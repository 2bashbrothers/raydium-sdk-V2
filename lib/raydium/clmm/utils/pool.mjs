var un=Object.defineProperty,cn=Object.defineProperties;var mn=Object.getOwnPropertyDescriptors;var Nt=Object.getOwnPropertySymbols;var ln=Object.prototype.hasOwnProperty,dn=Object.prototype.propertyIsEnumerable;var Lt=(u,e,t)=>e in u?un(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t,F=(u,e)=>{for(var t in e||(e={}))ln.call(e,t)&&Lt(u,t,e[t]);if(Nt)for(var t of Nt(e))dn.call(e,t)&&Lt(u,t,e[t]);return u},M=(u,e)=>cn(u,mn(e));import{PublicKey as ae}from"@solana/web3.js";import{TOKEN_2022_PROGRAM_ID as an}from"@solana/spl-token";import O from"bn.js";import N from"decimal.js";import{PublicKey as gn}from"@solana/web3.js";import{get as Rt,set as pn}from"lodash";var nt=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Date.now().toString()}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},_t={},fn={};function re(u){let e=Rt(_t,u);if(!e){let t=Rt(fn,u);e=new nt({name:u,logLevel:t}),pn(_t,u,e)}return e}import{MINT_SIZE as pr,TOKEN_PROGRAM_ID as fr,getTransferFeeConfig as gr,unpackMint as yr}from"@solana/spl-token";var rt=re("Raydium_accountInfo_util");async function we(u,e,t){let{batchRequest:n,commitment:r="confirmed",chunkCount:s=100}=F({batchRequest:!1},t),o=it(e,s),i=new Array(o.length).fill([]);if(n){let a=o.map(d=>{let p=u._buildArgs([d.map(m=>m.toBase58())],r,"base64");return{methodName:"getMultipleAccounts",args:p}}),c=it(a,10);i=(await(await Promise.all(c.map(async d=>await u._rpcBatchRequest(d)))).flat()).map(d=>(d.error&&rt.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${d.error.message}`),d.result.value.map(p=>{if(p){let{data:m,executable:y,lamports:g,owner:h,rentEpoch:f}=p;return m.length!==2&&m[1]!=="base64"&&rt.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(m[0],"base64"),executable:y,lamports:g,owner:new gn(h),rentEpoch:f}}return null})))}else try{i=await Promise.all(o.map(a=>u.getMultipleAccountsInfo(a,r)))}catch(a){a instanceof Error&&rt.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${a.message}`)}return i.flat()}async function ot(u,e,t){let n=await we(u,e.map(r=>r.pubkey),t);return e.map((r,s)=>M(F({},r),{accountInfo:n[s]}))}import he from"bn.js";import Hi from"decimal.js";import Pn from"big.js";import Ze from"bn.js";import yn from"toformat";var bn=yn,Fe=bn;import Ye from"big.js";import Tn from"bn.js";import xn from"decimal.js-light";import Me from"bn.js";var Et=9007199254740991;function ie(u){let e=re("Raydium_parseBigNumberish");if(u instanceof Me)return u;if(typeof u=="string"){if(u.match(/^-?[0-9]+$/))return new Me(u);e.logWithError(`invalid BigNumberish string: ${u}`)}return typeof u=="number"?(u%1&&e.logWithError(`BigNumberish number underflow: ${u}`),(u>=Et||u<=-Et)&&e.logWithError(`BigNumberish number overflow: ${u}`),new Me(String(u))):typeof u=="bigint"?new Me(u.toString()):(e.error(`invalid BigNumberish value: ${u}`),new Me(0))}var je=re("module/fraction"),at=Fe(Ye),Oe=Fe(xn),wn={[0]:Oe.ROUND_DOWN,[1]:Oe.ROUND_HALF_UP,[2]:Oe.ROUND_UP},An={[0]:Ye.roundDown,[1]:Ye.roundHalfUp,[2]:Ye.roundUp},_=class{constructor(e,t=new Tn(1)){this.numerator=ie(e),this.denominator=ie(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new _(this.denominator,this.numerator)}add(e){let t=e instanceof _?e:new _(ie(e));return this.denominator.eq(t.denominator)?new _(this.numerator.add(t.numerator),this.denominator):new _(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof _?e:new _(ie(e));return this.denominator.eq(t.denominator)?new _(this.numerator.sub(t.numerator),this.denominator):new _(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof _?e:new _(ie(e));return new _(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof _?e:new _(ie(e));return new _(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||je.logWithError(`${e} is not an integer.`),e<=0&&je.logWithError(`${e} is not positive.`),Oe.set({precision:e+1,rounding:wn[n]});let r=new Oe(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return r.toFormat(r.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||je.logWithError(`${e} is not an integer.`),e<0&&je.logWithError(`${e} is negative.`),at.DP=e,at.RM=An[n]||1,new at(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var kn=re("Raydium_amount"),Ft=Fe(Pn);function Bn(u,e){let t="0",n="0";if(u.includes(".")){let r=u.split(".");r.length===2?([t,n]=r,n=n.padEnd(e,"0")):kn.logWithError(`invalid number string, num: ${u}`)}else t=u;return[t,n.slice(0,e)||n]}var Z=class extends _{constructor(t,n,r=!0,s){let o=new Ze(0),i=ut.pow(new Ze(t.decimals));if(r)o=ie(n);else{let a=new Ze(0),c=new Ze(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,d]=Bn(n.toString(),t.decimals);a=ie(l),c=ie(d)}a=a.mul(i),o=a.add(c)}super(o,i);this.logger=re(s||"TokenAmount"),this.token=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.token.equals(t.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(t.raw)}lt(t){return this.token.equals(t.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(t.raw)}add(t){return this.token.equals(t.token)||this.logger.logWithError("add token not equals"),new Z(this.token,this.raw.add(t.raw))}subtract(t){return this.token.equals(t.token)||this.logger.logWithError("sub token not equals"),new Z(this.token,this.raw.sub(t.raw))}toSignificant(t=this.token.decimals,n,r=0){return super.toSignificant(t,n,r)}toFixed(t=this.token.decimals,n,r=0){return t>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,r)}toExact(t={groupSeparator:""}){return Ft.DP=this.token.decimals,new Ft(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}};import{PublicKey as In}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Mt}from"@solana/spl-token";var Ot={chainId:101,address:In.default.toBase58(),programId:Mt.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},Be={chainId:101,address:"So11111111111111111111111111111111111111112",programId:Mt.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};import{PublicKey as lt}from"@solana/web3.js";import{PublicKey as K,SystemProgram as Dt,SYSVAR_RENT_PUBKEY as Sn}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Cn}from"@solana/spl-token";function ct({pubkey:u,isSigner:e=!1,isWritable:t=!0}){return{pubkey:u,isWritable:t,isSigner:e}}var jr=[ct({pubkey:Cn,isWritable:!1}),ct({pubkey:Dt.programId,isWritable:!1}),ct({pubkey:Sn,isWritable:!1})];function mt({publicKey:u,transformSol:e}){let t=Kt(u.toString());if(t instanceof K)return e&&t.equals(De)?st:t;if(e&&t.toString()===De.toBase58())return st;if(typeof t=="string"){if(t===K.default.toBase58())return K.default;try{return new K(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function Kt(u){try{return new K(u)}catch{return u}}var Yr=new K("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),Zr=new K("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),Jr=new K("SysvarRent111111111111111111111111111111111"),Qr=new K("SysvarC1ock11111111111111111111111111111111"),Nn=new K("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),$r=new K("Sysvar1nstructions1111111111111111111111111"),ei=Dt.programId,ti=new K("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),ni=new K("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),ri=new K("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),ii=new K("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),oi=new K("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),si=new K("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),ai=new K("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),ui=new K("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),ci=new K("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),mi=new K("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),li=new K("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),st=new K("So11111111111111111111111111111111111111112"),De=K.default;function ze(u){return mt({publicKey:u,transformSol:!0})}var dt=class{constructor({mint:e,decimals:t,symbol:n,name:r,skipMint:s=!1,isToken2022:o=!1}){if(e===De.toBase58()||e instanceof lt&&De.equals(e)){this.decimals=Be.decimals,this.symbol=Be.symbol,this.name=Be.name,this.mint=new lt(Be.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=r||e.toString().substring(0,6),this.mint=s?lt.default:mt({publicKey:e}),this.isToken2022=o}equals(e){return this===e?!0:this.mint.equals(e.mint)}},be=dt;be.WSOL=new dt(M(F({},Be),{mint:Be.address}));var pt=class{constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},Je=pt;Je.SOL=new pt(Ot);import Ln from"bn.js";var vt=new _(new Ln(100)),Ae=class extends _{toSignificant(e=5,t,n){return this.mul(vt).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(vt).toFixed(e,t,n)}};var Rn=re("Raydium_price"),me=class extends _{constructor(t){let{baseToken:n,quoteToken:r,numerator:s,denominator:o}=t;super(s,o);this.baseToken=n,this.quoteToken=r,this.scalar=new _(ft(n.decimals),ft(r.decimals))}get raw(){return new _(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new me({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&Rn.logWithError("mul token not equals");let n=super.mul(t);return new me({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(t=this.quoteToken.decimals,n,r){return this.adjusted.toSignificant(t,n,r)}toFixed(t=this.quoteToken.decimals,n,r){return this.adjusted.toFixed(t,n,r)}};var _n=new he(0),to=new he(1),no=new he(2),ro=new he(3),io=new he(5),ut=new he(10),oo=new he(100),so=new he(1e3),ao=new he(1e4);function ft(u){return ut.pow(ie(u))}function it(u,e=1,t=[]){let n=[...u];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}import{PublicKey as _o}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Fo}from"@solana/spl-token";import{ComputeBudgetProgram as yo,Keypair as To,PublicKey as Fn,Transaction as wo,TransactionMessage as Po,VersionedTransaction as ko}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Co}from"@solana/spl-token";var No=re("Raydium_txUtil");function Ke(u,e){let[t,n]=Fn.findProgramAddressSync(u,e);return{publicKey:t,nonce:n}}import{PublicKey as b}from"@solana/web3.js";var Ko=new b("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),vo=new b("CBuCnLe26faBpcBP2fktp4rp8abpcAnTWft6ZrP5Q4T"),Go=new b("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),qo=new b("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),Vo=new b("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),Uo=new b("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),Wo=new b("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),Xo=new b("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),Ho=new b("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),zo=new b("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),jo=new b("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),Yo=new b("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),Zo=new b("kN1kEznaF5Xbd8LYuqtEFcxzWSBk5Fv6ygX6SqEGJVy"),Jo=new b("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Qo=new b("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),$o=new b("7YttLkHDoNj9wyDur5pM1ejNaAvT9X4eqaYcHQqtj2G5"),es=new b("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),ts=new b("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),ns=new b("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),rs=new b("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),is=new b("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),os=new b("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),ss=new b("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),as=new b("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),us=new b("3f7GcQFG397GAaEnv51zR6tsTVihYRydnydDD1cXekxH"),cs=new b("LanMV9sAd7wArD4vJFi2qDdfnVhFxYSUg6eADduJ3uj"),ms=new b("WLHv2UAZm6z4KyaaELi5pjdbJh6RESMva1Rnn8pJVVh"),ls=new b("DRay6fNdQ5J82H7xV6uq2aV3mNrUZ1J4PgSKsWgptcm6"),ds=new b("5xqNaZXX5eUi4p5HU4oz9i5QnwRNT2y6oN7yyn4qENeq"),ps=new b("4Bu96XjU84XjPDSpveTVf6LYGCkfW5FK7SNkREWcEfV4"),fs=new b("6s1xP3hpbAfFoNtUNF8mfHsjr2Bd97JxFJRWLbL6aHuX");var gs={OPEN_BOOK_PROGRAM:new b("EoTcMgcDRTJVZDMZWBoU6rhYHZfkNTVEAfz3uUJRcYGj"),SERUM_PROGRAM_ID_V3:new b("Ray1111111111111111111111111111111111111111"),AMM_V4:new b("DRaya7Kj3aMWQSy19kSjvmuwq9docCHofyP9kanQGaav"),AMM_STABLE:new b("DRayDdXc1NZQ9C3hRWmoSf8zK4iapgMnjdNZWrfwsP8m"),CLMM_PROGRAM_ID:new b("DRayAUgENGQBKVaX8owNhgzkEDyoHTGVEGHVJT1E9pfH"),CLMM_LOCK_PROGRAM_ID:new b("DRay25Usp3YJAi7beckgpGUC7mGJ2cR1AVPxhYfwVCUX"),CLMM_LOCK_AUTH_ID:new b("6Aoh8h2Lw2m5UGxYR8AdAL87jTWYeKoxM52mJRzfYwN"),CREATE_CPMM_POOL_PROGRAM:new b("DRaycpLY18LhpbydsBWbVJtxpNv9oXPgjRSfpF2bWpYb"),CREATE_CPMM_POOL_AUTH:new b("CXniRufdq5xL8t8jZAPxsPZDpuudwuJSPWnbcD5Y5Nxq"),CREATE_CPMM_POOL_FEE_ACC:new b("3oE58BKVt8KuYkGxx8zBojugnymWmBiyafWgMrnb6eYy"),LOCK_CPMM_PROGRAM:new b("DRay25Usp3YJAi7beckgpGUC7mGJ2cR1AVPxhYfwVCUX"),LOCK_CPMM_AUTH:new b("7qWVV8UY2bRJfDLP4s37YzBPKUkVB46DStYJBpYbQzu3"),UTIL1216:b.default,Router:new b("DRaybByLpbUL57LJARs3j8BitTxVfzBg351EaMr5UTCd"),FARM_PROGRAM_ID_V3:new b("DRayWyrLmEW5KEeqs8kdTMMaBabapqagaBC7KWpGtJeZ"),FARM_PROGRAM_ID_V4:new b("Ray1111111111111111111111111111111111111111"),FARM_PROGRAM_ID_V5:new b("DRayiCGSZgku1GTK6rXD6mVDdingXy6APAH1R6R5L2LC"),FARM_PROGRAM_ID_V6:new b("DRayzbYakXs45ELHkzH6vC3fuhQqTAnv5A68gdFuvZyZ"),LAUNCHPAD_PROGRAM:new b("DRay6fNdQ5J82H7xV6uq2aV3mNrUZ1J4PgSKsWgptcm6"),LAUNCHPAD_AUTH:new b("5xqNaZXX5eUi4p5HU4oz9i5QnwRNT2y6oN7yyn4qENeq"),LAUNCHPAD_PLATFORM:new b("2Jx4KTDrVSdWNazuGpcA8n3ZLTRGGBDxAWhuKe2Xcj2a"),LAUNCHPAD_CONFIG:new b("7ZR4zD7PYfY2XxoG1Gxcy2EgEeGYrpxrwzPuwdUBssEt"),FEE_DESTINATION_ID:new b("9y8ENuuZ3b19quffx9hQvRVygG5ky6snHfRvGpuSfeJy"),MODEL_DATA_PUBKEY:new b("Ray1111111111111111111111111111111111111111")};import le from"bn.js";var ve=1e4;function v(u,e,t,n){if(e===void 0)return{amount:u,fee:void 0,expirationTime:void 0};let r=M(F({},e),{olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}}),s=t.epoch<r.newerTransferFee.epoch?r.olderTransferFee:r.newerTransferFee,o=new le(s.maximumFee.toString()),i=t.epoch<r.newerTransferFee.epoch?(Number(r.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(s.transferFeeBasisPoints===ve){let a=new le(s.maximumFee.toString());return{amount:u.add(a),fee:a,expirationTime:i}}else{let a=gt(u.mul(new le(ve)),new le(ve-s.transferFeeBasisPoints)),c=new le(s.maximumFee.toString()),l=a.sub(u).gt(c)?u.add(c):a,d=gt(l.mul(new le(s.transferFeeBasisPoints)),new le(ve)),p=d.gt(o)?o:d;return{amount:l,fee:p,expirationTime:i}}else{let a=gt(u.mul(new le(s.transferFeeBasisPoints)),new le(ve)),c=a.gt(o)?o:a;return{amount:u,fee:c,expirationTime:i}}}function Pe(u,e){return u===void 0?e:e===void 0?u:Math.min(u,e)}function gt(u,e){let{div:t,mod:n}=u.divmod(e);return n.gt(new le(0))?t.add(new le(1)):t}import{PublicKey as ws,AddressLookupTableAccount as As}from"@solana/web3.js";import{PublicKey as Gs,sendAndConfirmTransaction as qs,SystemProgram as Ws,Transaction as Xs,TransactionMessage as zs,VersionedTransaction as js}from"@solana/web3.js";import Zs from"axios";import{PublicKey as ia}from"@solana/web3.js";import sa from"bn.js";import Mn from"bn.js";var la=new Mn(1e6);import{PublicKey as Wn}from"@solana/web3.js";import Ut,{isBN as Wt}from"bn.js";import{bits as Ea,BitStructure as Fa,blob as On,Blob as Ma,cstr as Oa,f32 as Da,f32be as Ka,f64 as va,f64be as Ga,greedy as qa,Layout as Dn,ns64 as Va,ns64be as Ua,nu64 as Wa,nu64be as Xa,offset as Ha,s16 as za,s16be as ja,s24 as Ya,s24be as Za,s32 as Kn,s32be as Ja,s40 as Qa,s40be as $a,s48 as eu,s48be as tu,s8 as nu,seq as vn,struct as ru,Structure as Gn,u16 as qn,u16be as iu,u24 as ou,u24be as su,u32 as au,u32be as uu,u40 as cu,u40be as mu,u48 as lu,u48be as du,u8 as Vn,UInt as Un,union as pu,Union as fu,unionLayoutDiscriminator as gu,utf8 as yu}from"@solana/buffer-layout";var yt=Dn,Gt=Gn;var bt=Un;var qt=Vn,Ge=qn;var ke=Kn;var Vt=vn;var oe=On;var Re=class extends yt{constructor(t,n,r){super(t,r);this.blob=oe(t),this.signed=n}decode(t,n=0){let r=new Ut(this.blob.decode(t,n),10,"le");return this.signed?r.fromTwos(this.span*8).clone():r}encode(t,n,r=0){return typeof t=="number"&&(t=new Ut(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),n,r)}};function te(u){return new bt(1,u)}function _e(u){return new bt(4,u)}function L(u){return new Re(8,!1,u)}function U(u){return new Re(16,!1,u)}function Xt(u){return new Re(8,!0,u)}function Ht(u){return new Re(16,!0,u)}var Qe=class extends yt{constructor(t,n,r,s){super(t.span,s);this.layout=t,this.decoder=n,this.encoder=r}decode(t,n){return this.decoder(this.layout.decode(t,n))}encode(t,n,r){return this.layout.encode(this.encoder(t),n,r)}getSpan(t,n){return this.layout.getSpan(t,n)}};function E(u){return new Qe(oe(32),e=>new Wn(e),e=>e.toBuffer(),u)}function zt(u){return new Qe(qt(),Xn,Hn,u)}function Xn(u){if(u===0)return!1;if(u===1)return!0;throw new Error("Invalid bool: "+u)}function Hn(u){return u?1:0}var ht=class extends Gt{decode(e,t){return super.decode(e,t)}};function Q(u,e,t){return new ht(u,e,t)}function G(u,e,t){let n,r=typeof e=="number"?e:Wt(e)?e.toNumber():new Proxy(e,{get(s,o){if(!n){let i=Reflect.get(s,"count");n=Wt(i)?i.toNumber():i,Reflect.set(s,"count",n)}return Reflect.get(s,o)},set(s,o,i){return o==="count"&&(n=i),Reflect.set(s,o,i)}});return Vt(u,r,t)}import Qn from"bn.js";import Ee from"decimal.js";import ue from"bn.js";var q=new ue(0),pe=new ue(1),Te=new ue(-1),se=new ue(1).shln(64),$e=new ue(1).shln(128),Tt=se.sub(pe),qe=64,jt=$e.subn(1),J=-443636,$=-J,Ie=new ue("4295048016"),Se=new ue("79226673521066979257578248091"),Lu=new ue("4295048017"),Ru=new ue("79226673521066979257578248090"),Yt=16,Zt="59543866431248",Jt="184467440737095516",Qt="15793534762490258745",et=new ue(10).pow(new ue(6));var _u=new ue("18446744073700000000");import A from"bn.js";import fe from"decimal.js";function $t(u){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,u,!1),new Uint8Array(e)}function xt(u,e){let t=0;for(let n=u-1;n>=0&&!e.testn(n);n--)t++;return t}function wt(u,e){let t=0;for(let n=0;n<u&&!e.testn(n);n++)t++;return t}function Ve(u,e){for(let t=0;t<u;t++)if(e.testn(t))return!1;return!0}function en(u,e){return Ve(u,e)?null:xt(u,e)}function tn(u,e){return Ve(u,e)?null:wt(u,e)}var Ku=Buffer.from("amm_config","utf8"),vu=Buffer.from("pool","utf8"),Gu=Buffer.from("pool_vault","utf8"),qu=Buffer.from("pool_reward_vault","utf8"),zn=Buffer.from("position","utf8"),jn=Buffer.from("tick_array","utf8"),Vu=Buffer.from("operation","utf8"),Yn=Buffer.from("pool_tick_array_bitmap_extension","utf8"),Uu=Buffer.from("observation","utf8");function ee(u,e,t){return Ke([jn,e.toBuffer(),$t(t)],u)}function nn(u,e){return Ke([zn,e.toBuffer()],u)}function tt(u,e){return Ke([Yn,e.toBuffer()],u)}var Wu=Buffer.from("locked_position","utf8");var Xu=Buffer.from("support_mint","utf8");var Zn=15,R=class{static async getTickArrays(e,t,n,r,s,o,i){let a=[],c=w.getTickArrayStartIndexByTick(r,s),l=w.getInitializedTickArrayInRange(o,i,s,c,Math.floor(Zn/2));for(let m=0;m<l.length;m++){let{publicKey:y}=ee(t,n,l[m]);a.push(y)}let d=(await we(e,a)).map(m=>m!==null?Ue.decode(m.data):null),p={};for(let m=0;m<a.length;m++){let y=d[m];y!==null&&(p[y.startTickIndex]=M(F({},y),{address:a[m]}))}return p}static nextInitializedTick(e,t,n,r,s,o){let{initializedTick:i,tickArrayAddress:a,tickArrayStartTickIndex:c}=this.nextInitializedTickInOneArray(e,t,n,r,s,o);for(;i==null||i.liquidityGross.lten(0);){if(c=w.getNextTickArrayStartIndex(c,s,o),this.checkIsValidStartIndex(c,s))throw new Error("No enough initialized tickArray");let l=n[c];if(l===void 0)continue;let{nextTick:d,tickArrayAddress:p,tickArrayStartTickIndex:m}=this.firstInitializedTickInOneArray(e,t,l,o);[i,a,c]=[d,p,m]}if(i==null)throw new Error("No invaild tickArray cache");return{nextTick:i,tickArrayAddress:a,tickArrayStartTickIndex:c}}static nextInitializedTickArray(e,t,n,r,s){let o=Math.floor(e/R.tickCount(t)),i=n?w.searchLowBitFromStart(r,s,o-1,1,t):w.searchHightBitFromStart(r,s,o+1,1,t);return i.length>0?{isExist:!0,nextStartIndex:i[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,r){let s;if(r){let i=H-1;for(;i>=0;){let a=n.ticks[i];if(a.liquidityGross.gtn(0)){s=a;break}i=i-1}}else{let i=0;for(;i<H;){let a=n.ticks[i];if(a.liquidityGross.gtn(0)){s=a;break}i=i+1}}let{publicKey:o}=ee(e,t,n.startTickIndex);return{nextTick:s,tickArrayAddress:o,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,r,s,o){let i=w.getTickArrayStartIndexByTick(r,s),a=Math.floor((r-i)/s),c=n[i];if(c==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:i};let l;if(o)for(;a>=0;){let p=c.ticks[a];if(p.liquidityGross.gtn(0)){l=p;break}a=a-1}else for(a=a+1;a<H;){let p=c.ticks[a];if(p.liquidityGross.gtn(0)){l=p;break}a=a+1}let{publicKey:d}=ee(e,t,i);return{initializedTick:l,tickArrayAddress:d,tickArrayStartTickIndex:c.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(w.checkIsOutOfBoundary(e)){if(e>$)return!1;let n=w.getTickArrayStartIndexByTick(J,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return H*e}};var P=class{static mulDivRoundingUp(e,t,n){let r=e.mul(t),s=r.div(n);return r.mod(n).eq(q)||(s=s.add(pe)),s}static mulDivFloor(e,t,n){if(n.eq(q))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(q))throw new Error("division by 0");return e.mul(t).add(n.sub(pe)).div(n)}static x64ToDecimal(e,t){return new fe(e.toString()).div(fe.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new A(e.mul(fe.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add($e).sub(t).mod($e)}};function z(u,e){return At(u.mul(e),64,256)}function Jn(u,e,t){let n=u.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function At(u,e,t){let n=u.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var x=class{static sqrtPriceX64ToPrice(e,t,n){return P.x64ToDecimal(e).pow(2).mul(fe.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return P.decimalToX64(e.mul(fe.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,r){if(!e.gt(q))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(q))throw new Error("liquidity must greater than 0");return r?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,r){if(!e.gt(q))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(q))throw new Error("liquidity must greater than 0");return r?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,r){if(n.eq(q))return e;let s=t.shln(qe);if(r){let o=s,i=s.add(n.mul(e));return i.gte(o)?P.mulDivCeil(o,e,i):P.mulDivRoundingUp(o,pe,o.div(e).add(n))}else{let o=n.mul(e);if(!s.gt(o))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let i=s.sub(o);return P.mulDivCeil(s,e,i)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,r){let s=n.shln(qe);if(r)return e.add(s.div(t));{let o=P.mulDivRoundingUp(s,pe,t);if(!e.gt(o))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(o)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<J||e>$)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new A("18445821805675395072"):new A("18446744073709551616");return(t&2)!=0&&(n=z(n,new A("18444899583751176192"))),(t&4)!=0&&(n=z(n,new A("18443055278223355904"))),(t&8)!=0&&(n=z(n,new A("18439367220385607680"))),(t&16)!=0&&(n=z(n,new A("18431993317065453568"))),(t&32)!=0&&(n=z(n,new A("18417254355718170624"))),(t&64)!=0&&(n=z(n,new A("18387811781193609216"))),(t&128)!=0&&(n=z(n,new A("18329067761203558400"))),(t&256)!=0&&(n=z(n,new A("18212142134806163456"))),(t&512)!=0&&(n=z(n,new A("17980523815641700352"))),(t&1024)!=0&&(n=z(n,new A("17526086738831433728"))),(t&2048)!=0&&(n=z(n,new A("16651378430235570176"))),(t&4096)!=0&&(n=z(n,new A("15030750278694412288"))),(t&8192)!=0&&(n=z(n,new A("12247334978884435968"))),(t&16384)!=0&&(n=z(n,new A("8131365268886854656"))),(t&32768)!=0&&(n=z(n,new A("3584323654725218816"))),(t&65536)!=0&&(n=z(n,new A("696457651848324352"))),(t&131072)!=0&&(n=z(n,new A("26294789957507116"))),(t&262144)!=0&&(n=z(n,new A("37481735321082"))),e>0&&(n=jt.div(n)),n}static getTickFromPrice(e,t,n){return x.getTickFromSqrtPriceX64(x.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(Se)||e.lt(Ie))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new A(t-64),r=Jn(n,32,128),s=new A("8000000000000000","hex"),o=0,i=new A(0),a=t>=64?e.shrn(t-63):e.shln(63-t);for(;s.gt(new A(0))&&o<Yt;){a=a.mul(a);let y=a.shrn(127);a=a.shrn(63+y.toNumber()),i=i.add(s.mul(y)),s=s.shrn(1),o+=1}let c=i.shrn(32),d=r.add(c).mul(new A(Zt)),p=At(d.sub(new A(Jt)),64,128).toNumber(),m=At(d.add(new A(Qt)),64,128).toNumber();return p==m?p:x.getSqrtPriceX64FromTick(m).lte(e)?m:p}},Ce=class{static getTickWithPriceAndTickspacing(e,t,n,r){let o=x.getTickFromSqrtPriceX64(x.priceToSqrtPriceX64(e,n,r))/t;return o<0?o=Math.floor(o):o=Math.ceil(o),o*t}static roundPriceWithTickspacing(e,t,n,r){let s=Ce.getTickWithPriceAndTickspacing(e,t,n,r),o=x.getSqrtPriceX64FromTick(s);return x.sqrtPriceX64ToPrice(o,n,r)}},C=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,r){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(q))throw new Error("sqrtPriceX64A must greater than 0");let s=n.ushln(qe),o=t.sub(e);return r?P.mulDivRoundingUp(P.mulDivCeil(s,o,t),pe,e):P.mulDivFloor(s,o,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,r){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(q))throw new Error("sqrtPriceX64A must greater than 0");return r?P.mulDivCeil(n,t.sub(e),se):P.mulDivFloor(n,t.sub(e),se)}static getLiquidityFromTokenAmountA(e,t,n,r){e.gt(t)&&([e,t]=[t,e]);let s=n.mul(e).mul(t),o=t.sub(e),i=s.div(o);return r?P.mulDivRoundingUp(i,pe,Tt):i.shrn(qe)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),P.mulDivFloor(n,Tt,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,r,s){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return C.getLiquidityFromTokenAmountA(t,n,r,!1);if(e.lt(n)){let o=C.getLiquidityFromTokenAmountA(e,n,r,!1),i=C.getLiquidityFromTokenAmountB(t,e,s);return o.lt(i)?o:i}else return C.getLiquidityFromTokenAmountB(t,n,s)}static getAmountsFromLiquidity(e,t,n,r,s){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:C.getTokenAmountAFromLiquidity(t,n,r,s),amountB:new A(0)};if(e.lt(n)){let o=C.getTokenAmountAFromLiquidity(e,n,r,s),i=C.getTokenAmountBFromLiquidity(t,e,r,s);return{amountA:o,amountB:i}}else return{amountA:new A(0),amountB:C.getTokenAmountBFromLiquidity(t,n,r,s)}}static getAmountsFromLiquidityWithSlippage(e,t,n,r,s,o,i){let{amountA:a,amountB:c}=C.getAmountsFromLiquidity(e,t,n,r,o),l=s?1+i:1-i,d=new A(new fe(a.toString()).mul(l).toFixed(0)),p=new A(new fe(c.toString()).mul(l).toFixed(0));return{amountSlippageA:d,amountSlippageB:p}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:r,slippage:s,add:o,epochInfo:i,amountAddFee:a}){var I,S,V,W;let c=x.priceToSqrtPriceX64(new fe(e.price),e.mintA.decimals,e.mintB.decimals),l=x.getSqrtPriceX64FromTick(t),d=x.getSqrtPriceX64FromTick(n),p=o?1+s:1-s,m=C.getAmountsFromLiquidity(c,l,d,r,o),[y,g]=[v(m.amountA,(I=e.mintA.extensions)==null?void 0:I.feeConfig,i,a),v(m.amountB,(S=e.mintB.extensions)==null?void 0:S.feeConfig,i,a)],[h,f]=[v(new A(new fe(m.amountA.toString()).mul(p).toFixed(0)),(V=e.mintA.extensions)==null?void 0:V.feeConfig,i,a),v(new A(new fe(m.amountB.toString()).mul(p).toFixed(0)),(W=e.mintB.extensions)==null?void 0:W.feeConfig,i,a)];return{liquidity:r,amountA:y,amountB:g,amountSlippageA:h,amountSlippageB:f,expirationTime:Pe(y.expirationTime,g.expirationTime)}}},Ne=class{static swapCompute(e,t,n,r,s,o,i,a,c,l,d,p,m,y,g=!1){if(p.eq(q))throw new Error("amountSpecified must not be 0");if(y||(y=o?Ie.add(pe):Se.sub(pe)),o){if(y.lt(Ie))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(y.gte(d))throw new Error("sqrtPriceX64 must smaller than current")}else{if(y.gt(Se))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(y.lte(d))throw new Error("sqrtPriceX64 must greater than current")}let h=p.gt(q),f={amountSpecifiedRemaining:p,amountCalculated:q,sqrtPriceX64:d,tick:c>m?Math.min(m+R.tickCount(l)-1,c):m,accounts:[],liquidity:a,feeAmount:new A(0)},I=m,S=n[m],V=0,W=!o&&S.startTickIndex===f.tick;for(;!f.amountSpecifiedRemaining.eq(q)&&!f.sqrtPriceX64.eq(y);){V>10;let T={};T.sqrtPriceStartX64=f.sqrtPriceX64;let j=w.nextInitTick(S,f.tick,l,o,W),D=j||null,ne=null;if(!(D!=null&&D.liquidityGross.gtn(0))){let X=de.nextInitializedTickArrayStartIndex({tickCurrent:f.tick,tickSpacing:l,tickArrayBitmap:r,exBitmapInfo:s},I,o);if(!X.isExist){if(g)return{allTrade:!1,amountSpecifiedRemaining:f.amountSpecifiedRemaining,amountCalculated:f.amountCalculated,feeAmount:f.feeAmount,sqrtPriceX64:f.sqrtPriceX64,liquidity:f.liquidity,tickCurrent:f.tick,accounts:f.accounts};throw Error("swapCompute LiquidityInsufficient")}I=X.nextStartIndex;let{publicKey:ye}=ee(e,t,I);ne=ye,S=n[I];try{D=w.firstInitializedTick(S,o)}catch{throw Error("not found next tick info")}}T.tickNext=D.tick,T.initialized=D.liquidityGross.gtn(0),m!==I&&ne&&(f.accounts.push(ne),m=I),T.tickNext<J?T.tickNext=J:T.tickNext>$&&(T.tickNext=$),T.sqrtPriceNextX64=x.getSqrtPriceX64FromTick(T.tickNext);let Y;if(o&&T.sqrtPriceNextX64.lt(y)||!o&&T.sqrtPriceNextX64.gt(y)?Y=y:Y=T.sqrtPriceNextX64,[f.sqrtPriceX64,T.amountIn,T.amountOut,T.feeAmount]=Ne.swapStepCompute(f.sqrtPriceX64,Y,f.liquidity,f.amountSpecifiedRemaining,i,o),f.feeAmount=f.feeAmount.add(T.feeAmount),h?(f.amountSpecifiedRemaining=f.amountSpecifiedRemaining.sub(T.amountIn.add(T.feeAmount)),f.amountCalculated=f.amountCalculated.sub(T.amountOut)):(f.amountSpecifiedRemaining=f.amountSpecifiedRemaining.add(T.amountOut),f.amountCalculated=f.amountCalculated.add(T.amountIn.add(T.feeAmount))),f.sqrtPriceX64.eq(T.sqrtPriceNextX64)){if(T.initialized){let X=D.liquidityNet;o&&(X=X.mul(Te)),f.liquidity=C.addDelta(f.liquidity,X)}W=T.tickNext!=f.tick&&!o&&S.startTickIndex===T.tickNext,f.tick=o?T.tickNext-1:T.tickNext}else if(f.sqrtPriceX64!=T.sqrtPriceStartX64){let X=x.getTickFromSqrtPriceX64(f.sqrtPriceX64);W=X!=f.tick&&!o&&S.startTickIndex===X,f.tick=X}++V}try{let{nextStartIndex:T,isExist:j}=R.nextInitializedTickArray(f.tick,l,o,r,s);j&&m!==T&&(f.accounts.push(ee(e,t,T).publicKey),m=T)}catch{}return{allTrade:!0,amountSpecifiedRemaining:q,amountCalculated:f.amountCalculated,feeAmount:f.feeAmount,sqrtPriceX64:f.sqrtPriceX64,liquidity:f.liquidity,tickCurrent:f.tick,accounts:f.accounts}}static swapStepCompute(e,t,n,r,s,o){let i={sqrtPriceX64Next:new A(0),amountIn:new A(0),amountOut:new A(0),feeAmount:new A(0)},a=r.gte(q);if(a){let l=P.mulDivFloor(r,et.sub(new A(s.toString())),et);i.amountIn=o?C.getTokenAmountAFromLiquidity(t,e,n,!0):C.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(i.amountIn)?i.sqrtPriceX64Next=t:i.sqrtPriceX64Next=x.getNextSqrtPriceX64FromInput(e,n,l,o)}else i.amountOut=o?C.getTokenAmountBFromLiquidity(t,e,n,!1):C.getTokenAmountAFromLiquidity(e,t,n,!1),r.mul(Te).gte(i.amountOut)?i.sqrtPriceX64Next=t:i.sqrtPriceX64Next=x.getNextSqrtPriceX64FromOutput(e,n,r.mul(Te),o);let c=t.eq(i.sqrtPriceX64Next);return o?(c&&a||(i.amountIn=C.getTokenAmountAFromLiquidity(i.sqrtPriceX64Next,e,n,!0)),c&&!a||(i.amountOut=C.getTokenAmountBFromLiquidity(i.sqrtPriceX64Next,e,n,!1))):(i.amountIn=c&&a?i.amountIn:C.getTokenAmountBFromLiquidity(e,i.sqrtPriceX64Next,n,!0),i.amountOut=c&&!a?i.amountOut:C.getTokenAmountAFromLiquidity(e,i.sqrtPriceX64Next,n,!1)),!a&&i.amountOut.gt(r.mul(Te))&&(i.amountOut=r.mul(Te)),a&&!i.sqrtPriceX64Next.eq(t)?i.feeAmount=r.sub(i.amountIn):i.feeAmount=P.mulDivCeil(i.amountIn,new A(s),et.sub(new A(s))),[i.sqrtPriceX64Next,i.amountIn,i.amountOut,i.feeAmount]}};var H=60,Le=512,w=class{static getTickArrayAddressByTick(e,t,n,r){let s=w.getTickArrayStartIndexByTick(n,r),{publicKey:o}=ee(e,t,s);return o}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=w.getTickArrayStartIndexByTick(e,t),r=Math.floor((e-n)/t);if(r<0||r>=H)throw new Error("tick offset in array overflow");return r}static getTickArrayBitIndex(e,t){let n=R.tickCount(t),r=e/n;return e<0&&e%n!=0?r=Math.ceil(r)-1:r=Math.floor(r),r}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*R.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*H,r=Math.floor(e/n)+512;return Math.abs(r)}static checkTickArrayIsInitialized(e,t,n){let r=n*H,s=Math.floor(t/r)+512,o=Math.abs(s);return{isInitialized:e.testn(o),startIndex:(o-512)*r}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*H:e+t*H}static mergeTickArrayBitmap(e){let t=new Qn(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,r,s){let o=Math.floor(r/(n*H));return[...w.searchLowBitFromStart(e,t,o-1,s,n),...w.searchHightBitFromStart(e,t,o,s,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return w.searchHightBitFromStart(e,t,-7680,Le,n)}static getAllInitializedTickArrayInfo(e,t,n,r,s){let o=[],i=w.getAllInitializedTickArrayStartIndex(n,r,s);for(let a of i){let{publicKey:c}=ee(e,t,a);o.push({tickArrayStartIndex:a,tickArrayAddress:c})}return o}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,r,s){let o=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(c=>w.mergeTickArrayBitmap(c)),i=[];for(;n>=-7680;){let c=Math.floor((n+7680)/512),l=(n+7680)%512;if(o[c].testn(l)&&i.push(n),n--,i.length===r)break}let a=R.tickCount(s);return i.map(c=>c*a)}static searchHightBitFromStart(e,t,n,r,s){let o=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(c=>w.mergeTickArrayBitmap(c)),i=[];for(;n<7680;){let c=Math.floor((n+7680)/512),l=(n+7680)%512;if(o[c].testn(l)&&i.push(n),n++,i.length===r)break}let a=R.tickCount(s);return i.map(c=>c*a)}static checkIsOutOfBoundary(e){return e<J||e>$}static nextInitTick(e,t,n,r,s){if(R.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let i=Math.floor((t-e.startTickIndex)/n);if(r)for(;i>=0;){if(e.ticks[i].liquidityGross.gtn(0))return e.ticks[i];i=i-1}else for(s||(i=i+1);i<H;){if(e.ticks[i].liquidityGross.gtn(0))return e.ticks[i];i=i+1}return null}static firstInitializedTick(e,t){if(t){let n=H-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<H;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let r=x.getSqrtPriceX64FromTick(t),s=x.sqrtPriceX64ToPrice(r,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:s,tickSqrtPriceX64:r}:{tick:t,price:new Ee(1).div(s),tickSqrtPriceX64:r}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let r=n?t:new Ee(1).div(t),s=Ce.getTickWithPriceAndTickspacing(r,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),o=x.getSqrtPriceX64FromTick(s),i=x.sqrtPriceX64ToPrice(o,e.mintA.decimals,e.mintB.decimals);return n?{tick:s,price:i}:{tick:s,price:new Ee(1).div(i)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let r=x.getSqrtPriceX64FromTick(t),s=x.sqrtPriceX64ToPrice(r,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:s,tickSqrtPriceX64:r}:{tick:t,price:new Ee(1).div(s),tickSqrtPriceX64:r}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let r=n?t:new Ee(1).div(t),s=Ce.getTickWithPriceAndTickspacing(r,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),o=x.getSqrtPriceX64FromTick(s),i=x.sqrtPriceX64ToPrice(o,e.mintA.decimals,e.mintB.decimals);return n?{tick:s,price:i}:{tick:s,price:new Ee(1).div(i)}}};var Pt=14,xe=class{static maxTickInTickarrayBitmap(e){return e*H*Le}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),r=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(r+=1);let s=n*r;return e<0?{minValue:-s,maxValue:-s+n}:{minValue:s,maxValue:s+n}}static nextInitializedTickArrayStartIndex(e,t,n,r){if(!R.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let s=this.maxTickInTickarrayBitmap(n),o=r?t-R.tickCount(n):t+R.tickCount(n);if(o<-s||o>=s)return{isInit:!1,tickIndex:t};let i=n*H,a=o/i+512;o<0&&o%i!=0&&a--;let c=Math.abs(a);if(r){let l=e.shln(1024-c-1),d=en(1024,l);if(d!==null){let p=(c-d-512)*i;return{isInit:!0,tickIndex:p}}else return{isInit:!1,tickIndex:-s}}else{let l=e.shrn(c),d=tn(1024,l);if(d!==null){let p=(c+d-512)*i;return{isInit:!0,tickIndex:p}}else return{isInit:!1,tickIndex:s-R.tickCount(n)}}}},We=class{static getBitmapOffset(e,t){if(!R.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=xe.maxTickInTickarrayBitmap(t),r=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&r--,r}static getBitmap(e,t,n){let r=this.getBitmapOffset(e,t);return e<0?{offset:r,tickarrayBitmap:n.negativeTickArrayBitmap[r]}:{offset:r,tickarrayBitmap:n.positiveTickArrayBitmap[r]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:r}=this.extensionTickBoundary(t);if(e>=r&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=xe.maxTickInTickarrayBitmap(e),n=-t;if($<=t)throw Error(`extensionTickBoundary check error: ${$}, ${t}`);if(n<=J)throw Error(`extensionTickBoundary check error: ${n}, ${J}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:r}=this.getBitmap(e,t,n),s=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:w.mergeTickArrayBitmap(r).testn(s),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,r){let s=R.tickCount(t),o=n?e-s:e+s,{tickarrayBitmap:i}=this.getBitmap(o,t,r);return this.nextInitializedTickArrayInBitmap(i,o,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,r){let{minValue:s,maxValue:o}=xe.getBitmapTickBoundary(t,n),i=this.tickArrayOffsetInBitmap(t,n);if(r){let a=w.mergeTickArrayBitmap(e).shln(Le-1-i),c=Ve(512,a)?null:xt(512,a);if(c!==null){let l=t-c*R.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s}}else{let a=w.mergeTickArrayBitmap(e).shrn(i),c=Ve(512,a)?null:wt(512,a);if(c!==null){let l=t+c*R.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:o-R.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%xe.maxTickInTickarrayBitmap(t),r=Math.floor(n/R.tickCount(t));return e<0&&n!=0&&(r=Le-r),r}};var Cc=Q([oe(8),te("bump"),Ge("index"),E(""),_e("protocolFeeRate"),_e("tradeFeeRate"),Ge("tickSpacing"),G(L(),8,"")]),$n=Q([_e("blockTimestamp"),Xt("tickCumulative"),G(L(),4)]),Nc=Q([oe(8),zt("initialized"),L("recentEpoch"),Ge("observationIndex"),E("poolId"),G($n,100,"observations"),G(L(),4)]),er=Q([te("rewardState"),L("openTime"),L("endTime"),L("lastUpdateTime"),U("emissionsPerSecondX64"),L("rewardTotalEmissioned"),L("rewardClaimed"),E("tokenMint"),E("tokenVault"),E("creator"),U("rewardGrowthGlobalX64")]),rn=Q([oe(8),te("bump"),E("ammConfig"),E("creator"),E("mintA"),E("mintB"),E("vaultA"),E("vaultB"),E("observationId"),te("mintDecimalsA"),te("mintDecimalsB"),Ge("tickSpacing"),U("liquidity"),U("sqrtPriceX64"),ke("tickCurrent"),_e(),U("feeGrowthGlobalX64A"),U("feeGrowthGlobalX64B"),L("protocolFeesTokenA"),L("protocolFeesTokenB"),U("swapInAmountTokenA"),U("swapOutAmountTokenB"),U("swapInAmountTokenB"),U("swapOutAmountTokenA"),te("status"),G(te(),7,""),G(er,3,"rewardInfos"),G(L(),16,"tickArrayBitmap"),L("totalFeesTokenA"),L("totalFeesClaimedTokenA"),L("totalFeesTokenB"),L("totalFeesClaimedTokenB"),L("fundFeesTokenA"),L("fundFeesTokenB"),L("startTime"),G(L(),15*4-3,"padding")]),tr=Q([U("growthInsideLastX64"),L("rewardAmountOwed")]),on=Q([oe(8),te("bump"),E("nftMint"),E("poolId"),ke("tickLower"),ke("tickUpper"),U("liquidity"),U("feeGrowthInsideLastX64A"),U("feeGrowthInsideLastX64B"),L("tokenFeesOwedA"),L("tokenFeesOwedB"),G(tr,3,"rewardInfos"),G(L(),8,"")]),Lc=Q([oe(8),te("bump"),E("poolId"),ke("tickLowerIndex"),ke("tickUpperIndex"),U("liquidity"),U("feeGrowthInsideLastX64A"),U("feeGrowthInsideLastX64B"),L("tokenFeesOwedA"),L("tokenFeesOwedB"),G(U(),3,"rewardGrowthInside"),G(L(),8,"")]),nr=Q([ke("tick"),Ht("liquidityNet"),U("liquidityGross"),U("feeGrowthOutsideX64A"),U("feeGrowthOutsideX64B"),G(U(),3,"rewardGrowthsOutsideX64"),G(_e(),13,"")]),Ue=Q([oe(8),E("poolId"),ke("startTickIndex"),G(nr,H,"ticks"),te("initializedTickCount"),G(te(),115,"")]),Rc=Q([oe(329),G(E(),100,"whitelistMints")]),sn=Q([oe(8),E("poolId"),G(G(L(),8),Pt,"positiveTickArrayBitmap"),G(G(L(),8),Pt,"negativeTickArrayBitmap")]),_c=Q([L(),te("bump"),E("owner"),E("poolId"),E("positionId"),E("nftAccount"),G(L(),8)]),Ec=Q([oe(8),te("bump"),E("lockOwner"),E("poolId"),E("positionId"),E("nftAccount"),E("lockNftMint"),L("recentEpoch"),G(L(),8)]);import ge from"bn.js";import kt from"decimal.js";var Xe=class{static getfeeGrowthInside(e,t,n){let r=new ge(0),s=new ge(0);e.tickCurrent>=t.tick?(r=t.feeGrowthOutsideX64A,s=t.feeGrowthOutsideX64B):(r=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),s=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let o=new ge(0),i=new ge(0);e.tickCurrent<n.tick?(o=n.feeGrowthOutsideX64A,i=n.feeGrowthOutsideX64B):(o=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),i=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let a=P.wrappingSubU128(P.wrappingSubU128(e.feeGrowthGlobalX64A,r),o),c=P.wrappingSubU128(P.wrappingSubU128(e.feeGrowthGlobalX64B,s),i);return{feeGrowthInsideX64A:a,feeGrowthInsideBX64:c}}static GetPositionFees(e,t,n,r){let{feeGrowthInsideX64A:s,feeGrowthInsideBX64:o}=this.getfeeGrowthInside(e,n,r),i=P.mulDivFloor(P.wrappingSubU128(s,t.feeGrowthInsideLastX64A),t.liquidity,se),a=t.tokenFeesOwedA.add(i),c=P.mulDivFloor(P.wrappingSubU128(o,t.feeGrowthInsideLastX64B),t.liquidity,se),l=t.tokenFeesOwedB.add(c);return{tokenFeeAmountA:a,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,r){let{feeGrowthInsideX64A:s,feeGrowthInsideBX64:o}=this.getfeeGrowthInside(e,n,r),i=P.mulDivFloor(P.wrappingSubU128(s,t.feeGrowthInsideLastX64A),t.liquidity,se),a=t.tokenFeesOwedA.add(i),c=P.mulDivFloor(P.wrappingSubU128(o,t.feeGrowthInsideLastX64B),t.liquidity,se),l=t.tokenFeesOwedB.add(c);return{tokenFeeAmountA:a,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,r){let s=[],o=this.getRewardGrowthInsideV2(e.tickCurrent,n,r,e.rewardInfos);for(let i=0;i<o.length;i++){let a=o[i],c=t.rewardInfos[i],l=P.wrappingSubU128(a,c.growthInsideLastX64),d=P.mulDivFloor(l,t.liquidity,se),p=c.rewardAmountOwed.add(d);s.push(p)}return s}static GetPositionRewards(e,t,n,r){let s=[],o=this.getRewardGrowthInside(e.tickCurrent,n,r,e.rewardInfos);for(let i=0;i<o.length;i++){let a=o[i],c=t.rewardInfos[i],l=P.wrappingSubU128(a,c.growthInsideLastX64),d=P.mulDivFloor(l,t.liquidity,se),p=c.rewardAmountOwed.add(d);s.push(p)}return s}static getRewardGrowthInside(e,t,n,r){let s=[];for(let o=0;o<r.length;o++){let i=new ge(0);t.liquidityGross.eqn(0)?i=r[o].rewardGrowthGlobalX64:e<t.tick?i=r[o].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[o]):i=t.rewardGrowthsOutsideX64[o];let a=new ge(0);n.liquidityGross.eqn(0)||(e<n.tick?a=n.rewardGrowthsOutsideX64[o]:a=r[o].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[o])),s.push(P.wrappingSubU128(P.wrappingSubU128(r[o].rewardGrowthGlobalX64,i),a))}return s}static getRewardGrowthInsideV2(e,t,n,r){let s=[];for(let o=0;o<r.length;o++){let i=new ge(0);t.liquidityGross.eqn(0)?i=r[o].rewardGrowthGlobalX64:e<t.tick?i=r[o].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[o]):i=t.rewardGrowthsOutsideX64[o];let a=new ge(0);n.liquidityGross.eqn(0)||(e<n.tick?a=n.rewardGrowthsOutsideX64[o]:a=r[o].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[o])),s.push(P.wrappingSubU128(P.wrappingSubU128(r[o].rewardGrowthGlobalX64,i),a))}return s}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:r,add:s,epochInfo:o}){var h,f,I,S;let i=x.priceToSqrtPriceX64(new kt(e.price),e.mintA.decimals,e.mintB.decimals),a=x.getSqrtPriceX64FromTick(t.tickLower),c=x.getSqrtPriceX64FromTick(t.tickUpper),l=s?1+r:1-r,d=C.getAmountsFromLiquidity(i,a,c,n,s),[p,m]=[v(d.amountA,(h=e.mintA.extensions)==null?void 0:h.feeConfig,o,!0),v(d.amountB,(f=e.mintB.extensions)==null?void 0:f.feeConfig,o,!0)],[y,g]=[v(new ge(new kt(d.amountA.toString()).mul(l).toFixed(0)),(I=e.mintA.extensions)==null?void 0:I.feeConfig,o,!0),v(new ge(new kt(d.amountB.toString()).mul(l).toFixed(0)),(S=e.mintB.extensions)==null?void 0:S.feeConfig,o,!0)];return{liquidity:n,amountA:p,amountB:m,amountSlippageA:y,amountSlippageB:g,expirationTime:Pe(p.expirationTime,m.expirationTime)}}};var de=class{static getOutputAmountAndRemainAccounts(e,t,n,r,s,o=!1){let i=n.toBase58()===e.mintA.address,a=[],{isExist:c,startIndex:l,nextAccountMeta:d}=this.getFirstInitializedTickArray(e,i);if(!c||l===void 0||!d)throw new Error("Invalid tick array");a.push(d);let{allTrade:p,amountCalculated:m,accounts:y,sqrtPriceX64:g,feeAmount:h}=Ne.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,i,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,r,l,s,o);return a.push(...y),{allTrade:p,expectedAmountOut:m.mul(Te),remainingAccounts:a,executionPrice:g,feeAmount:h}}static getInputAmountAndRemainAccounts(e,t,n,r,s){let o=n.toBase58()===e.mintB.address,i=[],{isExist:a,startIndex:c,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,o);if(!a||c===void 0||!l)throw new Error("Invalid tick array");try{let g=this.preInitializedTickArrayStartIndex(e,o);if(g.isExist){let{publicKey:h}=ee(e.programId,e.id,g.nextStartIndex);i.push(h)}}catch{}i.push(l);let{amountCalculated:d,accounts:p,sqrtPriceX64:m,feeAmount:y}=Ne.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,o,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,r.mul(Te),c,s);return i.push(...p),{expectedAmountIn:d,remainingAccounts:i,executionPrice:m,feeAmount:y}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:r}=de.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?We.checkTickArrayIsInit(R.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):w.checkTickArrayIsInitialized(w.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:i}=ee(e.programId,e.id,r);return{isExist:!0,startIndex:r,nextAccountMeta:i}}let{isExist:s,nextStartIndex:o}=this.nextInitializedTickArrayStartIndex(e,R.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(s){let{publicKey:i}=ee(e.programId,e.id,o);return{isExist:!0,startIndex:o,nextAccountMeta:i}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/R.tickCount(e.tickSpacing)),r=t?w.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):w.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return r.length>0?{isExist:!0,nextStartIndex:r[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=R.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:r,tickIndex:s}=xe.nextInitializedTickArrayStartIndex(w.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(r)return{isExist:!0,nextStartIndex:s};t=s;let{isInit:o,tickIndex:i}=We.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(o)return{isExist:!0,nextStartIndex:i};if(t=i,t<J||t>$)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:r,rewardInfos:s}){var i,a,c;let o=[];for(let l=0;l<s.length;l++){let d=s[l],p=(c=(i=t.rewardDefaultInfos[l])==null?void 0:i.mint.programId)!=null?c:(a=await e.getAccountInfo(d.tokenMint))==null?void 0:a.owner;if(p===void 0)throw Error("get new reward mint info error");let m=M(F({},d),{perSecond:P.x64ToDecimal(d.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new ae(p)});if(m.tokenMint.equals(ae.default))continue;if(n<=m.openTime.toNumber()||r.eq(q)){o.push(m);continue}let y=new O(Math.min(m.endTime.toNumber(),n)),g=y.sub(m.lastUpdateTime),h=P.mulDivFloor(g,m.emissionsPerSecondX64,r),f=m.rewardGrowthGlobalX64.add(h),I=P.mulDivFloor(g,m.emissionsPerSecondX64,se),S=m.rewardTotalEmissioned.add(I);o.push(M(F({},m),{rewardGrowthGlobalX64:f,rewardTotalEmissioned:S,lastUpdateTime:y}))}return o}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:r}=this.tickRange(e);for(let s of t){let o=w.getTickArrayStartIndexByTick(s,e);if(o>=n||o<r)return!0}return!1}static tickRange(e){let t=xe.maxTickInTickarrayBitmap(e),n=-t;return t>$&&(t=R.getArrayStartIndex($,e)+R.tickCount(e)),n<J&&(n=R.getArrayStartIndex(J,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!R.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/R.tickCount(t)*Le}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let r=await ot(e,t.map(o=>({pubkey:o})),{batchRequest:n}),s={};for(let o of r)o.accountInfo!==null&&(s[o.pubkey.toString()]=sn.decode(o.accountInfo.data));return s}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let r={},s=[];for(let a of t){let c=w.getTickArrayStartIndexByTick(a.tickCurrent,a.tickSpacing),l=w.getInitializedTickArrayInRange(a.tickArrayBitmap,a.exBitmapInfo,a.tickSpacing,c,7);for(let d of l){let{publicKey:p}=ee(a.programId,a.id,d);s.push({pubkey:p}),r[p.toString()]=a.id}}let o=await ot(e,s,{batchRequest:n}),i={};for(let a of o){if(!a.accountInfo)continue;let c=r[a.pubkey.toString()];if(!c)continue;i[c.toString()]===void 0&&(i[c.toString()]={});let l=Ue.decode(a.accountInfo.data);i[c.toString()][l.startTickIndex]=M(F({},l),{address:a.pubkey})}return i}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:r=!1,updateOwnerRewardAndFee:s=!0}){var i;let o=[];for(let a=0;a<e.length;a++){let c=e[a];c!==null&&(o.find(l=>l.equals(c.state.programId))||o.push(c.state.programId))}if(n){let a=n.tokenAccounts.map(p=>p.accountInfo.mint),c=[];for(let p of a)for(let m of o)c.push(nn(m,p).publicKey);let l=await we(t,c,{batchRequest:r}),d={};for(let p of l){if(p===null)continue;let m=on.decode(p.data),y=m.poolId.toString(),g=e.find(D=>D.state.id.toBase58()===y);if(g===void 0)continue;let h=g.state,f=w._getTickPriceLegacy({poolInfo:h,tick:m.tickLower,baseIn:!0}),I=w._getTickPriceLegacy({poolInfo:h,tick:m.tickUpper,baseIn:!0}),{amountA:S,amountB:V}=C.getAmountsFromLiquidity(h.sqrtPriceX64,f.tickSqrtPriceX64,I.tickSqrtPriceX64,m.liquidity,!1),W=1/(1-Math.sqrt(Math.sqrt(f.price.div(I.price).toNumber())));g.positionAccount=[...(i=g.positionAccount)!=null?i:[],{poolId:m.poolId,nftMint:m.nftMint,priceLower:f.price,priceUpper:I.price,amountA:S,amountB:V,tickLower:m.tickLower,tickUpper:m.tickUpper,liquidity:m.liquidity,feeGrowthInsideLastX64A:m.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:m.feeGrowthInsideLastX64B,tokenFeesOwedA:m.tokenFeesOwedA,tokenFeesOwedB:m.tokenFeesOwedB,rewardInfos:m.rewardInfos.map(D=>M(F({},D),{pendingReward:new O(0)})),leverage:W,tokenFeeAmountA:new O(0),tokenFeeAmountB:new O(0)}];let T=await w.getTickArrayAddressByTick(g.state.programId,m.poolId,m.tickLower,g.state.tickSpacing),j=await w.getTickArrayAddressByTick(g.state.programId,m.poolId,m.tickUpper,g.state.tickSpacing);d[`${g.state.programId.toString()}-${m.poolId.toString()}-${m.tickLower}`]=T,d[`${g.state.programId.toString()}-${m.poolId.toString()}-${m.tickUpper}`]=j}if(s){let p=Object.values(d),m=await we(t,p,{batchRequest:r}),y={};for(let g=0;g<p.length;g++){let h=m[g];if(h===null)continue;let f=p[g].toString();y[f]=Ue.decode(h.data)}for(let{state:g,positionAccount:h}of e)if(!!h)for(let f of h){let I=`${g.programId.toString()}-${g.id.toString()}-${f.tickLower}`,S=`${g.programId.toString()}-${g.id.toString()}-${f.tickUpper}`,V=y[d[I].toString()],W=y[d[S].toString()],T=V.ticks[w.getTickOffsetInArray(f.tickLower,g.tickSpacing)],j=W.ticks[w.getTickOffsetInArray(f.tickUpper,g.tickSpacing)],{tokenFeeAmountA:D,tokenFeeAmountB:ne}=await Xe.GetPositionFees(g,f,T,j),Y=await Xe.GetPositionRewards(g,f,T,j);f.tokenFeeAmountA=D.gte(new O(0))?D:new O(0),f.tokenFeeAmountB=ne.gte(new O(0))?ne:new O(0);for(let X=0;X<Y.length;X++)f.rewardInfos[X].pendingReward=Y[X].gte(new O(0))?Y[X]:new O(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:r,amountIn:s,slippage:o,priceLimit:i=new N(0),catchLiquidityInsufficient:a=!1}){var ye;let c,l=n.toBase58()===e.mintA.address,[d,p]=l?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];i.equals(new N(0))?c=l?Ie.add(new O(1)):Se.sub(new O(1)):c=x.priceToSqrtPriceX64(i,e.mintA.decimals,e.mintB.decimals);let m=v(s,d,r,!1),{allTrade:y,expectedAmountOut:g,remainingAccounts:h,executionPrice:f,feeAmount:I}=de.getOutputAmountAndRemainAccounts(e,t,n,m.amount.sub((ye=m.fee)!=null?ye:q),c,a),S=v(g,p,r,!1),V=x.sqrtPriceX64ToPrice(f,e.mintA.decimals,e.mintB.decimals),W=l?V:new N(1).div(V),T=g.mul(new O(Math.floor((1-o)*1e10))).div(new O(1e10)),j=v(T,p,r,!1),D=l?e.currentPrice:new N(1).div(e.currentPrice),ne=new N(W).sub(D).abs(),Y=D,X=new Ae(new N(ne).mul(10**15).toFixed(0),new N(Y).mul(10**15).toFixed(0));return{allTrade:y,realAmountIn:m,amountOut:S,minAmountOut:j,expirationTime:Pe(m.expirationTime,S.expirationTime),currentPrice:e.currentPrice,executionPrice:W,priceImpact:X,fee:I,remainingAccounts:h,executionPriceX64:f}}static computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:r,slippage:s,epochInfo:o,catchLiquidityInsufficient:i=!1}){let a=r.address===e.mintB.address,[c,l]=a?[e.mintA,e.mintB]:[e.mintB,e.mintA],[d,p]=[new be(M(F({},c),{mint:c.address,isToken2022:c.programId===an.toBase58()})),new be(M(F({},l),{mint:l.address,isToken2022:l.programId===an.toBase58()}))],{allTrade:m,realAmountIn:y,amountOut:g,minAmountOut:h,expirationTime:f,currentPrice:I,executionPrice:S,priceImpact:V,fee:W,remainingAccounts:T,executionPriceX64:j}=de.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new ae(c.address),amountIn:n,slippage:s,epochInfo:o,catchLiquidityInsufficient:i}),D=M(F({},y),{amount:new Z(d,y.amount),fee:y.fee===void 0?void 0:new Z(d,y.fee)}),ne=M(F({},g),{amount:new Z(p,g.amount),fee:g.fee===void 0?void 0:new Z(p,g.fee)}),Y=M(F({},h),{amount:new Z(p,h.amount),fee:h.fee===void 0?void 0:new Z(p,h.fee)}),X=new me({baseToken:d,denominator:new O(10).pow(new O(20+d.decimals)),quoteToken:p,numerator:I.mul(new N(10**(20+p.decimals))).toFixed(0)}),ye=new me({baseToken:d,denominator:new O(10).pow(new O(20+d.decimals)),quoteToken:p,numerator:S.mul(new N(10**(20+p.decimals))).toFixed(0)}),ce=new Z(d,W);return{allTrade:m,realAmountIn:D,amountOut:ne,minAmountOut:Y,expirationTime:f,currentPrice:X,executionPrice:ye,priceImpact:V,fee:ce,remainingAccounts:T,executionPriceX64:j}}static computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:r,amountOut:s,slippage:o,priceLimit:i=new N(0)}){var Y;let a=n.toBase58()===e.mintA.address,c={[e.mintA.address]:e.mintA.extensions.feeConfig,[e.mintB.address]:e.mintB.extensions.feeConfig},l;i.equals(new N(0))?l=a?Se.sub(new O(1)):Ie.add(new O(1)):l=x.priceToSqrtPriceX64(i,e.mintA.decimals,e.mintB.decimals);let d=v(s,c[n.toString()],r,!0),{expectedAmountIn:p,remainingAccounts:m,executionPrice:y,feeAmount:g}=de.getInputAmountAndRemainAccounts(e,t,n,d.amount.sub((Y=d.fee)!=null?Y:q),l),h=a?e.mintB.address:e.mintA.address,f=v(p,c[h],r,!1),I=x.sqrtPriceX64ToPrice(y,e.mintA.decimals,e.mintB.decimals),S=a?I:new N(1).div(I),V=p.mul(new O(Math.floor((1+o)*1e10))).div(new O(1e10)),W=v(V,c[h],r,!0),T=a?e.currentPrice:new N(1).div(e.currentPrice),j=new N(S).sub(T).abs(),D=T,ne=new Ae(new N(j).mul(10**15).toFixed(0),new N(D).mul(10**15).toFixed(0));return{amountIn:f,maxAmountIn:W,realAmountOut:d,expirationTime:Pe(f.expirationTime,d.expirationTime),currentPrice:e.currentPrice,executionPrice:S,priceImpact:ne,fee:g,remainingAccounts:m}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:r}){var y,g,h;let s=e[t],o=w.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),i=w.getTickPrice({poolInfo:e,tick:r,baseIn:!0}).price.toNumber(),a=Math.max(o,s.priceMin),l=Math.min(i,s.priceMax)-a,d=i-o,p=s.priceMax-s.priceMin,m;return l<=0?m=0:d===l?m=p/l:p===l?m=l/d:m=l/p*(l/d),{feeApr:s.feeApr*m,rewardsApr:[((y=s.rewardApr[0])!=null?y:0)*m,((g=s.rewardApr[1])!=null?g:0)*m,((h=s.rewardApr[2])!=null?h:0)*m],apr:s.apr*m}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:r,liquidity:s,positionTickLowerIndex:o,positionTickUpperIndex:i,chainTime:a}){let c=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],d=r[ze(e.mintA.address).toString()],p=r[ze(e.mintB.address).toString()],m=e.mintA.decimals,y=e.mintB.decimals;if(!l||!d||!p)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let g=x.priceToSqrtPriceX64(new N(e.price),e.mintA.decimals,e.mintB.decimals),h=x.getSqrtPriceX64FromTick(o),f=x.getSqrtPriceX64FromTick(i),{amountSlippageA:I,amountSlippageB:S}=C.getAmountsFromLiquidityWithSlippage(g,h,f,t,!1,!1,0),{amountSlippageA:V,amountSlippageB:W}=C.getAmountsFromLiquidityWithSlippage(g,h,f,s,!1,!1,0),T=new N(I.toString()).div(new N(10).pow(m)).mul(d.value).add(new N(S.toString()).div(new N(10).pow(y)).mul(p.value)),j=new N(V.toString()).div(new N(10).pow(m)).mul(d.value).add(new N(W.toString()).div(new N(10).pow(y)).mul(p.value)),D=new N(1).div(T.add(j)),Y=new N(l.volumeFee).mul(365).div(c).mul(D).mul(100).toNumber(),X=3600*24*365,ye=e.rewardDefaultInfos.map(ce=>{var St,Ct;let He=ce.mint.decimals,It=r[ce.mint.address];return a<((St=ce.startTime)!=null?St:0)||a>((Ct=ce.endTime)!=null?Ct:0)||!ce.perSecond||!It||He===void 0?0:new N(It.value).mul(new N(ce.perSecond).mul(X)).div(new N(10).pow(He)).mul(D).mul(100).toNumber()});return{feeApr:Y,rewardsApr:ye,apr:Y+ye.reduce((ce,He)=>ce+He,0)}}static async getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:r,amount:s,slippage:o,add:i,epochInfo:a,amountHasFee:c}){var f,I;let l=x.priceToSqrtPriceX64(new N(e.price),e.mintA.decimals,e.mintB.decimals),d=x.getSqrtPriceX64FromTick(n),p=x.getSqrtPriceX64FromTick(r),m=v(s,(f=e[t?"mintA":"mintB"].extensions)==null?void 0:f.feeConfig,a,!c),y=new O(new N(m.amount.sub((I=m.fee)!=null?I:q).toString()).toFixed(0)),g;if(l.lte(d))g=t?C.getLiquidityFromTokenAmountA(d,p,y,!i):new O(0);else if(l.lte(p)){let S=C.getLiquidityFromTokenAmountA(l,p,y,!i),V=C.getLiquidityFromTokenAmountB(d,l,y);g=t?S:V}else g=t?new O(0):C.getLiquidityFromTokenAmountB(d,p,y);let h=await de.getAmountsFromLiquidity({epochInfo:a,poolInfo:e,tickLower:n,tickUpper:r,liquidity:g,slippage:o,add:i});return{liquidity:g,amountA:t?m:h.amountA,amountB:t?h.amountB:m,amountSlippageA:t?m:h.amountSlippageA,amountSlippageB:t?h.amountSlippageB:m,expirationTime:h.expirationTime}}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:r,liquidity:s,slippage:o,add:i}){var h,f,I,S;let a=x.getSqrtPriceX64FromTick(n),c=x.getSqrtPriceX64FromTick(r),l=i?1+o:1-o,d=C.getAmountsFromLiquidity(x.priceToSqrtPriceX64(new N(t.price),t.mintA.decimals,t.mintB.decimals),a,c,s,i),[p,m]=[v(d.amountA,(h=t.mintA.extensions)==null?void 0:h.feeConfig,e,!0),v(d.amountB,(f=t.mintB.extensions)==null?void 0:f.feeConfig,e,!0)],[y,g]=[v(d.amountA.muln(l),(I=t.mintA.extensions)==null?void 0:I.feeConfig,e,!0),v(d.amountB.muln(l),(S=t.mintB.extensions)==null?void 0:S.feeConfig,e,!0)];return{liquidity:s,amountA:p,amountB:m,amountSlippageA:y,amountSlippageB:g,expirationTime:Pe(p.expirationTime,m.expirationTime)}}static async fetchComputeMultipleClmmInfo({connection:e,poolList:t,rpcDataMap:n={}}){let r=t.filter(a=>!n[a.id]).map(a=>new ae(a.id));(await we(e,r)).forEach((a,c)=>{!a||(n[r[c].toBase58()]=rn.decode(a.data))});let o=t.map(a=>tt(new ae(a.programId),new ae(a.id)).publicKey),i=await de.fetchExBitmaps({connection:e,exBitmapAddress:o,batchRequest:!1});return t.reduce((a,c)=>M(F({},a),{[c.id]:M(F({},n[c.id]),{id:new ae(c.id),version:6,programId:new ae(c.programId),mintA:c.mintA,mintB:c.mintB,ammConfig:M(F({},c.config),{id:new ae(c.config.id),fundOwner:""}),currentPrice:new N(c.price),exBitmapAccount:tt(new ae(c.programId),new ae(c.id)).publicKey,exBitmapInfo:i[tt(new ae(c.programId),new ae(c.id)).publicKey.toBase58()],startTime:n[c.id].startTime.toNumber(),rewardInfos:n[c.id].rewardInfos})}),{})}static async fetchComputeClmmInfo({connection:e,poolInfo:t,rpcData:n}){return(await this.fetchComputeMultipleClmmInfo({connection:e,rpcDataMap:n?{[t.id]:n}:void 0,poolList:[t]}))[t.id]}};function sm({poolInfo:u,tickLower:e,tickUpper:t,amountA:n,amountB:r,slippage:s,add:o,epochInfo:i,amountHasFee:a}){var S,V,W,T;let[c,l,d,p]=e<t?[e,t,n,r]:[t,e,r,n],m=x.priceToSqrtPriceX64(new N(u.price),u.mintA.decimals,u.mintB.decimals),y=x.getSqrtPriceX64FromTick(c),g=x.getSqrtPriceX64FromTick(l),[h,f]=[v(d,(S=u.mintA.extensions)==null?void 0:S.feeConfig,i,!a),v(p,(V=u.mintB.extensions)==null?void 0:V.feeConfig,i,!a)],I=C.getLiquidityFromTokenAmounts(m,y,g,h.amount.sub((W=h.fee)!=null?W:q),f.amount.sub((T=f.fee)!=null?T:q));return C.getAmountsOutFromLiquidity({poolInfo:u,tickLower:e,tickUpper:t,liquidity:I,slippage:s,add:o,epochInfo:i,amountAddFee:!a})}var Bt={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};function am(u){return M(F({},u),{type:"Concentrated",programId:u.programId.toString(),id:u.id.toString(),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Clmm",price:u.currentPrice.toNumber(),mintAmountA:0,mintAmountB:0,feeRate:u.ammConfig.tradeFeeRate,openTime:u.startTime.toString(),tvl:0,day:Bt,week:Bt,month:Bt,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,burnPercent:0,config:M(F({},u.ammConfig),{id:u.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]})})}export{de as PoolUtils,am as clmmComputeInfoToApiInfo,sm as getLiquidityFromAmounts};
//# sourceMappingURL=pool.mjs.map