var un=Object.defineProperty,cn=Object.defineProperties;var mn=Object.getOwnPropertyDescriptors;var Ct=Object.getOwnPropertySymbols;var ln=Object.prototype.hasOwnProperty,dn=Object.prototype.propertyIsEnumerable;var Nt=(c,e,t)=>e in c?un(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,_=(c,e)=>{for(var t in e||(e={}))ln.call(e,t)&&Nt(c,t,e[t]);if(Ct)for(var t of Ct(e))dn.call(e,t)&&Nt(c,t,e[t]);return c},v=(c,e)=>cn(c,mn(e));import P from"bn.js";import ge from"decimal.js";import me from"bn.js";var _e=1e4;function V(c,e,t,n){if(e===void 0)return{amount:c,fee:void 0,expirationTime:void 0};let r=v(_({},e),{olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}}),s=t.epoch<r.newerTransferFee.epoch?r.olderTransferFee:r.newerTransferFee,o=new me(s.maximumFee.toString()),i=t.epoch<r.newerTransferFee.epoch?(Number(r.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(s.transferFeeBasisPoints===_e){let a=new me(s.maximumFee.toString());return{amount:c.add(a),fee:a,expirationTime:i}}else{let a=nt(c.mul(new me(_e)),new me(_e-s.transferFeeBasisPoints)),u=new me(s.maximumFee.toString()),l=a.sub(c).gt(u)?c.add(u):a,d=nt(l.mul(new me(s.transferFeeBasisPoints)),new me(_e)),p=d.gt(o)?o:d;return{amount:l,fee:p,expirationTime:i}}else{let a=nt(c.mul(new me(s.transferFeeBasisPoints)),new me(_e)),u=a.gt(o)?o:a;return{amount:c,fee:u,expirationTime:i}}}function we(c,e){return c===void 0?e:e===void 0?c:Math.min(c,e)}function nt(c,e){let{div:t,mod:n}=c.divmod(e);return n.gt(new me(0))?t.add(new me(1)):t}import ue from"bn.js";var U=new ue(0),pe=new ue(1),be=new ue(-1),re=new ue(1).shln(64),He=new ue(1).shln(128),rt=re.sub(pe),Me=64,Lt=He.subn(1),Q=-443636,J=-Q,Be=new ue("4295048016"),Ie=new ue("79226673521066979257578248091"),cr=new ue("4295048017"),mr=new ue("79226673521066979257578248090"),Rt=16,Et="59543866431248",Ft="184467440737095516",_t="15793534762490258745",je=new ue(10).pow(new ue(6));var lr=new ue("18446744073700000000");import{PublicKey as gn}from"@solana/web3.js";import{get as Mt,set as pn}from"lodash";var it=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Date.now().toString()}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},Dt={},fn={};function ie(c){let e=Mt(Dt,c);if(!e){let t=Mt(fn,c);e=new it({name:c,logLevel:t}),pn(Dt,c,e)}return e}import{MINT_SIZE as Ar,TOKEN_PROGRAM_ID as Pr,getTransferFeeConfig as kr,unpackMint as Br}from"@solana/spl-token";var ot=ie("Raydium_accountInfo_util");async function Ae(c,e,t){let{batchRequest:n,commitment:r="confirmed",chunkCount:s=100}=_({batchRequest:!1},t),o=st(e,s),i=new Array(o.length).fill([]);if(n){let a=o.map(d=>{let p=c._buildArgs([d.map(m=>m.toBase58())],r,"base64");return{methodName:"getMultipleAccounts",args:p}}),u=st(a,10);i=(await(await Promise.all(u.map(async d=>await c._rpcBatchRequest(d)))).flat()).map(d=>(d.error&&ot.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${d.error.message}`),d.result.value.map(p=>{if(p){let{data:m,executable:y,lamports:g,owner:T,rentEpoch:f}=p;return m.length!==2&&m[1]!=="base64"&&ot.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(m[0],"base64"),executable:y,lamports:g,owner:new gn(T),rentEpoch:f}}return null})))}else try{i=await Promise.all(o.map(a=>c.getMultipleAccountsInfo(a,r)))}catch(a){a instanceof Error&&ot.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${a.message}`)}return i.flat()}async function at(c,e,t){let n=await Ae(c,e.map(r=>r.pubkey),t);return e.map((r,s)=>v(_({},r),{accountInfo:n[s]}))}import he from"bn.js";import co from"decimal.js";import Pn from"big.js";import Je from"bn.js";import yn from"toformat";var bn=yn,De=bn;import Ye from"big.js";import hn from"bn.js";import xn from"decimal.js-light";import Oe from"bn.js";var Ot=9007199254740991;function oe(c){let e=ie("Raydium_parseBigNumberish");if(c instanceof Oe)return c;if(typeof c=="string"){if(c.match(/^-?[0-9]+$/))return new Oe(c);e.logWithError(`invalid BigNumberish string: ${c}`)}return typeof c=="number"?(c%1&&e.logWithError(`BigNumberish number underflow: ${c}`),(c>=Ot||c<=-Ot)&&e.logWithError(`BigNumberish number overflow: ${c}`),new Oe(String(c))):typeof c=="bigint"?new Oe(c.toString()):(e.error(`invalid BigNumberish value: ${c}`),new Oe(0))}var Qe=ie("module/fraction"),ct=De(Ye),Ke=De(xn),wn={[0]:Ke.ROUND_DOWN,[1]:Ke.ROUND_HALF_UP,[2]:Ke.ROUND_UP},An={[0]:Ye.roundDown,[1]:Ye.roundHalfUp,[2]:Ye.roundUp},E=class{constructor(e,t=new hn(1)){this.numerator=oe(e),this.denominator=oe(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new E(this.denominator,this.numerator)}add(e){let t=e instanceof E?e:new E(oe(e));return this.denominator.eq(t.denominator)?new E(this.numerator.add(t.numerator),this.denominator):new E(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof E?e:new E(oe(e));return this.denominator.eq(t.denominator)?new E(this.numerator.sub(t.numerator),this.denominator):new E(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof E?e:new E(oe(e));return new E(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof E?e:new E(oe(e));return new E(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||Qe.logWithError(`${e} is not an integer.`),e<=0&&Qe.logWithError(`${e} is not positive.`),Ke.set({precision:e+1,rounding:wn[n]});let r=new Ke(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return r.toFormat(r.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||Qe.logWithError(`${e} is not an integer.`),e<0&&Qe.logWithError(`${e} is negative.`),ct.DP=e,ct.RM=An[n]||1,new ct(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var kn=ie("Raydium_amount"),Kt=De(Pn);function Bn(c,e){let t="0",n="0";if(c.includes(".")){let r=c.split(".");r.length===2?([t,n]=r,n=n.padEnd(e,"0")):kn.logWithError(`invalid number string, num: ${c}`)}else t=c;return[t,n.slice(0,e)||n]}var Y=class extends E{constructor(t,n,r=!0,s){let o=new Je(0),i=mt.pow(new Je(t.decimals));if(r)o=oe(n);else{let a=new Je(0),u=new Je(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,d]=Bn(n.toString(),t.decimals);a=oe(l),u=oe(d)}a=a.mul(i),o=a.add(u)}super(o,i);this.logger=ie(s||"TokenAmount"),this.token=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.token.equals(t.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(t.raw)}lt(t){return this.token.equals(t.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(t.raw)}add(t){return this.token.equals(t.token)||this.logger.logWithError("add token not equals"),new Y(this.token,this.raw.add(t.raw))}subtract(t){return this.token.equals(t.token)||this.logger.logWithError("sub token not equals"),new Y(this.token,this.raw.sub(t.raw))}toSignificant(t=this.token.decimals,n,r=0){return super.toSignificant(t,n,r)}toFixed(t=this.token.decimals,n,r=0){return t>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,r)}toExact(t={groupSeparator:""}){return Kt.DP=this.token.decimals,new Kt(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}};import{PublicKey as In}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as vt}from"@solana/spl-token";var Gt={chainId:101,address:In.default.toBase58(),programId:vt.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},Se={chainId:101,address:"So11111111111111111111111111111111111111112",programId:vt.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};import{PublicKey as pt}from"@solana/web3.js";import{PublicKey as O,SystemProgram as qt,SYSVAR_RENT_PUBKEY as Sn}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Cn}from"@solana/spl-token";function lt({pubkey:c,isSigner:e=!1,isWritable:t=!0}){return{pubkey:c,isWritable:t,isSigner:e}}var ri=[lt({pubkey:Cn,isWritable:!1}),lt({pubkey:qt.programId,isWritable:!1}),lt({pubkey:Sn,isWritable:!1})];function dt({publicKey:c,transformSol:e}){let t=Vt(c.toString());if(t instanceof O)return e&&t.equals(ve)?ut:t;if(e&&t.toString()===ve.toBase58())return ut;if(typeof t=="string"){if(t===O.default.toBase58())return O.default;try{return new O(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function Vt(c){try{return new O(c)}catch{return c}}var ii=new O("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),oi=new O("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),si=new O("SysvarRent111111111111111111111111111111111"),ai=new O("SysvarC1ock11111111111111111111111111111111"),Nn=new O("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),ui=new O("Sysvar1nstructions1111111111111111111111111"),ci=qt.programId,mi=new O("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),li=new O("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),di=new O("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),pi=new O("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),fi=new O("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),gi=new O("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),yi=new O("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),bi=new O("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),Ti=new O("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),hi=new O("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),xi=new O("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),ut=new O("So11111111111111111111111111111111111111112"),ve=O.default;function Ze(c){return dt({publicKey:c,transformSol:!0})}var ft=class{constructor({mint:e,decimals:t,symbol:n,name:r,skipMint:s=!1,isToken2022:o=!1}){if(e===ve.toBase58()||e instanceof pt&&ve.equals(e)){this.decimals=Se.decimals,this.symbol=Se.symbol,this.name=Se.name,this.mint=new pt(Se.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=r||e.toString().substring(0,6),this.mint=s?pt.default:dt({publicKey:e}),this.isToken2022=o}equals(e){return this===e?!0:this.mint.equals(e.mint)}},Te=ft;Te.WSOL=new ft(v(_({},Se),{mint:Se.address}));var gt=class{constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},$e=gt;$e.SOL=new gt(Gt);import Ln from"bn.js";var Ut=new E(new Ln(100)),Pe=class extends E{toSignificant(e=5,t,n){return this.mul(Ut).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(Ut).toFixed(e,t,n)}};var Rn=ie("Raydium_price"),le=class extends E{constructor(t){let{baseToken:n,quoteToken:r,numerator:s,denominator:o}=t;super(s,o);this.baseToken=n,this.quoteToken=r,this.scalar=new E(yt(n.decimals),yt(r.decimals))}get raw(){return new E(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new le({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&Rn.logWithError("mul token not equals");let n=super.mul(t);return new le({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(t=this.quoteToken.decimals,n,r){return this.adjusted.toSignificant(t,n,r)}toFixed(t=this.quoteToken.decimals,n,r){return this.adjusted.toFixed(t,n,r)}};import{PublicKey as Ji}from"@solana/web3.js";import eo from"bn.js";var En=new he(0),xo=new he(1),wo=new he(2),Ao=new he(3),Po=new he(5),mt=new he(10),ko=new he(100),Bo=new he(1e3),Io=new he(1e4);function yt(c){return mt.pow(oe(c))}function st(c,e=1,t=[]){let n=[...c];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}import{PublicKey as Qo}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Jo}from"@solana/spl-token";import{ComputeBudgetProgram as _o,Keypair as Oo,PublicKey as _n,Transaction as vo,TransactionMessage as qo,VersionedTransaction as Vo}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as zo}from"@solana/spl-token";var Ho=ie("Raydium_txUtil");function Ge(c,e){let[t,n]=_n.findProgramAddressSync(c,e);return{publicKey:t,nonce:n}}import{PublicKey as b}from"@solana/web3.js";var ns=new b("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),rs=new b("CBuCnLe26faBpcBP2fktp4rp8abpcAnTWft6ZrP5Q4T"),is=new b("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),os=new b("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),ss=new b("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),as=new b("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),us=new b("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),cs=new b("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),ms=new b("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),ls=new b("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),ds=new b("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),ps=new b("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),fs=new b("kN1kEznaF5Xbd8LYuqtEFcxzWSBk5Fv6ygX6SqEGJVy"),gs=new b("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),ys=new b("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),bs=new b("7YttLkHDoNj9wyDur5pM1ejNaAvT9X4eqaYcHQqtj2G5"),Ts=new b("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),hs=new b("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),xs=new b("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),ws=new b("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),As=new b("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),Ps=new b("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),ks=new b("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),Bs=new b("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),Is=new b("3f7GcQFG397GAaEnv51zR6tsTVihYRydnydDD1cXekxH"),Ss=new b("LanMV9sAd7wArD4vJFi2qDdfnVhFxYSUg6eADduJ3uj"),Cs=new b("WLHv2UAZm6z4KyaaELi5pjdbJh6RESMva1Rnn8pJVVh"),Ns=new b("DRay6fNdQ5J82H7xV6uq2aV3mNrUZ1J4PgSKsWgptcm6"),Ls=new b("5xqNaZXX5eUi4p5HU4oz9i5QnwRNT2y6oN7yyn4qENeq"),Rs=new b("4Bu96XjU84XjPDSpveTVf6LYGCkfW5FK7SNkREWcEfV4"),Es=new b("6s1xP3hpbAfFoNtUNF8mfHsjr2Bd97JxFJRWLbL6aHuX");var Fs={OPEN_BOOK_PROGRAM:new b("EoTcMgcDRTJVZDMZWBoU6rhYHZfkNTVEAfz3uUJRcYGj"),SERUM_PROGRAM_ID_V3:new b("Ray1111111111111111111111111111111111111111"),AMM_V4:new b("DRaya7Kj3aMWQSy19kSjvmuwq9docCHofyP9kanQGaav"),AMM_STABLE:new b("DRayDdXc1NZQ9C3hRWmoSf8zK4iapgMnjdNZWrfwsP8m"),CLMM_PROGRAM_ID:new b("DRayAUgENGQBKVaX8owNhgzkEDyoHTGVEGHVJT1E9pfH"),CLMM_LOCK_PROGRAM_ID:new b("DRay25Usp3YJAi7beckgpGUC7mGJ2cR1AVPxhYfwVCUX"),CLMM_LOCK_AUTH_ID:new b("6Aoh8h2Lw2m5UGxYR8AdAL87jTWYeKoxM52mJRzfYwN"),CREATE_CPMM_POOL_PROGRAM:new b("DRaycpLY18LhpbydsBWbVJtxpNv9oXPgjRSfpF2bWpYb"),CREATE_CPMM_POOL_AUTH:new b("CXniRufdq5xL8t8jZAPxsPZDpuudwuJSPWnbcD5Y5Nxq"),CREATE_CPMM_POOL_FEE_ACC:new b("3oE58BKVt8KuYkGxx8zBojugnymWmBiyafWgMrnb6eYy"),LOCK_CPMM_PROGRAM:new b("DRay25Usp3YJAi7beckgpGUC7mGJ2cR1AVPxhYfwVCUX"),LOCK_CPMM_AUTH:new b("7qWVV8UY2bRJfDLP4s37YzBPKUkVB46DStYJBpYbQzu3"),UTIL1216:b.default,Router:new b("DRaybByLpbUL57LJARs3j8BitTxVfzBg351EaMr5UTCd"),FARM_PROGRAM_ID_V3:new b("DRayWyrLmEW5KEeqs8kdTMMaBabapqagaBC7KWpGtJeZ"),FARM_PROGRAM_ID_V4:new b("Ray1111111111111111111111111111111111111111"),FARM_PROGRAM_ID_V5:new b("DRayiCGSZgku1GTK6rXD6mVDdingXy6APAH1R6R5L2LC"),FARM_PROGRAM_ID_V6:new b("DRayzbYakXs45ELHkzH6vC3fuhQqTAnv5A68gdFuvZyZ"),LAUNCHPAD_PROGRAM:new b("DRay6fNdQ5J82H7xV6uq2aV3mNrUZ1J4PgSKsWgptcm6"),LAUNCHPAD_AUTH:new b("5xqNaZXX5eUi4p5HU4oz9i5QnwRNT2y6oN7yyn4qENeq"),LAUNCHPAD_PLATFORM:new b("2Jx4KTDrVSdWNazuGpcA8n3ZLTRGGBDxAWhuKe2Xcj2a"),LAUNCHPAD_CONFIG:new b("7ZR4zD7PYfY2XxoG1Gxcy2EgEeGYrpxrwzPuwdUBssEt"),FEE_DESTINATION_ID:new b("9y8ENuuZ3b19quffx9hQvRVygG5ky6snHfRvGpuSfeJy"),MODEL_DATA_PUBKEY:new b("Ray1111111111111111111111111111111111111111")};import{PublicKey as Mn,AddressLookupTableAccount as Xt}from"@solana/web3.js";var Dn={AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU:new Xt({key:new Mn("AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU"),state:Xt.deserialize(Buffer.from("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","base64"))})};import{PublicKey as Js,sendAndConfirmTransaction as $s,SystemProgram as na,Transaction as ra,TransactionMessage as oa,VersionedTransaction as sa}from"@solana/web3.js";import ua from"axios";import On from"bn.js";var ga=new On(1e6);function Wt(c){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,c,!1),new Uint8Array(e)}function bt(c,e){let t=0;for(let n=c-1;n>=0&&!e.testn(n);n--)t++;return t}function Tt(c,e){let t=0;for(let n=0;n<c&&!e.testn(n);n++)t++;return t}function qe(c,e){for(let t=0;t<c;t++)if(e.testn(t))return!1;return!0}function zt(c,e){return qe(c,e)?null:bt(c,e)}function Ht(c,e){return qe(c,e)?null:Tt(c,e)}var Ga=Buffer.from("amm_config","utf8"),qa=Buffer.from("pool","utf8"),Va=Buffer.from("pool_vault","utf8"),Ua=Buffer.from("pool_reward_vault","utf8"),Kn=Buffer.from("position","utf8"),vn=Buffer.from("tick_array","utf8"),Xa=Buffer.from("operation","utf8"),Gn=Buffer.from("pool_tick_array_bitmap_extension","utf8"),Wa=Buffer.from("observation","utf8");function $(c,e,t){return Ge([vn,e.toBuffer(),Wt(t)],c)}function jt(c,e){return Ge([Kn,e.toBuffer()],c)}function et(c,e){return Ge([Gn,e.toBuffer()],c)}var za=Buffer.from("locked_position","utf8");var Ha=Buffer.from("support_mint","utf8");import{PublicKey as ae}from"@solana/web3.js";import{TOKEN_2022_PROGRAM_ID as an}from"@solana/spl-token";import M from"bn.js";import N from"decimal.js";import{PublicKey as Zn}from"@solana/web3.js";import Jt,{isBN as $t}from"bn.js";import{bits as Qa,BitStructure as Ya,blob as qn,Blob as Ja,cstr as $a,f32 as eu,f32be as tu,f64 as nu,f64be as ru,greedy as iu,Layout as Vn,ns64 as ou,ns64be as su,nu64 as au,nu64be as uu,offset as cu,s16 as mu,s16be as lu,s24 as du,s24be as pu,s32 as Un,s32be as fu,s40 as gu,s40be as yu,s48 as bu,s48be as Tu,s8 as hu,seq as Xn,struct as xu,Structure as Wn,u16 as zn,u16be as wu,u24 as Au,u24be as Pu,u32 as ku,u32be as Bu,u40 as Iu,u40be as Su,u48 as Cu,u48be as Nu,u8 as Hn,UInt as jn,union as Lu,Union as Ru,unionLayoutDiscriminator as Eu,utf8 as Fu}from"@solana/buffer-layout";var ht=Vn,Zt=Wn;var xt=jn;var Qt=Hn,Ve=zn;var ke=Un;var Yt=Xn;var se=qn;var Re=class extends ht{constructor(t,n,r){super(t,r);this.blob=se(t),this.signed=n}decode(t,n=0){let r=new Jt(this.blob.decode(t,n),10,"le");return this.signed?r.fromTwos(this.span*8).clone():r}encode(t,n,r=0){return typeof t=="number"&&(t=new Jt(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),n,r)}};function te(c){return new xt(1,c)}function Ee(c){return new xt(4,c)}function S(c){return new Re(8,!1,c)}function G(c){return new Re(16,!1,c)}function en(c){return new Re(8,!0,c)}function tn(c){return new Re(16,!0,c)}var tt=class extends ht{constructor(t,n,r,s){super(t.span,s);this.layout=t,this.decoder=n,this.encoder=r}decode(t,n){return this.decoder(this.layout.decode(t,n))}encode(t,n,r){return this.layout.encode(this.encoder(t),n,r)}getSpan(t,n){return this.layout.getSpan(t,n)}};function F(c){return new tt(se(32),e=>new Zn(e),e=>e.toBuffer(),c)}function nn(c){return new tt(Qt(),Qn,Yn,c)}function Qn(c){if(c===0)return!1;if(c===1)return!0;throw new Error("Invalid bool: "+c)}function Yn(c){return c?1:0}var wt=class extends Zt{decode(e,t){return super.decode(e,t)}};function ee(c,e,t){return new wt(c,e,t)}function K(c,e,t){let n,r=typeof e=="number"?e:$t(e)?e.toNumber():new Proxy(e,{get(s,o){if(!n){let i=Reflect.get(s,"count");n=$t(i)?i.toNumber():i,Reflect.set(s,"count",n)}return Reflect.get(s,o)},set(s,o,i){return o==="count"&&(n=i),Reflect.set(s,o,i)}});return Yt(c,r,t)}import $n from"bn.js";import Fe from"decimal.js";var Jn=15,C=class{static async getTickArrays(e,t,n,r,s,o,i){let a=[],u=x.getTickArrayStartIndexByTick(r,s),l=x.getInitializedTickArrayInRange(o,i,s,u,Math.floor(Jn/2));for(let m=0;m<l.length;m++){let{publicKey:y}=$(t,n,l[m]);a.push(y)}let d=(await Ae(e,a)).map(m=>m!==null?Ue.decode(m.data):null),p={};for(let m=0;m<a.length;m++){let y=d[m];y!==null&&(p[y.startTickIndex]=v(_({},y),{address:a[m]}))}return p}static nextInitializedTick(e,t,n,r,s,o){let{initializedTick:i,tickArrayAddress:a,tickArrayStartTickIndex:u}=this.nextInitializedTickInOneArray(e,t,n,r,s,o);for(;i==null||i.liquidityGross.lten(0);){if(u=x.getNextTickArrayStartIndex(u,s,o),this.checkIsValidStartIndex(u,s))throw new Error("No enough initialized tickArray");let l=n[u];if(l===void 0)continue;let{nextTick:d,tickArrayAddress:p,tickArrayStartTickIndex:m}=this.firstInitializedTickInOneArray(e,t,l,o);[i,a,u]=[d,p,m]}if(i==null)throw new Error("No invaild tickArray cache");return{nextTick:i,tickArrayAddress:a,tickArrayStartTickIndex:u}}static nextInitializedTickArray(e,t,n,r,s){let o=Math.floor(e/C.tickCount(t)),i=n?x.searchLowBitFromStart(r,s,o-1,1,t):x.searchHightBitFromStart(r,s,o+1,1,t);return i.length>0?{isExist:!0,nextStartIndex:i[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,r){let s;if(r){let i=z-1;for(;i>=0;){let a=n.ticks[i];if(a.liquidityGross.gtn(0)){s=a;break}i=i-1}}else{let i=0;for(;i<z;){let a=n.ticks[i];if(a.liquidityGross.gtn(0)){s=a;break}i=i+1}}let{publicKey:o}=$(e,t,n.startTickIndex);return{nextTick:s,tickArrayAddress:o,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,r,s,o){let i=x.getTickArrayStartIndexByTick(r,s),a=Math.floor((r-i)/s),u=n[i];if(u==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:i};let l;if(o)for(;a>=0;){let p=u.ticks[a];if(p.liquidityGross.gtn(0)){l=p;break}a=a-1}else for(a=a+1;a<z;){let p=u.ticks[a];if(p.liquidityGross.gtn(0)){l=p;break}a=a+1}let{publicKey:d}=$(e,t,i);return{initializedTick:l,tickArrayAddress:d,tickArrayStartTickIndex:u.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(x.checkIsOutOfBoundary(e)){if(e>J)return!1;let n=x.getTickArrayStartIndexByTick(Q,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return z*e}};var z=60,Ne=512,x=class{static getTickArrayAddressByTick(e,t,n,r){let s=x.getTickArrayStartIndexByTick(n,r),{publicKey:o}=$(e,t,s);return o}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=x.getTickArrayStartIndexByTick(e,t),r=Math.floor((e-n)/t);if(r<0||r>=z)throw new Error("tick offset in array overflow");return r}static getTickArrayBitIndex(e,t){let n=C.tickCount(t),r=e/n;return e<0&&e%n!=0?r=Math.ceil(r)-1:r=Math.floor(r),r}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*C.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*z,r=Math.floor(e/n)+512;return Math.abs(r)}static checkTickArrayIsInitialized(e,t,n){let r=n*z,s=Math.floor(t/r)+512,o=Math.abs(s);return{isInitialized:e.testn(o),startIndex:(o-512)*r}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*z:e+t*z}static mergeTickArrayBitmap(e){let t=new $n(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,r,s){let o=Math.floor(r/(n*z));return[...x.searchLowBitFromStart(e,t,o-1,s,n),...x.searchHightBitFromStart(e,t,o,s,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return x.searchHightBitFromStart(e,t,-7680,Ne,n)}static getAllInitializedTickArrayInfo(e,t,n,r,s){let o=[],i=x.getAllInitializedTickArrayStartIndex(n,r,s);for(let a of i){let{publicKey:u}=$(e,t,a);o.push({tickArrayStartIndex:a,tickArrayAddress:u})}return o}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,r,s){let o=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>x.mergeTickArrayBitmap(u)),i=[];for(;n>=-7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(o[u].testn(l)&&i.push(n),n--,i.length===r)break}let a=C.tickCount(s);return i.map(u=>u*a)}static searchHightBitFromStart(e,t,n,r,s){let o=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>x.mergeTickArrayBitmap(u)),i=[];for(;n<7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(o[u].testn(l)&&i.push(n),n++,i.length===r)break}let a=C.tickCount(s);return i.map(u=>u*a)}static checkIsOutOfBoundary(e){return e<Q||e>J}static nextInitTick(e,t,n,r,s){if(C.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let i=Math.floor((t-e.startTickIndex)/n);if(r)for(;i>=0;){if(e.ticks[i].liquidityGross.gtn(0))return e.ticks[i];i=i-1}else for(s||(i=i+1);i<z;){if(e.ticks[i].liquidityGross.gtn(0))return e.ticks[i];i=i+1}return null}static firstInitializedTick(e,t){if(t){let n=z-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<z;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let r=w.getSqrtPriceX64FromTick(t),s=w.sqrtPriceX64ToPrice(r,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:s,tickSqrtPriceX64:r}:{tick:t,price:new Fe(1).div(s),tickSqrtPriceX64:r}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let r=n?t:new Fe(1).div(t),s=Ce.getTickWithPriceAndTickspacing(r,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),o=w.getSqrtPriceX64FromTick(s),i=w.sqrtPriceX64ToPrice(o,e.mintA.decimals,e.mintB.decimals);return n?{tick:s,price:i}:{tick:s,price:new Fe(1).div(i)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let r=w.getSqrtPriceX64FromTick(t),s=w.sqrtPriceX64ToPrice(r,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:s,tickSqrtPriceX64:r}:{tick:t,price:new Fe(1).div(s),tickSqrtPriceX64:r}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let r=n?t:new Fe(1).div(t),s=Ce.getTickWithPriceAndTickspacing(r,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),o=w.getSqrtPriceX64FromTick(s),i=w.sqrtPriceX64ToPrice(o,e.mintA.decimals,e.mintB.decimals);return n?{tick:s,price:i}:{tick:s,price:new Fe(1).div(i)}}};var At=14,xe=class{static maxTickInTickarrayBitmap(e){return e*z*Ne}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),r=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(r+=1);let s=n*r;return e<0?{minValue:-s,maxValue:-s+n}:{minValue:s,maxValue:s+n}}static nextInitializedTickArrayStartIndex(e,t,n,r){if(!C.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let s=this.maxTickInTickarrayBitmap(n),o=r?t-C.tickCount(n):t+C.tickCount(n);if(o<-s||o>=s)return{isInit:!1,tickIndex:t};let i=n*z,a=o/i+512;o<0&&o%i!=0&&a--;let u=Math.abs(a);if(r){let l=e.shln(1024-u-1),d=zt(1024,l);if(d!==null){let p=(u-d-512)*i;return{isInit:!0,tickIndex:p}}else return{isInit:!1,tickIndex:-s}}else{let l=e.shrn(u),d=Ht(1024,l);if(d!==null){let p=(u+d-512)*i;return{isInit:!0,tickIndex:p}}else return{isInit:!1,tickIndex:s-C.tickCount(n)}}}},Xe=class{static getBitmapOffset(e,t){if(!C.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=xe.maxTickInTickarrayBitmap(t),r=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&r--,r}static getBitmap(e,t,n){let r=this.getBitmapOffset(e,t);return e<0?{offset:r,tickarrayBitmap:n.negativeTickArrayBitmap[r]}:{offset:r,tickarrayBitmap:n.positiveTickArrayBitmap[r]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:r}=this.extensionTickBoundary(t);if(e>=r&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=xe.maxTickInTickarrayBitmap(e),n=-t;if(J<=t)throw Error(`extensionTickBoundary check error: ${J}, ${t}`);if(n<=Q)throw Error(`extensionTickBoundary check error: ${n}, ${Q}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:r}=this.getBitmap(e,t,n),s=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:x.mergeTickArrayBitmap(r).testn(s),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,r){let s=C.tickCount(t),o=n?e-s:e+s,{tickarrayBitmap:i}=this.getBitmap(o,t,r);return this.nextInitializedTickArrayInBitmap(i,o,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,r){let{minValue:s,maxValue:o}=xe.getBitmapTickBoundary(t,n),i=this.tickArrayOffsetInBitmap(t,n);if(r){let a=x.mergeTickArrayBitmap(e).shln(Ne-1-i),u=qe(512,a)?null:bt(512,a);if(u!==null){let l=t-u*C.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s}}else{let a=x.mergeTickArrayBitmap(e).shrn(i),u=qe(512,a)?null:Tt(512,a);if(u!==null){let l=t+u*C.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:o-C.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%xe.maxTickInTickarrayBitmap(t),r=Math.floor(n/C.tickCount(t));return e<0&&n!=0&&(r=Ne-r),r}};var gc=ee([se(8),te("bump"),Ve("index"),F(""),Ee("protocolFeeRate"),Ee("tradeFeeRate"),Ve("tickSpacing"),K(S(),8,"")]),er=ee([Ee("blockTimestamp"),en("tickCumulative"),K(S(),4)]),yc=ee([se(8),nn("initialized"),S("recentEpoch"),Ve("observationIndex"),F("poolId"),K(er,100,"observations"),K(S(),4)]),tr=ee([te("rewardState"),S("openTime"),S("endTime"),S("lastUpdateTime"),G("emissionsPerSecondX64"),S("rewardTotalEmissioned"),S("rewardClaimed"),F("tokenMint"),F("tokenVault"),F("creator"),G("rewardGrowthGlobalX64")]),rn=ee([se(8),te("bump"),F("ammConfig"),F("creator"),F("mintA"),F("mintB"),F("vaultA"),F("vaultB"),F("observationId"),te("mintDecimalsA"),te("mintDecimalsB"),Ve("tickSpacing"),G("liquidity"),G("sqrtPriceX64"),ke("tickCurrent"),Ee(),G("feeGrowthGlobalX64A"),G("feeGrowthGlobalX64B"),S("protocolFeesTokenA"),S("protocolFeesTokenB"),G("swapInAmountTokenA"),G("swapOutAmountTokenB"),G("swapInAmountTokenB"),G("swapOutAmountTokenA"),te("status"),K(te(),7,""),K(tr,3,"rewardInfos"),K(S(),16,"tickArrayBitmap"),S("totalFeesTokenA"),S("totalFeesClaimedTokenA"),S("totalFeesTokenB"),S("totalFeesClaimedTokenB"),S("fundFeesTokenA"),S("fundFeesTokenB"),S("startTime"),K(S(),15*4-3,"padding")]),nr=ee([G("growthInsideLastX64"),S("rewardAmountOwed")]),on=ee([se(8),te("bump"),F("nftMint"),F("poolId"),ke("tickLower"),ke("tickUpper"),G("liquidity"),G("feeGrowthInsideLastX64A"),G("feeGrowthInsideLastX64B"),S("tokenFeesOwedA"),S("tokenFeesOwedB"),K(nr,3,"rewardInfos"),K(S(),8,"")]),bc=ee([se(8),te("bump"),F("poolId"),ke("tickLowerIndex"),ke("tickUpperIndex"),G("liquidity"),G("feeGrowthInsideLastX64A"),G("feeGrowthInsideLastX64B"),S("tokenFeesOwedA"),S("tokenFeesOwedB"),K(G(),3,"rewardGrowthInside"),K(S(),8,"")]),rr=ee([ke("tick"),tn("liquidityNet"),G("liquidityGross"),G("feeGrowthOutsideX64A"),G("feeGrowthOutsideX64B"),K(G(),3,"rewardGrowthsOutsideX64"),K(Ee(),13,"")]),Ue=ee([se(8),F("poolId"),ke("startTickIndex"),K(rr,z,"ticks"),te("initializedTickCount"),K(te(),115,"")]),Tc=ee([se(329),K(F(),100,"whitelistMints")]),sn=ee([se(8),F("poolId"),K(K(S(),8),At,"positiveTickArrayBitmap"),K(K(S(),8),At,"negativeTickArrayBitmap")]),hc=ee([S(),te("bump"),F("owner"),F("poolId"),F("positionId"),F("nftAccount"),K(S(),8)]),xc=ee([se(8),te("bump"),F("lockOwner"),F("poolId"),F("positionId"),F("nftAccount"),F("lockNftMint"),S("recentEpoch"),K(S(),8)]);import fe from"bn.js";import Pt from"decimal.js";var We=class{static getfeeGrowthInside(e,t,n){let r=new fe(0),s=new fe(0);e.tickCurrent>=t.tick?(r=t.feeGrowthOutsideX64A,s=t.feeGrowthOutsideX64B):(r=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),s=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let o=new fe(0),i=new fe(0);e.tickCurrent<n.tick?(o=n.feeGrowthOutsideX64A,i=n.feeGrowthOutsideX64B):(o=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),i=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let a=A.wrappingSubU128(A.wrappingSubU128(e.feeGrowthGlobalX64A,r),o),u=A.wrappingSubU128(A.wrappingSubU128(e.feeGrowthGlobalX64B,s),i);return{feeGrowthInsideX64A:a,feeGrowthInsideBX64:u}}static GetPositionFees(e,t,n,r){let{feeGrowthInsideX64A:s,feeGrowthInsideBX64:o}=this.getfeeGrowthInside(e,n,r),i=A.mulDivFloor(A.wrappingSubU128(s,t.feeGrowthInsideLastX64A),t.liquidity,re),a=t.tokenFeesOwedA.add(i),u=A.mulDivFloor(A.wrappingSubU128(o,t.feeGrowthInsideLastX64B),t.liquidity,re),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:a,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,r){let{feeGrowthInsideX64A:s,feeGrowthInsideBX64:o}=this.getfeeGrowthInside(e,n,r),i=A.mulDivFloor(A.wrappingSubU128(s,t.feeGrowthInsideLastX64A),t.liquidity,re),a=t.tokenFeesOwedA.add(i),u=A.mulDivFloor(A.wrappingSubU128(o,t.feeGrowthInsideLastX64B),t.liquidity,re),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:a,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,r){let s=[],o=this.getRewardGrowthInsideV2(e.tickCurrent,n,r,e.rewardInfos);for(let i=0;i<o.length;i++){let a=o[i],u=t.rewardInfos[i],l=A.wrappingSubU128(a,u.growthInsideLastX64),d=A.mulDivFloor(l,t.liquidity,re),p=u.rewardAmountOwed.add(d);s.push(p)}return s}static GetPositionRewards(e,t,n,r){let s=[],o=this.getRewardGrowthInside(e.tickCurrent,n,r,e.rewardInfos);for(let i=0;i<o.length;i++){let a=o[i],u=t.rewardInfos[i],l=A.wrappingSubU128(a,u.growthInsideLastX64),d=A.mulDivFloor(l,t.liquidity,re),p=u.rewardAmountOwed.add(d);s.push(p)}return s}static getRewardGrowthInside(e,t,n,r){let s=[];for(let o=0;o<r.length;o++){let i=new fe(0);t.liquidityGross.eqn(0)?i=r[o].rewardGrowthGlobalX64:e<t.tick?i=r[o].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[o]):i=t.rewardGrowthsOutsideX64[o];let a=new fe(0);n.liquidityGross.eqn(0)||(e<n.tick?a=n.rewardGrowthsOutsideX64[o]:a=r[o].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[o])),s.push(A.wrappingSubU128(A.wrappingSubU128(r[o].rewardGrowthGlobalX64,i),a))}return s}static getRewardGrowthInsideV2(e,t,n,r){let s=[];for(let o=0;o<r.length;o++){let i=new fe(0);t.liquidityGross.eqn(0)?i=r[o].rewardGrowthGlobalX64:e<t.tick?i=r[o].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[o]):i=t.rewardGrowthsOutsideX64[o];let a=new fe(0);n.liquidityGross.eqn(0)||(e<n.tick?a=n.rewardGrowthsOutsideX64[o]:a=r[o].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[o])),s.push(A.wrappingSubU128(A.wrappingSubU128(r[o].rewardGrowthGlobalX64,i),a))}return s}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:r,add:s,epochInfo:o}){var T,f,I,L;let i=w.priceToSqrtPriceX64(new Pt(e.price),e.mintA.decimals,e.mintB.decimals),a=w.getSqrtPriceX64FromTick(t.tickLower),u=w.getSqrtPriceX64FromTick(t.tickUpper),l=s?1+r:1-r,d=R.getAmountsFromLiquidity(i,a,u,n,s),[p,m]=[V(d.amountA,(T=e.mintA.extensions)==null?void 0:T.feeConfig,o,!0),V(d.amountB,(f=e.mintB.extensions)==null?void 0:f.feeConfig,o,!0)],[y,g]=[V(new fe(new Pt(d.amountA.toString()).mul(l).toFixed(0)),(I=e.mintA.extensions)==null?void 0:I.feeConfig,o,!0),V(new fe(new Pt(d.amountB.toString()).mul(l).toFixed(0)),(L=e.mintB.extensions)==null?void 0:L.feeConfig,o,!0)];return{liquidity:n,amountA:p,amountB:m,amountSlippageA:y,amountSlippageB:g,expirationTime:we(p.expirationTime,m.expirationTime)}}};var de=class{static getOutputAmountAndRemainAccounts(e,t,n,r,s,o=!1){let i=n.toBase58()===e.mintA.address,a=[],{isExist:u,startIndex:l,nextAccountMeta:d}=this.getFirstInitializedTickArray(e,i);if(!u||l===void 0||!d)throw new Error("Invalid tick array");a.push(d);let{allTrade:p,amountCalculated:m,accounts:y,sqrtPriceX64:g,feeAmount:T}=Le.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,i,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,r,l,s,o);return a.push(...y),{allTrade:p,expectedAmountOut:m.mul(be),remainingAccounts:a,executionPrice:g,feeAmount:T}}static getInputAmountAndRemainAccounts(e,t,n,r,s){let o=n.toBase58()===e.mintB.address,i=[],{isExist:a,startIndex:u,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,o);if(!a||u===void 0||!l)throw new Error("Invalid tick array");try{let g=this.preInitializedTickArrayStartIndex(e,o);if(g.isExist){let{publicKey:T}=$(e.programId,e.id,g.nextStartIndex);i.push(T)}}catch{}i.push(l);let{amountCalculated:d,accounts:p,sqrtPriceX64:m,feeAmount:y}=Le.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,o,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,r.mul(be),u,s);return i.push(...p),{expectedAmountIn:d,remainingAccounts:i,executionPrice:m,feeAmount:y}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:r}=de.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?Xe.checkTickArrayIsInit(C.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):x.checkTickArrayIsInitialized(x.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:i}=$(e.programId,e.id,r);return{isExist:!0,startIndex:r,nextAccountMeta:i}}let{isExist:s,nextStartIndex:o}=this.nextInitializedTickArrayStartIndex(e,C.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(s){let{publicKey:i}=$(e.programId,e.id,o);return{isExist:!0,startIndex:o,nextAccountMeta:i}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/C.tickCount(e.tickSpacing)),r=t?x.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):x.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return r.length>0?{isExist:!0,nextStartIndex:r[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=C.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:r,tickIndex:s}=xe.nextInitializedTickArrayStartIndex(x.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(r)return{isExist:!0,nextStartIndex:s};t=s;let{isInit:o,tickIndex:i}=Xe.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(o)return{isExist:!0,nextStartIndex:i};if(t=i,t<Q||t>J)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:r,rewardInfos:s}){var i,a,u;let o=[];for(let l=0;l<s.length;l++){let d=s[l],p=(u=(i=t.rewardDefaultInfos[l])==null?void 0:i.mint.programId)!=null?u:(a=await e.getAccountInfo(d.tokenMint))==null?void 0:a.owner;if(p===void 0)throw Error("get new reward mint info error");let m=v(_({},d),{perSecond:A.x64ToDecimal(d.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new ae(p)});if(m.tokenMint.equals(ae.default))continue;if(n<=m.openTime.toNumber()||r.eq(U)){o.push(m);continue}let y=new M(Math.min(m.endTime.toNumber(),n)),g=y.sub(m.lastUpdateTime),T=A.mulDivFloor(g,m.emissionsPerSecondX64,r),f=m.rewardGrowthGlobalX64.add(T),I=A.mulDivFloor(g,m.emissionsPerSecondX64,re),L=m.rewardTotalEmissioned.add(I);o.push(v(_({},m),{rewardGrowthGlobalX64:f,rewardTotalEmissioned:L,lastUpdateTime:y}))}return o}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:r}=this.tickRange(e);for(let s of t){let o=x.getTickArrayStartIndexByTick(s,e);if(o>=n||o<r)return!0}return!1}static tickRange(e){let t=xe.maxTickInTickarrayBitmap(e),n=-t;return t>J&&(t=C.getArrayStartIndex(J,e)+C.tickCount(e)),n<Q&&(n=C.getArrayStartIndex(Q,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!C.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/C.tickCount(t)*Ne}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let r=await at(e,t.map(o=>({pubkey:o})),{batchRequest:n}),s={};for(let o of r)o.accountInfo!==null&&(s[o.pubkey.toString()]=sn.decode(o.accountInfo.data));return s}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let r={},s=[];for(let a of t){let u=x.getTickArrayStartIndexByTick(a.tickCurrent,a.tickSpacing),l=x.getInitializedTickArrayInRange(a.tickArrayBitmap,a.exBitmapInfo,a.tickSpacing,u,7);for(let d of l){let{publicKey:p}=$(a.programId,a.id,d);s.push({pubkey:p}),r[p.toString()]=a.id}}let o=await at(e,s,{batchRequest:n}),i={};for(let a of o){if(!a.accountInfo)continue;let u=r[a.pubkey.toString()];if(!u)continue;i[u.toString()]===void 0&&(i[u.toString()]={});let l=Ue.decode(a.accountInfo.data);i[u.toString()][l.startTickIndex]=v(_({},l),{address:a.pubkey})}return i}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:r=!1,updateOwnerRewardAndFee:s=!0}){var i;let o=[];for(let a=0;a<e.length;a++){let u=e[a];u!==null&&(o.find(l=>l.equals(u.state.programId))||o.push(u.state.programId))}if(n){let a=n.tokenAccounts.map(p=>p.accountInfo.mint),u=[];for(let p of a)for(let m of o)u.push(jt(m,p).publicKey);let l=await Ae(t,u,{batchRequest:r}),d={};for(let p of l){if(p===null)continue;let m=on.decode(p.data),y=m.poolId.toString(),g=e.find(D=>D.state.id.toBase58()===y);if(g===void 0)continue;let T=g.state,f=x._getTickPriceLegacy({poolInfo:T,tick:m.tickLower,baseIn:!0}),I=x._getTickPriceLegacy({poolInfo:T,tick:m.tickUpper,baseIn:!0}),{amountA:L,amountB:X}=R.getAmountsFromLiquidity(T.sqrtPriceX64,f.tickSqrtPriceX64,I.tickSqrtPriceX64,m.liquidity,!1),W=1/(1-Math.sqrt(Math.sqrt(f.price.div(I.price).toNumber())));g.positionAccount=[...(i=g.positionAccount)!=null?i:[],{poolId:m.poolId,nftMint:m.nftMint,priceLower:f.price,priceUpper:I.price,amountA:L,amountB:X,tickLower:m.tickLower,tickUpper:m.tickUpper,liquidity:m.liquidity,feeGrowthInsideLastX64A:m.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:m.feeGrowthInsideLastX64B,tokenFeesOwedA:m.tokenFeesOwedA,tokenFeesOwedB:m.tokenFeesOwedB,rewardInfos:m.rewardInfos.map(D=>v(_({},D),{pendingReward:new M(0)})),leverage:W,tokenFeeAmountA:new M(0),tokenFeeAmountB:new M(0)}];let h=await x.getTickArrayAddressByTick(g.state.programId,m.poolId,m.tickLower,g.state.tickSpacing),j=await x.getTickArrayAddressByTick(g.state.programId,m.poolId,m.tickUpper,g.state.tickSpacing);d[`${g.state.programId.toString()}-${m.poolId.toString()}-${m.tickLower}`]=h,d[`${g.state.programId.toString()}-${m.poolId.toString()}-${m.tickUpper}`]=j}if(s){let p=Object.values(d),m=await Ae(t,p,{batchRequest:r}),y={};for(let g=0;g<p.length;g++){let T=m[g];if(T===null)continue;let f=p[g].toString();y[f]=Ue.decode(T.data)}for(let{state:g,positionAccount:T}of e)if(!!T)for(let f of T){let I=`${g.programId.toString()}-${g.id.toString()}-${f.tickLower}`,L=`${g.programId.toString()}-${g.id.toString()}-${f.tickUpper}`,X=y[d[I].toString()],W=y[d[L].toString()],h=X.ticks[x.getTickOffsetInArray(f.tickLower,g.tickSpacing)],j=W.ticks[x.getTickOffsetInArray(f.tickUpper,g.tickSpacing)],{tokenFeeAmountA:D,tokenFeeAmountB:ne}=await We.GetPositionFees(g,f,h,j),Z=await We.GetPositionRewards(g,f,h,j);f.tokenFeeAmountA=D.gte(new M(0))?D:new M(0),f.tokenFeeAmountB=ne.gte(new M(0))?ne:new M(0);for(let q=0;q<Z.length;q++)f.rewardInfos[q].pendingReward=Z[q].gte(new M(0))?Z[q]:new M(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:r,amountIn:s,slippage:o,priceLimit:i=new N(0),catchLiquidityInsufficient:a=!1}){var ye;let u,l=n.toBase58()===e.mintA.address,[d,p]=l?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];i.equals(new N(0))?u=l?Be.add(new M(1)):Ie.sub(new M(1)):u=w.priceToSqrtPriceX64(i,e.mintA.decimals,e.mintB.decimals);let m=V(s,d,r,!1),{allTrade:y,expectedAmountOut:g,remainingAccounts:T,executionPrice:f,feeAmount:I}=de.getOutputAmountAndRemainAccounts(e,t,n,m.amount.sub((ye=m.fee)!=null?ye:U),u,a),L=V(g,p,r,!1),X=w.sqrtPriceX64ToPrice(f,e.mintA.decimals,e.mintB.decimals),W=l?X:new N(1).div(X),h=g.mul(new M(Math.floor((1-o)*1e10))).div(new M(1e10)),j=V(h,p,r,!1),D=l?e.currentPrice:new N(1).div(e.currentPrice),ne=new N(W).sub(D).abs(),Z=D,q=new Pe(new N(ne).mul(10**15).toFixed(0),new N(Z).mul(10**15).toFixed(0));return{allTrade:y,realAmountIn:m,amountOut:L,minAmountOut:j,expirationTime:we(m.expirationTime,L.expirationTime),currentPrice:e.currentPrice,executionPrice:W,priceImpact:q,fee:I,remainingAccounts:T,executionPriceX64:f}}static computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:r,slippage:s,epochInfo:o,catchLiquidityInsufficient:i=!1}){let a=r.address===e.mintB.address,[u,l]=a?[e.mintA,e.mintB]:[e.mintB,e.mintA],[d,p]=[new Te(v(_({},u),{mint:u.address,isToken2022:u.programId===an.toBase58()})),new Te(v(_({},l),{mint:l.address,isToken2022:l.programId===an.toBase58()}))],{allTrade:m,realAmountIn:y,amountOut:g,minAmountOut:T,expirationTime:f,currentPrice:I,executionPrice:L,priceImpact:X,fee:W,remainingAccounts:h,executionPriceX64:j}=de.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new ae(u.address),amountIn:n,slippage:s,epochInfo:o,catchLiquidityInsufficient:i}),D=v(_({},y),{amount:new Y(d,y.amount),fee:y.fee===void 0?void 0:new Y(d,y.fee)}),ne=v(_({},g),{amount:new Y(p,g.amount),fee:g.fee===void 0?void 0:new Y(p,g.fee)}),Z=v(_({},T),{amount:new Y(p,T.amount),fee:T.fee===void 0?void 0:new Y(p,T.fee)}),q=new le({baseToken:d,denominator:new M(10).pow(new M(20+d.decimals)),quoteToken:p,numerator:I.mul(new N(10**(20+p.decimals))).toFixed(0)}),ye=new le({baseToken:d,denominator:new M(10).pow(new M(20+d.decimals)),quoteToken:p,numerator:L.mul(new N(10**(20+p.decimals))).toFixed(0)}),ce=new Y(d,W);return{allTrade:m,realAmountIn:D,amountOut:ne,minAmountOut:Z,expirationTime:f,currentPrice:q,executionPrice:ye,priceImpact:X,fee:ce,remainingAccounts:h,executionPriceX64:j}}static computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:r,amountOut:s,slippage:o,priceLimit:i=new N(0)}){var Z;let a=n.toBase58()===e.mintA.address,u={[e.mintA.address]:e.mintA.extensions.feeConfig,[e.mintB.address]:e.mintB.extensions.feeConfig},l;i.equals(new N(0))?l=a?Ie.sub(new M(1)):Be.add(new M(1)):l=w.priceToSqrtPriceX64(i,e.mintA.decimals,e.mintB.decimals);let d=V(s,u[n.toString()],r,!0),{expectedAmountIn:p,remainingAccounts:m,executionPrice:y,feeAmount:g}=de.getInputAmountAndRemainAccounts(e,t,n,d.amount.sub((Z=d.fee)!=null?Z:U),l),T=a?e.mintB.address:e.mintA.address,f=V(p,u[T],r,!1),I=w.sqrtPriceX64ToPrice(y,e.mintA.decimals,e.mintB.decimals),L=a?I:new N(1).div(I),X=p.mul(new M(Math.floor((1+o)*1e10))).div(new M(1e10)),W=V(X,u[T],r,!0),h=a?e.currentPrice:new N(1).div(e.currentPrice),j=new N(L).sub(h).abs(),D=h,ne=new Pe(new N(j).mul(10**15).toFixed(0),new N(D).mul(10**15).toFixed(0));return{amountIn:f,maxAmountIn:W,realAmountOut:d,expirationTime:we(f.expirationTime,d.expirationTime),currentPrice:e.currentPrice,executionPrice:L,priceImpact:ne,fee:g,remainingAccounts:m}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:r}){var y,g,T;let s=e[t],o=x.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),i=x.getTickPrice({poolInfo:e,tick:r,baseIn:!0}).price.toNumber(),a=Math.max(o,s.priceMin),l=Math.min(i,s.priceMax)-a,d=i-o,p=s.priceMax-s.priceMin,m;return l<=0?m=0:d===l?m=p/l:p===l?m=l/d:m=l/p*(l/d),{feeApr:s.feeApr*m,rewardsApr:[((y=s.rewardApr[0])!=null?y:0)*m,((g=s.rewardApr[1])!=null?g:0)*m,((T=s.rewardApr[2])!=null?T:0)*m],apr:s.apr*m}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:r,liquidity:s,positionTickLowerIndex:o,positionTickUpperIndex:i,chainTime:a}){let u=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],d=r[Ze(e.mintA.address).toString()],p=r[Ze(e.mintB.address).toString()],m=e.mintA.decimals,y=e.mintB.decimals;if(!l||!d||!p)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let g=w.priceToSqrtPriceX64(new N(e.price),e.mintA.decimals,e.mintB.decimals),T=w.getSqrtPriceX64FromTick(o),f=w.getSqrtPriceX64FromTick(i),{amountSlippageA:I,amountSlippageB:L}=R.getAmountsFromLiquidityWithSlippage(g,T,f,t,!1,!1,0),{amountSlippageA:X,amountSlippageB:W}=R.getAmountsFromLiquidityWithSlippage(g,T,f,s,!1,!1,0),h=new N(I.toString()).div(new N(10).pow(m)).mul(d.value).add(new N(L.toString()).div(new N(10).pow(y)).mul(p.value)),j=new N(X.toString()).div(new N(10).pow(m)).mul(d.value).add(new N(W.toString()).div(new N(10).pow(y)).mul(p.value)),D=new N(1).div(h.add(j)),Z=new N(l.volumeFee).mul(365).div(u).mul(D).mul(100).toNumber(),q=3600*24*365,ye=e.rewardDefaultInfos.map(ce=>{var It,St;let ze=ce.mint.decimals,Bt=r[ce.mint.address];return a<((It=ce.startTime)!=null?It:0)||a>((St=ce.endTime)!=null?St:0)||!ce.perSecond||!Bt||ze===void 0?0:new N(Bt.value).mul(new N(ce.perSecond).mul(q)).div(new N(10).pow(ze)).mul(D).mul(100).toNumber()});return{feeApr:Z,rewardsApr:ye,apr:Z+ye.reduce((ce,ze)=>ce+ze,0)}}static async getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:r,amount:s,slippage:o,add:i,epochInfo:a,amountHasFee:u}){var f,I;let l=w.priceToSqrtPriceX64(new N(e.price),e.mintA.decimals,e.mintB.decimals),d=w.getSqrtPriceX64FromTick(n),p=w.getSqrtPriceX64FromTick(r),m=V(s,(f=e[t?"mintA":"mintB"].extensions)==null?void 0:f.feeConfig,a,!u),y=new M(new N(m.amount.sub((I=m.fee)!=null?I:U).toString()).toFixed(0)),g;if(l.lte(d))g=t?R.getLiquidityFromTokenAmountA(d,p,y,!i):new M(0);else if(l.lte(p)){let L=R.getLiquidityFromTokenAmountA(l,p,y,!i),X=R.getLiquidityFromTokenAmountB(d,l,y);g=t?L:X}else g=t?new M(0):R.getLiquidityFromTokenAmountB(d,p,y);let T=await de.getAmountsFromLiquidity({epochInfo:a,poolInfo:e,tickLower:n,tickUpper:r,liquidity:g,slippage:o,add:i});return{liquidity:g,amountA:t?m:T.amountA,amountB:t?T.amountB:m,amountSlippageA:t?m:T.amountSlippageA,amountSlippageB:t?T.amountSlippageB:m,expirationTime:T.expirationTime}}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:r,liquidity:s,slippage:o,add:i}){var T,f,I,L;let a=w.getSqrtPriceX64FromTick(n),u=w.getSqrtPriceX64FromTick(r),l=i?1+o:1-o,d=R.getAmountsFromLiquidity(w.priceToSqrtPriceX64(new N(t.price),t.mintA.decimals,t.mintB.decimals),a,u,s,i),[p,m]=[V(d.amountA,(T=t.mintA.extensions)==null?void 0:T.feeConfig,e,!0),V(d.amountB,(f=t.mintB.extensions)==null?void 0:f.feeConfig,e,!0)],[y,g]=[V(d.amountA.muln(l),(I=t.mintA.extensions)==null?void 0:I.feeConfig,e,!0),V(d.amountB.muln(l),(L=t.mintB.extensions)==null?void 0:L.feeConfig,e,!0)];return{liquidity:s,amountA:p,amountB:m,amountSlippageA:y,amountSlippageB:g,expirationTime:we(p.expirationTime,m.expirationTime)}}static async fetchComputeMultipleClmmInfo({connection:e,poolList:t,rpcDataMap:n={}}){let r=t.filter(a=>!n[a.id]).map(a=>new ae(a.id));(await Ae(e,r)).forEach((a,u)=>{!a||(n[r[u].toBase58()]=rn.decode(a.data))});let o=t.map(a=>et(new ae(a.programId),new ae(a.id)).publicKey),i=await de.fetchExBitmaps({connection:e,exBitmapAddress:o,batchRequest:!1});return t.reduce((a,u)=>v(_({},a),{[u.id]:v(_({},n[u.id]),{id:new ae(u.id),version:6,programId:new ae(u.programId),mintA:u.mintA,mintB:u.mintB,ammConfig:v(_({},u.config),{id:new ae(u.config.id),fundOwner:""}),currentPrice:new N(u.price),exBitmapAccount:et(new ae(u.programId),new ae(u.id)).publicKey,exBitmapInfo:i[et(new ae(u.programId),new ae(u.id)).publicKey.toBase58()],startTime:n[u.id].startTime.toNumber(),rewardInfos:n[u.id].rewardInfos})}),{})}static async fetchComputeClmmInfo({connection:e,poolInfo:t,rpcData:n}){return(await this.fetchComputeMultipleClmmInfo({connection:e,rpcDataMap:n?{[t.id]:n}:void 0,poolList:[t]}))[t.id]}};var A=class{static mulDivRoundingUp(e,t,n){let r=e.mul(t),s=r.div(n);return r.mod(n).eq(U)||(s=s.add(pe)),s}static mulDivFloor(e,t,n){if(n.eq(U))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(U))throw new Error("division by 0");return e.mul(t).add(n.sub(pe)).div(n)}static x64ToDecimal(e,t){return new ge(e.toString()).div(ge.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new P(e.mul(ge.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(He).sub(t).mod(He)}};function H(c,e){return kt(c.mul(e),64,256)}function ir(c,e,t){let n=c.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function kt(c,e,t){let n=c.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var w=class{static sqrtPriceX64ToPrice(e,t,n){return A.x64ToDecimal(e).pow(2).mul(ge.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return A.decimalToX64(e.mul(ge.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,r){if(!e.gt(U))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(U))throw new Error("liquidity must greater than 0");return r?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,r){if(!e.gt(U))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(U))throw new Error("liquidity must greater than 0");return r?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,r){if(n.eq(U))return e;let s=t.shln(Me);if(r){let o=s,i=s.add(n.mul(e));return i.gte(o)?A.mulDivCeil(o,e,i):A.mulDivRoundingUp(o,pe,o.div(e).add(n))}else{let o=n.mul(e);if(!s.gt(o))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let i=s.sub(o);return A.mulDivCeil(s,e,i)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,r){let s=n.shln(Me);if(r)return e.add(s.div(t));{let o=A.mulDivRoundingUp(s,pe,t);if(!e.gt(o))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(o)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<Q||e>J)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new P("18445821805675395072"):new P("18446744073709551616");return(t&2)!=0&&(n=H(n,new P("18444899583751176192"))),(t&4)!=0&&(n=H(n,new P("18443055278223355904"))),(t&8)!=0&&(n=H(n,new P("18439367220385607680"))),(t&16)!=0&&(n=H(n,new P("18431993317065453568"))),(t&32)!=0&&(n=H(n,new P("18417254355718170624"))),(t&64)!=0&&(n=H(n,new P("18387811781193609216"))),(t&128)!=0&&(n=H(n,new P("18329067761203558400"))),(t&256)!=0&&(n=H(n,new P("18212142134806163456"))),(t&512)!=0&&(n=H(n,new P("17980523815641700352"))),(t&1024)!=0&&(n=H(n,new P("17526086738831433728"))),(t&2048)!=0&&(n=H(n,new P("16651378430235570176"))),(t&4096)!=0&&(n=H(n,new P("15030750278694412288"))),(t&8192)!=0&&(n=H(n,new P("12247334978884435968"))),(t&16384)!=0&&(n=H(n,new P("8131365268886854656"))),(t&32768)!=0&&(n=H(n,new P("3584323654725218816"))),(t&65536)!=0&&(n=H(n,new P("696457651848324352"))),(t&131072)!=0&&(n=H(n,new P("26294789957507116"))),(t&262144)!=0&&(n=H(n,new P("37481735321082"))),e>0&&(n=Lt.div(n)),n}static getTickFromPrice(e,t,n){return w.getTickFromSqrtPriceX64(w.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(Ie)||e.lt(Be))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new P(t-64),r=ir(n,32,128),s=new P("8000000000000000","hex"),o=0,i=new P(0),a=t>=64?e.shrn(t-63):e.shln(63-t);for(;s.gt(new P(0))&&o<Rt;){a=a.mul(a);let y=a.shrn(127);a=a.shrn(63+y.toNumber()),i=i.add(s.mul(y)),s=s.shrn(1),o+=1}let u=i.shrn(32),d=r.add(u).mul(new P(Et)),p=kt(d.sub(new P(Ft)),64,128).toNumber(),m=kt(d.add(new P(_t)),64,128).toNumber();return p==m?p:w.getSqrtPriceX64FromTick(m).lte(e)?m:p}},Ce=class{static getTickWithPriceAndTickspacing(e,t,n,r){let o=w.getTickFromSqrtPriceX64(w.priceToSqrtPriceX64(e,n,r))/t;return o<0?o=Math.floor(o):o=Math.ceil(o),o*t}static roundPriceWithTickspacing(e,t,n,r){let s=Ce.getTickWithPriceAndTickspacing(e,t,n,r),o=w.getSqrtPriceX64FromTick(s);return w.sqrtPriceX64ToPrice(o,n,r)}},R=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,r){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(U))throw new Error("sqrtPriceX64A must greater than 0");let s=n.ushln(Me),o=t.sub(e);return r?A.mulDivRoundingUp(A.mulDivCeil(s,o,t),pe,e):A.mulDivFloor(s,o,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,r){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(U))throw new Error("sqrtPriceX64A must greater than 0");return r?A.mulDivCeil(n,t.sub(e),re):A.mulDivFloor(n,t.sub(e),re)}static getLiquidityFromTokenAmountA(e,t,n,r){e.gt(t)&&([e,t]=[t,e]);let s=n.mul(e).mul(t),o=t.sub(e),i=s.div(o);return r?A.mulDivRoundingUp(i,pe,rt):i.shrn(Me)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),A.mulDivFloor(n,rt,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,r,s){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return R.getLiquidityFromTokenAmountA(t,n,r,!1);if(e.lt(n)){let o=R.getLiquidityFromTokenAmountA(e,n,r,!1),i=R.getLiquidityFromTokenAmountB(t,e,s);return o.lt(i)?o:i}else return R.getLiquidityFromTokenAmountB(t,n,s)}static getAmountsFromLiquidity(e,t,n,r,s){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:R.getTokenAmountAFromLiquidity(t,n,r,s),amountB:new P(0)};if(e.lt(n)){let o=R.getTokenAmountAFromLiquidity(e,n,r,s),i=R.getTokenAmountBFromLiquidity(t,e,r,s);return{amountA:o,amountB:i}}else return{amountA:new P(0),amountB:R.getTokenAmountBFromLiquidity(t,n,r,s)}}static getAmountsFromLiquidityWithSlippage(e,t,n,r,s,o,i){let{amountA:a,amountB:u}=R.getAmountsFromLiquidity(e,t,n,r,o),l=s?1+i:1-i,d=new P(new ge(a.toString()).mul(l).toFixed(0)),p=new P(new ge(u.toString()).mul(l).toFixed(0));return{amountSlippageA:d,amountSlippageB:p}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:r,slippage:s,add:o,epochInfo:i,amountAddFee:a}){var I,L,X,W;let u=w.priceToSqrtPriceX64(new ge(e.price),e.mintA.decimals,e.mintB.decimals),l=w.getSqrtPriceX64FromTick(t),d=w.getSqrtPriceX64FromTick(n),p=o?1+s:1-s,m=R.getAmountsFromLiquidity(u,l,d,r,o),[y,g]=[V(m.amountA,(I=e.mintA.extensions)==null?void 0:I.feeConfig,i,a),V(m.amountB,(L=e.mintB.extensions)==null?void 0:L.feeConfig,i,a)],[T,f]=[V(new P(new ge(m.amountA.toString()).mul(p).toFixed(0)),(X=e.mintA.extensions)==null?void 0:X.feeConfig,i,a),V(new P(new ge(m.amountB.toString()).mul(p).toFixed(0)),(W=e.mintB.extensions)==null?void 0:W.feeConfig,i,a)];return{liquidity:r,amountA:y,amountB:g,amountSlippageA:T,amountSlippageB:f,expirationTime:we(y.expirationTime,g.expirationTime)}}},Le=class{static swapCompute(e,t,n,r,s,o,i,a,u,l,d,p,m,y,g=!1){if(p.eq(U))throw new Error("amountSpecified must not be 0");if(y||(y=o?Be.add(pe):Ie.sub(pe)),o){if(y.lt(Be))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(y.gte(d))throw new Error("sqrtPriceX64 must smaller than current")}else{if(y.gt(Ie))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(y.lte(d))throw new Error("sqrtPriceX64 must greater than current")}let T=p.gt(U),f={amountSpecifiedRemaining:p,amountCalculated:U,sqrtPriceX64:d,tick:u>m?Math.min(m+C.tickCount(l)-1,u):m,accounts:[],liquidity:a,feeAmount:new P(0)},I=m,L=n[m],X=0,W=!o&&L.startTickIndex===f.tick;for(;!f.amountSpecifiedRemaining.eq(U)&&!f.sqrtPriceX64.eq(y);){X>10;let h={};h.sqrtPriceStartX64=f.sqrtPriceX64;let j=x.nextInitTick(L,f.tick,l,o,W),D=j||null,ne=null;if(!(D!=null&&D.liquidityGross.gtn(0))){let q=de.nextInitializedTickArrayStartIndex({tickCurrent:f.tick,tickSpacing:l,tickArrayBitmap:r,exBitmapInfo:s},I,o);if(!q.isExist){if(g)return{allTrade:!1,amountSpecifiedRemaining:f.amountSpecifiedRemaining,amountCalculated:f.amountCalculated,feeAmount:f.feeAmount,sqrtPriceX64:f.sqrtPriceX64,liquidity:f.liquidity,tickCurrent:f.tick,accounts:f.accounts};throw Error("swapCompute LiquidityInsufficient")}I=q.nextStartIndex;let{publicKey:ye}=$(e,t,I);ne=ye,L=n[I];try{D=x.firstInitializedTick(L,o)}catch{throw Error("not found next tick info")}}h.tickNext=D.tick,h.initialized=D.liquidityGross.gtn(0),m!==I&&ne&&(f.accounts.push(ne),m=I),h.tickNext<Q?h.tickNext=Q:h.tickNext>J&&(h.tickNext=J),h.sqrtPriceNextX64=w.getSqrtPriceX64FromTick(h.tickNext);let Z;if(o&&h.sqrtPriceNextX64.lt(y)||!o&&h.sqrtPriceNextX64.gt(y)?Z=y:Z=h.sqrtPriceNextX64,[f.sqrtPriceX64,h.amountIn,h.amountOut,h.feeAmount]=Le.swapStepCompute(f.sqrtPriceX64,Z,f.liquidity,f.amountSpecifiedRemaining,i,o),f.feeAmount=f.feeAmount.add(h.feeAmount),T?(f.amountSpecifiedRemaining=f.amountSpecifiedRemaining.sub(h.amountIn.add(h.feeAmount)),f.amountCalculated=f.amountCalculated.sub(h.amountOut)):(f.amountSpecifiedRemaining=f.amountSpecifiedRemaining.add(h.amountOut),f.amountCalculated=f.amountCalculated.add(h.amountIn.add(h.feeAmount))),f.sqrtPriceX64.eq(h.sqrtPriceNextX64)){if(h.initialized){let q=D.liquidityNet;o&&(q=q.mul(be)),f.liquidity=R.addDelta(f.liquidity,q)}W=h.tickNext!=f.tick&&!o&&L.startTickIndex===h.tickNext,f.tick=o?h.tickNext-1:h.tickNext}else if(f.sqrtPriceX64!=h.sqrtPriceStartX64){let q=w.getTickFromSqrtPriceX64(f.sqrtPriceX64);W=q!=f.tick&&!o&&L.startTickIndex===q,f.tick=q}++X}try{let{nextStartIndex:h,isExist:j}=C.nextInitializedTickArray(f.tick,l,o,r,s);j&&m!==h&&(f.accounts.push($(e,t,h).publicKey),m=h)}catch{}return{allTrade:!0,amountSpecifiedRemaining:U,amountCalculated:f.amountCalculated,feeAmount:f.feeAmount,sqrtPriceX64:f.sqrtPriceX64,liquidity:f.liquidity,tickCurrent:f.tick,accounts:f.accounts}}static swapStepCompute(e,t,n,r,s,o){let i={sqrtPriceX64Next:new P(0),amountIn:new P(0),amountOut:new P(0),feeAmount:new P(0)},a=r.gte(U);if(a){let l=A.mulDivFloor(r,je.sub(new P(s.toString())),je);i.amountIn=o?R.getTokenAmountAFromLiquidity(t,e,n,!0):R.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(i.amountIn)?i.sqrtPriceX64Next=t:i.sqrtPriceX64Next=w.getNextSqrtPriceX64FromInput(e,n,l,o)}else i.amountOut=o?R.getTokenAmountBFromLiquidity(t,e,n,!1):R.getTokenAmountAFromLiquidity(e,t,n,!1),r.mul(be).gte(i.amountOut)?i.sqrtPriceX64Next=t:i.sqrtPriceX64Next=w.getNextSqrtPriceX64FromOutput(e,n,r.mul(be),o);let u=t.eq(i.sqrtPriceX64Next);return o?(u&&a||(i.amountIn=R.getTokenAmountAFromLiquidity(i.sqrtPriceX64Next,e,n,!0)),u&&!a||(i.amountOut=R.getTokenAmountBFromLiquidity(i.sqrtPriceX64Next,e,n,!1))):(i.amountIn=u&&a?i.amountIn:R.getTokenAmountBFromLiquidity(e,i.sqrtPriceX64Next,n,!0),i.amountOut=u&&!a?i.amountOut:R.getTokenAmountAFromLiquidity(e,i.sqrtPriceX64Next,n,!1)),!a&&i.amountOut.gt(r.mul(be))&&(i.amountOut=r.mul(be)),a&&!i.sqrtPriceX64Next.eq(t)?i.feeAmount=r.sub(i.amountIn):i.feeAmount=A.mulDivCeil(i.amountIn,new P(s),je.sub(new P(s))),[i.sqrtPriceX64Next,i.amountIn,i.amountOut,i.feeAmount]}};export{R as LiquidityMath,A as MathUtil,w as SqrtPriceMath,Le as SwapMath,Ce as TickMath};
//# sourceMappingURL=math.mjs.map