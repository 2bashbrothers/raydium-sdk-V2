var Fr=Object.defineProperty,Wr=Object.defineProperties;var _r=Object.getOwnPropertyDescriptors;var Zt=Object.getOwnPropertySymbols;var ki=Object.prototype.hasOwnProperty,Ai=Object.prototype.propertyIsEnumerable;var Pi=(m,e,t)=>e in m?Fr(m,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):m[e]=t,W=(m,e)=>{for(var t in e||(e={}))ki.call(e,t)&&Pi(m,t,e[t]);if(Zt)for(var t of Zt(e))Ai.call(e,t)&&Pi(m,t,e[t]);return m},X=(m,e)=>Wr(m,_r(e));var at=(m,e)=>{var t={};for(var n in m)ki.call(m,n)&&e.indexOf(n)<0&&(t[n]=m[n]);if(m!=null&&Zt)for(var n of Zt(m))e.indexOf(n)<0&&Ai.call(m,n)&&(t[n]=m[n]);return t};import{PublicKey as Pt}from"@solana/web3.js";import{createTransferInstruction as Mr,TOKEN_PROGRAM_ID as be,TOKEN_2022_PROGRAM_ID as xn}from"@solana/spl-token";import In from"bn.js";import jt from"decimal.js";import{PublicKey as hi}from"@solana/web3.js";import{get as wi,set as Vr}from"lodash";var Sn=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Date.now().toString()}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},Ti={},vr={};function re(m){let e=wi(Ti,m);if(!e){let t=wi(vr,m);e=new Sn({name:m,logLevel:t}),Vr(Ti,m,e)}return e}import{MINT_SIZE as Dr,TOKEN_PROGRAM_ID as qr,getTransferFeeConfig as Gr,unpackMint as Ur}from"@solana/spl-token";var Kn=re("Raydium_accountInfo_util");async function He(m,e,t){let{batchRequest:n,commitment:i="confirmed",chunkCount:s=100}=W({batchRequest:!1},t),r=Cn(e,s),o=new Array(r.length).fill([]);if(n){let u=r.map(p=>{let l=m._buildArgs([p.map(d=>d.toBase58())],i,"base64");return{methodName:"getMultipleAccounts",args:l}}),a=Cn(u,10);o=(await(await Promise.all(a.map(async p=>await m._rpcBatchRequest(p)))).flat()).map(p=>(p.error&&Kn.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${p.error.message}`),p.result.value.map(l=>{if(l){let{data:d,executable:y,lamports:f,owner:b,rentEpoch:g}=l;return d.length!==2&&d[1]!=="base64"&&Kn.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(d[0],"base64"),executable:y,lamports:f,owner:new hi(b),rentEpoch:g}}return null})))}else try{o=await Promise.all(r.map(u=>m.getMultipleAccountsInfo(u,i)))}catch(u){u instanceof Error&&Kn.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${u.message}`)}return o.flat()}async function ut(m,e,t){let n=await He(m,e.map(i=>i.pubkey),t);return e.map((i,s)=>X(W({},i),{accountInfo:n[s]}))}async function Ln({connection:m,mints:e,config:t}){var s,r,o;if(e.length===0)return{};let n=await ut(m,e.map(u=>({pubkey:De(u)})),t),i={};for(let u of n){if(!u.accountInfo||u.accountInfo.data.length<Dr){console.log("invalid mint account",u.pubkey.toBase58());continue}let a=Ur(u.pubkey,u.accountInfo,(s=u.accountInfo)==null?void 0:s.owner);i[u.pubkey.toString()]=X(W({},a),{programId:((r=u.accountInfo)==null?void 0:r.owner)||qr,feeConfig:(o=Gr(a))!=null?o:void 0})}return i[hi.default.toBase58()]=i[Fe.toBase58()],i}import je from"bn.js";import wu from"decimal.js";import Jr from"big.js";import en from"bn.js";import Xr from"toformat";var zr=Xr,Lt=zr;import $t from"big.js";import Hr from"bn.js";import Yr from"decimal.js-light";import Rt from"bn.js";var Bi=9007199254740991;function oe(m){let e=re("Raydium_parseBigNumberish");if(m instanceof Rt)return m;if(typeof m=="string"){if(m.match(/^-?[0-9]+$/))return new Rt(m);e.logWithError(`invalid BigNumberish string: ${m}`)}return typeof m=="number"?(m%1&&e.logWithError(`BigNumberish number underflow: ${m}`),(m>=Bi||m<=-Bi)&&e.logWithError(`BigNumberish number overflow: ${m}`),new Rt(String(m))):typeof m=="bigint"?new Rt(m.toString()):(e.error(`invalid BigNumberish value: ${m}`),new Rt(0))}var Jt=re("module/fraction"),Rn=Lt($t),Nt=Lt(Yr),jr={[0]:Nt.ROUND_DOWN,[1]:Nt.ROUND_HALF_UP,[2]:Nt.ROUND_UP},Zr={[0]:$t.roundDown,[1]:$t.roundHalfUp,[2]:$t.roundUp},te=class{constructor(e,t=new Hr(1)){this.numerator=oe(e),this.denominator=oe(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new te(this.denominator,this.numerator)}add(e){let t=e instanceof te?e:new te(oe(e));return this.denominator.eq(t.denominator)?new te(this.numerator.add(t.numerator),this.denominator):new te(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof te?e:new te(oe(e));return this.denominator.eq(t.denominator)?new te(this.numerator.sub(t.numerator),this.denominator):new te(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof te?e:new te(oe(e));return new te(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof te?e:new te(oe(e));return new te(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||Jt.logWithError(`${e} is not an integer.`),e<=0&&Jt.logWithError(`${e} is not positive.`),Nt.set({precision:e+1,rounding:jr[n]});let i=new Nt(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return i.toFormat(i.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||Jt.logWithError(`${e} is not an integer.`),e<0&&Jt.logWithError(`${e} is negative.`),Rn.DP=e,Rn.RM=Zr[n]||1,new Rn(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var $r=re("Raydium_amount"),xi=Lt(Jr);function eo(m,e){let t="0",n="0";if(m.includes(".")){let i=m.split(".");i.length===2?([t,n]=i,n=n.padEnd(e,"0")):$r.logWithError(`invalid number string, num: ${m}`)}else t=m;return[t,n.slice(0,e)||n]}var se=class extends te{constructor(t,n,i=!0,s){let r=new en(0),o=Nn.pow(new en(t.decimals));if(i)r=oe(n);else{let u=new en(0),a=new en(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[c,p]=eo(n.toString(),t.decimals);u=oe(c),a=oe(p)}u=u.mul(o),r=u.add(a)}super(r,o);this.logger=re(s||"TokenAmount"),this.token=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.token.equals(t.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(t.raw)}lt(t){return this.token.equals(t.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(t.raw)}add(t){return this.token.equals(t.token)||this.logger.logWithError("add token not equals"),new se(this.token,this.raw.add(t.raw))}subtract(t){return this.token.equals(t.token)||this.logger.logWithError("sub token not equals"),new se(this.token,this.raw.sub(t.raw))}toSignificant(t=this.token.decimals,n,i=0){return super.toSignificant(t,n,i)}toFixed(t=this.token.decimals,n,i=0){return t>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,i)}toExact(t={groupSeparator:""}){return xi.DP=this.token.decimals,new xi(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}};import{PublicKey as to}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ii}from"@solana/spl-token";var On={chainId:101,address:to.default.toBase58(),programId:Ii.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},qe={chainId:101,address:"So11111111111111111111111111111111111111112",programId:Ii.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};import{PublicKey as Fn}from"@solana/web3.js";import{PublicKey as le,SystemProgram as Si,SYSVAR_RENT_PUBKEY as no}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as io}from"@solana/spl-token";function S({pubkey:m,isSigner:e=!1,isWritable:t=!0}){return{pubkey:m,isWritable:t,isSigner:e}}var Ta=[S({pubkey:io,isWritable:!1}),S({pubkey:Si.programId,isWritable:!1}),S({pubkey:no,isWritable:!1})];function Mn({publicKey:m,transformSol:e}){let t=En(m.toString());if(t instanceof le)return e&&t.equals(Ot)?Fe:t;if(e&&t.toString()===Ot.toBase58())return Fe;if(typeof t=="string"){if(t===le.default.toBase58())return le.default;try{return new le(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function En(m){try{return new le(m)}catch{return m}}var tn=new le("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),kt=new le("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),Ge=new le("SysvarRent111111111111111111111111111111111"),ha=new le("SysvarC1ock11111111111111111111111111111111"),it=new le("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),Ba=new le("Sysvar1nstructions1111111111111111111111111"),ro=Si.programId,xa=new le("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Ia=new le("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),Sa=new le("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),Ka=new le("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),Ca=new le("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),La=new le("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),Ra=new le("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),Na=new le("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),Oa=new le("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),Ma=new le("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),Ea=new le("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),Fe=new le("So11111111111111111111111111111111111111112"),Ot=le.default;function De(m){return Mn({publicKey:m,transformSol:!0})}var Wn=class{constructor({mint:e,decimals:t,symbol:n,name:i,skipMint:s=!1,isToken2022:r=!1}){if(e===Ot.toBase58()||e instanceof Fn&&Ot.equals(e)){this.decimals=qe.decimals,this.symbol=qe.symbol,this.name=qe.name,this.mint=new Fn(qe.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=i||e.toString().substring(0,6),this.mint=s?Fn.default:Mn({publicKey:e}),this.isToken2022=r}equals(e){return this===e?!0:this.mint.equals(e.mint)}},Se=Wn;Se.WSOL=new Wn(X(W({},qe),{mint:qe.address}));var _n=class{constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},nn=_n;nn.SOL=new _n(On);import oo from"bn.js";var Ki=new te(new oo(100)),Ye=class extends te{toSignificant(e=5,t,n){return this.mul(Ki).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(Ki).toFixed(e,t,n)}};var so=re("Raydium_price"),xe=class extends te{constructor(t){let{baseToken:n,quoteToken:i,numerator:s,denominator:r}=t;super(s,r);this.baseToken=n,this.quoteToken=i,this.scalar=new te(Vn(n.decimals),Vn(i.decimals))}get raw(){return new te(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new xe({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&so.logWithError("mul token not equals");let n=super.mul(t);return new xe({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(t=this.quoteToken.decimals,n,i){return this.adjusted.toSignificant(t,n,i)}toFixed(t=this.quoteToken.decimals,n,i){return this.adjusted.toFixed(t,n,i)}};import{PublicKey as ao}from"@solana/web3.js";import uo from"bn.js";function Li(m){return typeof m=="object"&&m!==null&&![Se,se,ao,te,uo,xe,Ye].some(e=>typeof e=="object"&&m instanceof e)}function ct(m){return typeof m=="string"?En(m):Array.isArray(m)?m.map(e=>ct(e)):Li(m)?Object.fromEntries(Object.entries(m).map(([e,t])=>[e,ct(t)])):m}var Ci=new je(0),co=new je(1),Ru=new je(2),Nu=new je(3),Ou=new je(5),Nn=new je(10),Mu=new je(100),Eu=new je(1e3),Fu=new je(1e4);function Vn(m){return Nn.pow(oe(m))}function Cn(m,e=1,t=[]){let n=[...m];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}import{PublicKey as go}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Po}from"@solana/spl-token";import{ComputeBudgetProgram as Ri,Keypair as Oi,PublicKey as lo,Transaction as Mi,TransactionMessage as mo,VersionedTransaction as Ei}from"@solana/web3.js";var Y={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",ClmmLockPosition:"ClmmLockPosition",ClmmHarvestLockPosition:"ClmmHarvestLockPosition",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV4Withdraw:"FarmV4Withdraw",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut",CpmmLockLp:"CpmmLockLp",CpmmCollectLockFee:"CpmmCollectLockFee",TransferTip:"TransferTip"};import{TOKEN_PROGRAM_ID as po}from"@solana/spl-token";var Ni=re("Raydium_txUtil"),Fi=1644;function rn(m){let e=[],t=[];return m.microLamports&&(e.push(Ri.setComputeUnitPrice({microLamports:m.microLamports})),t.push(Y.SetComputeUnitPrice)),m.units&&(e.push(Ri.setComputeUnitLimit({units:m.units})),t.push(Y.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function At(m,e){var n,i;let t=e!=null?e:"confirmed";return(i=await((n=m.getLatestBlockhash)==null?void 0:n.call(m,{commitment:t})))==null?void 0:i.blockhash}async function on(m,e){return m.getSignatureStatuses([e]),new Promise((t,n)=>{let i=setTimeout(n,6e4);m.onSignature(e,s=>{if(clearTimeout(i),!s.err){t("");return}n(Object.assign(s.err,{txId:e}))},"confirmed")})}function fo(m,e){m.length<1&&Ni.logWithError(`no instructions provided: ${m.toString()}`),e.length<1&&Ni.logWithError(`no signers provided:, ${e.toString()}`);let t=new Mi;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...m);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<Fi}catch{return!1}}function ye(m,e){let[t,n]=lo.findProgramAddressSync(m,e);return{publicKey:t,nonce:n}}function Mt({instructions:m,payer:e,signers:t}){return fo(m,[e,...t])}function Et({instructions:m,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=Oi.generate().publicKey.toString()}){let s=new mo({payerKey:e,recentBlockhash:n,instructions:m}).compileToV0Message(Object.values(t!=null?t:{}));try{return Buffer.from(new Ei(s).serialize()).toString("base64").length<Fi}catch{return!1}}var bo=m=>Buffer.isBuffer(m)?m:m instanceof Uint8Array?Buffer.from(m.buffer,m.byteOffset,m.byteLength):Buffer.from(m),yo=m=>{let e=m.serialize({requireAllSignatures:!1,verifySignatures:!1});m instanceof Ei&&(e=bo(e));try{return e instanceof Buffer?e.toString("base64"):Buffer.from(e).toString("base64")}catch{return e.toString("base64")}};function lt(m){let e=[];return m.forEach(t=>{t instanceof Mi&&(t.recentBlockhash||(t.recentBlockhash=po.toBase58()),t.feePayer||(t.feePayer=Oi.generate().publicKey)),e.push(yo(t))}),console.log("simulate tx string:",e),e}function ae(m,e,t){return ye([m.toBuffer(),(t!=null?t:Po).toBuffer(),e.toBuffer()],new go("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import{PublicKey as _}from"@solana/web3.js";var ic=new _("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),rc=new _("CBuCnLe26faBpcBP2fktp4rp8abpcAnTWft6ZrP5Q4T"),oc=new _("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),sc=new _("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),ac=new _("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),uc=new _("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),vn=new _("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),Wi=new _("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),cc=new _("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),_i=new _("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Dn=new _("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),ko=new _("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),Ao=new _("kN1kEznaF5Xbd8LYuqtEFcxzWSBk5Fv6ygX6SqEGJVy"),sn=new _("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),lc=new _("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),mc=new _("7YttLkHDoNj9wyDur5pM1ejNaAvT9X4eqaYcHQqtj2G5"),pc=new _("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),dc=new _("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),fc=new _("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),bc=new _("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),qn=new _("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),wo=new _("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),yc=new _("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),gc=new _("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),Pc=new _("3f7GcQFG397GAaEnv51zR6tsTVihYRydnydDD1cXekxH"),kc=new _("LanMV9sAd7wArD4vJFi2qDdfnVhFxYSUg6eADduJ3uj"),Ac=new _("WLHv2UAZm6z4KyaaELi5pjdbJh6RESMva1Rnn8pJVVh"),wc=new _("DRay6fNdQ5J82H7xV6uq2aV3mNrUZ1J4PgSKsWgptcm6"),Tc=new _("5xqNaZXX5eUi4p5HU4oz9i5QnwRNT2y6oN7yyn4qENeq"),hc=new _("4Bu96XjU84XjPDSpveTVf6LYGCkfW5FK7SNkREWcEfV4"),Bc=new _("6s1xP3hpbAfFoNtUNF8mfHsjr2Bd97JxFJRWLbL6aHuX");var xc={OPEN_BOOK_PROGRAM:new _("EoTcMgcDRTJVZDMZWBoU6rhYHZfkNTVEAfz3uUJRcYGj"),SERUM_PROGRAM_ID_V3:new _("Ray1111111111111111111111111111111111111111"),AMM_V4:new _("DRaya7Kj3aMWQSy19kSjvmuwq9docCHofyP9kanQGaav"),AMM_STABLE:new _("DRayDdXc1NZQ9C3hRWmoSf8zK4iapgMnjdNZWrfwsP8m"),CLMM_PROGRAM_ID:new _("DRayAUgENGQBKVaX8owNhgzkEDyoHTGVEGHVJT1E9pfH"),CLMM_LOCK_PROGRAM_ID:new _("DRay25Usp3YJAi7beckgpGUC7mGJ2cR1AVPxhYfwVCUX"),CLMM_LOCK_AUTH_ID:new _("6Aoh8h2Lw2m5UGxYR8AdAL87jTWYeKoxM52mJRzfYwN"),CREATE_CPMM_POOL_PROGRAM:new _("DRaycpLY18LhpbydsBWbVJtxpNv9oXPgjRSfpF2bWpYb"),CREATE_CPMM_POOL_AUTH:new _("CXniRufdq5xL8t8jZAPxsPZDpuudwuJSPWnbcD5Y5Nxq"),CREATE_CPMM_POOL_FEE_ACC:new _("3oE58BKVt8KuYkGxx8zBojugnymWmBiyafWgMrnb6eYy"),LOCK_CPMM_PROGRAM:new _("DRay25Usp3YJAi7beckgpGUC7mGJ2cR1AVPxhYfwVCUX"),LOCK_CPMM_AUTH:new _("7qWVV8UY2bRJfDLP4s37YzBPKUkVB46DStYJBpYbQzu3"),UTIL1216:_.default,Router:new _("DRaybByLpbUL57LJARs3j8BitTxVfzBg351EaMr5UTCd"),FARM_PROGRAM_ID_V3:new _("DRayWyrLmEW5KEeqs8kdTMMaBabapqagaBC7KWpGtJeZ"),FARM_PROGRAM_ID_V4:new _("Ray1111111111111111111111111111111111111111"),FARM_PROGRAM_ID_V5:new _("DRayiCGSZgku1GTK6rXD6mVDdingXy6APAH1R6R5L2LC"),FARM_PROGRAM_ID_V6:new _("DRayzbYakXs45ELHkzH6vC3fuhQqTAnv5A68gdFuvZyZ"),LAUNCHPAD_PROGRAM:new _("DRay6fNdQ5J82H7xV6uq2aV3mNrUZ1J4PgSKsWgptcm6"),LAUNCHPAD_AUTH:new _("5xqNaZXX5eUi4p5HU4oz9i5QnwRNT2y6oN7yyn4qENeq"),LAUNCHPAD_PLATFORM:new _("2Jx4KTDrVSdWNazuGpcA8n3ZLTRGGBDxAWhuKe2Xcj2a"),LAUNCHPAD_CONFIG:new _("7ZR4zD7PYfY2XxoG1Gxcy2EgEeGYrpxrwzPuwdUBssEt"),FEE_DESTINATION_ID:new _("9y8ENuuZ3b19quffx9hQvRVygG5ky6snHfRvGpuSfeJy"),MODEL_DATA_PUBKEY:new _("Ray1111111111111111111111111111111111111111")};import We from"bn.js";var Ft=1e4;function fe(m,e,t,n){if(e===void 0)return{amount:m,fee:void 0,expirationTime:void 0};let i=X(W({},e),{olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}}),s=t.epoch<i.newerTransferFee.epoch?i.olderTransferFee:i.newerTransferFee,r=new We(s.maximumFee.toString()),o=t.epoch<i.newerTransferFee.epoch?(Number(i.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(s.transferFeeBasisPoints===Ft){let u=new We(s.maximumFee.toString());return{amount:m.add(u),fee:u,expirationTime:o}}else{let u=an(m.mul(new We(Ft)),new We(Ft-s.transferFeeBasisPoints)),a=new We(s.maximumFee.toString()),c=u.sub(m).gt(a)?m.add(a):u,p=an(c.mul(new We(s.transferFeeBasisPoints)),new We(Ft)),l=p.gt(r)?r:p;return{amount:c,fee:l,expirationTime:o}}else{let u=an(m.mul(new We(s.transferFeeBasisPoints)),new We(Ft)),a=u.gt(r)?r:u;return{amount:m,fee:a,expirationTime:o}}}function _e(m,e){return m===void 0?e:e===void 0?m:Math.min(m,e)}function an(m,e){let{div:t,mod:n}=m.divmod(e);return n.gt(new We(0))?t.add(new We(1)):t}import{PublicKey as Gn,AddressLookupTableAccount as Tt}from"@solana/web3.js";async function Un({connection:m,address:e,cluster:t="mainnet"}){let n=await He(m,[...new Set(e.map(s=>s.toString()))].map(s=>new Gn(s))),i={};for(let s=0;s<e.length;s++){let r=n[s],o=e[s];if(!r)continue;let u=new Tt({key:o,state:Tt.deserialize(r.data)});i[o.toString()]=u,t==="devnet"?wt[o.toString()]=u:un[o.toString()]=u}return i}var un={AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU:new Tt({key:new Gn("AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU"),state:Tt.deserialize(Buffer.from("AQAAAP//////////I1rcEwAAAAAvAQYwun9CU6c5Ikm2pAj+D9IEnCOR45nK+SFTGSdpd6J6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAbd9uHXZaGT2cvhRs7reawctIXtX1s3kTqM9YV+/wCpBt324e51j94YQl285GzN2rYa/E2DuQ0n/r35KNihi/wFSlNQ+F3IgtYUpVZyeIopbd8eq6vQpgZ4iEky9O72oAVKU1qZKSEGTSTocWDaOHx8NbXdvJK7geQfqEBBBUSNBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvBkX2T9y7AHdNGviJAqQNtlDUDCnauQRWybsLji6nPM8Qkw5asQRvCdB3MbX6IEBwytOrpM32l4jQygKG9TKgR0vZScQ2AsM/IHeQ7RajUkyhuZdc8SGiqQz/7H34torNR/Wir3sl0ruUrVxJWEZfUg+QLNAxxODdBi53/OP7Ioil1cqeBM9dtZC3FLov4yyxWRM/wcGStyJX/QfTnLBAHqkqWotPKVlShCVQqpP9W5W1rOao65IMk5QuQ2kMIOxzDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu/YsA/yfEEFGcr8Z57VKDw8uQzpiru7g4lvjnfapW62W030syevD8k07SGoxUHiuT/ai7gAHWWhDsVmg/C63ajgpkH7Sn3GdutArDTfyqOkdqv4/IPC/EFFy7mGkfDd2C57N5a/4jC+BbmJy7wQaSEZr0CQU88lPtUxIVvzGjC95b8Ooss2TqmkrayGKofkPMGQn7Ux+9lfwBSNfxwH8NgbpqC/7LNlV4I7nCvsXf3p+ohQk9NrAJb2KAFpUqEIJ9ZBV7BYDzHF/ORKYlgtvPnXjudZQ6CEo5OzUDaNIomTCCsvhD16TxJjsbgne1kGnQPCFSoaxUbq2V1bPMFQ3VYP6wDZ9bKStCFKx9A3tNbwZFC5ZGAN83MFK7XoTy+OmmcFEr6rLOjfSuTfPvHJkSVxW6Qllwkl67XcBi5v00u2gQsbu+38sp+rd5pA/LvyWj4P94ZGZwc1tE2P88xekCLcAwZGb+UhFzL/7K26csOb57yM5bvF9xJrLEObOkAAAAAn+HWRkdcPKyFFMnVwEoD7vnD0jCKFIU1sImubYCxNTSVzsKpaQX+fzNxrLAI3L14JQnJx/D6Uk2LADIHGqnGELzjEbkBDAlaM77NkXMPfqXNLSveCkWI7UEgNs31WEWB6XHSYI/v5DklHOb4QTtDOR804PVbi3fjloZeLR2F8d4FuZmMMO7ck3Fnkn2zEMG5gOmqsygb6PjTitArVl52NhcSznTxVnguaIJxiZkAnurDmn3MWR0PC2GLghp2KJqHCc6QQ85odeIjFHKOlRlJyeSXVJmL8vb1UgOzsbJPVP8p6zM4M3C1Sd7uWIHP33G42AP2Zg8ucn/n6meQjjD266JgCWdxZD6PXs9CsnIeL7SSG0/6lGb9xfP0ZcWkCXB/3hjxHYVXjra/GPOeXGk0fLLKjCbk+mgs2w6d2oCwimBipTzuoZ30GiI8ij8VRzD5CzMWtu2m21eDBIfjGAEo4pQeNNonKcqzV/cleX8ySZLOHsz8PtBCrLqF+VkLm9hOzIT+6i/nIf6keR4GWKMOD4AvqfpjHoD4DuhBpz8P28+DxkGrDXXr/nr20x291VPvcTU/b+b+o2kC9G0kcXeTlLjU6a2TQXWlZ4gBUdBl1jgT7mObSTpLblNiXZsLkbmVXZwvFKXua5cUKlWed/w30skmEUraTuQqtqr5fHZPW9n57EmeTif6LjHL2YJFZkQU+TrJmFzqzmF4/b8OwrPQAprl8mX3q4LUIdAS/a+11B6DWD1Xk2++Sn94dLC4xjkO4Wtlw8c4XuzciVbepHOmnoWzVu/0y3KCrLCSfQxQ3br8DJCoVzhgtPsS2nZZjsBGIZgnU0QpMv+2MnRsnKwdp1VsrCX84j/qvaZn4WhKunippgTbN2EUs0tPTP55Qfgj+nKmjtWW5IYs72FrEwJKYoNfsmqaF4o5pf4v9zgPwVwY/5I4XJKUL2L25m9kAQcW/K+H1RTFEUoj8Z4ajpOmAB/dG0COmCphVMW2CCMvnxhcGiSgPnpDuWu6qiJ7NG7ye5kvHgefgqPLeicspNJ5EpL3XiRNLM2tmJLI1awAwOyd6iHv0dCkMYRKaa6rcaZeYwmKCkckm0kM2JNmnmmAaBQQ7mwmIM0IMxX4f5W6j9PqZWcJxF7r17T/lQBAmcjoupRiJifbnXCNUv9GhpRF19WcBdeKbivRJVlGop6I2RS6lGImJ9udcI1S/0aGlEXX1ZwF14puK9ElWUainojZFYVHLHD6dIP2ESjqBzg3ol1/wB7+/ylGwd9LS7wSZ2A630CJSVKwH47K9P4bB8PEQP8BwjMFa7xQHOqZFP1XqaQ==","base64"))})},wt={},Xn=async m=>{let e="EFhMuDw1PKEuckuFRW9PavNfTH4LKP5uKHgyXDmWpFCq";if(wt[e])return wt;let t=new Gn(e),n=await m.getAccountInfo(t);return n&&(wt[e]=new Tt({key:t,state:Tt.deserialize(n.data)})),wt};import{PublicKey as ht,sendAndConfirmTransaction as zn,SystemProgram as To,Transaction as Wt,TransactionMessage as _t,VersionedTransaction as Vt}from"@solana/web3.js";import ho from"axios";var cn=2e3,ln=class{constructor(e){this.instructions=[];this.endInstructions=[];this.lookupTableAddress=[];this.signers=[];this.instructionTypes=[];this.endInstructionTypes=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner,this.cluster=e.cluster,this.blockhashCommitment=e.blockhashCommitment,this.loopMultiTxStatus=!!e.loopMultiTxStatus}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){var n;let e=(await ho.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=(n=e==null?void 0:e[15])!=null?n:{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=rn(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}addTipInstruction(e){var t;return e?(this.endInstructions.push(To.transfer({fromPubkey:(t=e.feePayer)!=null?t:this.feePayer,toPubkey:new ht(e.address),lamports:BigInt(e.amount.toString())})),this.endInstructionTypes.push(Y.TransferTip),!0):!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:i=[],endInstructionTypes:s=[],lookupTableAddress:r=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...i),this.endInstructionTypes.push(...s),this.lookupTableAddress.push(...r.filter(o=>o!==ht.default.toString())),this}async versionBuild({txVersion:e,extInfo:t}){return e===0?await this.buildV0(W({},t||{})):this.build(t)}build(e){var n;let t=new Wt;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,((n=this.owner)==null?void 0:n.signer)&&!this.signers.some(i=>i.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer),{builder:this,transaction:t,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async i=>{var c;let{recentBlockHash:s,skipPreflight:r=!0,sendAndConfirm:o,notSendToRpc:u}=i||{},a=s!=null?s:await At(this.connection,this.blockhashCommitment);if(t.recentBlockhash=a,this.signers.length&&t.sign(...this.signers),lt([t]),(c=this.owner)!=null&&c.isKeyPair)return{txId:o?await zn(this.connection,t,this.signers.find(l=>l.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:r}):await this.connection.sendRawTransaction(t.serialize(),{skipPreflight:r}),signedTx:t};if(this.signAllTransactions){let p=await this.signAllTransactions([t]);if(this.signers.length)for(let l of p)try{l.sign(...this.signers)}catch{}return{txId:u?"":await this.connection.sendRawTransaction(p[0].serialize(),{skipPreflight:r}),signedTx:p[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:e||{}}}buildMultiTx(e){var a;let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:i}=this.build(n),s=t.filter(c=>c.transaction.instructions.length>0),r=[i,...s.map(c=>c.transaction)],o=[this.signers,...s.map(c=>c.signers)],u=[...this.instructionTypes,...s.map(c=>c.instructionTypes).flat()];return(a=this.owner)!=null&&a.signer&&o.forEach(c=>{c.some(p=>p.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),{builder:this,transactions:r,signers:o,instructionTypes:u,execute:async c=>{var g;let{sequentially:p,onTxUpdate:l,skipTxCount:d=0,recentBlockHash:y,skipPreflight:f=!0}=c||{},b=y!=null?y:await At(this.connection,this.blockhashCommitment);if((g=this.owner)!=null&&g.isKeyPair){if(p){let A=[],h=0;for(let B of r){if(++h,h<=d)continue;let T=await zn(this.connection,B,this.signers.find(k=>k.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:f});A.push(T)}return{txIds:A,signedTxs:r}}return{txIds:await await Promise.all(r.map(async A=>(A.recentBlockhash=b,await this.connection.sendRawTransaction(A.serialize(),{skipPreflight:f})))),signedTxs:r}}if(this.signAllTransactions){let A=r.map((B,T)=>(B.recentBlockhash=b,o[T].length&&B.sign(...o[T]),B));lt(A);let h=await this.signAllTransactions(A);if(p){let B=0,T=[],k=async()=>{if(!h[B])return;let x=await this.connection.sendRawTransaction(h[B].serialize(),{skipPreflight:f});T.push({txId:x,status:"sent",signedTx:h[B]}),l==null||l([...T]),B++;let I=!1,N=null,w=null,O=V=>{N!==null&&clearInterval(N),w!==null&&this.connection.removeSignatureListener(w);let M=T.findIndex(H=>H.txId===x);if(M>-1){if(T[M].status==="error"||T[M].status==="success")return;T[M].status=V.err?"error":"success"}l==null||l([...T]),V.err||k()};this.loopMultiTxStatus&&(N=setInterval(async()=>{var V;if(I){clearInterval(N);return}try{let M=await this.connection.getTransaction(x,{commitment:"confirmed",maxSupportedTransactionVersion:0});M&&(I=!0,clearInterval(N),O({err:((V=M.meta)==null?void 0:V.err)||null}),console.log("tx status from getTransaction:",x))}catch(M){I=!0,clearInterval(N),console.error("getTransaction timeout:",M,x)}},cn)),w=this.connection.onSignature(x,V=>{if(I){this.connection.removeSignatureListener(w);return}I=!0,O(V)},"confirmed"),this.connection.getSignatureStatus(x)};return await k(),{txIds:T.map(x=>x.txId),signedTxs:h}}else{let B=[];for(let T=0;T<h.length;T+=1){let k=await this.connection.sendRawTransaction(h[T].serialize(),{skipPreflight:f});B.push(k)}return{txIds:B,signedTxs:h}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e){var f;let y=e||{},{lookupTableCache:t={},lookupTableAddress:n=[],forerunCreate:i,recentBlockhash:s}=y,r=at(y,["lookupTableCache","lookupTableAddress","forerunCreate","recentBlockhash"]),o=W(W({},this.cluster==="devnet"?await Xn(this.connection):un),t),u=Array.from(new Set([...n,...this.lookupTableAddress])),a=[];for(let b of u)o[b]===void 0&&a.push(new ht(b));let c=await Un({connection:this.connection,address:a});for(let[b,g]of Object.entries(c))o[b]=g;let p=i?ht.default.toBase58():s!=null?s:await At(this.connection,this.blockhashCommitment),l=new _t({payerKey:this.feePayer,recentBlockhash:p,instructions:[...this.allInstructions]}).compileToV0Message(Object.values(o));((f=this.owner)==null?void 0:f.signer)&&!this.signers.some(b=>b.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer);let d=new Vt(l);return d.sign(this.signers),{builder:this,transaction:d,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async b=>{var B;let{skipPreflight:g=!0,sendAndConfirm:A,notSendToRpc:h}=b||{};if(lt([d]),(B=this.owner)!=null&&B.isKeyPair){let T=await this.connection.sendTransaction(d,{skipPreflight:g});return A&&await on(this.connection,T),{txId:T,signedTx:d}}if(this.signAllTransactions){let T=await this.signAllTransactions([d]);if(this.signers.length)for(let k of T)try{k.sign(this.signers)}catch{}return{txId:h?"":await this.connection.sendTransaction(T[0],{skipPreflight:g}),signedTx:T[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:r||{}}}async buildV0MultiTx(e){var a;let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:i}=await this.buildV0(n),s=t.filter(c=>c.builder.instructions.length>0),r=[i,...s.map(c=>c.transaction)],o=[this.signers,...s.map(c=>c.signers)],u=[...this.instructionTypes,...s.map(c=>c.instructionTypes).flat()];return(a=this.owner)!=null&&a.signer&&o.forEach(c=>{c.some(p=>p.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),r.forEach(async(c,p)=>{c.sign(o[p])}),{builder:this,transactions:r,signers:o,instructionTypes:u,buildProps:n,execute:async c=>{var f;let{sequentially:p,onTxUpdate:l,recentBlockHash:d,skipPreflight:y=!0}=c||{};if(d&&r.forEach(b=>b.message.recentBlockhash=d),lt(r),(f=this.owner)!=null&&f.isKeyPair){if(p){let b=[];for(let g of r){let A=await this.connection.sendTransaction(g,{skipPreflight:y});await on(this.connection,A),b.push(A)}return{txIds:b,signedTxs:r}}return{txIds:await Promise.all(r.map(async b=>await this.connection.sendTransaction(b,{skipPreflight:y}))),signedTxs:r}}if(this.signAllTransactions){let b=await this.signAllTransactions(r);if(p){let g=0,A=[],h=async()=>{if(!b[g])return;let B=await this.connection.sendTransaction(b[g],{skipPreflight:y});A.push({txId:B,status:"sent",signedTx:b[g]}),l==null||l([...A]),g++;let T=!1,k=null,x=null,I=N=>{k!==null&&clearInterval(k),x!==null&&this.connection.removeSignatureListener(x);let w=A.findIndex(O=>O.txId===B);if(w>-1){if(A[w].status==="error"||A[w].status==="success")return;A[w].status=N.err?"error":"success"}l==null||l([...A]),N.err||h()};this.loopMultiTxStatus&&(k=setInterval(async()=>{var N;if(T){clearInterval(k);return}try{let w=await this.connection.getTransaction(B,{commitment:"confirmed",maxSupportedTransactionVersion:0});w&&(T=!0,clearInterval(k),I({err:((N=w.meta)==null?void 0:N.err)||null}),console.log("tx status from getTransaction:",B))}catch(w){T=!0,clearInterval(k),console.error("getTransaction timeout:",w,B)}},cn)),x=this.connection.onSignature(B,N=>{if(T){this.connection.removeSignatureListener(x);return}T=!0,I(N)},"confirmed"),this.connection.getSignatureStatus(B)};return h(),{txIds:[],signedTxs:b}}else{let g=[];for(let A=0;A<b.length;A+=1){let h=await this.connection.sendTransaction(b[A],{skipPreflight:y});g.push(h)}return{txIds:g,signedTxs:b}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuild(e){var l;let p=e||{},{splitIns:t=[],computeBudgetConfig:n}=p,i=at(p,["splitIns","computeBudgetConfig"]),s=n?rn(n):{instructions:[],instructionTypes:[]},r=this.signers.reduce((d,y)=>X(W({},d),{[y.publicKey.toBase58()]:y}),{}),o=[],u=[],a=[],c=0;if(this.allInstructions.forEach(d=>{let y=[...a,d],f=n?[...s.instructions,...y]:y,g=[...new Set(y.map(A=>A.keys.filter(h=>h.isSigner).map(h=>h.pubkey.toString())).flat()).values()].map(A=>new ht(A));if(d!==t[c]&&a.length<12&&(Mt({instructions:f,payer:this.feePayer,signers:g})||Mt({instructions:y,payer:this.feePayer,signers:g})))a.push(d);else{if(a.length===0)throw Error("item ins too big");c+=d===t[c]?1:0,Mt({instructions:n?[...s.instructions,...a]:[...a],payer:this.feePayer,signers:g})?o.push(new Wt().add(...s.instructions,...a)):o.push(new Wt().add(...a)),u.push(Array.from(new Set(a.map(A=>A.keys.filter(h=>h.isSigner).map(h=>h.pubkey.toString())).flat())).map(A=>r[A]).filter(A=>A!==void 0)),a=[d]}}),a.length>0){let y=[...new Set(a.map(f=>f.keys.filter(b=>b.isSigner).map(b=>b.pubkey.toString())).flat()).values()].map(f=>r[f]).filter(f=>f!==void 0);Mt({instructions:n?[...s.instructions,...a]:[...a],payer:this.feePayer,signers:y.map(f=>f.publicKey)})?o.push(new Wt().add(...s.instructions,...a)):o.push(new Wt().add(...a)),u.push(y)}return o.forEach(d=>d.feePayer=this.feePayer),(l=this.owner)!=null&&l.signer&&u.forEach(d=>{d.some(y=>y.publicKey.equals(this.owner.publicKey))||d.push(this.owner.signer)}),{builder:this,transactions:o,signers:u,instructionTypes:this.instructionTypes,execute:async d=>{var B;let{sequentially:y,onTxUpdate:f,skipTxCount:b=0,recentBlockHash:g,skipPreflight:A=!0}=d||{},h=g!=null?g:await At(this.connection,this.blockhashCommitment);if(o.forEach(async(T,k)=>{T.recentBlockhash=h,u[k].length&&T.sign(...u[k])}),lt(o),(B=this.owner)!=null&&B.isKeyPair){if(y){let T=0,k=[];for(let x of o){if(++T,T<=b){k.push("tx skipped");continue}let I=await zn(this.connection,x,this.signers.find(N=>N.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:A});k.push(I)}return{txIds:k,signedTxs:o}}return{txIds:await Promise.all(o.map(async T=>await this.connection.sendRawTransaction(T.serialize(),{skipPreflight:A}))),signedTxs:o}}if(this.signAllTransactions){let T=await this.signAllTransactions(o.slice(b,o.length)),k=[...o.slice(0,b),...T];if(y){let x=0,I=[],N=async()=>{if(!k[x])return;x<b&&(I.push({txId:"",status:"success",signedTx:k[x]}),f==null||f([...I]),x++,N());let w=await this.connection.sendRawTransaction(k[x].serialize(),{skipPreflight:A});I.push({txId:w,status:"sent",signedTx:k[x]}),f==null||f([...I]),x++;let O=!1,V=null,M=null,H=j=>{V!==null&&clearInterval(V),M!==null&&this.connection.removeSignatureListener(M);let U=I.findIndex(Oe=>Oe.txId===w);if(U>-1){if(I[U].status==="error"||I[U].status==="success")return;I[U].status=j.err?"error":"success"}f==null||f([...I]),j.err||N()};this.loopMultiTxStatus&&(V=setInterval(async()=>{var j;if(O){clearInterval(V);return}try{let U=await this.connection.getTransaction(w,{commitment:"confirmed",maxSupportedTransactionVersion:0});U&&(O=!0,clearInterval(V),H({err:((j=U.meta)==null?void 0:j.err)||null}),console.log("tx status from getTransaction:",w))}catch(U){O=!0,clearInterval(V),console.error("getTransaction timeout:",U,w)}},cn)),M=this.connection.onSignature(w,j=>{if(O){this.connection.removeSignatureListener(M);return}O=!0,H(j)},"confirmed"),this.connection.getSignatureStatus(w)};return await N(),{txIds:I.map(w=>w.txId),signedTxs:k}}else{let x=[];for(let I=0;I<k.length;I+=1){let N=await this.connection.sendRawTransaction(k[I].serialize(),{skipPreflight:A});x.push(N)}return{txIds:x,signedTxs:k}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:i||{}}}async sizeCheckBuildV0(e){var h;let A=e||{},{computeBudgetConfig:t,splitIns:n=[],lookupTableCache:i={},lookupTableAddress:s=[]}=A,r=at(A,["computeBudgetConfig","splitIns","lookupTableCache","lookupTableAddress"]),o=W(W({},this.cluster==="devnet"?await Xn(this.connection):un),i),u=Array.from(new Set([...this.lookupTableAddress,...s])),a=[];for(let B of u)o[B]===void 0&&a.push(new ht(B));let c=await Un({connection:this.connection,address:a});for(let[B,T]of Object.entries(c))o[B]=T;let p=t?rn(t):{instructions:[],instructionTypes:[]},l=await At(this.connection,this.blockhashCommitment),d=this.signers.reduce((B,T)=>X(W({},B),{[T.publicKey.toBase58()]:T}),{}),y=[],f=[],b=[],g=0;if(this.allInstructions.forEach(B=>{let T=[...b,B],k=t?[...p.instructions,...T]:T;if(B!==n[g]&&b.length<12&&(Et({instructions:k,payer:this.feePayer,lookupTableAddressAccount:o})||Et({instructions:T,payer:this.feePayer,lookupTableAddressAccount:o})))b.push(B);else{if(b.length===0)throw Error("item ins too big");g+=B===n[g]?1:0;let x={};for(let I of[...new Set(u)])o[I]!==void 0&&(x[I]=o[I]);if(t&&Et({instructions:[...p.instructions,...b],payer:this.feePayer,lookupTableAddressAccount:o,recentBlockhash:l})){let I=new _t({payerKey:this.feePayer,recentBlockhash:l,instructions:[...p.instructions,...b]}).compileToV0Message(Object.values(o));y.push(new Vt(I))}else{let I=new _t({payerKey:this.feePayer,recentBlockhash:l,instructions:[...b]}).compileToV0Message(Object.values(o));y.push(new Vt(I))}f.push(Array.from(new Set(b.map(I=>I.keys.filter(N=>N.isSigner).map(N=>N.pubkey.toString())).flat())).map(I=>d[I]).filter(I=>I!==void 0)),b=[B]}}),b.length>0){let T=[...new Set(b.map(k=>k.keys.filter(x=>x.isSigner).map(x=>x.pubkey.toString())).flat()).values()].map(k=>d[k]).filter(k=>k!==void 0);if(t&&Et({instructions:[...p.instructions,...b],payer:this.feePayer,lookupTableAddressAccount:o,recentBlockhash:l})){let k=new _t({payerKey:this.feePayer,recentBlockhash:l,instructions:[...p.instructions,...b]}).compileToV0Message(Object.values(o));y.push(new Vt(k))}else{let k=new _t({payerKey:this.feePayer,recentBlockhash:l,instructions:[...b]}).compileToV0Message(Object.values(o));y.push(new Vt(k))}f.push(T)}return(h=this.owner)!=null&&h.signer&&f.forEach(B=>{B.some(T=>T.publicKey.equals(this.owner.publicKey))||B.push(this.owner.signer)}),y.forEach((B,T)=>{B.sign(f[T])}),{builder:this,transactions:y,buildProps:e,signers:f,instructionTypes:this.instructionTypes,execute:async B=>{var w;let{sequentially:T,onTxUpdate:k,skipTxCount:x=0,recentBlockHash:I,skipPreflight:N=!0}=B||{};if(y.map(async(O,V)=>{f[V].length&&O.sign(f[V]),I&&(O.message.recentBlockhash=I)}),lt(y),(w=this.owner)!=null&&w.isKeyPair){if(T){let O=0,V=[];for(let M of y){if(++O,O<=x){console.log("skip tx: ",O),V.push("tx skipped");continue}let H=await this.connection.sendTransaction(M,{skipPreflight:N});await on(this.connection,H),V.push(H)}return{txIds:V,signedTxs:y}}return{txIds:await Promise.all(y.map(async O=>await this.connection.sendTransaction(O,{skipPreflight:N}))),signedTxs:y}}if(this.signAllTransactions){let O=await this.signAllTransactions(y.slice(x,y.length)),V=[...y.slice(0,x),...O];if(T){let M=0,H=[],j=async()=>{if(!V[M])return;if(M<x){H.push({txId:"",status:"success",signedTx:V[M]}),k==null||k([...H]),M++,j();return}let U=await this.connection.sendTransaction(V[M],{skipPreflight:N});H.push({txId:U,status:"sent",signedTx:V[M]}),k==null||k([...H]),M++;let Oe=!1,nt=null,st=null,Ct=ve=>{nt!==null&&clearInterval(nt),st!==null&&this.connection.removeSignatureListener(st);let Me=H.findIndex(Er=>Er.txId===U);if(Me>-1){if(H[Me].status==="error"||H[Me].status==="success")return;H[Me].status=ve.err?"error":"success"}k==null||k([...H]),ve.err||j()};this.loopMultiTxStatus&&(nt=setInterval(async()=>{var ve;if(Oe){clearInterval(nt);return}try{let Me=await this.connection.getTransaction(U,{commitment:"confirmed",maxSupportedTransactionVersion:0});Me&&(Oe=!0,clearInterval(nt),Ct({err:((ve=Me.meta)==null?void 0:ve.err)||null}),console.log("tx status from getTransaction:",U))}catch(Me){Oe=!0,clearInterval(nt),console.error("getTransaction timeout:",Me,U)}},cn)),st=this.connection.onSignature(U,ve=>{if(Oe){this.connection.removeSignatureListener(st);return}Oe=!0,Ct(ve)},"confirmed"),this.connection.getSignatureStatus(U)};return j(),{txIds:[],signedTxs:V}}else{let M=[];for(let H=0;H<V.length;H+=1){let j=await this.connection.sendTransaction(V[H],{skipPreflight:N});M.push(j)}return{txIds:M,signedTxs:V}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:r||{}}}};import Bo from"bn.js";var xo=new Bo(1e6);import{PublicKey as Mo}from"@solana/web3.js";import Gi,{isBN as Ui}from"bn.js";import{bits as dl,BitStructure as fl,blob as Io,Blob as bl,cstr as yl,f32 as gl,f32be as Pl,f64 as kl,f64be as Al,greedy as wl,Layout as So,ns64 as Tl,ns64be as hl,nu64 as Bl,nu64be as xl,offset as Il,s16 as Sl,s16be as Kl,s24 as Cl,s24be as Ll,s32 as Ko,s32be as Rl,s40 as Nl,s40be as Ol,s48 as Ml,s48be as El,s8 as Fl,seq as Co,struct as Wl,Structure as Lo,u16 as Ro,u16be as _l,u24 as Vl,u24be as vl,u32 as Dl,u32be as ql,u40 as Gl,u40be as Ul,u48 as Xl,u48be as zl,u8 as No,UInt as Oo,union as Ql,Union as Hl,unionLayoutDiscriminator as Yl,utf8 as jl}from"@solana/buffer-layout";var Qn=So,vi=Lo;var Hn=Oo;var Di=No,mt=Ro;var ue=Ko;var qi=Co;var ge=Io;var Bt=class extends Qn{constructor(t,n,i){super(t,i);this.blob=ge(t),this.signed=n}decode(t,n=0){let i=new Gi(this.blob.decode(t,n),10,"le");return this.signed?i.fromTwos(this.span*8).clone():i}encode(t,n,i=0){return typeof t=="number"&&(t=new Gi(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),n,i)}};function D(m){return new Hn(1,m)}function Ke(m){return new Hn(4,m)}function P(m){return new Bt(8,!1,m)}function q(m){return new Bt(16,!1,m)}function Xi(m){return new Bt(8,!0,m)}function zi(m){return new Bt(16,!0,m)}var mn=class extends Qn{constructor(t,n,i,s){super(t.span,s);this.layout=t,this.decoder=n,this.encoder=i}decode(t,n){return this.decoder(this.layout.decode(t,n))}encode(t,n,i){return this.layout.encode(this.encoder(t),n,i)}getSpan(t,n){return this.layout.getSpan(t,n)}};function C(m){return new mn(ge(32),e=>new Mo(e),e=>e.toBuffer(),m)}function Ae(m){return new mn(Di(),Eo,Fo,m)}function Eo(m){if(m===0)return!1;if(m===1)return!0;throw new Error("Invalid bool: "+m)}function Fo(m){return m?1:0}var Yn=class extends vi{decode(e,t){return super.decode(e,t)}};function E(m,e,t){return new Yn(m,e,t)}function Z(m,e,t){let n,i=typeof e=="number"?e:Ui(e)?e.toNumber():new Proxy(e,{get(s,r){if(!n){let o=Reflect.get(s,"count");n=Ui(o)?o.toNumber():o,Reflect.set(s,"count",n)}return Reflect.get(s,r)},set(s,r,o){return r==="count"&&(n=o),Reflect.set(s,r,o)}});return qi(m,i,t)}import{PublicKey as ld}from"@solana/web3.js";import pd from"bn.js";import fd from"decimal.js";import{AccountLayout as gd,createAssociatedTokenAccountIdempotentInstruction as Pd,TOKEN_2022_PROGRAM_ID as kd,TOKEN_PROGRAM_ID as Ad}from"@solana/spl-token";import{PublicKey as mm}from"@solana/web3.js";import{MintLayout as dm,TOKEN_PROGRAM_ID as bm}from"@solana/spl-token";var Qi=m=>new Se({mint:m.address,decimals:m.decimals,symbol:m.symbol,name:m.name}),vt=i=>{var s=i,{amount:m,isRaw:e,name:t}=s,n=at(s,["amount","isRaw","name"]);return new se(new Se({mint:De(n.address).toBase58(),decimals:n.decimals,symbol:n.symbol,name:t}),m,e,t)};var pt=i=>{var s=i,{address:m,programId:e,decimals:t}=s,n=at(s,["address","programId","decimals"]);return W({chainId:101,address:De(m).toBase58(),programId:e,logoURI:"",symbol:"",name:"",decimals:t,tags:[],extensions:n.extensions||{}},n)};var jn=(...m)=>m.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),xt=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=re(t)}createTxBuilder(e){return this.scope.checkOwner(),new ln({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,cluster:this.scope.cluster,owner:this.scope.owner,blockhashCommitment:this.scope.blockhashCommitment,loopMultiTxStatus:this.scope.loopMultiTxStatus,api:this.scope.api,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(jn(e))}logInfo(...e){this.logger.info(jn(e))}logAndCreateError(...e){let t=jn(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{Keypair as Pn,PublicKey as K,SystemProgram as et,TransactionInstruction as Te}from"@solana/web3.js";import ai from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as zt,TOKEN_2022_PROGRAM_ID as de,TOKEN_PROGRAM_ID as ie}from"@solana/spl-token";import zo from"bn.js";import Kt from"decimal.js";import Ee from"bn.js";var me=new Ee(0),Ce=new Ee(1),Ze=new Ee(-1),Le=new Ee(1).shln(64),pn=new Ee(1).shln(128),Zn=Le.sub(Ce),Dt=64,Hi=pn.subn(1),he=-443636,Be=-he,Ue=new Ee("4295048016"),Xe=new Ee("79226673521066979257578248091"),dn=new Ee("4295048017"),fn=new Ee("79226673521066979257578248090"),Yi=16,ji="59543866431248",Zi="184467440737095516",Ji="15793534762490258745",bn=new Ee(10).pow(new Ee(6));var Im=new Ee("18446744073700000000");import Q from"bn.js";import Qe from"decimal.js";function yn(m){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,m,!1),new Uint8Array(e)}function Jn(m,e){let t=0;for(let n=m-1;n>=0&&!e.testn(n);n--)t++;return t}function $n(m,e){let t=0;for(let n=0;n<m&&!e.testn(n);n++)t++;return t}function qt(m,e){for(let t=0;t<m;t++)if(e.testn(t))return!1;return!0}function $i(m,e){return qt(m,e)?null:Jn(m,e)}function er(m,e){return qt(m,e)?null:$n(m,e)}var Nm=Buffer.from("amm_config","utf8"),Wo=Buffer.from("pool","utf8"),_o=Buffer.from("pool_vault","utf8"),Vo=Buffer.from("pool_reward_vault","utf8"),tr=Buffer.from("position","utf8"),vo=Buffer.from("tick_array","utf8"),Do=Buffer.from("operation","utf8"),qo=Buffer.from("pool_tick_array_bitmap_extension","utf8"),Go=Buffer.from("observation","utf8");function nr(m,e,t,n){return ye([Wo,e.toBuffer(),t.toBuffer(),n.toBuffer()],m)}function ei(m,e,t){return ye([_o,e.toBuffer(),t.toBuffer()],m)}function ir(m,e,t){return ye([Vo,e.toBuffer(),t.toBuffer()],m)}function ne(m,e,t){return ye([vo,e.toBuffer(),yn(t)],m)}function Je(m,e,t,n){return ye([tr,e.toBuffer(),yn(t),yn(n)],m)}function Ie(m,e){return ye([tr,e.toBuffer()],m)}function It(m){return ye([Buffer.from("metadata","utf8"),it.toBuffer(),m.toBuffer()],it)}function gn(m){return ye([Do],m)}function Pe(m,e){return ye([qo,e.toBuffer()],m)}function rr(m,e){return ye([Go,e.toBuffer()],m)}var or=Buffer.from("locked_position","utf8");function ti(m,e){return ye([or,e.toBuffer()],m)}function ni(m,e){return ye([or,e.toBuffer()],m)}var Om=Buffer.from("support_mint","utf8");import{PublicKey as Re}from"@solana/web3.js";import{TOKEN_2022_PROGRAM_ID as sr}from"@solana/spl-token";import ce from"bn.js";import $ from"decimal.js";import ze from"bn.js";import ii from"decimal.js";var Gt=class{static getfeeGrowthInside(e,t,n){let i=new ze(0),s=new ze(0);e.tickCurrent>=t.tick?(i=t.feeGrowthOutsideX64A,s=t.feeGrowthOutsideX64B):(i=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),s=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let r=new ze(0),o=new ze(0);e.tickCurrent<n.tick?(r=n.feeGrowthOutsideX64A,o=n.feeGrowthOutsideX64B):(r=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),o=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let u=z.wrappingSubU128(z.wrappingSubU128(e.feeGrowthGlobalX64A,i),r),a=z.wrappingSubU128(z.wrappingSubU128(e.feeGrowthGlobalX64B,s),o);return{feeGrowthInsideX64A:u,feeGrowthInsideBX64:a}}static GetPositionFees(e,t,n,i){let{feeGrowthInsideX64A:s,feeGrowthInsideBX64:r}=this.getfeeGrowthInside(e,n,i),o=z.mulDivFloor(z.wrappingSubU128(s,t.feeGrowthInsideLastX64A),t.liquidity,Le),u=t.tokenFeesOwedA.add(o),a=z.mulDivFloor(z.wrappingSubU128(r,t.feeGrowthInsideLastX64B),t.liquidity,Le),c=t.tokenFeesOwedB.add(a);return{tokenFeeAmountA:u,tokenFeeAmountB:c}}static GetPositionFeesV2(e,t,n,i){let{feeGrowthInsideX64A:s,feeGrowthInsideBX64:r}=this.getfeeGrowthInside(e,n,i),o=z.mulDivFloor(z.wrappingSubU128(s,t.feeGrowthInsideLastX64A),t.liquidity,Le),u=t.tokenFeesOwedA.add(o),a=z.mulDivFloor(z.wrappingSubU128(r,t.feeGrowthInsideLastX64B),t.liquidity,Le),c=t.tokenFeesOwedB.add(a);return{tokenFeeAmountA:u,tokenFeeAmountB:c}}static GetPositionRewardsV2(e,t,n,i){let s=[],r=this.getRewardGrowthInsideV2(e.tickCurrent,n,i,e.rewardInfos);for(let o=0;o<r.length;o++){let u=r[o],a=t.rewardInfos[o],c=z.wrappingSubU128(u,a.growthInsideLastX64),p=z.mulDivFloor(c,t.liquidity,Le),l=a.rewardAmountOwed.add(p);s.push(l)}return s}static GetPositionRewards(e,t,n,i){let s=[],r=this.getRewardGrowthInside(e.tickCurrent,n,i,e.rewardInfos);for(let o=0;o<r.length;o++){let u=r[o],a=t.rewardInfos[o],c=z.wrappingSubU128(u,a.growthInsideLastX64),p=z.mulDivFloor(c,t.liquidity,Le),l=a.rewardAmountOwed.add(p);s.push(l)}return s}static getRewardGrowthInside(e,t,n,i){let s=[];for(let r=0;r<i.length;r++){let o=new ze(0);t.liquidityGross.eqn(0)?o=i[r].rewardGrowthGlobalX64:e<t.tick?o=i[r].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[r]):o=t.rewardGrowthsOutsideX64[r];let u=new ze(0);n.liquidityGross.eqn(0)||(e<n.tick?u=n.rewardGrowthsOutsideX64[r]:u=i[r].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[r])),s.push(z.wrappingSubU128(z.wrappingSubU128(i[r].rewardGrowthGlobalX64,o),u))}return s}static getRewardGrowthInsideV2(e,t,n,i){let s=[];for(let r=0;r<i.length;r++){let o=new ze(0);t.liquidityGross.eqn(0)?o=i[r].rewardGrowthGlobalX64:e<t.tick?o=i[r].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[r]):o=t.rewardGrowthsOutsideX64[r];let u=new ze(0);n.liquidityGross.eqn(0)||(e<n.tick?u=n.rewardGrowthsOutsideX64[r]:u=i[r].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[r])),s.push(z.wrappingSubU128(z.wrappingSubU128(i[r].rewardGrowthGlobalX64,o),u))}return s}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:i,add:s,epochInfo:r}){var b,g,A,h;let o=G.priceToSqrtPriceX64(new ii(e.price),e.mintA.decimals,e.mintB.decimals),u=G.getSqrtPriceX64FromTick(t.tickLower),a=G.getSqrtPriceX64FromTick(t.tickUpper),c=s?1+i:1-i,p=ee.getAmountsFromLiquidity(o,u,a,n,s),[l,d]=[fe(p.amountA,(b=e.mintA.extensions)==null?void 0:b.feeConfig,r,!0),fe(p.amountB,(g=e.mintB.extensions)==null?void 0:g.feeConfig,r,!0)],[y,f]=[fe(new ze(new ii(p.amountA.toString()).mul(c).toFixed(0)),(A=e.mintA.extensions)==null?void 0:A.feeConfig,r,!0),fe(new ze(new ii(p.amountB.toString()).mul(c).toFixed(0)),(h=e.mintB.extensions)==null?void 0:h.feeConfig,r,!0)];return{liquidity:n,amountA:l,amountB:d,amountSlippageA:y,amountSlippageB:f,expirationTime:_e(l.expirationTime,d.expirationTime)}}};var Uo=15,J=class{static async getTickArrays(e,t,n,i,s,r,o){let u=[],a=F.getTickArrayStartIndexByTick(i,s),c=F.getInitializedTickArrayInRange(r,o,s,a,Math.floor(Uo/2));for(let d=0;d<c.length;d++){let{publicKey:y}=ne(t,n,c[d]);u.push(y)}let p=(await He(e,u)).map(d=>d!==null?Ut.decode(d.data):null),l={};for(let d=0;d<u.length;d++){let y=p[d];y!==null&&(l[y.startTickIndex]=X(W({},y),{address:u[d]}))}return l}static nextInitializedTick(e,t,n,i,s,r){let{initializedTick:o,tickArrayAddress:u,tickArrayStartTickIndex:a}=this.nextInitializedTickInOneArray(e,t,n,i,s,r);for(;o==null||o.liquidityGross.lten(0);){if(a=F.getNextTickArrayStartIndex(a,s,r),this.checkIsValidStartIndex(a,s))throw new Error("No enough initialized tickArray");let c=n[a];if(c===void 0)continue;let{nextTick:p,tickArrayAddress:l,tickArrayStartTickIndex:d}=this.firstInitializedTickInOneArray(e,t,c,r);[o,u,a]=[p,l,d]}if(o==null)throw new Error("No invaild tickArray cache");return{nextTick:o,tickArrayAddress:u,tickArrayStartTickIndex:a}}static nextInitializedTickArray(e,t,n,i,s){let r=Math.floor(e/J.tickCount(t)),o=n?F.searchLowBitFromStart(i,s,r-1,1,t):F.searchHightBitFromStart(i,s,r+1,1,t);return o.length>0?{isExist:!0,nextStartIndex:o[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,i){let s;if(i){let o=ke-1;for(;o>=0;){let u=n.ticks[o];if(u.liquidityGross.gtn(0)){s=u;break}o=o-1}}else{let o=0;for(;o<ke;){let u=n.ticks[o];if(u.liquidityGross.gtn(0)){s=u;break}o=o+1}}let{publicKey:r}=ne(e,t,n.startTickIndex);return{nextTick:s,tickArrayAddress:r,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,i,s,r){let o=F.getTickArrayStartIndexByTick(i,s),u=Math.floor((i-o)/s),a=n[o];if(a==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:o};let c;if(r)for(;u>=0;){let l=a.ticks[u];if(l.liquidityGross.gtn(0)){c=l;break}u=u-1}else for(u=u+1;u<ke;){let l=a.ticks[u];if(l.liquidityGross.gtn(0)){c=l;break}u=u+1}let{publicKey:p}=ne(e,t,o);return{initializedTick:c,tickArrayAddress:p,tickArrayStartTickIndex:a.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(F.checkIsOutOfBoundary(e)){if(e>Be)return!1;let n=F.getTickArrayStartIndexByTick(he,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return ke*e}};var ri=14,$e=class{static maxTickInTickarrayBitmap(e){return e*ke*dt}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(i+=1);let s=n*i;return e<0?{minValue:-s,maxValue:-s+n}:{minValue:s,maxValue:s+n}}static nextInitializedTickArrayStartIndex(e,t,n,i){if(!J.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let s=this.maxTickInTickarrayBitmap(n),r=i?t-J.tickCount(n):t+J.tickCount(n);if(r<-s||r>=s)return{isInit:!1,tickIndex:t};let o=n*ke,u=r/o+512;r<0&&r%o!=0&&u--;let a=Math.abs(u);if(i){let c=e.shln(1024-a-1),p=$i(1024,c);if(p!==null){let l=(a-p-512)*o;return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:-s}}else{let c=e.shrn(a),p=er(1024,c);if(p!==null){let l=(a+p-512)*o;return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-J.tickCount(n)}}}},Xt=class{static getBitmapOffset(e,t){if(!J.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=$e.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&i--,i}static getBitmap(e,t,n){let i=this.getBitmapOffset(e,t);return e<0?{offset:i,tickarrayBitmap:n.negativeTickArrayBitmap[i]}:{offset:i,tickarrayBitmap:n.positiveTickArrayBitmap[i]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:i}=this.extensionTickBoundary(t);if(e>=i&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=$e.maxTickInTickarrayBitmap(e),n=-t;if(Be<=t)throw Error(`extensionTickBoundary check error: ${Be}, ${t}`);if(n<=he)throw Error(`extensionTickBoundary check error: ${n}, ${he}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:i}=this.getBitmap(e,t,n),s=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:F.mergeTickArrayBitmap(i).testn(s),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,i){let s=J.tickCount(t),r=n?e-s:e+s,{tickarrayBitmap:o}=this.getBitmap(r,t,i);return this.nextInitializedTickArrayInBitmap(o,r,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,i){let{minValue:s,maxValue:r}=$e.getBitmapTickBoundary(t,n),o=this.tickArrayOffsetInBitmap(t,n);if(i){let u=F.mergeTickArrayBitmap(e).shln(dt-1-o),a=qt(512,u)?null:Jn(512,u);if(a!==null){let c=t-a*J.tickCount(n);return{isInit:!0,tickIndex:c}}else return{isInit:!1,tickIndex:s}}else{let u=F.mergeTickArrayBitmap(e).shrn(o),a=qt(512,u)?null:$n(512,u);if(a!==null){let c=t+a*J.tickCount(n);return{isInit:!0,tickIndex:c}}else return{isInit:!1,tickIndex:r-J.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%$e.maxTickInTickarrayBitmap(t),i=Math.floor(n/J.tickCount(t));return e<0&&n!=0&&(i=dt-i),i}};var pe=class{static getOutputAmountAndRemainAccounts(e,t,n,i,s,r=!1){let o=n.toBase58()===e.mintA.address,u=[],{isExist:a,startIndex:c,nextAccountMeta:p}=this.getFirstInitializedTickArray(e,o);if(!a||c===void 0||!p)throw new Error("Invalid tick array");u.push(p);let{allTrade:l,amountCalculated:d,accounts:y,sqrtPriceX64:f,feeAmount:b}=ft.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,o,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i,c,s,r);return u.push(...y),{allTrade:l,expectedAmountOut:d.mul(Ze),remainingAccounts:u,executionPrice:f,feeAmount:b}}static getInputAmountAndRemainAccounts(e,t,n,i,s){let r=n.toBase58()===e.mintB.address,o=[],{isExist:u,startIndex:a,nextAccountMeta:c}=this.getFirstInitializedTickArray(e,r);if(!u||a===void 0||!c)throw new Error("Invalid tick array");try{let f=this.preInitializedTickArrayStartIndex(e,r);if(f.isExist){let{publicKey:b}=ne(e.programId,e.id,f.nextStartIndex);o.push(b)}}catch{}o.push(c);let{amountCalculated:p,accounts:l,sqrtPriceX64:d,feeAmount:y}=ft.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,r,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i.mul(Ze),a,s);return o.push(...l),{expectedAmountIn:p,remainingAccounts:o,executionPrice:d,feeAmount:y}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:i}=pe.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?Xt.checkTickArrayIsInit(J.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):F.checkTickArrayIsInitialized(F.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:o}=ne(e.programId,e.id,i);return{isExist:!0,startIndex:i,nextAccountMeta:o}}let{isExist:s,nextStartIndex:r}=this.nextInitializedTickArrayStartIndex(e,J.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(s){let{publicKey:o}=ne(e.programId,e.id,r);return{isExist:!0,startIndex:r,nextAccountMeta:o}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/J.tickCount(e.tickSpacing)),i=t?F.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):F.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return i.length>0?{isExist:!0,nextStartIndex:i[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=J.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:i,tickIndex:s}=$e.nextInitializedTickArrayStartIndex(F.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(i)return{isExist:!0,nextStartIndex:s};t=s;let{isInit:r,tickIndex:o}=Xt.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(r)return{isExist:!0,nextStartIndex:o};if(t=o,t<he||t>Be)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:i,rewardInfos:s}){var o,u,a;let r=[];for(let c=0;c<s.length;c++){let p=s[c],l=(a=(o=t.rewardDefaultInfos[c])==null?void 0:o.mint.programId)!=null?a:(u=await e.getAccountInfo(p.tokenMint))==null?void 0:u.owner;if(l===void 0)throw Error("get new reward mint info error");let d=X(W({},p),{perSecond:z.x64ToDecimal(p.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new Re(l)});if(d.tokenMint.equals(Re.default))continue;if(n<=d.openTime.toNumber()||i.eq(me)){r.push(d);continue}let y=new ce(Math.min(d.endTime.toNumber(),n)),f=y.sub(d.lastUpdateTime),b=z.mulDivFloor(f,d.emissionsPerSecondX64,i),g=d.rewardGrowthGlobalX64.add(b),A=z.mulDivFloor(f,d.emissionsPerSecondX64,Le),h=d.rewardTotalEmissioned.add(A);r.push(X(W({},d),{rewardGrowthGlobalX64:g,rewardTotalEmissioned:h,lastUpdateTime:y}))}return r}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:i}=this.tickRange(e);for(let s of t){let r=F.getTickArrayStartIndexByTick(s,e);if(r>=n||r<i)return!0}return!1}static tickRange(e){let t=$e.maxTickInTickarrayBitmap(e),n=-t;return t>Be&&(t=J.getArrayStartIndex(Be,e)+J.tickCount(e)),n<he&&(n=J.getArrayStartIndex(he,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!J.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/J.tickCount(t)*dt}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let i=await ut(e,t.map(r=>({pubkey:r})),{batchRequest:n}),s={};for(let r of i)r.accountInfo!==null&&(s[r.pubkey.toString()]=ar.decode(r.accountInfo.data));return s}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let i={},s=[];for(let u of t){let a=F.getTickArrayStartIndexByTick(u.tickCurrent,u.tickSpacing),c=F.getInitializedTickArrayInRange(u.tickArrayBitmap,u.exBitmapInfo,u.tickSpacing,a,7);for(let p of c){let{publicKey:l}=ne(u.programId,u.id,p);s.push({pubkey:l}),i[l.toString()]=u.id}}let r=await ut(e,s,{batchRequest:n}),o={};for(let u of r){if(!u.accountInfo)continue;let a=i[u.pubkey.toString()];if(!a)continue;o[a.toString()]===void 0&&(o[a.toString()]={});let c=Ut.decode(u.accountInfo.data);o[a.toString()][c.startTickIndex]=X(W({},c),{address:u.pubkey})}return o}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:i=!1,updateOwnerRewardAndFee:s=!0}){var o;let r=[];for(let u=0;u<e.length;u++){let a=e[u];a!==null&&(r.find(c=>c.equals(a.state.programId))||r.push(a.state.programId))}if(n){let u=n.tokenAccounts.map(l=>l.accountInfo.mint),a=[];for(let l of u)for(let d of r)a.push(Ie(d,l).publicKey);let c=await He(t,a,{batchRequest:i}),p={};for(let l of c){if(l===null)continue;let d=oi.decode(l.data),y=d.poolId.toString(),f=e.find(I=>I.state.id.toBase58()===y);if(f===void 0)continue;let b=f.state,g=F._getTickPriceLegacy({poolInfo:b,tick:d.tickLower,baseIn:!0}),A=F._getTickPriceLegacy({poolInfo:b,tick:d.tickUpper,baseIn:!0}),{amountA:h,amountB:B}=ee.getAmountsFromLiquidity(b.sqrtPriceX64,g.tickSqrtPriceX64,A.tickSqrtPriceX64,d.liquidity,!1),T=1/(1-Math.sqrt(Math.sqrt(g.price.div(A.price).toNumber())));f.positionAccount=[...(o=f.positionAccount)!=null?o:[],{poolId:d.poolId,nftMint:d.nftMint,priceLower:g.price,priceUpper:A.price,amountA:h,amountB:B,tickLower:d.tickLower,tickUpper:d.tickUpper,liquidity:d.liquidity,feeGrowthInsideLastX64A:d.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:d.feeGrowthInsideLastX64B,tokenFeesOwedA:d.tokenFeesOwedA,tokenFeesOwedB:d.tokenFeesOwedB,rewardInfos:d.rewardInfos.map(I=>X(W({},I),{pendingReward:new ce(0)})),leverage:T,tokenFeeAmountA:new ce(0),tokenFeeAmountB:new ce(0)}];let k=await F.getTickArrayAddressByTick(f.state.programId,d.poolId,d.tickLower,f.state.tickSpacing),x=await F.getTickArrayAddressByTick(f.state.programId,d.poolId,d.tickUpper,f.state.tickSpacing);p[`${f.state.programId.toString()}-${d.poolId.toString()}-${d.tickLower}`]=k,p[`${f.state.programId.toString()}-${d.poolId.toString()}-${d.tickUpper}`]=x}if(s){let l=Object.values(p),d=await He(t,l,{batchRequest:i}),y={};for(let f=0;f<l.length;f++){let b=d[f];if(b===null)continue;let g=l[f].toString();y[g]=Ut.decode(b.data)}for(let{state:f,positionAccount:b}of e)if(!!b)for(let g of b){let A=`${f.programId.toString()}-${f.id.toString()}-${g.tickLower}`,h=`${f.programId.toString()}-${f.id.toString()}-${g.tickUpper}`,B=y[p[A].toString()],T=y[p[h].toString()],k=B.ticks[F.getTickOffsetInArray(g.tickLower,f.tickSpacing)],x=T.ticks[F.getTickOffsetInArray(g.tickUpper,f.tickSpacing)],{tokenFeeAmountA:I,tokenFeeAmountB:N}=await Gt.GetPositionFees(f,g,k,x),w=await Gt.GetPositionRewards(f,g,k,x);g.tokenFeeAmountA=I.gte(new ce(0))?I:new ce(0),g.tokenFeeAmountB=N.gte(new ce(0))?N:new ce(0);for(let O=0;O<w.length;O++)g.rewardInfos[O].pendingReward=w[O].gte(new ce(0))?w[O]:new ce(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:i,amountIn:s,slippage:r,priceLimit:o=new $(0),catchLiquidityInsufficient:u=!1}){var V;let a,c=n.toBase58()===e.mintA.address,[p,l]=c?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];o.equals(new $(0))?a=c?Ue.add(new ce(1)):Xe.sub(new ce(1)):a=G.priceToSqrtPriceX64(o,e.mintA.decimals,e.mintB.decimals);let d=fe(s,p,i,!1),{allTrade:y,expectedAmountOut:f,remainingAccounts:b,executionPrice:g,feeAmount:A}=pe.getOutputAmountAndRemainAccounts(e,t,n,d.amount.sub((V=d.fee)!=null?V:me),a,u),h=fe(f,l,i,!1),B=G.sqrtPriceX64ToPrice(g,e.mintA.decimals,e.mintB.decimals),T=c?B:new $(1).div(B),k=f.mul(new ce(Math.floor((1-r)*1e10))).div(new ce(1e10)),x=fe(k,l,i,!1),I=c?e.currentPrice:new $(1).div(e.currentPrice),N=new $(T).sub(I).abs(),w=I,O=new Ye(new $(N).mul(10**15).toFixed(0),new $(w).mul(10**15).toFixed(0));return{allTrade:y,realAmountIn:d,amountOut:h,minAmountOut:x,expirationTime:_e(d.expirationTime,h.expirationTime),currentPrice:e.currentPrice,executionPrice:T,priceImpact:O,fee:A,remainingAccounts:b,executionPriceX64:g}}static computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:i,slippage:s,epochInfo:r,catchLiquidityInsufficient:o=!1}){let u=i.address===e.mintB.address,[a,c]=u?[e.mintA,e.mintB]:[e.mintB,e.mintA],[p,l]=[new Se(X(W({},a),{mint:a.address,isToken2022:a.programId===sr.toBase58()})),new Se(X(W({},c),{mint:c.address,isToken2022:c.programId===sr.toBase58()}))],{allTrade:d,realAmountIn:y,amountOut:f,minAmountOut:b,expirationTime:g,currentPrice:A,executionPrice:h,priceImpact:B,fee:T,remainingAccounts:k,executionPriceX64:x}=pe.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new Re(a.address),amountIn:n,slippage:s,epochInfo:r,catchLiquidityInsufficient:o}),I=X(W({},y),{amount:new se(p,y.amount),fee:y.fee===void 0?void 0:new se(p,y.fee)}),N=X(W({},f),{amount:new se(l,f.amount),fee:f.fee===void 0?void 0:new se(l,f.fee)}),w=X(W({},b),{amount:new se(l,b.amount),fee:b.fee===void 0?void 0:new se(l,b.fee)}),O=new xe({baseToken:p,denominator:new ce(10).pow(new ce(20+p.decimals)),quoteToken:l,numerator:A.mul(new $(10**(20+l.decimals))).toFixed(0)}),V=new xe({baseToken:p,denominator:new ce(10).pow(new ce(20+p.decimals)),quoteToken:l,numerator:h.mul(new $(10**(20+l.decimals))).toFixed(0)}),M=new se(p,T);return{allTrade:d,realAmountIn:I,amountOut:N,minAmountOut:w,expirationTime:g,currentPrice:O,executionPrice:V,priceImpact:B,fee:M,remainingAccounts:k,executionPriceX64:x}}static computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:i,amountOut:s,slippage:r,priceLimit:o=new $(0)}){var w;let u=n.toBase58()===e.mintA.address,a={[e.mintA.address]:e.mintA.extensions.feeConfig,[e.mintB.address]:e.mintB.extensions.feeConfig},c;o.equals(new $(0))?c=u?Xe.sub(new ce(1)):Ue.add(new ce(1)):c=G.priceToSqrtPriceX64(o,e.mintA.decimals,e.mintB.decimals);let p=fe(s,a[n.toString()],i,!0),{expectedAmountIn:l,remainingAccounts:d,executionPrice:y,feeAmount:f}=pe.getInputAmountAndRemainAccounts(e,t,n,p.amount.sub((w=p.fee)!=null?w:me),c),b=u?e.mintB.address:e.mintA.address,g=fe(l,a[b],i,!1),A=G.sqrtPriceX64ToPrice(y,e.mintA.decimals,e.mintB.decimals),h=u?A:new $(1).div(A),B=l.mul(new ce(Math.floor((1+r)*1e10))).div(new ce(1e10)),T=fe(B,a[b],i,!0),k=u?e.currentPrice:new $(1).div(e.currentPrice),x=new $(h).sub(k).abs(),I=k,N=new Ye(new $(x).mul(10**15).toFixed(0),new $(I).mul(10**15).toFixed(0));return{amountIn:g,maxAmountIn:T,realAmountOut:p,expirationTime:_e(g.expirationTime,p.expirationTime),currentPrice:e.currentPrice,executionPrice:h,priceImpact:N,fee:f,remainingAccounts:d}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:i}){var y,f,b;let s=e[t],r=F.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),o=F.getTickPrice({poolInfo:e,tick:i,baseIn:!0}).price.toNumber(),u=Math.max(r,s.priceMin),c=Math.min(o,s.priceMax)-u,p=o-r,l=s.priceMax-s.priceMin,d;return c<=0?d=0:p===c?d=l/c:l===c?d=c/p:d=c/l*(c/p),{feeApr:s.feeApr*d,rewardsApr:[((y=s.rewardApr[0])!=null?y:0)*d,((f=s.rewardApr[1])!=null?f:0)*d,((b=s.rewardApr[2])!=null?b:0)*d],apr:s.apr*d}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:i,liquidity:s,positionTickLowerIndex:r,positionTickUpperIndex:o,chainTime:u}){let a=n==="day"?1:n==="week"?7:n==="month"?30:0,c=e[n],p=i[De(e.mintA.address).toString()],l=i[De(e.mintB.address).toString()],d=e.mintA.decimals,y=e.mintB.decimals;if(!c||!p||!l)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let f=G.priceToSqrtPriceX64(new $(e.price),e.mintA.decimals,e.mintB.decimals),b=G.getSqrtPriceX64FromTick(r),g=G.getSqrtPriceX64FromTick(o),{amountSlippageA:A,amountSlippageB:h}=ee.getAmountsFromLiquidityWithSlippage(f,b,g,t,!1,!1,0),{amountSlippageA:B,amountSlippageB:T}=ee.getAmountsFromLiquidityWithSlippage(f,b,g,s,!1,!1,0),k=new $(A.toString()).div(new $(10).pow(d)).mul(p.value).add(new $(h.toString()).div(new $(10).pow(y)).mul(l.value)),x=new $(B.toString()).div(new $(10).pow(d)).mul(p.value).add(new $(T.toString()).div(new $(10).pow(y)).mul(l.value)),I=new $(1).div(k.add(x)),w=new $(c.volumeFee).mul(365).div(a).mul(I).mul(100).toNumber(),O=3600*24*365,V=e.rewardDefaultInfos.map(M=>{var U,Oe;let H=M.mint.decimals,j=i[M.mint.address];return u<((U=M.startTime)!=null?U:0)||u>((Oe=M.endTime)!=null?Oe:0)||!M.perSecond||!j||H===void 0?0:new $(j.value).mul(new $(M.perSecond).mul(O)).div(new $(10).pow(H)).mul(I).mul(100).toNumber()});return{feeApr:w,rewardsApr:V,apr:w+V.reduce((M,H)=>M+H,0)}}static async getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:i,amount:s,slippage:r,add:o,epochInfo:u,amountHasFee:a}){var g,A;let c=G.priceToSqrtPriceX64(new $(e.price),e.mintA.decimals,e.mintB.decimals),p=G.getSqrtPriceX64FromTick(n),l=G.getSqrtPriceX64FromTick(i),d=fe(s,(g=e[t?"mintA":"mintB"].extensions)==null?void 0:g.feeConfig,u,!a),y=new ce(new $(d.amount.sub((A=d.fee)!=null?A:me).toString()).toFixed(0)),f;if(c.lte(p))f=t?ee.getLiquidityFromTokenAmountA(p,l,y,!o):new ce(0);else if(c.lte(l)){let h=ee.getLiquidityFromTokenAmountA(c,l,y,!o),B=ee.getLiquidityFromTokenAmountB(p,c,y);f=t?h:B}else f=t?new ce(0):ee.getLiquidityFromTokenAmountB(p,l,y);let b=await pe.getAmountsFromLiquidity({epochInfo:u,poolInfo:e,tickLower:n,tickUpper:i,liquidity:f,slippage:r,add:o});return{liquidity:f,amountA:t?d:b.amountA,amountB:t?b.amountB:d,amountSlippageA:t?d:b.amountSlippageA,amountSlippageB:t?b.amountSlippageB:d,expirationTime:b.expirationTime}}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:i,liquidity:s,slippage:r,add:o}){var b,g,A,h;let u=G.getSqrtPriceX64FromTick(n),a=G.getSqrtPriceX64FromTick(i),c=o?1+r:1-r,p=ee.getAmountsFromLiquidity(G.priceToSqrtPriceX64(new $(t.price),t.mintA.decimals,t.mintB.decimals),u,a,s,o),[l,d]=[fe(p.amountA,(b=t.mintA.extensions)==null?void 0:b.feeConfig,e,!0),fe(p.amountB,(g=t.mintB.extensions)==null?void 0:g.feeConfig,e,!0)],[y,f]=[fe(p.amountA.muln(c),(A=t.mintA.extensions)==null?void 0:A.feeConfig,e,!0),fe(p.amountB.muln(c),(h=t.mintB.extensions)==null?void 0:h.feeConfig,e,!0)];return{liquidity:s,amountA:l,amountB:d,amountSlippageA:y,amountSlippageB:f,expirationTime:_e(l.expirationTime,d.expirationTime)}}static async fetchComputeMultipleClmmInfo({connection:e,poolList:t,rpcDataMap:n={}}){let i=t.filter(u=>!n[u.id]).map(u=>new Re(u.id));(await He(e,i)).forEach((u,a)=>{!u||(n[i[a].toBase58()]=St.decode(u.data))});let r=t.map(u=>Pe(new Re(u.programId),new Re(u.id)).publicKey),o=await pe.fetchExBitmaps({connection:e,exBitmapAddress:r,batchRequest:!1});return t.reduce((u,a)=>X(W({},u),{[a.id]:X(W({},n[a.id]),{id:new Re(a.id),version:6,programId:new Re(a.programId),mintA:a.mintA,mintB:a.mintB,ammConfig:X(W({},a.config),{id:new Re(a.config.id),fundOwner:""}),currentPrice:new $(a.price),exBitmapAccount:Pe(new Re(a.programId),new Re(a.id)).publicKey,exBitmapInfo:o[Pe(new Re(a.programId),new Re(a.id)).publicKey.toBase58()],startTime:n[a.id].startTime.toNumber(),rewardInfos:n[a.id].rewardInfos})}),{})}static async fetchComputeClmmInfo({connection:e,poolInfo:t,rpcData:n}){return(await this.fetchComputeMultipleClmmInfo({connection:e,rpcDataMap:n?{[t.id]:n}:void 0,poolList:[t]}))[t.id]}};var z=class{static mulDivRoundingUp(e,t,n){let i=e.mul(t),s=i.div(n);return i.mod(n).eq(me)||(s=s.add(Ce)),s}static mulDivFloor(e,t,n){if(n.eq(me))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(me))throw new Error("division by 0");return e.mul(t).add(n.sub(Ce)).div(n)}static x64ToDecimal(e,t){return new Qe(e.toString()).div(Qe.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new Q(e.mul(Qe.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(pn).sub(t).mod(pn)}};function we(m,e){return si(m.mul(e),64,256)}function Xo(m,e,t){let n=m.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function si(m,e,t){let n=m.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var G=class{static sqrtPriceX64ToPrice(e,t,n){return z.x64ToDecimal(e).pow(2).mul(Qe.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return z.decimalToX64(e.mul(Qe.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,i){if(!e.gt(me))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(me))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,i){if(!e.gt(me))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(me))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,i){if(n.eq(me))return e;let s=t.shln(Dt);if(i){let r=s,o=s.add(n.mul(e));return o.gte(r)?z.mulDivCeil(r,e,o):z.mulDivRoundingUp(r,Ce,r.div(e).add(n))}else{let r=n.mul(e);if(!s.gt(r))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let o=s.sub(r);return z.mulDivCeil(s,e,o)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,i){let s=n.shln(Dt);if(i)return e.add(s.div(t));{let r=z.mulDivRoundingUp(s,Ce,t);if(!e.gt(r))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(r)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<he||e>Be)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new Q("18445821805675395072"):new Q("18446744073709551616");return(t&2)!=0&&(n=we(n,new Q("18444899583751176192"))),(t&4)!=0&&(n=we(n,new Q("18443055278223355904"))),(t&8)!=0&&(n=we(n,new Q("18439367220385607680"))),(t&16)!=0&&(n=we(n,new Q("18431993317065453568"))),(t&32)!=0&&(n=we(n,new Q("18417254355718170624"))),(t&64)!=0&&(n=we(n,new Q("18387811781193609216"))),(t&128)!=0&&(n=we(n,new Q("18329067761203558400"))),(t&256)!=0&&(n=we(n,new Q("18212142134806163456"))),(t&512)!=0&&(n=we(n,new Q("17980523815641700352"))),(t&1024)!=0&&(n=we(n,new Q("17526086738831433728"))),(t&2048)!=0&&(n=we(n,new Q("16651378430235570176"))),(t&4096)!=0&&(n=we(n,new Q("15030750278694412288"))),(t&8192)!=0&&(n=we(n,new Q("12247334978884435968"))),(t&16384)!=0&&(n=we(n,new Q("8131365268886854656"))),(t&32768)!=0&&(n=we(n,new Q("3584323654725218816"))),(t&65536)!=0&&(n=we(n,new Q("696457651848324352"))),(t&131072)!=0&&(n=we(n,new Q("26294789957507116"))),(t&262144)!=0&&(n=we(n,new Q("37481735321082"))),e>0&&(n=Hi.div(n)),n}static getTickFromPrice(e,t,n){return G.getTickFromSqrtPriceX64(G.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(Xe)||e.lt(Ue))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new Q(t-64),i=Xo(n,32,128),s=new Q("8000000000000000","hex"),r=0,o=new Q(0),u=t>=64?e.shrn(t-63):e.shln(63-t);for(;s.gt(new Q(0))&&r<Yi;){u=u.mul(u);let y=u.shrn(127);u=u.shrn(63+y.toNumber()),o=o.add(s.mul(y)),s=s.shrn(1),r+=1}let a=o.shrn(32),p=i.add(a).mul(new Q(ji)),l=si(p.sub(new Q(Zi)),64,128).toNumber(),d=si(p.add(new Q(Ji)),64,128).toNumber();return l==d?l:G.getSqrtPriceX64FromTick(d).lte(e)?d:l}},bt=class{static getTickWithPriceAndTickspacing(e,t,n,i){let r=G.getTickFromSqrtPriceX64(G.priceToSqrtPriceX64(e,n,i))/t;return r<0?r=Math.floor(r):r=Math.ceil(r),r*t}static roundPriceWithTickspacing(e,t,n,i){let s=bt.getTickWithPriceAndTickspacing(e,t,n,i),r=G.getSqrtPriceX64FromTick(s);return G.sqrtPriceX64ToPrice(r,n,i)}},ee=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(me))throw new Error("sqrtPriceX64A must greater than 0");let s=n.ushln(Dt),r=t.sub(e);return i?z.mulDivRoundingUp(z.mulDivCeil(s,r,t),Ce,e):z.mulDivFloor(s,r,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(me))throw new Error("sqrtPriceX64A must greater than 0");return i?z.mulDivCeil(n,t.sub(e),Le):z.mulDivFloor(n,t.sub(e),Le)}static getLiquidityFromTokenAmountA(e,t,n,i){e.gt(t)&&([e,t]=[t,e]);let s=n.mul(e).mul(t),r=t.sub(e),o=s.div(r);return i?z.mulDivRoundingUp(o,Ce,Zn):o.shrn(Dt)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),z.mulDivFloor(n,Zn,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,i,s){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return ee.getLiquidityFromTokenAmountA(t,n,i,!1);if(e.lt(n)){let r=ee.getLiquidityFromTokenAmountA(e,n,i,!1),o=ee.getLiquidityFromTokenAmountB(t,e,s);return r.lt(o)?r:o}else return ee.getLiquidityFromTokenAmountB(t,n,s)}static getAmountsFromLiquidity(e,t,n,i,s){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:ee.getTokenAmountAFromLiquidity(t,n,i,s),amountB:new Q(0)};if(e.lt(n)){let r=ee.getTokenAmountAFromLiquidity(e,n,i,s),o=ee.getTokenAmountBFromLiquidity(t,e,i,s);return{amountA:r,amountB:o}}else return{amountA:new Q(0),amountB:ee.getTokenAmountBFromLiquidity(t,n,i,s)}}static getAmountsFromLiquidityWithSlippage(e,t,n,i,s,r,o){let{amountA:u,amountB:a}=ee.getAmountsFromLiquidity(e,t,n,i,r),c=s?1+o:1-o,p=new Q(new Qe(u.toString()).mul(c).toFixed(0)),l=new Q(new Qe(a.toString()).mul(c).toFixed(0));return{amountSlippageA:p,amountSlippageB:l}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:i,slippage:s,add:r,epochInfo:o,amountAddFee:u}){var A,h,B,T;let a=G.priceToSqrtPriceX64(new Qe(e.price),e.mintA.decimals,e.mintB.decimals),c=G.getSqrtPriceX64FromTick(t),p=G.getSqrtPriceX64FromTick(n),l=r?1+s:1-s,d=ee.getAmountsFromLiquidity(a,c,p,i,r),[y,f]=[fe(d.amountA,(A=e.mintA.extensions)==null?void 0:A.feeConfig,o,u),fe(d.amountB,(h=e.mintB.extensions)==null?void 0:h.feeConfig,o,u)],[b,g]=[fe(new Q(new Qe(d.amountA.toString()).mul(l).toFixed(0)),(B=e.mintA.extensions)==null?void 0:B.feeConfig,o,u),fe(new Q(new Qe(d.amountB.toString()).mul(l).toFixed(0)),(T=e.mintB.extensions)==null?void 0:T.feeConfig,o,u)];return{liquidity:i,amountA:y,amountB:f,amountSlippageA:b,amountSlippageB:g,expirationTime:_e(y.expirationTime,f.expirationTime)}}},ft=class{static swapCompute(e,t,n,i,s,r,o,u,a,c,p,l,d,y,f=!1){if(l.eq(me))throw new Error("amountSpecified must not be 0");if(y||(y=r?Ue.add(Ce):Xe.sub(Ce)),r){if(y.lt(Ue))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(y.gte(p))throw new Error("sqrtPriceX64 must smaller than current")}else{if(y.gt(Xe))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(y.lte(p))throw new Error("sqrtPriceX64 must greater than current")}let b=l.gt(me),g={amountSpecifiedRemaining:l,amountCalculated:me,sqrtPriceX64:p,tick:a>d?Math.min(d+J.tickCount(c)-1,a):d,accounts:[],liquidity:u,feeAmount:new Q(0)},A=d,h=n[d],B=0,T=!r&&h.startTickIndex===g.tick;for(;!g.amountSpecifiedRemaining.eq(me)&&!g.sqrtPriceX64.eq(y);){B>10;let k={};k.sqrtPriceStartX64=g.sqrtPriceX64;let x=F.nextInitTick(h,g.tick,c,r,T),I=x||null,N=null;if(!(I!=null&&I.liquidityGross.gtn(0))){let O=pe.nextInitializedTickArrayStartIndex({tickCurrent:g.tick,tickSpacing:c,tickArrayBitmap:i,exBitmapInfo:s},A,r);if(!O.isExist){if(f)return{allTrade:!1,amountSpecifiedRemaining:g.amountSpecifiedRemaining,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts};throw Error("swapCompute LiquidityInsufficient")}A=O.nextStartIndex;let{publicKey:V}=ne(e,t,A);N=V,h=n[A];try{I=F.firstInitializedTick(h,r)}catch{throw Error("not found next tick info")}}k.tickNext=I.tick,k.initialized=I.liquidityGross.gtn(0),d!==A&&N&&(g.accounts.push(N),d=A),k.tickNext<he?k.tickNext=he:k.tickNext>Be&&(k.tickNext=Be),k.sqrtPriceNextX64=G.getSqrtPriceX64FromTick(k.tickNext);let w;if(r&&k.sqrtPriceNextX64.lt(y)||!r&&k.sqrtPriceNextX64.gt(y)?w=y:w=k.sqrtPriceNextX64,[g.sqrtPriceX64,k.amountIn,k.amountOut,k.feeAmount]=ft.swapStepCompute(g.sqrtPriceX64,w,g.liquidity,g.amountSpecifiedRemaining,o,r),g.feeAmount=g.feeAmount.add(k.feeAmount),b?(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.sub(k.amountIn.add(k.feeAmount)),g.amountCalculated=g.amountCalculated.sub(k.amountOut)):(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.add(k.amountOut),g.amountCalculated=g.amountCalculated.add(k.amountIn.add(k.feeAmount))),g.sqrtPriceX64.eq(k.sqrtPriceNextX64)){if(k.initialized){let O=I.liquidityNet;r&&(O=O.mul(Ze)),g.liquidity=ee.addDelta(g.liquidity,O)}T=k.tickNext!=g.tick&&!r&&h.startTickIndex===k.tickNext,g.tick=r?k.tickNext-1:k.tickNext}else if(g.sqrtPriceX64!=k.sqrtPriceStartX64){let O=G.getTickFromSqrtPriceX64(g.sqrtPriceX64);T=O!=g.tick&&!r&&h.startTickIndex===O,g.tick=O}++B}try{let{nextStartIndex:k,isExist:x}=J.nextInitializedTickArray(g.tick,c,r,i,s);x&&d!==k&&(g.accounts.push(ne(e,t,k).publicKey),d=k)}catch{}return{allTrade:!0,amountSpecifiedRemaining:me,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts}}static swapStepCompute(e,t,n,i,s,r){let o={sqrtPriceX64Next:new Q(0),amountIn:new Q(0),amountOut:new Q(0),feeAmount:new Q(0)},u=i.gte(me);if(u){let c=z.mulDivFloor(i,bn.sub(new Q(s.toString())),bn);o.amountIn=r?ee.getTokenAmountAFromLiquidity(t,e,n,!0):ee.getTokenAmountBFromLiquidity(e,t,n,!0),c.gte(o.amountIn)?o.sqrtPriceX64Next=t:o.sqrtPriceX64Next=G.getNextSqrtPriceX64FromInput(e,n,c,r)}else o.amountOut=r?ee.getTokenAmountBFromLiquidity(t,e,n,!1):ee.getTokenAmountAFromLiquidity(e,t,n,!1),i.mul(Ze).gte(o.amountOut)?o.sqrtPriceX64Next=t:o.sqrtPriceX64Next=G.getNextSqrtPriceX64FromOutput(e,n,i.mul(Ze),r);let a=t.eq(o.sqrtPriceX64Next);return r?(a&&u||(o.amountIn=ee.getTokenAmountAFromLiquidity(o.sqrtPriceX64Next,e,n,!0)),a&&!u||(o.amountOut=ee.getTokenAmountBFromLiquidity(o.sqrtPriceX64Next,e,n,!1))):(o.amountIn=a&&u?o.amountIn:ee.getTokenAmountBFromLiquidity(e,o.sqrtPriceX64Next,n,!0),o.amountOut=a&&!u?o.amountOut:ee.getTokenAmountAFromLiquidity(e,o.sqrtPriceX64Next,n,!1)),!u&&o.amountOut.gt(i.mul(Ze))&&(o.amountOut=i.mul(Ze)),u&&!o.sqrtPriceX64Next.eq(t)?o.feeAmount=i.sub(o.amountIn):o.feeAmount=z.mulDivCeil(o.amountIn,new Q(s),bn.sub(new Q(s))),[o.sqrtPriceX64Next,o.amountIn,o.amountOut,o.feeAmount]}};var ke=60,dt=512,F=class{static getTickArrayAddressByTick(e,t,n,i){let s=F.getTickArrayStartIndexByTick(n,i),{publicKey:r}=ne(e,t,s);return r}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=F.getTickArrayStartIndexByTick(e,t),i=Math.floor((e-n)/t);if(i<0||i>=ke)throw new Error("tick offset in array overflow");return i}static getTickArrayBitIndex(e,t){let n=J.tickCount(t),i=e/n;return e<0&&e%n!=0?i=Math.ceil(i)-1:i=Math.floor(i),i}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*J.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*ke,i=Math.floor(e/n)+512;return Math.abs(i)}static checkTickArrayIsInitialized(e,t,n){let i=n*ke,s=Math.floor(t/i)+512,r=Math.abs(s);return{isInitialized:e.testn(r),startIndex:(r-512)*i}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*ke:e+t*ke}static mergeTickArrayBitmap(e){let t=new zo(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,i,s){let r=Math.floor(i/(n*ke));return[...F.searchLowBitFromStart(e,t,r-1,s,n),...F.searchHightBitFromStart(e,t,r,s,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return F.searchHightBitFromStart(e,t,-7680,dt,n)}static getAllInitializedTickArrayInfo(e,t,n,i,s){let r=[],o=F.getAllInitializedTickArrayStartIndex(n,i,s);for(let u of o){let{publicKey:a}=ne(e,t,u);r.push({tickArrayStartIndex:u,tickArrayAddress:a})}return r}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,i,s){let r=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(a=>F.mergeTickArrayBitmap(a)),o=[];for(;n>=-7680;){let a=Math.floor((n+7680)/512),c=(n+7680)%512;if(r[a].testn(c)&&o.push(n),n--,o.length===i)break}let u=J.tickCount(s);return o.map(a=>a*u)}static searchHightBitFromStart(e,t,n,i,s){let r=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(a=>F.mergeTickArrayBitmap(a)),o=[];for(;n<7680;){let a=Math.floor((n+7680)/512),c=(n+7680)%512;if(r[a].testn(c)&&o.push(n),n++,o.length===i)break}let u=J.tickCount(s);return o.map(a=>a*u)}static checkIsOutOfBoundary(e){return e<he||e>Be}static nextInitTick(e,t,n,i,s){if(J.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let o=Math.floor((t-e.startTickIndex)/n);if(i)for(;o>=0;){if(e.ticks[o].liquidityGross.gtn(0))return e.ticks[o];o=o-1}else for(s||(o=o+1);o<ke;){if(e.ticks[o].liquidityGross.gtn(0))return e.ticks[o];o=o+1}return null}static firstInitializedTick(e,t){if(t){let n=ke-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<ke;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let i=G.getSqrtPriceX64FromTick(t),s=G.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:s,tickSqrtPriceX64:i}:{tick:t,price:new Kt(1).div(s),tickSqrtPriceX64:i}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let i=n?t:new Kt(1).div(t),s=bt.getTickWithPriceAndTickspacing(i,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),r=G.getSqrtPriceX64FromTick(s),o=G.sqrtPriceX64ToPrice(r,e.mintA.decimals,e.mintB.decimals);return n?{tick:s,price:o}:{tick:s,price:new Kt(1).div(o)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let i=G.getSqrtPriceX64FromTick(t),s=G.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:s,tickSqrtPriceX64:i}:{tick:t,price:new Kt(1).div(s),tickSqrtPriceX64:i}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let i=n?t:new Kt(1).div(t),s=bt.getTickWithPriceAndTickspacing(i,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),r=G.getSqrtPriceX64FromTick(s),o=G.sqrtPriceX64ToPrice(r,e.mintA.decimals,e.mintB.decimals);return n?{tick:s,price:o}:{tick:s,price:new Kt(1).div(o)}}};var Qo=E([ge(8),D("bump"),mt("index"),C(""),Ke("protocolFeeRate"),Ke("tradeFeeRate"),mt("tickSpacing"),Z(P(),8,"")]),Ho=E([Ke("blockTimestamp"),Xi("tickCumulative"),Z(P(),4)]),ur=E([ge(8),Ae("initialized"),P("recentEpoch"),mt("observationIndex"),C("poolId"),Z(Ho,100,"observations"),Z(P(),4)]),Yo=E([D("rewardState"),P("openTime"),P("endTime"),P("lastUpdateTime"),q("emissionsPerSecondX64"),P("rewardTotalEmissioned"),P("rewardClaimed"),C("tokenMint"),C("tokenVault"),C("creator"),q("rewardGrowthGlobalX64")]),St=E([ge(8),D("bump"),C("ammConfig"),C("creator"),C("mintA"),C("mintB"),C("vaultA"),C("vaultB"),C("observationId"),D("mintDecimalsA"),D("mintDecimalsB"),mt("tickSpacing"),q("liquidity"),q("sqrtPriceX64"),ue("tickCurrent"),Ke(),q("feeGrowthGlobalX64A"),q("feeGrowthGlobalX64B"),P("protocolFeesTokenA"),P("protocolFeesTokenB"),q("swapInAmountTokenA"),q("swapOutAmountTokenB"),q("swapInAmountTokenB"),q("swapOutAmountTokenA"),D("status"),Z(D(),7,""),Z(Yo,3,"rewardInfos"),Z(P(),16,"tickArrayBitmap"),P("totalFeesTokenA"),P("totalFeesClaimedTokenA"),P("totalFeesTokenB"),P("totalFeesClaimedTokenB"),P("fundFeesTokenA"),P("fundFeesTokenB"),P("startTime"),Z(P(),15*4-3,"padding")]),jo=E([q("growthInsideLastX64"),P("rewardAmountOwed")]),oi=E([ge(8),D("bump"),C("nftMint"),C("poolId"),ue("tickLower"),ue("tickUpper"),q("liquidity"),q("feeGrowthInsideLastX64A"),q("feeGrowthInsideLastX64B"),P("tokenFeesOwedA"),P("tokenFeesOwedB"),Z(jo,3,"rewardInfos"),Z(P(),8,"")]),Dp=E([ge(8),D("bump"),C("poolId"),ue("tickLowerIndex"),ue("tickUpperIndex"),q("liquidity"),q("feeGrowthInsideLastX64A"),q("feeGrowthInsideLastX64B"),P("tokenFeesOwedA"),P("tokenFeesOwedB"),Z(q(),3,"rewardGrowthInside"),Z(P(),8,"")]),Zo=E([ue("tick"),zi("liquidityNet"),q("liquidityGross"),q("feeGrowthOutsideX64A"),q("feeGrowthOutsideX64B"),Z(q(),3,"rewardGrowthsOutsideX64"),Z(Ke(),13,"")]),Ut=E([ge(8),C("poolId"),ue("startTickIndex"),Z(Zo,ke,"ticks"),D("initializedTickCount"),Z(D(),115,"")]),Jo=E([ge(329),Z(C(),100,"whitelistMints")]),ar=E([ge(8),C("poolId"),Z(Z(P(),8),ri,"positiveTickArrayBitmap"),Z(Z(P(),8),ri,"negativeTickArrayBitmap")]),qp=E([P(),D("bump"),C("owner"),C("poolId"),C("positionId"),C("nftAccount"),Z(P(),8)]),$o=E([ge(8),D("bump"),C("lockOwner"),C("poolId"),C("positionId"),C("nftAccount"),C("lockNftMint"),P("recentEpoch"),Z(P(),8)]);ur.span;var cr=re("Raydium_Clmm"),Ne={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],openPositionWithTokenEx:[77,255,174,82,125,29,201,46],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},lr=[188,37,179,131,82,150,84,73],mr=[16,72,250,198,14,162,212,19],yt=class{static createPoolInstruction(e,t,n,i,s,r,o,u,a,c,p,l,d,y){let f=E([q("sqrtPriceX64"),P("zero")]),b=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:et.programId,isSigner:!1,isWritable:!1},{pubkey:Ge,isSigner:!1,isWritable:!1},...(y==null?void 0:y.map(h=>({pubkey:h,isSigner:!1,isWritable:!1})))||[]],g=Buffer.alloc(f.span);f.encode({sqrtPriceX64:d,zero:me},g);let A=Buffer.from([...Ne.createPool,...g]);return new Te({keys:b,programId:e,data:A})}static async createPoolInstructions(e){let{programId:t,owner:n,mintA:i,mintB:s,ammConfigId:r,initialPriceX64:o,extendMintAccount:u}=e,[a,c]=[new K(i.address),new K(s.address)],{publicKey:p}=nr(t,r,a,c),{publicKey:l}=rr(t,p),{publicKey:d}=ei(t,p,a),{publicKey:y}=ei(t,p,c),f=Pe(t,p).publicKey,b=[this.createPoolInstruction(t,p,n,r,l,a,d,new K(i.programId||ie),c,y,new K(s.programId||ie),f,o,u)];return{signers:[],instructions:b,instructionTypes:[Y.CreateAccount,Y.ClmmCreatePool],address:{poolId:p,observationId:l,exBitmapAccount:f,mintAVault:d,mintBVault:y},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,i,s,r,o,u,a,c,p,l,d,y,f,b,g,A,h,B,T,k,x,I,N,w){let O=E([ue("tickLowerIndex"),ue("tickUpperIndex"),ue("tickArrayLowerStartIndex"),ue("tickArrayUpperStartIndex"),q("liquidity"),P("amountMaxA"),P("amountMaxB"),Ae("withMetadata"),D("optionBaseFlag"),Ae("baseFlag")]),V=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[]],M=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:et.programId,isSigner:!1,isWritable:!1},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:zt,isSigner:!1,isWritable:!1},{pubkey:it,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...V],H=Buffer.alloc(O.span);O.encode({tickLowerIndex:A,tickUpperIndex:h,tickArrayLowerStartIndex:B,tickArrayUpperStartIndex:T,liquidity:k,amountMaxA:x,amountMaxB:I,withMetadata:N==="create",baseFlag:!1,optionBaseFlag:0},H);let j=Buffer.from([...Ne.openPosition,...H]);return new Te({keys:M,programId:e,data:j})}static openPositionFromLiquidityInstruction22(e,t,n,i,s,r,o,u,a,c,p,l,d,y,f,b,g,A,h,B,T,k,x,I,N){let w=E([ue("tickLowerIndex"),ue("tickUpperIndex"),ue("tickArrayLowerStartIndex"),ue("tickArrayUpperStartIndex"),q("liquidity"),P("amountMaxA"),P("amountMaxB"),Ae("withMetadata"),D("optionBaseFlag"),Ae("baseFlag")]),O=[...N?[{pubkey:N,isSigner:!1,isWritable:!0}]:[]],V=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:et.programId,isSigner:!1,isWritable:!1},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:zt,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...O],M=Buffer.alloc(w.span);w.encode({tickLowerIndex:g,tickUpperIndex:A,tickArrayLowerStartIndex:h,tickArrayUpperStartIndex:B,liquidity:T,amountMaxA:k,amountMaxB:x,withMetadata:I==="create",baseFlag:!1,optionBaseFlag:0},M);let H=Buffer.from([...Ne.openPositionWithTokenEx,...M]);return new Te({keys:V,programId:e,data:H})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:s,liquidity:r,amountMaxA:o,amountMaxB:u,withMetadata:a,getEphemeralSigners:c,nft2022:p}){let l=[],[d,y]=[new K(e.programId),new K(e.id)],f;if(c)f=new K((await c(1))[0]);else{let N=Pn.generate();l.push(N),f=N.publicKey}let b=F.getTickArrayStartIndexByTick(i,e.config.tickSpacing),g=F.getTickArrayStartIndexByTick(s,e.config.tickSpacing),{publicKey:A}=ne(d,y,b),{publicKey:h}=ne(d,y,g),{publicKey:B}=p?ae(n.wallet,f,de):ae(n.wallet,f,ie),{publicKey:T}=It(f),{publicKey:k}=Ie(d,f),{publicKey:x}=Je(d,y,i,s),I=p?this.openPositionFromLiquidityInstruction22(d,n.feePayer,y,n.wallet,f,B,x,A,h,k,n.tokenAccountA,n.tokenAccountB,new K(t.vault.A),new K(t.vault.B),new K(e.mintA.address),new K(e.mintB.address),i,s,b,g,r,o,u,a,pe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Pe(d,y).publicKey:void 0):this.openPositionFromLiquidityInstruction(d,n.feePayer,y,n.wallet,f,B,T,x,A,h,k,n.tokenAccountA,n.tokenAccountB,new K(t.vault.A),new K(t.vault.B),new K(e.mintA.address),new K(e.mintB.address),i,s,b,g,r,o,u,a,pe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Pe(d,y).publicKey:void 0);return{signers:l,instructions:[I],instructionTypes:[Y.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:f,tickArrayLower:A,tickArrayUpper:h,positionNftAccount:B,metadataAccount:T,personalPosition:k,protocolPosition:x}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:s,base:r,baseAmount:o,otherAmountMax:u,withMetadata:a,getEphemeralSigners:c,nft2022:p}){let l=[],[d,y]=[new K(e.programId),new K(e.id)],f;if(c)f=new K((await c(1))[0]);else{let N=Pn.generate();l.push(N),f=N.publicKey}let b=F.getTickArrayStartIndexByTick(i,e.config.tickSpacing),g=F.getTickArrayStartIndexByTick(s,e.config.tickSpacing),{publicKey:A}=ne(d,y,b),{publicKey:h}=ne(d,y,g),{publicKey:B}=p?ae(n.wallet,f,de):ae(n.wallet,f,ie),{publicKey:T}=It(f),{publicKey:k}=Ie(d,f),{publicKey:x}=Je(d,y,i,s),I=p?this.openPositionFromBaseInstruction22(d,n.feePayer,y,n.wallet,f,B,x,A,h,k,n.tokenAccountA,n.tokenAccountB,new K(t.vault.A),new K(t.vault.B),new K(e.mintA.address),new K(e.mintB.address),i,s,b,g,a,r,o,u,pe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Pe(d,y).publicKey:void 0):this.openPositionFromBaseInstruction(d,n.feePayer,y,n.wallet,f,B,T,x,A,h,k,n.tokenAccountA,n.tokenAccountB,new K(t.vault.A),new K(t.vault.B),new K(e.mintA.address),new K(e.mintB.address),i,s,b,g,a,r,o,u,pe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Pe(d,y).publicKey:void 0);return{address:{nftMint:f,tickArrayLower:A,tickArrayUpper:h,positionNftAccount:B,metadataAccount:T,personalPosition:k,protocolPosition:x},instructions:[I],signers:l,instructionTypes:[Y.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,i,s,r,o,u,a,c,p,l,d,y,f,b,g,A,h,B,T,k,x,I,N,w){let O=E([ue("tickLowerIndex"),ue("tickUpperIndex"),ue("tickArrayLowerStartIndex"),ue("tickArrayUpperStartIndex"),q("liquidity"),P("amountMaxA"),P("amountMaxB"),Ae("withMetadata"),D("optionBaseFlag"),Ae("baseFlag")]),V=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[]],M=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:et.programId,isSigner:!1,isWritable:!1},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:zt,isSigner:!1,isWritable:!1},{pubkey:it,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...V],H=Buffer.alloc(O.span);O.encode({tickLowerIndex:A,tickUpperIndex:h,tickArrayLowerStartIndex:B,tickArrayUpperStartIndex:T,liquidity:new ai(0),amountMaxA:x==="MintA"?I:N,amountMaxB:x==="MintA"?N:I,withMetadata:k==="create",baseFlag:x==="MintA",optionBaseFlag:1},H);let j=Buffer.from([...Ne.openPosition,...H]);return new Te({keys:M,programId:e,data:j})}static openPositionFromBaseInstruction22(e,t,n,i,s,r,o,u,a,c,p,l,d,y,f,b,g,A,h,B,T,k,x,I,N){let w=E([ue("tickLowerIndex"),ue("tickUpperIndex"),ue("tickArrayLowerStartIndex"),ue("tickArrayUpperStartIndex"),q("liquidity"),P("amountMaxA"),P("amountMaxB"),Ae("withMetadata"),D("optionBaseFlag"),Ae("baseFlag")]),O=[...N?[{pubkey:N,isSigner:!1,isWritable:!0}]:[]],V=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:et.programId,isSigner:!1,isWritable:!1},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:zt,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...O],M=Buffer.alloc(w.span);w.encode({tickLowerIndex:g,tickUpperIndex:A,tickArrayLowerStartIndex:h,tickArrayUpperStartIndex:B,liquidity:new ai(0),amountMaxA:k==="MintA"?x:I,amountMaxB:k==="MintA"?I:x,withMetadata:T==="create",baseFlag:k==="MintA",optionBaseFlag:1},M);let H=Buffer.from([...Ne.openPositionWithTokenEx,...M]);return new Te({keys:V,programId:e,data:H})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:s,liquidity:r,amountMaxA:o,amountMaxB:u,withMetadata:a,getEphemeralSigners:c,nft2022:p}){let l,d=[];if(c)l=new K((await c(1))[0]);else{let N=Pn.generate();d.push(N),l=N.publicKey}let[y,f]=[new K(e.programId),new K(e.id)],b=F.getTickArrayStartIndexByTick(i,e.config.tickSpacing),g=F.getTickArrayStartIndexByTick(s,e.config.tickSpacing),{publicKey:A}=ne(y,f,b),{publicKey:h}=ne(y,f,g),{publicKey:B}=p?ae(n.wallet,l,de):ae(n.wallet,l,ie),{publicKey:T}=It(l),{publicKey:k}=Ie(y,l),{publicKey:x}=Je(y,f,i,s),I=p?this.openPositionFromLiquidityInstruction22(y,n.wallet,f,n.wallet,l,B,x,A,h,k,n.tokenAccountA,n.tokenAccountB,new K(t.vault.A),new K(t.vault.B),new K(t.mintA.address),new K(t.mintB.address),i,s,b,g,r,o,u,a,pe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Pe(y,f).publicKey:void 0):this.openPositionFromLiquidityInstruction(y,n.wallet,f,n.wallet,l,B,T,x,A,h,k,n.tokenAccountA,n.tokenAccountB,new K(t.vault.A),new K(t.vault.B),new K(t.mintA.address),new K(t.mintB.address),i,s,b,g,r,o,u,a,pe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Pe(y,f).publicKey:void 0);return{address:{nftMint:l,tickArrayLower:A,tickArrayUpper:h,positionNftAccount:B,metadataAccount:T,personalPosition:k,protocolPosition:x},instructions:[I],signers:d,instructionTypes:[Y.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,i,s,r){let o=E([]),u=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:et.programId,isSigner:!1,isWritable:!1},{pubkey:r?de:ie,isSigner:!1,isWritable:!1}],a=Buffer.alloc(o.span);o.encode({},a);let c=Buffer.from([...Ne.closePosition,...a]);return new Te({keys:u,programId:e,data:c})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:i,nft2022:s}){let r=new K(e.programId),o=s?ae(n.wallet,i.nftMint,de).publicKey:ae(n.wallet,i.nftMint,ie).publicKey,{publicKey:u}=Ie(r,i.nftMint),a=[];return a.push(this.closePositionInstruction(r,n.wallet,i.nftMint,o,u,s)),{address:{positionNftAccount:o,personalPosition:u},signers:[],instructions:a,instructionTypes:[Y.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,i,s,r,o,u,a,c,p,l,d,y,f,b,g,A){let h=E([q("liquidity"),P("amountMaxA"),P("amountMaxB"),D("optionBaseFlag"),Ae("baseFlag")]),B=[...A?[{pubkey:A,isSigner:!1,isWritable:!0}]:[]],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...B],k=Buffer.alloc(h.span);h.encode({liquidity:f,amountMaxA:b,amountMaxB:g,optionBaseFlag:0,baseFlag:!1},k);let x=Buffer.from([...Ne.increaseLiquidity,...k]);return new Te({keys:T,programId:e,data:x})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:s,amountMaxA:r,amountMaxB:o,nft2022:u}){let[a,c]=[new K(e.programId),new K(e.id)],p=F.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),l=F.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:d}=ne(a,c,p),{publicKey:y}=ne(a,c,l),{publicKey:f}=u?ae(i.wallet,n.nftMint,de):ae(i.wallet,n.nftMint,ie),{publicKey:b}=Ie(a,n.nftMint),{publicKey:g}=Je(a,c,n.tickLower,n.tickUpper),A=this.increasePositionFromLiquidityInstruction(a,i.wallet,f,b,c,g,d,y,i.tokenAccountA,i.tokenAccountB,new K(t.vault.A),new K(t.vault.B),new K(e.mintA.address),new K(e.mintB.address),s,r,o,pe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[p,l])?Pe(a,c).publicKey:void 0);return{address:{tickArrayLower:d,tickArrayUpper:y,positionNftAccount:f,personalPosition:b,protocolPosition:g},signers:[],instructions:[A],instructionTypes:[Y.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,base:s,baseAmount:r,otherAmountMax:o,nft2022:u}){let[a,c]=[new K(e.programId),new K(e.id)],p=F.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),l=F.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:d}=ne(a,c,p),{publicKey:y}=ne(a,c,l),{publicKey:f}=u?ae(i.wallet,n.nftMint,de):ae(i.wallet,n.nftMint,ie),{publicKey:b}=Ie(a,n.nftMint),{publicKey:g}=Je(a,c,n.tickLower,n.tickUpper);return{address:{tickArrayLower:d,tickArrayUpper:y,positionNftAccount:f,personalPosition:b,protocolPosition:g},instructions:[this.increasePositionFromBaseInstruction(a,i.wallet,f,b,c,g,d,y,i.tokenAccountA,i.tokenAccountB,new K(t.vault.A),new K(t.vault.B),new K(e.mintA.address),new K(e.mintB.address),s,r,o,pe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[p,l])?Pe(a,c).publicKey:void 0)],signers:[],instructionTypes:[Y.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,i,s,r,o,u,a,c,p,l,d,y,f,b,g,A){let h=E([q("liquidity"),P("amountMaxA"),P("amountMaxB"),D("optionBaseFlag"),Ae("baseFlag")]),B=[...A?[{pubkey:A,isSigner:!1,isWritable:!0}]:[]],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...B],k=Buffer.alloc(h.span);h.encode({liquidity:new ai(0),amountMaxA:f==="MintA"?b:g,amountMaxB:f==="MintA"?g:b,baseFlag:f==="MintA",optionBaseFlag:1},k);let x=Buffer.from([...Ne.increaseLiquidity,...k]);return new Te({keys:T,programId:e,data:x})}static decreaseLiquidityInstruction(e,t,n,i,s,r,o,u,a,c,p,l,d,y,f,b,g,A,h){let B=E([q("liquidity"),P("amountMinA"),P("amountMinB")]),T=[...h?[{pubkey:h,isSigner:!1,isWritable:!0}]:[],...f.map(N=>[{pubkey:N.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:N.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:N.rewardMint,isSigner:!1,isWritable:!1}]).flat()],k=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:tn,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...T],x=Buffer.alloc(B.span);B.encode({liquidity:b,amountMinA:g,amountMinB:A},x);let I=Buffer.from([...Ne.decreaseLiquidity,...x]);return new Te({keys:k,programId:e,data:I})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:s,amountMinA:r,amountMinB:o,programId:u,nft2022:a}){let[c,p]=[new K(e.programId),new K(e.id)],l=F.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=F.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:y}=ne(c,p,l),{publicKey:f}=ne(c,p,d),{publicKey:b}=a?ae(i.wallet,n.nftMint,de):ae(i.wallet,n.nftMint,u),{publicKey:g}=Ie(c,n.nftMint),{publicKey:A}=Je(c,p,n.tickLower,n.tickUpper),h=[];for(let k=0;k<e.rewardDefaultInfos.length;k++)h.push({poolRewardVault:new K(t.rewardInfos[k].vault),ownerRewardVault:i.rewardAccounts[k],rewardMint:new K(e.rewardDefaultInfos[k].mint.address)});let B=[],T=this.decreaseLiquidityInstruction(c,i.wallet,b,g,p,A,y,f,i.tokenAccountA,i.tokenAccountB,new K(t.vault.A),new K(t.vault.B),new K(e.mintA.address),new K(e.mintB.address),h,s,r,o,pe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[l,d])?Pe(c,p).publicKey:void 0);return B.push(T),{address:{tickArrayLower:y,tickArrayUpper:f,positionNftAccount:b,personalPosition:g,protocolPosition:A},signers:[],instructions:B,instructionTypes:[Y.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,i,s,r,o,u,a,c,p,l,d,y,f,b,g){let A=E([P("amount"),P("otherAmountThreshold"),q("sqrtPriceLimitX64"),Ae("isBaseInput")]),h=[...g?[{pubkey:g,isSigner:!1,isWritable:!0}]:[],...p.map(x=>({pubkey:x,isSigner:!1,isWritable:!0}))],B=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:tn,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},...h],T=Buffer.alloc(A.span);A.encode({amount:d,otherAmountThreshold:y,sqrtPriceLimitX64:f,isBaseInput:b},T);let k=Buffer.from([...Ne.swap,...T]);return new Te({keys:B,programId:e,data:k})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:i,inputMint:s,amountIn:r,amountOutMin:o,sqrtPriceLimitX64:u,remainingAccounts:a}){let[c,p]=[new K(e.programId),new K(e.id)],[l,d]=[new K(t.vault.A),new K(t.vault.B)],[y,f]=[new K(e.mintA.address),new K(e.mintB.address)],b=e.mintA.address===s.toString(),g=[this.swapInstruction(c,i.wallet,p,new K(e.config.id),b?i.tokenAccountA:i.tokenAccountB,b?i.tokenAccountB:i.tokenAccountA,b?l:d,b?d:l,b?y:f,b?f:y,a,n,r,o,u,!0,Pe(c,p).publicKey)];return{signers:[],instructions:g,instructionTypes:[Y.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static makeSwapBaseOutInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:i,outputMint:s,amountOut:r,amountInMax:o,sqrtPriceLimitX64:u,remainingAccounts:a}){let[c,p]=[new K(e.programId),new K(e.id)],[l,d]=[new K(t.vault.A),new K(t.vault.B)],[y,f]=[new K(e.mintA.address),new K(e.mintB.address)],b=e.mintA.address===s.toBase58(),g=[this.swapInstruction(c,i.wallet,p,new K(e.config.id),b?i.tokenAccountB:i.tokenAccountA,b?i.tokenAccountA:i.tokenAccountB,b?d:l,b?l:d,b?f:y,b?y:f,a,n,r,o,u,!1,Pe(c,p).publicKey)];return{signers:[],instructions:g,instructionTypes:[Y.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,i,s,r,o,u,a,c,p,l){let d=E([P("openTime"),P("endTime"),q("emissionsPerSecondX64")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:et.programId,isSigner:!1,isWritable:!1},{pubkey:Ge,isSigner:!1,isWritable:!1}],f=Buffer.alloc(d.span);d.encode({openTime:oe(c),endTime:oe(p),emissionsPerSecondX64:l},f);let b=Buffer.from([...Ne.initReward,...f]);return new Te({keys:y,programId:e,data:b})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[s,r]=[new K(e.programId),new K(e.id)],o=ir(s,r,i.mint).publicKey,u=gn(s).publicKey,a=[this.initRewardInstruction(s,n.wallet,r,u,new K(e.config.id),n.tokenAccount,i.programId,i.mint,o,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{poolRewardVault:o,operationId:u},signers:[],instructions:a,instructionTypes:[Y.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,i,s,r,o,u,a,c,p,l){let d=E([D("rewardIndex"),q("emissionsPerSecondX64"),P("openTime"),P("endTime")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0}],f=Buffer.alloc(d.span);d.encode({rewardIndex:a,emissionsPerSecondX64:l,openTime:oe(c),endTime:oe(p)},f);let b=Buffer.from([...Ne.setRewardEmissions,...f]);return new Te({keys:y,programId:e,data:b})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[s,r]=[new K(e.programId),new K(e.id)],o,u,a;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===i.mint.toString()&&(o=l,u=new K(t.rewardInfos[l].vault),a=new K(t.rewardInfos[l].mint.address));(o===void 0||u===void 0)&&cr.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let c=gn(s).publicKey,p=[this.setRewardInstruction(s,n.wallet,r,c,new K(e.config.id),n.tokenAccount,u,a,o,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{rewardVault:u,operationId:c},signers:[],instructions:p,instructionTypes:[Y.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,i,s,r,o){let u=E([D("rewardIndex")]),a=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:tn,isSigner:!1,isWritable:!1}],c=Buffer.alloc(u.span);u.encode({rewardIndex:o},c);let p=Buffer.from([...Ne.collectReward,...c]);return new Te({keys:a,programId:e,data:p})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:i}){let[s,r]=[new K(e.programId),new K(e.id)],o,u;for(let c=0;c<e.rewardDefaultInfos.length;c++)e.rewardDefaultInfos[c].mint.address===i.toString()&&(o=c,u=new K(t.rewardInfos[c].vault));(o===void 0||u===void 0)&&cr.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let a=[this.collectRewardInstruction(s,n.wallet,r,n.tokenAccount,u,i,o)];return{address:{rewardVault:u},signers:[],instructions:a,instructionTypes:[Y.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static async makeLockPositions({programId:e,authProgramId:t,poolProgramId:n,payer:i,wallet:s,nftMint:r,nft2022:o,getEphemeralSigners:u}){let a=[],c;if(u)c=new K((await u(1))[0]);else{let g=Pn.generate();a.push(g),c=g.publicKey}let p=o?ae(s,r,de).publicKey:ae(s,r,ie).publicKey,{publicKey:l}=Ie(n,r),d=ni(e,c).publicKey,y=ae(s,c,ie).publicKey,f=It(c).publicKey,b=yt.lockPositionInstructionV2({programId:e,auth:t,payer:i,positionOwner:s,lockOwner:s,positionNftAccount:p,positionId:l,lockPositionId:d,lockNftMint:c,lockNftAccount:y,metadataAccount:f,withMetadata:!0,nft2022:o,positionNftMint:r,authPositionNftAccount:ae(t,r,o?de:ie).publicKey,positionNftProgram:o?de:ie});return{address:{positionId:l,lockPositionId:d,lockNftAccount:y,lockNftMint:c,positionNftAccount:p,metadataAccount:f},instructions:[b],signers:a,instructionTypes:[Y.ClmmLockPosition],lookupTableAddress:[]}}static lockPositionInstructionV2({programId:e,auth:t,payer:n,positionOwner:i,lockOwner:s,positionNftAccount:r,positionId:o,positionNftMint:u,authPositionNftAccount:a,positionNftProgram:c,lockPositionId:p,lockNftMint:l,lockNftAccount:d,metadataAccount:y,withMetadata:f}){let b=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!0,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:it,isSigner:!1,isWritable:!1},{pubkey:zt,isSigner:!1,isWritable:!1},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:et.programId,isSigner:!1,isWritable:!1}],g=E([Ae("withMetadata")]),A=Buffer.alloc(g.span);g.encode({withMetadata:f},A);let h=Buffer.from([...lr,...A]);return new Te({keys:b,programId:e,data:h})}static lockPositionInstruction({programId:e,authProgramId:t,poolProgramId:n,owner:i,positionNft:s}){let{publicKey:r}=ae(i,s,ie),{publicKey:o}=Ie(n,s),u=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:ti(e,o).publicKey,isSigner:!1,isWritable:!0},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:et.programId,isSigner:!1,isWritable:!1}];return new Te({keys:u,programId:e,data:Buffer.from(lr)})}static harvestLockPositionInstruction(e){let[t,n]=[new K(e.poolKeys.programId),new K(e.poolKeys.id)],i=F.getTickArrayStartIndexByTick(e.ownerPosition.tickLower,e.poolKeys.config.tickSpacing),s=F.getTickArrayStartIndexByTick(e.ownerPosition.tickUpper,e.poolKeys.config.tickSpacing),{publicKey:r}=ne(t,n,i),{publicKey:o}=ne(t,n,s),{publicKey:u}=ae(e.owner,e.ownerPosition.nftMint,ie),{publicKey:a}=Ie(t,e.ownerPosition.nftMint),{publicKey:c}=Je(t,n,e.ownerPosition.tickLower,e.ownerPosition.tickUpper),p=[];for(let y=0;y<e.poolKeys.rewardInfos.length;y++)p.push({poolRewardVault:new K(e.poolKeys.rewardInfos[y].vault),ownerRewardVault:e.ownerRewardAccounts[y],rewardMint:new K(e.poolKeys.rewardInfos[y].mint.address)});let l=[...p.map(y=>[{pubkey:y.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:y.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:y.rewardMint,isSigner:!1,isWritable:!1}]).flat()],d=[{pubkey:e.authProgramId,isSigner:!1,isWritable:!1},{pubkey:ti(e.programId,a).publicKey,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e.owner,isSigner:!0,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:new K(e.poolKeys.vault.A),isSigner:!1,isWritable:!0},{pubkey:new K(e.poolKeys.vault.B),isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:e.userVaultA,isSigner:!1,isWritable:!0},{pubkey:e.userVaultB,isSigner:!1,isWritable:!0},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:kt,isSigner:!1,isWritable:!1},{pubkey:new K(e.poolKeys.mintA.address),isSigner:!1,isWritable:!1},{pubkey:new K(e.poolKeys.mintB.address),isSigner:!1,isWritable:!1},...l];return new Te({keys:d,programId:e.programId,data:Buffer.from(mr)})}static harvestLockPositionInstructionV2({programId:e,auth:t,lockPositionId:n,clmmProgram:i,lockOwner:s,lockNftMint:r,lockNftAccount:o,positionNftAccount:u,positionId:a,poolId:c,protocolPosition:p,vaultA:l,vaultB:d,tickArrayLower:y,tickArrayUpper:f,userVaultA:b,userVaultB:g,mintA:A,mintB:h,rewardAccounts:B,exTickArrayBitmap:T}){let k=[...T?[{pubkey:T,isSigner:!1,isWritable:!0}]:[],...B.map(I=>[{pubkey:I.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:I.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:I.rewardMint,isSigner:!1,isWritable:!1}]).flat()],x=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:kt,isSigner:!1,isWritable:!1},{pubkey:A,isSigner:!1,isWritable:!1},{pubkey:h,isSigner:!1,isWritable:!1},...k];return new Te({keys:x,programId:e,data:Buffer.from(mr)})}};var of=E([ge(8),D("bump"),Ae("disableCreatePool"),mt("index"),P("tradeFeeRate"),P("protocolFeeRate"),P("fundFeeRate"),P("createPoolFee"),C("protocolOwner"),C("fundOwner"),Z(P(),16)]),pr=E([ge(8),C("configId"),C("poolCreator"),C("vaultA"),C("vaultB"),C("mintLp"),C("mintA"),C("mintB"),C("mintProgramA"),C("mintProgramB"),C("observationId"),D("bump"),D("status"),D("lpDecimals"),D("mintDecimalA"),D("mintDecimalB"),P("lpAmount"),P("protocolFeesMintA"),P("protocolFeesMintB"),P("fundFeesMintA"),P("fundFeesMintB"),P("openTime"),Z(P(),32)]);import{PublicKey as kf,TransactionInstruction as ts,Keypair as wf,SystemProgram as Tf}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Bf,TOKEN_2022_PROGRAM_ID as xf,TOKEN_PROGRAM_ID as If}from"@solana/spl-token";var es=Buffer.from("vault_and_lp_mint_auth_seed","utf8"),uf=Buffer.from("amm_config","utf8"),cf=Buffer.from("pool","utf8"),lf=Buffer.from("pool_lp_mint","utf8"),mf=Buffer.from("pool_vault","utf8"),pf=Buffer.from("observation","utf8");function dr(m){return ye([es],m)}var df=Buffer.from("locked_liquidity","utf8");var Nf=re("Raydium_cpmm"),ns={initialize:[175,175,109,31,13,152,155,237],deposit:[242,35,198,137,82,225,242,182],withdraw:[183,18,70,156,148,109,161,34],swapBaseInput:[143,190,90,218,196,30,51,222],swapBaseOutput:[55,217,98,86,163,74,180,173],lockCpLiquidity:[216,157,29,78,38,51,31,26],collectCpFee:[8,30,51,199,209,184,247,133]};function fr(m,e,t,n,i,s,r,o,u,a,c,p,l,d,y,f){let b=E([P("amountIn"),P("amounOutMin")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!0}],A=Buffer.alloc(b.span);return b.encode({amountIn:y,amounOutMin:f},A),new ts({keys:g,programId:m,data:Buffer.from([...ns.swapBaseInput,...A])})}import Yf from"bn.js";import Zf from"decimal.js-light";import is from"bn.js";var _f=new is(0);import br from"bn.js";var pb=new br(25),db=new br(1e4);var ui=E([D("instruction"),P("amountIn"),P("minAmountOut")]),ci=E([D("instruction"),P("maxAmountIn"),P("amountOut")]),gb=E([D("instruction"),D("nonce")]),rs=E([D("instruction"),D("nonce"),P("startTime")]),li=E([P("status"),P("nonce"),P("maxOrder"),P("depth"),P("baseDecimal"),P("quoteDecimal"),P("state"),P("resetFlag"),P("minSize"),P("volMaxCutRatio"),P("amountWaveRatio"),P("baseLotSize"),P("quoteLotSize"),P("minPriceMultiplier"),P("maxPriceMultiplier"),P("systemDecimalValue"),P("minSeparateNumerator"),P("minSeparateDenominator"),P("tradeFeeNumerator"),P("tradeFeeDenominator"),P("pnlNumerator"),P("pnlDenominator"),P("swapFeeNumerator"),P("swapFeeDenominator"),P("baseNeedTakePnl"),P("quoteNeedTakePnl"),P("quoteTotalPnl"),P("baseTotalPnl"),P("poolOpenTime"),P("punishPcAmount"),P("punishCoinAmount"),P("orderbookToInitTime"),q("swapBaseInAmount"),q("swapQuoteOutAmount"),P("swapBase2QuoteFee"),q("swapQuoteInAmount"),q("swapBaseOutAmount"),P("swapQuote2BaseFee"),C("baseVault"),C("quoteVault"),C("baseMint"),C("quoteMint"),C("lpMint"),C("openOrders"),C("marketId"),C("marketProgramId"),C("targetOrders"),C("withdrawQueue"),C("lpVault"),C("owner"),P("lpReserve"),Z(P(),3,"padding")]),Pb=E([P("accountType"),P("status"),P("nonce"),P("maxOrder"),P("depth"),P("baseDecimal"),P("quoteDecimal"),P("state"),P("resetFlag"),P("minSize"),P("volMaxCutRatio"),P("amountWaveRatio"),P("baseLotSize"),P("quoteLotSize"),P("minPriceMultiplier"),P("maxPriceMultiplier"),P("systemDecimalsValue"),P("abortTradeFactor"),P("priceTickMultiplier"),P("priceTick"),P("minSeparateNumerator"),P("minSeparateDenominator"),P("tradeFeeNumerator"),P("tradeFeeDenominator"),P("pnlNumerator"),P("pnlDenominator"),P("swapFeeNumerator"),P("swapFeeDenominator"),P("baseNeedTakePnl"),P("quoteNeedTakePnl"),P("quoteTotalPnl"),P("baseTotalPnl"),P("poolOpenTime"),P("punishPcAmount"),P("punishCoinAmount"),P("orderbookToInitTime"),q("swapBaseInAmount"),q("swapQuoteOutAmount"),q("swapQuoteInAmount"),q("swapBaseOutAmount"),P("swapQuote2BaseFee"),P("swapBase2QuoteFee"),C("baseVault"),C("quoteVault"),C("baseMint"),C("quoteMint"),C("lpMint"),C("modelDataAccount"),C("openOrders"),C("marketId"),C("marketProgramId"),C("targetOrders"),C("owner"),Z(P(),64,"padding")]),os=E([D("instruction"),P("baseAmountIn"),P("quoteAmountIn"),P("fixedSide"),P("otherAmountMin")]),ss=E([D("instruction"),P("lpAmount"),P("baseAmountMin"),P("quoteAmountMin")]);var kb=E([P("fee")]);import{PublicKey as Jy}from"@solana/web3.js";import eg from"bn.js";import Tn from"decimal.js";import{TOKEN_PROGRAM_ID as Is}from"@solana/spl-token";import{PublicKey as Tb,SystemProgram as hb,SYSVAR_RENT_PUBKEY as Bb,TransactionInstruction as gr}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Ib,TOKEN_PROGRAM_ID as Pr}from"@solana/spl-token";var yr=re("Raydium_liquidity_instruction");function as({poolKeys:m,userKeys:e,amountIn:t,minAmountOut:n,modelDataPubKey:i=sn},s){let r=ct(m),o=Buffer.alloc(ui.span);ui.encode({instruction:9,amountIn:oe(t),minAmountOut:oe(n)},o);let u=[S({pubkey:Pr,isWritable:!1}),S({pubkey:r.id}),S({pubkey:r.authority,isWritable:!1}),S({pubkey:r.openOrders})];return s===4&&u.push(S({pubkey:r.targetOrders})),u.push(S({pubkey:r.vault.A}),S({pubkey:r.vault.B})),s===5&&u.push(S({pubkey:i})),u.push(S({pubkey:r.marketProgramId,isWritable:!1}),S({pubkey:r.marketId}),S({pubkey:r.marketBids}),S({pubkey:r.marketAsks}),S({pubkey:r.marketEventQueue}),S({pubkey:r.marketBaseVault}),S({pubkey:r.marketQuoteVault}),S({pubkey:r.marketAuthority,isWritable:!1}),S({pubkey:e.tokenAccountIn}),S({pubkey:e.tokenAccountOut}),S({pubkey:e.owner,isWritable:!1,isSigner:!0})),new gr({programId:r.programId,keys:u,data:o})}function us({poolKeys:m,userKeys:e,maxAmountIn:t,amountOut:n,modelDataPubKey:i=sn},s){let r=ct(m),o=Buffer.alloc(ci.span);ci.encode({instruction:11,maxAmountIn:oe(t),amountOut:oe(n)},o);let u=[S({pubkey:Pr,isWritable:!1}),S({pubkey:r.id}),S({pubkey:r.authority,isWritable:!1}),S({pubkey:r.openOrders}),S({pubkey:r.targetOrders}),S({pubkey:r.vault.A}),S({pubkey:r.vault.B})];return s===5&&u.push(S({pubkey:i})),u.push(S({pubkey:r.marketProgramId,isWritable:!1}),S({pubkey:r.marketId}),S({pubkey:r.marketBids}),S({pubkey:r.marketAsks}),S({pubkey:r.marketEventQueue}),S({pubkey:r.marketBaseVault}),S({pubkey:r.marketQuoteVault}),S({pubkey:r.marketAuthority,isWritable:!1}),S({pubkey:e.tokenAccountIn}),S({pubkey:e.tokenAccountOut}),S({pubkey:e.owner,isWritable:!1,isSigner:!0})),new gr({programId:r.programId,keys:u,data:o})}function kr(m){let{poolKeys:e,version:t,userKeys:n,amountIn:i,amountOut:s,fixedSide:r}=m;if(t===4||t===5){let o={poolKeys:e,userKeys:n};if(r==="in")return as(X(W({},o),{amountIn:i,minAmountOut:s}),t);if(r==="out")return us(X(W({},o),{maxAmountIn:i,amountOut:s}),t);yr.logWithError("invalid params","params",m)}throw yr.logWithError("invalid version","poolKeys.version",t),new Error("invalid version")}import{PublicKey as Wb}from"@solana/web3.js";var vb=re("Raydium_liquidity_serum");var cs=5e4,ls=E([P("x"),P("y"),P("price")]),Ub=E([P("accountType"),P("status"),P("multiplier"),P("validDataCount"),Z(ls,cs,"DataElement")]);var Qt=E([C("mint"),C("owner"),P("amount"),Ke("delegateOption"),C("delegate"),D("state"),Ke("isNativeOption"),P("isNative"),P("delegatedAmount"),Ke("closeAuthorityOption"),C("closeAuthority")]);import{Keypair as bs,PublicKey as ys}from"@solana/web3.js";import ly from"bn.js";import{TOKEN_PROGRAM_ID as gs}from"@solana/spl-token";function ms(m){return m instanceof Uint8Array||m!=null&&typeof m=="object"&&m.constructor.name==="Uint8Array"}function mi(m,...e){if(!ms(m))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(m.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${m.length}`)}function pi(m,e=!0){if(m.destroyed)throw new Error("Hash instance has been destroyed");if(e&&m.finished)throw new Error("Hash#digest() has already been called")}function Ar(m,e){mi(m);let t=e.outputLen;if(m.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var An=m=>new DataView(m.buffer,m.byteOffset,m.byteLength),Ve=(m,e)=>m<<32-e|m>>>e;var jb=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function ps(m){if(typeof m!="string")throw new Error(`utf8ToBytes expected string, got ${typeof m}`);return new Uint8Array(new TextEncoder().encode(m))}function di(m){return typeof m=="string"&&(m=ps(m)),mi(m),m}var kn=class{clone(){return this._cloneInto()}},Zb={}.toString;function wr(m){let e=n=>m().update(di(n)).digest(),t=m();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>m(),e}function ds(m,e,t,n){if(typeof m.setBigUint64=="function")return m.setBigUint64(e,t,n);let i=BigInt(32),s=BigInt(4294967295),r=Number(t>>i&s),o=Number(t&s),u=n?4:0,a=n?0:4;m.setUint32(e+u,r,n),m.setUint32(e+a,o,n)}var Tr=(m,e,t)=>m&e^~m&t,hr=(m,e,t)=>m&e^m&t^e&t,wn=class extends kn{constructor(e,t,n,i){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=i,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=An(this.buffer)}update(e){pi(this);let{view:t,buffer:n,blockLen:i}=this;e=di(e);let s=e.length;for(let r=0;r<s;){let o=Math.min(i-this.pos,s-r);if(o===i){let u=An(e);for(;i<=s-r;r+=i)this.process(u,r);continue}n.set(e.subarray(r,r+o),this.pos),this.pos+=o,r+=o,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){pi(this),Ar(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:i,isLE:s}=this,{pos:r}=this;t[r++]=128,this.buffer.subarray(r).fill(0),this.padOffset>i-r&&(this.process(n,0),r=0);for(let p=r;p<i;p++)t[p]=0;ds(n,i-8,BigInt(this.length*8),s),this.process(n,0);let o=An(e),u=this.outputLen;if(u%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let a=u/4,c=this.get();if(a>c.length)throw new Error("_sha2: outputLen bigger than state");for(let p=0;p<a;p++)o.setUint32(4*p,c[p],s)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:i,finished:s,destroyed:r,pos:o}=this;return e.length=i,e.pos=o,e.finished=s,e.destroyed=r,i%t&&e.buffer.set(n),e}};var fs=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),rt=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),ot=new Uint32Array(64),fi=class extends wn{constructor(){super(64,32,8,!1),this.A=rt[0]|0,this.B=rt[1]|0,this.C=rt[2]|0,this.D=rt[3]|0,this.E=rt[4]|0,this.F=rt[5]|0,this.G=rt[6]|0,this.H=rt[7]|0}get(){let{A:e,B:t,C:n,D:i,E:s,F:r,G:o,H:u}=this;return[e,t,n,i,s,r,o,u]}set(e,t,n,i,s,r,o,u){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=s|0,this.F=r|0,this.G=o|0,this.H=u|0}process(e,t){for(let p=0;p<16;p++,t+=4)ot[p]=e.getUint32(t,!1);for(let p=16;p<64;p++){let l=ot[p-15],d=ot[p-2],y=Ve(l,7)^Ve(l,18)^l>>>3,f=Ve(d,17)^Ve(d,19)^d>>>10;ot[p]=f+ot[p-7]+y+ot[p-16]|0}let{A:n,B:i,C:s,D:r,E:o,F:u,G:a,H:c}=this;for(let p=0;p<64;p++){let l=Ve(o,6)^Ve(o,11)^Ve(o,25),d=c+l+Tr(o,u,a)+fs[p]+ot[p]|0,f=(Ve(n,2)^Ve(n,13)^Ve(n,22))+hr(n,i,s)|0;c=a,a=u,u=o,o=r+d|0,r=s,s=i,i=n,n=d+f|0}n=n+this.A|0,i=i+this.B|0,s=s+this.C|0,r=r+this.D|0,o=o+this.E|0,u=u+this.F|0,a=a+this.G|0,c=c+this.H|0,this.set(n,i,s,r,o,u,a,c)}roundClean(){ot.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var Br=wr(()=>new fi);var by=re("Raydium_Util");function xr({fromPublicKey:m,programId:e=gs,assignSeed:t}){let n=t?btoa(t).slice(0,32):bs.generate().publicKey.toBase58().slice(0,32);return{publicKey:Ps(m,n,e),seed:n}}function Ps(m,e,t){let n=Buffer.concat([m.toBuffer(),Buffer.from(e),t.toBuffer()]),i=Br(n);return new ys(i)}import{PublicKey as ks,SystemProgram as As}from"@solana/web3.js";import ws from"bn.js";import{createCloseAccountInstruction as Ts,createInitializeAccountInstruction as hs,createTransferInstruction as Iy,TOKEN_PROGRAM_ID as Ht}from"@solana/spl-token";function Bs(m){let{mint:e,tokenAccount:t,owner:n,programId:i=Ht}=m;return hs(t,e,n,i)}function Yt(m){let{tokenAccount:e,payer:t,multiSigners:n=[],owner:i,programId:s=Ht}=m;return Ts(e,t,i,n,s)}async function Ir(m){let{connection:e,amount:t,commitment:n,payer:i,owner:s,skipCloseAccount:r}=m,o=await e.getMinimumBalanceForRentExemption(Qt.span,n),u=oe(t).add(new ws(o)),a=xr({fromPublicKey:i,programId:Ht});return{addresses:{newAccount:a.publicKey},signers:[],instructions:[As.createAccountWithSeed({fromPubkey:i,basePubkey:i,seed:a.seed,newAccountPubkey:a.publicKey,lamports:u.toNumber(),space:Qt.span,programId:Ht}),Bs({mint:new ks(qe.address),tokenAccount:a.publicKey,owner:s,programId:Ht})],instructionTypes:[Y.CreateAccount,Y.InitAccount],endInstructionTypes:r?[]:[Y.CloseAccount],endInstructions:r?[]:[Yt({tokenAccount:a.publicKey,payer:i,owner:s})]}}var xs=E([Ke("mintAuthorityOption"),C("mintAuthority"),P("supply"),D("decimals"),D("isInitialized"),Ke("freezeAuthorityOption"),C("freezeAuthority")]);function Ss({programId:m}){let{publicKey:e}=ye([Buffer.from("amm_config_account_seed","utf-8")],m);return e}function Sr({programId:m}){return ye([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],m)}var bi={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]},Kr=m=>{let e={},t=Is.toBase58();return Object.keys(m).map(n=>{let i=m[n],[s,r]=[i.baseMint.toBase58(),i.quoteMint.toBase58()];e[n]={id:n,version:4,status:i.status.toNumber(),programId:i.programId.toBase58(),mintA:pt({address:s,programId:t,decimals:i.baseDecimal.toNumber()}),mintB:pt({address:r,programId:t,decimals:i.quoteDecimal.toNumber()}),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:i.poolPrice.toNumber(),mintAmountA:new Tn(i.mintAAmount.toString()).div(10**i.baseDecimal.toNumber()).toNumber(),mintAmountB:new Tn(i.mintBAmount.toString()).div(10**i.quoteDecimal.toNumber()).toNumber(),baseReserve:i.baseReserve,quoteReserve:i.quoteReserve,feeRate:new Tn(i.tradeFeeNumerator.toString()).div(i.tradeFeeDenominator.toString()).toNumber(),openTime:i.poolOpenTime.toString(),tvl:0,day:bi,week:bi,month:bi,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,type:"Standard",marketId:i.marketId.toBase58(),configId:Ss({programId:i.programId}).toBase58(),lpPrice:0,lpAmount:new Tn(i.lpReserve.toString()).div(10**Math.min(i.baseDecimal.toNumber(),i.quoteDecimal.toNumber())).toNumber(),lpMint:pt({address:i.lpMint.toBase58(),programId:t,decimals:Math.min(i.baseDecimal.toNumber(),i.quoteDecimal.toNumber())}),burnPercent:0}}),e};var Cr={[vn.toBase58()]:3},Lr={3:vn};var yi=E([ge(5),ge(8),C("ownAddress"),P("vaultSignerNonce"),C("baseMint"),C("quoteMint"),C("baseVault"),P("baseDepositsTotal"),P("baseFeesAccrued"),C("quoteVault"),P("quoteDepositsTotal"),P("quoteFeesAccrued"),P("quoteDustThreshold"),C("requestQueue"),C("eventQueue"),C("bids"),C("asks"),P("baseLotSize"),P("quoteLotSize"),P("feeRateBps"),P("referrerRebatesAccrued"),ge(7)]),Rr={3:yi};import{PublicKey as Nr}from"@solana/web3.js";var hn=re("Serum"),Bn=class{static getProgramId(e){let t=Lr[e];return t||hn.logWithError("invalid version","version",e),t}static getVersion(e){let t=e.toBase58(),n=Cr[t];return n||hn.logWithError("invalid program id","programId",t),n}static getStateLayout(e){let t=Rr[e];return t||hn.logWithError(!!t,"invalid version","version",e),t}static getLayouts(e){return{state:this.getStateLayout(e)}}static getAssociatedAuthority({programId:e,marketId:t}){let n=[t.toBuffer()],i=0,s;for(;i<100;){try{let r=n.concat(Buffer.from([i]),Buffer.alloc(7));s=Nr.createProgramAddressSync(r,e)}catch(r){if(r instanceof TypeError)throw r;i++;continue}return{publicKey:s,nonce:i}}return hn.logWithError("unable to find a viable program address nonce","params",{programId:e,marketId:t}),{publicKey:Nr.default,nonce:i}}};import{PublicKey as v,SystemProgram as Ks,TransactionInstruction as Cs}from"@solana/web3.js";import gt from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Ls,TOKEN_2022_PROGRAM_ID as Rs,TOKEN_PROGRAM_ID as Ns}from"@solana/spl-token";function Os(m,e,t,n,i,s,r,o,u,a,c,p,l,d,y){var k;let f=[],b=[S({pubkey:Ns,isWritable:!1}),S({pubkey:Rs,isWritable:!1}),S({pubkey:Ls,isWritable:!1}),S({pubkey:Ks.programId,isWritable:!1}),S({pubkey:e,isSigner:!0})];b.push(S({pubkey:t})),b.push(S({pubkey:i}));let g=[u,a],A=[c,p],h=[s,r,o];for(let x=0;x<g.length;x++){let I=g[x],N=h[x]===I.mintA.address;if(b.push(S({pubkey:new v(I.programId),isWritable:!1})),x===g.length-1?b.push(S({pubkey:i})):b.push(S({pubkey:n})),b.push(S({pubkey:new v(h[x])})),b.push(S({pubkey:new v(h[x+1])})),I.version===6){let w=A[x];b.push(S({pubkey:new v(w.config.id)})),b.push(S({pubkey:new v(w.id)})),b.push(S({pubkey:new v(N?w.vault.A:w.vault.B)})),b.push(S({pubkey:new v(N?w.vault.B:w.vault.A)})),b.push(S({pubkey:new v(I.observationId)})),b.push(S({pubkey:kt})),b.push(S({pubkey:Pe(new v(I.programId),new v(I.id)).publicKey})),f.push(Ms(I.sqrtPriceX64.toString(),N));for(let O of(k=y[x])!=null?k:[])b.push(S({pubkey:new v(O)}))}else if(I.version===5){let w=A[x];b.push(S({pubkey:new v(w.id)})),b.push(S({pubkey:new v(w.authority),isWritable:!1})),b.push(S({pubkey:new v(w.marketProgramId)})),b.push(S({pubkey:new v(w.marketAuthority)})),b.push(S({pubkey:_i,isWritable:!1})),b.push(S({pubkey:new v(w.openOrders)})),b.push(S({pubkey:new v(w.vault.A)})),b.push(S({pubkey:new v(w.vault.B)})),b.push(S({pubkey:new v(w.id)})),b.push(S({pubkey:new v(w.id)})),b.push(S({pubkey:new v(w.id)})),b.push(S({pubkey:new v(w.id)})),b.push(S({pubkey:new v(w.id)})),b.push(S({pubkey:new v(w.id)})),b.push(S({pubkey:new v(w.marketId)})),b.push(S({pubkey:new v(w.marketBids)})),b.push(S({pubkey:new v(w.marketAsks)})),b.push(S({pubkey:new v(w.marketEventQueue)})),b.push(S({pubkey:new v(w.marketBaseVault)})),b.push(S({pubkey:new v(w.marketQuoteVault)}))}else if(I.version===4){let w=A[x],O=I.status!==1;b.push(S({pubkey:new v(w.id)})),b.push(S({pubkey:new v(w.authority),isWritable:!1})),b.push(S({pubkey:new v(O?w.id:w.marketProgramId)})),b.push(S({pubkey:new v(O?w.id:w.marketAuthority)})),b.push(S({pubkey:new v(O?w.id:w.openOrders)})),b.push(S({pubkey:new v(w.vault.A)})),b.push(S({pubkey:new v(w.vault.B)})),b.push(S({pubkey:new v(O?w.id:w.marketId)})),b.push(S({pubkey:new v(O?w.id:w.marketBids)})),b.push(S({pubkey:new v(O?w.id:w.marketAsks)})),b.push(S({pubkey:new v(O?w.id:w.marketEventQueue)})),b.push(S({pubkey:new v(O?w.id:w.marketBaseVault)})),b.push(S({pubkey:new v(O?w.id:w.marketQuoteVault)}))}else if(I.version===7){let w=A[x];b.push(S({pubkey:new v(w.authority)})),b.push(S({pubkey:new v(w.config.id)})),b.push(S({pubkey:new v(w.id)})),b.push(S({pubkey:new v(N?w.vault.A:w.vault.B)})),b.push(S({pubkey:new v(N?w.vault.B:w.vault.A)})),b.push(S({pubkey:new v(I.observationId)}))}else throw Error("pool type error")}let B=E([D("insId"),P("amountIn"),P("amountOut"),Z(q(),f.length,"clmmPriceLimit")]),T=Buffer.alloc(B.span);return B.encode({insId:0,amountIn:l,amountOut:d,clmmPriceLimit:f},T),new Cs({keys:b,programId:m,data:T})}function Ms(m,e){if(m)if(e){let t=new gt(m).div(new gt(25));return t.gt(dn)?t:dn}else{let t=new gt(m).mul(new gt(25));return t.lt(fn)?t:fn}else return e?dn:fn}function Or({routeProgram:m,ownerInfo:e,inputMint:t,swapInfo:n}){var i,s,r,o,u,a,c;if(n.routeType==="amm")if(n.poolInfo[0].version===6){let p=n.poolKey[0],l=ct(p),d=t.equals(l.mintA.address)?Ue.add(Ce):Xe.sub(Ce);return yt.makeSwapBaseInInstructions({poolInfo:p,poolKeys:p,observationId:n.poolInfo[0].observationId,ownerInfo:{wallet:e.wallet,tokenAccountA:l.mintA.address.equals(t)?e.sourceToken:e.destinationToken,tokenAccountB:l.mintA.address.equals(t)?e.destinationToken:e.sourceToken},inputMint:t,amountIn:n.amountIn.amount.raw,amountOutMin:n.minAmountOut.amount.raw.sub((s=(i=n.minAmountOut.fee)==null?void 0:i.raw)!=null?s:new gt(0)),sqrtPriceLimitX64:d,remainingAccounts:(r=n.remainingAccounts[0])!=null?r:[]})}else if(n.poolInfo[0].version===7){let p=n.poolInfo[0],l=t.toString()===n.poolInfo[0].mintA.address;return{signers:[],instructions:[fr(p.programId,e.wallet,p.authority,p.configId,p.id,e.sourceToken,e.destinationToken,l?p.vaultA:p.vaultB,l?p.vaultB:p.vaultA,l?p.mintProgramA:p.mintProgramB,l?p.mintProgramB:p.mintProgramA,new v(p[l?"mintA":"mintB"].address),new v(p[l?"mintB":"mintA"].address),p.observationId,n.amountIn.amount.raw,n.minAmountOut.amount.raw)],lookupTableAddress:[],instructionTypes:[l?Y.CpmmSwapBaseIn:Y.CpmmSwapBaseOut],address:{}}}else{let p=n.poolKey[0];return{signers:[],instructions:[kr({poolKeys:p,version:n.poolInfo[0].pooltype.includes("StablePool")?5:4,userKeys:{tokenAccountIn:e.sourceToken,tokenAccountOut:e.destinationToken,owner:e.wallet},amountIn:n.amountIn.amount.raw,amountOut:n.minAmountOut.amount.raw.sub((u=(o=n.minAmountOut.fee)==null?void 0:o.raw)!=null?u:new gt(0)),fixedSide:"in"})],lookupTableAddress:p.lookupTableAccount?[p.lookupTableAccount]:[],instructionTypes:[n.poolInfo[0].pooltype.includes("StablePool")?Y.AmmV5SwapBaseIn:Y.AmmV4SwapBaseIn],address:{}}}else if(n.routeType==="route"){let p=n.poolInfo[0],l=n.poolInfo[1],d=n.poolKey[0],y=n.poolKey[1];if(e.routeToken===void 0)throw Error("owner route token account check error");return{signers:[],instructions:[Os(m,e.wallet,e.sourceToken,e.routeToken,e.destinationToken,t.toString(),n.middleToken.mint.toString(),n.outputMint.toString(),p,l,d,y,n.amountIn.amount.raw,n.minAmountOut.amount.raw.sub((c=(a=n.minAmountOut.fee)==null?void 0:a.raw)!=null?c:new gt(0)),n.remainingAccounts)],instructionTypes:[Y.RouteSwap],lookupTableAddress:[d.lookupTableAccount,y.lookupTableAccount].filter(f=>f!==void 0),address:{}}}else throw Error("route type error")}var tt=new In(0),gi=class extends xt{constructor(e){super(e)}async getWSolAccounts(){this.scope.checkOwner(),await this.scope.account.fetchWalletTokenAccounts();let e=this.scope.account.tokenAccounts.filter(t=>t.mint.equals(Fe));return e.sort((t,n)=>t.isAssociated?1:n.isAssociated||t.amount.lt(n.amount)?-1:1),e}async unWrapWSol(e){let{amount:t,tokenProgram:n,txVersion:i=1,feePayer:s}=e,r=await this.getWSolAccounts(),o=this.createTxBuilder(s);o.addCustomComputeBudget(e.computeBudgetConfig);let u=oe(t);for(let a=0;a<r.length;a++)u.gte(r[a].amount)?(o.addInstruction({instructions:[Yt({tokenAccount:r[a].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),u.sub(r[a].amount)):o.addInstruction({instructions:[Yt({tokenAccount:r[a].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]});return o.versionBuild({txVersion:i})}async wrapWSol(e,t,n,i){let s=this.createTxBuilder(i),r=await Ir({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:e,skipCloseAccount:!0});return s.addInstruction(r),s.versionBuild({txVersion:n!=null?n:1})}async swap({swapInfo:e,swapPoolKeys:t,ownerInfo:n,computeBudgetConfig:i,routeProgram:s,txVersion:r,feePayer:o}){let u=this.createTxBuilder(o),a=e.amountIn,c=e.amountOut,p=a.amount.token.mint.equals(Fe),l=c.amount.token.mint.equals(Fe),d=a.amount.token.mint,y=c.amount.token.mint,{account:f,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:a.amount.token.isToken2022?xn:be,mint:d,notUseTokenAccount:p,owner:this.scope.ownerPubKey,skipCloseAccount:!p,createInfo:p?{payer:this.scope.ownerPubKey,amount:a.amount.raw}:void 0,associatedOnly:p?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});if(b&&u.addInstruction(b),f===void 0)throw Error("input account check error");let g;if(e.routeType==="route"&&!l)g=this.scope.account.getAssociatedTokenAccount(y,c.amount.token.isToken2022?xn:be);else{let{account:T,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:c.amount.token.isToken2022?xn:be,mint:y,notUseTokenAccount:l,owner:this.scope.ownerPubKey,skipCloseAccount:!0,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:l?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});g=T,k&&u.addInstruction(k)}l&&u.addInstruction({endInstructions:[Yt({owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,tokenAccount:g,programId:be})],endInstructionTypes:[Y.CloseAccount]});let A;if(e.routeType==="route"){let T=e.middleToken;A=this.scope.account.getAssociatedTokenAccount(T.mint,T.isToken2022?xn:be)}let h=t||await this.computePoolToPoolKeys({pools:e.poolInfoList}),B=Or({routeProgram:s,inputMint:d,swapInfo:X(W({},e),{poolInfo:[...e.poolInfoList],poolKey:h,outputMint:y}),ownerInfo:{wallet:this.scope.ownerPubKey,sourceToken:f,routeToken:A,destinationToken:g}});if(e.feeConfig!==void 0){let T=this.createTxBuilder();T.addInstruction({instructions:[Mr(f,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[Y.TransferAmount]}),T.addInstruction(B);let{transactions:k}=r===0?await T.sizeCheckBuildV0():await T.sizeCheckBuild();k.length<2&&u.addInstruction({instructions:[Mr(f,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[Y.TransferAmount]})}return u.addInstruction(B),r===0?u.sizeCheckBuildV0({computeBudgetConfig:i,address:B.address}):u.sizeCheckBuild({computeBudgetConfig:i,address:B.address})}async fetchRoutePoolBasicInfo(e){let{amm:t=Wi,clmm:n=Dn,cpmm:i=qn}=e||{},s=await this.scope.connection.getProgramAccounts(t,{dataSlice:{offset:li.offsetOf("baseMint"),length:64}}),r=E([C("baseMint"),C("quoteMint")]),o=s.map(d=>({id:d.pubkey,version:4,mintA:r.decode(d.account.data).baseMint,mintB:r.decode(d.account.data).quoteMint})),u=E([C("mintA"),C("mintB")]),c=(await this.scope.connection.getProgramAccounts(n,{filters:[{dataSize:St.span}],dataSlice:{offset:St.offsetOf("mintA"),length:64}})).map(d=>{let y=u.decode(d.account.data);return{id:d.pubkey,version:6,mintA:y.mintA,mintB:y.mintB}}),l=(await this.scope.connection.getProgramAccounts(i,{dataSlice:{offset:pr.offsetOf("mintA"),length:64}})).map(d=>{let y=u.decode(d.account.data);return{id:d.pubkey,version:7,mintA:y.mintA,mintB:y.mintB}});return{clmmPools:c,ammPools:o,cpmmPools:l}}getAllRoute({inputMint:e,outputMint:t,clmmPools:n,ammPools:i,cpmmPools:s}){e=e.toString()===Pt.default.toString()?Fe:e,t=t.toString()===Pt.default.toString()?Fe:t;let r={},o={},u={},a=[],c={};for(let l of n!=null?n:[]){if((l.mintA.equals(e)&&l.mintB.equals(t)||l.mintA.equals(t)&&l.mintB.equals(e))&&(a.push(l),o[l.id.toString()]=l),l.mintA.equals(e)){let d=l.mintB.toString();c[d]===void 0&&(c[d]={mintProgram:be,in:[],out:[],mDecimals:0}),c[d].in.push(l)}if(l.mintB.equals(e)){let d=l.mintA.toString();c[d]===void 0&&(c[d]={mintProgram:be,in:[],out:[],mDecimals:0}),c[d].in.push(l)}if(l.mintA.equals(t)){let d=l.mintB.toString();c[d]===void 0&&(c[d]={mintProgram:be,in:[],out:[],mDecimals:0}),c[d].out.push(l)}if(l.mintB.equals(t)){let d=l.mintA.toString();c[d]===void 0&&(c[d]={mintProgram:be,in:[],out:[],mDecimals:0}),c[d].out.push(l)}}let p=[];for(let l of i)(l.mintA.equals(e)&&l.mintB.equals(t)||l.mintA.equals(t)&&l.mintB.equals(e))&&(a.push(l),r[l.id.toBase58()]=l,p.push(l)),l.mintA.equals(e)&&(c[l.mintB.toBase58()]===void 0&&(c[l.mintB.toBase58()]={mintProgram:be,in:[],out:[],mDecimals:0}),c[l.mintB.toBase58()].in.push(l)),l.mintB.equals(e)&&(c[l.mintA.toBase58()]===void 0&&(c[l.mintA.toBase58()]={mintProgram:be,in:[],out:[],mDecimals:0}),c[l.mintA.toBase58()].in.push(l)),l.mintA.equals(t)&&(c[l.mintB.toBase58()]===void 0&&(c[l.mintB.toBase58()]={mintProgram:be,in:[],out:[],mDecimals:0}),c[l.mintB.toBase58()].out.push(l)),l.mintB.equals(t)&&(c[l.mintA.toBase58()]===void 0&&(c[l.mintA.toBase58()]={mintProgram:be,in:[],out:[],mDecimals:0}),c[l.mintA.toBase58()].out.push(l));for(let l of s)(l.mintA.equals(e)&&l.mintB.equals(t)||l.mintA.equals(t)&&l.mintB.equals(e))&&(a.push(l),u[l.id.toBase58()]=l),l.mintA.equals(e)&&(c[l.mintB.toBase58()]===void 0&&(c[l.mintB.toBase58()]={mintProgram:be,in:[],out:[],mDecimals:0}),c[l.mintB.toBase58()].in.push(l)),l.mintB.equals(e)&&(c[l.mintA.toBase58()]===void 0&&(c[l.mintA.toBase58()]={mintProgram:be,in:[],out:[],mDecimals:0}),c[l.mintA.toBase58()].in.push(l)),l.mintA.equals(t)&&(c[l.mintB.toBase58()]===void 0&&(c[l.mintB.toBase58()]={mintProgram:be,in:[],out:[],mDecimals:0}),c[l.mintB.toBase58()].out.push(l)),l.mintB.equals(t)&&(c[l.mintA.toBase58()]===void 0&&(c[l.mintA.toBase58()]={mintProgram:be,in:[],out:[],mDecimals:0}),c[l.mintA.toBase58()].out.push(l));for(let l of Object.keys(c)){if(c[l].in.length===1&&c[l].out.length===1&&c[l].in[0].id.equals(c[l].out[0].id)){delete c[l];continue}if(c[l].in.length===0||c[l].out.length===0){delete c[l];continue}let d=c[l];for(let y of d.in)for(let f of d.out)y.version===6&&o[y.id.toString()]===void 0?o[y.id.toString()]=y:y.version===7&&u[y.id.toString()]===void 0?u[y.id.toString()]=y:(y.version===4||y.version===5)&&r[y.id.toString()]===void 0&&(r[y.id.toString()]=y),f.version===6&&o[f.id.toString()]===void 0?o[f.id.toString()]=f:f.version===7&&u[f.id.toString()]===void 0?u[f.id.toString()]=f:(f.version===4||f.version===5)&&r[f.id.toString()]===void 0&&(r[f.id.toString()]=f)}return{directPath:a,addLiquidityPools:p,routePathDict:c,needSimulate:Object.values(r),needTickArray:Object.values(o),cpmmPoolList:Object.values(u)}}async fetchSwapRoutesData({routes:e,inputMint:t,outputMint:n}){let i=new Set([...e.needTickArray.map(f=>[f.mintA.toBase58(),f.mintB.toBase58()]).flat(),t.toString(),n.toString()]);console.log("fetching amm pools info, total: ",e.needSimulate.length);let s=await this.scope.liquidity.getRpcPoolInfos(e.needSimulate.map(f=>f.id)),r=Kr(s),o={};Object.values(r).forEach(f=>{i.delete(f.mintA.address),o[f.mintA.address]={address:new Pt(f.mintA.address),programId:be,mintAuthority:null,supply:BigInt(0),decimals:f.mintA.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0},i.delete(f.mintB.address),o[f.mintB.address]={address:new Pt(f.mintB.address),programId:be,mintAuthority:null,supply:BigInt(0),decimals:f.mintB.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}}),console.log("fetching cpmm pools info, total: ",e.cpmmPoolList.length);let u=await this.scope.cpmm.getRpcPoolInfos(e.cpmmPoolList.map(f=>f.id.toBase58()),!0);Object.values(u).forEach(f=>{let[b,g]=[f.mintA.toBase58(),f.mintB.toBase58()];f.mintProgramA.equals(be)?(i.delete(b),o[b]={address:f.mintA,programId:f.mintProgramA,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalA,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):i.add(b),f.mintProgramB.equals(be)?(i.delete(g),o[g]={address:f.mintB,programId:f.mintProgramB,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalB,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):i.add(g)}),console.log("fetching mints info, total: ",i.size);let a=await Ln({connection:this.scope.connection,mints:Array.from(i).map(f=>new Pt(f))});o=W(W({},o),a);let c=this.scope.cpmm.toComputePoolInfos({pools:u,mintInfos:o});console.log("fetching clmm pools info, total:",e.needTickArray.length);let p=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:e.needTickArray.map(f=>f.id)}),{computeClmmPoolInfo:l,computePoolTickData:d}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:p,mintInfos:o}),y=Object.keys(e.routePathDict).reduce((f,b)=>X(W({},f),{[b]:X(W({},e.routePathDict[b]),{mintProgram:o[b].programId,mDecimals:o[b].decimals,in:e.routePathDict[b].in.map(g=>r[g.id.toBase58()]||l[g.id.toBase58()]||c[g.id.toBase58()]),out:e.routePathDict[b].out.map(g=>r[g.id.toBase58()]||l[g.id.toBase58()]||c[g.id.toBase58()])})}),{});return{mintInfos:o,ammPoolsRpcInfo:s,ammSimulateCache:r,clmmPoolsRpcInfo:p,computeClmmPoolInfo:l,computePoolTickData:d,computeCpmmData:c,routePathDict:y}}getAllRouteComputeAmountOut({inputTokenAmount:e,outputToken:t,directPath:n,routePathDict:i,simulateCache:s,tickCache:r,slippage:o,chainTime:u,epochInfo:a,feeConfig:c}){var g,A,h,B,T,k,x,I,N;let p=c===void 0?new In(0):e.raw.mul(new In(c.feeBps.toNumber())).div(new In(1e4)),l=e.raw.sub(p),d=new se(e.token,l),y=c===void 0?void 0:{feeAmount:p,feeAccount:c.feeAccount},f=X(W({},t),{address:De(t.address).toString()}),b=[];for(let w of n)try{b.push(X(W({},this.computeAmountOut({itemPool:w,tickCache:r,simulateCache:s,chainTime:u,epochInfo:a,slippage:o,outputToken:f,amountIn:d})),{feeConfig:y}))}catch(O){this.logDebug("direct error",w.version,w.id.toString(),O.message)}this.logDebug("direct done");for(let[w,O]of Object.entries(i)){let V={chainId:101,address:w,programId:O.mintProgram.toBase58(),logoURI:"",symbol:"",name:"",decimals:O.mDecimals,tags:[],extensions:{}},M=O.in.map(j=>{try{return{pool:j,data:this.computeAmountOut({itemPool:j,tickCache:r,simulateCache:s,chainTime:u,epochInfo:a,slippage:o,outputToken:V,amountIn:d})}}catch(U){this.logDebug("route in error",j.version,j.id.toString(),U.message);return}}).sort((j,U)=>{var st,Ct,ve,Me;let Oe=j===void 0?tt:j.data.amountOut.amount.raw.sub((Ct=(st=j.data.amountOut.fee)==null?void 0:st.raw)!=null?Ct:tt),nt=U===void 0?tt:U.data.amountOut.amount.raw.sub((Me=(ve=U.data.amountOut.fee)==null?void 0:ve.raw)!=null?Me:tt);return Oe.lt(nt)?1:-1})[0];if(M===void 0)continue;let H=new se(Qi(V),M.data.amountOut.amount.raw.sub((A=(g=M.data.amountOut.fee)==null?void 0:g.raw)!=null?A:tt));for(let j of O.out)try{let U=this.computeAmountOut({itemPool:j,tickCache:r,simulateCache:s,chainTime:u,epochInfo:a,slippage:o,outputToken:f,amountIn:H});b.push(X(W({},U),{allTrade:!!(M.data.allTrade&&U.allTrade),amountIn:M.data.amountIn,amountOut:U.amountOut,minAmountOut:U.minAmountOut,currentPrice:void 0,executionPrice:new jt(new xe({baseToken:M.data.amountIn.amount.token,denominator:M.data.amountIn.amount.raw,quoteToken:U.amountOut.amount.token,numerator:U.amountOut.amount.raw.sub((B=(h=U.amountOut.fee)==null?void 0:h.raw)!=null?B:tt)}).toFixed()),priceImpact:new jt(M.data.priceImpact.add(U.priceImpact).toFixed()),fee:[M.data.fee[0],U.fee[0]],routeType:"route",poolInfoList:[M.pool,j],remainingAccounts:[M.data.remainingAccounts[0],U.remainingAccounts[0]],minMiddleAmountFee:(T=U.amountOut.fee)!=null&&T.raw?new se(M.data.amountOut.amount.token,((x=(k=M.data.amountOut.fee)==null?void 0:k.raw)!=null?x:tt).add((N=(I=U.amountOut.fee)==null?void 0:I.raw)!=null?N:tt)):void 0,middleToken:M.data.amountOut.amount.token,poolReady:M.data.poolReady&&U.poolReady,poolType:[M.data.poolType,U.poolType],feeConfig:y,expirationTime:_e(M.data.expirationTime,U.expirationTime)}))}catch(U){this.logDebug("route out error",j.version,j.id.toString(),U.message)}}return b.filter(w=>(w.allTrade||this.logDebug(`pool ${w.poolInfoList.map(O=>O.id.toString()).join(",")} filter out since not all trade`),w.allTrade)).sort((w,O)=>w.amountOut.amount.raw.sub(O.amountOut.amount.raw).gt(tt)?-1:1)}computeAmountOut({itemPool:e,tickCache:t,simulateCache:n,chainTime:i,epochInfo:s,slippage:r,outputToken:o,amountIn:u}){if(e.version===6){let{allTrade:a,realAmountIn:c,amountOut:p,minAmountOut:l,expirationTime:d,currentPrice:y,executionPrice:f,priceImpact:b,fee:g,remainingAccounts:A,executionPriceX64:h}=pe.computeAmountOutFormat({poolInfo:e,tickArrayCache:t[e.id.toString()],amountIn:u.raw,tokenOut:o,slippage:r,epochInfo:s,catchLiquidityInsufficient:!0});return{allTrade:a,amountIn:c,amountOut:p,minAmountOut:l,currentPrice:new jt(y.toFixed()),executionPrice:new jt(f.toFixed()),priceImpact:new jt(b.toFixed()),fee:[g],remainingAccounts:[A],routeType:"amm",poolInfoList:[e],poolReady:e.startTime<i,poolType:"CLMM",slippage:r,clmmExPriceX64:[h],expirationTime:_e(c.expirationTime,d)}}else if(e.version===7){let{allTrade:a,executionPrice:c,amountOut:p,minAmountOut:l,priceImpact:d,fee:y}=this.scope.cpmm.computeSwapAmount({pool:e,outputMint:o.address,amountIn:u.raw,slippage:r});return{allTrade:a,amountIn:{amount:u,fee:void 0,expirationTime:void 0},amountOut:{amount:vt(X(W({},o),{amount:p})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:vt(X(W({},o),{amount:l})),fee:void 0,expirationTime:void 0},currentPrice:e.poolPrice,executionPrice:c,priceImpact:d,fee:[new se(u.token,y)],remainingAccounts:[],routeType:"amm",poolInfoList:[e],poolReady:e.openTime.toNumber()<i,poolType:"CPMM",slippage:r,clmmExPriceX64:[void 0],expirationTime:void 0}}else{if(![1,6,7].includes(n[e.id.toString()].status))throw Error("swap error");let{amountOut:a,minAmountOut:c,currentPrice:p,executionPrice:l,priceImpact:d,fee:y}=this.scope.liquidity.computeAmountOut({poolInfo:n[e.id.toString()],amountIn:u.raw,mintIn:u.token.mint,mintOut:o.address,slippage:r});return{amountIn:{amount:u,fee:void 0,expirationTime:void 0},amountOut:{amount:vt(X(W({},o),{amount:a})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:vt(X(W({},o),{amount:c})),fee:void 0,expirationTime:void 0},currentPrice:p,executionPrice:l,priceImpact:d,fee:[new se(u.token,y)],routeType:"amm",poolInfoList:[e],remainingAccounts:[],poolReady:Number(n[e.id].openTime)<i,poolType:e.version===5?"STABLE":void 0,expirationTime:void 0,allTrade:!0,slippage:r,clmmExPriceX64:[void 0]}}}async computePoolToPoolKeys({pools:e,clmmRpcData:t={},ammRpcData:n={}}){let i=new Set(e.filter(a=>a.version===6&&!t[a.id.toString()]).map(a=>a.id.toString()));if(i.size>0){let a=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:Array.from(i)});Object.keys(a).forEach(c=>{t[c]=a[c]})}let s=new Set(e.filter(a=>a.version===4&&!n[a.id.toString()]).map(a=>a.id.toString()));if(s.size>0){let a=await this.scope.liquidity.getRpcPoolInfos(Array.from(s));Object.keys(a).forEach(c=>{n[c]=a[c]})}let r=new Set(e.filter(a=>a.version===4).map(a=>a.marketId)),o={};r.size>0&&(await ut(this.scope.connection,Array.from(r).map(c=>({pubkey:new Pt(c)})))).forEach(c=>{if(!c.accountInfo)return;let p=yi.decode(c.accountInfo.data);o[c.pubkey.toBase58()]={marketId:c.pubkey.toString(),marketProgramId:c.accountInfo.owner.toString(),marketAuthority:Bn.getAssociatedAuthority({programId:c.accountInfo.owner,marketId:c.pubkey}).publicKey.toString(),marketBaseVault:p.baseVault.toString(),marketQuoteVault:p.quoteVault.toString(),marketBids:p.bids.toString(),marketAsks:p.asks.toString(),marketEventQueue:p.eventQueue.toString()}});let u=[];return e.forEach(a=>{if(a.version===6){let c=t[a.id.toString()],p={programId:a.programId.toBase58(),id:a.id.toBase58(),mintA:a.mintA,mintB:a.mintB,openTime:String(a.startTime),vault:{A:c.vaultA.toBase58(),B:c.vaultB.toBase58()},config:X(W({},a.ammConfig),{id:a.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]}),rewardInfos:[],observationId:a.observationId.toBase58(),exBitmapAccount:a.exBitmapAccount.toBase58()};u.push(p)}else if(a.version===4){let c=n[a.id.toString()],p=W({programId:a.programId,id:a.id,mintA:a.mintA,mintB:a.mintB,openTime:String(a.openTime),vault:{A:c.baseVault.toBase58(),B:c.quoteVault.toBase58()},authority:Sr({programId:new Pt(a.programId)}).publicKey.toString(),openOrders:c.openOrders.toBase58(),targetOrders:c.targetOrders.toBase58(),mintLp:a.lpMint},o[a.marketId]);u.push(p)}else a.version===7&&u.push({observationId:a.observationId.toBase58(),programId:a.programId.toBase58(),id:a.id.toBase58(),mintA:a.mintA,mintB:a.mintB,openTime:String(a.openTime),authority:dr(a.programId).publicKey.toBase58(),vault:{A:a.vaultA.toBase58(),B:a.vaultB.toBase58()},mintLp:pt({address:a.mintLp.toBase58(),programId:be.toBase58(),decimals:a.lpDecimals}),config:X(W({id:a.configId.toBase58()},a.configInfo),{protocolFeeRate:a.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:a.configInfo.tradeFeeRate.toNumber(),fundFeeRate:a.configInfo.fundFeeRate.toNumber(),createPoolFee:a.configInfo.createPoolFee.toString()})})}),u}};export{gi as default};
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
//# sourceMappingURL=trade.mjs.map