var Fr=Object.defineProperty,Vr=Object.defineProperties;var _r=Object.getOwnPropertyDescriptors;var rn=Object.getOwnPropertySymbols;var wi=Object.prototype.hasOwnProperty,Ti=Object.prototype.propertyIsEnumerable;var Ai=(m,e,t)=>e in m?Fr(m,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):m[e]=t,V=(m,e)=>{for(var t in e||(e={}))wi.call(e,t)&&Ai(m,t,e[t]);if(rn)for(var t of rn(e))Ti.call(e,t)&&Ai(m,t,e[t]);return m},X=(m,e)=>Vr(m,_r(e));var ct=(m,e)=>{var t={};for(var n in m)wi.call(m,n)&&e.indexOf(n)<0&&(t[n]=m[n]);if(m!=null&&rn)for(var n of rn(m))e.indexOf(n)<0&&Ti.call(m,n)&&(t[n]=m[n]);return t};import{PublicKey as It}from"@solana/web3.js";import{createTransferInstruction as Wr,TOKEN_PROGRAM_ID as ye,TOKEN_2022_PROGRAM_ID as Kn}from"@solana/spl-token";import Cn from"bn.js";import nn from"decimal.js";import{PublicKey as Ii}from"@solana/web3.js";import{get as hi,set as vr}from"lodash";var Rn=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Date.now().toString()}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},xi={},Dr={};function re(m){let e=hi(xi,m);if(!e){let t=hi(Dr,m);e=new Rn({name:m,logLevel:t}),vr(xi,m,e)}return e}import{MINT_SIZE as qr,TOKEN_PROGRAM_ID as Gr,getTransferFeeConfig as Ur,unpackMint as Xr}from"@solana/spl-token";var Nn=re("Raydium_accountInfo_util");async function Ze(m,e,t){let{batchRequest:n,commitment:i="confirmed",chunkCount:s=100}=V({batchRequest:!1},t),o=Mn(e,s),r=new Array(o.length).fill([]);if(n){let u=o.map(p=>{let l=m._buildArgs([p.map(d=>d.toBase58())],i,"base64");return{methodName:"getMultipleAccounts",args:l}}),a=Mn(u,10);r=(await(await Promise.all(a.map(async p=>await m._rpcBatchRequest(p)))).flat()).map(p=>(p.error&&Nn.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${p.error.message}`),p.result.value.map(l=>{if(l){let{data:d,executable:y,lamports:b,owner:f,rentEpoch:g}=l;return d.length!==2&&d[1]!=="base64"&&Nn.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(d[0],"base64"),executable:y,lamports:b,owner:new Ii(f),rentEpoch:g}}return null})))}else try{r=await Promise.all(o.map(u=>m.getMultipleAccountsInfo(u,i)))}catch(u){u instanceof Error&&Nn.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${u.message}`)}return r.flat()}async function ft(m,e,t){let n=await Ze(m,e.map(i=>i.pubkey),t);return e.map((i,s)=>X(V({},i),{accountInfo:n[s]}))}async function On({connection:m,mints:e,config:t}){var s,o,r;if(e.length===0)return{};let n=await ft(m,e.map(u=>({pubkey:Ge(u)})),t),i={};for(let u of n){if(!u.accountInfo||u.accountInfo.data.length<qr){console.log("invalid mint account",u.pubkey.toBase58());continue}let a=Xr(u.pubkey,u.accountInfo,(s=u.accountInfo)==null?void 0:s.owner);i[u.pubkey.toString()]=X(V({},a),{programId:((o=u.accountInfo)==null?void 0:o.owner)||Gr,feeConfig:(r=Ur(a))!=null?r:void 0})}return i[Ii.default.toBase58()]=i[_e.toBase58()],i}import $e from"bn.js";import Tu from"decimal.js";import $r from"big.js";import an from"bn.js";import zr from"toformat";var Qr=zr,Ot=Qr;import sn from"big.js";import jr from"bn.js";import Yr from"decimal.js-light";import Et from"bn.js";var Bi=9007199254740991;function oe(m){let e=re("Raydium_parseBigNumberish");if(m instanceof Et)return m;if(typeof m=="string"){if(m.match(/^-?[0-9]+$/))return new Et(m);e.logWithError(`invalid BigNumberish string: ${m}`)}return typeof m=="number"?(m%1&&e.logWithError(`BigNumberish number underflow: ${m}`),(m>=Bi||m<=-Bi)&&e.logWithError(`BigNumberish number overflow: ${m}`),new Et(String(m))):typeof m=="bigint"?new Et(m.toString()):(e.error(`invalid BigNumberish value: ${m}`),new Et(0))}var on=re("module/fraction"),En=Ot(sn),Wt=Ot(Yr),Zr={[0]:Wt.ROUND_DOWN,[1]:Wt.ROUND_HALF_UP,[2]:Wt.ROUND_UP},Jr={[0]:sn.roundDown,[1]:sn.roundHalfUp,[2]:sn.roundUp},te=class{constructor(e,t=new jr(1)){this.numerator=oe(e),this.denominator=oe(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new te(this.denominator,this.numerator)}add(e){let t=e instanceof te?e:new te(oe(e));return this.denominator.eq(t.denominator)?new te(this.numerator.add(t.numerator),this.denominator):new te(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof te?e:new te(oe(e));return this.denominator.eq(t.denominator)?new te(this.numerator.sub(t.numerator),this.denominator):new te(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof te?e:new te(oe(e));return new te(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof te?e:new te(oe(e));return new te(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||on.logWithError(`${e} is not an integer.`),e<=0&&on.logWithError(`${e} is not positive.`),Wt.set({precision:e+1,rounding:Zr[n]});let i=new Wt(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return i.toFormat(i.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||on.logWithError(`${e} is not an integer.`),e<0&&on.logWithError(`${e} is negative.`),En.DP=e,En.RM=Jr[n]||1,new En(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var eo=re("Raydium_amount"),Si=Ot($r);function to(m,e){let t="0",n="0";if(m.includes(".")){let i=m.split(".");i.length===2?([t,n]=i,n=n.padEnd(e,"0")):eo.logWithError(`invalid number string, num: ${m}`)}else t=m;return[t,n.slice(0,e)||n]}var se=class extends te{constructor(t,n,i=!0,s){let o=new an(0),r=Wn.pow(new an(t.decimals));if(i)o=oe(n);else{let u=new an(0),a=new an(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[c,p]=to(n.toString(),t.decimals);u=oe(c),a=oe(p)}u=u.mul(r),o=u.add(a)}super(o,r);this.logger=re(s||"TokenAmount"),this.token=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.token.equals(t.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(t.raw)}lt(t){return this.token.equals(t.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(t.raw)}add(t){return this.token.equals(t.token)||this.logger.logWithError("add token not equals"),new se(this.token,this.raw.add(t.raw))}subtract(t){return this.token.equals(t.token)||this.logger.logWithError("sub token not equals"),new se(this.token,this.raw.sub(t.raw))}toSignificant(t=this.token.decimals,n,i=0){return super.toSignificant(t,n,i)}toFixed(t=this.token.decimals,n,i=0){return t>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,i)}toExact(t={groupSeparator:""}){return Si.DP=this.token.decimals,new Si(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}};import{PublicKey as no}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ki}from"@solana/spl-token";var Fn={chainId:101,address:no.default.toBase58(),programId:Ki.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},Ue={chainId:101,address:"So11111111111111111111111111111111111111112",programId:Ki.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};import{PublicKey as vn}from"@solana/web3.js";import{PublicKey as le,SystemProgram as Ci,SYSVAR_RENT_PUBKEY as io}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as ro}from"@solana/spl-token";function S({pubkey:m,isSigner:e=!1,isWritable:t=!0}){return{pubkey:m,isWritable:t,isSigner:e}}var ha=[S({pubkey:ro,isWritable:!1}),S({pubkey:Ci.programId,isWritable:!1}),S({pubkey:io,isWritable:!1})];function Vn({publicKey:m,transformSol:e}){let t=_n(m.toString());if(t instanceof le)return e&&t.equals(Ft)?_e:t;if(e&&t.toString()===Ft.toBase58())return _e;if(typeof t=="string"){if(t===le.default.toBase58())return le.default;try{return new le(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function _n(m){try{return new le(m)}catch{return m}}var un=new le("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),Bt=new le("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),Xe=new le("SysvarRent111111111111111111111111111111111"),xa=new le("SysvarC1ock11111111111111111111111111111111"),lt=new le("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),Ia=new le("Sysvar1nstructions1111111111111111111111111"),oo=Ci.programId,Ba=new le("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Sa=new le("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),Ka=new le("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),Ca=new le("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),La=new le("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),Ra=new le("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),Na=new le("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),Ma=new le("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),Oa=new le("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),Ea=new le("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),Wa=new le("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),_e=new le("So11111111111111111111111111111111111111112"),Ft=le.default;function Ge(m){return Vn({publicKey:m,transformSol:!0})}var Dn=class{constructor({mint:e,decimals:t,symbol:n,name:i,skipMint:s=!1,isToken2022:o=!1}){if(e===Ft.toBase58()||e instanceof vn&&Ft.equals(e)){this.decimals=Ue.decimals,this.symbol=Ue.symbol,this.name=Ue.name,this.mint=new vn(Ue.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=i||e.toString().substring(0,6),this.mint=s?vn.default:Vn({publicKey:e}),this.isToken2022=o}equals(e){return this===e?!0:this.mint.equals(e.mint)}},Re=Dn;Re.WSOL=new Dn(X(V({},Ue),{mint:Ue.address}));var qn=class{constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},cn=qn;cn.SOL=new qn(Fn);import so from"bn.js";var Li=new te(new so(100)),Je=class extends te{toSignificant(e=5,t,n){return this.mul(Li).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(Li).toFixed(e,t,n)}};var ao=re("Raydium_price"),Ce=class extends te{constructor(t){let{baseToken:n,quoteToken:i,numerator:s,denominator:o}=t;super(s,o);this.baseToken=n,this.quoteToken=i,this.scalar=new te(Gn(n.decimals),Gn(i.decimals))}get raw(){return new te(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new Ce({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&ao.logWithError("mul token not equals");let n=super.mul(t);return new Ce({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(t=this.quoteToken.decimals,n,i){return this.adjusted.toSignificant(t,n,i)}toFixed(t=this.quoteToken.decimals,n,i){return this.adjusted.toFixed(t,n,i)}};import{PublicKey as uo}from"@solana/web3.js";import co from"bn.js";function Ni(m){return typeof m=="object"&&m!==null&&![Re,se,uo,te,co,Ce,Je].some(e=>typeof e=="object"&&m instanceof e)}function bt(m){return typeof m=="string"?_n(m):Array.isArray(m)?m.map(e=>bt(e)):Ni(m)?Object.fromEntries(Object.entries(m).map(([e,t])=>[e,bt(t)])):m}var Ri=new $e(0),lo=new $e(1),Nu=new $e(2),Mu=new $e(3),Ou=new $e(5),Wn=new $e(10),Eu=new $e(100),Wu=new $e(1e3),Fu=new $e(1e4);function Gn(m){return Wn.pow(oe(m))}function Mn(m,e=1,t=[]){let n=[...m];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}var ze=class{constructor(e){this._owner=e}get publicKey(){return ze.isKeyPair(this._owner)?this._owner.publicKey:this._owner}get signer(){return ze.isKeyPair(this._owner)?this._owner:void 0}get isKeyPair(){return ze.isKeyPair(this._owner)}get isPublicKey(){return ze.isPublicKey(this._owner)}static isKeyPair(e){return e.secretKey!==void 0}static isPublicKey(e){return!ze.isKeyPair(e)}};import{PublicKey as Po}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as ko}from"@solana/spl-token";import{ComputeBudgetProgram as Mi,Keypair as Ei,PublicKey as mo,Transaction as Wi,TransactionMessage as po,VersionedTransaction as Fi}from"@solana/web3.js";var Y={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",ClmmLockPosition:"ClmmLockPosition",ClmmHarvestLockPosition:"ClmmHarvestLockPosition",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV4Withdraw:"FarmV4Withdraw",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut",CpmmLockLp:"CpmmLockLp",CpmmCollectLockFee:"CpmmCollectLockFee",TransferTip:"TransferTip"};import{TOKEN_PROGRAM_ID as fo}from"@solana/spl-token";var Oi=re("Raydium_txUtil"),Vi=1644;function Vt(m){let e=[],t=[];return m.microLamports&&(e.push(Mi.setComputeUnitPrice({microLamports:m.microLamports})),t.push(Y.SetComputeUnitPrice)),m.units&&(e.push(Mi.setComputeUnitLimit({units:m.units})),t.push(Y.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function yt(m,e){var n,i;let t=e!=null?e:"confirmed";return(i=await((n=m.getLatestBlockhash)==null?void 0:n.call(m,{commitment:t})))==null?void 0:i.blockhash}async function _t(m,e){return m.getSignatureStatuses([e]),new Promise((t,n)=>{let i=setTimeout(n,6e4);m.onSignature(e,s=>{if(clearTimeout(i),!s.err){t("");return}n(Object.assign(s.err,{txId:e}))},"confirmed")})}function bo(m,e){m.length<1&&Oi.logWithError(`no instructions provided: ${m.toString()}`),e.length<1&&Oi.logWithError(`no signers provided:, ${e.toString()}`);let t=new Wi;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...m);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<Vi}catch{return!1}}function ge(m,e){let[t,n]=mo.findProgramAddressSync(m,e);return{publicKey:t,nonce:n}}function vt({instructions:m,payer:e,signers:t}){return bo(m,[e,...t])}function et({instructions:m,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=Ei.generate().publicKey.toString()}){let s=new po({payerKey:e,recentBlockhash:n,instructions:m}).compileToV0Message(Object.values(t!=null?t:{}));try{return Buffer.from(new Fi(s).serialize()).toString("base64").length<Vi}catch{return!1}}var yo=m=>Buffer.isBuffer(m)?m:m instanceof Uint8Array?Buffer.from(m.buffer,m.byteOffset,m.byteLength):Buffer.from(m),go=m=>{let e=m.serialize({requireAllSignatures:!1,verifySignatures:!1});m instanceof Fi&&(e=yo(e));try{return e instanceof Buffer?e.toString("base64"):Buffer.from(e).toString("base64")}catch{return e.toString("base64")}};function mt(m){let e=[];return m.forEach(t=>{t instanceof Wi&&(t.recentBlockhash||(t.recentBlockhash=fo.toBase58()),t.feePayer||(t.feePayer=Ei.generate().publicKey)),e.push(go(t))}),console.log("simulate tx string:",e),e}function ae(m,e,t){return ge([m.toBuffer(),(t!=null?t:ko).toBuffer(),e.toBuffer()],new Po("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import{PublicKey as v}from"@solana/web3.js";var rc=new v("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),oc=new v("CBuCnLe26faBpcBP2fktp4rp8abpcAnTWft6ZrP5Q4T"),sc=new v("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),ac=new v("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),uc=new v("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),cc=new v("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),Un=new v("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),_i=new v("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),lc=new v("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),vi=new v("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Xn=new v("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),Ao=new v("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),wo=new v("kN1kEznaF5Xbd8LYuqtEFcxzWSBk5Fv6ygX6SqEGJVy"),ln=new v("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),mc=new v("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),pc=new v("7YttLkHDoNj9wyDur5pM1ejNaAvT9X4eqaYcHQqtj2G5"),dc=new v("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),fc=new v("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),bc=new v("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),yc=new v("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),zn=new v("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),To=new v("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),gc=new v("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),Pc=new v("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),kc=new v("3f7GcQFG397GAaEnv51zR6tsTVihYRydnydDD1cXekxH"),Ac=new v("LanMV9sAd7wArD4vJFi2qDdfnVhFxYSUg6eADduJ3uj"),wc=new v("WLHv2UAZm6z4KyaaELi5pjdbJh6RESMva1Rnn8pJVVh"),Tc=new v("DRay6fNdQ5J82H7xV6uq2aV3mNrUZ1J4PgSKsWgptcm6"),hc=new v("5xqNaZXX5eUi4p5HU4oz9i5QnwRNT2y6oN7yyn4qENeq"),xc=new v("4Bu96XjU84XjPDSpveTVf6LYGCkfW5FK7SNkREWcEfV4"),Ic=new v("6s1xP3hpbAfFoNtUNF8mfHsjr2Bd97JxFJRWLbL6aHuX");var Bc={OPEN_BOOK_PROGRAM:new v("EoTcMgcDRTJVZDMZWBoU6rhYHZfkNTVEAfz3uUJRcYGj"),SERUM_PROGRAM_ID_V3:new v("Ray1111111111111111111111111111111111111111"),AMM_V4:new v("DRaya7Kj3aMWQSy19kSjvmuwq9docCHofyP9kanQGaav"),AMM_STABLE:new v("DRayDdXc1NZQ9C3hRWmoSf8zK4iapgMnjdNZWrfwsP8m"),CLMM_PROGRAM_ID:new v("DRayAUgENGQBKVaX8owNhgzkEDyoHTGVEGHVJT1E9pfH"),CLMM_LOCK_PROGRAM_ID:new v("DRay25Usp3YJAi7beckgpGUC7mGJ2cR1AVPxhYfwVCUX"),CLMM_LOCK_AUTH_ID:new v("6Aoh8h2Lw2m5UGxYR8AdAL87jTWYeKoxM52mJRzfYwN"),CREATE_CPMM_POOL_PROGRAM:new v("DRaycpLY18LhpbydsBWbVJtxpNv9oXPgjRSfpF2bWpYb"),CREATE_CPMM_POOL_AUTH:new v("CXniRufdq5xL8t8jZAPxsPZDpuudwuJSPWnbcD5Y5Nxq"),CREATE_CPMM_POOL_FEE_ACC:new v("3oE58BKVt8KuYkGxx8zBojugnymWmBiyafWgMrnb6eYy"),LOCK_CPMM_PROGRAM:new v("DRay25Usp3YJAi7beckgpGUC7mGJ2cR1AVPxhYfwVCUX"),LOCK_CPMM_AUTH:new v("7qWVV8UY2bRJfDLP4s37YzBPKUkVB46DStYJBpYbQzu3"),UTIL1216:v.default,Router:new v("DRaybByLpbUL57LJARs3j8BitTxVfzBg351EaMr5UTCd"),FARM_PROGRAM_ID_V3:new v("DRayWyrLmEW5KEeqs8kdTMMaBabapqagaBC7KWpGtJeZ"),FARM_PROGRAM_ID_V4:new v("Ray1111111111111111111111111111111111111111"),FARM_PROGRAM_ID_V5:new v("DRayiCGSZgku1GTK6rXD6mVDdingXy6APAH1R6R5L2LC"),FARM_PROGRAM_ID_V6:new v("DRayzbYakXs45ELHkzH6vC3fuhQqTAnv5A68gdFuvZyZ"),LAUNCHPAD_PROGRAM:new v("DRay6fNdQ5J82H7xV6uq2aV3mNrUZ1J4PgSKsWgptcm6"),LAUNCHPAD_AUTH:new v("5xqNaZXX5eUi4p5HU4oz9i5QnwRNT2y6oN7yyn4qENeq"),LAUNCHPAD_PLATFORM:new v("2Jx4KTDrVSdWNazuGpcA8n3ZLTRGGBDxAWhuKe2Xcj2a"),LAUNCHPAD_CONFIG:new v("7ZR4zD7PYfY2XxoG1Gxcy2EgEeGYrpxrwzPuwdUBssEt"),FEE_DESTINATION_ID:new v("9y8ENuuZ3b19quffx9hQvRVygG5ky6snHfRvGpuSfeJy"),MODEL_DATA_PUBKEY:new v("Ray1111111111111111111111111111111111111111")};import ve from"bn.js";var Dt=1e4;function be(m,e,t,n){if(e===void 0)return{amount:m,fee:void 0,expirationTime:void 0};let i=X(V({},e),{olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}}),s=t.epoch<i.newerTransferFee.epoch?i.olderTransferFee:i.newerTransferFee,o=new ve(s.maximumFee.toString()),r=t.epoch<i.newerTransferFee.epoch?(Number(i.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(s.transferFeeBasisPoints===Dt){let u=new ve(s.maximumFee.toString());return{amount:m.add(u),fee:u,expirationTime:r}}else{let u=mn(m.mul(new ve(Dt)),new ve(Dt-s.transferFeeBasisPoints)),a=new ve(s.maximumFee.toString()),c=u.sub(m).gt(a)?m.add(a):u,p=mn(c.mul(new ve(s.transferFeeBasisPoints)),new ve(Dt)),l=p.gt(o)?o:p;return{amount:c,fee:l,expirationTime:r}}else{let u=mn(m.mul(new ve(s.transferFeeBasisPoints)),new ve(Dt)),a=u.gt(o)?o:u;return{amount:m,fee:a,expirationTime:r}}}function De(m,e){return m===void 0?e:e===void 0?m:Math.min(m,e)}function mn(m,e){let{div:t,mod:n}=m.divmod(e);return n.gt(new ve(0))?t.add(new ve(1)):t}import{PublicKey as Qn,AddressLookupTableAccount as Kt}from"@solana/web3.js";async function pn({connection:m,address:e,cluster:t="mainnet"}){let n=await Ze(m,[...new Set(e.map(s=>s.toString()))].map(s=>new Qn(s))),i={};for(let s=0;s<e.length;s++){let o=n[s],r=e[s];if(!o)continue;let u=new Kt({key:r,state:Kt.deserialize(o.data)});i[r.toString()]=u,t==="devnet"?St[r.toString()]=u:qt[r.toString()]=u}return i}var qt={AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU:new Kt({key:new Qn("AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU"),state:Kt.deserialize(Buffer.from("AQAAAP//////////I1rcEwAAAAAvAQYwun9CU6c5Ikm2pAj+D9IEnCOR45nK+SFTGSdpd6J6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAbd9uHXZaGT2cvhRs7reawctIXtX1s3kTqM9YV+/wCpBt324e51j94YQl285GzN2rYa/E2DuQ0n/r35KNihi/wFSlNQ+F3IgtYUpVZyeIopbd8eq6vQpgZ4iEky9O72oAVKU1qZKSEGTSTocWDaOHx8NbXdvJK7geQfqEBBBUSNBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvBkX2T9y7AHdNGviJAqQNtlDUDCnauQRWybsLji6nPM8Qkw5asQRvCdB3MbX6IEBwytOrpM32l4jQygKG9TKgR0vZScQ2AsM/IHeQ7RajUkyhuZdc8SGiqQz/7H34torNR/Wir3sl0ruUrVxJWEZfUg+QLNAxxODdBi53/OP7Ioil1cqeBM9dtZC3FLov4yyxWRM/wcGStyJX/QfTnLBAHqkqWotPKVlShCVQqpP9W5W1rOao65IMk5QuQ2kMIOxzDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu/YsA/yfEEFGcr8Z57VKDw8uQzpiru7g4lvjnfapW62W030syevD8k07SGoxUHiuT/ai7gAHWWhDsVmg/C63ajgpkH7Sn3GdutArDTfyqOkdqv4/IPC/EFFy7mGkfDd2C57N5a/4jC+BbmJy7wQaSEZr0CQU88lPtUxIVvzGjC95b8Ooss2TqmkrayGKofkPMGQn7Ux+9lfwBSNfxwH8NgbpqC/7LNlV4I7nCvsXf3p+ohQk9NrAJb2KAFpUqEIJ9ZBV7BYDzHF/ORKYlgtvPnXjudZQ6CEo5OzUDaNIomTCCsvhD16TxJjsbgne1kGnQPCFSoaxUbq2V1bPMFQ3VYP6wDZ9bKStCFKx9A3tNbwZFC5ZGAN83MFK7XoTy+OmmcFEr6rLOjfSuTfPvHJkSVxW6Qllwkl67XcBi5v00u2gQsbu+38sp+rd5pA/LvyWj4P94ZGZwc1tE2P88xekCLcAwZGb+UhFzL/7K26csOb57yM5bvF9xJrLEObOkAAAAAn+HWRkdcPKyFFMnVwEoD7vnD0jCKFIU1sImubYCxNTSVzsKpaQX+fzNxrLAI3L14JQnJx/D6Uk2LADIHGqnGELzjEbkBDAlaM77NkXMPfqXNLSveCkWI7UEgNs31WEWB6XHSYI/v5DklHOb4QTtDOR804PVbi3fjloZeLR2F8d4FuZmMMO7ck3Fnkn2zEMG5gOmqsygb6PjTitArVl52NhcSznTxVnguaIJxiZkAnurDmn3MWR0PC2GLghp2KJqHCc6QQ85odeIjFHKOlRlJyeSXVJmL8vb1UgOzsbJPVP8p6zM4M3C1Sd7uWIHP33G42AP2Zg8ucn/n6meQjjD266JgCWdxZD6PXs9CsnIeL7SSG0/6lGb9xfP0ZcWkCXB/3hjxHYVXjra/GPOeXGk0fLLKjCbk+mgs2w6d2oCwimBipTzuoZ30GiI8ij8VRzD5CzMWtu2m21eDBIfjGAEo4pQeNNonKcqzV/cleX8ySZLOHsz8PtBCrLqF+VkLm9hOzIT+6i/nIf6keR4GWKMOD4AvqfpjHoD4DuhBpz8P28+DxkGrDXXr/nr20x291VPvcTU/b+b+o2kC9G0kcXeTlLjU6a2TQXWlZ4gBUdBl1jgT7mObSTpLblNiXZsLkbmVXZwvFKXua5cUKlWed/w30skmEUraTuQqtqr5fHZPW9n57EmeTif6LjHL2YJFZkQU+TrJmFzqzmF4/b8OwrPQAprl8mX3q4LUIdAS/a+11B6DWD1Xk2++Sn94dLC4xjkO4Wtlw8c4XuzciVbepHOmnoWzVu/0y3KCrLCSfQxQ3br8DJCoVzhgtPsS2nZZjsBGIZgnU0QpMv+2MnRsnKwdp1VsrCX84j/qvaZn4WhKunippgTbN2EUs0tPTP55Qfgj+nKmjtWW5IYs72FrEwJKYoNfsmqaF4o5pf4v9zgPwVwY/5I4XJKUL2L25m9kAQcW/K+H1RTFEUoj8Z4ajpOmAB/dG0COmCphVMW2CCMvnxhcGiSgPnpDuWu6qiJ7NG7ye5kvHgefgqPLeicspNJ5EpL3XiRNLM2tmJLI1awAwOyd6iHv0dCkMYRKaa6rcaZeYwmKCkckm0kM2JNmnmmAaBQQ7mwmIM0IMxX4f5W6j9PqZWcJxF7r17T/lQBAmcjoupRiJifbnXCNUv9GhpRF19WcBdeKbivRJVlGop6I2RS6lGImJ9udcI1S/0aGlEXX1ZwF14puK9ElWUainojZFYVHLHD6dIP2ESjqBzg3ol1/wB7+/ylGwd9LS7wSZ2A630CJSVKwH47K9P4bB8PEQP8BwjMFa7xQHOqZFP1XqaQ==","base64"))})},St={},dn=async m=>{let e="EFhMuDw1PKEuckuFRW9PavNfTH4LKP5uKHgyXDmWpFCq";if(St[e])return St;let t=new Qn(e),n=await m.getAccountInfo(t);return n&&(St[e]=new Kt({key:t,state:Kt.deserialize(n.data)})),St};import{PublicKey as gt,sendAndConfirmTransaction as Hn,SystemProgram as ho,Transaction as Gt,TransactionMessage as tt,VersionedTransaction as nt}from"@solana/web3.js";import xo from"axios";var Ut=2e3,Xt=class{constructor(e){this.instructions=[];this.endInstructions=[];this.lookupTableAddress=[];this.signers=[];this.instructionTypes=[];this.endInstructionTypes=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner,this.cluster=e.cluster,this.blockhashCommitment=e.blockhashCommitment,this.loopMultiTxStatus=!!e.loopMultiTxStatus}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){var n;let e=(await xo.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=(n=e==null?void 0:e[15])!=null?n:{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=Vt(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}addTipInstruction(e){var t;return e?(this.endInstructions.push(ho.transfer({fromPubkey:(t=e.feePayer)!=null?t:this.feePayer,toPubkey:new gt(e.address),lamports:BigInt(e.amount.toString())})),this.endInstructionTypes.push(Y.TransferTip),!0):!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:i=[],endInstructionTypes:s=[],lookupTableAddress:o=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...i),this.endInstructionTypes.push(...s),this.lookupTableAddress.push(...o.filter(r=>r!==gt.default.toString())),this}async versionBuild({txVersion:e,extInfo:t}){return e===0?await this.buildV0(V({},t||{})):this.build(t)}build(e){var n;let t=new Gt;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,((n=this.owner)==null?void 0:n.signer)&&!this.signers.some(i=>i.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer),{builder:this,transaction:t,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async i=>{var c;let{recentBlockHash:s,skipPreflight:o=!0,sendAndConfirm:r,notSendToRpc:u}=i||{},a=s!=null?s:await yt(this.connection,this.blockhashCommitment);if(t.recentBlockhash=a,this.signers.length&&t.sign(...this.signers),mt([t]),(c=this.owner)!=null&&c.isKeyPair)return{txId:r?await Hn(this.connection,t,this.signers.find(l=>l.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:o}):await this.connection.sendRawTransaction(t.serialize(),{skipPreflight:o}),signedTx:t};if(this.signAllTransactions){let p=await this.signAllTransactions([t]);if(this.signers.length)for(let l of p)try{l.sign(...this.signers)}catch{}return{txId:u?"":await this.connection.sendRawTransaction(p[0].serialize(),{skipPreflight:o}),signedTx:p[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:e||{}}}buildMultiTx(e){var a;let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:i}=this.build(n),s=t.filter(c=>c.transaction.instructions.length>0),o=[i,...s.map(c=>c.transaction)],r=[this.signers,...s.map(c=>c.signers)],u=[...this.instructionTypes,...s.map(c=>c.instructionTypes).flat()];return(a=this.owner)!=null&&a.signer&&r.forEach(c=>{c.some(p=>p.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),{builder:this,transactions:o,signers:r,instructionTypes:u,execute:async c=>{var g;let{sequentially:p,onTxUpdate:l,skipTxCount:d=0,recentBlockHash:y,skipPreflight:b=!0}=c||{},f=y!=null?y:await yt(this.connection,this.blockhashCommitment);if((g=this.owner)!=null&&g.isKeyPair){if(p){let w=[],I=0;for(let T of o){if(++I,I<=d)continue;let A=await Hn(this.connection,T,this.signers.find(k=>k.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:b});w.push(A)}return{txIds:w,signedTxs:o}}return{txIds:await await Promise.all(o.map(async w=>(w.recentBlockhash=f,await this.connection.sendRawTransaction(w.serialize(),{skipPreflight:b})))),signedTxs:o}}if(this.signAllTransactions){let w=o.map((T,A)=>(T.recentBlockhash=f,r[A].length&&T.sign(...r[A]),T));mt(w);let I=await this.signAllTransactions(w);if(p){let T=0,A=[],k=async()=>{if(!I[T])return;let B=await this.connection.sendRawTransaction(I[T].serialize(),{skipPreflight:b});A.push({txId:B,status:"sent",signedTx:I[T]}),l==null||l([...A]),T++;let x=!1,R=null,h=null,C=E=>{R!==null&&clearInterval(R),h!==null&&this.connection.removeSignatureListener(h);let O=A.findIndex(_=>_.txId===B);if(O>-1){if(A[O].status==="error"||A[O].status==="success")return;A[O].status=E.err?"error":"success"}l==null||l([...A]),E.err||k()};this.loopMultiTxStatus&&(R=setInterval(async()=>{var E;if(x){clearInterval(R);return}try{let O=await this.connection.getTransaction(B,{commitment:"confirmed",maxSupportedTransactionVersion:0});O&&(x=!0,clearInterval(R),C({err:((E=O.meta)==null?void 0:E.err)||null}),console.log("tx status from getTransaction:",B))}catch(O){x=!0,clearInterval(R),console.error("getTransaction timeout:",O,B)}},Ut)),h=this.connection.onSignature(B,E=>{if(x){this.connection.removeSignatureListener(h);return}x=!0,C(E)},"confirmed"),this.connection.getSignatureStatus(B)};return await k(),{txIds:A.map(B=>B.txId),signedTxs:I}}else{let T=[];for(let A=0;A<I.length;A+=1){let k=await this.connection.sendRawTransaction(I[A].serialize(),{skipPreflight:b});T.push(k)}return{txIds:T,signedTxs:I}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e){var b;let y=e||{},{lookupTableCache:t={},lookupTableAddress:n=[],forerunCreate:i,recentBlockhash:s}=y,o=ct(y,["lookupTableCache","lookupTableAddress","forerunCreate","recentBlockhash"]),r=V(V({},this.cluster==="devnet"?await dn(this.connection):qt),t),u=Array.from(new Set([...n,...this.lookupTableAddress])),a=[];for(let f of u)r[f]===void 0&&a.push(new gt(f));let c=await pn({connection:this.connection,address:a});for(let[f,g]of Object.entries(c))r[f]=g;let p=i?gt.default.toBase58():s!=null?s:await yt(this.connection,this.blockhashCommitment),l=new tt({payerKey:this.feePayer,recentBlockhash:p,instructions:[...this.allInstructions]}).compileToV0Message(Object.values(r));((b=this.owner)==null?void 0:b.signer)&&!this.signers.some(f=>f.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer);let d=new nt(l);return d.sign(this.signers),{builder:this,transaction:d,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async f=>{var T;let{skipPreflight:g=!0,sendAndConfirm:w,notSendToRpc:I}=f||{};if(mt([d]),(T=this.owner)!=null&&T.isKeyPair){let A=await this.connection.sendTransaction(d,{skipPreflight:g});return w&&await _t(this.connection,A),{txId:A,signedTx:d}}if(this.signAllTransactions){let A=await this.signAllTransactions([d]);if(this.signers.length)for(let k of A)try{k.sign(this.signers)}catch{}return{txId:I?"":await this.connection.sendTransaction(A[0],{skipPreflight:g}),signedTx:A[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:o||{}}}async buildV0MultiTx(e){var a;let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:i}=await this.buildV0(n),s=t.filter(c=>c.builder.instructions.length>0),o=[i,...s.map(c=>c.transaction)],r=[this.signers,...s.map(c=>c.signers)],u=[...this.instructionTypes,...s.map(c=>c.instructionTypes).flat()];return(a=this.owner)!=null&&a.signer&&r.forEach(c=>{c.some(p=>p.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),o.forEach(async(c,p)=>{c.sign(r[p])}),{builder:this,transactions:o,signers:r,instructionTypes:u,buildProps:n,execute:async c=>{var b;let{sequentially:p,onTxUpdate:l,recentBlockHash:d,skipPreflight:y=!0}=c||{};if(d&&o.forEach(f=>f.message.recentBlockhash=d),mt(o),(b=this.owner)!=null&&b.isKeyPair){if(p){let f=[];for(let g of o){let w=await this.connection.sendTransaction(g,{skipPreflight:y});await _t(this.connection,w),f.push(w)}return{txIds:f,signedTxs:o}}return{txIds:await Promise.all(o.map(async f=>await this.connection.sendTransaction(f,{skipPreflight:y}))),signedTxs:o}}if(this.signAllTransactions){let f=await this.signAllTransactions(o);if(p){let g=0,w=[],I=async()=>{if(!f[g])return;let T=await this.connection.sendTransaction(f[g],{skipPreflight:y});w.push({txId:T,status:"sent",signedTx:f[g]}),l==null||l([...w]),g++;let A=!1,k=null,B=null,x=R=>{k!==null&&clearInterval(k),B!==null&&this.connection.removeSignatureListener(B);let h=w.findIndex(C=>C.txId===T);if(h>-1){if(w[h].status==="error"||w[h].status==="success")return;w[h].status=R.err?"error":"success"}l==null||l([...w]),R.err||I()};this.loopMultiTxStatus&&(k=setInterval(async()=>{var R;if(A){clearInterval(k);return}try{let h=await this.connection.getTransaction(T,{commitment:"confirmed",maxSupportedTransactionVersion:0});h&&(A=!0,clearInterval(k),x({err:((R=h.meta)==null?void 0:R.err)||null}),console.log("tx status from getTransaction:",T))}catch(h){A=!0,clearInterval(k),console.error("getTransaction timeout:",h,T)}},Ut)),B=this.connection.onSignature(T,R=>{if(A){this.connection.removeSignatureListener(B);return}A=!0,x(R)},"confirmed"),this.connection.getSignatureStatus(T)};return I(),{txIds:[],signedTxs:f}}else{let g=[];for(let w=0;w<f.length;w+=1){let I=await this.connection.sendTransaction(f[w],{skipPreflight:y});g.push(I)}return{txIds:g,signedTxs:f}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuild(e){var l;let p=e||{},{splitIns:t=[],computeBudgetConfig:n}=p,i=ct(p,["splitIns","computeBudgetConfig"]),s=n?Vt(n):{instructions:[],instructionTypes:[]},o=this.signers.reduce((d,y)=>X(V({},d),{[y.publicKey.toBase58()]:y}),{}),r=[],u=[],a=[],c=0;if(this.allInstructions.forEach(d=>{let y=[...a,d],b=n?[...s.instructions,...y]:y,g=[...new Set(y.map(w=>w.keys.filter(I=>I.isSigner).map(I=>I.pubkey.toString())).flat()).values()].map(w=>new gt(w));if(d!==t[c]&&a.length<12&&(vt({instructions:b,payer:this.feePayer,signers:g})||vt({instructions:y,payer:this.feePayer,signers:g})))a.push(d);else{if(a.length===0)throw Error("item ins too big");c+=d===t[c]?1:0,vt({instructions:n?[...s.instructions,...a]:[...a],payer:this.feePayer,signers:g})?r.push(new Gt().add(...s.instructions,...a)):r.push(new Gt().add(...a)),u.push(Array.from(new Set(a.map(w=>w.keys.filter(I=>I.isSigner).map(I=>I.pubkey.toString())).flat())).map(w=>o[w]).filter(w=>w!==void 0)),a=[d]}}),a.length>0){let y=[...new Set(a.map(b=>b.keys.filter(f=>f.isSigner).map(f=>f.pubkey.toString())).flat()).values()].map(b=>o[b]).filter(b=>b!==void 0);vt({instructions:n?[...s.instructions,...a]:[...a],payer:this.feePayer,signers:y.map(b=>b.publicKey)})?r.push(new Gt().add(...s.instructions,...a)):r.push(new Gt().add(...a)),u.push(y)}return r.forEach(d=>d.feePayer=this.feePayer),(l=this.owner)!=null&&l.signer&&u.forEach(d=>{d.some(y=>y.publicKey.equals(this.owner.publicKey))||d.push(this.owner.signer)}),{builder:this,transactions:r,signers:u,instructionTypes:this.instructionTypes,execute:async d=>{var T;let{sequentially:y,onTxUpdate:b,skipTxCount:f=0,recentBlockHash:g,skipPreflight:w=!0}=d||{},I=g!=null?g:await yt(this.connection,this.blockhashCommitment);if(r.forEach(async(A,k)=>{A.recentBlockhash=I,u[k].length&&A.sign(...u[k])}),mt(r),(T=this.owner)!=null&&T.isKeyPair){if(y){let A=0,k=[];for(let B of r){if(++A,A<=f){k.push("tx skipped");continue}let x=await Hn(this.connection,B,this.signers.find(R=>R.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:w});k.push(x)}return{txIds:k,signedTxs:r}}return{txIds:await Promise.all(r.map(async A=>await this.connection.sendRawTransaction(A.serialize(),{skipPreflight:w}))),signedTxs:r}}if(this.signAllTransactions){let A=await this.signAllTransactions(r.slice(f,r.length)),k=[...r.slice(0,f),...A];if(y){let B=0,x=[],R=async()=>{if(!k[B])return;B<f&&(x.push({txId:"",status:"success",signedTx:k[B]}),b==null||b([...x]),B++,R());let h=await this.connection.sendRawTransaction(k[B].serialize(),{skipPreflight:w});x.push({txId:h,status:"sent",signedTx:k[B]}),b==null||b([...x]),B++;let C=!1,E=null,O=null,_=j=>{E!==null&&clearInterval(E),O!==null&&this.connection.removeSignatureListener(O);let D=x.findIndex(we=>we.txId===h);if(D>-1){if(x[D].status==="error"||x[D].status==="success")return;x[D].status=j.err?"error":"success"}b==null||b([...x]),j.err||R()};this.loopMultiTxStatus&&(E=setInterval(async()=>{var j;if(C){clearInterval(E);return}try{let D=await this.connection.getTransaction(h,{commitment:"confirmed",maxSupportedTransactionVersion:0});D&&(C=!0,clearInterval(E),_({err:((j=D.meta)==null?void 0:j.err)||null}),console.log("tx status from getTransaction:",h))}catch(D){C=!0,clearInterval(E),console.error("getTransaction timeout:",D,h)}},Ut)),O=this.connection.onSignature(h,j=>{if(C){this.connection.removeSignatureListener(O);return}C=!0,_(j)},"confirmed"),this.connection.getSignatureStatus(h)};return await R(),{txIds:x.map(h=>h.txId),signedTxs:k}}else{let B=[];for(let x=0;x<k.length;x+=1){let R=await this.connection.sendRawTransaction(k[x].serialize(),{skipPreflight:w});B.push(R)}return{txIds:B,signedTxs:k}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:i||{}}}async sizeCheckBuildV0(e){var I;let w=e||{},{computeBudgetConfig:t,splitIns:n=[],lookupTableCache:i={},lookupTableAddress:s=[]}=w,o=ct(w,["computeBudgetConfig","splitIns","lookupTableCache","lookupTableAddress"]),r=V(V({},this.cluster==="devnet"?await dn(this.connection):qt),i),u=Array.from(new Set([...this.lookupTableAddress,...s])),a=[];for(let T of u)r[T]===void 0&&a.push(new gt(T));let c=await pn({connection:this.connection,address:a});for(let[T,A]of Object.entries(c))r[T]=A;let p=t?Vt(t):{instructions:[],instructionTypes:[]},l=await yt(this.connection,this.blockhashCommitment),d=this.signers.reduce((T,A)=>X(V({},T),{[A.publicKey.toBase58()]:A}),{}),y=[],b=[],f=[],g=0;if(this.allInstructions.forEach(T=>{let A=[...f,T],k=t?[...p.instructions,...A]:A;if(T!==n[g]&&f.length<12&&(et({instructions:k,payer:this.feePayer,lookupTableAddressAccount:r})||et({instructions:A,payer:this.feePayer,lookupTableAddressAccount:r})))f.push(T);else{if(f.length===0)throw Error("item ins too big");g+=T===n[g]?1:0;let B={};for(let x of[...new Set(u)])r[x]!==void 0&&(B[x]=r[x]);if(t&&et({instructions:[...p.instructions,...f],payer:this.feePayer,lookupTableAddressAccount:r,recentBlockhash:l})){let x=new tt({payerKey:this.feePayer,recentBlockhash:l,instructions:[...p.instructions,...f]}).compileToV0Message(Object.values(r));y.push(new nt(x))}else{let x=new tt({payerKey:this.feePayer,recentBlockhash:l,instructions:[...f]}).compileToV0Message(Object.values(r));y.push(new nt(x))}b.push(Array.from(new Set(f.map(x=>x.keys.filter(R=>R.isSigner).map(R=>R.pubkey.toString())).flat())).map(x=>d[x]).filter(x=>x!==void 0)),f=[T]}}),f.length>0){let A=[...new Set(f.map(k=>k.keys.filter(B=>B.isSigner).map(B=>B.pubkey.toString())).flat()).values()].map(k=>d[k]).filter(k=>k!==void 0);if(t&&et({instructions:[...p.instructions,...f],payer:this.feePayer,lookupTableAddressAccount:r,recentBlockhash:l})){let k=new tt({payerKey:this.feePayer,recentBlockhash:l,instructions:[...p.instructions,...f]}).compileToV0Message(Object.values(r));y.push(new nt(k))}else{let k=new tt({payerKey:this.feePayer,recentBlockhash:l,instructions:[...f]}).compileToV0Message(Object.values(r));y.push(new nt(k))}b.push(A)}return(I=this.owner)!=null&&I.signer&&b.forEach(T=>{T.some(A=>A.publicKey.equals(this.owner.publicKey))||T.push(this.owner.signer)}),y.forEach((T,A)=>{T.sign(b[A])}),{builder:this,transactions:y,buildProps:e,signers:b,blockHash:l,instructionTypes:this.instructionTypes,execute:async T=>{var h;let{sequentially:A,onTxUpdate:k,skipTxCount:B=0,recentBlockHash:x,skipPreflight:R=!0}=T||{};if(y.map(async(C,E)=>{b[E].length&&C.sign(b[E]),x&&(C.message.recentBlockhash=x)}),mt(y),(h=this.owner)!=null&&h.isKeyPair){if(A){let C=0,E=[];for(let O of y){if(++C,C<=B){console.log("skip tx: ",C),E.push("tx skipped");continue}let _=await this.connection.sendTransaction(O,{skipPreflight:R});await _t(this.connection,_),E.push(_)}return{txIds:E,signedTxs:y}}return{txIds:await Promise.all(y.map(async C=>await this.connection.sendTransaction(C,{skipPreflight:R}))),signedTxs:y}}if(this.signAllTransactions){let C=await this.signAllTransactions(y.slice(B,y.length)),E=[...y.slice(0,B),...C];if(A){let O=0,_=[],j=async()=>{if(!E[O])return;if(O<B){_.push({txId:"",status:"success",signedTx:E[O]}),k==null||k([..._]),O++,j();return}let D=await this.connection.sendTransaction(E[O],{skipPreflight:R});_.push({txId:D,status:"sent",signedTx:E[O]}),k==null||k([..._]),O++;let we=!1,Se=null,Fe=null,ut=Te=>{Se!==null&&clearInterval(Se),Fe!==null&&this.connection.removeSignatureListener(Fe);let fe=_.findIndex(Ln=>Ln.txId===D);if(fe>-1){if(_[fe].status==="error"||_[fe].status==="success")return;_[fe].status=Te.err?"error":"success"}k==null||k([..._]),Te.err||j()};this.loopMultiTxStatus&&(Se=setInterval(async()=>{var Te;if(we){clearInterval(Se);return}try{let fe=await this.connection.getTransaction(D,{commitment:"confirmed",maxSupportedTransactionVersion:0});fe&&(we=!0,clearInterval(Se),ut({err:((Te=fe.meta)==null?void 0:Te.err)||null}),console.log("tx status from getTransaction:",D))}catch(fe){we=!0,clearInterval(Se),console.error("getTransaction timeout:",fe,D)}},Ut)),Fe=this.connection.onSignature(D,Te=>{if(we){this.connection.removeSignatureListener(Fe);return}we=!0,ut(Te)},"confirmed"),this.connection.getSignatureStatus(D)};return j(),{txIds:[],signedTxs:E}}else{let O=[];for(let _=0;_<E.length;_+=1){let j=await this.connection.sendTransaction(E[_],{skipPreflight:R});O.push(j)}return{txIds:O,signedTxs:E}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:o||{}}}async buildSniperTransaction(e){var I;let w=e||{},{computeBudgetConfig:t,splitIns:n=[],lookupTableCache:i={},lookupTableAddress:s=[]}=w,o=ct(w,["computeBudgetConfig","splitIns","lookupTableCache","lookupTableAddress"]),r=V(V({},this.cluster==="devnet"?await dn(this.connection):qt),i),u=Array.from(new Set([...this.lookupTableAddress,...s])),a=[];for(let T of u)r[T]===void 0&&a.push(new gt(T));let c=await pn({connection:this.connection,address:a});for(let[T,A]of Object.entries(c))r[T]=A;let p=t?Vt(t):{instructions:[],instructionTypes:[]},l=await yt(this.connection,this.blockhashCommitment),d=this.signers.reduce((T,A)=>X(V({},T),{[A.publicKey.toBase58()]:A}),{}),y=[],b=[],f=[],g=0;if(this.allInstructions.forEach(T=>{let A=[...f,T],k=t?[...p.instructions,...A]:A;if(T!==n[g]&&f.length<12&&(et({instructions:k,payer:this.feePayer,lookupTableAddressAccount:r})||et({instructions:A,payer:this.feePayer,lookupTableAddressAccount:r})))f.push(T);else{if(f.length===0)throw Error("item ins too big");g+=T===n[g]?1:0;let B={};for(let x of[...new Set(u)])r[x]!==void 0&&(B[x]=r[x]);if(t&&et({instructions:[...p.instructions,...f],payer:this.feePayer,lookupTableAddressAccount:r,recentBlockhash:l})){let x=new tt({payerKey:this.feePayer,recentBlockhash:l,instructions:[...p.instructions,...f]}).compileToV0Message(Object.values(r));y.push(new nt(x))}else{let x=new tt({payerKey:this.feePayer,recentBlockhash:l,instructions:[...f]}).compileToV0Message(Object.values(r));y.push(new nt(x))}b.push(Array.from(new Set(f.map(x=>x.keys.filter(R=>R.isSigner).map(R=>R.pubkey.toString())).flat())).map(x=>d[x]).filter(x=>x!==void 0)),f=[T]}}),f.length>0){let A=[...new Set(f.map(k=>k.keys.filter(B=>B.isSigner).map(B=>B.pubkey.toString())).flat()).values()].map(k=>d[k]).filter(k=>k!==void 0);if(t&&et({instructions:[...p.instructions,...f],payer:this.feePayer,lookupTableAddressAccount:r,recentBlockhash:l})){let k=new tt({payerKey:this.feePayer,recentBlockhash:l,instructions:[...p.instructions,...f]}).compileToV0Message(Object.values(r));y.push(new nt(k))}else{let k=new tt({payerKey:this.feePayer,recentBlockhash:l,instructions:[...f]}).compileToV0Message(Object.values(r));y.push(new nt(k))}b.push(A)}return(I=this.owner)!=null&&I.signer&&b.forEach(T=>{T.some(A=>A.publicKey.equals(this.owner.publicKey))||T.push(this.owner.signer)}),y.forEach((T,A)=>{T.sign(b[A])}),{builder:this,transactions:y,buildProps:e,signers:b,instructionTypes:this.instructionTypes,execute:async T=>{var h;let{sequentially:A,onTxUpdate:k,skipTxCount:B=0,recentBlockHash:x,skipPreflight:R=!0}=T||{};if(y.map(async(C,E)=>{b[E].length&&C.sign(b[E]),x&&(C.message.recentBlockhash=x)}),mt(y),(h=this.owner)!=null&&h.isKeyPair){if(A){let C=0,E=[];for(let O of y){if(++C,C<=B){console.log("skip tx: ",C),E.push("tx skipped");continue}let _=await this.connection.sendTransaction(O,{skipPreflight:R});await _t(this.connection,_),E.push(_)}return{txIds:E,signedTxs:y}}return{txIds:await Promise.all(y.map(async C=>await this.connection.sendTransaction(C,{skipPreflight:R}))),signedTxs:y}}if(this.signAllTransactions){let C=await this.signAllTransactions(y.slice(B,y.length)),E=[...y.slice(0,B),...C];if(A){let O=0,_=[],j=async()=>{if(!E[O])return;if(O<B){_.push({txId:"",status:"success",signedTx:E[O]}),k==null||k([..._]),O++,j();return}let D=await this.connection.sendTransaction(E[O],{skipPreflight:R});_.push({txId:D,status:"sent",signedTx:E[O]}),k==null||k([..._]),O++;let we=!1,Se=null,Fe=null,ut=Te=>{Se!==null&&clearInterval(Se),Fe!==null&&this.connection.removeSignatureListener(Fe);let fe=_.findIndex(Ln=>Ln.txId===D);if(fe>-1){if(_[fe].status==="error"||_[fe].status==="success")return;_[fe].status=Te.err?"error":"success"}k==null||k([..._]),Te.err||j()};this.loopMultiTxStatus&&(Se=setInterval(async()=>{var Te;if(we){clearInterval(Se);return}try{let fe=await this.connection.getTransaction(D,{commitment:"confirmed",maxSupportedTransactionVersion:0});fe&&(we=!0,clearInterval(Se),ut({err:((Te=fe.meta)==null?void 0:Te.err)||null}),console.log("tx status from getTransaction:",D))}catch(fe){we=!0,clearInterval(Se),console.error("getTransaction timeout:",fe,D)}},Ut)),Fe=this.connection.onSignature(D,Te=>{if(we){this.connection.removeSignatureListener(Fe);return}we=!0,ut(Te)},"confirmed"),this.connection.getSignatureStatus(D)};return j(),{txIds:[],signedTxs:E}}else{let O=[];for(let _=0;_<E.length;_+=1){let j=await this.connection.sendTransaction(E[_],{skipPreflight:R});O.push(j)}return{txIds:O,signedTxs:E}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:o||{}}}};import Io from"bn.js";var Bo=new Io(1e6);import{PublicKey as Eo}from"@solana/web3.js";import Xi,{isBN as zi}from"bn.js";import{bits as fl,BitStructure as bl,blob as So,Blob as yl,cstr as gl,f32 as Pl,f32be as kl,f64 as Al,f64be as wl,greedy as Tl,Layout as Ko,ns64 as hl,ns64be as xl,nu64 as Il,nu64be as Bl,offset as Sl,s16 as Kl,s16be as Cl,s24 as Ll,s24be as Rl,s32 as Co,s32be as Nl,s40 as Ml,s40be as Ol,s48 as El,s48be as Wl,s8 as Fl,seq as Lo,struct as Vl,Structure as Ro,u16 as No,u16be as _l,u24 as vl,u24be as Dl,u32 as ql,u32be as Gl,u40 as Ul,u40be as Xl,u48 as zl,u48be as Ql,u8 as Mo,UInt as Oo,union as Hl,Union as jl,unionLayoutDiscriminator as Yl,utf8 as Zl}from"@solana/buffer-layout";var jn=Ko,qi=Ro;var Yn=Oo;var Gi=Mo,Pt=No;var ue=Co;var Ui=Lo;var Pe=So;var Ct=class extends jn{constructor(t,n,i){super(t,i);this.blob=Pe(t),this.signed=n}decode(t,n=0){let i=new Xi(this.blob.decode(t,n),10,"le");return this.signed?i.fromTwos(this.span*8).clone():i}encode(t,n,i=0){return typeof t=="number"&&(t=new Xi(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),n,i)}};function G(m){return new Yn(1,m)}function Ne(m){return new Yn(4,m)}function P(m){return new Ct(8,!1,m)}function U(m){return new Ct(16,!1,m)}function Qi(m){return new Ct(8,!0,m)}function Hi(m){return new Ct(16,!0,m)}var fn=class extends jn{constructor(t,n,i,s){super(t.span,s);this.layout=t,this.decoder=n,this.encoder=i}decode(t,n){return this.decoder(this.layout.decode(t,n))}encode(t,n,i){return this.layout.encode(this.encoder(t),n,i)}getSpan(t,n){return this.layout.getSpan(t,n)}};function L(m){return new fn(Pe(32),e=>new Eo(e),e=>e.toBuffer(),m)}function he(m){return new fn(Gi(),Wo,Fo,m)}function Wo(m){if(m===0)return!1;if(m===1)return!0;throw new Error("Invalid bool: "+m)}function Fo(m){return m?1:0}var Zn=class extends qi{decode(e,t){return super.decode(e,t)}};function W(m,e,t){return new Zn(m,e,t)}function Z(m,e,t){let n,i=typeof e=="number"?e:zi(e)?e.toNumber():new Proxy(e,{get(s,o){if(!n){let r=Reflect.get(s,"count");n=zi(r)?r.toNumber():r,Reflect.set(s,"count",n)}return Reflect.get(s,o)},set(s,o,r){return o==="count"&&(n=r),Reflect.set(s,o,r)}});return Ui(m,i,t)}import{PublicKey as pd}from"@solana/web3.js";import fd from"bn.js";import yd from"decimal.js";import{AccountLayout as kd,createAssociatedTokenAccountIdempotentInstruction as Ad,TOKEN_2022_PROGRAM_ID as wd,TOKEN_PROGRAM_ID as Td}from"@solana/spl-token";import{PublicKey as pm}from"@solana/web3.js";import{MintLayout as fm,TOKEN_PROGRAM_ID as ym}from"@solana/spl-token";var ji=m=>new Re({mint:m.address,decimals:m.decimals,symbol:m.symbol,name:m.name}),zt=i=>{var s=i,{amount:m,isRaw:e,name:t}=s,n=ct(s,["amount","isRaw","name"]);return new se(new Re({mint:Ge(n.address).toBase58(),decimals:n.decimals,symbol:n.symbol,name:t}),m,e,t)};var kt=i=>{var s=i,{address:m,programId:e,decimals:t}=s,n=ct(s,["address","programId","decimals"]);return V({chainId:101,address:Ge(m).toBase58(),programId:e,logoURI:"",symbol:"",name:"",decimals:t,tags:[],extensions:n.extensions||{}},n)};var Jn=(...m)=>m.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),Lt=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=re(t)}createTxBuilder(e){return this.scope.checkOwner(),new Xt({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,cluster:this.scope.cluster,owner:this.scope.owner,blockhashCommitment:this.scope.blockhashCommitment,loopMultiTxStatus:this.scope.loopMultiTxStatus,api:this.scope.api,signAllTransactions:this.scope.signAllTransactions})}createSniperTxBuilder(e,t){let n=new ze(e);return new Xt({connection:this.scope.connection,feePayer:t,cluster:this.scope.cluster,owner:n,blockhashCommitment:this.scope.blockhashCommitment,loopMultiTxStatus:this.scope.loopMultiTxStatus,api:this.scope.api,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(Jn(e))}logInfo(...e){this.logger.info(Jn(e))}logAndCreateError(...e){let t=Jn(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{Keypair as wn,PublicKey as K,SystemProgram as st,TransactionInstruction as Ie}from"@solana/web3.js";import ci from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Jt,TOKEN_2022_PROGRAM_ID as de,TOKEN_PROGRAM_ID as ie}from"@solana/spl-token";import Qo from"bn.js";import Mt from"decimal.js";import Ve from"bn.js";var me=new Ve(0),Me=new Ve(1),it=new Ve(-1),Oe=new Ve(1).shln(64),bn=new Ve(1).shln(128),$n=Oe.sub(Me),Qt=64,Yi=bn.subn(1),Be=-443636,Ke=-Be,Qe=new Ve("4295048016"),He=new Ve("79226673521066979257578248091"),yn=new Ve("4295048017"),gn=new Ve("79226673521066979257578248090"),Zi=16,Ji="59543866431248",$i="184467440737095516",er="15793534762490258745",Pn=new Ve(10).pow(new Ve(6));var Km=new Ve("18446744073700000000");import H from"bn.js";import Ye from"decimal.js";function kn(m){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,m,!1),new Uint8Array(e)}function ei(m,e){let t=0;for(let n=m-1;n>=0&&!e.testn(n);n--)t++;return t}function ti(m,e){let t=0;for(let n=0;n<m&&!e.testn(n);n++)t++;return t}function Ht(m,e){for(let t=0;t<m;t++)if(e.testn(t))return!1;return!0}function tr(m,e){return Ht(m,e)?null:ei(m,e)}function nr(m,e){return Ht(m,e)?null:ti(m,e)}var Om=Buffer.from("amm_config","utf8"),Vo=Buffer.from("pool","utf8"),_o=Buffer.from("pool_vault","utf8"),vo=Buffer.from("pool_reward_vault","utf8"),ir=Buffer.from("position","utf8"),Do=Buffer.from("tick_array","utf8"),qo=Buffer.from("operation","utf8"),Go=Buffer.from("pool_tick_array_bitmap_extension","utf8"),Uo=Buffer.from("observation","utf8");function rr(m,e,t,n){return ge([Vo,e.toBuffer(),t.toBuffer(),n.toBuffer()],m)}function ni(m,e,t){return ge([_o,e.toBuffer(),t.toBuffer()],m)}function or(m,e,t){return ge([vo,e.toBuffer(),t.toBuffer()],m)}function ne(m,e,t){return ge([Do,e.toBuffer(),kn(t)],m)}function rt(m,e,t,n){return ge([ir,e.toBuffer(),kn(t),kn(n)],m)}function Le(m,e){return ge([ir,e.toBuffer()],m)}function Rt(m){return ge([Buffer.from("metadata","utf8"),lt.toBuffer(),m.toBuffer()],lt)}function An(m){return ge([qo],m)}function ke(m,e){return ge([Go,e.toBuffer()],m)}function sr(m,e){return ge([Uo,e.toBuffer()],m)}var ar=Buffer.from("locked_position","utf8");function ii(m,e){return ge([ar,e.toBuffer()],m)}function ri(m,e){return ge([ar,e.toBuffer()],m)}var Em=Buffer.from("support_mint","utf8");import{PublicKey as Ee}from"@solana/web3.js";import{TOKEN_2022_PROGRAM_ID as ur}from"@solana/spl-token";import ce from"bn.js";import $ from"decimal.js";import je from"bn.js";import oi from"decimal.js";var jt=class{static getfeeGrowthInside(e,t,n){let i=new je(0),s=new je(0);e.tickCurrent>=t.tick?(i=t.feeGrowthOutsideX64A,s=t.feeGrowthOutsideX64B):(i=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),s=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let o=new je(0),r=new je(0);e.tickCurrent<n.tick?(o=n.feeGrowthOutsideX64A,r=n.feeGrowthOutsideX64B):(o=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),r=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let u=Q.wrappingSubU128(Q.wrappingSubU128(e.feeGrowthGlobalX64A,i),o),a=Q.wrappingSubU128(Q.wrappingSubU128(e.feeGrowthGlobalX64B,s),r);return{feeGrowthInsideX64A:u,feeGrowthInsideBX64:a}}static GetPositionFees(e,t,n,i){let{feeGrowthInsideX64A:s,feeGrowthInsideBX64:o}=this.getfeeGrowthInside(e,n,i),r=Q.mulDivFloor(Q.wrappingSubU128(s,t.feeGrowthInsideLastX64A),t.liquidity,Oe),u=t.tokenFeesOwedA.add(r),a=Q.mulDivFloor(Q.wrappingSubU128(o,t.feeGrowthInsideLastX64B),t.liquidity,Oe),c=t.tokenFeesOwedB.add(a);return{tokenFeeAmountA:u,tokenFeeAmountB:c}}static GetPositionFeesV2(e,t,n,i){let{feeGrowthInsideX64A:s,feeGrowthInsideBX64:o}=this.getfeeGrowthInside(e,n,i),r=Q.mulDivFloor(Q.wrappingSubU128(s,t.feeGrowthInsideLastX64A),t.liquidity,Oe),u=t.tokenFeesOwedA.add(r),a=Q.mulDivFloor(Q.wrappingSubU128(o,t.feeGrowthInsideLastX64B),t.liquidity,Oe),c=t.tokenFeesOwedB.add(a);return{tokenFeeAmountA:u,tokenFeeAmountB:c}}static GetPositionRewardsV2(e,t,n,i){let s=[],o=this.getRewardGrowthInsideV2(e.tickCurrent,n,i,e.rewardInfos);for(let r=0;r<o.length;r++){let u=o[r],a=t.rewardInfos[r],c=Q.wrappingSubU128(u,a.growthInsideLastX64),p=Q.mulDivFloor(c,t.liquidity,Oe),l=a.rewardAmountOwed.add(p);s.push(l)}return s}static GetPositionRewards(e,t,n,i){let s=[],o=this.getRewardGrowthInside(e.tickCurrent,n,i,e.rewardInfos);for(let r=0;r<o.length;r++){let u=o[r],a=t.rewardInfos[r],c=Q.wrappingSubU128(u,a.growthInsideLastX64),p=Q.mulDivFloor(c,t.liquidity,Oe),l=a.rewardAmountOwed.add(p);s.push(l)}return s}static getRewardGrowthInside(e,t,n,i){let s=[];for(let o=0;o<i.length;o++){let r=new je(0);t.liquidityGross.eqn(0)?r=i[o].rewardGrowthGlobalX64:e<t.tick?r=i[o].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[o]):r=t.rewardGrowthsOutsideX64[o];let u=new je(0);n.liquidityGross.eqn(0)||(e<n.tick?u=n.rewardGrowthsOutsideX64[o]:u=i[o].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[o])),s.push(Q.wrappingSubU128(Q.wrappingSubU128(i[o].rewardGrowthGlobalX64,r),u))}return s}static getRewardGrowthInsideV2(e,t,n,i){let s=[];for(let o=0;o<i.length;o++){let r=new je(0);t.liquidityGross.eqn(0)?r=i[o].rewardGrowthGlobalX64:e<t.tick?r=i[o].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[o]):r=t.rewardGrowthsOutsideX64[o];let u=new je(0);n.liquidityGross.eqn(0)||(e<n.tick?u=n.rewardGrowthsOutsideX64[o]:u=i[o].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[o])),s.push(Q.wrappingSubU128(Q.wrappingSubU128(i[o].rewardGrowthGlobalX64,r),u))}return s}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:i,add:s,epochInfo:o}){var f,g,w,I;let r=z.priceToSqrtPriceX64(new oi(e.price),e.mintA.decimals,e.mintB.decimals),u=z.getSqrtPriceX64FromTick(t.tickLower),a=z.getSqrtPriceX64FromTick(t.tickUpper),c=s?1+i:1-i,p=ee.getAmountsFromLiquidity(r,u,a,n,s),[l,d]=[be(p.amountA,(f=e.mintA.extensions)==null?void 0:f.feeConfig,o,!0),be(p.amountB,(g=e.mintB.extensions)==null?void 0:g.feeConfig,o,!0)],[y,b]=[be(new je(new oi(p.amountA.toString()).mul(c).toFixed(0)),(w=e.mintA.extensions)==null?void 0:w.feeConfig,o,!0),be(new je(new oi(p.amountB.toString()).mul(c).toFixed(0)),(I=e.mintB.extensions)==null?void 0:I.feeConfig,o,!0)];return{liquidity:n,amountA:l,amountB:d,amountSlippageA:y,amountSlippageB:b,expirationTime:De(l.expirationTime,d.expirationTime)}}};var Xo=15,J=class{static async getTickArrays(e,t,n,i,s,o,r){let u=[],a=F.getTickArrayStartIndexByTick(i,s),c=F.getInitializedTickArrayInRange(o,r,s,a,Math.floor(Xo/2));for(let d=0;d<c.length;d++){let{publicKey:y}=ne(t,n,c[d]);u.push(y)}let p=(await Ze(e,u)).map(d=>d!==null?Yt.decode(d.data):null),l={};for(let d=0;d<u.length;d++){let y=p[d];y!==null&&(l[y.startTickIndex]=X(V({},y),{address:u[d]}))}return l}static nextInitializedTick(e,t,n,i,s,o){let{initializedTick:r,tickArrayAddress:u,tickArrayStartTickIndex:a}=this.nextInitializedTickInOneArray(e,t,n,i,s,o);for(;r==null||r.liquidityGross.lten(0);){if(a=F.getNextTickArrayStartIndex(a,s,o),this.checkIsValidStartIndex(a,s))throw new Error("No enough initialized tickArray");let c=n[a];if(c===void 0)continue;let{nextTick:p,tickArrayAddress:l,tickArrayStartTickIndex:d}=this.firstInitializedTickInOneArray(e,t,c,o);[r,u,a]=[p,l,d]}if(r==null)throw new Error("No invaild tickArray cache");return{nextTick:r,tickArrayAddress:u,tickArrayStartTickIndex:a}}static nextInitializedTickArray(e,t,n,i,s){let o=Math.floor(e/J.tickCount(t)),r=n?F.searchLowBitFromStart(i,s,o-1,1,t):F.searchHightBitFromStart(i,s,o+1,1,t);return r.length>0?{isExist:!0,nextStartIndex:r[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,i){let s;if(i){let r=Ae-1;for(;r>=0;){let u=n.ticks[r];if(u.liquidityGross.gtn(0)){s=u;break}r=r-1}}else{let r=0;for(;r<Ae;){let u=n.ticks[r];if(u.liquidityGross.gtn(0)){s=u;break}r=r+1}}let{publicKey:o}=ne(e,t,n.startTickIndex);return{nextTick:s,tickArrayAddress:o,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,i,s,o){let r=F.getTickArrayStartIndexByTick(i,s),u=Math.floor((i-r)/s),a=n[r];if(a==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:r};let c;if(o)for(;u>=0;){let l=a.ticks[u];if(l.liquidityGross.gtn(0)){c=l;break}u=u-1}else for(u=u+1;u<Ae;){let l=a.ticks[u];if(l.liquidityGross.gtn(0)){c=l;break}u=u+1}let{publicKey:p}=ne(e,t,r);return{initializedTick:c,tickArrayAddress:p,tickArrayStartTickIndex:a.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(F.checkIsOutOfBoundary(e)){if(e>Ke)return!1;let n=F.getTickArrayStartIndexByTick(Be,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return Ae*e}};var si=14,ot=class{static maxTickInTickarrayBitmap(e){return e*Ae*At}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(i+=1);let s=n*i;return e<0?{minValue:-s,maxValue:-s+n}:{minValue:s,maxValue:s+n}}static nextInitializedTickArrayStartIndex(e,t,n,i){if(!J.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let s=this.maxTickInTickarrayBitmap(n),o=i?t-J.tickCount(n):t+J.tickCount(n);if(o<-s||o>=s)return{isInit:!1,tickIndex:t};let r=n*Ae,u=o/r+512;o<0&&o%r!=0&&u--;let a=Math.abs(u);if(i){let c=e.shln(1024-a-1),p=tr(1024,c);if(p!==null){let l=(a-p-512)*r;return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:-s}}else{let c=e.shrn(a),p=nr(1024,c);if(p!==null){let l=(a+p-512)*r;return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-J.tickCount(n)}}}},Zt=class{static getBitmapOffset(e,t){if(!J.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=ot.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&i--,i}static getBitmap(e,t,n){let i=this.getBitmapOffset(e,t);return e<0?{offset:i,tickarrayBitmap:n.negativeTickArrayBitmap[i]}:{offset:i,tickarrayBitmap:n.positiveTickArrayBitmap[i]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:i}=this.extensionTickBoundary(t);if(e>=i&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=ot.maxTickInTickarrayBitmap(e),n=-t;if(Ke<=t)throw Error(`extensionTickBoundary check error: ${Ke}, ${t}`);if(n<=Be)throw Error(`extensionTickBoundary check error: ${n}, ${Be}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:i}=this.getBitmap(e,t,n),s=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:F.mergeTickArrayBitmap(i).testn(s),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,i){let s=J.tickCount(t),o=n?e-s:e+s,{tickarrayBitmap:r}=this.getBitmap(o,t,i);return this.nextInitializedTickArrayInBitmap(r,o,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,i){let{minValue:s,maxValue:o}=ot.getBitmapTickBoundary(t,n),r=this.tickArrayOffsetInBitmap(t,n);if(i){let u=F.mergeTickArrayBitmap(e).shln(At-1-r),a=Ht(512,u)?null:ei(512,u);if(a!==null){let c=t-a*J.tickCount(n);return{isInit:!0,tickIndex:c}}else return{isInit:!1,tickIndex:s}}else{let u=F.mergeTickArrayBitmap(e).shrn(r),a=Ht(512,u)?null:ti(512,u);if(a!==null){let c=t+a*J.tickCount(n);return{isInit:!0,tickIndex:c}}else return{isInit:!1,tickIndex:o-J.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%ot.maxTickInTickarrayBitmap(t),i=Math.floor(n/J.tickCount(t));return e<0&&n!=0&&(i=At-i),i}};var pe=class{static getOutputAmountAndRemainAccounts(e,t,n,i,s,o=!1){let r=n.toBase58()===e.mintA.address,u=[],{isExist:a,startIndex:c,nextAccountMeta:p}=this.getFirstInitializedTickArray(e,r);if(!a||c===void 0||!p)throw new Error("Invalid tick array");u.push(p);let{allTrade:l,amountCalculated:d,accounts:y,sqrtPriceX64:b,feeAmount:f}=wt.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,r,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i,c,s,o);return u.push(...y),{allTrade:l,expectedAmountOut:d.mul(it),remainingAccounts:u,executionPrice:b,feeAmount:f}}static getInputAmountAndRemainAccounts(e,t,n,i,s){let o=n.toBase58()===e.mintB.address,r=[],{isExist:u,startIndex:a,nextAccountMeta:c}=this.getFirstInitializedTickArray(e,o);if(!u||a===void 0||!c)throw new Error("Invalid tick array");try{let b=this.preInitializedTickArrayStartIndex(e,o);if(b.isExist){let{publicKey:f}=ne(e.programId,e.id,b.nextStartIndex);r.push(f)}}catch{}r.push(c);let{amountCalculated:p,accounts:l,sqrtPriceX64:d,feeAmount:y}=wt.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,o,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i.mul(it),a,s);return r.push(...l),{expectedAmountIn:p,remainingAccounts:r,executionPrice:d,feeAmount:y}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:i}=pe.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?Zt.checkTickArrayIsInit(J.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):F.checkTickArrayIsInitialized(F.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:r}=ne(e.programId,e.id,i);return{isExist:!0,startIndex:i,nextAccountMeta:r}}let{isExist:s,nextStartIndex:o}=this.nextInitializedTickArrayStartIndex(e,J.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(s){let{publicKey:r}=ne(e.programId,e.id,o);return{isExist:!0,startIndex:o,nextAccountMeta:r}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/J.tickCount(e.tickSpacing)),i=t?F.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):F.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return i.length>0?{isExist:!0,nextStartIndex:i[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=J.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:i,tickIndex:s}=ot.nextInitializedTickArrayStartIndex(F.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(i)return{isExist:!0,nextStartIndex:s};t=s;let{isInit:o,tickIndex:r}=Zt.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(o)return{isExist:!0,nextStartIndex:r};if(t=r,t<Be||t>Ke)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:i,rewardInfos:s}){var r,u,a;let o=[];for(let c=0;c<s.length;c++){let p=s[c],l=(a=(r=t.rewardDefaultInfos[c])==null?void 0:r.mint.programId)!=null?a:(u=await e.getAccountInfo(p.tokenMint))==null?void 0:u.owner;if(l===void 0)throw Error("get new reward mint info error");let d=X(V({},p),{perSecond:Q.x64ToDecimal(p.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new Ee(l)});if(d.tokenMint.equals(Ee.default))continue;if(n<=d.openTime.toNumber()||i.eq(me)){o.push(d);continue}let y=new ce(Math.min(d.endTime.toNumber(),n)),b=y.sub(d.lastUpdateTime),f=Q.mulDivFloor(b,d.emissionsPerSecondX64,i),g=d.rewardGrowthGlobalX64.add(f),w=Q.mulDivFloor(b,d.emissionsPerSecondX64,Oe),I=d.rewardTotalEmissioned.add(w);o.push(X(V({},d),{rewardGrowthGlobalX64:g,rewardTotalEmissioned:I,lastUpdateTime:y}))}return o}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:i}=this.tickRange(e);for(let s of t){let o=F.getTickArrayStartIndexByTick(s,e);if(o>=n||o<i)return!0}return!1}static tickRange(e){let t=ot.maxTickInTickarrayBitmap(e),n=-t;return t>Ke&&(t=J.getArrayStartIndex(Ke,e)+J.tickCount(e)),n<Be&&(n=J.getArrayStartIndex(Be,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!J.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/J.tickCount(t)*At}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let i=await ft(e,t.map(o=>({pubkey:o})),{batchRequest:n}),s={};for(let o of i)o.accountInfo!==null&&(s[o.pubkey.toString()]=cr.decode(o.accountInfo.data));return s}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let i={},s=[];for(let u of t){let a=F.getTickArrayStartIndexByTick(u.tickCurrent,u.tickSpacing),c=F.getInitializedTickArrayInRange(u.tickArrayBitmap,u.exBitmapInfo,u.tickSpacing,a,7);for(let p of c){let{publicKey:l}=ne(u.programId,u.id,p);s.push({pubkey:l}),i[l.toString()]=u.id}}let o=await ft(e,s,{batchRequest:n}),r={};for(let u of o){if(!u.accountInfo)continue;let a=i[u.pubkey.toString()];if(!a)continue;r[a.toString()]===void 0&&(r[a.toString()]={});let c=Yt.decode(u.accountInfo.data);r[a.toString()][c.startTickIndex]=X(V({},c),{address:u.pubkey})}return r}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:i=!1,updateOwnerRewardAndFee:s=!0}){var r;let o=[];for(let u=0;u<e.length;u++){let a=e[u];a!==null&&(o.find(c=>c.equals(a.state.programId))||o.push(a.state.programId))}if(n){let u=n.tokenAccounts.map(l=>l.accountInfo.mint),a=[];for(let l of u)for(let d of o)a.push(Le(d,l).publicKey);let c=await Ze(t,a,{batchRequest:i}),p={};for(let l of c){if(l===null)continue;let d=ai.decode(l.data),y=d.poolId.toString(),b=e.find(x=>x.state.id.toBase58()===y);if(b===void 0)continue;let f=b.state,g=F._getTickPriceLegacy({poolInfo:f,tick:d.tickLower,baseIn:!0}),w=F._getTickPriceLegacy({poolInfo:f,tick:d.tickUpper,baseIn:!0}),{amountA:I,amountB:T}=ee.getAmountsFromLiquidity(f.sqrtPriceX64,g.tickSqrtPriceX64,w.tickSqrtPriceX64,d.liquidity,!1),A=1/(1-Math.sqrt(Math.sqrt(g.price.div(w.price).toNumber())));b.positionAccount=[...(r=b.positionAccount)!=null?r:[],{poolId:d.poolId,nftMint:d.nftMint,priceLower:g.price,priceUpper:w.price,amountA:I,amountB:T,tickLower:d.tickLower,tickUpper:d.tickUpper,liquidity:d.liquidity,feeGrowthInsideLastX64A:d.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:d.feeGrowthInsideLastX64B,tokenFeesOwedA:d.tokenFeesOwedA,tokenFeesOwedB:d.tokenFeesOwedB,rewardInfos:d.rewardInfos.map(x=>X(V({},x),{pendingReward:new ce(0)})),leverage:A,tokenFeeAmountA:new ce(0),tokenFeeAmountB:new ce(0)}];let k=await F.getTickArrayAddressByTick(b.state.programId,d.poolId,d.tickLower,b.state.tickSpacing),B=await F.getTickArrayAddressByTick(b.state.programId,d.poolId,d.tickUpper,b.state.tickSpacing);p[`${b.state.programId.toString()}-${d.poolId.toString()}-${d.tickLower}`]=k,p[`${b.state.programId.toString()}-${d.poolId.toString()}-${d.tickUpper}`]=B}if(s){let l=Object.values(p),d=await Ze(t,l,{batchRequest:i}),y={};for(let b=0;b<l.length;b++){let f=d[b];if(f===null)continue;let g=l[b].toString();y[g]=Yt.decode(f.data)}for(let{state:b,positionAccount:f}of e)if(!!f)for(let g of f){let w=`${b.programId.toString()}-${b.id.toString()}-${g.tickLower}`,I=`${b.programId.toString()}-${b.id.toString()}-${g.tickUpper}`,T=y[p[w].toString()],A=y[p[I].toString()],k=T.ticks[F.getTickOffsetInArray(g.tickLower,b.tickSpacing)],B=A.ticks[F.getTickOffsetInArray(g.tickUpper,b.tickSpacing)],{tokenFeeAmountA:x,tokenFeeAmountB:R}=await jt.GetPositionFees(b,g,k,B),h=await jt.GetPositionRewards(b,g,k,B);g.tokenFeeAmountA=x.gte(new ce(0))?x:new ce(0),g.tokenFeeAmountB=R.gte(new ce(0))?R:new ce(0);for(let C=0;C<h.length;C++)g.rewardInfos[C].pendingReward=h[C].gte(new ce(0))?h[C]:new ce(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:i,amountIn:s,slippage:o,priceLimit:r=new $(0),catchLiquidityInsufficient:u=!1}){var E;let a,c=n.toBase58()===e.mintA.address,[p,l]=c?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];r.equals(new $(0))?a=c?Qe.add(new ce(1)):He.sub(new ce(1)):a=z.priceToSqrtPriceX64(r,e.mintA.decimals,e.mintB.decimals);let d=be(s,p,i,!1),{allTrade:y,expectedAmountOut:b,remainingAccounts:f,executionPrice:g,feeAmount:w}=pe.getOutputAmountAndRemainAccounts(e,t,n,d.amount.sub((E=d.fee)!=null?E:me),a,u),I=be(b,l,i,!1),T=z.sqrtPriceX64ToPrice(g,e.mintA.decimals,e.mintB.decimals),A=c?T:new $(1).div(T),k=b.mul(new ce(Math.floor((1-o)*1e10))).div(new ce(1e10)),B=be(k,l,i,!1),x=c?e.currentPrice:new $(1).div(e.currentPrice),R=new $(A).sub(x).abs(),h=x,C=new Je(new $(R).mul(10**15).toFixed(0),new $(h).mul(10**15).toFixed(0));return{allTrade:y,realAmountIn:d,amountOut:I,minAmountOut:B,expirationTime:De(d.expirationTime,I.expirationTime),currentPrice:e.currentPrice,executionPrice:A,priceImpact:C,fee:w,remainingAccounts:f,executionPriceX64:g}}static computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:i,slippage:s,epochInfo:o,catchLiquidityInsufficient:r=!1}){let u=i.address===e.mintB.address,[a,c]=u?[e.mintA,e.mintB]:[e.mintB,e.mintA],[p,l]=[new Re(X(V({},a),{mint:a.address,isToken2022:a.programId===ur.toBase58()})),new Re(X(V({},c),{mint:c.address,isToken2022:c.programId===ur.toBase58()}))],{allTrade:d,realAmountIn:y,amountOut:b,minAmountOut:f,expirationTime:g,currentPrice:w,executionPrice:I,priceImpact:T,fee:A,remainingAccounts:k,executionPriceX64:B}=pe.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new Ee(a.address),amountIn:n,slippage:s,epochInfo:o,catchLiquidityInsufficient:r}),x=X(V({},y),{amount:new se(p,y.amount),fee:y.fee===void 0?void 0:new se(p,y.fee)}),R=X(V({},b),{amount:new se(l,b.amount),fee:b.fee===void 0?void 0:new se(l,b.fee)}),h=X(V({},f),{amount:new se(l,f.amount),fee:f.fee===void 0?void 0:new se(l,f.fee)}),C=new Ce({baseToken:p,denominator:new ce(10).pow(new ce(20+p.decimals)),quoteToken:l,numerator:w.mul(new $(10**(20+l.decimals))).toFixed(0)}),E=new Ce({baseToken:p,denominator:new ce(10).pow(new ce(20+p.decimals)),quoteToken:l,numerator:I.mul(new $(10**(20+l.decimals))).toFixed(0)}),O=new se(p,A);return{allTrade:d,realAmountIn:x,amountOut:R,minAmountOut:h,expirationTime:g,currentPrice:C,executionPrice:E,priceImpact:T,fee:O,remainingAccounts:k,executionPriceX64:B}}static computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:i,amountOut:s,slippage:o,priceLimit:r=new $(0)}){var h;let u=n.toBase58()===e.mintA.address,a={[e.mintA.address]:e.mintA.extensions.feeConfig,[e.mintB.address]:e.mintB.extensions.feeConfig},c;r.equals(new $(0))?c=u?He.sub(new ce(1)):Qe.add(new ce(1)):c=z.priceToSqrtPriceX64(r,e.mintA.decimals,e.mintB.decimals);let p=be(s,a[n.toString()],i,!0),{expectedAmountIn:l,remainingAccounts:d,executionPrice:y,feeAmount:b}=pe.getInputAmountAndRemainAccounts(e,t,n,p.amount.sub((h=p.fee)!=null?h:me),c),f=u?e.mintB.address:e.mintA.address,g=be(l,a[f],i,!1),w=z.sqrtPriceX64ToPrice(y,e.mintA.decimals,e.mintB.decimals),I=u?w:new $(1).div(w),T=l.mul(new ce(Math.floor((1+o)*1e10))).div(new ce(1e10)),A=be(T,a[f],i,!0),k=u?e.currentPrice:new $(1).div(e.currentPrice),B=new $(I).sub(k).abs(),x=k,R=new Je(new $(B).mul(10**15).toFixed(0),new $(x).mul(10**15).toFixed(0));return{amountIn:g,maxAmountIn:A,realAmountOut:p,expirationTime:De(g.expirationTime,p.expirationTime),currentPrice:e.currentPrice,executionPrice:I,priceImpact:R,fee:b,remainingAccounts:d}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:i}){var y,b,f;let s=e[t],o=F.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),r=F.getTickPrice({poolInfo:e,tick:i,baseIn:!0}).price.toNumber(),u=Math.max(o,s.priceMin),c=Math.min(r,s.priceMax)-u,p=r-o,l=s.priceMax-s.priceMin,d;return c<=0?d=0:p===c?d=l/c:l===c?d=c/p:d=c/l*(c/p),{feeApr:s.feeApr*d,rewardsApr:[((y=s.rewardApr[0])!=null?y:0)*d,((b=s.rewardApr[1])!=null?b:0)*d,((f=s.rewardApr[2])!=null?f:0)*d],apr:s.apr*d}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:i,liquidity:s,positionTickLowerIndex:o,positionTickUpperIndex:r,chainTime:u}){let a=n==="day"?1:n==="week"?7:n==="month"?30:0,c=e[n],p=i[Ge(e.mintA.address).toString()],l=i[Ge(e.mintB.address).toString()],d=e.mintA.decimals,y=e.mintB.decimals;if(!c||!p||!l)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let b=z.priceToSqrtPriceX64(new $(e.price),e.mintA.decimals,e.mintB.decimals),f=z.getSqrtPriceX64FromTick(o),g=z.getSqrtPriceX64FromTick(r),{amountSlippageA:w,amountSlippageB:I}=ee.getAmountsFromLiquidityWithSlippage(b,f,g,t,!1,!1,0),{amountSlippageA:T,amountSlippageB:A}=ee.getAmountsFromLiquidityWithSlippage(b,f,g,s,!1,!1,0),k=new $(w.toString()).div(new $(10).pow(d)).mul(p.value).add(new $(I.toString()).div(new $(10).pow(y)).mul(l.value)),B=new $(T.toString()).div(new $(10).pow(d)).mul(p.value).add(new $(A.toString()).div(new $(10).pow(y)).mul(l.value)),x=new $(1).div(k.add(B)),h=new $(c.volumeFee).mul(365).div(a).mul(x).mul(100).toNumber(),C=3600*24*365,E=e.rewardDefaultInfos.map(O=>{var D,we;let _=O.mint.decimals,j=i[O.mint.address];return u<((D=O.startTime)!=null?D:0)||u>((we=O.endTime)!=null?we:0)||!O.perSecond||!j||_===void 0?0:new $(j.value).mul(new $(O.perSecond).mul(C)).div(new $(10).pow(_)).mul(x).mul(100).toNumber()});return{feeApr:h,rewardsApr:E,apr:h+E.reduce((O,_)=>O+_,0)}}static async getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:i,amount:s,slippage:o,add:r,epochInfo:u,amountHasFee:a}){var g,w;let c=z.priceToSqrtPriceX64(new $(e.price),e.mintA.decimals,e.mintB.decimals),p=z.getSqrtPriceX64FromTick(n),l=z.getSqrtPriceX64FromTick(i),d=be(s,(g=e[t?"mintA":"mintB"].extensions)==null?void 0:g.feeConfig,u,!a),y=new ce(new $(d.amount.sub((w=d.fee)!=null?w:me).toString()).toFixed(0)),b;if(c.lte(p))b=t?ee.getLiquidityFromTokenAmountA(p,l,y,!r):new ce(0);else if(c.lte(l)){let I=ee.getLiquidityFromTokenAmountA(c,l,y,!r),T=ee.getLiquidityFromTokenAmountB(p,c,y);b=t?I:T}else b=t?new ce(0):ee.getLiquidityFromTokenAmountB(p,l,y);let f=await pe.getAmountsFromLiquidity({epochInfo:u,poolInfo:e,tickLower:n,tickUpper:i,liquidity:b,slippage:o,add:r});return{liquidity:b,amountA:t?d:f.amountA,amountB:t?f.amountB:d,amountSlippageA:t?d:f.amountSlippageA,amountSlippageB:t?f.amountSlippageB:d,expirationTime:f.expirationTime}}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:i,liquidity:s,slippage:o,add:r}){var f,g,w,I;let u=z.getSqrtPriceX64FromTick(n),a=z.getSqrtPriceX64FromTick(i),c=r?1+o:1-o,p=ee.getAmountsFromLiquidity(z.priceToSqrtPriceX64(new $(t.price),t.mintA.decimals,t.mintB.decimals),u,a,s,r),[l,d]=[be(p.amountA,(f=t.mintA.extensions)==null?void 0:f.feeConfig,e,!0),be(p.amountB,(g=t.mintB.extensions)==null?void 0:g.feeConfig,e,!0)],[y,b]=[be(p.amountA.muln(c),(w=t.mintA.extensions)==null?void 0:w.feeConfig,e,!0),be(p.amountB.muln(c),(I=t.mintB.extensions)==null?void 0:I.feeConfig,e,!0)];return{liquidity:s,amountA:l,amountB:d,amountSlippageA:y,amountSlippageB:b,expirationTime:De(l.expirationTime,d.expirationTime)}}static async fetchComputeMultipleClmmInfo({connection:e,poolList:t,rpcDataMap:n={}}){let i=t.filter(u=>!n[u.id]).map(u=>new Ee(u.id));(await Ze(e,i)).forEach((u,a)=>{!u||(n[i[a].toBase58()]=Nt.decode(u.data))});let o=t.map(u=>ke(new Ee(u.programId),new Ee(u.id)).publicKey),r=await pe.fetchExBitmaps({connection:e,exBitmapAddress:o,batchRequest:!1});return t.reduce((u,a)=>X(V({},u),{[a.id]:X(V({},n[a.id]),{id:new Ee(a.id),version:6,programId:new Ee(a.programId),mintA:a.mintA,mintB:a.mintB,ammConfig:X(V({},a.config),{id:new Ee(a.config.id),fundOwner:""}),currentPrice:new $(a.price),exBitmapAccount:ke(new Ee(a.programId),new Ee(a.id)).publicKey,exBitmapInfo:r[ke(new Ee(a.programId),new Ee(a.id)).publicKey.toBase58()],startTime:n[a.id].startTime.toNumber(),rewardInfos:n[a.id].rewardInfos})}),{})}static async fetchComputeClmmInfo({connection:e,poolInfo:t,rpcData:n}){return(await this.fetchComputeMultipleClmmInfo({connection:e,rpcDataMap:n?{[t.id]:n}:void 0,poolList:[t]}))[t.id]}};var Q=class{static mulDivRoundingUp(e,t,n){let i=e.mul(t),s=i.div(n);return i.mod(n).eq(me)||(s=s.add(Me)),s}static mulDivFloor(e,t,n){if(n.eq(me))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(me))throw new Error("division by 0");return e.mul(t).add(n.sub(Me)).div(n)}static x64ToDecimal(e,t){return new Ye(e.toString()).div(Ye.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new H(e.mul(Ye.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(bn).sub(t).mod(bn)}};function xe(m,e){return ui(m.mul(e),64,256)}function zo(m,e,t){let n=m.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function ui(m,e,t){let n=m.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var z=class{static sqrtPriceX64ToPrice(e,t,n){return Q.x64ToDecimal(e).pow(2).mul(Ye.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return Q.decimalToX64(e.mul(Ye.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,i){if(!e.gt(me))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(me))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,i){if(!e.gt(me))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(me))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,i){if(n.eq(me))return e;let s=t.shln(Qt);if(i){let o=s,r=s.add(n.mul(e));return r.gte(o)?Q.mulDivCeil(o,e,r):Q.mulDivRoundingUp(o,Me,o.div(e).add(n))}else{let o=n.mul(e);if(!s.gt(o))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let r=s.sub(o);return Q.mulDivCeil(s,e,r)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,i){let s=n.shln(Qt);if(i)return e.add(s.div(t));{let o=Q.mulDivRoundingUp(s,Me,t);if(!e.gt(o))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(o)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<Be||e>Ke)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new H("18445821805675395072"):new H("18446744073709551616");return(t&2)!=0&&(n=xe(n,new H("18444899583751176192"))),(t&4)!=0&&(n=xe(n,new H("18443055278223355904"))),(t&8)!=0&&(n=xe(n,new H("18439367220385607680"))),(t&16)!=0&&(n=xe(n,new H("18431993317065453568"))),(t&32)!=0&&(n=xe(n,new H("18417254355718170624"))),(t&64)!=0&&(n=xe(n,new H("18387811781193609216"))),(t&128)!=0&&(n=xe(n,new H("18329067761203558400"))),(t&256)!=0&&(n=xe(n,new H("18212142134806163456"))),(t&512)!=0&&(n=xe(n,new H("17980523815641700352"))),(t&1024)!=0&&(n=xe(n,new H("17526086738831433728"))),(t&2048)!=0&&(n=xe(n,new H("16651378430235570176"))),(t&4096)!=0&&(n=xe(n,new H("15030750278694412288"))),(t&8192)!=0&&(n=xe(n,new H("12247334978884435968"))),(t&16384)!=0&&(n=xe(n,new H("8131365268886854656"))),(t&32768)!=0&&(n=xe(n,new H("3584323654725218816"))),(t&65536)!=0&&(n=xe(n,new H("696457651848324352"))),(t&131072)!=0&&(n=xe(n,new H("26294789957507116"))),(t&262144)!=0&&(n=xe(n,new H("37481735321082"))),e>0&&(n=Yi.div(n)),n}static getTickFromPrice(e,t,n){return z.getTickFromSqrtPriceX64(z.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(He)||e.lt(Qe))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new H(t-64),i=zo(n,32,128),s=new H("8000000000000000","hex"),o=0,r=new H(0),u=t>=64?e.shrn(t-63):e.shln(63-t);for(;s.gt(new H(0))&&o<Zi;){u=u.mul(u);let y=u.shrn(127);u=u.shrn(63+y.toNumber()),r=r.add(s.mul(y)),s=s.shrn(1),o+=1}let a=r.shrn(32),p=i.add(a).mul(new H(Ji)),l=ui(p.sub(new H($i)),64,128).toNumber(),d=ui(p.add(new H(er)),64,128).toNumber();return l==d?l:z.getSqrtPriceX64FromTick(d).lte(e)?d:l}},Tt=class{static getTickWithPriceAndTickspacing(e,t,n,i){let o=z.getTickFromSqrtPriceX64(z.priceToSqrtPriceX64(e,n,i))/t;return o<0?o=Math.floor(o):o=Math.ceil(o),o*t}static roundPriceWithTickspacing(e,t,n,i){let s=Tt.getTickWithPriceAndTickspacing(e,t,n,i),o=z.getSqrtPriceX64FromTick(s);return z.sqrtPriceX64ToPrice(o,n,i)}},ee=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(me))throw new Error("sqrtPriceX64A must greater than 0");let s=n.ushln(Qt),o=t.sub(e);return i?Q.mulDivRoundingUp(Q.mulDivCeil(s,o,t),Me,e):Q.mulDivFloor(s,o,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(me))throw new Error("sqrtPriceX64A must greater than 0");return i?Q.mulDivCeil(n,t.sub(e),Oe):Q.mulDivFloor(n,t.sub(e),Oe)}static getLiquidityFromTokenAmountA(e,t,n,i){e.gt(t)&&([e,t]=[t,e]);let s=n.mul(e).mul(t),o=t.sub(e),r=s.div(o);return i?Q.mulDivRoundingUp(r,Me,$n):r.shrn(Qt)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),Q.mulDivFloor(n,$n,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,i,s){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return ee.getLiquidityFromTokenAmountA(t,n,i,!1);if(e.lt(n)){let o=ee.getLiquidityFromTokenAmountA(e,n,i,!1),r=ee.getLiquidityFromTokenAmountB(t,e,s);return o.lt(r)?o:r}else return ee.getLiquidityFromTokenAmountB(t,n,s)}static getAmountsFromLiquidity(e,t,n,i,s){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:ee.getTokenAmountAFromLiquidity(t,n,i,s),amountB:new H(0)};if(e.lt(n)){let o=ee.getTokenAmountAFromLiquidity(e,n,i,s),r=ee.getTokenAmountBFromLiquidity(t,e,i,s);return{amountA:o,amountB:r}}else return{amountA:new H(0),amountB:ee.getTokenAmountBFromLiquidity(t,n,i,s)}}static getAmountsFromLiquidityWithSlippage(e,t,n,i,s,o,r){let{amountA:u,amountB:a}=ee.getAmountsFromLiquidity(e,t,n,i,o),c=s?1+r:1-r,p=new H(new Ye(u.toString()).mul(c).toFixed(0)),l=new H(new Ye(a.toString()).mul(c).toFixed(0));return{amountSlippageA:p,amountSlippageB:l}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:i,slippage:s,add:o,epochInfo:r,amountAddFee:u}){var w,I,T,A;let a=z.priceToSqrtPriceX64(new Ye(e.price),e.mintA.decimals,e.mintB.decimals),c=z.getSqrtPriceX64FromTick(t),p=z.getSqrtPriceX64FromTick(n),l=o?1+s:1-s,d=ee.getAmountsFromLiquidity(a,c,p,i,o),[y,b]=[be(d.amountA,(w=e.mintA.extensions)==null?void 0:w.feeConfig,r,u),be(d.amountB,(I=e.mintB.extensions)==null?void 0:I.feeConfig,r,u)],[f,g]=[be(new H(new Ye(d.amountA.toString()).mul(l).toFixed(0)),(T=e.mintA.extensions)==null?void 0:T.feeConfig,r,u),be(new H(new Ye(d.amountB.toString()).mul(l).toFixed(0)),(A=e.mintB.extensions)==null?void 0:A.feeConfig,r,u)];return{liquidity:i,amountA:y,amountB:b,amountSlippageA:f,amountSlippageB:g,expirationTime:De(y.expirationTime,b.expirationTime)}}},wt=class{static swapCompute(e,t,n,i,s,o,r,u,a,c,p,l,d,y,b=!1){if(l.eq(me))throw new Error("amountSpecified must not be 0");if(y||(y=o?Qe.add(Me):He.sub(Me)),o){if(y.lt(Qe))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(y.gte(p))throw new Error("sqrtPriceX64 must smaller than current")}else{if(y.gt(He))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(y.lte(p))throw new Error("sqrtPriceX64 must greater than current")}let f=l.gt(me),g={amountSpecifiedRemaining:l,amountCalculated:me,sqrtPriceX64:p,tick:a>d?Math.min(d+J.tickCount(c)-1,a):d,accounts:[],liquidity:u,feeAmount:new H(0)},w=d,I=n[d],T=0,A=!o&&I.startTickIndex===g.tick;for(;!g.amountSpecifiedRemaining.eq(me)&&!g.sqrtPriceX64.eq(y);){T>10;let k={};k.sqrtPriceStartX64=g.sqrtPriceX64;let B=F.nextInitTick(I,g.tick,c,o,A),x=B||null,R=null;if(!(x!=null&&x.liquidityGross.gtn(0))){let C=pe.nextInitializedTickArrayStartIndex({tickCurrent:g.tick,tickSpacing:c,tickArrayBitmap:i,exBitmapInfo:s},w,o);if(!C.isExist){if(b)return{allTrade:!1,amountSpecifiedRemaining:g.amountSpecifiedRemaining,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts};throw Error("swapCompute LiquidityInsufficient")}w=C.nextStartIndex;let{publicKey:E}=ne(e,t,w);R=E,I=n[w];try{x=F.firstInitializedTick(I,o)}catch{throw Error("not found next tick info")}}k.tickNext=x.tick,k.initialized=x.liquidityGross.gtn(0),d!==w&&R&&(g.accounts.push(R),d=w),k.tickNext<Be?k.tickNext=Be:k.tickNext>Ke&&(k.tickNext=Ke),k.sqrtPriceNextX64=z.getSqrtPriceX64FromTick(k.tickNext);let h;if(o&&k.sqrtPriceNextX64.lt(y)||!o&&k.sqrtPriceNextX64.gt(y)?h=y:h=k.sqrtPriceNextX64,[g.sqrtPriceX64,k.amountIn,k.amountOut,k.feeAmount]=wt.swapStepCompute(g.sqrtPriceX64,h,g.liquidity,g.amountSpecifiedRemaining,r,o),g.feeAmount=g.feeAmount.add(k.feeAmount),f?(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.sub(k.amountIn.add(k.feeAmount)),g.amountCalculated=g.amountCalculated.sub(k.amountOut)):(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.add(k.amountOut),g.amountCalculated=g.amountCalculated.add(k.amountIn.add(k.feeAmount))),g.sqrtPriceX64.eq(k.sqrtPriceNextX64)){if(k.initialized){let C=x.liquidityNet;o&&(C=C.mul(it)),g.liquidity=ee.addDelta(g.liquidity,C)}A=k.tickNext!=g.tick&&!o&&I.startTickIndex===k.tickNext,g.tick=o?k.tickNext-1:k.tickNext}else if(g.sqrtPriceX64!=k.sqrtPriceStartX64){let C=z.getTickFromSqrtPriceX64(g.sqrtPriceX64);A=C!=g.tick&&!o&&I.startTickIndex===C,g.tick=C}++T}try{let{nextStartIndex:k,isExist:B}=J.nextInitializedTickArray(g.tick,c,o,i,s);B&&d!==k&&(g.accounts.push(ne(e,t,k).publicKey),d=k)}catch{}return{allTrade:!0,amountSpecifiedRemaining:me,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts}}static swapStepCompute(e,t,n,i,s,o){let r={sqrtPriceX64Next:new H(0),amountIn:new H(0),amountOut:new H(0),feeAmount:new H(0)},u=i.gte(me);if(u){let c=Q.mulDivFloor(i,Pn.sub(new H(s.toString())),Pn);r.amountIn=o?ee.getTokenAmountAFromLiquidity(t,e,n,!0):ee.getTokenAmountBFromLiquidity(e,t,n,!0),c.gte(r.amountIn)?r.sqrtPriceX64Next=t:r.sqrtPriceX64Next=z.getNextSqrtPriceX64FromInput(e,n,c,o)}else r.amountOut=o?ee.getTokenAmountBFromLiquidity(t,e,n,!1):ee.getTokenAmountAFromLiquidity(e,t,n,!1),i.mul(it).gte(r.amountOut)?r.sqrtPriceX64Next=t:r.sqrtPriceX64Next=z.getNextSqrtPriceX64FromOutput(e,n,i.mul(it),o);let a=t.eq(r.sqrtPriceX64Next);return o?(a&&u||(r.amountIn=ee.getTokenAmountAFromLiquidity(r.sqrtPriceX64Next,e,n,!0)),a&&!u||(r.amountOut=ee.getTokenAmountBFromLiquidity(r.sqrtPriceX64Next,e,n,!1))):(r.amountIn=a&&u?r.amountIn:ee.getTokenAmountBFromLiquidity(e,r.sqrtPriceX64Next,n,!0),r.amountOut=a&&!u?r.amountOut:ee.getTokenAmountAFromLiquidity(e,r.sqrtPriceX64Next,n,!1)),!u&&r.amountOut.gt(i.mul(it))&&(r.amountOut=i.mul(it)),u&&!r.sqrtPriceX64Next.eq(t)?r.feeAmount=i.sub(r.amountIn):r.feeAmount=Q.mulDivCeil(r.amountIn,new H(s),Pn.sub(new H(s))),[r.sqrtPriceX64Next,r.amountIn,r.amountOut,r.feeAmount]}};var Ae=60,At=512,F=class{static getTickArrayAddressByTick(e,t,n,i){let s=F.getTickArrayStartIndexByTick(n,i),{publicKey:o}=ne(e,t,s);return o}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=F.getTickArrayStartIndexByTick(e,t),i=Math.floor((e-n)/t);if(i<0||i>=Ae)throw new Error("tick offset in array overflow");return i}static getTickArrayBitIndex(e,t){let n=J.tickCount(t),i=e/n;return e<0&&e%n!=0?i=Math.ceil(i)-1:i=Math.floor(i),i}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*J.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*Ae,i=Math.floor(e/n)+512;return Math.abs(i)}static checkTickArrayIsInitialized(e,t,n){let i=n*Ae,s=Math.floor(t/i)+512,o=Math.abs(s);return{isInitialized:e.testn(o),startIndex:(o-512)*i}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*Ae:e+t*Ae}static mergeTickArrayBitmap(e){let t=new Qo(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,i,s){let o=Math.floor(i/(n*Ae));return[...F.searchLowBitFromStart(e,t,o-1,s,n),...F.searchHightBitFromStart(e,t,o,s,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return F.searchHightBitFromStart(e,t,-7680,At,n)}static getAllInitializedTickArrayInfo(e,t,n,i,s){let o=[],r=F.getAllInitializedTickArrayStartIndex(n,i,s);for(let u of r){let{publicKey:a}=ne(e,t,u);o.push({tickArrayStartIndex:u,tickArrayAddress:a})}return o}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,i,s){let o=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(a=>F.mergeTickArrayBitmap(a)),r=[];for(;n>=-7680;){let a=Math.floor((n+7680)/512),c=(n+7680)%512;if(o[a].testn(c)&&r.push(n),n--,r.length===i)break}let u=J.tickCount(s);return r.map(a=>a*u)}static searchHightBitFromStart(e,t,n,i,s){let o=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(a=>F.mergeTickArrayBitmap(a)),r=[];for(;n<7680;){let a=Math.floor((n+7680)/512),c=(n+7680)%512;if(o[a].testn(c)&&r.push(n),n++,r.length===i)break}let u=J.tickCount(s);return r.map(a=>a*u)}static checkIsOutOfBoundary(e){return e<Be||e>Ke}static nextInitTick(e,t,n,i,s){if(J.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let r=Math.floor((t-e.startTickIndex)/n);if(i)for(;r>=0;){if(e.ticks[r].liquidityGross.gtn(0))return e.ticks[r];r=r-1}else for(s||(r=r+1);r<Ae;){if(e.ticks[r].liquidityGross.gtn(0))return e.ticks[r];r=r+1}return null}static firstInitializedTick(e,t){if(t){let n=Ae-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<Ae;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let i=z.getSqrtPriceX64FromTick(t),s=z.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:s,tickSqrtPriceX64:i}:{tick:t,price:new Mt(1).div(s),tickSqrtPriceX64:i}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let i=n?t:new Mt(1).div(t),s=Tt.getTickWithPriceAndTickspacing(i,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),o=z.getSqrtPriceX64FromTick(s),r=z.sqrtPriceX64ToPrice(o,e.mintA.decimals,e.mintB.decimals);return n?{tick:s,price:r}:{tick:s,price:new Mt(1).div(r)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let i=z.getSqrtPriceX64FromTick(t),s=z.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:s,tickSqrtPriceX64:i}:{tick:t,price:new Mt(1).div(s),tickSqrtPriceX64:i}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let i=n?t:new Mt(1).div(t),s=Tt.getTickWithPriceAndTickspacing(i,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),o=z.getSqrtPriceX64FromTick(s),r=z.sqrtPriceX64ToPrice(o,e.mintA.decimals,e.mintB.decimals);return n?{tick:s,price:r}:{tick:s,price:new Mt(1).div(r)}}};var Ho=W([Pe(8),G("bump"),Pt("index"),L(""),Ne("protocolFeeRate"),Ne("tradeFeeRate"),Pt("tickSpacing"),Z(P(),8,"")]),jo=W([Ne("blockTimestamp"),Qi("tickCumulative"),Z(P(),4)]),lr=W([Pe(8),he("initialized"),P("recentEpoch"),Pt("observationIndex"),L("poolId"),Z(jo,100,"observations"),Z(P(),4)]),Yo=W([G("rewardState"),P("openTime"),P("endTime"),P("lastUpdateTime"),U("emissionsPerSecondX64"),P("rewardTotalEmissioned"),P("rewardClaimed"),L("tokenMint"),L("tokenVault"),L("creator"),U("rewardGrowthGlobalX64")]),Nt=W([Pe(8),G("bump"),L("ammConfig"),L("creator"),L("mintA"),L("mintB"),L("vaultA"),L("vaultB"),L("observationId"),G("mintDecimalsA"),G("mintDecimalsB"),Pt("tickSpacing"),U("liquidity"),U("sqrtPriceX64"),ue("tickCurrent"),Ne(),U("feeGrowthGlobalX64A"),U("feeGrowthGlobalX64B"),P("protocolFeesTokenA"),P("protocolFeesTokenB"),U("swapInAmountTokenA"),U("swapOutAmountTokenB"),U("swapInAmountTokenB"),U("swapOutAmountTokenA"),G("status"),Z(G(),7,""),Z(Yo,3,"rewardInfos"),Z(P(),16,"tickArrayBitmap"),P("totalFeesTokenA"),P("totalFeesClaimedTokenA"),P("totalFeesTokenB"),P("totalFeesClaimedTokenB"),P("fundFeesTokenA"),P("fundFeesTokenB"),P("startTime"),Z(P(),15*4-3,"padding")]),Zo=W([U("growthInsideLastX64"),P("rewardAmountOwed")]),ai=W([Pe(8),G("bump"),L("nftMint"),L("poolId"),ue("tickLower"),ue("tickUpper"),U("liquidity"),U("feeGrowthInsideLastX64A"),U("feeGrowthInsideLastX64B"),P("tokenFeesOwedA"),P("tokenFeesOwedB"),Z(Zo,3,"rewardInfos"),Z(P(),8,"")]),Gp=W([Pe(8),G("bump"),L("poolId"),ue("tickLowerIndex"),ue("tickUpperIndex"),U("liquidity"),U("feeGrowthInsideLastX64A"),U("feeGrowthInsideLastX64B"),P("tokenFeesOwedA"),P("tokenFeesOwedB"),Z(U(),3,"rewardGrowthInside"),Z(P(),8,"")]),Jo=W([ue("tick"),Hi("liquidityNet"),U("liquidityGross"),U("feeGrowthOutsideX64A"),U("feeGrowthOutsideX64B"),Z(U(),3,"rewardGrowthsOutsideX64"),Z(Ne(),13,"")]),Yt=W([Pe(8),L("poolId"),ue("startTickIndex"),Z(Jo,Ae,"ticks"),G("initializedTickCount"),Z(G(),115,"")]),$o=W([Pe(329),Z(L(),100,"whitelistMints")]),cr=W([Pe(8),L("poolId"),Z(Z(P(),8),si,"positiveTickArrayBitmap"),Z(Z(P(),8),si,"negativeTickArrayBitmap")]),Up=W([P(),G("bump"),L("owner"),L("poolId"),L("positionId"),L("nftAccount"),Z(P(),8)]),es=W([Pe(8),G("bump"),L("lockOwner"),L("poolId"),L("positionId"),L("nftAccount"),L("lockNftMint"),P("recentEpoch"),Z(P(),8)]);lr.span;var mr=re("Raydium_Clmm"),We={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],openPositionWithTokenEx:[77,255,174,82,125,29,201,46],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},pr=[188,37,179,131,82,150,84,73],dr=[16,72,250,198,14,162,212,19],ht=class{static createPoolInstruction(e,t,n,i,s,o,r,u,a,c,p,l,d,y){let b=W([U("sqrtPriceX64"),P("zero")]),f=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:st.programId,isSigner:!1,isWritable:!1},{pubkey:Xe,isSigner:!1,isWritable:!1},...(y==null?void 0:y.map(I=>({pubkey:I,isSigner:!1,isWritable:!1})))||[]],g=Buffer.alloc(b.span);b.encode({sqrtPriceX64:d,zero:me},g);let w=Buffer.from([...We.createPool,...g]);return new Ie({keys:f,programId:e,data:w})}static async createPoolInstructions(e){let{programId:t,owner:n,mintA:i,mintB:s,ammConfigId:o,initialPriceX64:r,extendMintAccount:u}=e,[a,c]=[new K(i.address),new K(s.address)],{publicKey:p}=rr(t,o,a,c),{publicKey:l}=sr(t,p),{publicKey:d}=ni(t,p,a),{publicKey:y}=ni(t,p,c),b=ke(t,p).publicKey,f=[this.createPoolInstruction(t,p,n,o,l,a,d,new K(i.programId||ie),c,y,new K(s.programId||ie),b,r,u)];return{signers:[],instructions:f,instructionTypes:[Y.CreateAccount,Y.ClmmCreatePool],address:{poolId:p,observationId:l,exBitmapAccount:b,mintAVault:d,mintBVault:y},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,i,s,o,r,u,a,c,p,l,d,y,b,f,g,w,I,T,A,k,B,x,R,h){let C=W([ue("tickLowerIndex"),ue("tickUpperIndex"),ue("tickArrayLowerStartIndex"),ue("tickArrayUpperStartIndex"),U("liquidity"),P("amountMaxA"),P("amountMaxB"),he("withMetadata"),G("optionBaseFlag"),he("baseFlag")]),E=[...h?[{pubkey:h,isSigner:!1,isWritable:!0}]:[]],O=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:Xe,isSigner:!1,isWritable:!1},{pubkey:st.programId,isSigner:!1,isWritable:!1},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:Jt,isSigner:!1,isWritable:!1},{pubkey:lt,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...E],_=Buffer.alloc(C.span);C.encode({tickLowerIndex:w,tickUpperIndex:I,tickArrayLowerStartIndex:T,tickArrayUpperStartIndex:A,liquidity:k,amountMaxA:B,amountMaxB:x,withMetadata:R==="create",baseFlag:!1,optionBaseFlag:0},_);let j=Buffer.from([...We.openPosition,..._]);return new Ie({keys:O,programId:e,data:j})}static openPositionFromLiquidityInstruction22(e,t,n,i,s,o,r,u,a,c,p,l,d,y,b,f,g,w,I,T,A,k,B,x,R){let h=W([ue("tickLowerIndex"),ue("tickUpperIndex"),ue("tickArrayLowerStartIndex"),ue("tickArrayUpperStartIndex"),U("liquidity"),P("amountMaxA"),P("amountMaxB"),he("withMetadata"),G("optionBaseFlag"),he("baseFlag")]),C=[...R?[{pubkey:R,isSigner:!1,isWritable:!0}]:[]],E=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:Xe,isSigner:!1,isWritable:!1},{pubkey:st.programId,isSigner:!1,isWritable:!1},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:Jt,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},...C],O=Buffer.alloc(h.span);h.encode({tickLowerIndex:g,tickUpperIndex:w,tickArrayLowerStartIndex:I,tickArrayUpperStartIndex:T,liquidity:A,amountMaxA:k,amountMaxB:B,withMetadata:x==="create",baseFlag:!1,optionBaseFlag:0},O);let _=Buffer.from([...We.openPositionWithTokenEx,...O]);return new Ie({keys:E,programId:e,data:_})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:s,liquidity:o,amountMaxA:r,amountMaxB:u,withMetadata:a,getEphemeralSigners:c,nft2022:p}){let l=[],[d,y]=[new K(e.programId),new K(e.id)],b;if(c)b=new K((await c(1))[0]);else{let R=wn.generate();l.push(R),b=R.publicKey}let f=F.getTickArrayStartIndexByTick(i,e.config.tickSpacing),g=F.getTickArrayStartIndexByTick(s,e.config.tickSpacing),{publicKey:w}=ne(d,y,f),{publicKey:I}=ne(d,y,g),{publicKey:T}=p?ae(n.wallet,b,de):ae(n.wallet,b,ie),{publicKey:A}=Rt(b),{publicKey:k}=Le(d,b),{publicKey:B}=rt(d,y,i,s),x=p?this.openPositionFromLiquidityInstruction22(d,n.feePayer,y,n.wallet,b,T,B,w,I,k,n.tokenAccountA,n.tokenAccountB,new K(t.vault.A),new K(t.vault.B),new K(e.mintA.address),new K(e.mintB.address),i,s,f,g,o,r,u,a,pe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[f,g])?ke(d,y).publicKey:void 0):this.openPositionFromLiquidityInstruction(d,n.feePayer,y,n.wallet,b,T,A,B,w,I,k,n.tokenAccountA,n.tokenAccountB,new K(t.vault.A),new K(t.vault.B),new K(e.mintA.address),new K(e.mintB.address),i,s,f,g,o,r,u,a,pe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[f,g])?ke(d,y).publicKey:void 0);return{signers:l,instructions:[x],instructionTypes:[Y.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:b,tickArrayLower:w,tickArrayUpper:I,positionNftAccount:T,metadataAccount:A,personalPosition:k,protocolPosition:B}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:s,base:o,baseAmount:r,otherAmountMax:u,withMetadata:a,getEphemeralSigners:c,nft2022:p}){let l=[],[d,y]=[new K(e.programId),new K(e.id)],b;if(c)b=new K((await c(1))[0]);else{let R=wn.generate();l.push(R),b=R.publicKey}let f=F.getTickArrayStartIndexByTick(i,e.config.tickSpacing),g=F.getTickArrayStartIndexByTick(s,e.config.tickSpacing),{publicKey:w}=ne(d,y,f),{publicKey:I}=ne(d,y,g),{publicKey:T}=p?ae(n.wallet,b,de):ae(n.wallet,b,ie),{publicKey:A}=Rt(b),{publicKey:k}=Le(d,b),{publicKey:B}=rt(d,y,i,s),x=p?this.openPositionFromBaseInstruction22(d,n.feePayer,y,n.wallet,b,T,B,w,I,k,n.tokenAccountA,n.tokenAccountB,new K(t.vault.A),new K(t.vault.B),new K(e.mintA.address),new K(e.mintB.address),i,s,f,g,a,o,r,u,pe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[f,g])?ke(d,y).publicKey:void 0):this.openPositionFromBaseInstruction(d,n.feePayer,y,n.wallet,b,T,A,B,w,I,k,n.tokenAccountA,n.tokenAccountB,new K(t.vault.A),new K(t.vault.B),new K(e.mintA.address),new K(e.mintB.address),i,s,f,g,a,o,r,u,pe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[f,g])?ke(d,y).publicKey:void 0);return{address:{nftMint:b,tickArrayLower:w,tickArrayUpper:I,positionNftAccount:T,metadataAccount:A,personalPosition:k,protocolPosition:B},instructions:[x],signers:l,instructionTypes:[Y.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,i,s,o,r,u,a,c,p,l,d,y,b,f,g,w,I,T,A,k,B,x,R,h){let C=W([ue("tickLowerIndex"),ue("tickUpperIndex"),ue("tickArrayLowerStartIndex"),ue("tickArrayUpperStartIndex"),U("liquidity"),P("amountMaxA"),P("amountMaxB"),he("withMetadata"),G("optionBaseFlag"),he("baseFlag")]),E=[...h?[{pubkey:h,isSigner:!1,isWritable:!0}]:[]],O=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:Xe,isSigner:!1,isWritable:!1},{pubkey:st.programId,isSigner:!1,isWritable:!1},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:Jt,isSigner:!1,isWritable:!1},{pubkey:lt,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...E],_=Buffer.alloc(C.span);C.encode({tickLowerIndex:w,tickUpperIndex:I,tickArrayLowerStartIndex:T,tickArrayUpperStartIndex:A,liquidity:new ci(0),amountMaxA:B==="MintA"?x:R,amountMaxB:B==="MintA"?R:x,withMetadata:k==="create",baseFlag:B==="MintA",optionBaseFlag:1},_);let j=Buffer.from([...We.openPosition,..._]);return new Ie({keys:O,programId:e,data:j})}static openPositionFromBaseInstruction22(e,t,n,i,s,o,r,u,a,c,p,l,d,y,b,f,g,w,I,T,A,k,B,x,R){let h=W([ue("tickLowerIndex"),ue("tickUpperIndex"),ue("tickArrayLowerStartIndex"),ue("tickArrayUpperStartIndex"),U("liquidity"),P("amountMaxA"),P("amountMaxB"),he("withMetadata"),G("optionBaseFlag"),he("baseFlag")]),C=[...R?[{pubkey:R,isSigner:!1,isWritable:!0}]:[]],E=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:Xe,isSigner:!1,isWritable:!1},{pubkey:st.programId,isSigner:!1,isWritable:!1},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:Jt,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},...C],O=Buffer.alloc(h.span);h.encode({tickLowerIndex:g,tickUpperIndex:w,tickArrayLowerStartIndex:I,tickArrayUpperStartIndex:T,liquidity:new ci(0),amountMaxA:k==="MintA"?B:x,amountMaxB:k==="MintA"?x:B,withMetadata:A==="create",baseFlag:k==="MintA",optionBaseFlag:1},O);let _=Buffer.from([...We.openPositionWithTokenEx,...O]);return new Ie({keys:E,programId:e,data:_})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:s,liquidity:o,amountMaxA:r,amountMaxB:u,withMetadata:a,getEphemeralSigners:c,nft2022:p}){let l,d=[];if(c)l=new K((await c(1))[0]);else{let R=wn.generate();d.push(R),l=R.publicKey}let[y,b]=[new K(e.programId),new K(e.id)],f=F.getTickArrayStartIndexByTick(i,e.config.tickSpacing),g=F.getTickArrayStartIndexByTick(s,e.config.tickSpacing),{publicKey:w}=ne(y,b,f),{publicKey:I}=ne(y,b,g),{publicKey:T}=p?ae(n.wallet,l,de):ae(n.wallet,l,ie),{publicKey:A}=Rt(l),{publicKey:k}=Le(y,l),{publicKey:B}=rt(y,b,i,s),x=p?this.openPositionFromLiquidityInstruction22(y,n.wallet,b,n.wallet,l,T,B,w,I,k,n.tokenAccountA,n.tokenAccountB,new K(t.vault.A),new K(t.vault.B),new K(t.mintA.address),new K(t.mintB.address),i,s,f,g,o,r,u,a,pe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[f,g])?ke(y,b).publicKey:void 0):this.openPositionFromLiquidityInstruction(y,n.wallet,b,n.wallet,l,T,A,B,w,I,k,n.tokenAccountA,n.tokenAccountB,new K(t.vault.A),new K(t.vault.B),new K(t.mintA.address),new K(t.mintB.address),i,s,f,g,o,r,u,a,pe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[f,g])?ke(y,b).publicKey:void 0);return{address:{nftMint:l,tickArrayLower:w,tickArrayUpper:I,positionNftAccount:T,metadataAccount:A,personalPosition:k,protocolPosition:B},instructions:[x],signers:d,instructionTypes:[Y.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,i,s,o){let r=W([]),u=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:st.programId,isSigner:!1,isWritable:!1},{pubkey:o?de:ie,isSigner:!1,isWritable:!1}],a=Buffer.alloc(r.span);r.encode({},a);let c=Buffer.from([...We.closePosition,...a]);return new Ie({keys:u,programId:e,data:c})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:i,nft2022:s}){let o=new K(e.programId),r=s?ae(n.wallet,i.nftMint,de).publicKey:ae(n.wallet,i.nftMint,ie).publicKey,{publicKey:u}=Le(o,i.nftMint),a=[];return a.push(this.closePositionInstruction(o,n.wallet,i.nftMint,r,u,s)),{address:{positionNftAccount:r,personalPosition:u},signers:[],instructions:a,instructionTypes:[Y.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,i,s,o,r,u,a,c,p,l,d,y,b,f,g,w){let I=W([U("liquidity"),P("amountMaxA"),P("amountMaxB"),G("optionBaseFlag"),he("baseFlag")]),T=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[]],A=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...T],k=Buffer.alloc(I.span);I.encode({liquidity:b,amountMaxA:f,amountMaxB:g,optionBaseFlag:0,baseFlag:!1},k);let B=Buffer.from([...We.increaseLiquidity,...k]);return new Ie({keys:A,programId:e,data:B})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:s,amountMaxA:o,amountMaxB:r,nft2022:u}){let[a,c]=[new K(e.programId),new K(e.id)],p=F.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),l=F.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:d}=ne(a,c,p),{publicKey:y}=ne(a,c,l),{publicKey:b}=u?ae(i.wallet,n.nftMint,de):ae(i.wallet,n.nftMint,ie),{publicKey:f}=Le(a,n.nftMint),{publicKey:g}=rt(a,c,n.tickLower,n.tickUpper),w=this.increasePositionFromLiquidityInstruction(a,i.wallet,b,f,c,g,d,y,i.tokenAccountA,i.tokenAccountB,new K(t.vault.A),new K(t.vault.B),new K(e.mintA.address),new K(e.mintB.address),s,o,r,pe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[p,l])?ke(a,c).publicKey:void 0);return{address:{tickArrayLower:d,tickArrayUpper:y,positionNftAccount:b,personalPosition:f,protocolPosition:g},signers:[],instructions:[w],instructionTypes:[Y.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,base:s,baseAmount:o,otherAmountMax:r,nft2022:u}){let[a,c]=[new K(e.programId),new K(e.id)],p=F.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),l=F.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:d}=ne(a,c,p),{publicKey:y}=ne(a,c,l),{publicKey:b}=u?ae(i.wallet,n.nftMint,de):ae(i.wallet,n.nftMint,ie),{publicKey:f}=Le(a,n.nftMint),{publicKey:g}=rt(a,c,n.tickLower,n.tickUpper);return{address:{tickArrayLower:d,tickArrayUpper:y,positionNftAccount:b,personalPosition:f,protocolPosition:g},instructions:[this.increasePositionFromBaseInstruction(a,i.wallet,b,f,c,g,d,y,i.tokenAccountA,i.tokenAccountB,new K(t.vault.A),new K(t.vault.B),new K(e.mintA.address),new K(e.mintB.address),s,o,r,pe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[p,l])?ke(a,c).publicKey:void 0)],signers:[],instructionTypes:[Y.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,i,s,o,r,u,a,c,p,l,d,y,b,f,g,w){let I=W([U("liquidity"),P("amountMaxA"),P("amountMaxB"),G("optionBaseFlag"),he("baseFlag")]),T=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[]],A=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...T],k=Buffer.alloc(I.span);I.encode({liquidity:new ci(0),amountMaxA:b==="MintA"?f:g,amountMaxB:b==="MintA"?g:f,baseFlag:b==="MintA",optionBaseFlag:1},k);let B=Buffer.from([...We.increaseLiquidity,...k]);return new Ie({keys:A,programId:e,data:B})}static decreaseLiquidityInstruction(e,t,n,i,s,o,r,u,a,c,p,l,d,y,b,f,g,w,I){let T=W([U("liquidity"),P("amountMinA"),P("amountMinB")]),A=[...I?[{pubkey:I,isSigner:!1,isWritable:!0}]:[],...b.map(R=>[{pubkey:R.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:R.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:R.rewardMint,isSigner:!1,isWritable:!1}]).flat()],k=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:un,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...A],B=Buffer.alloc(T.span);T.encode({liquidity:f,amountMinA:g,amountMinB:w},B);let x=Buffer.from([...We.decreaseLiquidity,...B]);return new Ie({keys:k,programId:e,data:x})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:s,amountMinA:o,amountMinB:r,programId:u,nft2022:a}){let[c,p]=[new K(e.programId),new K(e.id)],l=F.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=F.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:y}=ne(c,p,l),{publicKey:b}=ne(c,p,d),{publicKey:f}=a?ae(i.wallet,n.nftMint,de):ae(i.wallet,n.nftMint,u),{publicKey:g}=Le(c,n.nftMint),{publicKey:w}=rt(c,p,n.tickLower,n.tickUpper),I=[];for(let k=0;k<e.rewardDefaultInfos.length;k++)I.push({poolRewardVault:new K(t.rewardInfos[k].vault),ownerRewardVault:i.rewardAccounts[k],rewardMint:new K(e.rewardDefaultInfos[k].mint.address)});let T=[],A=this.decreaseLiquidityInstruction(c,i.wallet,f,g,p,w,y,b,i.tokenAccountA,i.tokenAccountB,new K(t.vault.A),new K(t.vault.B),new K(e.mintA.address),new K(e.mintB.address),I,s,o,r,pe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[l,d])?ke(c,p).publicKey:void 0);return T.push(A),{address:{tickArrayLower:y,tickArrayUpper:b,positionNftAccount:f,personalPosition:g,protocolPosition:w},signers:[],instructions:T,instructionTypes:[Y.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,i,s,o,r,u,a,c,p,l,d,y,b,f,g){let w=W([P("amount"),P("otherAmountThreshold"),U("sqrtPriceLimitX64"),he("isBaseInput")]),I=[...g?[{pubkey:g,isSigner:!1,isWritable:!0}]:[],...p.map(B=>({pubkey:B,isSigner:!1,isWritable:!0}))],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:un,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},...I],A=Buffer.alloc(w.span);w.encode({amount:d,otherAmountThreshold:y,sqrtPriceLimitX64:b,isBaseInput:f},A);let k=Buffer.from([...We.swap,...A]);return new Ie({keys:T,programId:e,data:k})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:i,inputMint:s,amountIn:o,amountOutMin:r,sqrtPriceLimitX64:u,remainingAccounts:a}){let[c,p]=[new K(e.programId),new K(e.id)],[l,d]=[new K(t.vault.A),new K(t.vault.B)],[y,b]=[new K(e.mintA.address),new K(e.mintB.address)],f=e.mintA.address===s.toString(),g=[this.swapInstruction(c,i.wallet,p,new K(e.config.id),f?i.tokenAccountA:i.tokenAccountB,f?i.tokenAccountB:i.tokenAccountA,f?l:d,f?d:l,f?y:b,f?b:y,a,n,o,r,u,!0,ke(c,p).publicKey)];return{signers:[],instructions:g,instructionTypes:[Y.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static makeSwapBaseOutInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:i,outputMint:s,amountOut:o,amountInMax:r,sqrtPriceLimitX64:u,remainingAccounts:a}){let[c,p]=[new K(e.programId),new K(e.id)],[l,d]=[new K(t.vault.A),new K(t.vault.B)],[y,b]=[new K(e.mintA.address),new K(e.mintB.address)],f=e.mintA.address===s.toBase58(),g=[this.swapInstruction(c,i.wallet,p,new K(e.config.id),f?i.tokenAccountB:i.tokenAccountA,f?i.tokenAccountA:i.tokenAccountB,f?d:l,f?l:d,f?b:y,f?y:b,a,n,o,r,u,!1,ke(c,p).publicKey)];return{signers:[],instructions:g,instructionTypes:[Y.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,i,s,o,r,u,a,c,p,l){let d=W([P("openTime"),P("endTime"),U("emissionsPerSecondX64")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:st.programId,isSigner:!1,isWritable:!1},{pubkey:Xe,isSigner:!1,isWritable:!1}],b=Buffer.alloc(d.span);d.encode({openTime:oe(c),endTime:oe(p),emissionsPerSecondX64:l},b);let f=Buffer.from([...We.initReward,...b]);return new Ie({keys:y,programId:e,data:f})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[s,o]=[new K(e.programId),new K(e.id)],r=or(s,o,i.mint).publicKey,u=An(s).publicKey,a=[this.initRewardInstruction(s,n.wallet,o,u,new K(e.config.id),n.tokenAccount,i.programId,i.mint,r,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{poolRewardVault:r,operationId:u},signers:[],instructions:a,instructionTypes:[Y.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,i,s,o,r,u,a,c,p,l){let d=W([G("rewardIndex"),U("emissionsPerSecondX64"),P("openTime"),P("endTime")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0}],b=Buffer.alloc(d.span);d.encode({rewardIndex:a,emissionsPerSecondX64:l,openTime:oe(c),endTime:oe(p)},b);let f=Buffer.from([...We.setRewardEmissions,...b]);return new Ie({keys:y,programId:e,data:f})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[s,o]=[new K(e.programId),new K(e.id)],r,u,a;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===i.mint.toString()&&(r=l,u=new K(t.rewardInfos[l].vault),a=new K(t.rewardInfos[l].mint.address));(r===void 0||u===void 0)&&mr.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let c=An(s).publicKey,p=[this.setRewardInstruction(s,n.wallet,o,c,new K(e.config.id),n.tokenAccount,u,a,r,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{rewardVault:u,operationId:c},signers:[],instructions:p,instructionTypes:[Y.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,i,s,o,r){let u=W([G("rewardIndex")]),a=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:un,isSigner:!1,isWritable:!1}],c=Buffer.alloc(u.span);u.encode({rewardIndex:r},c);let p=Buffer.from([...We.collectReward,...c]);return new Ie({keys:a,programId:e,data:p})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:i}){let[s,o]=[new K(e.programId),new K(e.id)],r,u;for(let c=0;c<e.rewardDefaultInfos.length;c++)e.rewardDefaultInfos[c].mint.address===i.toString()&&(r=c,u=new K(t.rewardInfos[c].vault));(r===void 0||u===void 0)&&mr.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let a=[this.collectRewardInstruction(s,n.wallet,o,n.tokenAccount,u,i,r)];return{address:{rewardVault:u},signers:[],instructions:a,instructionTypes:[Y.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static async makeLockPositions({programId:e,authProgramId:t,poolProgramId:n,payer:i,wallet:s,nftMint:o,nft2022:r,getEphemeralSigners:u}){let a=[],c;if(u)c=new K((await u(1))[0]);else{let g=wn.generate();a.push(g),c=g.publicKey}let p=r?ae(s,o,de).publicKey:ae(s,o,ie).publicKey,{publicKey:l}=Le(n,o),d=ri(e,c).publicKey,y=ae(s,c,ie).publicKey,b=Rt(c).publicKey,f=ht.lockPositionInstructionV2({programId:e,auth:t,payer:i,positionOwner:s,lockOwner:s,positionNftAccount:p,positionId:l,lockPositionId:d,lockNftMint:c,lockNftAccount:y,metadataAccount:b,withMetadata:!0,nft2022:r,positionNftMint:o,authPositionNftAccount:ae(t,o,r?de:ie).publicKey,positionNftProgram:r?de:ie});return{address:{positionId:l,lockPositionId:d,lockNftAccount:y,lockNftMint:c,positionNftAccount:p,metadataAccount:b},instructions:[f],signers:a,instructionTypes:[Y.ClmmLockPosition],lookupTableAddress:[]}}static lockPositionInstructionV2({programId:e,auth:t,payer:n,positionOwner:i,lockOwner:s,positionNftAccount:o,positionId:r,positionNftMint:u,authPositionNftAccount:a,positionNftProgram:c,lockPositionId:p,lockNftMint:l,lockNftAccount:d,metadataAccount:y,withMetadata:b}){let f=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!0,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:lt,isSigner:!1,isWritable:!1},{pubkey:Jt,isSigner:!1,isWritable:!1},{pubkey:Xe,isSigner:!1,isWritable:!1},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:st.programId,isSigner:!1,isWritable:!1}],g=W([he("withMetadata")]),w=Buffer.alloc(g.span);g.encode({withMetadata:b},w);let I=Buffer.from([...pr,...w]);return new Ie({keys:f,programId:e,data:I})}static lockPositionInstruction({programId:e,authProgramId:t,poolProgramId:n,owner:i,positionNft:s}){let{publicKey:o}=ae(i,s,ie),{publicKey:r}=Le(n,s),u=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:ii(e,r).publicKey,isSigner:!1,isWritable:!0},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:st.programId,isSigner:!1,isWritable:!1}];return new Ie({keys:u,programId:e,data:Buffer.from(pr)})}static harvestLockPositionInstruction(e){let[t,n]=[new K(e.poolKeys.programId),new K(e.poolKeys.id)],i=F.getTickArrayStartIndexByTick(e.ownerPosition.tickLower,e.poolKeys.config.tickSpacing),s=F.getTickArrayStartIndexByTick(e.ownerPosition.tickUpper,e.poolKeys.config.tickSpacing),{publicKey:o}=ne(t,n,i),{publicKey:r}=ne(t,n,s),{publicKey:u}=ae(e.owner,e.ownerPosition.nftMint,ie),{publicKey:a}=Le(t,e.ownerPosition.nftMint),{publicKey:c}=rt(t,n,e.ownerPosition.tickLower,e.ownerPosition.tickUpper),p=[];for(let y=0;y<e.poolKeys.rewardInfos.length;y++)p.push({poolRewardVault:new K(e.poolKeys.rewardInfos[y].vault),ownerRewardVault:e.ownerRewardAccounts[y],rewardMint:new K(e.poolKeys.rewardInfos[y].mint.address)});let l=[...p.map(y=>[{pubkey:y.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:y.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:y.rewardMint,isSigner:!1,isWritable:!1}]).flat()],d=[{pubkey:e.authProgramId,isSigner:!1,isWritable:!1},{pubkey:ii(e.programId,a).publicKey,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e.owner,isSigner:!0,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:new K(e.poolKeys.vault.A),isSigner:!1,isWritable:!0},{pubkey:new K(e.poolKeys.vault.B),isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:e.userVaultA,isSigner:!1,isWritable:!0},{pubkey:e.userVaultB,isSigner:!1,isWritable:!0},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:Bt,isSigner:!1,isWritable:!1},{pubkey:new K(e.poolKeys.mintA.address),isSigner:!1,isWritable:!1},{pubkey:new K(e.poolKeys.mintB.address),isSigner:!1,isWritable:!1},...l];return new Ie({keys:d,programId:e.programId,data:Buffer.from(dr)})}static harvestLockPositionInstructionV2({programId:e,auth:t,lockPositionId:n,clmmProgram:i,lockOwner:s,lockNftMint:o,lockNftAccount:r,positionNftAccount:u,positionId:a,poolId:c,protocolPosition:p,vaultA:l,vaultB:d,tickArrayLower:y,tickArrayUpper:b,userVaultA:f,userVaultB:g,mintA:w,mintB:I,rewardAccounts:T,exTickArrayBitmap:A}){let k=[...A?[{pubkey:A,isSigner:!1,isWritable:!0}]:[],...T.map(x=>[{pubkey:x.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:x.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:x.rewardMint,isSigner:!1,isWritable:!1}]).flat()],B=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!0,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0},{pubkey:ie,isSigner:!1,isWritable:!1},{pubkey:de,isSigner:!1,isWritable:!1},{pubkey:Bt,isSigner:!1,isWritable:!1},{pubkey:w,isSigner:!1,isWritable:!1},{pubkey:I,isSigner:!1,isWritable:!1},...k];return new Ie({keys:B,programId:e,data:Buffer.from(dr)})}};var af=W([Pe(8),G("bump"),he("disableCreatePool"),Pt("index"),P("tradeFeeRate"),P("protocolFeeRate"),P("fundFeeRate"),P("createPoolFee"),L("protocolOwner"),L("fundOwner"),Z(P(),16)]),fr=W([Pe(8),L("configId"),L("poolCreator"),L("vaultA"),L("vaultB"),L("mintLp"),L("mintA"),L("mintB"),L("mintProgramA"),L("mintProgramB"),L("observationId"),G("bump"),G("status"),G("lpDecimals"),G("mintDecimalA"),G("mintDecimalB"),P("lpAmount"),P("protocolFeesMintA"),P("protocolFeesMintB"),P("fundFeesMintA"),P("fundFeesMintB"),P("openTime"),Z(P(),32)]);import{PublicKey as wf,TransactionInstruction as ns,Keypair as hf,SystemProgram as xf}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Bf,TOKEN_2022_PROGRAM_ID as Sf,TOKEN_PROGRAM_ID as Kf}from"@solana/spl-token";var ts=Buffer.from("vault_and_lp_mint_auth_seed","utf8"),lf=Buffer.from("amm_config","utf8"),mf=Buffer.from("pool","utf8"),pf=Buffer.from("pool_lp_mint","utf8"),df=Buffer.from("pool_vault","utf8"),ff=Buffer.from("observation","utf8");function br(m){return ge([ts],m)}var bf=Buffer.from("locked_liquidity","utf8");var Of=re("Raydium_cpmm"),is={initialize:[175,175,109,31,13,152,155,237],deposit:[242,35,198,137,82,225,242,182],withdraw:[183,18,70,156,148,109,161,34],swapBaseInput:[143,190,90,218,196,30,51,222],swapBaseOutput:[55,217,98,86,163,74,180,173],lockCpLiquidity:[216,157,29,78,38,51,31,26],collectCpFee:[8,30,51,199,209,184,247,133]};function yr(m,e,t,n,i,s,o,r,u,a,c,p,l,d,y,b){let f=W([P("amountIn"),P("amounOutMin")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!0}],w=Buffer.alloc(f.span);return f.encode({amountIn:y,amounOutMin:b},w),new ns({keys:g,programId:m,data:Buffer.from([...is.swapBaseInput,...w])})}import Zf from"bn.js";import $f from"decimal.js-light";import rs from"bn.js";var vf=new rs(0);import gr from"bn.js";var fb=new gr(25),bb=new gr(1e4);var li=W([G("instruction"),P("amountIn"),P("minAmountOut")]),mi=W([G("instruction"),P("maxAmountIn"),P("amountOut")]),kb=W([G("instruction"),G("nonce")]),os=W([G("instruction"),G("nonce"),P("startTime")]),pi=W([P("status"),P("nonce"),P("maxOrder"),P("depth"),P("baseDecimal"),P("quoteDecimal"),P("state"),P("resetFlag"),P("minSize"),P("volMaxCutRatio"),P("amountWaveRatio"),P("baseLotSize"),P("quoteLotSize"),P("minPriceMultiplier"),P("maxPriceMultiplier"),P("systemDecimalValue"),P("minSeparateNumerator"),P("minSeparateDenominator"),P("tradeFeeNumerator"),P("tradeFeeDenominator"),P("pnlNumerator"),P("pnlDenominator"),P("swapFeeNumerator"),P("swapFeeDenominator"),P("baseNeedTakePnl"),P("quoteNeedTakePnl"),P("quoteTotalPnl"),P("baseTotalPnl"),P("poolOpenTime"),P("punishPcAmount"),P("punishCoinAmount"),P("orderbookToInitTime"),U("swapBaseInAmount"),U("swapQuoteOutAmount"),P("swapBase2QuoteFee"),U("swapQuoteInAmount"),U("swapBaseOutAmount"),P("swapQuote2BaseFee"),L("baseVault"),L("quoteVault"),L("baseMint"),L("quoteMint"),L("lpMint"),L("openOrders"),L("marketId"),L("marketProgramId"),L("targetOrders"),L("withdrawQueue"),L("lpVault"),L("owner"),P("lpReserve"),Z(P(),3,"padding")]),Ab=W([P("accountType"),P("status"),P("nonce"),P("maxOrder"),P("depth"),P("baseDecimal"),P("quoteDecimal"),P("state"),P("resetFlag"),P("minSize"),P("volMaxCutRatio"),P("amountWaveRatio"),P("baseLotSize"),P("quoteLotSize"),P("minPriceMultiplier"),P("maxPriceMultiplier"),P("systemDecimalsValue"),P("abortTradeFactor"),P("priceTickMultiplier"),P("priceTick"),P("minSeparateNumerator"),P("minSeparateDenominator"),P("tradeFeeNumerator"),P("tradeFeeDenominator"),P("pnlNumerator"),P("pnlDenominator"),P("swapFeeNumerator"),P("swapFeeDenominator"),P("baseNeedTakePnl"),P("quoteNeedTakePnl"),P("quoteTotalPnl"),P("baseTotalPnl"),P("poolOpenTime"),P("punishPcAmount"),P("punishCoinAmount"),P("orderbookToInitTime"),U("swapBaseInAmount"),U("swapQuoteOutAmount"),U("swapQuoteInAmount"),U("swapBaseOutAmount"),P("swapQuote2BaseFee"),P("swapBase2QuoteFee"),L("baseVault"),L("quoteVault"),L("baseMint"),L("quoteMint"),L("lpMint"),L("modelDataAccount"),L("openOrders"),L("marketId"),L("marketProgramId"),L("targetOrders"),L("owner"),Z(P(),64,"padding")]),ss=W([G("instruction"),P("baseAmountIn"),P("quoteAmountIn"),P("fixedSide"),P("otherAmountMin")]),as=W([G("instruction"),P("lpAmount"),P("baseAmountMin"),P("quoteAmountMin")]);var wb=W([P("fee")]);import{PublicKey as eg}from"@solana/web3.js";import ng from"bn.js";import In from"decimal.js";import{TOKEN_PROGRAM_ID as Ss}from"@solana/spl-token";import{PublicKey as xb,SystemProgram as Ib,SYSVAR_RENT_PUBKEY as Bb,TransactionInstruction as kr}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Kb,TOKEN_PROGRAM_ID as Ar}from"@solana/spl-token";var Pr=re("Raydium_liquidity_instruction");function us({poolKeys:m,userKeys:e,amountIn:t,minAmountOut:n,modelDataPubKey:i=ln},s){let o=bt(m),r=Buffer.alloc(li.span);li.encode({instruction:9,amountIn:oe(t),minAmountOut:oe(n)},r);let u=[S({pubkey:Ar,isWritable:!1}),S({pubkey:o.id}),S({pubkey:o.authority,isWritable:!1}),S({pubkey:o.openOrders})];return s===4&&u.push(S({pubkey:o.targetOrders})),u.push(S({pubkey:o.vault.A}),S({pubkey:o.vault.B})),s===5&&u.push(S({pubkey:i})),u.push(S({pubkey:o.marketProgramId,isWritable:!1}),S({pubkey:o.marketId}),S({pubkey:o.marketBids}),S({pubkey:o.marketAsks}),S({pubkey:o.marketEventQueue}),S({pubkey:o.marketBaseVault}),S({pubkey:o.marketQuoteVault}),S({pubkey:o.marketAuthority,isWritable:!1}),S({pubkey:e.tokenAccountIn}),S({pubkey:e.tokenAccountOut}),S({pubkey:e.owner,isWritable:!1,isSigner:!0})),new kr({programId:o.programId,keys:u,data:r})}function cs({poolKeys:m,userKeys:e,maxAmountIn:t,amountOut:n,modelDataPubKey:i=ln},s){let o=bt(m),r=Buffer.alloc(mi.span);mi.encode({instruction:11,maxAmountIn:oe(t),amountOut:oe(n)},r);let u=[S({pubkey:Ar,isWritable:!1}),S({pubkey:o.id}),S({pubkey:o.authority,isWritable:!1}),S({pubkey:o.openOrders}),S({pubkey:o.targetOrders}),S({pubkey:o.vault.A}),S({pubkey:o.vault.B})];return s===5&&u.push(S({pubkey:i})),u.push(S({pubkey:o.marketProgramId,isWritable:!1}),S({pubkey:o.marketId}),S({pubkey:o.marketBids}),S({pubkey:o.marketAsks}),S({pubkey:o.marketEventQueue}),S({pubkey:o.marketBaseVault}),S({pubkey:o.marketQuoteVault}),S({pubkey:o.marketAuthority,isWritable:!1}),S({pubkey:e.tokenAccountIn}),S({pubkey:e.tokenAccountOut}),S({pubkey:e.owner,isWritable:!1,isSigner:!0})),new kr({programId:o.programId,keys:u,data:r})}function wr(m){let{poolKeys:e,version:t,userKeys:n,amountIn:i,amountOut:s,fixedSide:o}=m;if(t===4||t===5){let r={poolKeys:e,userKeys:n};if(o==="in")return us(X(V({},r),{amountIn:i,minAmountOut:s}),t);if(o==="out")return cs(X(V({},r),{maxAmountIn:i,amountOut:s}),t);Pr.logWithError("invalid params","params",m)}throw Pr.logWithError("invalid version","poolKeys.version",t),new Error("invalid version")}import{PublicKey as _b}from"@solana/web3.js";var qb=re("Raydium_liquidity_serum");var ls=5e4,ms=W([P("x"),P("y"),P("price")]),zb=W([P("accountType"),P("status"),P("multiplier"),P("validDataCount"),Z(ms,ls,"DataElement")]);var $t=W([L("mint"),L("owner"),P("amount"),Ne("delegateOption"),L("delegate"),G("state"),Ne("isNativeOption"),P("isNative"),P("delegatedAmount"),Ne("closeAuthorityOption"),L("closeAuthority")]);import{Keypair as ys,PublicKey as gs}from"@solana/web3.js";import py from"bn.js";import{TOKEN_PROGRAM_ID as Ps}from"@solana/spl-token";function ps(m){return m instanceof Uint8Array||m!=null&&typeof m=="object"&&m.constructor.name==="Uint8Array"}function di(m,...e){if(!ps(m))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(m.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${m.length}`)}function fi(m,e=!0){if(m.destroyed)throw new Error("Hash instance has been destroyed");if(e&&m.finished)throw new Error("Hash#digest() has already been called")}function Tr(m,e){di(m);let t=e.outputLen;if(m.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var hn=m=>new DataView(m.buffer,m.byteOffset,m.byteLength),qe=(m,e)=>m<<32-e|m>>>e;var Jb=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function ds(m){if(typeof m!="string")throw new Error(`utf8ToBytes expected string, got ${typeof m}`);return new Uint8Array(new TextEncoder().encode(m))}function bi(m){return typeof m=="string"&&(m=ds(m)),di(m),m}var Tn=class{clone(){return this._cloneInto()}},$b={}.toString;function hr(m){let e=n=>m().update(bi(n)).digest(),t=m();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>m(),e}function fs(m,e,t,n){if(typeof m.setBigUint64=="function")return m.setBigUint64(e,t,n);let i=BigInt(32),s=BigInt(4294967295),o=Number(t>>i&s),r=Number(t&s),u=n?4:0,a=n?0:4;m.setUint32(e+u,o,n),m.setUint32(e+a,r,n)}var xr=(m,e,t)=>m&e^~m&t,Ir=(m,e,t)=>m&e^m&t^e&t,xn=class extends Tn{constructor(e,t,n,i){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=i,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=hn(this.buffer)}update(e){fi(this);let{view:t,buffer:n,blockLen:i}=this;e=bi(e);let s=e.length;for(let o=0;o<s;){let r=Math.min(i-this.pos,s-o);if(r===i){let u=hn(e);for(;i<=s-o;o+=i)this.process(u,o);continue}n.set(e.subarray(o,o+r),this.pos),this.pos+=r,o+=r,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){fi(this),Tr(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:i,isLE:s}=this,{pos:o}=this;t[o++]=128,this.buffer.subarray(o).fill(0),this.padOffset>i-o&&(this.process(n,0),o=0);for(let p=o;p<i;p++)t[p]=0;fs(n,i-8,BigInt(this.length*8),s),this.process(n,0);let r=hn(e),u=this.outputLen;if(u%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let a=u/4,c=this.get();if(a>c.length)throw new Error("_sha2: outputLen bigger than state");for(let p=0;p<a;p++)r.setUint32(4*p,c[p],s)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:i,finished:s,destroyed:o,pos:r}=this;return e.length=i,e.pos=r,e.finished=s,e.destroyed=o,i%t&&e.buffer.set(n),e}};var bs=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),pt=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),dt=new Uint32Array(64),yi=class extends xn{constructor(){super(64,32,8,!1),this.A=pt[0]|0,this.B=pt[1]|0,this.C=pt[2]|0,this.D=pt[3]|0,this.E=pt[4]|0,this.F=pt[5]|0,this.G=pt[6]|0,this.H=pt[7]|0}get(){let{A:e,B:t,C:n,D:i,E:s,F:o,G:r,H:u}=this;return[e,t,n,i,s,o,r,u]}set(e,t,n,i,s,o,r,u){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=s|0,this.F=o|0,this.G=r|0,this.H=u|0}process(e,t){for(let p=0;p<16;p++,t+=4)dt[p]=e.getUint32(t,!1);for(let p=16;p<64;p++){let l=dt[p-15],d=dt[p-2],y=qe(l,7)^qe(l,18)^l>>>3,b=qe(d,17)^qe(d,19)^d>>>10;dt[p]=b+dt[p-7]+y+dt[p-16]|0}let{A:n,B:i,C:s,D:o,E:r,F:u,G:a,H:c}=this;for(let p=0;p<64;p++){let l=qe(r,6)^qe(r,11)^qe(r,25),d=c+l+xr(r,u,a)+bs[p]+dt[p]|0,b=(qe(n,2)^qe(n,13)^qe(n,22))+Ir(n,i,s)|0;c=a,a=u,u=r,r=o+d|0,o=s,s=i,i=n,n=d+b|0}n=n+this.A|0,i=i+this.B|0,s=s+this.C|0,o=o+this.D|0,r=r+this.E|0,u=u+this.F|0,a=a+this.G|0,c=c+this.H|0,this.set(n,i,s,o,r,u,a,c)}roundClean(){dt.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var Br=hr(()=>new yi);var gy=re("Raydium_Util");function Sr({fromPublicKey:m,programId:e=Ps,assignSeed:t}){let n=t?btoa(t).slice(0,32):ys.generate().publicKey.toBase58().slice(0,32);return{publicKey:ks(m,n,e),seed:n}}function ks(m,e,t){let n=Buffer.concat([m.toBuffer(),Buffer.from(e),t.toBuffer()]),i=Br(n);return new gs(i)}import{PublicKey as As,SystemProgram as ws}from"@solana/web3.js";import Ts from"bn.js";import{createCloseAccountInstruction as hs,createInitializeAccountInstruction as xs,createTransferInstruction as Ky,TOKEN_PROGRAM_ID as en}from"@solana/spl-token";function Is(m){let{mint:e,tokenAccount:t,owner:n,programId:i=en}=m;return xs(t,e,n,i)}function tn(m){let{tokenAccount:e,payer:t,multiSigners:n=[],owner:i,programId:s=en}=m;return hs(e,t,i,n,s)}async function Kr(m){let{connection:e,amount:t,commitment:n,payer:i,owner:s,skipCloseAccount:o}=m,r=await e.getMinimumBalanceForRentExemption($t.span,n),u=oe(t).add(new Ts(r)),a=Sr({fromPublicKey:i,programId:en});return{addresses:{newAccount:a.publicKey},signers:[],instructions:[ws.createAccountWithSeed({fromPubkey:i,basePubkey:i,seed:a.seed,newAccountPubkey:a.publicKey,lamports:u.toNumber(),space:$t.span,programId:en}),Is({mint:new As(Ue.address),tokenAccount:a.publicKey,owner:s,programId:en})],instructionTypes:[Y.CreateAccount,Y.InitAccount],endInstructionTypes:o?[]:[Y.CloseAccount],endInstructions:o?[]:[tn({tokenAccount:a.publicKey,payer:i,owner:s})]}}var Bs=W([Ne("mintAuthorityOption"),L("mintAuthority"),P("supply"),G("decimals"),G("isInitialized"),Ne("freezeAuthorityOption"),L("freezeAuthority")]);function Ks({programId:m}){let{publicKey:e}=ge([Buffer.from("amm_config_account_seed","utf-8")],m);return e}function Cr({programId:m}){return ge([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],m)}var gi={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]},Lr=m=>{let e={},t=Ss.toBase58();return Object.keys(m).map(n=>{let i=m[n],[s,o]=[i.baseMint.toBase58(),i.quoteMint.toBase58()];e[n]={id:n,version:4,status:i.status.toNumber(),programId:i.programId.toBase58(),mintA:kt({address:s,programId:t,decimals:i.baseDecimal.toNumber()}),mintB:kt({address:o,programId:t,decimals:i.quoteDecimal.toNumber()}),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:i.poolPrice.toNumber(),mintAmountA:new In(i.mintAAmount.toString()).div(10**i.baseDecimal.toNumber()).toNumber(),mintAmountB:new In(i.mintBAmount.toString()).div(10**i.quoteDecimal.toNumber()).toNumber(),baseReserve:i.baseReserve,quoteReserve:i.quoteReserve,feeRate:new In(i.tradeFeeNumerator.toString()).div(i.tradeFeeDenominator.toString()).toNumber(),openTime:i.poolOpenTime.toString(),tvl:0,day:gi,week:gi,month:gi,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,type:"Standard",marketId:i.marketId.toBase58(),configId:Ks({programId:i.programId}).toBase58(),lpPrice:0,lpAmount:new In(i.lpReserve.toString()).div(10**Math.min(i.baseDecimal.toNumber(),i.quoteDecimal.toNumber())).toNumber(),lpMint:kt({address:i.lpMint.toBase58(),programId:t,decimals:Math.min(i.baseDecimal.toNumber(),i.quoteDecimal.toNumber())}),burnPercent:0}}),e};var Rr={[Un.toBase58()]:3},Nr={3:Un};var Pi=W([Pe(5),Pe(8),L("ownAddress"),P("vaultSignerNonce"),L("baseMint"),L("quoteMint"),L("baseVault"),P("baseDepositsTotal"),P("baseFeesAccrued"),L("quoteVault"),P("quoteDepositsTotal"),P("quoteFeesAccrued"),P("quoteDustThreshold"),L("requestQueue"),L("eventQueue"),L("bids"),L("asks"),P("baseLotSize"),P("quoteLotSize"),P("feeRateBps"),P("referrerRebatesAccrued"),Pe(7)]),Mr={3:Pi};import{PublicKey as Or}from"@solana/web3.js";var Bn=re("Serum"),Sn=class{static getProgramId(e){let t=Nr[e];return t||Bn.logWithError("invalid version","version",e),t}static getVersion(e){let t=e.toBase58(),n=Rr[t];return n||Bn.logWithError("invalid program id","programId",t),n}static getStateLayout(e){let t=Mr[e];return t||Bn.logWithError(!!t,"invalid version","version",e),t}static getLayouts(e){return{state:this.getStateLayout(e)}}static getAssociatedAuthority({programId:e,marketId:t}){let n=[t.toBuffer()],i=0,s;for(;i<100;){try{let o=n.concat(Buffer.from([i]),Buffer.alloc(7));s=Or.createProgramAddressSync(o,e)}catch(o){if(o instanceof TypeError)throw o;i++;continue}return{publicKey:s,nonce:i}}return Bn.logWithError("unable to find a viable program address nonce","params",{programId:e,marketId:t}),{publicKey:Or.default,nonce:i}}};import{PublicKey as q,SystemProgram as Cs,TransactionInstruction as Ls}from"@solana/web3.js";import xt from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Rs,TOKEN_2022_PROGRAM_ID as Ns,TOKEN_PROGRAM_ID as Ms}from"@solana/spl-token";function Os(m,e,t,n,i,s,o,r,u,a,c,p,l,d,y){var k;let b=[],f=[S({pubkey:Ms,isWritable:!1}),S({pubkey:Ns,isWritable:!1}),S({pubkey:Rs,isWritable:!1}),S({pubkey:Cs.programId,isWritable:!1}),S({pubkey:e,isSigner:!0})];f.push(S({pubkey:t})),f.push(S({pubkey:i}));let g=[u,a],w=[c,p],I=[s,o,r];for(let B=0;B<g.length;B++){let x=g[B],R=I[B]===x.mintA.address;if(f.push(S({pubkey:new q(x.programId),isWritable:!1})),B===g.length-1?f.push(S({pubkey:i})):f.push(S({pubkey:n})),f.push(S({pubkey:new q(I[B])})),f.push(S({pubkey:new q(I[B+1])})),x.version===6){let h=w[B];f.push(S({pubkey:new q(h.config.id)})),f.push(S({pubkey:new q(h.id)})),f.push(S({pubkey:new q(R?h.vault.A:h.vault.B)})),f.push(S({pubkey:new q(R?h.vault.B:h.vault.A)})),f.push(S({pubkey:new q(x.observationId)})),f.push(S({pubkey:Bt})),f.push(S({pubkey:ke(new q(x.programId),new q(x.id)).publicKey})),b.push(Es(x.sqrtPriceX64.toString(),R));for(let C of(k=y[B])!=null?k:[])f.push(S({pubkey:new q(C)}))}else if(x.version===5){let h=w[B];f.push(S({pubkey:new q(h.id)})),f.push(S({pubkey:new q(h.authority),isWritable:!1})),f.push(S({pubkey:new q(h.marketProgramId)})),f.push(S({pubkey:new q(h.marketAuthority)})),f.push(S({pubkey:vi,isWritable:!1})),f.push(S({pubkey:new q(h.openOrders)})),f.push(S({pubkey:new q(h.vault.A)})),f.push(S({pubkey:new q(h.vault.B)})),f.push(S({pubkey:new q(h.id)})),f.push(S({pubkey:new q(h.id)})),f.push(S({pubkey:new q(h.id)})),f.push(S({pubkey:new q(h.id)})),f.push(S({pubkey:new q(h.id)})),f.push(S({pubkey:new q(h.id)})),f.push(S({pubkey:new q(h.marketId)})),f.push(S({pubkey:new q(h.marketBids)})),f.push(S({pubkey:new q(h.marketAsks)})),f.push(S({pubkey:new q(h.marketEventQueue)})),f.push(S({pubkey:new q(h.marketBaseVault)})),f.push(S({pubkey:new q(h.marketQuoteVault)}))}else if(x.version===4){let h=w[B],C=x.status!==1;f.push(S({pubkey:new q(h.id)})),f.push(S({pubkey:new q(h.authority),isWritable:!1})),f.push(S({pubkey:new q(C?h.id:h.marketProgramId)})),f.push(S({pubkey:new q(C?h.id:h.marketAuthority)})),f.push(S({pubkey:new q(C?h.id:h.openOrders)})),f.push(S({pubkey:new q(h.vault.A)})),f.push(S({pubkey:new q(h.vault.B)})),f.push(S({pubkey:new q(C?h.id:h.marketId)})),f.push(S({pubkey:new q(C?h.id:h.marketBids)})),f.push(S({pubkey:new q(C?h.id:h.marketAsks)})),f.push(S({pubkey:new q(C?h.id:h.marketEventQueue)})),f.push(S({pubkey:new q(C?h.id:h.marketBaseVault)})),f.push(S({pubkey:new q(C?h.id:h.marketQuoteVault)}))}else if(x.version===7){let h=w[B];f.push(S({pubkey:new q(h.authority)})),f.push(S({pubkey:new q(h.config.id)})),f.push(S({pubkey:new q(h.id)})),f.push(S({pubkey:new q(R?h.vault.A:h.vault.B)})),f.push(S({pubkey:new q(R?h.vault.B:h.vault.A)})),f.push(S({pubkey:new q(x.observationId)}))}else throw Error("pool type error")}let T=W([G("insId"),P("amountIn"),P("amountOut"),Z(U(),b.length,"clmmPriceLimit")]),A=Buffer.alloc(T.span);return T.encode({insId:0,amountIn:l,amountOut:d,clmmPriceLimit:b},A),new Ls({keys:f,programId:m,data:A})}function Es(m,e){if(m)if(e){let t=new xt(m).div(new xt(25));return t.gt(yn)?t:yn}else{let t=new xt(m).mul(new xt(25));return t.lt(gn)?t:gn}else return e?yn:gn}function Er({routeProgram:m,ownerInfo:e,inputMint:t,swapInfo:n}){var i,s,o,r,u,a,c;if(n.routeType==="amm")if(n.poolInfo[0].version===6){let p=n.poolKey[0],l=bt(p),d=t.equals(l.mintA.address)?Qe.add(Me):He.sub(Me);return ht.makeSwapBaseInInstructions({poolInfo:p,poolKeys:p,observationId:n.poolInfo[0].observationId,ownerInfo:{wallet:e.wallet,tokenAccountA:l.mintA.address.equals(t)?e.sourceToken:e.destinationToken,tokenAccountB:l.mintA.address.equals(t)?e.destinationToken:e.sourceToken},inputMint:t,amountIn:n.amountIn.amount.raw,amountOutMin:n.minAmountOut.amount.raw.sub((s=(i=n.minAmountOut.fee)==null?void 0:i.raw)!=null?s:new xt(0)),sqrtPriceLimitX64:d,remainingAccounts:(o=n.remainingAccounts[0])!=null?o:[]})}else if(n.poolInfo[0].version===7){let p=n.poolInfo[0],l=t.toString()===n.poolInfo[0].mintA.address;return{signers:[],instructions:[yr(p.programId,e.wallet,p.authority,p.configId,p.id,e.sourceToken,e.destinationToken,l?p.vaultA:p.vaultB,l?p.vaultB:p.vaultA,l?p.mintProgramA:p.mintProgramB,l?p.mintProgramB:p.mintProgramA,new q(p[l?"mintA":"mintB"].address),new q(p[l?"mintB":"mintA"].address),p.observationId,n.amountIn.amount.raw,n.minAmountOut.amount.raw)],lookupTableAddress:[],instructionTypes:[l?Y.CpmmSwapBaseIn:Y.CpmmSwapBaseOut],address:{}}}else{let p=n.poolKey[0];return{signers:[],instructions:[wr({poolKeys:p,version:n.poolInfo[0].pooltype.includes("StablePool")?5:4,userKeys:{tokenAccountIn:e.sourceToken,tokenAccountOut:e.destinationToken,owner:e.wallet},amountIn:n.amountIn.amount.raw,amountOut:n.minAmountOut.amount.raw.sub((u=(r=n.minAmountOut.fee)==null?void 0:r.raw)!=null?u:new xt(0)),fixedSide:"in"})],lookupTableAddress:p.lookupTableAccount?[p.lookupTableAccount]:[],instructionTypes:[n.poolInfo[0].pooltype.includes("StablePool")?Y.AmmV5SwapBaseIn:Y.AmmV4SwapBaseIn],address:{}}}else if(n.routeType==="route"){let p=n.poolInfo[0],l=n.poolInfo[1],d=n.poolKey[0],y=n.poolKey[1];if(e.routeToken===void 0)throw Error("owner route token account check error");return{signers:[],instructions:[Os(m,e.wallet,e.sourceToken,e.routeToken,e.destinationToken,t.toString(),n.middleToken.mint.toString(),n.outputMint.toString(),p,l,d,y,n.amountIn.amount.raw,n.minAmountOut.amount.raw.sub((c=(a=n.minAmountOut.fee)==null?void 0:a.raw)!=null?c:new xt(0)),n.remainingAccounts)],instructionTypes:[Y.RouteSwap],lookupTableAddress:[d.lookupTableAccount,y.lookupTableAccount].filter(b=>b!==void 0),address:{}}}else throw Error("route type error")}var at=new Cn(0),ki=class extends Lt{constructor(e){super(e)}async getWSolAccounts(){this.scope.checkOwner(),await this.scope.account.fetchWalletTokenAccounts();let e=this.scope.account.tokenAccounts.filter(t=>t.mint.equals(_e));return e.sort((t,n)=>t.isAssociated?1:n.isAssociated||t.amount.lt(n.amount)?-1:1),e}async unWrapWSol(e){let{amount:t,tokenProgram:n,txVersion:i=1,feePayer:s}=e,o=await this.getWSolAccounts(),r=this.createTxBuilder(s);r.addCustomComputeBudget(e.computeBudgetConfig);let u=oe(t);for(let a=0;a<o.length;a++)u.gte(o[a].amount)?(r.addInstruction({instructions:[tn({tokenAccount:o[a].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),u.sub(o[a].amount)):r.addInstruction({instructions:[tn({tokenAccount:o[a].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]});return r.versionBuild({txVersion:i})}async wrapWSol(e,t,n,i){let s=this.createTxBuilder(i),o=await Kr({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:e,skipCloseAccount:!0});return s.addInstruction(o),s.versionBuild({txVersion:n!=null?n:1})}async swap({swapInfo:e,swapPoolKeys:t,ownerInfo:n,computeBudgetConfig:i,routeProgram:s,txVersion:o,feePayer:r}){let u=this.createTxBuilder(r),a=e.amountIn,c=e.amountOut,p=a.amount.token.mint.equals(_e),l=c.amount.token.mint.equals(_e),d=a.amount.token.mint,y=c.amount.token.mint,{account:b,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:a.amount.token.isToken2022?Kn:ye,mint:d,notUseTokenAccount:p,owner:this.scope.ownerPubKey,skipCloseAccount:!p,createInfo:p?{payer:this.scope.ownerPubKey,amount:a.amount.raw}:void 0,associatedOnly:p?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});if(f&&u.addInstruction(f),b===void 0)throw Error("input account check error");let g;if(e.routeType==="route"&&!l)g=this.scope.account.getAssociatedTokenAccount(y,c.amount.token.isToken2022?Kn:ye);else{let{account:A,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:c.amount.token.isToken2022?Kn:ye,mint:y,notUseTokenAccount:l,owner:this.scope.ownerPubKey,skipCloseAccount:!0,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:l?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});g=A,k&&u.addInstruction(k)}l&&u.addInstruction({endInstructions:[tn({owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,tokenAccount:g,programId:ye})],endInstructionTypes:[Y.CloseAccount]});let w;if(e.routeType==="route"){let A=e.middleToken;w=this.scope.account.getAssociatedTokenAccount(A.mint,A.isToken2022?Kn:ye)}let I=t||await this.computePoolToPoolKeys({pools:e.poolInfoList}),T=Er({routeProgram:s,inputMint:d,swapInfo:X(V({},e),{poolInfo:[...e.poolInfoList],poolKey:I,outputMint:y}),ownerInfo:{wallet:this.scope.ownerPubKey,sourceToken:b,routeToken:w,destinationToken:g}});if(e.feeConfig!==void 0){let A=this.createTxBuilder();A.addInstruction({instructions:[Wr(b,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[Y.TransferAmount]}),A.addInstruction(T);let{transactions:k}=o===0?await A.sizeCheckBuildV0():await A.sizeCheckBuild();k.length<2&&u.addInstruction({instructions:[Wr(b,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[Y.TransferAmount]})}return u.addInstruction(T),o===0?u.sizeCheckBuildV0({computeBudgetConfig:i,address:T.address}):u.sizeCheckBuild({computeBudgetConfig:i,address:T.address})}async fetchRoutePoolBasicInfo(e){let{amm:t=_i,clmm:n=Xn,cpmm:i=zn}=e||{},s=await this.scope.connection.getProgramAccounts(t,{dataSlice:{offset:pi.offsetOf("baseMint"),length:64}}),o=W([L("baseMint"),L("quoteMint")]),r=s.map(d=>({id:d.pubkey,version:4,mintA:o.decode(d.account.data).baseMint,mintB:o.decode(d.account.data).quoteMint})),u=W([L("mintA"),L("mintB")]),c=(await this.scope.connection.getProgramAccounts(n,{filters:[{dataSize:Nt.span}],dataSlice:{offset:Nt.offsetOf("mintA"),length:64}})).map(d=>{let y=u.decode(d.account.data);return{id:d.pubkey,version:6,mintA:y.mintA,mintB:y.mintB}}),l=(await this.scope.connection.getProgramAccounts(i,{dataSlice:{offset:fr.offsetOf("mintA"),length:64}})).map(d=>{let y=u.decode(d.account.data);return{id:d.pubkey,version:7,mintA:y.mintA,mintB:y.mintB}});return{clmmPools:c,ammPools:r,cpmmPools:l}}getAllRoute({inputMint:e,outputMint:t,clmmPools:n,ammPools:i,cpmmPools:s}){e=e.toString()===It.default.toString()?_e:e,t=t.toString()===It.default.toString()?_e:t;let o={},r={},u={},a=[],c={};for(let l of n!=null?n:[]){if((l.mintA.equals(e)&&l.mintB.equals(t)||l.mintA.equals(t)&&l.mintB.equals(e))&&(a.push(l),r[l.id.toString()]=l),l.mintA.equals(e)){let d=l.mintB.toString();c[d]===void 0&&(c[d]={mintProgram:ye,in:[],out:[],mDecimals:0}),c[d].in.push(l)}if(l.mintB.equals(e)){let d=l.mintA.toString();c[d]===void 0&&(c[d]={mintProgram:ye,in:[],out:[],mDecimals:0}),c[d].in.push(l)}if(l.mintA.equals(t)){let d=l.mintB.toString();c[d]===void 0&&(c[d]={mintProgram:ye,in:[],out:[],mDecimals:0}),c[d].out.push(l)}if(l.mintB.equals(t)){let d=l.mintA.toString();c[d]===void 0&&(c[d]={mintProgram:ye,in:[],out:[],mDecimals:0}),c[d].out.push(l)}}let p=[];for(let l of i)(l.mintA.equals(e)&&l.mintB.equals(t)||l.mintA.equals(t)&&l.mintB.equals(e))&&(a.push(l),o[l.id.toBase58()]=l,p.push(l)),l.mintA.equals(e)&&(c[l.mintB.toBase58()]===void 0&&(c[l.mintB.toBase58()]={mintProgram:ye,in:[],out:[],mDecimals:0}),c[l.mintB.toBase58()].in.push(l)),l.mintB.equals(e)&&(c[l.mintA.toBase58()]===void 0&&(c[l.mintA.toBase58()]={mintProgram:ye,in:[],out:[],mDecimals:0}),c[l.mintA.toBase58()].in.push(l)),l.mintA.equals(t)&&(c[l.mintB.toBase58()]===void 0&&(c[l.mintB.toBase58()]={mintProgram:ye,in:[],out:[],mDecimals:0}),c[l.mintB.toBase58()].out.push(l)),l.mintB.equals(t)&&(c[l.mintA.toBase58()]===void 0&&(c[l.mintA.toBase58()]={mintProgram:ye,in:[],out:[],mDecimals:0}),c[l.mintA.toBase58()].out.push(l));for(let l of s)(l.mintA.equals(e)&&l.mintB.equals(t)||l.mintA.equals(t)&&l.mintB.equals(e))&&(a.push(l),u[l.id.toBase58()]=l),l.mintA.equals(e)&&(c[l.mintB.toBase58()]===void 0&&(c[l.mintB.toBase58()]={mintProgram:ye,in:[],out:[],mDecimals:0}),c[l.mintB.toBase58()].in.push(l)),l.mintB.equals(e)&&(c[l.mintA.toBase58()]===void 0&&(c[l.mintA.toBase58()]={mintProgram:ye,in:[],out:[],mDecimals:0}),c[l.mintA.toBase58()].in.push(l)),l.mintA.equals(t)&&(c[l.mintB.toBase58()]===void 0&&(c[l.mintB.toBase58()]={mintProgram:ye,in:[],out:[],mDecimals:0}),c[l.mintB.toBase58()].out.push(l)),l.mintB.equals(t)&&(c[l.mintA.toBase58()]===void 0&&(c[l.mintA.toBase58()]={mintProgram:ye,in:[],out:[],mDecimals:0}),c[l.mintA.toBase58()].out.push(l));for(let l of Object.keys(c)){if(c[l].in.length===1&&c[l].out.length===1&&c[l].in[0].id.equals(c[l].out[0].id)){delete c[l];continue}if(c[l].in.length===0||c[l].out.length===0){delete c[l];continue}let d=c[l];for(let y of d.in)for(let b of d.out)y.version===6&&r[y.id.toString()]===void 0?r[y.id.toString()]=y:y.version===7&&u[y.id.toString()]===void 0?u[y.id.toString()]=y:(y.version===4||y.version===5)&&o[y.id.toString()]===void 0&&(o[y.id.toString()]=y),b.version===6&&r[b.id.toString()]===void 0?r[b.id.toString()]=b:b.version===7&&u[b.id.toString()]===void 0?u[b.id.toString()]=b:(b.version===4||b.version===5)&&o[b.id.toString()]===void 0&&(o[b.id.toString()]=b)}return{directPath:a,addLiquidityPools:p,routePathDict:c,needSimulate:Object.values(o),needTickArray:Object.values(r),cpmmPoolList:Object.values(u)}}async fetchSwapRoutesData({routes:e,inputMint:t,outputMint:n}){let i=new Set([...e.needTickArray.map(b=>[b.mintA.toBase58(),b.mintB.toBase58()]).flat(),t.toString(),n.toString()]);console.log("fetching amm pools info, total: ",e.needSimulate.length);let s=await this.scope.liquidity.getRpcPoolInfos(e.needSimulate.map(b=>b.id)),o=Lr(s),r={};Object.values(o).forEach(b=>{i.delete(b.mintA.address),r[b.mintA.address]={address:new It(b.mintA.address),programId:ye,mintAuthority:null,supply:BigInt(0),decimals:b.mintA.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0},i.delete(b.mintB.address),r[b.mintB.address]={address:new It(b.mintB.address),programId:ye,mintAuthority:null,supply:BigInt(0),decimals:b.mintB.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}}),console.log("fetching cpmm pools info, total: ",e.cpmmPoolList.length);let u=await this.scope.cpmm.getRpcPoolInfos(e.cpmmPoolList.map(b=>b.id.toBase58()),!0);Object.values(u).forEach(b=>{let[f,g]=[b.mintA.toBase58(),b.mintB.toBase58()];b.mintProgramA.equals(ye)?(i.delete(f),r[f]={address:b.mintA,programId:b.mintProgramA,mintAuthority:null,supply:BigInt(0),decimals:b.mintDecimalA,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):i.add(f),b.mintProgramB.equals(ye)?(i.delete(g),r[g]={address:b.mintB,programId:b.mintProgramB,mintAuthority:null,supply:BigInt(0),decimals:b.mintDecimalB,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):i.add(g)}),console.log("fetching mints info, total: ",i.size);let a=await On({connection:this.scope.connection,mints:Array.from(i).map(b=>new It(b))});r=V(V({},r),a);let c=this.scope.cpmm.toComputePoolInfos({pools:u,mintInfos:r});console.log("fetching clmm pools info, total:",e.needTickArray.length);let p=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:e.needTickArray.map(b=>b.id)}),{computeClmmPoolInfo:l,computePoolTickData:d}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:p,mintInfos:r}),y=Object.keys(e.routePathDict).reduce((b,f)=>X(V({},b),{[f]:X(V({},e.routePathDict[f]),{mintProgram:r[f].programId,mDecimals:r[f].decimals,in:e.routePathDict[f].in.map(g=>o[g.id.toBase58()]||l[g.id.toBase58()]||c[g.id.toBase58()]),out:e.routePathDict[f].out.map(g=>o[g.id.toBase58()]||l[g.id.toBase58()]||c[g.id.toBase58()])})}),{});return{mintInfos:r,ammPoolsRpcInfo:s,ammSimulateCache:o,clmmPoolsRpcInfo:p,computeClmmPoolInfo:l,computePoolTickData:d,computeCpmmData:c,routePathDict:y}}getAllRouteComputeAmountOut({inputTokenAmount:e,outputToken:t,directPath:n,routePathDict:i,simulateCache:s,tickCache:o,slippage:r,chainTime:u,epochInfo:a,feeConfig:c}){var g,w,I,T,A,k,B,x,R;let p=c===void 0?new Cn(0):e.raw.mul(new Cn(c.feeBps.toNumber())).div(new Cn(1e4)),l=e.raw.sub(p),d=new se(e.token,l),y=c===void 0?void 0:{feeAmount:p,feeAccount:c.feeAccount},b=X(V({},t),{address:Ge(t.address).toString()}),f=[];for(let h of n)try{f.push(X(V({},this.computeAmountOut({itemPool:h,tickCache:o,simulateCache:s,chainTime:u,epochInfo:a,slippage:r,outputToken:b,amountIn:d})),{feeConfig:y}))}catch(C){this.logDebug("direct error",h.version,h.id.toString(),C.message)}this.logDebug("direct done");for(let[h,C]of Object.entries(i)){let E={chainId:101,address:h,programId:C.mintProgram.toBase58(),logoURI:"",symbol:"",name:"",decimals:C.mDecimals,tags:[],extensions:{}},O=C.in.map(j=>{try{return{pool:j,data:this.computeAmountOut({itemPool:j,tickCache:o,simulateCache:s,chainTime:u,epochInfo:a,slippage:r,outputToken:E,amountIn:d})}}catch(D){this.logDebug("route in error",j.version,j.id.toString(),D.message);return}}).sort((j,D)=>{var Fe,ut,Te,fe;let we=j===void 0?at:j.data.amountOut.amount.raw.sub((ut=(Fe=j.data.amountOut.fee)==null?void 0:Fe.raw)!=null?ut:at),Se=D===void 0?at:D.data.amountOut.amount.raw.sub((fe=(Te=D.data.amountOut.fee)==null?void 0:Te.raw)!=null?fe:at);return we.lt(Se)?1:-1})[0];if(O===void 0)continue;let _=new se(ji(E),O.data.amountOut.amount.raw.sub((w=(g=O.data.amountOut.fee)==null?void 0:g.raw)!=null?w:at));for(let j of C.out)try{let D=this.computeAmountOut({itemPool:j,tickCache:o,simulateCache:s,chainTime:u,epochInfo:a,slippage:r,outputToken:b,amountIn:_});f.push(X(V({},D),{allTrade:!!(O.data.allTrade&&D.allTrade),amountIn:O.data.amountIn,amountOut:D.amountOut,minAmountOut:D.minAmountOut,currentPrice:void 0,executionPrice:new nn(new Ce({baseToken:O.data.amountIn.amount.token,denominator:O.data.amountIn.amount.raw,quoteToken:D.amountOut.amount.token,numerator:D.amountOut.amount.raw.sub((T=(I=D.amountOut.fee)==null?void 0:I.raw)!=null?T:at)}).toFixed()),priceImpact:new nn(O.data.priceImpact.add(D.priceImpact).toFixed()),fee:[O.data.fee[0],D.fee[0]],routeType:"route",poolInfoList:[O.pool,j],remainingAccounts:[O.data.remainingAccounts[0],D.remainingAccounts[0]],minMiddleAmountFee:(A=D.amountOut.fee)!=null&&A.raw?new se(O.data.amountOut.amount.token,((B=(k=O.data.amountOut.fee)==null?void 0:k.raw)!=null?B:at).add((R=(x=D.amountOut.fee)==null?void 0:x.raw)!=null?R:at)):void 0,middleToken:O.data.amountOut.amount.token,poolReady:O.data.poolReady&&D.poolReady,poolType:[O.data.poolType,D.poolType],feeConfig:y,expirationTime:De(O.data.expirationTime,D.expirationTime)}))}catch(D){this.logDebug("route out error",j.version,j.id.toString(),D.message)}}return f.filter(h=>(h.allTrade||this.logDebug(`pool ${h.poolInfoList.map(C=>C.id.toString()).join(",")} filter out since not all trade`),h.allTrade)).sort((h,C)=>h.amountOut.amount.raw.sub(C.amountOut.amount.raw).gt(at)?-1:1)}computeAmountOut({itemPool:e,tickCache:t,simulateCache:n,chainTime:i,epochInfo:s,slippage:o,outputToken:r,amountIn:u}){if(e.version===6){let{allTrade:a,realAmountIn:c,amountOut:p,minAmountOut:l,expirationTime:d,currentPrice:y,executionPrice:b,priceImpact:f,fee:g,remainingAccounts:w,executionPriceX64:I}=pe.computeAmountOutFormat({poolInfo:e,tickArrayCache:t[e.id.toString()],amountIn:u.raw,tokenOut:r,slippage:o,epochInfo:s,catchLiquidityInsufficient:!0});return{allTrade:a,amountIn:c,amountOut:p,minAmountOut:l,currentPrice:new nn(y.toFixed()),executionPrice:new nn(b.toFixed()),priceImpact:new nn(f.toFixed()),fee:[g],remainingAccounts:[w],routeType:"amm",poolInfoList:[e],poolReady:e.startTime<i,poolType:"CLMM",slippage:o,clmmExPriceX64:[I],expirationTime:De(c.expirationTime,d)}}else if(e.version===7){let{allTrade:a,executionPrice:c,amountOut:p,minAmountOut:l,priceImpact:d,fee:y}=this.scope.cpmm.computeSwapAmount({pool:e,outputMint:r.address,amountIn:u.raw,slippage:o});return{allTrade:a,amountIn:{amount:u,fee:void 0,expirationTime:void 0},amountOut:{amount:zt(X(V({},r),{amount:p})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:zt(X(V({},r),{amount:l})),fee:void 0,expirationTime:void 0},currentPrice:e.poolPrice,executionPrice:c,priceImpact:d,fee:[new se(u.token,y)],remainingAccounts:[],routeType:"amm",poolInfoList:[e],poolReady:e.openTime.toNumber()<i,poolType:"CPMM",slippage:o,clmmExPriceX64:[void 0],expirationTime:void 0}}else{if(![1,6,7].includes(n[e.id.toString()].status))throw Error("swap error");let{amountOut:a,minAmountOut:c,currentPrice:p,executionPrice:l,priceImpact:d,fee:y}=this.scope.liquidity.computeAmountOut({poolInfo:n[e.id.toString()],amountIn:u.raw,mintIn:u.token.mint,mintOut:r.address,slippage:o});return{amountIn:{amount:u,fee:void 0,expirationTime:void 0},amountOut:{amount:zt(X(V({},r),{amount:a})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:zt(X(V({},r),{amount:c})),fee:void 0,expirationTime:void 0},currentPrice:p,executionPrice:l,priceImpact:d,fee:[new se(u.token,y)],routeType:"amm",poolInfoList:[e],remainingAccounts:[],poolReady:Number(n[e.id].openTime)<i,poolType:e.version===5?"STABLE":void 0,expirationTime:void 0,allTrade:!0,slippage:o,clmmExPriceX64:[void 0]}}}async computePoolToPoolKeys({pools:e,clmmRpcData:t={},ammRpcData:n={}}){let i=new Set(e.filter(a=>a.version===6&&!t[a.id.toString()]).map(a=>a.id.toString()));if(i.size>0){let a=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:Array.from(i)});Object.keys(a).forEach(c=>{t[c]=a[c]})}let s=new Set(e.filter(a=>a.version===4&&!n[a.id.toString()]).map(a=>a.id.toString()));if(s.size>0){let a=await this.scope.liquidity.getRpcPoolInfos(Array.from(s));Object.keys(a).forEach(c=>{n[c]=a[c]})}let o=new Set(e.filter(a=>a.version===4).map(a=>a.marketId)),r={};o.size>0&&(await ft(this.scope.connection,Array.from(o).map(c=>({pubkey:new It(c)})))).forEach(c=>{if(!c.accountInfo)return;let p=Pi.decode(c.accountInfo.data);r[c.pubkey.toBase58()]={marketId:c.pubkey.toString(),marketProgramId:c.accountInfo.owner.toString(),marketAuthority:Sn.getAssociatedAuthority({programId:c.accountInfo.owner,marketId:c.pubkey}).publicKey.toString(),marketBaseVault:p.baseVault.toString(),marketQuoteVault:p.quoteVault.toString(),marketBids:p.bids.toString(),marketAsks:p.asks.toString(),marketEventQueue:p.eventQueue.toString()}});let u=[];return e.forEach(a=>{if(a.version===6){let c=t[a.id.toString()],p={programId:a.programId.toBase58(),id:a.id.toBase58(),mintA:a.mintA,mintB:a.mintB,openTime:String(a.startTime),vault:{A:c.vaultA.toBase58(),B:c.vaultB.toBase58()},config:X(V({},a.ammConfig),{id:a.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]}),rewardInfos:[],observationId:a.observationId.toBase58(),exBitmapAccount:a.exBitmapAccount.toBase58()};u.push(p)}else if(a.version===4){let c=n[a.id.toString()],p=V({programId:a.programId,id:a.id,mintA:a.mintA,mintB:a.mintB,openTime:String(a.openTime),vault:{A:c.baseVault.toBase58(),B:c.quoteVault.toBase58()},authority:Cr({programId:new It(a.programId)}).publicKey.toString(),openOrders:c.openOrders.toBase58(),targetOrders:c.targetOrders.toBase58(),mintLp:a.lpMint},r[a.marketId]);u.push(p)}else a.version===7&&u.push({observationId:a.observationId.toBase58(),programId:a.programId.toBase58(),id:a.id.toBase58(),mintA:a.mintA,mintB:a.mintB,openTime:String(a.openTime),authority:br(a.programId).publicKey.toBase58(),vault:{A:a.vaultA.toBase58(),B:a.vaultB.toBase58()},mintLp:kt({address:a.mintLp.toBase58(),programId:ye.toBase58(),decimals:a.lpDecimals}),config:X(V({id:a.configId.toBase58()},a.configInfo),{protocolFeeRate:a.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:a.configInfo.tradeFeeRate.toNumber(),fundFeeRate:a.configInfo.fundFeeRate.toNumber(),createPoolFee:a.configInfo.createPoolFee.toString()})})}),u}};export{ki as default};
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
//# sourceMappingURL=trade.mjs.map