var pm=Object.defineProperty,fm=Object.defineProperties;var ym=Object.getOwnPropertyDescriptors;var ur=Object.getOwnPropertySymbols;var Ou=Object.prototype.hasOwnProperty,Nu=Object.prototype.propertyIsEnumerable;var Lu=(a,e,t)=>e in a?pm(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,v=(a,e)=>{for(var t in e||(e={}))Ou.call(e,t)&&Lu(a,t,e[t]);if(ur)for(var t of ur(e))Nu.call(e,t)&&Lu(a,t,e[t]);return a},q=(a,e)=>fm(a,ym(e));var De=(a,e)=>{var t={};for(var n in a)Ou.call(a,n)&&e.indexOf(n)<0&&(t[n]=a[n]);if(a!=null&&ur)for(var n of ur(a))e.indexOf(n)<0&&Nu.call(a,n)&&(t[n]=a[n]);return t};import ac from"axios";import{PublicKey as Fu}from"@solana/web3.js";import{get as Ps,set as Mu}from"lodash";var bm=(o=>(o[o.Error=0]="Error",o[o.Warning=1]="Warning",o[o.Info=2]="Info",o[o.Debug=3]="Debug",o))(bm||{}),ks=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Date.now().toString()}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},ws={},vu={};function ye(a){let e=Ps(ws,a);if(!e){let t=Ps(vu,a);e=new ks({name:a,logLevel:t}),Mu(ws,a,e)}return e}function Ty(a,e){Mu(vu,a,e);let t=Ps(ws,a);t&&(t.level=e)}import{MINT_SIZE as gm,TOKEN_PROGRAM_ID as Am,getTransferFeeConfig as Pm,unpackMint as km}from"@solana/spl-token";var Ts=ye("Raydium_accountInfo_util");async function Jt(a,e,t){let{batchRequest:n,commitment:o="confirmed",chunkCount:s=100}=v({batchRequest:!1},t),i=hs(e,s),r=new Array(i.length).fill([]);if(n){let c=i.map(m=>{let p=a._buildArgs([m.map(d=>d.toBase58())],o,"base64");return{methodName:"getMultipleAccounts",args:p}}),u=hs(c,10);r=(await(await Promise.all(u.map(async m=>await a._rpcBatchRequest(m)))).flat()).map(m=>(m.error&&Ts.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${m.error.message}`),m.result.value.map(p=>{if(p){let{data:d,executable:f,lamports:y,owner:b,rentEpoch:g}=p;return d.length!==2&&d[1]!=="base64"&&Ts.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(d[0],"base64"),executable:f,lamports:y,owner:new Fu(b),rentEpoch:g}}return null})))}else try{r=await Promise.all(i.map(c=>a.getMultipleAccountsInfo(c,o)))}catch(c){c instanceof Error&&Ts.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${c.message}`)}return r.flat()}async function Ne(a,e,t){let n=await Jt(a,e.map(o=>o.pubkey),t);return e.map((o,s)=>q(v({},o),{accountInfo:n[s]}))}var wm=(n=>(n[n.Uninitialized=0]="Uninitialized",n[n.Mint=1]="Mint",n[n.Account=2]="Account",n))(wm||{}),Ly=1;async function ho({connection:a,mints:e,config:t}){var s,i,r;if(e.length===0)return{};let n=await Ne(a,e.map(c=>({pubkey:bt(c)})),t),o={};for(let c of n){if(!c.accountInfo||c.accountInfo.data.length<gm){console.log("invalid mint account",c.pubkey.toBase58());continue}let u=km(c.pubkey,c.accountInfo,(s=c.accountInfo)==null?void 0:s.owner);o[c.pubkey.toString()]=q(v({},u),{programId:((i=c.accountInfo)==null?void 0:i.owner)||Am,feeConfig:(r=Pm(u))!=null?r:void 0})}return o[Fu.default.toBase58()]=o[Z.toBase58()],o}import Qe from"bn.js";import Em from"decimal.js";import Km from"big.js";import On from"bn.js";import Tm from"toformat";var hm=Tm,Ho=hm;import lr from"big.js";import Im from"bn.js";import Bm from"decimal.js-light";import Zo from"bn.js";var Is=(n=>(n[n.ROUND_DOWN=0]="ROUND_DOWN",n[n.ROUND_HALF_UP=1]="ROUND_HALF_UP",n[n.ROUND_UP=2]="ROUND_UP",n))(Is||{}),Vu=9007199254740991;function J(a){let e=ye("Raydium_parseBigNumberish");if(a instanceof Zo)return a;if(typeof a=="string"){if(a.match(/^-?[0-9]+$/))return new Zo(a);e.logWithError(`invalid BigNumberish string: ${a}`)}return typeof a=="number"?(a%1&&e.logWithError(`BigNumberish number underflow: ${a}`),(a>=Vu||a<=-Vu)&&e.logWithError(`BigNumberish number overflow: ${a}`),new Zo(String(a))):typeof a=="bigint"?new Zo(a.toString()):(e.error(`invalid BigNumberish value: ${a}`),new Zo(0))}var cr=ye("module/fraction"),Bs=Ho(lr),$o=Ho(Bm),xm={[0]:$o.ROUND_DOWN,[1]:$o.ROUND_HALF_UP,[2]:$o.ROUND_UP},Sm={[0]:lr.roundDown,[1]:lr.roundHalfUp,[2]:lr.roundUp},me=class{constructor(e,t=new Im(1)){this.numerator=J(e),this.denominator=J(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new me(this.denominator,this.numerator)}add(e){let t=e instanceof me?e:new me(J(e));return this.denominator.eq(t.denominator)?new me(this.numerator.add(t.numerator),this.denominator):new me(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof me?e:new me(J(e));return this.denominator.eq(t.denominator)?new me(this.numerator.sub(t.numerator),this.denominator):new me(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof me?e:new me(J(e));return new me(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof me?e:new me(J(e));return new me(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||cr.logWithError(`${e} is not an integer.`),e<=0&&cr.logWithError(`${e} is not positive.`),$o.set({precision:e+1,rounding:xm[n]});let o=new $o(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return o.toFormat(o.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||cr.logWithError(`${e} is not an integer.`),e<0&&cr.logWithError(`${e} is negative.`),Bs.DP=e,Bs.RM=Sm[n]||1,new Bs(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var Cm=ye("Raydium_amount"),mr=Ho(Km);function _u(a,e){let t="0",n="0";if(a.includes(".")){let o=a.split(".");o.length===2?([t,n]=o,n=n.padEnd(e,"0")):Cm.logWithError(`invalid number string, num: ${a}`)}else t=a;return[t,n.slice(0,e)||n]}var he=class extends me{constructor(t,n,o=!0,s){let i=new On(0),r=Zn.pow(new On(t.decimals));if(o)i=J(n);else{let c=new On(0),u=new On(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,m]=_u(n.toString(),t.decimals);c=J(l),u=J(m)}c=c.mul(r),i=c.add(u)}super(i,r);this.logger=ye(s||"TokenAmount"),this.token=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.token.equals(t.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(t.raw)}lt(t){return this.token.equals(t.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(t.raw)}add(t){return this.token.equals(t.token)||this.logger.logWithError("add token not equals"),new he(this.token,this.raw.add(t.raw))}subtract(t){return this.token.equals(t.token)||this.logger.logWithError("sub token not equals"),new he(this.token,this.raw.sub(t.raw))}toSignificant(t=this.token.decimals,n,o=0){return super.toSignificant(t,n,o)}toFixed(t=this.token.decimals,n,o=0){return t>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,o)}toExact(t={groupSeparator:""}){return mr.DP=this.token.decimals,new mr(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}},Hn=class extends me{constructor(t,n,o=!0,s){let i=new On(0),r=Zn.pow(new On(t.decimals));if(o)i=J(n);else{let c=new On(0),u=new On(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,m]=_u(n.toString(),t.decimals);c=J(l),u=J(m)}c=c.mul(r),i=c.add(u)}super(i,r);this.logger=ye(s||"TokenAmount"),this.currency=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.currency.equals(t.currency)||this.logger.logWithError("gt currency not equals"),this.raw.gt(t.raw)}lt(t){return this.currency.equals(t.currency)||this.logger.logWithError("lt currency not equals"),this.raw.lt(t.raw)}add(t){return this.currency.equals(t.currency)||this.logger.logWithError("add currency not equals"),new Hn(this.currency,this.raw.add(t.raw))}sub(t){return this.currency.equals(t.currency)||this.logger.logWithError("sub currency not equals"),new Hn(this.currency,this.raw.sub(t.raw))}toSignificant(t=this.currency.decimals,n,o=0){return super.toSignificant(t,n,o)}toFixed(t=this.currency.decimals,n,o=0){return t>this.currency.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,o)}toExact(t={groupSeparator:""}){return mr.DP=this.currency.decimals,new mr(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}};import{PublicKey as Rm}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Eu}from"@solana/spl-token";var ln={chainId:101,address:Rm.default.toBase58(),programId:Eu.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},ut={chainId:101,address:"So11111111111111111111111111111111111111112",programId:Eu.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};import{PublicKey as Rs}from"@solana/web3.js";import{PublicKey as We,SystemProgram as Du,SYSVAR_RENT_PUBKEY as Lm}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Om}from"@solana/spl-token";function P({pubkey:a,isSigner:e=!1,isWritable:t=!0}){return{pubkey:a,isWritable:t,isSigner:e}}var xs=[P({pubkey:Om,isWritable:!1}),P({pubkey:Du.programId,isWritable:!1}),P({pubkey:Lm,isWritable:!1})];function Ss({publicKey:a,transformSol:e}){let t=Ks(a.toString());if(t instanceof We)return e&&t.equals(ct)?Z:t;if(e&&t.toString()===ct.toBase58())return Z;if(typeof t=="string"){if(t===We.default.toBase58())return We.default;try{return new We(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function Ks(a){try{return new We(a)}catch{return a}}var dr=new We("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),mn=new We("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),nt=new We("SysvarRent111111111111111111111111111111111"),Cs=new We("SysvarC1ock11111111111111111111111111111111"),en=new We("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),pr=new We("Sysvar1nstructions1111111111111111111111111"),fr=Du.programId,cb=new We("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),lb=new We("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),mb=new We("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),db=new We("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),pb=new We("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),fb=new We("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),yb=new We("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),bb=new We("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),gb=new We("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),Ab=new We("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),Pb=new We("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),Z=new We("So11111111111111111111111111111111111111112"),ct=We.default;function bt(a){return Ss({publicKey:a,transformSol:!0})}var Ls=class{constructor({mint:e,decimals:t,symbol:n,name:o,skipMint:s=!1,isToken2022:i=!1}){if(e===ct.toBase58()||e instanceof Rs&&ct.equals(e)){this.decimals=ut.decimals,this.symbol=ut.symbol,this.name=ut.name,this.mint=new Rs(ut.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=o||e.toString().substring(0,6),this.mint=s?Rs.default:Ss({publicKey:e}),this.isToken2022=i}equals(e){return this===e?!0:this.mint.equals(e.mint)}},Se=Ls;Se.WSOL=new Ls(q(v({},ut),{mint:ut.address}));var Os=class{constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},Jo=Os;Jo.SOL=new Os(ln);function Kb(a,e){return a instanceof Se&&e instanceof Se?a.equals(e):a instanceof Se||e instanceof Se?!1:a===e}import Nm from"bn.js";var Wu=new me(new Nm(100)),ze=class extends me{toSignificant(e=5,t,n){return this.mul(Wu).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(Wu).toFixed(e,t,n)}};var Mm=ye("Raydium_price"),lt=class extends me{constructor(t){let{baseToken:n,quoteToken:o,numerator:s,denominator:i}=t;super(s,i);this.baseToken=n,this.quoteToken=o,this.scalar=new me(Ns(n.decimals),Ns(o.decimals))}get raw(){return new me(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new lt({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&Mm.logWithError("mul token not equals");let n=super.mul(t);return new lt({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(t=this.quoteToken.decimals,n,o){return this.adjusted.toSignificant(t,n,o)}toFixed(t=this.quoteToken.decimals,n,o){return this.adjusted.toFixed(t,n,o)}};function Je(a){if(a instanceof ze)return new me(a.numerator,a.denominator);if(a instanceof lt)return a.adjusted;if(a instanceof he)try{return Je(a.toExact())}catch{return new me(et)}if(a instanceof me)return a;let e=String(a),t=$n(e);return new me(t.numerator,t.denominator)}function jb(a){var n;if(a instanceof ze)return{fr:new me(a.numerator,a.denominator)};if(a instanceof lt)return{fr:a.adjusted};if(a instanceof he)return{fr:Je(a.toExact()),decimals:a.token.decimals};if(a instanceof me)return{fr:a};let e=String(a),t=$n(e);return{fr:new me(t.numerator,t.denominator),decimals:(n=t.dec)==null?void 0:n.length}}function Hb(a,e){if(a==null||e==null)return!1;let t=Je(a),n=Je(e);return t.sub(n).numerator,t.sub(n).numerator.lt(et)}function vm(a,e){if(a==null||e==null)return!1;let t=Je(a),n=Je(e);return t.sub(n).numerator.gt(et)}function Zb(a,e){if(a==null||e==null)return!1;let t=Je(a),n=Je(e);return t.sub(n).numerator.lte(et)}function $b(a,e){if(a==null||e==null)return!1;let t=Je(a),n=Je(e);return t.sub(n).numerator.gte(et)}function Fm(a,e){if(a==null||e==null)return!1;let t=Je(a),n=Je(e);return t.sub(n).numerator.eq(et)}function Jb(a,e){if(a==null||e==null)return;let t=Je(a),n=Je(e);try{return t.div(n)}catch{return t}}function eg(a,e){if(a==null||e==null)return;let t=Je(a),n=Je(e);return t.sub(n)}function tg(a){return a==null?!1:!Fm(a,0)}function ng(a,e){return vm(e,a)?e:a}function Ms(a,e){if(a==null||e==null)return;let t=Je(a),n=Je(e);return t.mul(n)}function og(a,e){if(a==null||e==null)return;let t=Je(a),n=Je(e);return t.add(n)}import{PublicKey as Vm}from"@solana/web3.js";import _m from"bn.js";async function qu(a){new Promise(e=>setTimeout(e,a))}function cg(){return new Date().getTime()}function vs(a){return typeof a=="object"&&a!==null&&![Se,he,Vm,me,_m,lt,ze].some(e=>typeof e=="object"&&a instanceof e)}function Fe(a){return typeof a=="string"?Ks(a):Array.isArray(a)?a.map(e=>Fe(e)):vs(a)?Object.fromEntries(Object.entries(a).map(([e,t])=>[e,Fe(t)])):a}var et=new Qe(0),Xu=new Qe(1),Tg=new Qe(2),hg=new Qe(3),Ig=new Qe(5),Zn=new Qe(10),Bg=new Qe(100),xg=new Qe(1e3),Sg=new Qe(1e4);function Ns(a){return Zn.pow(J(a))}function $n(a){var r;if(a===void 0)return{denominator:"1",numerator:"0"};if(a instanceof Qe)return{numerator:a.toString(),denominator:"1"};if(a instanceof me)return{denominator:a.denominator.toString(),numerator:a.numerator.toString()};let e=String(a),[,t="",n="",o=""]=(r=e.replace(",","").match(/(-?)(\d*)\.?(\d*)/))!=null?r:[],s="1"+"0".repeat(o.length),i=t+(n==="0"?"":n)+o||"0";return{denominator:s,numerator:i,sign:t,int:n,dec:o}}function yr(a,e){let t=a.divmod(e);return t.mod.isZero()?t.div:t.div.isNeg()?t.div.isubn(1):t.div.iaddn(1)}function Dm(a){var n;let[,e="",t=""]=(n=a.toFixed(2).match(/(-?)(\d*)\.?(\d*)/))!=null?n:[];return`${e}${t}`}function Wm(a,e=0){return a instanceof Qe?a:new Qe(Dm(zu(a).mul(Zn.pow(new Qe(String(e))))))}function zu(a){if(a instanceof ze)return new me(a.numerator,a.denominator);if(a instanceof lt)return a.adjusted;if(a instanceof he)try{return zu(a.toExact())}catch{return new me(et)}if(a instanceof me)return a;let e=String(a),t=$n(e);return new me(t.numerator,t.denominator)}function br(a,e,t){return a.mul(e).add(t).sub(new Qe(1)).div(t)}function Fs(a,e,t){return a.mul(e).div(t)}function Kg(a,e){let{numerator:t,denominator:n}=$n(a);return new ze(new Qe(t),new Qe(n).mul(e!=null&&e.alreadyDecimaled?new Qe(100):new Qe(1)))}function Cg(a){let{token:e,numberPrice:t,decimalDone:n}=a,o=new Se({mint:"",decimals:6,symbol:"usd",name:"usd",skipMint:!0}),{numerator:s,denominator:i}=$n(t),r=n?new Qe(s).mul(Zn.pow(new Qe(e.decimals))):s,c=new Qe(i).mul(Zn.pow(new Qe(o.decimals)));return new lt({baseToken:o,denominator:c.toString(),quoteToken:new Se(q(v({},e),{skipMint:!0,mint:""})),numerator:r.toString()})}function Uu(a){let e=new Jo({decimals:6,symbol:"usd",name:"usd"}),t=Wm(Ms(a,10**e.decimals));return new Hn(e,t)}function Rg(a,e){return Uu(!e||!a?0:Ms(a,e))}function qm(a){if(a==null)return;let{numerator:e,denominator:t}=$n(a.toString());return new me(e,t)}function Um(a){return a instanceof Em}function Gu(a){return Um(a)?qm(a):Array.isArray(a)?a.map(e=>Gu(e)):vs(a)?Object.fromEntries(Object.entries(a).map(([e,t])=>[e,Gu(t)])):a}var Qu=a=>typeof a=="number",Yu=a=>a?new Date(a):new Date,Gm=a=>Yu(a).getTime();function ju(a,e,t){let n=Qu(e)?e*((t==null?void 0:t.unit)==="s"?1e3:1):e;return new Date(a).getTime()<=n}function Hu(a,e,t){let n=Qu(e)?e*((t==null?void 0:t.unit)==="s"?1e3:1):e;return new Date(a).getTime()>n}function Og(a,e){let n=Gm(a)+(e.days?e.days*24*60*60*1e3:0)+(e.hours?e.hours*60*60*1e3:0)+(e.minutes?e.minutes*60*1e3:0)+(e.seconds?e.seconds*1e3:0)+(e.milliseconds?e.milliseconds:0);return Yu(n)}function hs(a,e=1,t=[]){let n=[...a];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}function Mg(a,...e){return a.filter(t=>e.every(n=>n.includes(t)))}function vg(a,...e){return a.filter(t=>e.every(n=>!n.includes(t)))}function Fg(a){return[...new Set(a)]}var Nt=class{constructor(e){this._owner=e}get publicKey(){return Nt.isKeyPair(this._owner)?this._owner.publicKey:this._owner}get signer(){return Nt.isKeyPair(this._owner)?this._owner:void 0}get isKeyPair(){return Nt.isKeyPair(this._owner)}get isPublicKey(){return Nt.isPublicKey(this._owner)}static isKeyPair(e){return e.secretKey!==void 0}static isPublicKey(e){return!Nt.isKeyPair(e)}};import{PublicKey as jm}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Hm}from"@solana/spl-token";import{ComputeBudgetProgram as Zu,Keypair as $u,PublicKey as Ju,Transaction as Ar,TransactionMessage as Xm,VersionedTransaction as Vs}from"@solana/web3.js";var bn=(t=>(t[t.V0=0]="V0",t[t.LEGACY=1]="LEGACY",t))(bn||{}),U={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",ClmmLockPosition:"ClmmLockPosition",ClmmHarvestLockPosition:"ClmmHarvestLockPosition",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV4Withdraw:"FarmV4Withdraw",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut",CpmmLockLp:"CpmmLockLp",CpmmCollectLockFee:"CpmmCollectLockFee",TransferTip:"TransferTip"};import{TOKEN_PROGRAM_ID as zm}from"@solana/spl-token";var gn=ye("Raydium_txUtil"),ec=1644;function ei(a){let e=[],t=[];return a.microLamports&&(e.push(Zu.setComputeUnitPrice({microLamports:a.microLamports})),t.push(U.SetComputeUnitPrice)),a.units&&(e.push(Zu.setComputeUnitLimit({units:a.units})),t.push(U.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function Jn(a,e){var n,o;let t=e!=null?e:"confirmed";return(o=await((n=a.getLatestBlockhash)==null?void 0:n.call(a,{commitment:t})))==null?void 0:o.blockhash}async function ti(a,e){return a.getSignatureStatuses([e]),new Promise((t,n)=>{let o=setTimeout(n,6e4);a.onSignature(e,s=>{if(clearTimeout(o),!s.err){t("");return}n(Object.assign(s.err,{txId:e}))},"confirmed")})}function Pr(a,e){a.length<1&&gn.logWithError(`no instructions provided: ${a.toString()}`),e.length<1&&gn.logWithError(`no signers provided:, ${e.toString()}`);let t=new Ar;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...a);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<ec}catch{return!1}}async function tc(a,e,t,n=!0){let o=new Ju("RaydiumSimuLateTransaction11111111111111111"),s=[],i=new Ar;i.feePayer=o;for(let u of e)Pr([...i.instructions,u],[o])||(s.push(i),i=new Ar,i.feePayer=o),i.add(u);i.instructions.length>0&&s.push(i);let r=[];try{if(r=await Qm(a,s,n),r.find(u=>u.err!==null))throw Error("rpc simulateTransaction error")}catch(u){u instanceof Error&&gn.logWithError("failed to simulate for instructions","RPC_ERROR",{message:u.message})}let c=[];for(let u of r)if(gn.debug("simulate result:",u),u.logs){let l=u.logs.filter(m=>m&&m.includes(t));gn.debug("filteredLog:",c),l.length||gn.logWithError("simulate log not match keyword","keyword",t),c.push(...l)}return c}function nc(a,e){let t=a.match(/{["\w:,]+}/g);return!t||t.length!==1?gn.logWithError(`simulate log fail to match json, keyword: ${e}`):t[0]}function An(a,e){let n=new RegExp(`"${e}":(\\d+)`,"g").exec(a);return!n||n.length!==2?gn.logWithError(`simulate log fail to match key", key: ${e}`):n[1]}function ne(a,e){let[t,n]=Ju.findProgramAddressSync(a,e);return{publicKey:t,nonce:n}}async function Qm(a,e,t){let n=[];if(t){let o=await a.getLatestBlockhash(),s=[];for(let u of e){u.recentBlockhash=o.blockhash,u.lastValidBlockHeight=o.lastValidBlockHeight;let m=u._compile().serialize(),d=u._serialize(m).toString("base64");s.push(d)}let i=s.map(u=>{let l=a._buildArgs([u],void 0,"base64");return{methodName:"simulateTransaction",args:l}}),r=[],c=20;for(let u=0;u<Math.ceil(i.length/c);u++)r.push(i.slice(u*c,(u+1)*c));n=await(await Promise.all(r.map(async u=>(await a._rpcBatchRequest(u)).map(l=>l.result.value)))).flat()}else try{n=await Promise.all(e.map(async o=>await(await a.simulateTransaction(o)).value))}catch(o){o instanceof Error&&gn.logWithError("failed to get info for multiple accounts","RPC_ERROR",{message:o.message})}return n}function ni({instructions:a,payer:e,signers:t}){return Pr(a,[e,...t])}function Pn({instructions:a,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=$u.generate().publicKey.toString()}){let s=new Xm({payerKey:e,recentBlockhash:n,instructions:a}).compileToV0Message(Object.values(t!=null?t:{}));try{return Buffer.from(new Vs(s).serialize()).toString("base64").length<ec}catch{return!1}}var gr={time:0,data:void 0};async function jg(a){if(!gr.data||(Date.now()-gr.time)/1e3>30){let e=await a.getEpochInfo();return gr={time:Date.now(),data:e},e}else return gr.data}var oc=a=>Buffer.isBuffer(a)?a:a instanceof Uint8Array?Buffer.from(a.buffer,a.byteOffset,a.byteLength):Buffer.from(a),Ym=a=>{let e=a.serialize({requireAllSignatures:!1,verifySignatures:!1});a instanceof Vs&&(e=oc(e));try{return e instanceof Buffer?e.toString("base64"):Buffer.from(e).toString("base64")}catch{return e.toString("base64")}};function Nn(a){let e=[];return a.forEach(t=>{t instanceof Ar&&(t.recentBlockhash||(t.recentBlockhash=zm.toBase58()),t.feePayer||(t.feePayer=$u.generate().publicKey)),e.push(Ym(t))}),console.log("simulate tx string:",e),e}function Hg(a){let e=a.serialize({requireAllSignatures:!1,verifySignatures:!1});return a instanceof Vs&&(e=oc(e)),e.toString("base64")}function H(a,e,t){return ne([a.toBuffer(),(t!=null?t:Hm).toBuffer(),e.toBuffer()],new jm("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import{PublicKey as oe}from"@solana/web3.js";var _s=new oe("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),Es=new oe("CBuCnLe26faBpcBP2fktp4rp8abpcAnTWft6ZrP5Q4T"),Ds=new oe("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),Io=new oe("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),Zm=new oe("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),Ws=new oe("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),kr=new oe("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),oi=new oe("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),$m=new oe("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),wr=new oe("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Mn=new oe("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),Bo=new oe("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),ii=new oe("kN1kEznaF5Xbd8LYuqtEFcxzWSBk5Fv6ygX6SqEGJVy"),vn=new oe("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Jm=new oe("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),qs=new oe("7YttLkHDoNj9wyDur5pM1ejNaAvT9X4eqaYcHQqtj2G5"),ed=new oe("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),td=new oe("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),nd=new oe("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),od=new oe("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),ri=new oe("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),Us=new oe("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),id=new oe("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),si=new oe("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),ai=new oe("3f7GcQFG397GAaEnv51zR6tsTVihYRydnydDD1cXekxH"),mt=new oe("LanMV9sAd7wArD4vJFi2qDdfnVhFxYSUg6eADduJ3uj"),rd=new oe("WLHv2UAZm6z4KyaaELi5pjdbJh6RESMva1Rnn8pJVVh"),oA=new oe("DRay6fNdQ5J82H7xV6uq2aV3mNrUZ1J4PgSKsWgptcm6"),iA=new oe("5xqNaZXX5eUi4p5HU4oz9i5QnwRNT2y6oN7yyn4qENeq"),sd=new oe("4Bu96XjU84XjPDSpveTVf6LYGCkfW5FK7SNkREWcEfV4"),ad=new oe("6s1xP3hpbAfFoNtUNF8mfHsjr2Bd97JxFJRWLbL6aHuX"),ui={IDO_PROGRAM_ID_V1:ed,IDO_PROGRAM_ID_V2:td,IDO_PROGRAM_ID_V3:nd,IDO_PROGRAM_ID_V4:od},wt={AMM_V4:oi,AMM_STABLE:$m,CLMM_PROGRAM_ID:Mn,CLMM_LOCK_PROGRAM_ID:Bo,CLMM_LOCK_AUTH_ID:ii,FARM_PROGRAM_ID_V3:_s,FARM_PROGRAM_ID_V4:Es,FARM_PROGRAM_ID_V5:Ds,FARM_PROGRAM_ID_V6:Io,OPEN_BOOK_PROGRAM:Ws,SERUM_PROGRAM_ID_V3:kr,UTIL1216:Zm,Router:Jm,CREATE_CPMM_POOL_PROGRAM:ri,CREATE_CPMM_POOL_AUTH:Us,CREATE_CPMM_POOL_FEE_ACC:id,LOCK_CPMM_PROGRAM:si,LOCK_CPMM_AUTH:ai,LAUNCHPAD_PROGRAM:mt,LAUNCHPAD_AUTH:rd,LAUNCHPAD_PLATFORM:sd,LAUNCHPAD_CONFIG:ad,FEE_DESTINATION_ID:qs,MODEL_DATA_PUBKEY:vn},kn={OPEN_BOOK_PROGRAM:new oe("EoTcMgcDRTJVZDMZWBoU6rhYHZfkNTVEAfz3uUJRcYGj"),SERUM_PROGRAM_ID_V3:new oe("Ray1111111111111111111111111111111111111111"),AMM_V4:new oe("DRaya7Kj3aMWQSy19kSjvmuwq9docCHofyP9kanQGaav"),AMM_STABLE:new oe("DRayDdXc1NZQ9C3hRWmoSf8zK4iapgMnjdNZWrfwsP8m"),CLMM_PROGRAM_ID:new oe("DRayAUgENGQBKVaX8owNhgzkEDyoHTGVEGHVJT1E9pfH"),CLMM_LOCK_PROGRAM_ID:new oe("DRay25Usp3YJAi7beckgpGUC7mGJ2cR1AVPxhYfwVCUX"),CLMM_LOCK_AUTH_ID:new oe("6Aoh8h2Lw2m5UGxYR8AdAL87jTWYeKoxM52mJRzfYwN"),CREATE_CPMM_POOL_PROGRAM:new oe("DRaycpLY18LhpbydsBWbVJtxpNv9oXPgjRSfpF2bWpYb"),CREATE_CPMM_POOL_AUTH:new oe("CXniRufdq5xL8t8jZAPxsPZDpuudwuJSPWnbcD5Y5Nxq"),CREATE_CPMM_POOL_FEE_ACC:new oe("3oE58BKVt8KuYkGxx8zBojugnymWmBiyafWgMrnb6eYy"),LOCK_CPMM_PROGRAM:new oe("DRay25Usp3YJAi7beckgpGUC7mGJ2cR1AVPxhYfwVCUX"),LOCK_CPMM_AUTH:new oe("7qWVV8UY2bRJfDLP4s37YzBPKUkVB46DStYJBpYbQzu3"),UTIL1216:oe.default,Router:new oe("DRaybByLpbUL57LJARs3j8BitTxVfzBg351EaMr5UTCd"),FARM_PROGRAM_ID_V3:new oe("DRayWyrLmEW5KEeqs8kdTMMaBabapqagaBC7KWpGtJeZ"),FARM_PROGRAM_ID_V4:new oe("Ray1111111111111111111111111111111111111111"),FARM_PROGRAM_ID_V5:new oe("DRayiCGSZgku1GTK6rXD6mVDdingXy6APAH1R6R5L2LC"),FARM_PROGRAM_ID_V6:new oe("DRayzbYakXs45ELHkzH6vC3fuhQqTAnv5A68gdFuvZyZ"),LAUNCHPAD_PROGRAM:new oe("DRay6fNdQ5J82H7xV6uq2aV3mNrUZ1J4PgSKsWgptcm6"),LAUNCHPAD_AUTH:new oe("5xqNaZXX5eUi4p5HU4oz9i5QnwRNT2y6oN7yyn4qENeq"),LAUNCHPAD_PLATFORM:new oe("2Jx4KTDrVSdWNazuGpcA8n3ZLTRGGBDxAWhuKe2Xcj2a"),LAUNCHPAD_CONFIG:new oe("7ZR4zD7PYfY2XxoG1Gxcy2EgEeGYrpxrwzPuwdUBssEt"),FEE_DESTINATION_ID:new oe("9y8ENuuZ3b19quffx9hQvRVygG5ky6snHfRvGpuSfeJy"),MODEL_DATA_PUBKEY:new oe("Ray1111111111111111111111111111111111111111")};import we from"bn.js";var Tt=1e4;function aA(a,e,t,n){if(e===void 0)return{amount:a,fee:void 0,expirationTime:void 0};let o=t.epoch<e.newerTransferFee.epoch?e.olderTransferFee:e.newerTransferFee,s=new we(o.maximumFee.toString()),i=t.epoch<e.newerTransferFee.epoch?(Number(e.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(o.transferFeeBasisPoints===Tt){let r=new we(o.maximumFee.toString());return{amount:a.add(r),fee:r,expirationTime:i}}else{let r=St(a.mul(new we(Tt)),new we(Tt-o.transferFeeBasisPoints)),c=new we(o.maximumFee.toString()),u=r.sub(a).gt(c)?a.add(c):r,l=St(u.mul(new we(o.transferFeeBasisPoints)),new we(Tt)),m=l.gt(s)?s:l;return{amount:u,fee:m,expirationTime:i}}else{let r=St(a.mul(new we(o.transferFeeBasisPoints)),new we(Tt)),c=r.gt(s)?s:r;return{amount:a,fee:c,expirationTime:i}}}function Ie(a,e,t,n){if(e===void 0)return{amount:a,fee:void 0,expirationTime:void 0};let o=q(v({},e),{olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}}),s=t.epoch<o.newerTransferFee.epoch?o.olderTransferFee:o.newerTransferFee,i=new we(s.maximumFee.toString()),r=t.epoch<o.newerTransferFee.epoch?(Number(o.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(s.transferFeeBasisPoints===Tt){let c=new we(s.maximumFee.toString());return{amount:a.add(c),fee:c,expirationTime:r}}else{let c=St(a.mul(new we(Tt)),new we(Tt-s.transferFeeBasisPoints)),u=new we(s.maximumFee.toString()),l=c.sub(a).gt(u)?a.add(u):c,m=St(l.mul(new we(s.transferFeeBasisPoints)),new we(Tt)),p=m.gt(i)?i:m;return{amount:l,fee:p,expirationTime:r}}else{let c=St(a.mul(new we(s.transferFeeBasisPoints)),new we(Tt)),u=c.gt(i)?i:c;return{amount:a,fee:u,expirationTime:r}}}function tn(a,e){return a===void 0?e:e===void 0?a:Math.min(a,e)}function St(a,e){let{div:t,mod:n}=a.divmod(e);return n.gt(new we(0))?t.add(new we(1)):t}function eo(a,e){if(a.isZero())return new we(0);let t=a.div(e);return t.isZero()?new we(1):a.mod(e).gt(new we(0))?t.add(new we(1)):t}function Gs(a,e,t){if(e===void 0)return{amount:a,fee:void 0,expirationTime:void 0};let n=Math.floor(t/432e3),o=n<e.newerTransferFee.epoch?e.olderTransferFee:e.newerTransferFee,s=new we(o.maximumFee.toString()),i=n<e.newerTransferFee.epoch?(Number(e.newerTransferFee.epoch)*432e3-t)*400/1e3:void 0,r=St(a.mul(new we(o.transferFeeBasisPoints)),new we(Tt)),c=r.gt(s)?s:r;return{amount:a,fee:c,expirationTime:i}}function Xs(a,e,t){if(e===void 0)return{amount:a,fee:void 0,expirationTime:void 0};let n=Math.floor(t/432e3),o=n<e.newerTransferFee.epoch?e.olderTransferFee:e.newerTransferFee,s=new we(o.maximumFee.toString()),i=n<e.newerTransferFee.epoch?(Number(e.newerTransferFee.epoch)*432e3-t)*400/1e3:void 0;if(o.transferFeeBasisPoints===Tt){let r=new we(o.maximumFee.toString());return{amount:a.add(r),fee:r,expirationTime:i}}else{let r=St(a.mul(new we(Tt)),new we(Tt-o.transferFeeBasisPoints)),c=new we(o.maximumFee.toString()),u=r.sub(a).gt(c)?a.add(c):r,l=St(u.mul(new we(o.transferFeeBasisPoints)),new we(Tt)),m=l.gt(s)?s:l;return{amount:u,fee:m,expirationTime:i}}}import{PublicKey as zs,AddressLookupTableAccount as So}from"@solana/web3.js";async function Tr({connection:a,address:e,cluster:t="mainnet"}){let n=await Jt(a,[...new Set(e.map(s=>s.toString()))].map(s=>new zs(s))),o={};for(let s=0;s<e.length;s++){let i=n[s],r=e[s];if(!i)continue;let c=new So({key:r,state:So.deserialize(i.data)});o[r.toString()]=c,t==="devnet"?xo[r.toString()]=c:ci[r.toString()]=c}return o}var ci={AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU:new So({key:new zs("AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU"),state:So.deserialize(Buffer.from("AQAAAP//////////I1rcEwAAAAAvAQYwun9CU6c5Ikm2pAj+D9IEnCOR45nK+SFTGSdpd6J6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAbd9uHXZaGT2cvhRs7reawctIXtX1s3kTqM9YV+/wCpBt324e51j94YQl285GzN2rYa/E2DuQ0n/r35KNihi/wFSlNQ+F3IgtYUpVZyeIopbd8eq6vQpgZ4iEky9O72oAVKU1qZKSEGTSTocWDaOHx8NbXdvJK7geQfqEBBBUSNBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvBkX2T9y7AHdNGviJAqQNtlDUDCnauQRWybsLji6nPM8Qkw5asQRvCdB3MbX6IEBwytOrpM32l4jQygKG9TKgR0vZScQ2AsM/IHeQ7RajUkyhuZdc8SGiqQz/7H34torNR/Wir3sl0ruUrVxJWEZfUg+QLNAxxODdBi53/OP7Ioil1cqeBM9dtZC3FLov4yyxWRM/wcGStyJX/QfTnLBAHqkqWotPKVlShCVQqpP9W5W1rOao65IMk5QuQ2kMIOxzDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu/YsA/yfEEFGcr8Z57VKDw8uQzpiru7g4lvjnfapW62W030syevD8k07SGoxUHiuT/ai7gAHWWhDsVmg/C63ajgpkH7Sn3GdutArDTfyqOkdqv4/IPC/EFFy7mGkfDd2C57N5a/4jC+BbmJy7wQaSEZr0CQU88lPtUxIVvzGjC95b8Ooss2TqmkrayGKofkPMGQn7Ux+9lfwBSNfxwH8NgbpqC/7LNlV4I7nCvsXf3p+ohQk9NrAJb2KAFpUqEIJ9ZBV7BYDzHF/ORKYlgtvPnXjudZQ6CEo5OzUDaNIomTCCsvhD16TxJjsbgne1kGnQPCFSoaxUbq2V1bPMFQ3VYP6wDZ9bKStCFKx9A3tNbwZFC5ZGAN83MFK7XoTy+OmmcFEr6rLOjfSuTfPvHJkSVxW6Qllwkl67XcBi5v00u2gQsbu+38sp+rd5pA/LvyWj4P94ZGZwc1tE2P88xekCLcAwZGb+UhFzL/7K26csOb57yM5bvF9xJrLEObOkAAAAAn+HWRkdcPKyFFMnVwEoD7vnD0jCKFIU1sImubYCxNTSVzsKpaQX+fzNxrLAI3L14JQnJx/D6Uk2LADIHGqnGELzjEbkBDAlaM77NkXMPfqXNLSveCkWI7UEgNs31WEWB6XHSYI/v5DklHOb4QTtDOR804PVbi3fjloZeLR2F8d4FuZmMMO7ck3Fnkn2zEMG5gOmqsygb6PjTitArVl52NhcSznTxVnguaIJxiZkAnurDmn3MWR0PC2GLghp2KJqHCc6QQ85odeIjFHKOlRlJyeSXVJmL8vb1UgOzsbJPVP8p6zM4M3C1Sd7uWIHP33G42AP2Zg8ucn/n6meQjjD266JgCWdxZD6PXs9CsnIeL7SSG0/6lGb9xfP0ZcWkCXB/3hjxHYVXjra/GPOeXGk0fLLKjCbk+mgs2w6d2oCwimBipTzuoZ30GiI8ij8VRzD5CzMWtu2m21eDBIfjGAEo4pQeNNonKcqzV/cleX8ySZLOHsz8PtBCrLqF+VkLm9hOzIT+6i/nIf6keR4GWKMOD4AvqfpjHoD4DuhBpz8P28+DxkGrDXXr/nr20x291VPvcTU/b+b+o2kC9G0kcXeTlLjU6a2TQXWlZ4gBUdBl1jgT7mObSTpLblNiXZsLkbmVXZwvFKXua5cUKlWed/w30skmEUraTuQqtqr5fHZPW9n57EmeTif6LjHL2YJFZkQU+TrJmFzqzmF4/b8OwrPQAprl8mX3q4LUIdAS/a+11B6DWD1Xk2++Sn94dLC4xjkO4Wtlw8c4XuzciVbepHOmnoWzVu/0y3KCrLCSfQxQ3br8DJCoVzhgtPsS2nZZjsBGIZgnU0QpMv+2MnRsnKwdp1VsrCX84j/qvaZn4WhKunippgTbN2EUs0tPTP55Qfgj+nKmjtWW5IYs72FrEwJKYoNfsmqaF4o5pf4v9zgPwVwY/5I4XJKUL2L25m9kAQcW/K+H1RTFEUoj8Z4ajpOmAB/dG0COmCphVMW2CCMvnxhcGiSgPnpDuWu6qiJ7NG7ye5kvHgefgqPLeicspNJ5EpL3XiRNLM2tmJLI1awAwOyd6iHv0dCkMYRKaa6rcaZeYwmKCkckm0kM2JNmnmmAaBQQ7mwmIM0IMxX4f5W6j9PqZWcJxF7r17T/lQBAmcjoupRiJifbnXCNUv9GhpRF19WcBdeKbivRJVlGop6I2RS6lGImJ9udcI1S/0aGlEXX1ZwF14puK9ElWUainojZFYVHLHD6dIP2ESjqBzg3ol1/wB7+/ylGwd9LS7wSZ2A630CJSVKwH47K9P4bB8PEQP8BwjMFa7xQHOqZFP1XqaQ==","base64"))})},xo={},hr=async a=>{let e="EFhMuDw1PKEuckuFRW9PavNfTH4LKP5uKHgyXDmWpFCq";if(xo[e])return xo;let t=new zs(e),n=await a.getAccountInfo(t);return n&&(xo[e]=new So({key:t,state:So.deserialize(n.data)})),xo};import{PublicKey as to,sendAndConfirmTransaction as Qs,SystemProgram as ud,Transaction as li,TransactionMessage as wn,VersionedTransaction as Tn}from"@solana/web3.js";import cd from"axios";var mi=2e3,di=class{constructor(e){this.instructions=[];this.endInstructions=[];this.lookupTableAddress=[];this.signers=[];this.instructionTypes=[];this.endInstructionTypes=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner,this.cluster=e.cluster,this.blockhashCommitment=e.blockhashCommitment,this.loopMultiTxStatus=!!e.loopMultiTxStatus}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){var n;let e=(await cd.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=(n=e==null?void 0:e[15])!=null?n:{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=ei(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}addTipInstruction(e){var t;return e?(this.endInstructions.push(ud.transfer({fromPubkey:(t=e.feePayer)!=null?t:this.feePayer,toPubkey:new to(e.address),lamports:BigInt(e.amount.toString())})),this.endInstructionTypes.push(U.TransferTip),!0):!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:o=[],endInstructionTypes:s=[],lookupTableAddress:i=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...o),this.endInstructionTypes.push(...s),this.lookupTableAddress.push(...i.filter(r=>r!==to.default.toString())),this}async versionBuild({txVersion:e,extInfo:t}){return e===0?await this.buildV0(v({},t||{})):this.build(t)}build(e){var n;let t=new li;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,((n=this.owner)==null?void 0:n.signer)&&!this.signers.some(o=>o.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer),{builder:this,transaction:t,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async o=>{var l;let{recentBlockHash:s,skipPreflight:i=!0,sendAndConfirm:r,notSendToRpc:c}=o||{},u=s!=null?s:await Jn(this.connection,this.blockhashCommitment);if(t.recentBlockhash=u,this.signers.length&&t.sign(...this.signers),Nn([t]),(l=this.owner)!=null&&l.isKeyPair)return{txId:r?await Qs(this.connection,t,this.signers.find(p=>p.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:i}):await this.connection.sendRawTransaction(t.serialize(),{skipPreflight:i}),signedTx:t};if(this.signAllTransactions){let m=await this.signAllTransactions([t]);if(this.signers.length)for(let p of m)try{p.sign(...this.signers)}catch{}return{txId:c?"":await this.connection.sendRawTransaction(m[0].serialize(),{skipPreflight:i}),signedTx:m[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:e||{}}}buildMultiTx(e){var u;let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:o}=this.build(n),s=t.filter(l=>l.transaction.instructions.length>0),i=[o,...s.map(l=>l.transaction)],r=[this.signers,...s.map(l=>l.signers)],c=[...this.instructionTypes,...s.map(l=>l.instructionTypes).flat()];return(u=this.owner)!=null&&u.signer&&r.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),{builder:this,transactions:i,signers:r,instructionTypes:c,execute:async l=>{var g;let{sequentially:m,onTxUpdate:p,skipTxCount:d=0,recentBlockHash:f,skipPreflight:y=!0}=l||{},b=f!=null?f:await Jn(this.connection,this.blockhashCommitment);if((g=this.owner)!=null&&g.isKeyPair){if(m){let A=[],h=0;for(let I of i){if(++h,h<=d)continue;let T=await Qs(this.connection,I,this.signers.find(w=>w.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:y});A.push(T)}return{txIds:A,signedTxs:i}}return{txIds:await await Promise.all(i.map(async A=>(A.recentBlockhash=b,await this.connection.sendRawTransaction(A.serialize(),{skipPreflight:y})))),signedTxs:i}}if(this.signAllTransactions){let A=i.map((I,T)=>(I.recentBlockhash=b,r[T].length&&I.sign(...r[T]),I));Nn(A);let h=await this.signAllTransactions(A);if(m){let I=0,T=[],w=async()=>{if(!h[I])return;let S=await this.connection.sendRawTransaction(h[I].serialize(),{skipPreflight:y});T.push({txId:S,status:"sent",signedTx:h[I]}),p==null||p([...T]),I++;let x=!1,K=null,B=null,C=L=>{K!==null&&clearInterval(K),B!==null&&this.connection.removeSignatureListener(B);let M=T.findIndex(R=>R.txId===S);if(M>-1){if(T[M].status==="error"||T[M].status==="success")return;T[M].status=L.err?"error":"success"}p==null||p([...T]),L.err||w()};this.loopMultiTxStatus&&(K=setInterval(async()=>{var L;if(x){clearInterval(K);return}try{let M=await this.connection.getTransaction(S,{commitment:"confirmed",maxSupportedTransactionVersion:0});M&&(x=!0,clearInterval(K),C({err:((L=M.meta)==null?void 0:L.err)||null}),console.log("tx status from getTransaction:",S))}catch(M){x=!0,clearInterval(K),console.error("getTransaction timeout:",M,S)}},mi)),B=this.connection.onSignature(S,L=>{if(x){this.connection.removeSignatureListener(B);return}x=!0,C(L)},"confirmed"),this.connection.getSignatureStatus(S)};return await w(),{txIds:T.map(S=>S.txId),signedTxs:h}}else{let I=[];for(let T=0;T<h.length;T+=1){let w=await this.connection.sendRawTransaction(h[T].serialize(),{skipPreflight:y});I.push(w)}return{txIds:I,signedTxs:h}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e){var y;let f=e||{},{lookupTableCache:t={},lookupTableAddress:n=[],forerunCreate:o,recentBlockhash:s}=f,i=De(f,["lookupTableCache","lookupTableAddress","forerunCreate","recentBlockhash"]),r=v(v({},this.cluster==="devnet"?await hr(this.connection):ci),t),c=Array.from(new Set([...n,...this.lookupTableAddress])),u=[];for(let b of c)r[b]===void 0&&u.push(new to(b));let l=await Tr({connection:this.connection,address:u});for(let[b,g]of Object.entries(l))r[b]=g;let m=o?to.default.toBase58():s!=null?s:await Jn(this.connection,this.blockhashCommitment),p=new wn({payerKey:this.feePayer,recentBlockhash:m,instructions:[...this.allInstructions]}).compileToV0Message(Object.values(r));((y=this.owner)==null?void 0:y.signer)&&!this.signers.some(b=>b.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer);let d=new Tn(p);return d.sign(this.signers),{builder:this,transaction:d,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async b=>{var I;let{skipPreflight:g=!0,sendAndConfirm:A,notSendToRpc:h}=b||{};if(Nn([d]),(I=this.owner)!=null&&I.isKeyPair){let T=await this.connection.sendTransaction(d,{skipPreflight:g});return A&&await ti(this.connection,T),{txId:T,signedTx:d}}if(this.signAllTransactions){let T=await this.signAllTransactions([d]);if(this.signers.length)for(let w of T)try{w.sign(this.signers)}catch{}return{txId:h?"":await this.connection.sendTransaction(T[0],{skipPreflight:g}),signedTx:T[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:i||{}}}async buildV0MultiTx(e){var u;let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:o}=await this.buildV0(n),s=t.filter(l=>l.builder.instructions.length>0),i=[o,...s.map(l=>l.transaction)],r=[this.signers,...s.map(l=>l.signers)],c=[...this.instructionTypes,...s.map(l=>l.instructionTypes).flat()];return(u=this.owner)!=null&&u.signer&&r.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),i.forEach(async(l,m)=>{l.sign(r[m])}),{builder:this,transactions:i,signers:r,instructionTypes:c,buildProps:n,execute:async l=>{var y;let{sequentially:m,onTxUpdate:p,recentBlockHash:d,skipPreflight:f=!0}=l||{};if(d&&i.forEach(b=>b.message.recentBlockhash=d),Nn(i),(y=this.owner)!=null&&y.isKeyPair){if(m){let b=[];for(let g of i){let A=await this.connection.sendTransaction(g,{skipPreflight:f});await ti(this.connection,A),b.push(A)}return{txIds:b,signedTxs:i}}return{txIds:await Promise.all(i.map(async b=>await this.connection.sendTransaction(b,{skipPreflight:f}))),signedTxs:i}}if(this.signAllTransactions){let b=await this.signAllTransactions(i);if(m){let g=0,A=[],h=async()=>{if(!b[g])return;let I=await this.connection.sendTransaction(b[g],{skipPreflight:f});A.push({txId:I,status:"sent",signedTx:b[g]}),p==null||p([...A]),g++;let T=!1,w=null,S=null,x=K=>{w!==null&&clearInterval(w),S!==null&&this.connection.removeSignatureListener(S);let B=A.findIndex(C=>C.txId===I);if(B>-1){if(A[B].status==="error"||A[B].status==="success")return;A[B].status=K.err?"error":"success"}p==null||p([...A]),K.err||h()};this.loopMultiTxStatus&&(w=setInterval(async()=>{var K;if(T){clearInterval(w);return}try{let B=await this.connection.getTransaction(I,{commitment:"confirmed",maxSupportedTransactionVersion:0});B&&(T=!0,clearInterval(w),x({err:((K=B.meta)==null?void 0:K.err)||null}),console.log("tx status from getTransaction:",I))}catch(B){T=!0,clearInterval(w),console.error("getTransaction timeout:",B,I)}},mi)),S=this.connection.onSignature(I,K=>{if(T){this.connection.removeSignatureListener(S);return}T=!0,x(K)},"confirmed"),this.connection.getSignatureStatus(I)};return h(),{txIds:[],signedTxs:b}}else{let g=[];for(let A=0;A<b.length;A+=1){let h=await this.connection.sendTransaction(b[A],{skipPreflight:f});g.push(h)}return{txIds:g,signedTxs:b}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuild(e){var p;let m=e||{},{splitIns:t=[],computeBudgetConfig:n}=m,o=De(m,["splitIns","computeBudgetConfig"]),s=n?ei(n):{instructions:[],instructionTypes:[]},i=this.signers.reduce((d,f)=>q(v({},d),{[f.publicKey.toBase58()]:f}),{}),r=[],c=[],u=[],l=0;if(this.allInstructions.forEach(d=>{let f=[...u,d],y=n?[...s.instructions,...f]:f,g=[...new Set(f.map(A=>A.keys.filter(h=>h.isSigner).map(h=>h.pubkey.toString())).flat()).values()].map(A=>new to(A));if(d!==t[l]&&u.length<12&&(ni({instructions:y,payer:this.feePayer,signers:g})||ni({instructions:f,payer:this.feePayer,signers:g})))u.push(d);else{if(u.length===0)throw Error("item ins too big");l+=d===t[l]?1:0,ni({instructions:n?[...s.instructions,...u]:[...u],payer:this.feePayer,signers:g})?r.push(new li().add(...s.instructions,...u)):r.push(new li().add(...u)),c.push(Array.from(new Set(u.map(A=>A.keys.filter(h=>h.isSigner).map(h=>h.pubkey.toString())).flat())).map(A=>i[A]).filter(A=>A!==void 0)),u=[d]}}),u.length>0){let f=[...new Set(u.map(y=>y.keys.filter(b=>b.isSigner).map(b=>b.pubkey.toString())).flat()).values()].map(y=>i[y]).filter(y=>y!==void 0);ni({instructions:n?[...s.instructions,...u]:[...u],payer:this.feePayer,signers:f.map(y=>y.publicKey)})?r.push(new li().add(...s.instructions,...u)):r.push(new li().add(...u)),c.push(f)}return r.forEach(d=>d.feePayer=this.feePayer),(p=this.owner)!=null&&p.signer&&c.forEach(d=>{d.some(f=>f.publicKey.equals(this.owner.publicKey))||d.push(this.owner.signer)}),{builder:this,transactions:r,signers:c,instructionTypes:this.instructionTypes,execute:async d=>{var I;let{sequentially:f,onTxUpdate:y,skipTxCount:b=0,recentBlockHash:g,skipPreflight:A=!0}=d||{},h=g!=null?g:await Jn(this.connection,this.blockhashCommitment);if(r.forEach(async(T,w)=>{T.recentBlockhash=h,c[w].length&&T.sign(...c[w])}),Nn(r),(I=this.owner)!=null&&I.isKeyPair){if(f){let T=0,w=[];for(let S of r){if(++T,T<=b){w.push("tx skipped");continue}let x=await Qs(this.connection,S,this.signers.find(K=>K.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:A});w.push(x)}return{txIds:w,signedTxs:r}}return{txIds:await Promise.all(r.map(async T=>await this.connection.sendRawTransaction(T.serialize(),{skipPreflight:A}))),signedTxs:r}}if(this.signAllTransactions){let T=await this.signAllTransactions(r.slice(b,r.length)),w=[...r.slice(0,b),...T];if(f){let S=0,x=[],K=async()=>{if(!w[S])return;S<b&&(x.push({txId:"",status:"success",signedTx:w[S]}),y==null||y([...x]),S++,K());let B=await this.connection.sendRawTransaction(w[S].serialize(),{skipPreflight:A});x.push({txId:B,status:"sent",signedTx:w[S]}),y==null||y([...x]),S++;let C=!1,L=null,M=null,R=O=>{L!==null&&clearInterval(L),M!==null&&this.connection.removeSignatureListener(M);let _=x.findIndex(X=>X.txId===B);if(_>-1){if(x[_].status==="error"||x[_].status==="success")return;x[_].status=O.err?"error":"success"}y==null||y([...x]),O.err||K()};this.loopMultiTxStatus&&(L=setInterval(async()=>{var O;if(C){clearInterval(L);return}try{let _=await this.connection.getTransaction(B,{commitment:"confirmed",maxSupportedTransactionVersion:0});_&&(C=!0,clearInterval(L),R({err:((O=_.meta)==null?void 0:O.err)||null}),console.log("tx status from getTransaction:",B))}catch(_){C=!0,clearInterval(L),console.error("getTransaction timeout:",_,B)}},mi)),M=this.connection.onSignature(B,O=>{if(C){this.connection.removeSignatureListener(M);return}C=!0,R(O)},"confirmed"),this.connection.getSignatureStatus(B)};return await K(),{txIds:x.map(B=>B.txId),signedTxs:w}}else{let S=[];for(let x=0;x<w.length;x+=1){let K=await this.connection.sendRawTransaction(w[x].serialize(),{skipPreflight:A});S.push(K)}return{txIds:S,signedTxs:w}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:o||{}}}async sizeCheckBuildV0(e){var h;let A=e||{},{computeBudgetConfig:t,splitIns:n=[],lookupTableCache:o={},lookupTableAddress:s=[]}=A,i=De(A,["computeBudgetConfig","splitIns","lookupTableCache","lookupTableAddress"]),r=v(v({},this.cluster==="devnet"?await hr(this.connection):ci),o),c=Array.from(new Set([...this.lookupTableAddress,...s])),u=[];for(let I of c)r[I]===void 0&&u.push(new to(I));let l=await Tr({connection:this.connection,address:u});for(let[I,T]of Object.entries(l))r[I]=T;let m=t?ei(t):{instructions:[],instructionTypes:[]},p=await Jn(this.connection,this.blockhashCommitment),d=this.signers.reduce((I,T)=>q(v({},I),{[T.publicKey.toBase58()]:T}),{}),f=[],y=[],b=[],g=0;if(this.allInstructions.forEach(I=>{let T=[...b,I],w=t?[...m.instructions,...T]:T;if(I!==n[g]&&b.length<12&&(Pn({instructions:w,payer:this.feePayer,lookupTableAddressAccount:r})||Pn({instructions:T,payer:this.feePayer,lookupTableAddressAccount:r})))b.push(I);else{if(b.length===0)throw Error("item ins too big");g+=I===n[g]?1:0;let S={};for(let x of[...new Set(c)])r[x]!==void 0&&(S[x]=r[x]);if(t&&Pn({instructions:[...m.instructions,...b],payer:this.feePayer,lookupTableAddressAccount:r,recentBlockhash:p})){let x=new wn({payerKey:this.feePayer,recentBlockhash:p,instructions:[...m.instructions,...b]}).compileToV0Message(Object.values(r));f.push(new Tn(x))}else{let x=new wn({payerKey:this.feePayer,recentBlockhash:p,instructions:[...b]}).compileToV0Message(Object.values(r));f.push(new Tn(x))}y.push(Array.from(new Set(b.map(x=>x.keys.filter(K=>K.isSigner).map(K=>K.pubkey.toString())).flat())).map(x=>d[x]).filter(x=>x!==void 0)),b=[I]}}),b.length>0){let T=[...new Set(b.map(w=>w.keys.filter(S=>S.isSigner).map(S=>S.pubkey.toString())).flat()).values()].map(w=>d[w]).filter(w=>w!==void 0);if(t&&Pn({instructions:[...m.instructions,...b],payer:this.feePayer,lookupTableAddressAccount:r,recentBlockhash:p})){let w=new wn({payerKey:this.feePayer,recentBlockhash:p,instructions:[...m.instructions,...b]}).compileToV0Message(Object.values(r));f.push(new Tn(w))}else{let w=new wn({payerKey:this.feePayer,recentBlockhash:p,instructions:[...b]}).compileToV0Message(Object.values(r));f.push(new Tn(w))}y.push(T)}return(h=this.owner)!=null&&h.signer&&y.forEach(I=>{I.some(T=>T.publicKey.equals(this.owner.publicKey))||I.push(this.owner.signer)}),f.forEach((I,T)=>{I.sign(y[T])}),{builder:this,transactions:f,buildProps:e,signers:y,instructionTypes:this.instructionTypes,execute:async I=>{var B;let{sequentially:T,onTxUpdate:w,skipTxCount:S=0,recentBlockHash:x,skipPreflight:K=!0}=I||{};if(f.map(async(C,L)=>{y[L].length&&C.sign(y[L]),x&&(C.message.recentBlockhash=x)}),Nn(f),(B=this.owner)!=null&&B.isKeyPair){if(T){let C=0,L=[];for(let M of f){if(++C,C<=S){console.log("skip tx: ",C),L.push("tx skipped");continue}let R=await this.connection.sendTransaction(M,{skipPreflight:K});await ti(this.connection,R),L.push(R)}return{txIds:L,signedTxs:f}}return{txIds:await Promise.all(f.map(async C=>await this.connection.sendTransaction(C,{skipPreflight:K}))),signedTxs:f}}if(this.signAllTransactions){let C=await this.signAllTransactions(f.slice(S,f.length)),L=[...f.slice(0,S),...C];if(T){let M=0,R=[],O=async()=>{if(!L[M])return;if(M<S){R.push({txId:"",status:"success",signedTx:L[M]}),w==null||w([...R]),M++,O();return}let _=await this.connection.sendTransaction(L[M],{skipPreflight:K});R.push({txId:_,status:"sent",signedTx:L[M]}),w==null||w([...R]),M++;let X=!1,j=null,ae=null,le=ie=>{j!==null&&clearInterval(j),ae!==null&&this.connection.removeSignatureListener(ae);let de=R.findIndex(be=>be.txId===_);if(de>-1){if(R[de].status==="error"||R[de].status==="success")return;R[de].status=ie.err?"error":"success"}w==null||w([...R]),ie.err||O()};this.loopMultiTxStatus&&(j=setInterval(async()=>{var ie;if(X){clearInterval(j);return}try{let de=await this.connection.getTransaction(_,{commitment:"confirmed",maxSupportedTransactionVersion:0});de&&(X=!0,clearInterval(j),le({err:((ie=de.meta)==null?void 0:ie.err)||null}),console.log("tx status from getTransaction:",_))}catch(de){X=!0,clearInterval(j),console.error("getTransaction timeout:",de,_)}},mi)),ae=this.connection.onSignature(_,ie=>{if(X){this.connection.removeSignatureListener(ae);return}X=!0,le(ie)},"confirmed"),this.connection.getSignatureStatus(_)};return O(),{txIds:[],signedTxs:L}}else{let M=[];for(let R=0;R<L.length;R+=1){let O=await this.connection.sendTransaction(L[R],{skipPreflight:K});M.push(O)}return{txIds:M,signedTxs:L}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:i||{}}}async buildSniperTransaction(e){var h;let A=e||{},{computeBudgetConfig:t,splitIns:n=[],lookupTableCache:o={},lookupTableAddress:s=[]}=A,i=De(A,["computeBudgetConfig","splitIns","lookupTableCache","lookupTableAddress"]),r=v(v({},this.cluster==="devnet"?await hr(this.connection):ci),o),c=Array.from(new Set([...this.lookupTableAddress,...s])),u=[];for(let I of c)r[I]===void 0&&u.push(new to(I));let l=await Tr({connection:this.connection,address:u});for(let[I,T]of Object.entries(l))r[I]=T;let m=t?ei(t):{instructions:[],instructionTypes:[]},p=await Jn(this.connection,this.blockhashCommitment),d=this.signers.reduce((I,T)=>q(v({},I),{[T.publicKey.toBase58()]:T}),{}),f=[],y=[],b=[],g=0;if(this.allInstructions.forEach(I=>{let T=[...b,I],w=t?[...m.instructions,...T]:T;if(I!==n[g]&&b.length<12&&(Pn({instructions:w,payer:this.feePayer,lookupTableAddressAccount:r})||Pn({instructions:T,payer:this.feePayer,lookupTableAddressAccount:r})))b.push(I);else{if(b.length===0)throw Error("item ins too big");g+=I===n[g]?1:0;let S={};for(let x of[...new Set(c)])r[x]!==void 0&&(S[x]=r[x]);if(t&&Pn({instructions:[...m.instructions,...b],payer:this.feePayer,lookupTableAddressAccount:r,recentBlockhash:p})){let x=new wn({payerKey:this.feePayer,recentBlockhash:p,instructions:[...m.instructions,...b]}).compileToV0Message(Object.values(r));f.push(new Tn(x))}else{let x=new wn({payerKey:this.feePayer,recentBlockhash:p,instructions:[...b]}).compileToV0Message(Object.values(r));f.push(new Tn(x))}y.push(Array.from(new Set(b.map(x=>x.keys.filter(K=>K.isSigner).map(K=>K.pubkey.toString())).flat())).map(x=>d[x]).filter(x=>x!==void 0)),b=[I]}}),b.length>0){let T=[...new Set(b.map(w=>w.keys.filter(S=>S.isSigner).map(S=>S.pubkey.toString())).flat()).values()].map(w=>d[w]).filter(w=>w!==void 0);if(t&&Pn({instructions:[...m.instructions,...b],payer:this.feePayer,lookupTableAddressAccount:r,recentBlockhash:p})){let w=new wn({payerKey:this.feePayer,recentBlockhash:p,instructions:[...m.instructions,...b]}).compileToV0Message(Object.values(r));f.push(new Tn(w))}else{let w=new wn({payerKey:this.feePayer,recentBlockhash:p,instructions:[...b]}).compileToV0Message(Object.values(r));f.push(new Tn(w))}y.push(T)}return(h=this.owner)!=null&&h.signer&&y.forEach(I=>{I.some(T=>T.publicKey.equals(this.owner.publicKey))||I.push(this.owner.signer)}),f.forEach((I,T)=>{I.sign(y[T])}),{builder:this,transactions:f,buildProps:e,signers:y,instructionTypes:this.instructionTypes,execute:async I=>{var B;let{sequentially:T,onTxUpdate:w,skipTxCount:S=0,recentBlockHash:x,skipPreflight:K=!0}=I||{};if(f.map(async(C,L)=>{y[L].length&&C.sign(y[L]),x&&(C.message.recentBlockhash=x)}),Nn(f),(B=this.owner)!=null&&B.isKeyPair){if(T){let C=0,L=[];for(let M of f){if(++C,C<=S){console.log("skip tx: ",C),L.push("tx skipped");continue}let R=await this.connection.sendTransaction(M,{skipPreflight:K});await ti(this.connection,R),L.push(R)}return{txIds:L,signedTxs:f}}return{txIds:await Promise.all(f.map(async C=>await this.connection.sendTransaction(C,{skipPreflight:K}))),signedTxs:f}}if(this.signAllTransactions){let C=await this.signAllTransactions(f.slice(S,f.length)),L=[...f.slice(0,S),...C];if(T){let M=0,R=[],O=async()=>{if(!L[M])return;if(M<S){R.push({txId:"",status:"success",signedTx:L[M]}),w==null||w([...R]),M++,O();return}let _=await this.connection.sendTransaction(L[M],{skipPreflight:K});R.push({txId:_,status:"sent",signedTx:L[M]}),w==null||w([...R]),M++;let X=!1,j=null,ae=null,le=ie=>{j!==null&&clearInterval(j),ae!==null&&this.connection.removeSignatureListener(ae);let de=R.findIndex(be=>be.txId===_);if(de>-1){if(R[de].status==="error"||R[de].status==="success")return;R[de].status=ie.err?"error":"success"}w==null||w([...R]),ie.err||O()};this.loopMultiTxStatus&&(j=setInterval(async()=>{var ie;if(X){clearInterval(j);return}try{let de=await this.connection.getTransaction(_,{commitment:"confirmed",maxSupportedTransactionVersion:0});de&&(X=!0,clearInterval(j),le({err:((ie=de.meta)==null?void 0:ie.err)||null}),console.log("tx status from getTransaction:",_))}catch(de){X=!0,clearInterval(j),console.error("getTransaction timeout:",de,_)}},mi)),ae=this.connection.onSignature(_,ie=>{if(X){this.connection.removeSignatureListener(ae);return}X=!0,le(ie)},"confirmed"),this.connection.getSignatureStatus(_)};return O(),{txIds:[],signedTxs:L}}else{let M=[];for(let R=0;R<L.length;R+=1){let O=await this.connection.sendTransaction(L[R],{skipPreflight:K});M.push(O)}return{txIds:M,signedTxs:L}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:i||{}}}};import ld from"bn.js";var nn=new ld(1e6);var ic=(t=>(t.ALL="all",t.Strict="strict",t))(ic||{}),rc=(i=>(i.All="all",i.Standard="standard",i.Concentrated="concentrated",i.AllFarm="allFarm",i.StandardFarm="standardFarm",i.ConcentratedFarm="concentratedFarm",i))(rc||{});var dt={BASE_HOST:"https://api-v3.raydium.io",OWNER_BASE_HOST:"https://owner-v1.raydium.io",SERVICE_BASE_HOST:"https://service.raydium.io",MONITOR_BASE_HOST:"https://monitor.raydium.io",SERVICE_1_BASE_HOST:"https://service-v1.raydium.io",SEND_TRANSACTION:"/send-transaction",FARM_ARP:"/main/farm/info",FARM_ARP_LINE:"/main/farm-apr-tv",CLMM_CONFIG:"/main/clmm-config",CPMM_CONFIG:"/main/cpmm-config",VERSION:"/main/version",CHECK_AVAILABILITY:"/v3/main/AvailabilityCheckAPI",RPCS:"/main/rpcs",INFO:"/main/info",STAKE_POOLS:"/main/stake-pools",CHAIN_TIME:"/main/chain-time",TOKEN_LIST:"/mint/list",MINT_INFO_ID:"/mint/ids",JUP_TOKEN_LIST:"https://lite-api.jup.ag/tokens/v1/tagged/verified",POOL_LIST:"/pools/info/list",POOL_SEARCH_BY_ID:"/pools/info/ids",POOL_SEARCH_MINT:"/pools/info/mint",POOL_SEARCH_LP:"/pools/info/lps",POOL_KEY_BY_ID:"/pools/key/ids",POOL_LIQUIDITY_LINE:"/pools/line/liquidity",POOL_POSITION_LINE:"/pools/line/position",FARM_INFO:"/farms/info/ids",FARM_LP_INFO:"/farms/info/lp",FARM_KEYS:"/farms/key/ids",OWNER_CREATED_FARM:"/create-pool/{owner}",OWNER_IDO:"/main/ido/{owner}",OWNER_STAKE_FARMS:"/position/stake/{owner}",OWNER_LOCK_POSITION:"/position/clmm-lock/{owner}",IDO_KEYS:"/ido/key/ids",SWAP_HOST:"https://transaction-v1.raydium.io",SWAP_COMPUTE:"/compute/",SWAP_TX:"/transaction/",MINT_PRICE:"/mint/price",MIGRATE_CONFIG:"/main/migrate-lp",PRIORITY_FEE:"/main/auto-fee",CPMM_LOCK:"https://dynamic-ipfs.raydium.io/lock/cpmm/position"},QA=v({},dt);var sc="ray_tab_hash",Ys="ray_req_hash",md=()=>{if(typeof window===void 0)return"";let a=sessionStorage.getItem(sc);return a||(a=`ray-${Date.now()}`,sessionStorage.setItem(sc,a)),a},Ir=async n=>{var o=n,{logCount:a=1e3,removeLastLog:e}=o,t=De(o,["logCount","removeLastLog"]);if(typeof window===void 0)return new Promise(i=>i());let s=JSON.parse(localStorage.getItem(Ys)||"[]").slice(0,a-1);e&&s.pop(),new Blob([JSON.stringify(t.data)]).size>1024&&(t.data=JSON.stringify(t.data).substring(0,200)+"..."),s.unshift(q(v({},t),{time:Date.now(),session:md()}));try{localStorage.setItem(Ys,JSON.stringify(s))}catch{if(e){let i=!1,r=JSON.stringify(t.data).substring(0,100);for(s[0].data=r+(r.length>100?"...":"");!i;){s.pop();let c=JSON.stringify(t.data).substring(0,100);s[0].data=c+(c.length>100?"...":"");try{localStorage.setItem(Ys,JSON.stringify(s)),i=!0}catch{i=!1}}return new Promise(c=>c())}return Ir(q(v({},t),{logCount:a,removeLastLog:!0}))}};import{TOKEN_2022_PROGRAM_ID as dd,TOKEN_PROGRAM_ID as pd}from"@solana/spl-token";var Ko=ye("Raydium_Api"),js=new Map;async function gP(a,e,t=1e3){let n;for(;n==null;)try{Ko.debug(`Request ${a} through endlessRetry`),n=await e()}catch(o){Ko.error(`Request ${a} failed, retry after ${t} ms`,o),await qu(t)}return n}var Br=class{constructor({cluster:e,timeout:t,logRequests:n,logCount:o,urlConfigs:s}){this.cluster=e,this.urlConfigs=s||{},this.logCount=o||1e3,this.api=ac.create({baseURL:this.urlConfigs.BASE_HOST||dt.BASE_HOST,timeout:t}),this.api.interceptors.request.use(i=>{let{method:r,baseURL:c,url:u}=i;return Ko.debug(`${r==null?void 0:r.toUpperCase()} ${c}${u}`),i},i=>(Ko.error("Request failed"),Promise.reject(i))),this.api.interceptors.response.use(i=>{let{config:r,data:c,status:u}=i,{method:l,baseURL:m,url:p}=r;return n&&Ir({status:u,url:`${m}${p}`,params:r.params,data:c,logCount:this.logCount}),Ko.debug(`${l==null?void 0:l.toUpperCase()} ${m}${p}  ${u}`),c},i=>{let{config:r,response:c={}}=i,{status:u}=c,{method:l,baseURL:m,url:p}=r;return n&&Ir({status:u,url:`${m}${p}`,params:r.params,data:i.message,logCount:this.logCount}),Ko.error(`${l.toUpperCase()} ${m}${p} ${u||i.message}`),Promise.reject(i)})}async getClmmConfigs(){return(await this.api.get(this.urlConfigs.CLMM_CONFIG||dt.CLMM_CONFIG)).data}async getCpmmConfigs(){return(await this.api.get(this.urlConfigs.CPMM_CONFIG||dt.CPMM_CONFIG)).data}async getClmmPoolLines(e){return(await this.api.get(`${this.urlConfigs.POOL_LIQUIDITY_LINE||dt.POOL_LIQUIDITY_LINE}?pool_id=${e}`)).data}async getBlockSlotCountForSecond(e){if(!e)return 2;let n=(await ac.post(e,{id:"getRecentPerformanceSamples",jsonrpc:"2.0",method:"getRecentPerformanceSamples",params:[4]})).result.map(o=>o.numSlots);return n.reduce((o,s)=>o+s,0)/n.length/60}async getChainTimeOffset(){return(await this.api.get(this.urlConfigs.CHAIN_TIME||dt.CHAIN_TIME)).data}async getRpcs(){return this.api.get(this.urlConfigs.RPCS||dt.RPCS)}async getTokenList(){return(await this.api.get(this.urlConfigs.TOKEN_LIST||dt.TOKEN_LIST)).data}async getJupTokenList(){return(await this.api.get("",{baseURL:this.urlConfigs.JUP_TOKEN_LIST||dt.JUP_TOKEN_LIST})).map(t=>q(v({},t),{chainId:101,programId:t.tags.includes("token-2022")?dd.toBase58():pd.toBase58()}))}async getTokenInfo(e){return(await this.api.get((this.urlConfigs.MINT_INFO_ID||dt.MINT_INFO_ID)+`?mints=${e.map(n=>n.toString()).join(",")}`)).data}async getPoolList(e={}){let{type:t="all",sort:n="liquidity",order:o="desc",page:s=0,pageSize:i=100}=e;return(await this.api.get((this.urlConfigs.POOL_LIST||dt.POOL_LIST)+`?poolType=${t}&poolSortField=${n}&sortType=${o}&page=${s}&pageSize=${i}`)).data}async fetchPoolById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.POOL_SEARCH_BY_ID||dt.POOL_SEARCH_BY_ID)+`?ids=${t}`)).data}async fetchPoolKeysById(e){let{idList:t}=e,n=[],o=t.filter(i=>js.has(i)?(n.push(js.get(i)),!1):!0),s=[];return o.length&&(s=(await this.api.get((this.urlConfigs.POOL_KEY_BY_ID||dt.POOL_KEY_BY_ID)+`?ids=${o.join(",")}`)).data.filter(Boolean),s.forEach(r=>{js.set(r.id,r)})),n.concat(s)}async fetchPoolByMints(e){let{mint1:t,mint2:n,type:o="all",sort:s="default",order:i="desc",page:r=1}=e,[c,u]=[t&&bt(t).toBase58(),n&&n!=="undefined"?bt(n).toBase58():""],[l,m]=u&&c>u?[u,c]:[c,u];return(await this.api.get((this.urlConfigs.POOL_SEARCH_MINT||dt.POOL_SEARCH_MINT)+`?mint1=${l}&mint2=${m}&poolType=${o}&poolSortField=${s}&sortType=${i}&pageSize=100&page=${r}`)).data}async fetchFarmInfoById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_INFO||dt.FARM_INFO)+`?ids=${t}`)).data}async fetchFarmKeysById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_KEYS||dt.FARM_KEYS)+`?ids=${t}`)).data}async fetchAvailabilityStatus(){return(await this.api.get(this.urlConfigs.CHECK_AVAILABILITY||dt.CHECK_AVAILABILITY)).data}};import{merge as gy}from"lodash";var xr="please provide owner in load() initialization or you can set by calling raydium.setOwner(owner)",uc="please provide connection in load() initialization or set it by raydium.setConnection(connection)";import{PublicKey as Or,SystemProgram as hp}from"@solana/web3.js";import{AccountLayout as Lo,createAssociatedTokenAccountIdempotentInstruction as ca,TOKEN_PROGRAM_ID as En,TOKEN_2022_PROGRAM_ID as Ip}from"@solana/spl-token";var Hs=(...a)=>a.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),Ve=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=ye(t)}createTxBuilder(e){return this.scope.checkOwner(),new di({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,cluster:this.scope.cluster,owner:this.scope.owner,blockhashCommitment:this.scope.blockhashCommitment,loopMultiTxStatus:this.scope.loopMultiTxStatus,api:this.scope.api,signAllTransactions:this.scope.signAllTransactions})}createSniperTxBuilder(e,t){let n=new Nt(e);return new di({connection:this.scope.connection,feePayer:t,cluster:this.scope.cluster,owner:n,blockhashCommitment:this.scope.blockhashCommitment,loopMultiTxStatus:this.scope.loopMultiTxStatus,api:this.scope.api,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(Hs(e))}logInfo(...e){this.logger.info(Hs(e))}logAndCreateError(...e){let t=Hs(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as gp,SystemProgram as Ap}from"@solana/web3.js";import Pp from"bn.js";import{createCloseAccountInstruction as kp,createInitializeAccountInstruction as wp,createTransferInstruction as Tp,TOKEN_PROGRAM_ID as Ro}from"@solana/spl-token";import{Keypair as pp,PublicKey as Ic}from"@solana/web3.js";import fp from"bn.js";import{TOKEN_PROGRAM_ID as yp}from"@solana/spl-token";function fd(a){return a instanceof Uint8Array||a!=null&&typeof a=="object"&&a.constructor.name==="Uint8Array"}function Zs(a,...e){if(!fd(a))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(a.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${a.length}`)}function $s(a,e=!0){if(a.destroyed)throw new Error("Hash instance has been destroyed");if(e&&a.finished)throw new Error("Hash#digest() has already been called")}function cc(a,e){Zs(a);let t=e.outputLen;if(a.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var Kr=a=>new DataView(a.buffer,a.byteOffset,a.byteLength),on=(a,e)=>a<<32-e|a>>>e;var OP=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function yd(a){if(typeof a!="string")throw new Error(`utf8ToBytes expected string, got ${typeof a}`);return new Uint8Array(new TextEncoder().encode(a))}function Js(a){return typeof a=="string"&&(a=yd(a)),Zs(a),a}var Sr=class{clone(){return this._cloneInto()}},NP={}.toString;function lc(a){let e=n=>a().update(Js(n)).digest(),t=a();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>a(),e}function bd(a,e,t,n){if(typeof a.setBigUint64=="function")return a.setBigUint64(e,t,n);let o=BigInt(32),s=BigInt(4294967295),i=Number(t>>o&s),r=Number(t&s),c=n?4:0,u=n?0:4;a.setUint32(e+c,i,n),a.setUint32(e+u,r,n)}var mc=(a,e,t)=>a&e^~a&t,dc=(a,e,t)=>a&e^a&t^e&t,Cr=class extends Sr{constructor(e,t,n,o){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=o,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=Kr(this.buffer)}update(e){$s(this);let{view:t,buffer:n,blockLen:o}=this;e=Js(e);let s=e.length;for(let i=0;i<s;){let r=Math.min(o-this.pos,s-i);if(r===o){let c=Kr(e);for(;o<=s-i;i+=o)this.process(c,i);continue}n.set(e.subarray(i,i+r),this.pos),this.pos+=r,i+=r,this.pos===o&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){$s(this),cc(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:o,isLE:s}=this,{pos:i}=this;t[i++]=128,this.buffer.subarray(i).fill(0),this.padOffset>o-i&&(this.process(n,0),i=0);for(let m=i;m<o;m++)t[m]=0;bd(n,o-8,BigInt(this.length*8),s),this.process(n,0);let r=Kr(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let u=c/4,l=this.get();if(u>l.length)throw new Error("_sha2: outputLen bigger than state");for(let m=0;m<u;m++)r.setUint32(4*m,l[m],s)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:o,finished:s,destroyed:i,pos:r}=this;return e.length=o,e.pos=r,e.finished=s,e.destroyed=i,o%t&&e.buffer.set(n),e}};var gd=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Fn=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Vn=new Uint32Array(64),ea=class extends Cr{constructor(){super(64,32,8,!1),this.A=Fn[0]|0,this.B=Fn[1]|0,this.C=Fn[2]|0,this.D=Fn[3]|0,this.E=Fn[4]|0,this.F=Fn[5]|0,this.G=Fn[6]|0,this.H=Fn[7]|0}get(){let{A:e,B:t,C:n,D:o,E:s,F:i,G:r,H:c}=this;return[e,t,n,o,s,i,r,c]}set(e,t,n,o,s,i,r,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=o|0,this.E=s|0,this.F=i|0,this.G=r|0,this.H=c|0}process(e,t){for(let m=0;m<16;m++,t+=4)Vn[m]=e.getUint32(t,!1);for(let m=16;m<64;m++){let p=Vn[m-15],d=Vn[m-2],f=on(p,7)^on(p,18)^p>>>3,y=on(d,17)^on(d,19)^d>>>10;Vn[m]=y+Vn[m-7]+f+Vn[m-16]|0}let{A:n,B:o,C:s,D:i,E:r,F:c,G:u,H:l}=this;for(let m=0;m<64;m++){let p=on(r,6)^on(r,11)^on(r,25),d=l+p+mc(r,c,u)+gd[m]+Vn[m]|0,y=(on(n,2)^on(n,13)^on(n,22))+dc(n,o,s)|0;l=u,u=c,c=r,r=i+d|0,i=s,s=o,o=n,n=d+y|0}n=n+this.A|0,o=o+this.B|0,s=s+this.C|0,i=i+this.D|0,r=r+this.E|0,c=c+this.F|0,u=u+this.G|0,l=l+this.H|0,this.set(n,o,s,i,r,c,u,l)}roundClean(){Vn.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var pc=lc(()=>new ea);import{PublicKey as cp}from"@solana/web3.js";import kc,{isBN as wc}from"bn.js";import{bits as Ad,BitStructure as Pd,blob as kd,Blob as wd,cstr as Td,f32 as hd,f32be as Id,f64 as Bd,f64be as xd,greedy as Sd,Layout as Kd,ns64 as Cd,ns64be as Rd,nu64 as Ld,nu64be as Od,offset as Nd,s16 as Md,s16be as vd,s24 as Fd,s24be as Vd,s32 as _d,s32be as Ed,s40 as Dd,s40be as Wd,s48 as qd,s48be as Ud,s8 as Gd,seq as Xd,struct as qP,Structure as zd,u16 as Qd,u16be as Yd,u24 as jd,u24be as Hd,u32 as Zd,u32be as $d,u40 as Jd,u40be as ep,u48 as tp,u48be as np,u8 as op,UInt as ip,union as rp,Union as sp,unionLayoutDiscriminator as ap,utf8 as up}from"@solana/buffer-layout";var pi=Kd,fc=zd,yc=sp,UP=Pd,ta=ip,bc=wd,GP=Sd,Rr=op,Mt=Qd,XP=jd,fi=Zd,zP=Jd,QP=tp,gc=Ld,YP=Yd,jP=Hd,HP=$d,ZP=ep,$P=np,JP=Od,ek=Gd,tk=Md,nk=Fd,_e=_d,ok=Dd,ik=qd,rk=Cd,sk=vd,ak=Vd,uk=Ed,ck=Wd,lk=Ud,mk=Rd,dk=hd,pk=Id,fk=Bd,yk=xd;var Ac=Xd,Pc=rp,bk=ap,Be=kd,gk=Td,Ak=up,na=Ad,oa=Nd;var no=class extends pi{constructor(t,n,o){super(t,o);this.blob=Be(t),this.signed=n}decode(t,n=0){let o=new kc(this.blob.decode(t,n),10,"le");return this.signed?o.fromTwos(this.span*8).clone():o}encode(t,n,o=0){return typeof t=="number"&&(t=new kc(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),n,o)}},Lr=class extends pi{constructor(t){super(8,t);this._lower=na(fi(),!1),this._upper=na(fi(),!1)}addBoolean(t){this._lower.fields.length<32?this._lower.addBoolean(t):this._upper.addBoolean(t)}decode(t,n=0){let o=this._lower.decode(t,n),s=this._upper.decode(t,n+this._lower.span);return v(v({},o),s)}encode(t,n,o=0){return this._lower.encode(t,n,o)+this._upper.encode(t,n,o+this._lower.span)}};function W(a){return new ta(1,a)}function ft(a){return new ta(4,a)}function k(a){return new no(8,!1,a)}function ee(a){return new no(16,!1,a)}function Tc(a){return new no(1,!0,a)}function Co(a){return new no(8,!0,a)}function hc(a){return new no(16,!0,a)}var hn=class extends pi{constructor(t,n,o,s){super(t.span,s);this.layout=t,this.decoder=n,this.encoder=o}decode(t,n){return this.decoder(this.layout.decode(t,n))}encode(t,n,o){return this.layout.encode(this.encoder(t),n,o)}getSpan(t,n){return this.layout.getSpan(t,n)}};function N(a){return new hn(Be(32),e=>new cp(e),e=>e.toBuffer(),a)}var ia=class extends pi{constructor(t,n){super(-1,n);this.layout=t,this.discriminator=Rr()}encode(t,n,o=0){return t==null?this.discriminator.encode(0,n,o):(this.discriminator.encode(1,n,o),this.layout.encode(t,n,o+1)+1)}decode(t,n=0){let o=this.discriminator.decode(t,n);if(o===0)return null;if(o===1)return this.layout.decode(t,n+1);throw new Error("Invalid option "+this.property)}getSpan(t,n=0){let o=this.discriminator.decode(t,n);if(o===0)return 1;if(o===1)return this.layout.getSpan(t,n+1)+1;throw new Error("Invalid option "+this.property)}};function hk(a,e){return new ia(a,e)}function qe(a){return new hn(Rr(),lp,mp,a)}function lp(a){if(a===0)return!1;if(a===1)return!0;throw new Error("Invalid bool: "+a)}function mp(a){return a?1:0}function Ik(a,e){let t=fi("length"),n=F([t,Q(a,oa(t,-t.span),"values")]);return new hn(n,({values:o})=>o,o=>({values:o}),e)}function Bk(a,e,t){let n=F([k("tag"),e.replicate("data")]);function o({tag:s,data:i}){if(!s.eq(a))throw new Error("Invalid tag, expected: "+a.toString("hex")+", got: "+s.toString("hex"));return i}return new hn(n,o,s=>({tag:a,data:s}),t)}function dp(a){let e=fi("length"),t=F([e,Be(oa(e,-e.span),"data")]);return new hn(t,({data:n})=>n,n=>({data:n}),a)}function Kt(a){return new hn(dp(),e=>e.toString("utf-8"),e=>Buffer.from(e,"utf-8"),a)}function xk(a,e){let t=Pc(Rr(),e);return a.forEach((n,o)=>t.addVariant(o,n,n.property)),t}function Sk(a,e,t){let n=F([Q(a,e,"values")]);return new hn(n,({values:o})=>o,o=>({values:o}),t)}var ra=class extends fc{decode(e,t){return super.decode(e,t)}};function F(a,e,t){return new ra(a,e,t)}var sa=class extends yc{encodeInstruction(e){let t=Math.max(...Object.values(this.registry).map(o=>o.span)),n=Buffer.alloc(t);return n.slice(0,this.encode(e,n))}decodeInstruction(e){return this.decode(e)}};function Kk(a,e,t){return new sa(a,e,t)}var aa=class extends bc{decode(e,t){let n=super.decode(e,t);if(!n.every(o=>o===0))throw new Error("nonzero padding bytes");return n}};function Ck(a){return new aa(a)}function Q(a,e,t){let n,o=typeof e=="number"?e:wc(e)?e.toNumber():new Proxy(e,{get(s,i){if(!n){let r=Reflect.get(s,"count");n=wc(r)?r.toNumber():r,Reflect.set(s,"count",n)}return Reflect.get(s,i)},set(s,i,r){return i==="count"&&(n=r),Reflect.set(s,i,r)}});return Ac(a,o,t)}var rn=F([N("mint"),N("owner"),k("amount"),ft("delegateOption"),N("delegate"),W("state"),ft("isNativeOption"),k("isNative"),k("delegatedAmount"),ft("closeAuthorityOption"),N("closeAuthority")]);var Uk=ye("Raydium_Util");function Bc({owner:a,solAccountResp:e,tokenAccountResp:t}){let n=[],o=[];for(let{pubkey:s,account:i}of t.value){let r=rn.decode(i.data),{mint:c,amount:u}=r;n.push({publicKey:s,mint:c,amount:u,isAssociated:H(a,c,i.owner).publicKey.equals(s),isNative:!1,programId:i.owner}),o.push({pubkey:s,accountInfo:r,programId:i.owner})}return e&&n.push({mint:Ic.default,amount:new fp(String(e.lamports)),isNative:!0,programId:e.owner}),{tokenAccounts:n,tokenAccountRawInfos:o}}function Ye({fromPublicKey:a,programId:e=yp,assignSeed:t}){let n=t?btoa(t).slice(0,32):pp.generate().publicKey.toBase58().slice(0,32);return{publicKey:bp(a,n,e),seed:n}}function bp(a,e,t){let n=Buffer.concat([a.toBuffer(),Buffer.from(e),t.toBuffer()]),o=pc(n);return new Ic(o)}function ua(a){let{mint:e,tokenAccount:t,owner:n,programId:o=Ro}=a;return wp(t,e,n,o)}function In(a){let{tokenAccount:e,payer:t,multiSigners:n=[],owner:o,programId:s=Ro}=a;return kp(e,t,o,n,s)}async function _n(a){let{connection:e,amount:t,commitment:n,payer:o,owner:s,skipCloseAccount:i}=a,r=await e.getMinimumBalanceForRentExemption(rn.span,n),c=J(t).add(new Pp(r)),u=Ye({fromPublicKey:o,programId:Ro});return{addresses:{newAccount:u.publicKey},signers:[],instructions:[Ap.createAccountWithSeed({fromPubkey:o,basePubkey:o,seed:u.seed,newAccountPubkey:u.publicKey,lamports:c.toNumber(),space:rn.span,programId:Ro}),ua({mint:new gp(ut.address),tokenAccount:u.publicKey,owner:s,programId:Ro})],instructionTypes:[U.CreateAccount,U.InitAccount],endInstructionTypes:i?[]:[U.CloseAccount],endInstructions:i?[]:[In({tokenAccount:u.publicKey,payer:o,owner:s})]}}function xc({source:a,destination:e,owner:t,amount:n,multiSigners:o=[],tokenProgram:s=Ro}){return Tp(a,e,t,BigInt(String(n)),o,s)}var yi=class extends Ve{constructor(t){super(t);this._tokenAccounts=[];this._tokenAccountRawInfos=[];this._accountListener=[];this._clientOwnedToken=!1;this._notSubscribeAccountChange=!1;this._accountFetchTime=0;let{tokenAccounts:n,tokenAccountRawInfos:o,notSubscribeAccountChange:s}=t;this._tokenAccounts=n||[],this._tokenAccountRawInfos=o||[],this._notSubscribeAccountChange=s!=null?s:!0,this._clientOwnedToken=!!(n||o)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}set notSubscribeAccountChange(t){this._notSubscribeAccountChange=t}updateTokenAccount({tokenAccounts:t,tokenAccountRawInfos:n}){return t&&(this._tokenAccounts=t),n&&(this._tokenAccountRawInfos=n),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(t){return this._accountListener.push(t),this}removeAccountChangeListener(t){return this._accountListener=this._accountListener.filter(n=>n!==t),this}getAssociatedTokenAccount(t,n){return H(this.scope.ownerPubKey,t,n).publicKey}getAssociatedTokenAccountByOwner(t,n,o){return H(t,n,o).publicKey}resetTokenAccounts(){this._clientOwnedToken||(this._tokenAccounts=[],this._tokenAccountRawInfos=[])}async fetchWalletTokenAccounts(t){if(this._clientOwnedToken||!(t!=null&&t.forceUpdate)&&this._tokenAccounts.length&&Date.now()-this._accountFetchTime<(this._notSubscribeAccountChange?1e3*5:1e3*60*3))return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let o=v(v({},{}),t),[s,i,r]=await Promise.all([this.scope.connection.getAccountInfo(this.scope.ownerPubKey,o.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:En},o.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:Ip},o.commitment)]),{tokenAccounts:c,tokenAccountRawInfos:u}=Bc({owner:this.scope.ownerPubKey,solAccountResp:s,tokenAccountResp:{context:i.context,value:[...i.value,...r.value]}});return this._tokenAccounts=c,this._tokenAccountRawInfos=u,this._accountFetchTime=Date.now(),this._notSubscribeAccountChange||(this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>{this.fetchWalletTokenAccounts({forceUpdate:!0}),this._accountListener.forEach(l=>l({tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos}))},{commitment:t==null?void 0:t.commitment})),{tokenAccounts:c,tokenAccountRawInfos:u}}clearAccountChangeCkb(){this._accountChangeListenerId!==void 0&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId)}async getCreatedTokenAccount({mint:t,programId:n=En,associatedOnly:o=!0}){await this.fetchWalletTokenAccounts();let s=this._tokenAccounts.filter(({mint:r})=>r==null?void 0:r.equals(t)).sort((r,c)=>r.amount.lt(c.amount)?1:-1),i=this.getAssociatedTokenAccount(t,n);for(let r of s){let{publicKey:c}=r;if(c&&(!o||o&&i.equals(c)))return c}}async getOrCreateTokenAccount(t){var y,b,g,A;await this.fetchWalletTokenAccounts();let{mint:n,createInfo:o,associatedOnly:s,owner:i,notUseTokenAccount:r=!1,skipCloseAccount:c=!1,checkCreateATAOwner:u=!1,assignSeed:l}=t,m=new Or(t.tokenProgram||En),p=this.getAssociatedTokenAccount(n,new Or(m)),d=(r?[]:this.tokenAccountRawInfos).filter(h=>h.accountInfo.mint.equals(n)&&(!s||h.pubkey.equals(p))).sort((h,I)=>h.accountInfo.amount.lt(I.accountInfo.amount)?1:-1);if(o===void 0||d.length>0)return d.length>0?{account:d[0].pubkey}:{};let f={instructions:[],endInstructions:[],signers:[],instructionTypes:[],endInstructionTypes:[]};if(s){let h=ca(i,p,i,n,m),I=this.tokenAccountRawInfos.find(T=>T.pubkey.equals(p));if(u){let T=await this.scope.connection.getAccountInfo(p);if(T===null)(y=f.instructions)==null||y.push(h),f.instructionTypes.push(U.CreateATA);else if(!(T.owner.equals(m)&&Lo.decode(T.data).mint.equals(n)&&Lo.decode(T.data).owner.equals(i)))throw Error(`create ata check error -> mint: ${n.toString()}, ata: ${p.toString()}`)}else I===void 0&&(f.instructions.push(h),f.instructionTypes.push(U.CreateATA));if(n.equals(Z)&&o.amount){let T=await _n({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:o.payer||this.scope.ownerPubKey,amount:(b=o.amount)!=null?b:0,skipCloseAccount:c});f.instructions.push(...T.instructions||[]),f.endInstructions.push(...T.endInstructions||[]),f.instructionTypes.push(...T.instructionTypes||[]),f.endInstructionTypes.push(...T.endInstructionTypes||[]),o.amount&&(f.instructions.push(xc({source:T.addresses.newAccount,destination:p,owner:this.scope.ownerPubKey,amount:o.amount,tokenProgram:En})),f.instructionTypes.push(U.TransferAmount))}return!c&&I===void 0&&(f.endInstructions.push(In({owner:i,payer:o.payer||i,tokenAccount:p,programId:m})),f.endInstructionTypes.push(U.CloseAccount)),{account:p,instructionParams:f}}else{let h=Ye({fromPublicKey:i,programId:m,assignSeed:l}),I=await this.scope.connection.getMinimumBalanceForRentExemption(Lo.span),T=hp.createAccountWithSeed({fromPubkey:i,basePubkey:i,seed:h.seed,newAccountPubkey:h.publicKey,lamports:I+Number((A=(g=o.amount)==null?void 0:g.toString())!=null?A:0),space:Lo.span,programId:m});return f.instructions.push(T,ua({mint:n,tokenAccount:h.publicKey,owner:this.scope.ownerPubKey,programId:m})),f.instructionTypes.push(U.CreateAccount),f.instructionTypes.push(U.InitAccount),c||(f.endInstructions.push(In({owner:i,payer:o.payer||i,tokenAccount:h.publicKey,programId:m})),f.endInstructionTypes.push(U.CloseAccount)),{account:h.publicKey,instructionParams:f}}}async checkOrCreateAta({mint:t,programId:n=En,autoUnwrapWSOLToSOL:o}){var c;await this.fetchWalletTokenAccounts();let s=(c=this.scope.account.tokenAccounts.find(({mint:u})=>(u==null?void 0:u.toBase58())===t.toBase58()))==null?void 0:c.publicKey,i=this.scope.ownerPubKey,r={};if(!s){let u=this.getAssociatedTokenAccount(t,n),l=await ca(i,u,i,t,n);r.instructions=[l],r.instructionTypes=[U.CreateATA],s=u}return o&&Z.toBase58()===t.toBase58()&&(r.endInstructions=[In({owner:i,payer:i,tokenAccount:s,programId:n})],r.endInstructionTypes=[U.CloseAccount]),{pubKey:s,newInstructions:r}}async handleTokenAccount(t){let{side:n,amount:o,mint:s,programId:i=En,tokenAccount:r,payer:c=this.scope.ownerPubKey,bypassAssociatedCheck:u,skipCloseAccount:l,checkCreateATAOwner:m}=t,p=this.getAssociatedTokenAccount(s,i);if(new Or(Z).equals(s)){let d=await _n({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:c,amount:o,skipCloseAccount:l});return v({tokenAccount:d.addresses.newAccount},d)}else if(!r||n==="out"&&!p.equals(r)&&!u){let d=[],f=ca(this.scope.ownerPubKey,p,this.scope.ownerPubKey,s,i);if(m){let y=await this.scope.connection.getAccountInfo(p);if(y===null)d.push(f);else if(!(y.owner.equals(En)&&Lo.decode(y.data).mint.equals(s)&&Lo.decode(y.data).owner.equals(this.scope.ownerPubKey)))throw Error(`create ata check error -> mint: ${s.toString()}, ata: ${p.toString()}`)}else d.push(f);return{tokenAccount:p,instructions:d,instructionTypes:[U.CreateATA]}}return{tokenAccount:r}}async processTokenAccount(t){let{mint:n,programId:o=En,amount:s,useSOLBalance:i,handleTokenAccount:r,feePayer:c}=t,u,l=this.createTxBuilder(c);if(n.equals(new Or(Z))&&i){let m=await this.handleTokenAccount({side:"in",amount:s||0,mint:n,bypassAssociatedCheck:!0,programId:o}),{tokenAccount:d}=m,f=De(m,["tokenAccount"]);u=d,l.addInstruction(f)}else if(u=await this.getCreatedTokenAccount({mint:n,associatedOnly:!1,programId:o}),!u&&r){let p=await this.scope.account.handleTokenAccount({side:"in",amount:0,mint:n,bypassAssociatedCheck:!0,programId:o}),{tokenAccount:d}=p,f=De(p,["tokenAccount"]);u=d,l.addInstruction(f)}return v({tokenAccount:u},l.AllTxData)}};import{PublicKey as Ke,SystemProgram as zp}from"@solana/web3.js";import{createAssociatedTokenAccountIdempotentInstruction as Xc}from"@solana/spl-token";import Qp from"decimal.js";import{PublicKey as ya}from"@solana/web3.js";var la=F([W("instruction")]),ma=F([W("instruction")]),Bp=F([k("rewardState"),k("rewardOpenTime"),k("rewardEndTime"),k("rewardLastUpdateTime"),k("totalReward"),k("totalRewardEmissioned"),k("rewardClaimed"),k("rewardPerSecond"),ee("accRewardPerShare"),N("rewardVault"),N("rewardMint"),N("rewardSender"),k("rewardType"),Q(k(),15,"padding")]),xp=F([k("state"),k("nonce"),N("lpVault"),N("rewardVault"),N(),N(),k(),k(),k("totalReward"),ee("perShareReward"),k("lastSlot"),k("perSlotReward")]),Sp=F([k("state"),k("nonce"),N("lpVault"),N("rewardVaultA"),k("totalRewardA"),ee("perShareRewardA"),k("perSlotRewardA"),W("option"),N("rewardVaultB"),Be(7),k("totalRewardB"),ee("perShareRewardB"),k("perSlotRewardB"),k("lastSlot"),N()]),Kp=F([k(),k("state"),k("nonce"),k("validRewardTokenNum"),ee("rewardMultiplier"),k("rewardPeriodMax"),k("rewardPeriodMin"),k("rewardPeriodExtend"),N("lpMint"),N("lpVault"),Q(Bp,5,"rewardInfos"),N("creator"),N(),Q(k(),32,"padding")]),Sc=new Proxy(xp,{get(a,e,t){return e==="decode"?(...n)=>{let o=a.decode(...n);return q(v({},o),{version:3,rewardInfos:[{rewardVault:o.rewardVault,totalReward:o.totalReward,perSlotReward:o.perSlotReward,perShareReward:o.perShareReward}]})}:Reflect.get(a,e,t)}}),Kc=new Proxy(Sp,{get(a,e,t){return e==="decode"?(...n)=>{let o=a.decode(...n);return q(v({},o),{version:5,rewardInfos:[{rewardVault:o.rewardVaultA,totalReward:o.totalRewardA,perSlotReward:o.perSlotRewardA,perShareReward:o.perShareRewardA},{rewardVault:o.rewardVaultB,totalReward:o.totalRewardB,perSlotReward:o.perSlotRewardB,perShareReward:o.perShareRewardB}]})}:Reflect.get(a,e,t)}}),bi=new Proxy(Kp,{get(a,e,t){return e==="decode"?(...n)=>{let o=a.decode(...n);return q(v({},o),{version:6,rewardInfos:o.rewardInfos.map(s=>{var i;return q(v({},s),{rewardType:((i=Object.entries(Dn).find(r=>String(r[1])===s.rewardType.toString()))!=null?i:["Standard SPL"])[0]})})})}:Reflect.get(a,e,t)}}),Cp=F([k("isSet"),k("rewardPerSecond"),k("rewardOpenTime"),k("rewardEndTime"),k("rewardType")]),da=F([W("instruction"),k("nonce"),Q(Cp,5,"rewardTimeInfo")]),pa=F([W("instruction"),k("rewardReopenTime"),k("rewardEndTime"),k("rewardPerSecond")]),fa=F([W("instruction"),k("isSet"),k("rewardPerSecond"),k("rewardOpenTime"),k("rewardEndTime"),k("rewardType")]),ww=F([k("state"),N("id"),N("owner"),k("deposited"),Q(k(),1,"rewardDebts")]),gi=F([k("state"),N("id"),N("owner"),k("deposited"),Q(ee(),1,"rewardDebts"),k(""),k("voteLockedBalance"),Q(k(),15)]),Tw=F([k("state"),N("id"),N("owner"),k("deposited"),Q(k(),2,"rewardDebts")]),Cc=F([k("state"),N("id"),N("owner"),k("deposited"),Q(ee(),2,"rewardDebts"),Q(k(),17)]),Rc=F([k(),k("state"),N("id"),N("owner"),k("deposited"),Q(ee(),5,"rewardDebts"),Q(k(),16)]),ht=F([W("instruction"),k("amount")]),Rp=F([N("mint"),N("grantAuthority"),k("baselineVoteWeightScaledFactor"),k("maxExtraLockupVoteWeightScaledFactor"),k("lockupSaturationSecs"),Tc("digitShift"),Q(W(),7,"reserved1"),Q(k(),7,"reserved2")]),Lc=F([Be(8),N("governanceProgramId"),N("realm"),N("realmGoverningTokenMint"),N("realmAuthority"),Q(W(),32,"reserved1"),Q(Rp,4,"votingMints"),Co("timeOffset"),W("bump"),Q(W(),7,"reserved2"),Q(k(),11,"reserved3")]),Lp=F([Co("startTime"),Co("endTime"),W("kind"),Q(W(),15,"reserved")]),Op=F([Q(Lp,1,"lockup"),k("amountDeposited_native"),k("amountInitiallyLockedNative"),qe("isUsed"),qe("allowClawback"),W("votingMintConfigIdx"),Q(W(),29,"reserved")]),Oc=F([Be(8),N("voterAuthority"),N("registrar"),Q(Op,32,"deposits"),W("voterBump"),W("voterWweightRecordBump"),Q(W(),94,"reserved")]);import{NATIVE_MINT as Np}from"@solana/spl-token";var Lw=ye("Raydium_farm_config"),Nc=new ya("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Mc=new ya("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1"),Ow=Np,Nw=new ya("3TRTX4dXUpp2eqxi3tvQDFYUV7SdDJjcPE3Y4mbtftaX"),vc={3:Sc,5:Kc,6:bi},Fc={3:gi,5:Cc,6:Rc},ba=a=>[3,4,5,6].indexOf(a)!==-1,ga=a=>{var i;let{version:e,rewardInfos:t,rewardTokenAccountsPublicKeys:n}=a,o=`rewardInfo:${JSON.stringify(t)}, rewardAccount:${JSON.stringify(n)}`,s={3:()=>{if(t.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${o}`},5:()=>{if(t.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${o}`},6:()=>{if(!n.length||t.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${o}`}};return(i=s[e])==null?void 0:i.call(s)},Dn={"Standard SPL":0,"Option tokens":1},Ut={[_s.toString()]:3,[Es.toString()]:4,[Ds.toString()]:5,[Io.toString()]:6,[kn.FARM_PROGRAM_ID_V3.toString()]:3,[kn.FARM_PROGRAM_ID_V4.toString()]:4,[kn.FARM_PROGRAM_ID_V5.toString()]:5,[kn.FARM_PROGRAM_ID_V6.toString()]:6};import{PublicKey as ue,SystemProgram as oo,SYSVAR_CLOCK_PUBKEY as No,SYSVAR_RENT_PUBKEY as Fp,TransactionInstruction as ot}from"@solana/web3.js";import Nr from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Vp,createAssociatedTokenAccountIdempotentInstruction as _p,TOKEN_PROGRAM_ID as Rt}from"@solana/spl-token";function Aa(a,e,t){return ne([e.toBuffer(),Buffer.from("registrar","utf8"),t.toBuffer()],a)}function Pa(a,e){return ne([e.toBuffer(),Buffer.from("voting_mint_seed","utf8")],a)}function ka(a,e){return ne([e.toBuffer()],a)}function wa(a,e,t){return ne([e.toBuffer(),Buffer.from("voter","utf8"),t.toBuffer()],a)}function Ta(a,e,t){return ne([e.toBuffer(),Buffer.from("voter-weight-record","utf8"),t.toBuffer()],a)}function ha(a,e,t,n){return ne([Buffer.from("governance","utf8"),e.toBuffer(),t.toBuffer(),n.toBuffer()],a)}import Ct from"bn.js";var Ai=ye("Raydium.farm.util");function Pi({programId:a,poolId:e,mint:t,type:n}){let{publicKey:o}=ne([e.toBuffer(),t.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],a);return o}function gt({programId:a,poolId:e,owner:t,version:n}){let{publicKey:o}=ne([e.toBuffer(),t.toBuffer(),Buffer.from(n===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],a);return o}var Vc=({programId:a,poolId:e})=>ne([e.toBuffer()],a);function _c(a){return{isSet:new Ct(1),rewardPerSecond:J(a.perSecond),rewardOpenTime:J(a.openTime),rewardEndTime:J(a.endTime),rewardType:J(Dn[a.rewardType])}}function Ia(a){return J(a.endTime).sub(J(a.openTime)).mul(J(a.perSecond))}function Oo(a){let e=Fc[a];return e||Ai.logWithError("invalid version",a),e}function Mp(a){let e=vc[a];return e||Ai.logWithError("invalid version",a),e}function vp(a,e,t,n){if(a.version===3||a.version===5){if(a.lastSlot.gte(new Ct(t)))return a;let o=new Ct(t).sub(a.lastSlot);a.lastSlot=new Ct(t);for(let s of a.rewardInfos){if(e.amount.eq(new Ct(0)))continue;let i=s.perSlotReward.mul(o);s.perShareReward=s.perShareReward.add(i.mul(new Ct(10).pow(new Ct(a.version===3?9:15))).div(e.amount)),s.totalReward=s.totalReward.add(i)}}else if(a.version===6)for(let o of a.rewardInfos){if(o.rewardState.eq(new Ct(0)))continue;let s=Ct.min(new Ct(n),o.rewardEndTime);if(o.rewardOpenTime.gte(s))continue;let r=s.sub(o.rewardLastUpdateTime).mul(o.rewardPerSecond),c=o.totalReward.sub(o.totalRewardEmissioned);c.lt(r)?(r=c,o.rewardLastUpdateTime=o.rewardLastUpdateTime.add(c.div(o.rewardPerSecond))):o.rewardLastUpdateTime=s,!e.amount.eq(new Ct(0))&&(o.accRewardPerShare=o.accRewardPerShare.add(r.mul(a.rewardMultiplier).div(e.amount)),o.totalRewardEmissioned=o.totalRewardEmissioned.add(r))}return a}async function Hw({connection:a,farmPools:e,owner:t,config:n,chainTime:o}){let s=!1,i=!1,r=new Ct(10),c=[];for(let p of e){let d=Fe(p);d.version===6?i=!0:s=!0,c.push({pubkey:d.id,version:d.version,key:"state",poolId:d.id},{pubkey:d.lpVault,version:d.version,key:"lpVault",poolId:d.id}),t&&c.push({pubkey:gt({programId:d.programId,poolId:d.id,owner:t,version:p.version}),version:d.version,key:"ledger",poolId:d.id})}let u={},l=await Ne(a,c,n);for(let{pubkey:p,version:d,key:f,poolId:y,accountInfo:b}of l){let g=y.toBase58();if(u[g]=v({},u[g]),f==="state"){let A=Mp(d);(!b||!b.data||b.data.length!==A.span)&&Ai.logWithError(`invalid farm state account info, pools.id, ${p}`),u[g].state=A.decode(b.data)}else if(f==="lpVault")(!b||!b.data||b.data.length!==rn.span)&&Ai.logWithError(`invalid farm lp vault account info, pools.lpVault, ${p}`),u[g].lpVault=rn.decode(b.data);else if(f==="ledger"){let A=Oo(d);b&&b.data&&(b.data.length!==A.span&&Ai.logWithError(`invalid farm ledger account info, ledger, ${p}`),u[g].ledger=A.decode(b.data))}}let m=i||s?await a.getSlot():0;for(let p of Object.keys(u))u[p]!==void 0&&(u[p].state=vp(u[p].state,u[p].lpVault,m,o));for(let[p,{state:d,ledger:f}]of Object.entries(u))if(f){let y=d.version===6?d.rewardMultiplier:d.rewardInfos.length===1?r.pow(new Ct(9)):r.pow(new Ct(15)),b=d.rewardInfos.map((g,A)=>{let h=f.rewardDebts[A];return f.deposited.mul(d.version===6?g.accRewardPerShare:g.perShareReward).div(y).sub(h)});u[p].wrapped=q(v({},u[p].wrapped),{pendingRewards:b})}return u}function Zw(a,e=Date.now()){if(a.version===6){let t=a.state.rewardInfos;if(t.every(({rewardOpenTime:n})=>ju(e,n.toNumber(),{unit:"s"})))return"upcoming pool";if(t.every(({rewardEndTime:n})=>Hu(e,n.toNumber(),{unit:"s"})))return"closed pool"}else{let t=a.state.rewardInfos.map(({perSlotReward:n})=>n);if(t.length===2){if(String(t[0])==="0"&&String(t[1])!=="0")return"normal fusion pool";if(String(t[0])!=="0"&&String(t[1])!=="0")return"dual fusion pool";if(String(t[0])==="0"&&String(t[1])==="0")return"closed pool"}else if(t.length===1&&String(t[0])==="0")return"closed pool"}}async function Ba(a,e,t,n){let o=await a.getAccountInfo(e);if(o===null)throw Error("registrar info check error");let i=Lc.decode(o.data).votingMints.findIndex(l=>l.mint.equals(n));if(i===-1)throw Error("find voter mint error");let r=await a.getAccountInfo(t);if(r===null)return{index:i,isInit:!1};let u=Oc.decode(r.data).deposits.findIndex(l=>l.isUsed&&l.votingMintConfigIdx===i);return u===-1?{index:i,isInit:!1}:{index:u,isInit:!0}}var Ep=ye("Raydium_farm_instruction"),ki={voterStakeRegistryCreateVoter:Buffer.from([6,24,245,52,243,255,148,25]),voterStakeRegistryCreateDepositEntry:Buffer.from([185,131,167,186,159,125,19,67]),voterStakeRegistryDeposit:Buffer.from([242,35,198,137,82,225,242,182]),voterStakeRegistryWithdraw:Buffer.from([183,18,70,156,148,109,161,34]),voterStakeRegistryUpdateVoterWeightRecord:Buffer.from([45,185,3,36,109,190,115,169])};function wi(a){let{version:e,id:t,ledger:n,programId:o,owner:s}=a,i={3:9,5:10}[e];i||Ep.logWithError(`invalid farm pool version: ${e}`);let r=Buffer.alloc(la.span);la.encode({instruction:i},r);let c=[P({pubkey:t}),P({pubkey:n}),P({pubkey:s,isWritable:!1}),P({pubkey:oo.programId,isWritable:!1}),P({pubkey:Fp,isWritable:!1})];return{instruction:new ot({programId:o,keys:c,data:r}),instructionType:U.FarmV3CreateLedger}}function Ec(a){var n;let e=Buffer.alloc(da.span);da.encode({instruction:0,nonce:new Nr(a.nonce),rewardTimeInfo:a.rewardInfoConfig},e);let t=[...xs,P({pubkey:a.farmId}),P({pubkey:a.farmAuthority,isWritable:!1}),P({pubkey:a.lpVault}),P({pubkey:a.lpMint,isWritable:!1}),P({pubkey:a.lockVault}),P({pubkey:a.lockMint,isWritable:!1}),P({pubkey:(n=a.lockUserAccount)!=null?n:ct}),P({pubkey:a.owner,isWritable:!1,isSigner:!0})];for(let o of a.rewardInfo)t.push(P({pubkey:o.rewardMint,isWritable:!1}),P({pubkey:o.rewardVault}),P({pubkey:o.userRewardToken}));return{instruction:new ot({programId:a.programId,keys:t,data:e}),instructionType:U.FarmV6Create}}function Dc(a){let e=Buffer.alloc(ma.span);ma.encode({instruction:5},e);let t=[P({pubkey:Rt,isWritable:!1}),P({pubkey:a.id}),P({pubkey:a.authority,isWritable:!1}),P({pubkey:a.lpVault,isWritable:!1}),P({pubkey:a.rewardVault}),P({pubkey:a.userRewardToken}),P({pubkey:a.owner,isWritable:!1,isSigner:!0})];return{instruction:new ot({programId:a.programId,keys:t,data:e}),instructionType:U.FarmV6CreatorWithdraw}}function Dp(a,e,t,n,o,s,i,r,c,u,l,m,p){let d=F([W("depositEntryIndex"),k("amount")]),f=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:Rt,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:pr,isSigner:!1,isWritable:!1}],y=Buffer.alloc(d.span);d.encode({depositEntryIndex:m,amount:p},y);let b=Buffer.from([...ki.voterStakeRegistryDeposit,...y]);return new ot({keys:f,programId:a,data:b})}function Wp(a,e,t,n){let o=F([]),s=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:oo.programId,isSigner:!1,isWritable:!1}],i=Buffer.alloc(o.span);o.encode({},i);let r=Buffer.from([...ki.voterStakeRegistryUpdateVoterWeightRecord,...i]);return new ot({keys:s,programId:a,data:r})}function qp(a,e,t,n,o,s,i,r,c,u,l,m,p,d,f){let y=F([W("depositEntryIndex"),k("amount")]),b=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:Rt,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:pr,isSigner:!1,isWritable:!1}],g=Buffer.alloc(y.span);y.encode({depositEntryIndex:d,amount:f},g);let A=Buffer.from([...ki.voterStakeRegistryWithdraw,...g]);return new ot({keys:b,programId:a,data:A})}function Up(a,e,t,n,o,s){let i=F([W("ins")]),r=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:oo.programId,isSigner:!1,isWritable:!1}],c=Buffer.alloc(i.span);return i.encode({ins:23},c),new ot({keys:r,programId:a,data:c})}function Gp(a,e,t,n,o,s,i,r){let c=F([W("voterBump"),W("voterWeightRecordBump")]),u=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!0,isWritable:!0},{pubkey:oo.programId,isSigner:!1,isWritable:!1},{pubkey:nt,isSigner:!1,isWritable:!1},{pubkey:pr,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({voterBump:i,voterWeightRecordBump:r},l);let m=Buffer.from([...ki.voterStakeRegistryCreateVoter,...l]);return new ot({keys:u,programId:a,data:m})}function Xp(a,e,t,n,o,s,i,r,c,u,l,m){let p=F([W("depositEntryIndex"),W("kind"),W("option"),k("startTs"),ft("periods"),qe("allowClawback")]),d=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:s,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:oo.programId,isSigner:!1,isWritable:!1},{pubkey:Rt,isSigner:!1,isWritable:!1},{pubkey:Vp,isSigner:!1,isWritable:!1},{pubkey:nt,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({depositEntryIndex:r,kind:c,option:u===void 0?0:1,startTs:u,periods:l,allowClawback:m},f);let y=Buffer.from([...ki.voterStakeRegistryCreateDepositEntry,...f]);return new ot({keys:d,programId:a,data:y})}async function pT({connection:a,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:o,communityTokenMint:s,owner:i,poolId:r,tokenProgram:c}){let u=Aa(n,o,s).publicKey,l=gt({programId:e,poolId:r,owner:i,version:3}),m=await a.getAccountInfo(l);if(m===null)throw Error("user is not staker");let p=gi.decode(m.data),d=p.deposited.sub(p.voteLockedBalance);if(console.log("amount",d.toString()),d.eq(new Nr(0)))throw Error("user do not has new stake amount");let f=Pa(e,r).publicKey,y=ka(e,r).publicKey,{publicKey:b,nonce:g}=wa(n,u,i),A=H(b,f,c).publicKey,{publicKey:h,nonce:I}=Ta(n,u,i),T=ha(t,o,s,i).publicKey,w=[],S=H(i,f,c).publicKey;if(await a.getAccountInfo(S)===null&&w.push(_p(i,S,i,f)),await a.getAccountInfo(b)===null){let L=Up(t,o,i,s,i,T);w.push(L,Gp(n,u,b,h,i,i,g,I))}let{index:B,isInit:C}=await Ba(a,u,b,f);return C||w.push(Xp(n,u,b,A,i,i,f,B,0,void 0,0,!1)),w.push(Dp(n,u,b,A,S,i,l,r,f,y,e,B,d),Wp(n,u,b,h)),w}async function fT({connection:a,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:o,communityTokenMint:s,owner:i,poolId:r,tokenProgram:c}){let u=Aa(n,o,s).publicKey,l=gt({programId:e,poolId:r,owner:i,version:3}),m=await a.getAccountInfo(l);if(m===null)throw Error("user is not staker");let p=gi.decode(m.data);if(p.voteLockedBalance.eq(new Nr(0)))throw Error("user has vote locked balance = 0");let d=Pa(e,r).publicKey,f=ka(e,r).publicKey,{publicKey:y}=wa(n,u,i),b=H(y,d,c).publicKey,{publicKey:g}=Ta(n,u,i),A=ha(t,o,s,i).publicKey,h=[],{index:I,isInit:T}=await Ba(a,u,y,d);if(!T)throw Error("deposit entry index check error");return h.push(qp(n,u,y,i,A,g,b,H(i,d,c).publicKey,l,r,d,f,e,I,p.voteLockedBalance)),h}function xa({payer:a,rewardVault:e,userRewardTokenPub:t,farmKeys:n,rewardInfo:o}){let s=Buffer.alloc(pa.span);pa.encode({instruction:3,rewardReopenTime:J(o.openTime),rewardEndTime:J(o.endTime),rewardPerSecond:J(o.perSecond)},s);let i=[P({pubkey:Rt,isWritable:!1}),P({pubkey:n.id}),P({pubkey:n.lpVault,isWritable:!1}),P({pubkey:e}),P({pubkey:t}),P({pubkey:a,isWritable:!1,isSigner:!0})];return new ot({programId:n.programId,keys:i,data:s})}function Sa({payer:a,userRewardTokenPub:e,farmKeys:t,rewardVault:n,rewardInfo:o}){let s=Buffer.alloc(fa.span);fa.encode({instruction:4,isSet:new Nr(1),rewardPerSecond:J(o.perSecond),rewardOpenTime:J(o.openTime),rewardEndTime:J(o.endTime),rewardType:J(Dn[o.rewardType])},s);let i=[...xs,P({pubkey:t.id}),P({pubkey:t.authority,isWritable:!1}),P({pubkey:o.mint,isWritable:!1}),P({pubkey:n}),P({pubkey:e}),P({pubkey:a,isWritable:!1,isSigner:!0})];return new ot({programId:t.programId,keys:i,data:s})}function yT(a){let{farmInfo:e,farmKeys:t,version:n,lpAccount:o,rewardAccounts:s,owner:i,instruction:r,amount:c,deposit:u}=a,[l,m]=[new ue(e.programId),new ue(e.id)],p=gt({programId:l,poolId:m,owner:i,version:n}),d=Buffer.alloc(ht.span);ht.encode({instruction:r,amount:c},d);let f=n===6?[P({pubkey:Rt,isWritable:!1}),...u?[P({pubkey:oo.programId,isWritable:!1})]:[],P({pubkey:m}),P({pubkey:new ue(t.authority),isWritable:!1}),P({pubkey:new ue(t.lpVault)}),P({pubkey:p}),P({pubkey:i,isWritable:!1,isSigner:!0}),P({pubkey:o})]:[P({pubkey:m}),P({pubkey:new ue(t.authority),isWritable:!1}),P({pubkey:p}),P({pubkey:i,isWritable:!1,isSigner:!0}),P({pubkey:o}),P({pubkey:new ue(t.lpVault)}),P({pubkey:s[0]}),P({pubkey:new ue(t.rewardInfos[0].vault)}),P({pubkey:No,isWritable:!1}),P({pubkey:Rt,isWritable:!1})];if(n===5)for(let y=1;y<t.rewardInfos.length;y++)f.push(P({pubkey:s[y]})),f.push(P({pubkey:new ue(t.rewardInfos[y].vault)}));if(n===6)for(let y=0;y<t.rewardInfos.length;y++)f.push(P({pubkey:new ue(t.rewardInfos[y].vault)})),f.push(P({pubkey:s[y]}));return new ot({programId:l,keys:f,data:d})}function Ti(a){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:s,amount:i}=a,[r,c]=[new ue(e.programId),new ue(e.id)],u=gt({programId:r,poolId:c,owner:s,version:6}),l=Buffer.alloc(ht.span);ht.encode({instruction:2,amount:J(i)},l);let m=[P({pubkey:Rt,isWritable:!1}),P({pubkey:c}),P({pubkey:new ue(t.authority),isWritable:!1}),P({pubkey:new ue(t.lpVault)}),P({pubkey:u}),P({pubkey:s,isWritable:!1,isSigner:!0}),P({pubkey:n})];for(let p=0;p<t.rewardInfos.length;p++)m.push(P({pubkey:new ue(t.rewardInfos[p].vault)})),m.push(P({pubkey:o[p]}));return new ot({programId:r,keys:m,data:l})}function hi(a){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:s,amount:i,userAuxiliaryLedgers:r}=a,[c,u]=[new ue(e.programId),new ue(e.id)],l=gt({programId:c,poolId:u,owner:s,version:5}),m=Buffer.alloc(ht.span);ht.encode({instruction:12,amount:J(i)},m);let p=[P({pubkey:u}),P({pubkey:new ue(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:s,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new ue(t.lpVault)}),P({pubkey:o[0]}),P({pubkey:new ue(t.rewardInfos[0].vault)}),P({pubkey:No,isWritable:!1}),P({pubkey:Rt,isWritable:!1})];for(let d=1;d<t.rewardInfos.length;d++)p.push(P({pubkey:o[d]})),p.push(P({pubkey:new ue(t.rewardInfos[d].vault)}));if(r)for(let d of r)p.push(P({pubkey:d}));return new ot({programId:c,keys:p,data:m})}function Wc(a){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:s,amount:i,userAuxiliaryLedgers:r}=a,[c,u]=[new ue(e.programId),new ue(e.id)],l=F([W("instruction"),k("amount")]),m=[P({pubkey:u}),P({pubkey:new ue(t.authority),isWritable:!1}),P({pubkey:r[0]}),P({pubkey:s,isSigner:!0,isWritable:!1}),P({pubkey:n}),P({pubkey:new ue(t.lpVault)}),P({pubkey:o[0]}),P({pubkey:new ue(t.rewardInfos[0].vault)}),P({pubkey:No,isWritable:!1}),P({pubkey:Rt,isWritable:!1}),P({pubkey:o[1]}),P({pubkey:new ue(t.rewardInfos[1].vault)})],p=Buffer.alloc(l.span);return l.encode({instruction:2,amount:i},p),new ot({keys:m,programId:c,data:p})}function Ii(a){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:s,amount:i,userAuxiliaryLedgers:r}=a,[c,u]=[new ue(e.programId),new ue(e.id)],l=gt({programId:c,poolId:u,owner:s,version:3}),m=Buffer.alloc(ht.span);ht.encode({instruction:11,amount:J(i)},m);let p=[P({pubkey:u}),P({pubkey:new ue(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:s,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new ue(t.lpVault)}),P({pubkey:o[0]}),P({pubkey:new ue(t.rewardInfos[0].vault)}),P({pubkey:No,isWritable:!1}),P({pubkey:Rt,isWritable:!1})];if(r)for(let d of r)p.push(P({pubkey:d}));return new ot({programId:c,keys:p,data:m})}function qc(a){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:s,amount:i,userAuxiliaryLedgers:r}=a,[c,u]=[new ue(e.programId),new ue(e.id)],l=gt({programId:c,poolId:u,owner:s,version:3}),m=Buffer.alloc(ht.span);ht.encode({instruction:10,amount:J(i)},m);let p=[P({pubkey:u}),P({pubkey:new ue(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:s,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new ue(t.lpVault)}),P({pubkey:o[0]}),P({pubkey:new ue(t.rewardInfos[0].vault)}),P({pubkey:No,isWritable:!1}),P({pubkey:Rt,isWritable:!1})];if(r)for(let d of r)p.push(P({pubkey:d}));return new ot({programId:c,keys:p,data:m})}function Uc(a){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:s,amount:i,userAuxiliaryLedgers:r}=a,[c,u]=[new ue(e.programId),new ue(e.id)],l=gt({programId:c,poolId:u,owner:s,version:5}),m=Buffer.alloc(ht.span);ht.encode({instruction:11,amount:J(i)},m);let p=[P({pubkey:u}),P({pubkey:new ue(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:s,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new ue(t.lpVault)}),P({pubkey:o[0]}),P({pubkey:new ue(t.rewardInfos[0].vault)}),P({pubkey:No,isWritable:!1}),P({pubkey:Rt,isWritable:!1})];for(let d=1;d<t.rewardInfos.length;d++)p.push(P({pubkey:o[d]})),p.push(P({pubkey:new ue(t.rewardInfos[d].vault)}));if(r)for(let d of r)p.push(P({pubkey:d}));return new ot({programId:c,keys:p,data:m})}function Gc(a){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:s,amount:i}=a,[r,c]=[new ue(e.programId),new ue(e.id)],u=gt({programId:r,poolId:c,owner:s,version:6}),l=Buffer.alloc(ht.span);ht.encode({instruction:1,amount:J(i)},l);let m=[P({pubkey:Rt,isWritable:!1}),P({pubkey:oo.programId,isWritable:!1}),P({pubkey:c}),P({pubkey:new ue(t.authority),isWritable:!1}),P({pubkey:new ue(t.lpVault)}),P({pubkey:u}),P({pubkey:s,isWritable:!1,isSigner:!0}),P({pubkey:n})];for(let p=0;p<t.rewardInfos.length;p++)m.push(P({pubkey:new ue(t.rewardInfos[p].vault)})),m.push(P({pubkey:o[p]}));return new ot({programId:r,keys:m,data:l})}var Bi=class extends Ve{async _getUserRewardInfo({payer:e,rewardInfo:t}){if(t.mint.equals(ct)){let n=await _n({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:e,amount:Ia(q(v({},t),{openTime:t.openTime.toString(),endTime:t.endTime.toString()}))});return{rewardPubKey:n.addresses.newAccount,newInstruction:n}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:t.mint,associatedOnly:!1})}}async create({poolInfo:e,rewardInfos:t,payer:n,programId:o=Io,txVersion:s,feePayer:i,lockProgram:r}){var S,x;this.checkDisabled(),this.scope.checkOwner();let u={lpMint:new Ke(e.lpMint.address),lockInfo:{lockMint:(S=r==null?void 0:r.mint)!=null?S:Nc,lockVault:(x=r==null?void 0:r.vault)!=null?x:Mc},version:6,rewardInfos:t,programId:o},l=this.createTxBuilder(i),m=n!=null?n:this.scope.ownerPubKey,p=Ye({fromPublicKey:m,programId:u.programId}),d=await this.scope.connection.getMinimumBalanceForRentExemption(bi.span);l.addInstruction({instructions:[zp.createAccountWithSeed({fromPubkey:m,basePubkey:m,seed:p.seed,newAccountPubkey:p.publicKey,lamports:d,space:bi.span,programId:u.programId})]});let{publicKey:f,nonce:y}=Vc({programId:new Ke(u.programId),poolId:p.publicKey}),b=Pi({programId:u.programId,poolId:p.publicKey,mint:u.lpMint,type:"lpVault"}),g=[],A=[];for(let K of u.rewardInfos){K.openTime>=K.endTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",K.openTime.toString()),isNaN(Dn[K.rewardType])&&this.logAndCreateError("rewardType error",K.rewardType),Number(K.perSecond)<=0&&this.logAndCreateError("rewardPerSecond error",K.perSecond),g.push(_c(K));let{rewardPubKey:B,newInstruction:C}=await this._getUserRewardInfo({rewardInfo:K,payer:m});C&&l.addInstruction(C),B||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let L=K.mint.equals(ct)?new Ke(ut.address):K.mint;A.push({rewardMint:L,rewardVault:Pi({programId:u.programId,poolId:p.publicKey,mint:L,type:"rewardVault"}),userRewardToken:B})}let{account:h,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({mint:new Ke(u.lockInfo.lockMint),owner:this.scope.ownerPubKey,skipCloseAccount:!1,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:!1});I&&l.addInstruction(I),h||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let{instruction:T,instructionType:w}=Ec({farmId:p.publicKey,owner:this.scope.ownerPubKey,farmAuthority:f,lpVault:b,lpMint:u.lpMint,lockVault:u.lockInfo.lockVault,lockMint:u.lockInfo.lockMint,lockUserAccount:h,programId:u.programId,rewardInfo:A,rewardInfoConfig:g,nonce:y});return l.addInstruction({instructions:[T],instructionTypes:[w]}).versionBuild({txVersion:s,extInfo:{farmId:p.publicKey,farmAuthority:f,lpVault:b,lockUserAccount:h,nonce:y}})}async restartReward({farmInfo:e,payer:t,newRewardInfo:n,txVersion:o,feePayer:s}){var g;let i=Ut[e.programId];i!==6&&this.logAndCreateError("invalid farm version ",i);let r=Fe((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:r.id,rewardInfos:e.rewardInfos,lpVault:r.lpVault,programId:r.programId};n.openTime>=n.endTime&&this.logAndCreateError("start time error","newRewardInfo",n);let u=t||this.scope.ownerPubKey,l=n.mint.equals(ct)?new Ke(ut.address):n.mint,m=c.rewardInfos.findIndex(A=>new Ke(A.mint.address).equals(l)),p=r.rewardInfos[m];p||this.logAndCreateError("configuration does not exist","rewardMint",l);let d=(g=p.vault)!=null?g:ct,f=this.createTxBuilder(s),{rewardPubKey:y,newInstruction:b}=await this._getUserRewardInfo({rewardInfo:n,payer:u});return b&&f.addInstruction(b),y||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts),f.addInstruction({instructions:[xa({payer:this.scope.ownerPubKey,rewardVault:d,userRewardTokenPub:y,farmKeys:c,rewardInfo:n})],instructionTypes:[U.FarmV6Restart]}).versionBuild({txVersion:o})}async restartRewards({farmInfo:e,payer:t,newRewardInfos:n,txVersion:o,feePayer:s}){var m;let i=Ut[e.programId];i!==6&&this.logAndCreateError("invalid farm version ",i);let r=Fe((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:r.id,rewardInfos:e.rewardInfos,lpVault:r.lpVault,programId:r.programId};n.forEach(p=>{p.openTime>=p.endTime&&this.logAndCreateError("start time error","newRewardInfo",p)});let u=t||this.scope.ownerPubKey,l=this.createTxBuilder(s);for(let p of n){let d=p.mint.equals(ct)?new Ke(ut.address):p.mint,f=c.rewardInfos.findIndex(I=>new Ke(I.mint.address).equals(d)),y=r.rewardInfos[f];y||this.logAndCreateError("configuration does not exist","rewardMint",d);let b=(m=y.vault)!=null?m:ct,{rewardPubKey:g,newInstruction:A}=await this._getUserRewardInfo({rewardInfo:p,payer:u});A&&l.addInstruction(A),g||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let h=xa({payer:this.scope.ownerPubKey,rewardVault:b,userRewardTokenPub:g,farmKeys:c,rewardInfo:p});l.addInstruction({instructions:[h],instructionTypes:[U.FarmV6Restart]})}return l.versionBuild({txVersion:o})}async addNewRewardToken(e){let{txVersion:t,farmInfo:n,newRewardInfo:o,payer:s,feePayer:i}=e,r=Ut[n.programId];r!==6&&this.logAndCreateError("invalid farm version ",r);let c=Fe((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=s!=null?s:this.scope.ownerPubKey,l=this.createTxBuilder(i),m=o.mint.equals(ct)?new Ke(ut.address):o.mint,p=Pi({programId:new Ke(n.programId),poolId:new Ke(n.id),mint:m,type:"rewardVault"}),{rewardPubKey:d,newInstruction:f}=await this._getUserRewardInfo({rewardInfo:o,payer:u});return f&&l.addInstruction(f),d||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts),o.mint=m,l.addInstruction({instructions:[Sa({payer:this.scope.ownerPubKey,userRewardTokenPub:d,farmKeys:c,rewardVault:p,rewardInfo:o})],instructionTypes:[U.FarmV6CreatorAddReward]}).versionBuild({txVersion:t})}async addNewRewardsToken(e){let{txVersion:t,farmInfo:n,newRewardInfos:o,payer:s,feePayer:i}=e,r=Ut[n.programId];r!==6&&this.logAndCreateError("invalid farm version ",r);let c=Fe((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=s!=null?s:this.scope.ownerPubKey,l=this.createTxBuilder(i);for(let m of o){let p=m.mint.equals(ct)?new Ke(ut.address):m.mint,d=Pi({programId:new Ke(n.programId),poolId:new Ke(n.id),mint:p,type:"rewardVault"}),{rewardPubKey:f,newInstruction:y}=await this._getUserRewardInfo({rewardInfo:m,payer:u});y&&l.addInstruction(y),f||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let b=Sa({payer:this.scope.ownerPubKey,userRewardTokenPub:f,farmKeys:c,rewardVault:d,rewardInfo:q(v({},m),{mint:p})});l.addInstruction({instructions:[b],instructionTypes:[U.FarmV6CreatorAddReward]})}return l.versionBuild({txVersion:t})}async deposit(e){let{txVersion:t,farmInfo:n,amount:o,feePayer:s,useSOLBalance:i,associatedOnly:r=!0,checkCreateATAOwner:c=!1,userAuxiliaryLedgers:u,computeBudgetConfig:l,txTipConfig:m}=e;this.scope.availability.addFarm===!1&&this.logAndCreateError("farm deposit feature disabled in your region");let{rewardInfos:p,programId:d}=n,f=Ut[d];f===4&&this.logAndCreateError("V4 has suspended deposits:",n.programId),ba(f)||this.logAndCreateError("invalid farm program:",n.programId);let[y,b]=[new Ke(n.programId),new Ke(n.id)],g=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],A=gt({programId:y,poolId:b,owner:this.scope.ownerPubKey,version:f}),h=this.createTxBuilder(s);h.addCustomComputeBudget(l),h.addTipInstruction(m);let I={};for(let R of this.scope.account.tokenAccounts)if(r){let O=H(this.scope.ownerPubKey,R.mint,R.programId).publicKey;R.publicKey&&O.equals(R.publicKey)&&(I[R.mint.toString()]=R.publicKey)}else I[R.mint.toString()]=R.publicKey;let T=g.lpMint,w=I[T.address];w||this.logAndCreateError("you don't have any lp","lp zero",I);let S=[];for(let R of p){let O=i&&R.mint.address===Z.toString(),_=I[R.mint.address];if(!_){let{account:X,instructionParams:j}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:R.mint.programId,mint:new Ke(R.mint.address),notUseTokenAccount:O,createInfo:{payer:s||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!O,associatedOnly:O?!1:r,checkCreateATAOwner:c});_=X,j&&h.addInstruction(j)}I[R.mint.address]=_,S.push(_)}let x,K=await this.scope.connection.getAccountInfo(A);if(K&&(x=Oo(f).decode(K.data)),n.programId!==Io.toString()&&n.programId!==kn.FARM_PROGRAM_ID_V6.toString()&&!x){let{instruction:R,instructionType:O}=wi({id:b,programId:y,version:f,ledger:A,owner:this.scope.ownerPubKey});h.addInstruction({instructions:[R],instructionTypes:[O]})}let B=ga({version:f,rewardInfos:p,rewardTokenAccountsPublicKeys:S});B&&this.logAndCreateError(B);let C={amount:J(o),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:g,lpAccount:w,rewardAccounts:S,userAuxiliaryLedgers:u==null?void 0:u.map(R=>new Ke(R))},L=f===6?Gc(C):f===5?Uc(C):qc(C),M={3:U.FarmV3Deposit,5:U.FarmV5Deposit,6:U.FarmV6Deposit};return h.addInstruction({instructions:[L],instructionTypes:[M[f]]}).versionBuild({txVersion:t})}async withdraw(e){let{txVersion:t,farmInfo:n,amount:o,deposited:s,useSOLBalance:i,feePayer:r,associatedOnly:c=!0,checkCreateATAOwner:u=!1,userAuxiliaryLedgers:l,computeBudgetConfig:m,txTipConfig:p}=e,{rewardInfos:d}=n;this.scope.availability.removeFarm===!1&&this.logAndCreateError("farm withdraw feature disabled in your region");let f=Ut[n.programId];ba(f)||this.logAndCreateError("invalid farm program:",n.programId);let y=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],b=this.createTxBuilder(r);b.addCustomComputeBudget(m),b.addTipInstruction(p);let g={};for(let B of this.scope.account.tokenAccounts)if(c){let C=H(this.scope.ownerPubKey,B.mint).publicKey;B.publicKey&&C.equals(B.publicKey)&&(g[B.mint.toString()]=B.publicKey)}else g[B.mint.toString()]=B.publicKey;if(f!==4){let B=gt({programId:new Ke(n.programId),poolId:new Ke(n.id),owner:this.scope.ownerPubKey,version:f}),C=await this.scope.connection.getAccountInfo(B);if(C)Oo(f).decode(C.data).deposited.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});else if(f!==6){let{instruction:L,instructionType:M}=wi({id:new Ke(y.id),programId:new Ke(y.programId),version:f,ledger:B,owner:this.scope.ownerPubKey});b.addInstruction({instructions:[L],instructionTypes:[M]})}}s&&s.isZero()&&!(l||[]).length&&this.logAndCreateError("no deposited lp",{farmId:n.id});let A=y.lpMint.address,h=i&&A===Z.toString(),I=g[A.toString()];if(!I){let{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:y.lpMint.programId,mint:new Ke(A),notUseTokenAccount:h,createInfo:{payer:r||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:h?!1:c,checkCreateATAOwner:u});I=B,C&&b.addInstruction(C)}g[A.toString()]=I;let T=[];for(let B of d){let C=i&&B.mint.address===Z.toString(),L=g[B.mint.address];if(!L){let{account:M,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:B.mint.programId,mint:new Ke(B.mint.address),notUseTokenAccount:C,createInfo:{payer:r||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!C,associatedOnly:C?!1:c,checkCreateATAOwner:u});L=M,R&&b.addInstruction(R)}g[B.mint.address]=L,T.push(L)}let w=ga({version:f,rewardInfos:d,rewardTokenAccountsPublicKeys:T});w&&this.logAndCreateError(w);let S={amount:J(o),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:y,lpAccount:I,rewardAccounts:T,userAuxiliaryLedgers:l==null?void 0:l.map(B=>new Ke(B))},x=f===6?Ti(S):f===5?hi(S):f===4?Wc(S):Ii(S),K={3:U.FarmV3Withdraw,4:U.FarmV4Withdraw,5:U.FarmV5Withdraw,6:U.FarmV6Withdraw};return b.addInstruction({instructions:[x],instructionTypes:[K[f]]}).versionBuild({txVersion:t})}async withdrawFarmReward({farmInfo:e,withdrawMint:t,txVersion:n,computeBudgetConfig:o,txTipConfig:s,feePayer:i}){var y;this.scope.checkOwner();let r=Fe((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c=Ut[e.programId];c!==6&&this.logAndCreateError("invalid farm version",c);let u=r.rewardInfos.find(b=>bt(b.mint.address).equals(bt(t)));u||this.logAndCreateError("withdraw mint error","rewardInfos",e);let l=(y=u==null?void 0:u.vault)!=null?y:ct,m=this.createTxBuilder(i),p;if(t.equals(ct)||t.equals(Ke.default)){let b=await _n({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:Ia(q(v({},u),{openTime:u.openTime,endTime:u.endTime,perSecond:new Qp(u.perSecond).mul(10**u.mint.decimals).toString()}))});p=b.addresses.newAccount,m.addInstruction(b)}else{let b=await this.scope.account.getCreatedTokenAccount({mint:t});b===null?(p=await this.scope.account.getAssociatedTokenAccount(t),m.addInstruction({instructions:[Xc(this.scope.ownerPubKey,p,this.scope.ownerPubKey,t)],instructionTypes:[U.CreateATA]})):p=b}let{instruction:d,instructionType:f}=Dc({programId:r.programId,id:r.id,authority:r.authority,lpVault:r.lpVault,rewardVault:l,userRewardToken:p,owner:this.scope.ownerPubKey});return m.addCustomComputeBudget(o),m.addTipInstruction(s),m.addInstruction({instructions:[d],instructionTypes:[f]}).versionBuild({txVersion:n})}async harvestAllRewards(e){let{farmInfoList:t,useSOLBalance:n,feePayer:o,associatedOnly:s=!0,checkCreateATAOwner:i=!1,userAuxiliaryLedgers:r,txVersion:c,computeBudgetConfig:u}=e,l=this.createTxBuilder(o),m={};for(let f of this.scope.account.tokenAccounts)if(s){let y=H(this.scope.ownerPubKey,f.mint).publicKey;f.publicKey&&y.equals(f.publicKey)&&(m[f.mint.toString()]=f.publicKey)}else m[f.mint.toString()]=f.publicKey;let d=(await this.scope.api.fetchFarmKeysById({ids:Object.values(t).map(f=>f.id).join(",")})).reduce((f,y)=>q(v({},f),{[y.id]:y}),{});for(let f of Object.values(t)){let{programId:y,lpMint:b,rewardInfos:g,id:A}=f,h=Ut[y],I=b.address,T=n&&I===Z.toString(),w=m[I];if(!w){let{account:L,instructionParams:M}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:b.programId,mint:new Ke(I),notUseTokenAccount:T,createInfo:{payer:o||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:T?!1:s,checkCreateATAOwner:i});w=L,M&&l.addInstruction(M)}m[I.toString()]=w;let S=[];for(let L of g){let M=n&&L.mint.address===Z.toString(),R=m[L.mint.address];if(!R)if(M){let{account:O,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:L.mint.programId,mint:new Ke(L.mint.address),notUseTokenAccount:M,createInfo:{payer:o||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!M,associatedOnly:M?!1:s,checkCreateATAOwner:i});R=O,_&&l.addInstruction(_)}else{let O=new Ke(L.mint.address);R=this.scope.account.getAssociatedTokenAccount(O),l.addInstruction({instructions:[Xc(this.scope.ownerPubKey,R,this.scope.ownerPubKey,O)]})}m[L.mint.address]=R,S.push(R)}let x=d[A],K={amount:et,owner:this.scope.ownerPubKey,farmInfo:f,farmKeys:x,lpAccount:w,rewardAccounts:S,userAuxiliaryLedgers:r==null?void 0:r.map(L=>new Ke(L))},B=h===6?Ti(K):h===5?hi(K):Ii(K),C={3:U.FarmV3Withdraw,5:U.FarmV5Withdraw,6:U.FarmV6Withdraw};l.addInstruction({instructions:[B],instructionTypes:[C[h]]})}return c===1?l.sizeCheckBuild({computeBudgetConfig:u}):l.sizeCheckBuildV0({computeBudgetConfig:u})}};import{PublicKey as tt}from"@solana/web3.js";import{AccountLayout as Vf,NATIVE_MINT as Yr,TOKEN_PROGRAM_ID as qn}from"@solana/spl-token";import{Keypair as Dr,PublicKey as G,SystemProgram as Kn,TransactionInstruction as yt}from"@solana/web3.js";import Ea from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Ni,TOKEN_2022_PROGRAM_ID as Ue,TOKEN_PROGRAM_ID as Ce}from"@solana/spl-token";import rf from"bn.js";import Fo from"decimal.js";import Gt from"bn.js";var ge=new Gt(0),vt=new Gt(1),Bn=new Gt(-1),it=new Gt(1).shln(64),Mr=new Gt(1).shln(128),xi=it.sub(vt),Si=64,zc=Mr.subn(1),At=-443636,It=-At,Xt=new Gt("4295048016"),zt=new Gt("79226673521066979257578248091"),vr=new Gt("4295048017"),Fr=new Gt("79226673521066979257578248090"),Qc=16,Yc="59543866431248",jc="184467440737095516",Hc="15793534762490258745",Vr=new Gt(10).pow(new Gt(6)),Yp=(n=>(n[n.rate_500=500]="rate_500",n[n.rate_3000=3e3]="rate_3000",n[n.rate_10000=1e4]="rate_10000",n))(Yp||{}),zT={[500]:10,[3e3]:60,[1e4]:200},QT={version:6,liquidity:ge,tickCurrent:0,feeGrowthGlobalX64A:ge,feeGrowthGlobalX64B:ge,protocolFeesTokenA:ge,protocolFeesTokenB:ge,swapInAmountTokenA:ge,swapOutAmountTokenB:ge,swapInAmountTokenB:ge,swapOutAmountTokenA:ge,tickArrayBitmap:[],rewardInfos:[],day:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},week:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},month:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},tvl:0},Zc={tvl:0,volumeQuote:0,mintAmountA:0,mintAmountB:0,rewardDefaultInfos:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,day:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},week:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},month:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},pooltype:[]},YT=new Gt("18446744073700000000");import pe from"bn.js";import pn from"decimal.js";function _r(a){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,a,!1),new Uint8Array(e)}function HT(a){let e=new ArrayBuffer(2);return new DataView(e).setInt16(0,a,!1),new Uint8Array(e)}function ZT(a){let e=new ArrayBuffer(4);return new DataView(e).setUint32(0,a,!1),new Uint8Array(e)}function Er(a){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,a,!1),new Uint8Array(e)}function Ka(a,e){let t=0;for(let n=a-1;n>=0&&!e.testn(n);n--)t++;return t}function Ca(a,e){let t=0;for(let n=0;n<a&&!e.testn(n);n++)t++;return t}function Ki(a,e){for(let t=0;t<a;t++)if(e.testn(t))return!1;return!0}function $c(a,e){return Ki(a,e)?null:Ka(a,e)}function Jc(a,e){return Ki(a,e)?null:Ca(a,e)}var jp=Buffer.from("amm_config","utf8"),Ra=Buffer.from("pool","utf8"),La=Buffer.from("pool_vault","utf8"),Hp=Buffer.from("pool_reward_vault","utf8"),el=Buffer.from("position","utf8"),Zp=Buffer.from("tick_array","utf8"),$p=Buffer.from("operation","utf8"),Jp=Buffer.from("pool_tick_array_bitmap_extension","utf8"),ef=Buffer.from("observation","utf8");function th(a,e){return ne([jp,_r(e)],a)}function tl(a,e,t,n){return ne([Ra,e.toBuffer(),t.toBuffer(),n.toBuffer()],a)}function Oa(a,e,t){return ne([La,e.toBuffer(),t.toBuffer()],a)}function nl(a,e,t){return ne([Hp,e.toBuffer(),t.toBuffer()],a)}function Ae(a,e,t){return ne([Zp,e.toBuffer(),Er(t)],a)}function sn(a,e,t,n){return ne([el,e.toBuffer(),Er(t),Er(n)],a)}function Bt(a,e){return ne([el,e.toBuffer()],a)}function xn(a){return ne([Buffer.from("metadata","utf8"),en.toBuffer(),a.toBuffer()],en)}function Ci(a){return ne([$p],a)}function je(a,e){return ne([Jp,e.toBuffer()],a)}function ol(a,e){return ne([ef,e.toBuffer()],a)}var il=Buffer.from("locked_position","utf8");function Na(a,e){return ne([il,e.toBuffer()],a)}function Mo(a,e){return ne([il,e.toBuffer()],a)}var tf=Buffer.from("support_mint","utf8");function Ma(a,e){return ne([tf,e.toBuffer()],a)}import{PublicKey as Ft}from"@solana/web3.js";import{TOKEN_2022_PROGRAM_ID as rl}from"@solana/spl-token";import Ee from"bn.js";import ke from"decimal.js";import dn from"bn.js";import va from"decimal.js";var Ri=class{static getfeeGrowthInside(e,t,n){let o=new dn(0),s=new dn(0);e.tickCurrent>=t.tick?(o=t.feeGrowthOutsideX64A,s=t.feeGrowthOutsideX64B):(o=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),s=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let i=new dn(0),r=new dn(0);e.tickCurrent<n.tick?(i=n.feeGrowthOutsideX64A,r=n.feeGrowthOutsideX64B):(i=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),r=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let c=ce.wrappingSubU128(ce.wrappingSubU128(e.feeGrowthGlobalX64A,o),i),u=ce.wrappingSubU128(ce.wrappingSubU128(e.feeGrowthGlobalX64B,s),r);return{feeGrowthInsideX64A:c,feeGrowthInsideBX64:u}}static GetPositionFees(e,t,n,o){let{feeGrowthInsideX64A:s,feeGrowthInsideBX64:i}=this.getfeeGrowthInside(e,n,o),r=ce.mulDivFloor(ce.wrappingSubU128(s,t.feeGrowthInsideLastX64A),t.liquidity,it),c=t.tokenFeesOwedA.add(r),u=ce.mulDivFloor(ce.wrappingSubU128(i,t.feeGrowthInsideLastX64B),t.liquidity,it),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,o){let{feeGrowthInsideX64A:s,feeGrowthInsideBX64:i}=this.getfeeGrowthInside(e,n,o),r=ce.mulDivFloor(ce.wrappingSubU128(s,t.feeGrowthInsideLastX64A),t.liquidity,it),c=t.tokenFeesOwedA.add(r),u=ce.mulDivFloor(ce.wrappingSubU128(i,t.feeGrowthInsideLastX64B),t.liquidity,it),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,o){let s=[],i=this.getRewardGrowthInsideV2(e.tickCurrent,n,o,e.rewardInfos);for(let r=0;r<i.length;r++){let c=i[r],u=t.rewardInfos[r],l=ce.wrappingSubU128(c,u.growthInsideLastX64),m=ce.mulDivFloor(l,t.liquidity,it),p=u.rewardAmountOwed.add(m);s.push(p)}return s}static GetPositionRewards(e,t,n,o){let s=[],i=this.getRewardGrowthInside(e.tickCurrent,n,o,e.rewardInfos);for(let r=0;r<i.length;r++){let c=i[r],u=t.rewardInfos[r],l=ce.wrappingSubU128(c,u.growthInsideLastX64),m=ce.mulDivFloor(l,t.liquidity,it),p=u.rewardAmountOwed.add(m);s.push(p)}return s}static getRewardGrowthInside(e,t,n,o){let s=[];for(let i=0;i<o.length;i++){let r=new dn(0);t.liquidityGross.eqn(0)?r=o[i].rewardGrowthGlobalX64:e<t.tick?r=o[i].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[i]):r=t.rewardGrowthsOutsideX64[i];let c=new dn(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[i]:c=o[i].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[i])),s.push(ce.wrappingSubU128(ce.wrappingSubU128(o[i].rewardGrowthGlobalX64,r),c))}return s}static getRewardGrowthInsideV2(e,t,n,o){let s=[];for(let i=0;i<o.length;i++){let r=new dn(0);t.liquidityGross.eqn(0)?r=o[i].rewardGrowthGlobalX64:e<t.tick?r=o[i].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[i]):r=t.rewardGrowthsOutsideX64[i];let c=new dn(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[i]:c=o[i].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[i])),s.push(ce.wrappingSubU128(ce.wrappingSubU128(o[i].rewardGrowthGlobalX64,r),c))}return s}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:o,add:s,epochInfo:i}){var b,g,A,h;let r=re.priceToSqrtPriceX64(new va(e.price),e.mintA.decimals,e.mintB.decimals),c=re.getSqrtPriceX64FromTick(t.tickLower),u=re.getSqrtPriceX64FromTick(t.tickUpper),l=s?1+o:1-o,m=Pe.getAmountsFromLiquidity(r,c,u,n,s),[p,d]=[Ie(m.amountA,(b=e.mintA.extensions)==null?void 0:b.feeConfig,i,!0),Ie(m.amountB,(g=e.mintB.extensions)==null?void 0:g.feeConfig,i,!0)],[f,y]=[Ie(new dn(new va(m.amountA.toString()).mul(l).toFixed(0)),(A=e.mintA.extensions)==null?void 0:A.feeConfig,i,!0),Ie(new dn(new va(m.amountB.toString()).mul(l).toFixed(0)),(h=e.mintB.extensions)==null?void 0:h.feeConfig,i,!0)];return{liquidity:n,amountA:p,amountB:d,amountSlippageA:f,amountSlippageB:y,expirationTime:tn(p.expirationTime,d.expirationTime)}}};var nf=15,Te=class{static async getTickArrays(e,t,n,o,s,i,r){let c=[],u=$.getTickArrayStartIndexByTick(o,s),l=$.getInitializedTickArrayInRange(i,r,s,u,Math.floor(nf/2));for(let d=0;d<l.length;d++){let{publicKey:f}=Ae(t,n,l[d]);c.push(f)}let m=(await Jt(e,c)).map(d=>d!==null?Li.decode(d.data):null),p={};for(let d=0;d<c.length;d++){let f=m[d];f!==null&&(p[f.startTickIndex]=q(v({},f),{address:c[d]}))}return p}static nextInitializedTick(e,t,n,o,s,i){let{initializedTick:r,tickArrayAddress:c,tickArrayStartTickIndex:u}=this.nextInitializedTickInOneArray(e,t,n,o,s,i);for(;r==null||r.liquidityGross.lten(0);){if(u=$.getNextTickArrayStartIndex(u,s,i),this.checkIsValidStartIndex(u,s))throw new Error("No enough initialized tickArray");let l=n[u];if(l===void 0)continue;let{nextTick:m,tickArrayAddress:p,tickArrayStartTickIndex:d}=this.firstInitializedTickInOneArray(e,t,l,i);[r,c,u]=[m,p,d]}if(r==null)throw new Error("No invaild tickArray cache");return{nextTick:r,tickArrayAddress:c,tickArrayStartTickIndex:u}}static nextInitializedTickArray(e,t,n,o,s){let i=Math.floor(e/Te.tickCount(t)),r=n?$.searchLowBitFromStart(o,s,i-1,1,t):$.searchHightBitFromStart(o,s,i+1,1,t);return r.length>0?{isExist:!0,nextStartIndex:r[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,o){let s;if(o){let r=rt-1;for(;r>=0;){let c=n.ticks[r];if(c.liquidityGross.gtn(0)){s=c;break}r=r-1}}else{let r=0;for(;r<rt;){let c=n.ticks[r];if(c.liquidityGross.gtn(0)){s=c;break}r=r+1}}let{publicKey:i}=Ae(e,t,n.startTickIndex);return{nextTick:s,tickArrayAddress:i,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,o,s,i){let r=$.getTickArrayStartIndexByTick(o,s),c=Math.floor((o-r)/s),u=n[r];if(u==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:r};let l;if(i)for(;c>=0;){let p=u.ticks[c];if(p.liquidityGross.gtn(0)){l=p;break}c=c-1}else for(c=c+1;c<rt;){let p=u.ticks[c];if(p.liquidityGross.gtn(0)){l=p;break}c=c+1}let{publicKey:m}=Ae(e,t,r);return{initializedTick:l,tickArrayAddress:m,tickArrayStartTickIndex:u.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if($.checkIsOutOfBoundary(e)){if(e>It)return!1;let n=$.getTickArrayStartIndexByTick(At,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return rt*e}};var Fa=14,Sn=class{static maxTickInTickarrayBitmap(e){return e*rt*io}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),o=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(o+=1);let s=n*o;return e<0?{minValue:-s,maxValue:-s+n}:{minValue:s,maxValue:s+n}}static nextInitializedTickArrayStartIndex(e,t,n,o){if(!Te.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let s=this.maxTickInTickarrayBitmap(n),i=o?t-Te.tickCount(n):t+Te.tickCount(n);if(i<-s||i>=s)return{isInit:!1,tickIndex:t};let r=n*rt,c=i/r+512;i<0&&i%r!=0&&c--;let u=Math.abs(c);if(o){let l=e.shln(1024-u-1),m=$c(1024,l);if(m!==null){let p=(u-m-512)*r;return{isInit:!0,tickIndex:p}}else return{isInit:!1,tickIndex:-s}}else{let l=e.shrn(u),m=Jc(1024,l);if(m!==null){let p=(u+m-512)*r;return{isInit:!0,tickIndex:p}}else return{isInit:!1,tickIndex:s-Te.tickCount(n)}}}},Oi=class{static getBitmapOffset(e,t){if(!Te.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=Sn.maxTickInTickarrayBitmap(t),o=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&o--,o}static getBitmap(e,t,n){let o=this.getBitmapOffset(e,t);return e<0?{offset:o,tickarrayBitmap:n.negativeTickArrayBitmap[o]}:{offset:o,tickarrayBitmap:n.positiveTickArrayBitmap[o]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:o}=this.extensionTickBoundary(t);if(e>=o&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=Sn.maxTickInTickarrayBitmap(e),n=-t;if(It<=t)throw Error(`extensionTickBoundary check error: ${It}, ${t}`);if(n<=At)throw Error(`extensionTickBoundary check error: ${n}, ${At}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:o}=this.getBitmap(e,t,n),s=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:$.mergeTickArrayBitmap(o).testn(s),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,o){let s=Te.tickCount(t),i=n?e-s:e+s,{tickarrayBitmap:r}=this.getBitmap(i,t,o);return this.nextInitializedTickArrayInBitmap(r,i,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,o){let{minValue:s,maxValue:i}=Sn.getBitmapTickBoundary(t,n),r=this.tickArrayOffsetInBitmap(t,n);if(o){let c=$.mergeTickArrayBitmap(e).shln(io-1-r),u=Ki(512,c)?null:Ka(512,c);if(u!==null){let l=t-u*Te.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s}}else{let c=$.mergeTickArrayBitmap(e).shrn(r),u=Ki(512,c)?null:Ca(512,c);if(u!==null){let l=t+u*Te.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:i-Te.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%Sn.maxTickInTickarrayBitmap(t),o=Math.floor(n/Te.tickCount(t));return e<0&&n!=0&&(o=io-o),o}};var Me=class{static getOutputAmountAndRemainAccounts(e,t,n,o,s,i=!1){let r=n.toBase58()===e.mintA.address,c=[],{isExist:u,startIndex:l,nextAccountMeta:m}=this.getFirstInitializedTickArray(e,r);if(!u||l===void 0||!m)throw new Error("Invalid tick array");c.push(m);let{allTrade:p,amountCalculated:d,accounts:f,sqrtPriceX64:y,feeAmount:b}=ro.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,r,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,o,l,s,i);return c.push(...f),{allTrade:p,expectedAmountOut:d.mul(Bn),remainingAccounts:c,executionPrice:y,feeAmount:b}}static getInputAmountAndRemainAccounts(e,t,n,o,s){let i=n.toBase58()===e.mintB.address,r=[],{isExist:c,startIndex:u,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,i);if(!c||u===void 0||!l)throw new Error("Invalid tick array");try{let y=this.preInitializedTickArrayStartIndex(e,i);if(y.isExist){let{publicKey:b}=Ae(e.programId,e.id,y.nextStartIndex);r.push(b)}}catch{}r.push(l);let{amountCalculated:m,accounts:p,sqrtPriceX64:d,feeAmount:f}=ro.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,i,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,o.mul(Bn),u,s);return r.push(...p),{expectedAmountIn:m,remainingAccounts:r,executionPrice:d,feeAmount:f}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:o}=Me.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?Oi.checkTickArrayIsInit(Te.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):$.checkTickArrayIsInitialized($.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:r}=Ae(e.programId,e.id,o);return{isExist:!0,startIndex:o,nextAccountMeta:r}}let{isExist:s,nextStartIndex:i}=this.nextInitializedTickArrayStartIndex(e,Te.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(s){let{publicKey:r}=Ae(e.programId,e.id,i);return{isExist:!0,startIndex:i,nextAccountMeta:r}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/Te.tickCount(e.tickSpacing)),o=t?$.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):$.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return o.length>0?{isExist:!0,nextStartIndex:o[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=Te.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:o,tickIndex:s}=Sn.nextInitializedTickArrayStartIndex($.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(o)return{isExist:!0,nextStartIndex:s};t=s;let{isInit:i,tickIndex:r}=Oi.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(i)return{isExist:!0,nextStartIndex:r};if(t=r,t<At||t>It)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:o,rewardInfos:s}){var r,c,u;let i=[];for(let l=0;l<s.length;l++){let m=s[l],p=(u=(r=t.rewardDefaultInfos[l])==null?void 0:r.mint.programId)!=null?u:(c=await e.getAccountInfo(m.tokenMint))==null?void 0:c.owner;if(p===void 0)throw Error("get new reward mint info error");let d=q(v({},m),{perSecond:ce.x64ToDecimal(m.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new Ft(p)});if(d.tokenMint.equals(Ft.default))continue;if(n<=d.openTime.toNumber()||o.eq(ge)){i.push(d);continue}let f=new Ee(Math.min(d.endTime.toNumber(),n)),y=f.sub(d.lastUpdateTime),b=ce.mulDivFloor(y,d.emissionsPerSecondX64,o),g=d.rewardGrowthGlobalX64.add(b),A=ce.mulDivFloor(y,d.emissionsPerSecondX64,it),h=d.rewardTotalEmissioned.add(A);i.push(q(v({},d),{rewardGrowthGlobalX64:g,rewardTotalEmissioned:h,lastUpdateTime:f}))}return i}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:o}=this.tickRange(e);for(let s of t){let i=$.getTickArrayStartIndexByTick(s,e);if(i>=n||i<o)return!0}return!1}static tickRange(e){let t=Sn.maxTickInTickarrayBitmap(e),n=-t;return t>It&&(t=Te.getArrayStartIndex(It,e)+Te.tickCount(e)),n<At&&(n=Te.getArrayStartIndex(At,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!Te.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/Te.tickCount(t)*io}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let o=await Ne(e,t.map(i=>({pubkey:i})),{batchRequest:n}),s={};for(let i of o)i.accountInfo!==null&&(s[i.pubkey.toString()]=al.decode(i.accountInfo.data));return s}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let o={},s=[];for(let c of t){let u=$.getTickArrayStartIndexByTick(c.tickCurrent,c.tickSpacing),l=$.getInitializedTickArrayInRange(c.tickArrayBitmap,c.exBitmapInfo,c.tickSpacing,u,7);for(let m of l){let{publicKey:p}=Ae(c.programId,c.id,m);s.push({pubkey:p}),o[p.toString()]=c.id}}let i=await Ne(e,s,{batchRequest:n}),r={};for(let c of i){if(!c.accountInfo)continue;let u=o[c.pubkey.toString()];if(!u)continue;r[u.toString()]===void 0&&(r[u.toString()]={});let l=Li.decode(c.accountInfo.data);r[u.toString()][l.startTickIndex]=q(v({},l),{address:c.pubkey})}return r}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:o=!1,updateOwnerRewardAndFee:s=!0}){var r;let i=[];for(let c=0;c<e.length;c++){let u=e[c];u!==null&&(i.find(l=>l.equals(u.state.programId))||i.push(u.state.programId))}if(n){let c=n.tokenAccounts.map(p=>p.accountInfo.mint),u=[];for(let p of c)for(let d of i)u.push(Bt(d,p).publicKey);let l=await Jt(t,u,{batchRequest:o}),m={};for(let p of l){if(p===null)continue;let d=vo.decode(p.data),f=d.poolId.toString(),y=e.find(x=>x.state.id.toBase58()===f);if(y===void 0)continue;let b=y.state,g=$._getTickPriceLegacy({poolInfo:b,tick:d.tickLower,baseIn:!0}),A=$._getTickPriceLegacy({poolInfo:b,tick:d.tickUpper,baseIn:!0}),{amountA:h,amountB:I}=Pe.getAmountsFromLiquidity(b.sqrtPriceX64,g.tickSqrtPriceX64,A.tickSqrtPriceX64,d.liquidity,!1),T=1/(1-Math.sqrt(Math.sqrt(g.price.div(A.price).toNumber())));y.positionAccount=[...(r=y.positionAccount)!=null?r:[],{poolId:d.poolId,nftMint:d.nftMint,priceLower:g.price,priceUpper:A.price,amountA:h,amountB:I,tickLower:d.tickLower,tickUpper:d.tickUpper,liquidity:d.liquidity,feeGrowthInsideLastX64A:d.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:d.feeGrowthInsideLastX64B,tokenFeesOwedA:d.tokenFeesOwedA,tokenFeesOwedB:d.tokenFeesOwedB,rewardInfos:d.rewardInfos.map(x=>q(v({},x),{pendingReward:new Ee(0)})),leverage:T,tokenFeeAmountA:new Ee(0),tokenFeeAmountB:new Ee(0)}];let w=await $.getTickArrayAddressByTick(y.state.programId,d.poolId,d.tickLower,y.state.tickSpacing),S=await $.getTickArrayAddressByTick(y.state.programId,d.poolId,d.tickUpper,y.state.tickSpacing);m[`${y.state.programId.toString()}-${d.poolId.toString()}-${d.tickLower}`]=w,m[`${y.state.programId.toString()}-${d.poolId.toString()}-${d.tickUpper}`]=S}if(s){let p=Object.values(m),d=await Jt(t,p,{batchRequest:o}),f={};for(let y=0;y<p.length;y++){let b=d[y];if(b===null)continue;let g=p[y].toString();f[g]=Li.decode(b.data)}for(let{state:y,positionAccount:b}of e)if(!!b)for(let g of b){let A=`${y.programId.toString()}-${y.id.toString()}-${g.tickLower}`,h=`${y.programId.toString()}-${y.id.toString()}-${g.tickUpper}`,I=f[m[A].toString()],T=f[m[h].toString()],w=I.ticks[$.getTickOffsetInArray(g.tickLower,y.tickSpacing)],S=T.ticks[$.getTickOffsetInArray(g.tickUpper,y.tickSpacing)],{tokenFeeAmountA:x,tokenFeeAmountB:K}=await Ri.GetPositionFees(y,g,w,S),B=await Ri.GetPositionRewards(y,g,w,S);g.tokenFeeAmountA=x.gte(new Ee(0))?x:new Ee(0),g.tokenFeeAmountB=K.gte(new Ee(0))?K:new Ee(0);for(let C=0;C<B.length;C++)g.rewardInfos[C].pendingReward=B[C].gte(new Ee(0))?B[C]:new Ee(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:o,amountIn:s,slippage:i,priceLimit:r=new ke(0),catchLiquidityInsufficient:c=!1}){var L;let u,l=n.toBase58()===e.mintA.address,[m,p]=l?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];r.equals(new ke(0))?u=l?Xt.add(new Ee(1)):zt.sub(new Ee(1)):u=re.priceToSqrtPriceX64(r,e.mintA.decimals,e.mintB.decimals);let d=Ie(s,m,o,!1),{allTrade:f,expectedAmountOut:y,remainingAccounts:b,executionPrice:g,feeAmount:A}=Me.getOutputAmountAndRemainAccounts(e,t,n,d.amount.sub((L=d.fee)!=null?L:ge),u,c),h=Ie(y,p,o,!1),I=re.sqrtPriceX64ToPrice(g,e.mintA.decimals,e.mintB.decimals),T=l?I:new ke(1).div(I),w=y.mul(new Ee(Math.floor((1-i)*1e10))).div(new Ee(1e10)),S=Ie(w,p,o,!1),x=l?e.currentPrice:new ke(1).div(e.currentPrice),K=new ke(T).sub(x).abs(),B=x,C=new ze(new ke(K).mul(10**15).toFixed(0),new ke(B).mul(10**15).toFixed(0));return{allTrade:f,realAmountIn:d,amountOut:h,minAmountOut:S,expirationTime:tn(d.expirationTime,h.expirationTime),currentPrice:e.currentPrice,executionPrice:T,priceImpact:C,fee:A,remainingAccounts:b,executionPriceX64:g}}static computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:o,slippage:s,epochInfo:i,catchLiquidityInsufficient:r=!1}){let c=o.address===e.mintB.address,[u,l]=c?[e.mintA,e.mintB]:[e.mintB,e.mintA],[m,p]=[new Se(q(v({},u),{mint:u.address,isToken2022:u.programId===rl.toBase58()})),new Se(q(v({},l),{mint:l.address,isToken2022:l.programId===rl.toBase58()}))],{allTrade:d,realAmountIn:f,amountOut:y,minAmountOut:b,expirationTime:g,currentPrice:A,executionPrice:h,priceImpact:I,fee:T,remainingAccounts:w,executionPriceX64:S}=Me.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new Ft(u.address),amountIn:n,slippage:s,epochInfo:i,catchLiquidityInsufficient:r}),x=q(v({},f),{amount:new he(m,f.amount),fee:f.fee===void 0?void 0:new he(m,f.fee)}),K=q(v({},y),{amount:new he(p,y.amount),fee:y.fee===void 0?void 0:new he(p,y.fee)}),B=q(v({},b),{amount:new he(p,b.amount),fee:b.fee===void 0?void 0:new he(p,b.fee)}),C=new lt({baseToken:m,denominator:new Ee(10).pow(new Ee(20+m.decimals)),quoteToken:p,numerator:A.mul(new ke(10**(20+p.decimals))).toFixed(0)}),L=new lt({baseToken:m,denominator:new Ee(10).pow(new Ee(20+m.decimals)),quoteToken:p,numerator:h.mul(new ke(10**(20+p.decimals))).toFixed(0)}),M=new he(m,T);return{allTrade:d,realAmountIn:x,amountOut:K,minAmountOut:B,expirationTime:g,currentPrice:C,executionPrice:L,priceImpact:I,fee:M,remainingAccounts:w,executionPriceX64:S}}static computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:o,amountOut:s,slippage:i,priceLimit:r=new ke(0)}){var B;let c=n.toBase58()===e.mintA.address,u={[e.mintA.address]:e.mintA.extensions.feeConfig,[e.mintB.address]:e.mintB.extensions.feeConfig},l;r.equals(new ke(0))?l=c?zt.sub(new Ee(1)):Xt.add(new Ee(1)):l=re.priceToSqrtPriceX64(r,e.mintA.decimals,e.mintB.decimals);let m=Ie(s,u[n.toString()],o,!0),{expectedAmountIn:p,remainingAccounts:d,executionPrice:f,feeAmount:y}=Me.getInputAmountAndRemainAccounts(e,t,n,m.amount.sub((B=m.fee)!=null?B:ge),l),b=c?e.mintB.address:e.mintA.address,g=Ie(p,u[b],o,!1),A=re.sqrtPriceX64ToPrice(f,e.mintA.decimals,e.mintB.decimals),h=c?A:new ke(1).div(A),I=p.mul(new Ee(Math.floor((1+i)*1e10))).div(new Ee(1e10)),T=Ie(I,u[b],o,!0),w=c?e.currentPrice:new ke(1).div(e.currentPrice),S=new ke(h).sub(w).abs(),x=w,K=new ze(new ke(S).mul(10**15).toFixed(0),new ke(x).mul(10**15).toFixed(0));return{amountIn:g,maxAmountIn:T,realAmountOut:m,expirationTime:tn(g.expirationTime,m.expirationTime),currentPrice:e.currentPrice,executionPrice:h,priceImpact:K,fee:y,remainingAccounts:d}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:o}){var f,y,b;let s=e[t],i=$.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),r=$.getTickPrice({poolInfo:e,tick:o,baseIn:!0}).price.toNumber(),c=Math.max(i,s.priceMin),l=Math.min(r,s.priceMax)-c,m=r-i,p=s.priceMax-s.priceMin,d;return l<=0?d=0:m===l?d=p/l:p===l?d=l/m:d=l/p*(l/m),{feeApr:s.feeApr*d,rewardsApr:[((f=s.rewardApr[0])!=null?f:0)*d,((y=s.rewardApr[1])!=null?y:0)*d,((b=s.rewardApr[2])!=null?b:0)*d],apr:s.apr*d}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:o,liquidity:s,positionTickLowerIndex:i,positionTickUpperIndex:r,chainTime:c}){let u=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],m=o[bt(e.mintA.address).toString()],p=o[bt(e.mintB.address).toString()],d=e.mintA.decimals,f=e.mintB.decimals;if(!l||!m||!p)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let y=re.priceToSqrtPriceX64(new ke(e.price),e.mintA.decimals,e.mintB.decimals),b=re.getSqrtPriceX64FromTick(i),g=re.getSqrtPriceX64FromTick(r),{amountSlippageA:A,amountSlippageB:h}=Pe.getAmountsFromLiquidityWithSlippage(y,b,g,t,!1,!1,0),{amountSlippageA:I,amountSlippageB:T}=Pe.getAmountsFromLiquidityWithSlippage(y,b,g,s,!1,!1,0),w=new ke(A.toString()).div(new ke(10).pow(d)).mul(m.value).add(new ke(h.toString()).div(new ke(10).pow(f)).mul(p.value)),S=new ke(I.toString()).div(new ke(10).pow(d)).mul(m.value).add(new ke(T.toString()).div(new ke(10).pow(f)).mul(p.value)),x=new ke(1).div(w.add(S)),B=new ke(l.volumeFee).mul(365).div(u).mul(x).mul(100).toNumber(),C=3600*24*365,L=e.rewardDefaultInfos.map(M=>{var _,X;let R=M.mint.decimals,O=o[M.mint.address];return c<((_=M.startTime)!=null?_:0)||c>((X=M.endTime)!=null?X:0)||!M.perSecond||!O||R===void 0?0:new ke(O.value).mul(new ke(M.perSecond).mul(C)).div(new ke(10).pow(R)).mul(x).mul(100).toNumber()});return{feeApr:B,rewardsApr:L,apr:B+L.reduce((M,R)=>M+R,0)}}static async getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:o,amount:s,slippage:i,add:r,epochInfo:c,amountHasFee:u}){var g,A;let l=re.priceToSqrtPriceX64(new ke(e.price),e.mintA.decimals,e.mintB.decimals),m=re.getSqrtPriceX64FromTick(n),p=re.getSqrtPriceX64FromTick(o),d=Ie(s,(g=e[t?"mintA":"mintB"].extensions)==null?void 0:g.feeConfig,c,!u),f=new Ee(new ke(d.amount.sub((A=d.fee)!=null?A:ge).toString()).toFixed(0)),y;if(l.lte(m))y=t?Pe.getLiquidityFromTokenAmountA(m,p,f,!r):new Ee(0);else if(l.lte(p)){let h=Pe.getLiquidityFromTokenAmountA(l,p,f,!r),I=Pe.getLiquidityFromTokenAmountB(m,l,f);y=t?h:I}else y=t?new Ee(0):Pe.getLiquidityFromTokenAmountB(m,p,f);let b=await Me.getAmountsFromLiquidity({epochInfo:c,poolInfo:e,tickLower:n,tickUpper:o,liquidity:y,slippage:i,add:r});return{liquidity:y,amountA:t?d:b.amountA,amountB:t?b.amountB:d,amountSlippageA:t?d:b.amountSlippageA,amountSlippageB:t?b.amountSlippageB:d,expirationTime:b.expirationTime}}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:o,liquidity:s,slippage:i,add:r}){var b,g,A,h;let c=re.getSqrtPriceX64FromTick(n),u=re.getSqrtPriceX64FromTick(o),l=r?1+i:1-i,m=Pe.getAmountsFromLiquidity(re.priceToSqrtPriceX64(new ke(t.price),t.mintA.decimals,t.mintB.decimals),c,u,s,r),[p,d]=[Ie(m.amountA,(b=t.mintA.extensions)==null?void 0:b.feeConfig,e,!0),Ie(m.amountB,(g=t.mintB.extensions)==null?void 0:g.feeConfig,e,!0)],[f,y]=[Ie(m.amountA.muln(l),(A=t.mintA.extensions)==null?void 0:A.feeConfig,e,!0),Ie(m.amountB.muln(l),(h=t.mintB.extensions)==null?void 0:h.feeConfig,e,!0)];return{liquidity:s,amountA:p,amountB:d,amountSlippageA:f,amountSlippageB:y,expirationTime:tn(p.expirationTime,d.expirationTime)}}static async fetchComputeMultipleClmmInfo({connection:e,poolList:t,rpcDataMap:n={}}){let o=t.filter(c=>!n[c.id]).map(c=>new Ft(c.id));(await Jt(e,o)).forEach((c,u)=>{!c||(n[o[u].toBase58()]=so.decode(c.data))});let i=t.map(c=>je(new Ft(c.programId),new Ft(c.id)).publicKey),r=await Me.fetchExBitmaps({connection:e,exBitmapAddress:i,batchRequest:!1});return t.reduce((c,u)=>q(v({},c),{[u.id]:q(v({},n[u.id]),{id:new Ft(u.id),version:6,programId:new Ft(u.programId),mintA:u.mintA,mintB:u.mintB,ammConfig:q(v({},u.config),{id:new Ft(u.config.id),fundOwner:""}),currentPrice:new ke(u.price),exBitmapAccount:je(new Ft(u.programId),new Ft(u.id)).publicKey,exBitmapInfo:r[je(new Ft(u.programId),new Ft(u.id)).publicKey.toBase58()],startTime:n[u.id].startTime.toNumber(),rewardInfos:n[u.id].rewardInfos})}),{})}static async fetchComputeClmmInfo({connection:e,poolInfo:t,rpcData:n}){return(await this.fetchComputeMultipleClmmInfo({connection:e,rpcDataMap:n?{[t.id]:n}:void 0,poolList:[t]}))[t.id]}};function Dh({poolInfo:a,tickLower:e,tickUpper:t,amountA:n,amountB:o,slippage:s,add:i,epochInfo:r,amountHasFee:c}){var h,I,T,w;let[u,l,m,p]=e<t?[e,t,n,o]:[t,e,o,n],d=re.priceToSqrtPriceX64(new ke(a.price),a.mintA.decimals,a.mintB.decimals),f=re.getSqrtPriceX64FromTick(u),y=re.getSqrtPriceX64FromTick(l),[b,g]=[Ie(m,(h=a.mintA.extensions)==null?void 0:h.feeConfig,r,!c),Ie(p,(I=a.mintB.extensions)==null?void 0:I.feeConfig,r,!c)],A=Pe.getLiquidityFromTokenAmounts(d,f,y,b.amount.sub((T=b.fee)!=null?T:ge),g.amount.sub((w=g.fee)!=null?w:ge));return Pe.getAmountsOutFromLiquidity({poolInfo:a,tickLower:e,tickUpper:t,liquidity:A,slippage:s,add:i,epochInfo:r,amountAddFee:!c})}var Va={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};function sl(a){return q(v({},a),{type:"Concentrated",programId:a.programId.toString(),id:a.id.toString(),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Clmm",price:a.currentPrice.toNumber(),mintAmountA:0,mintAmountB:0,feeRate:a.ammConfig.tradeFeeRate,openTime:a.startTime.toString(),tvl:0,day:Va,week:Va,month:Va,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,burnPercent:0,config:q(v({},a.ammConfig),{id:a.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]})})}var ce=class{static mulDivRoundingUp(e,t,n){let o=e.mul(t),s=o.div(n);return o.mod(n).eq(ge)||(s=s.add(vt)),s}static mulDivFloor(e,t,n){if(n.eq(ge))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(ge))throw new Error("division by 0");return e.mul(t).add(n.sub(vt)).div(n)}static x64ToDecimal(e,t){return new pn(e.toString()).div(pn.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new pe(e.mul(pn.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(Mr).sub(t).mod(Mr)}};function pt(a,e){return _a(a.mul(e),64,256)}function of(a,e,t){let n=a.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function _a(a,e,t){let n=a.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var re=class{static sqrtPriceX64ToPrice(e,t,n){return ce.x64ToDecimal(e).pow(2).mul(pn.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return ce.decimalToX64(e.mul(pn.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,o){if(!e.gt(ge))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(ge))throw new Error("liquidity must greater than 0");return o?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,o){if(!e.gt(ge))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(ge))throw new Error("liquidity must greater than 0");return o?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,o){if(n.eq(ge))return e;let s=t.shln(Si);if(o){let i=s,r=s.add(n.mul(e));return r.gte(i)?ce.mulDivCeil(i,e,r):ce.mulDivRoundingUp(i,vt,i.div(e).add(n))}else{let i=n.mul(e);if(!s.gt(i))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let r=s.sub(i);return ce.mulDivCeil(s,e,r)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,o){let s=n.shln(Si);if(o)return e.add(s.div(t));{let i=ce.mulDivRoundingUp(s,vt,t);if(!e.gt(i))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(i)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<At||e>It)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new pe("18445821805675395072"):new pe("18446744073709551616");return(t&2)!=0&&(n=pt(n,new pe("18444899583751176192"))),(t&4)!=0&&(n=pt(n,new pe("18443055278223355904"))),(t&8)!=0&&(n=pt(n,new pe("18439367220385607680"))),(t&16)!=0&&(n=pt(n,new pe("18431993317065453568"))),(t&32)!=0&&(n=pt(n,new pe("18417254355718170624"))),(t&64)!=0&&(n=pt(n,new pe("18387811781193609216"))),(t&128)!=0&&(n=pt(n,new pe("18329067761203558400"))),(t&256)!=0&&(n=pt(n,new pe("18212142134806163456"))),(t&512)!=0&&(n=pt(n,new pe("17980523815641700352"))),(t&1024)!=0&&(n=pt(n,new pe("17526086738831433728"))),(t&2048)!=0&&(n=pt(n,new pe("16651378430235570176"))),(t&4096)!=0&&(n=pt(n,new pe("15030750278694412288"))),(t&8192)!=0&&(n=pt(n,new pe("12247334978884435968"))),(t&16384)!=0&&(n=pt(n,new pe("8131365268886854656"))),(t&32768)!=0&&(n=pt(n,new pe("3584323654725218816"))),(t&65536)!=0&&(n=pt(n,new pe("696457651848324352"))),(t&131072)!=0&&(n=pt(n,new pe("26294789957507116"))),(t&262144)!=0&&(n=pt(n,new pe("37481735321082"))),e>0&&(n=zc.div(n)),n}static getTickFromPrice(e,t,n){return re.getTickFromSqrtPriceX64(re.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(zt)||e.lt(Xt))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new pe(t-64),o=of(n,32,128),s=new pe("8000000000000000","hex"),i=0,r=new pe(0),c=t>=64?e.shrn(t-63):e.shln(63-t);for(;s.gt(new pe(0))&&i<Qc;){c=c.mul(c);let f=c.shrn(127);c=c.shrn(63+f.toNumber()),r=r.add(s.mul(f)),s=s.shrn(1),i+=1}let u=r.shrn(32),m=o.add(u).mul(new pe(Yc)),p=_a(m.sub(new pe(jc)),64,128).toNumber(),d=_a(m.add(new pe(Hc)),64,128).toNumber();return p==d?p:re.getSqrtPriceX64FromTick(d).lte(e)?d:p}},ao=class{static getTickWithPriceAndTickspacing(e,t,n,o){let i=re.getTickFromSqrtPriceX64(re.priceToSqrtPriceX64(e,n,o))/t;return i<0?i=Math.floor(i):i=Math.ceil(i),i*t}static roundPriceWithTickspacing(e,t,n,o){let s=ao.getTickWithPriceAndTickspacing(e,t,n,o),i=re.getSqrtPriceX64FromTick(s);return re.sqrtPriceX64ToPrice(i,n,o)}},Pe=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,o){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(ge))throw new Error("sqrtPriceX64A must greater than 0");let s=n.ushln(Si),i=t.sub(e);return o?ce.mulDivRoundingUp(ce.mulDivCeil(s,i,t),vt,e):ce.mulDivFloor(s,i,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,o){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(ge))throw new Error("sqrtPriceX64A must greater than 0");return o?ce.mulDivCeil(n,t.sub(e),it):ce.mulDivFloor(n,t.sub(e),it)}static getLiquidityFromTokenAmountA(e,t,n,o){e.gt(t)&&([e,t]=[t,e]);let s=n.mul(e).mul(t),i=t.sub(e),r=s.div(i);return o?ce.mulDivRoundingUp(r,vt,xi):r.shrn(Si)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),ce.mulDivFloor(n,xi,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,o,s){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return Pe.getLiquidityFromTokenAmountA(t,n,o,!1);if(e.lt(n)){let i=Pe.getLiquidityFromTokenAmountA(e,n,o,!1),r=Pe.getLiquidityFromTokenAmountB(t,e,s);return i.lt(r)?i:r}else return Pe.getLiquidityFromTokenAmountB(t,n,s)}static getAmountsFromLiquidity(e,t,n,o,s){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:Pe.getTokenAmountAFromLiquidity(t,n,o,s),amountB:new pe(0)};if(e.lt(n)){let i=Pe.getTokenAmountAFromLiquidity(e,n,o,s),r=Pe.getTokenAmountBFromLiquidity(t,e,o,s);return{amountA:i,amountB:r}}else return{amountA:new pe(0),amountB:Pe.getTokenAmountBFromLiquidity(t,n,o,s)}}static getAmountsFromLiquidityWithSlippage(e,t,n,o,s,i,r){let{amountA:c,amountB:u}=Pe.getAmountsFromLiquidity(e,t,n,o,i),l=s?1+r:1-r,m=new pe(new pn(c.toString()).mul(l).toFixed(0)),p=new pe(new pn(u.toString()).mul(l).toFixed(0));return{amountSlippageA:m,amountSlippageB:p}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:o,slippage:s,add:i,epochInfo:r,amountAddFee:c}){var A,h,I,T;let u=re.priceToSqrtPriceX64(new pn(e.price),e.mintA.decimals,e.mintB.decimals),l=re.getSqrtPriceX64FromTick(t),m=re.getSqrtPriceX64FromTick(n),p=i?1+s:1-s,d=Pe.getAmountsFromLiquidity(u,l,m,o,i),[f,y]=[Ie(d.amountA,(A=e.mintA.extensions)==null?void 0:A.feeConfig,r,c),Ie(d.amountB,(h=e.mintB.extensions)==null?void 0:h.feeConfig,r,c)],[b,g]=[Ie(new pe(new pn(d.amountA.toString()).mul(p).toFixed(0)),(I=e.mintA.extensions)==null?void 0:I.feeConfig,r,c),Ie(new pe(new pn(d.amountB.toString()).mul(p).toFixed(0)),(T=e.mintB.extensions)==null?void 0:T.feeConfig,r,c)];return{liquidity:o,amountA:f,amountB:y,amountSlippageA:b,amountSlippageB:g,expirationTime:tn(f.expirationTime,y.expirationTime)}}},ro=class{static swapCompute(e,t,n,o,s,i,r,c,u,l,m,p,d,f,y=!1){if(p.eq(ge))throw new Error("amountSpecified must not be 0");if(f||(f=i?Xt.add(vt):zt.sub(vt)),i){if(f.lt(Xt))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(f.gte(m))throw new Error("sqrtPriceX64 must smaller than current")}else{if(f.gt(zt))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(f.lte(m))throw new Error("sqrtPriceX64 must greater than current")}let b=p.gt(ge),g={amountSpecifiedRemaining:p,amountCalculated:ge,sqrtPriceX64:m,tick:u>d?Math.min(d+Te.tickCount(l)-1,u):d,accounts:[],liquidity:c,feeAmount:new pe(0)},A=d,h=n[d],I=0,T=!i&&h.startTickIndex===g.tick;for(;!g.amountSpecifiedRemaining.eq(ge)&&!g.sqrtPriceX64.eq(f);){I>10;let w={};w.sqrtPriceStartX64=g.sqrtPriceX64;let S=$.nextInitTick(h,g.tick,l,i,T),x=S||null,K=null;if(!(x!=null&&x.liquidityGross.gtn(0))){let C=Me.nextInitializedTickArrayStartIndex({tickCurrent:g.tick,tickSpacing:l,tickArrayBitmap:o,exBitmapInfo:s},A,i);if(!C.isExist){if(y)return{allTrade:!1,amountSpecifiedRemaining:g.amountSpecifiedRemaining,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts};throw Error("swapCompute LiquidityInsufficient")}A=C.nextStartIndex;let{publicKey:L}=Ae(e,t,A);K=L,h=n[A];try{x=$.firstInitializedTick(h,i)}catch{throw Error("not found next tick info")}}w.tickNext=x.tick,w.initialized=x.liquidityGross.gtn(0),d!==A&&K&&(g.accounts.push(K),d=A),w.tickNext<At?w.tickNext=At:w.tickNext>It&&(w.tickNext=It),w.sqrtPriceNextX64=re.getSqrtPriceX64FromTick(w.tickNext);let B;if(i&&w.sqrtPriceNextX64.lt(f)||!i&&w.sqrtPriceNextX64.gt(f)?B=f:B=w.sqrtPriceNextX64,[g.sqrtPriceX64,w.amountIn,w.amountOut,w.feeAmount]=ro.swapStepCompute(g.sqrtPriceX64,B,g.liquidity,g.amountSpecifiedRemaining,r,i),g.feeAmount=g.feeAmount.add(w.feeAmount),b?(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.sub(w.amountIn.add(w.feeAmount)),g.amountCalculated=g.amountCalculated.sub(w.amountOut)):(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.add(w.amountOut),g.amountCalculated=g.amountCalculated.add(w.amountIn.add(w.feeAmount))),g.sqrtPriceX64.eq(w.sqrtPriceNextX64)){if(w.initialized){let C=x.liquidityNet;i&&(C=C.mul(Bn)),g.liquidity=Pe.addDelta(g.liquidity,C)}T=w.tickNext!=g.tick&&!i&&h.startTickIndex===w.tickNext,g.tick=i?w.tickNext-1:w.tickNext}else if(g.sqrtPriceX64!=w.sqrtPriceStartX64){let C=re.getTickFromSqrtPriceX64(g.sqrtPriceX64);T=C!=g.tick&&!i&&h.startTickIndex===C,g.tick=C}++I}try{let{nextStartIndex:w,isExist:S}=Te.nextInitializedTickArray(g.tick,l,i,o,s);S&&d!==w&&(g.accounts.push(Ae(e,t,w).publicKey),d=w)}catch{}return{allTrade:!0,amountSpecifiedRemaining:ge,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts}}static swapStepCompute(e,t,n,o,s,i){let r={sqrtPriceX64Next:new pe(0),amountIn:new pe(0),amountOut:new pe(0),feeAmount:new pe(0)},c=o.gte(ge);if(c){let l=ce.mulDivFloor(o,Vr.sub(new pe(s.toString())),Vr);r.amountIn=i?Pe.getTokenAmountAFromLiquidity(t,e,n,!0):Pe.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(r.amountIn)?r.sqrtPriceX64Next=t:r.sqrtPriceX64Next=re.getNextSqrtPriceX64FromInput(e,n,l,i)}else r.amountOut=i?Pe.getTokenAmountBFromLiquidity(t,e,n,!1):Pe.getTokenAmountAFromLiquidity(e,t,n,!1),o.mul(Bn).gte(r.amountOut)?r.sqrtPriceX64Next=t:r.sqrtPriceX64Next=re.getNextSqrtPriceX64FromOutput(e,n,o.mul(Bn),i);let u=t.eq(r.sqrtPriceX64Next);return i?(u&&c||(r.amountIn=Pe.getTokenAmountAFromLiquidity(r.sqrtPriceX64Next,e,n,!0)),u&&!c||(r.amountOut=Pe.getTokenAmountBFromLiquidity(r.sqrtPriceX64Next,e,n,!1))):(r.amountIn=u&&c?r.amountIn:Pe.getTokenAmountBFromLiquidity(e,r.sqrtPriceX64Next,n,!0),r.amountOut=u&&!c?r.amountOut:Pe.getTokenAmountAFromLiquidity(e,r.sqrtPriceX64Next,n,!1)),!c&&r.amountOut.gt(o.mul(Bn))&&(r.amountOut=o.mul(Bn)),c&&!r.sqrtPriceX64Next.eq(t)?r.feeAmount=o.sub(r.amountIn):r.feeAmount=ce.mulDivCeil(r.amountIn,new pe(s),Vr.sub(new pe(s))),[r.sqrtPriceX64Next,r.amountIn,r.amountOut,r.feeAmount]}};var rt=60,io=512,$=class{static getTickArrayAddressByTick(e,t,n,o){let s=$.getTickArrayStartIndexByTick(n,o),{publicKey:i}=Ae(e,t,s);return i}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=$.getTickArrayStartIndexByTick(e,t),o=Math.floor((e-n)/t);if(o<0||o>=rt)throw new Error("tick offset in array overflow");return o}static getTickArrayBitIndex(e,t){let n=Te.tickCount(t),o=e/n;return e<0&&e%n!=0?o=Math.ceil(o)-1:o=Math.floor(o),o}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*Te.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*rt,o=Math.floor(e/n)+512;return Math.abs(o)}static checkTickArrayIsInitialized(e,t,n){let o=n*rt,s=Math.floor(t/o)+512,i=Math.abs(s);return{isInitialized:e.testn(i),startIndex:(i-512)*o}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*rt:e+t*rt}static mergeTickArrayBitmap(e){let t=new rf(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,o,s){let i=Math.floor(o/(n*rt));return[...$.searchLowBitFromStart(e,t,i-1,s,n),...$.searchHightBitFromStart(e,t,i,s,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return $.searchHightBitFromStart(e,t,-7680,io,n)}static getAllInitializedTickArrayInfo(e,t,n,o,s){let i=[],r=$.getAllInitializedTickArrayStartIndex(n,o,s);for(let c of r){let{publicKey:u}=Ae(e,t,c);i.push({tickArrayStartIndex:c,tickArrayAddress:u})}return i}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,o,s){let i=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>$.mergeTickArrayBitmap(u)),r=[];for(;n>=-7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(i[u].testn(l)&&r.push(n),n--,r.length===o)break}let c=Te.tickCount(s);return r.map(u=>u*c)}static searchHightBitFromStart(e,t,n,o,s){let i=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>$.mergeTickArrayBitmap(u)),r=[];for(;n<7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(i[u].testn(l)&&r.push(n),n++,r.length===o)break}let c=Te.tickCount(s);return r.map(u=>u*c)}static checkIsOutOfBoundary(e){return e<At||e>It}static nextInitTick(e,t,n,o,s){if(Te.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let r=Math.floor((t-e.startTickIndex)/n);if(o)for(;r>=0;){if(e.ticks[r].liquidityGross.gtn(0))return e.ticks[r];r=r-1}else for(s||(r=r+1);r<rt;){if(e.ticks[r].liquidityGross.gtn(0))return e.ticks[r];r=r+1}return null}static firstInitializedTick(e,t){if(t){let n=rt-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<rt;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let o=re.getSqrtPriceX64FromTick(t),s=re.sqrtPriceX64ToPrice(o,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:s,tickSqrtPriceX64:o}:{tick:t,price:new Fo(1).div(s),tickSqrtPriceX64:o}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let o=n?t:new Fo(1).div(t),s=ao.getTickWithPriceAndTickspacing(o,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),i=re.getSqrtPriceX64FromTick(s),r=re.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:s,price:r}:{tick:s,price:new Fo(1).div(r)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let o=re.getSqrtPriceX64FromTick(t),s=re.sqrtPriceX64ToPrice(o,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:s,tickSqrtPriceX64:o}:{tick:t,price:new Fo(1).div(s),tickSqrtPriceX64:o}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let o=n?t:new Fo(1).div(t),s=ao.getTickWithPriceAndTickspacing(o,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),i=re.getSqrtPriceX64FromTick(s),r=re.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:s,price:r}:{tick:s,price:new Fo(1).div(r)}}};var ul=F([Be(8),W("bump"),Mt("index"),N(""),ft("protocolFeeRate"),ft("tradeFeeRate"),Mt("tickSpacing"),Q(k(),8,"")]),sf=F([ft("blockTimestamp"),Co("tickCumulative"),Q(k(),4)]),cl=F([Be(8),qe("initialized"),k("recentEpoch"),Mt("observationIndex"),N("poolId"),Q(sf,100,"observations"),Q(k(),4)]),af=F([W("rewardState"),k("openTime"),k("endTime"),k("lastUpdateTime"),ee("emissionsPerSecondX64"),k("rewardTotalEmissioned"),k("rewardClaimed"),N("tokenMint"),N("tokenVault"),N("creator"),ee("rewardGrowthGlobalX64")]),so=F([Be(8),W("bump"),N("ammConfig"),N("creator"),N("mintA"),N("mintB"),N("vaultA"),N("vaultB"),N("observationId"),W("mintDecimalsA"),W("mintDecimalsB"),Mt("tickSpacing"),ee("liquidity"),ee("sqrtPriceX64"),_e("tickCurrent"),ft(),ee("feeGrowthGlobalX64A"),ee("feeGrowthGlobalX64B"),k("protocolFeesTokenA"),k("protocolFeesTokenB"),ee("swapInAmountTokenA"),ee("swapOutAmountTokenB"),ee("swapInAmountTokenB"),ee("swapOutAmountTokenA"),W("status"),Q(W(),7,""),Q(af,3,"rewardInfos"),Q(k(),16,"tickArrayBitmap"),k("totalFeesTokenA"),k("totalFeesClaimedTokenA"),k("totalFeesTokenB"),k("totalFeesClaimedTokenB"),k("fundFeesTokenA"),k("fundFeesTokenB"),k("startTime"),Q(k(),15*4-3,"padding")]),uf=F([ee("growthInsideLastX64"),k("rewardAmountOwed")]),vo=F([Be(8),W("bump"),N("nftMint"),N("poolId"),_e("tickLower"),_e("tickUpper"),ee("liquidity"),ee("feeGrowthInsideLastX64A"),ee("feeGrowthInsideLastX64B"),k("tokenFeesOwedA"),k("tokenFeesOwedB"),Q(uf,3,"rewardInfos"),Q(k(),8,"")]),lI=F([Be(8),W("bump"),N("poolId"),_e("tickLowerIndex"),_e("tickUpperIndex"),ee("liquidity"),ee("feeGrowthInsideLastX64A"),ee("feeGrowthInsideLastX64B"),k("tokenFeesOwedA"),k("tokenFeesOwedB"),Q(ee(),3,"rewardGrowthInside"),Q(k(),8,"")]),cf=F([_e("tick"),hc("liquidityNet"),ee("liquidityGross"),ee("feeGrowthOutsideX64A"),ee("feeGrowthOutsideX64B"),Q(ee(),3,"rewardGrowthsOutsideX64"),Q(ft(),13,"")]),Li=F([Be(8),N("poolId"),_e("startTickIndex"),Q(cf,rt,"ticks"),W("initializedTickCount"),Q(W(),115,"")]),ll=F([Be(329),Q(N(),100,"whitelistMints")]),al=F([Be(8),N("poolId"),Q(Q(k(),8),Fa,"positiveTickArrayBitmap"),Q(Q(k(),8),Fa,"negativeTickArrayBitmap")]),mI=F([k(),W("bump"),N("owner"),N("poolId"),N("positionId"),N("nftAccount"),Q(k(),8)]),ml=F([Be(8),W("bump"),N("lockOwner"),N("poolId"),N("positionId"),N("nftAccount"),N("lockNftMint"),k("recentEpoch"),Q(k(),8)]);cl.span;var dl=ye("Raydium_Clmm"),Vt={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],openPositionWithTokenEx:[77,255,174,82,125,29,201,46],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},pl=[188,37,179,131,82,150,84,73],fl=[16,72,250,198,14,162,212,19],Re=class{static createPoolInstruction(e,t,n,o,s,i,r,c,u,l,m,p,d,f){let y=F([ee("sqrtPriceX64"),k("zero")]),b=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:Kn.programId,isSigner:!1,isWritable:!1},{pubkey:nt,isSigner:!1,isWritable:!1},...(f==null?void 0:f.map(h=>({pubkey:h,isSigner:!1,isWritable:!1})))||[]],g=Buffer.alloc(y.span);y.encode({sqrtPriceX64:d,zero:ge},g);let A=Buffer.from([...Vt.createPool,...g]);return new yt({keys:b,programId:e,data:A})}static async createPoolInstructions(e){let{programId:t,owner:n,mintA:o,mintB:s,ammConfigId:i,initialPriceX64:r,extendMintAccount:c}=e,[u,l]=[new G(o.address),new G(s.address)],{publicKey:m}=tl(t,i,u,l),{publicKey:p}=ol(t,m),{publicKey:d}=Oa(t,m,u),{publicKey:f}=Oa(t,m,l),y=je(t,m).publicKey,b=[this.createPoolInstruction(t,m,n,i,p,u,d,new G(o.programId||Ce),l,f,new G(s.programId||Ce),y,r,c)];return{signers:[],instructions:b,instructionTypes:[U.CreateAccount,U.ClmmCreatePool],address:{poolId:m,observationId:p,exBitmapAccount:y,mintAVault:d,mintBVault:f},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,o,s,i,r,c,u,l,m,p,d,f,y,b,g,A,h,I,T,w,S,x,K,B){let C=F([_e("tickLowerIndex"),_e("tickUpperIndex"),_e("tickArrayLowerStartIndex"),_e("tickArrayUpperStartIndex"),ee("liquidity"),k("amountMaxA"),k("amountMaxB"),qe("withMetadata"),W("optionBaseFlag"),qe("baseFlag")]),L=[...B?[{pubkey:B,isSigner:!1,isWritable:!0}]:[]],M=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:nt,isSigner:!1,isWritable:!1},{pubkey:Kn.programId,isSigner:!1,isWritable:!1},{pubkey:Ce,isSigner:!1,isWritable:!1},{pubkey:Ni,isSigner:!1,isWritable:!1},{pubkey:en,isSigner:!1,isWritable:!1},{pubkey:Ue,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...L],R=Buffer.alloc(C.span);C.encode({tickLowerIndex:A,tickUpperIndex:h,tickArrayLowerStartIndex:I,tickArrayUpperStartIndex:T,liquidity:w,amountMaxA:S,amountMaxB:x,withMetadata:K==="create",baseFlag:!1,optionBaseFlag:0},R);let O=Buffer.from([...Vt.openPosition,...R]);return new yt({keys:M,programId:e,data:O})}static openPositionFromLiquidityInstruction22(e,t,n,o,s,i,r,c,u,l,m,p,d,f,y,b,g,A,h,I,T,w,S,x,K){let B=F([_e("tickLowerIndex"),_e("tickUpperIndex"),_e("tickArrayLowerStartIndex"),_e("tickArrayUpperStartIndex"),ee("liquidity"),k("amountMaxA"),k("amountMaxB"),qe("withMetadata"),W("optionBaseFlag"),qe("baseFlag")]),C=[...K?[{pubkey:K,isSigner:!1,isWritable:!0}]:[]],L=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:nt,isSigner:!1,isWritable:!1},{pubkey:Kn.programId,isSigner:!1,isWritable:!1},{pubkey:Ce,isSigner:!1,isWritable:!1},{pubkey:Ni,isSigner:!1,isWritable:!1},{pubkey:Ue,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...C],M=Buffer.alloc(B.span);B.encode({tickLowerIndex:g,tickUpperIndex:A,tickArrayLowerStartIndex:h,tickArrayUpperStartIndex:I,liquidity:T,amountMaxA:w,amountMaxB:S,withMetadata:x==="create",baseFlag:!1,optionBaseFlag:0},M);let R=Buffer.from([...Vt.openPositionWithTokenEx,...M]);return new yt({keys:L,programId:e,data:R})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:s,liquidity:i,amountMaxA:r,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let p=[],[d,f]=[new G(e.programId),new G(e.id)],y;if(l)y=new G((await l(1))[0]);else{let K=Dr.generate();p.push(K),y=K.publicKey}let b=$.getTickArrayStartIndexByTick(o,e.config.tickSpacing),g=$.getTickArrayStartIndexByTick(s,e.config.tickSpacing),{publicKey:A}=Ae(d,f,b),{publicKey:h}=Ae(d,f,g),{publicKey:I}=m?H(n.wallet,y,Ue):H(n.wallet,y,Ce),{publicKey:T}=xn(y),{publicKey:w}=Bt(d,y),{publicKey:S}=sn(d,f,o,s),x=m?this.openPositionFromLiquidityInstruction22(d,n.feePayer,f,n.wallet,y,I,S,A,h,w,n.tokenAccountA,n.tokenAccountB,new G(t.vault.A),new G(t.vault.B),new G(e.mintA.address),new G(e.mintB.address),o,s,b,g,i,r,c,u,Me.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?je(d,f).publicKey:void 0):this.openPositionFromLiquidityInstruction(d,n.feePayer,f,n.wallet,y,I,T,S,A,h,w,n.tokenAccountA,n.tokenAccountB,new G(t.vault.A),new G(t.vault.B),new G(e.mintA.address),new G(e.mintB.address),o,s,b,g,i,r,c,u,Me.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?je(d,f).publicKey:void 0);return{signers:p,instructions:[x],instructionTypes:[U.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:y,tickArrayLower:A,tickArrayUpper:h,positionNftAccount:I,metadataAccount:T,personalPosition:w,protocolPosition:S}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:s,base:i,baseAmount:r,otherAmountMax:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let p=[],[d,f]=[new G(e.programId),new G(e.id)],y;if(l)y=new G((await l(1))[0]);else{let K=Dr.generate();p.push(K),y=K.publicKey}let b=$.getTickArrayStartIndexByTick(o,e.config.tickSpacing),g=$.getTickArrayStartIndexByTick(s,e.config.tickSpacing),{publicKey:A}=Ae(d,f,b),{publicKey:h}=Ae(d,f,g),{publicKey:I}=m?H(n.wallet,y,Ue):H(n.wallet,y,Ce),{publicKey:T}=xn(y),{publicKey:w}=Bt(d,y),{publicKey:S}=sn(d,f,o,s),x=m?this.openPositionFromBaseInstruction22(d,n.feePayer,f,n.wallet,y,I,S,A,h,w,n.tokenAccountA,n.tokenAccountB,new G(t.vault.A),new G(t.vault.B),new G(e.mintA.address),new G(e.mintB.address),o,s,b,g,u,i,r,c,Me.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?je(d,f).publicKey:void 0):this.openPositionFromBaseInstruction(d,n.feePayer,f,n.wallet,y,I,T,S,A,h,w,n.tokenAccountA,n.tokenAccountB,new G(t.vault.A),new G(t.vault.B),new G(e.mintA.address),new G(e.mintB.address),o,s,b,g,u,i,r,c,Me.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?je(d,f).publicKey:void 0);return{address:{nftMint:y,tickArrayLower:A,tickArrayUpper:h,positionNftAccount:I,metadataAccount:T,personalPosition:w,protocolPosition:S},instructions:[x],signers:p,instructionTypes:[U.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,o,s,i,r,c,u,l,m,p,d,f,y,b,g,A,h,I,T,w,S,x,K,B){let C=F([_e("tickLowerIndex"),_e("tickUpperIndex"),_e("tickArrayLowerStartIndex"),_e("tickArrayUpperStartIndex"),ee("liquidity"),k("amountMaxA"),k("amountMaxB"),qe("withMetadata"),W("optionBaseFlag"),qe("baseFlag")]),L=[...B?[{pubkey:B,isSigner:!1,isWritable:!0}]:[]],M=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:nt,isSigner:!1,isWritable:!1},{pubkey:Kn.programId,isSigner:!1,isWritable:!1},{pubkey:Ce,isSigner:!1,isWritable:!1},{pubkey:Ni,isSigner:!1,isWritable:!1},{pubkey:en,isSigner:!1,isWritable:!1},{pubkey:Ue,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...L],R=Buffer.alloc(C.span);C.encode({tickLowerIndex:A,tickUpperIndex:h,tickArrayLowerStartIndex:I,tickArrayUpperStartIndex:T,liquidity:new Ea(0),amountMaxA:S==="MintA"?x:K,amountMaxB:S==="MintA"?K:x,withMetadata:w==="create",baseFlag:S==="MintA",optionBaseFlag:1},R);let O=Buffer.from([...Vt.openPosition,...R]);return new yt({keys:M,programId:e,data:O})}static openPositionFromBaseInstruction22(e,t,n,o,s,i,r,c,u,l,m,p,d,f,y,b,g,A,h,I,T,w,S,x,K){let B=F([_e("tickLowerIndex"),_e("tickUpperIndex"),_e("tickArrayLowerStartIndex"),_e("tickArrayUpperStartIndex"),ee("liquidity"),k("amountMaxA"),k("amountMaxB"),qe("withMetadata"),W("optionBaseFlag"),qe("baseFlag")]),C=[...K?[{pubkey:K,isSigner:!1,isWritable:!0}]:[]],L=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:nt,isSigner:!1,isWritable:!1},{pubkey:Kn.programId,isSigner:!1,isWritable:!1},{pubkey:Ce,isSigner:!1,isWritable:!1},{pubkey:Ni,isSigner:!1,isWritable:!1},{pubkey:Ue,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...C],M=Buffer.alloc(B.span);B.encode({tickLowerIndex:g,tickUpperIndex:A,tickArrayLowerStartIndex:h,tickArrayUpperStartIndex:I,liquidity:new Ea(0),amountMaxA:w==="MintA"?S:x,amountMaxB:w==="MintA"?x:S,withMetadata:T==="create",baseFlag:w==="MintA",optionBaseFlag:1},M);let R=Buffer.from([...Vt.openPositionWithTokenEx,...M]);return new yt({keys:L,programId:e,data:R})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:s,liquidity:i,amountMaxA:r,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let p,d=[];if(l)p=new G((await l(1))[0]);else{let K=Dr.generate();d.push(K),p=K.publicKey}let[f,y]=[new G(e.programId),new G(e.id)],b=$.getTickArrayStartIndexByTick(o,e.config.tickSpacing),g=$.getTickArrayStartIndexByTick(s,e.config.tickSpacing),{publicKey:A}=Ae(f,y,b),{publicKey:h}=Ae(f,y,g),{publicKey:I}=m?H(n.wallet,p,Ue):H(n.wallet,p,Ce),{publicKey:T}=xn(p),{publicKey:w}=Bt(f,p),{publicKey:S}=sn(f,y,o,s),x=m?this.openPositionFromLiquidityInstruction22(f,n.wallet,y,n.wallet,p,I,S,A,h,w,n.tokenAccountA,n.tokenAccountB,new G(t.vault.A),new G(t.vault.B),new G(t.mintA.address),new G(t.mintB.address),o,s,b,g,i,r,c,u,Me.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?je(f,y).publicKey:void 0):this.openPositionFromLiquidityInstruction(f,n.wallet,y,n.wallet,p,I,T,S,A,h,w,n.tokenAccountA,n.tokenAccountB,new G(t.vault.A),new G(t.vault.B),new G(t.mintA.address),new G(t.mintB.address),o,s,b,g,i,r,c,u,Me.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?je(f,y).publicKey:void 0);return{address:{nftMint:p,tickArrayLower:A,tickArrayUpper:h,positionNftAccount:I,metadataAccount:T,personalPosition:w,protocolPosition:S},instructions:[x],signers:d,instructionTypes:[U.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,o,s,i){let r=F([]),c=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:Kn.programId,isSigner:!1,isWritable:!1},{pubkey:i?Ue:Ce,isSigner:!1,isWritable:!1}],u=Buffer.alloc(r.span);r.encode({},u);let l=Buffer.from([...Vt.closePosition,...u]);return new yt({keys:c,programId:e,data:l})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:o,nft2022:s}){let i=new G(e.programId),r=s?H(n.wallet,o.nftMint,Ue).publicKey:H(n.wallet,o.nftMint,Ce).publicKey,{publicKey:c}=Bt(i,o.nftMint),u=[];return u.push(this.closePositionInstruction(i,n.wallet,o.nftMint,r,c,s)),{address:{positionNftAccount:r,personalPosition:c},signers:[],instructions:u,instructionTypes:[U.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,o,s,i,r,c,u,l,m,p,d,f,y,b,g,A){let h=F([ee("liquidity"),k("amountMaxA"),k("amountMaxB"),W("optionBaseFlag"),qe("baseFlag")]),I=[...A?[{pubkey:A,isSigner:!1,isWritable:!0}]:[]],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:Ce,isSigner:!1,isWritable:!1},{pubkey:Ue,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},...I],w=Buffer.alloc(h.span);h.encode({liquidity:y,amountMaxA:b,amountMaxB:g,optionBaseFlag:0,baseFlag:!1},w);let S=Buffer.from([...Vt.increaseLiquidity,...w]);return new yt({keys:T,programId:e,data:S})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:o,liquidity:s,amountMaxA:i,amountMaxB:r,nft2022:c}){let[u,l]=[new G(e.programId),new G(e.id)],m=$.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),p=$.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:d}=Ae(u,l,m),{publicKey:f}=Ae(u,l,p),{publicKey:y}=c?H(o.wallet,n.nftMint,Ue):H(o.wallet,n.nftMint,Ce),{publicKey:b}=Bt(u,n.nftMint),{publicKey:g}=sn(u,l,n.tickLower,n.tickUpper),A=this.increasePositionFromLiquidityInstruction(u,o.wallet,y,b,l,g,d,f,o.tokenAccountA,o.tokenAccountB,new G(t.vault.A),new G(t.vault.B),new G(e.mintA.address),new G(e.mintB.address),s,i,r,Me.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,p])?je(u,l).publicKey:void 0);return{address:{tickArrayLower:d,tickArrayUpper:f,positionNftAccount:y,personalPosition:b,protocolPosition:g},signers:[],instructions:[A],instructionTypes:[U.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:o,base:s,baseAmount:i,otherAmountMax:r,nft2022:c}){let[u,l]=[new G(e.programId),new G(e.id)],m=$.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),p=$.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:d}=Ae(u,l,m),{publicKey:f}=Ae(u,l,p),{publicKey:y}=c?H(o.wallet,n.nftMint,Ue):H(o.wallet,n.nftMint,Ce),{publicKey:b}=Bt(u,n.nftMint),{publicKey:g}=sn(u,l,n.tickLower,n.tickUpper);return{address:{tickArrayLower:d,tickArrayUpper:f,positionNftAccount:y,personalPosition:b,protocolPosition:g},instructions:[this.increasePositionFromBaseInstruction(u,o.wallet,y,b,l,g,d,f,o.tokenAccountA,o.tokenAccountB,new G(t.vault.A),new G(t.vault.B),new G(e.mintA.address),new G(e.mintB.address),s,i,r,Me.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,p])?je(u,l).publicKey:void 0)],signers:[],instructionTypes:[U.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,o,s,i,r,c,u,l,m,p,d,f,y,b,g,A){let h=F([ee("liquidity"),k("amountMaxA"),k("amountMaxB"),W("optionBaseFlag"),qe("baseFlag")]),I=[...A?[{pubkey:A,isSigner:!1,isWritable:!0}]:[]],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:Ce,isSigner:!1,isWritable:!1},{pubkey:Ue,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},...I],w=Buffer.alloc(h.span);h.encode({liquidity:new Ea(0),amountMaxA:y==="MintA"?b:g,amountMaxB:y==="MintA"?g:b,baseFlag:y==="MintA",optionBaseFlag:1},w);let S=Buffer.from([...Vt.increaseLiquidity,...w]);return new yt({keys:T,programId:e,data:S})}static decreaseLiquidityInstruction(e,t,n,o,s,i,r,c,u,l,m,p,d,f,y,b,g,A,h){let I=F([ee("liquidity"),k("amountMinA"),k("amountMinB")]),T=[...h?[{pubkey:h,isSigner:!1,isWritable:!0}]:[],...y.map(K=>[{pubkey:K.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:K.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:K.rewardMint,isSigner:!1,isWritable:!1}]).flat()],w=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:Ce,isSigner:!1,isWritable:!1},{pubkey:Ue,isSigner:!1,isWritable:!1},{pubkey:dr,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},...T],S=Buffer.alloc(I.span);I.encode({liquidity:b,amountMinA:g,amountMinB:A},S);let x=Buffer.from([...Vt.decreaseLiquidity,...S]);return new yt({keys:w,programId:e,data:x})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:o,liquidity:s,amountMinA:i,amountMinB:r,programId:c,nft2022:u}){let[l,m]=[new G(e.programId),new G(e.id)],p=$.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=$.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:f}=Ae(l,m,p),{publicKey:y}=Ae(l,m,d),{publicKey:b}=u?H(o.wallet,n.nftMint,Ue):H(o.wallet,n.nftMint,c),{publicKey:g}=Bt(l,n.nftMint),{publicKey:A}=sn(l,m,n.tickLower,n.tickUpper),h=[];for(let w=0;w<e.rewardDefaultInfos.length;w++)h.push({poolRewardVault:new G(t.rewardInfos[w].vault),ownerRewardVault:o.rewardAccounts[w],rewardMint:new G(e.rewardDefaultInfos[w].mint.address)});let I=[],T=this.decreaseLiquidityInstruction(l,o.wallet,b,g,m,A,f,y,o.tokenAccountA,o.tokenAccountB,new G(t.vault.A),new G(t.vault.B),new G(e.mintA.address),new G(e.mintB.address),h,s,i,r,Me.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[p,d])?je(l,m).publicKey:void 0);return I.push(T),{address:{tickArrayLower:f,tickArrayUpper:y,positionNftAccount:b,personalPosition:g,protocolPosition:A},signers:[],instructions:I,instructionTypes:[U.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,o,s,i,r,c,u,l,m,p,d,f,y,b,g){let A=F([k("amount"),k("otherAmountThreshold"),ee("sqrtPriceLimitX64"),qe("isBaseInput")]),h=[...g?[{pubkey:g,isSigner:!1,isWritable:!0}]:[],...m.map(S=>({pubkey:S,isSigner:!1,isWritable:!0}))],I=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:Ce,isSigner:!1,isWritable:!1},{pubkey:Ue,isSigner:!1,isWritable:!1},{pubkey:dr,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},...h],T=Buffer.alloc(A.span);A.encode({amount:d,otherAmountThreshold:f,sqrtPriceLimitX64:y,isBaseInput:b},T);let w=Buffer.from([...Vt.swap,...T]);return new yt({keys:I,programId:e,data:w})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:o,inputMint:s,amountIn:i,amountOutMin:r,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,m]=[new G(e.programId),new G(e.id)],[p,d]=[new G(t.vault.A),new G(t.vault.B)],[f,y]=[new G(e.mintA.address),new G(e.mintB.address)],b=e.mintA.address===s.toString(),g=[this.swapInstruction(l,o.wallet,m,new G(e.config.id),b?o.tokenAccountA:o.tokenAccountB,b?o.tokenAccountB:o.tokenAccountA,b?p:d,b?d:p,b?f:y,b?y:f,u,n,i,r,c,!0,je(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[U.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static makeSwapBaseOutInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:o,outputMint:s,amountOut:i,amountInMax:r,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,m]=[new G(e.programId),new G(e.id)],[p,d]=[new G(t.vault.A),new G(t.vault.B)],[f,y]=[new G(e.mintA.address),new G(e.mintB.address)],b=e.mintA.address===s.toBase58(),g=[this.swapInstruction(l,o.wallet,m,new G(e.config.id),b?o.tokenAccountB:o.tokenAccountA,b?o.tokenAccountA:o.tokenAccountB,b?d:p,b?p:d,b?y:f,b?f:y,u,n,i,r,c,!1,je(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[U.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,o,s,i,r,c,u,l,m,p){let d=F([k("openTime"),k("endTime"),ee("emissionsPerSecondX64")]),f=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:Kn.programId,isSigner:!1,isWritable:!1},{pubkey:nt,isSigner:!1,isWritable:!1}],y=Buffer.alloc(d.span);d.encode({openTime:J(l),endTime:J(m),emissionsPerSecondX64:p},y);let b=Buffer.from([...Vt.initReward,...y]);return new yt({keys:f,programId:e,data:b})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:o}){let[s,i]=[new G(e.programId),new G(e.id)],r=nl(s,i,o.mint).publicKey,c=Ci(s).publicKey,u=[this.initRewardInstruction(s,n.wallet,i,c,new G(e.config.id),n.tokenAccount,o.programId,o.mint,r,o.openTime,o.endTime,o.emissionsPerSecondX64)];return{address:{poolRewardVault:r,operationId:c},signers:[],instructions:u,instructionTypes:[U.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,o,s,i,r,c,u,l,m,p){let d=F([W("rewardIndex"),ee("emissionsPerSecondX64"),k("openTime"),k("endTime")]),f=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:Ce,isSigner:!1,isWritable:!1},{pubkey:Ue,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0}],y=Buffer.alloc(d.span);d.encode({rewardIndex:u,emissionsPerSecondX64:p,openTime:J(l),endTime:J(m)},y);let b=Buffer.from([...Vt.setRewardEmissions,...y]);return new yt({keys:f,programId:e,data:b})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:o}){let[s,i]=[new G(e.programId),new G(e.id)],r,c,u;for(let p=0;p<e.rewardDefaultInfos.length;p++)e.rewardDefaultInfos[p].mint.address===o.mint.toString()&&(r=p,c=new G(t.rewardInfos[p].vault),u=new G(t.rewardInfos[p].mint.address));(r===void 0||c===void 0)&&dl.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let l=Ci(s).publicKey,m=[this.setRewardInstruction(s,n.wallet,i,l,new G(e.config.id),n.tokenAccount,c,u,r,o.openTime,o.endTime,o.emissionsPerSecondX64)];return{address:{rewardVault:c,operationId:l},signers:[],instructions:m,instructionTypes:[U.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,o,s,i,r){let c=F([W("rewardIndex")]),u=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:Ce,isSigner:!1,isWritable:!1},{pubkey:Ue,isSigner:!1,isWritable:!1},{pubkey:dr,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({rewardIndex:r},l);let m=Buffer.from([...Vt.collectReward,...l]);return new yt({keys:u,programId:e,data:m})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:o}){let[s,i]=[new G(e.programId),new G(e.id)],r,c;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===o.toString()&&(r=l,c=new G(t.rewardInfos[l].vault));(r===void 0||c===void 0)&&dl.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let u=[this.collectRewardInstruction(s,n.wallet,i,n.tokenAccount,c,o,r)];return{address:{rewardVault:c},signers:[],instructions:u,instructionTypes:[U.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static async makeLockPositions({programId:e,authProgramId:t,poolProgramId:n,payer:o,wallet:s,nftMint:i,nft2022:r,getEphemeralSigners:c}){let u=[],l;if(c)l=new G((await c(1))[0]);else{let g=Dr.generate();u.push(g),l=g.publicKey}let m=r?H(s,i,Ue).publicKey:H(s,i,Ce).publicKey,{publicKey:p}=Bt(n,i),d=Mo(e,l).publicKey,f=H(s,l,Ce).publicKey,y=xn(l).publicKey,b=Re.lockPositionInstructionV2({programId:e,auth:t,payer:o,positionOwner:s,lockOwner:s,positionNftAccount:m,positionId:p,lockPositionId:d,lockNftMint:l,lockNftAccount:f,metadataAccount:y,withMetadata:!0,nft2022:r,positionNftMint:i,authPositionNftAccount:H(t,i,r?Ue:Ce).publicKey,positionNftProgram:r?Ue:Ce});return{address:{positionId:p,lockPositionId:d,lockNftAccount:f,lockNftMint:l,positionNftAccount:m,metadataAccount:y},instructions:[b],signers:u,instructionTypes:[U.ClmmLockPosition],lookupTableAddress:[]}}static lockPositionInstructionV2({programId:e,auth:t,payer:n,positionOwner:o,lockOwner:s,positionNftAccount:i,positionId:r,positionNftMint:c,authPositionNftAccount:u,positionNftProgram:l,lockPositionId:m,lockNftMint:p,lockNftAccount:d,metadataAccount:f,withMetadata:y}){let b=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!0,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:en,isSigner:!1,isWritable:!1},{pubkey:Ni,isSigner:!1,isWritable:!1},{pubkey:nt,isSigner:!1,isWritable:!1},{pubkey:Ce,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:Kn.programId,isSigner:!1,isWritable:!1}],g=F([qe("withMetadata")]),A=Buffer.alloc(g.span);g.encode({withMetadata:y},A);let h=Buffer.from([...pl,...A]);return new yt({keys:b,programId:e,data:h})}static lockPositionInstruction({programId:e,authProgramId:t,poolProgramId:n,owner:o,positionNft:s}){let{publicKey:i}=H(o,s,Ce),{publicKey:r}=Bt(n,s),c=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:Na(e,r).publicKey,isSigner:!1,isWritable:!0},{pubkey:Ce,isSigner:!1,isWritable:!1},{pubkey:Kn.programId,isSigner:!1,isWritable:!1}];return new yt({keys:c,programId:e,data:Buffer.from(pl)})}static harvestLockPositionInstruction(e){let[t,n]=[new G(e.poolKeys.programId),new G(e.poolKeys.id)],o=$.getTickArrayStartIndexByTick(e.ownerPosition.tickLower,e.poolKeys.config.tickSpacing),s=$.getTickArrayStartIndexByTick(e.ownerPosition.tickUpper,e.poolKeys.config.tickSpacing),{publicKey:i}=Ae(t,n,o),{publicKey:r}=Ae(t,n,s),{publicKey:c}=H(e.owner,e.ownerPosition.nftMint,Ce),{publicKey:u}=Bt(t,e.ownerPosition.nftMint),{publicKey:l}=sn(t,n,e.ownerPosition.tickLower,e.ownerPosition.tickUpper),m=[];for(let f=0;f<e.poolKeys.rewardInfos.length;f++)m.push({poolRewardVault:new G(e.poolKeys.rewardInfos[f].vault),ownerRewardVault:e.ownerRewardAccounts[f],rewardMint:new G(e.poolKeys.rewardInfos[f].mint.address)});let p=[...m.map(f=>[{pubkey:f.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:f.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:f.rewardMint,isSigner:!1,isWritable:!1}]).flat()],d=[{pubkey:e.authProgramId,isSigner:!1,isWritable:!1},{pubkey:Na(e.programId,u).publicKey,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e.owner,isSigner:!0,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:new G(e.poolKeys.vault.A),isSigner:!1,isWritable:!0},{pubkey:new G(e.poolKeys.vault.B),isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:e.userVaultA,isSigner:!1,isWritable:!0},{pubkey:e.userVaultB,isSigner:!1,isWritable:!0},{pubkey:Ce,isSigner:!1,isWritable:!1},{pubkey:Ue,isSigner:!1,isWritable:!1},{pubkey:mn,isSigner:!1,isWritable:!1},{pubkey:new G(e.poolKeys.mintA.address),isSigner:!1,isWritable:!1},{pubkey:new G(e.poolKeys.mintB.address),isSigner:!1,isWritable:!1},...p];return new yt({keys:d,programId:e.programId,data:Buffer.from(fl)})}static harvestLockPositionInstructionV2({programId:e,auth:t,lockPositionId:n,clmmProgram:o,lockOwner:s,lockNftMint:i,lockNftAccount:r,positionNftAccount:c,positionId:u,poolId:l,protocolPosition:m,vaultA:p,vaultB:d,tickArrayLower:f,tickArrayUpper:y,userVaultA:b,userVaultB:g,mintA:A,mintB:h,rewardAccounts:I,exTickArrayBitmap:T}){let w=[...T?[{pubkey:T,isSigner:!1,isWritable:!0}]:[],...I.map(x=>[{pubkey:x.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:x.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:x.rewardMint,isSigner:!1,isWritable:!1}]).flat()],S=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!0,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0},{pubkey:Ce,isSigner:!1,isWritable:!1},{pubkey:Ue,isSigner:!1,isWritable:!1},{pubkey:mn,isSigner:!1,isWritable:!1},{pubkey:A,isSigner:!1,isWritable:!1},{pubkey:h,isSigner:!1,isWritable:!1},...w];return new yt({keys:S,programId:e,data:Buffer.from(fl)})}};var yl=F([ft("mintAuthorityOption"),N("mintAuthority"),k("supply"),W("decimals"),W("isInitialized"),ft("freezeAuthorityOption"),N("freezeAuthority")]);import{PublicKey as lf}from"@solana/web3.js";import{MintLayout as bl,TOKEN_PROGRAM_ID as mf}from"@solana/spl-token";var _I=async({connection:a,mint:e})=>{let t=await a.getAccountInfo(new lf(e));return!t||t.data.length!==bl.span?void 0:bl.decode(t.data)},EI=({mint:a,decimals:e,programId:t=mf,logoURI:n="",priority:o=3})=>{let s=a.toBase58().substring(0,6);return{address:a.toBase58(),decimals:e,symbol:s,logoURI:n,extensions:{},chainId:101,programId:t.toString(),name:s,tags:[],priority:o}},Wr=a=>new Se({mint:a.address,decimals:a.decimals,symbol:a.symbol,name:a.name}),Mi=o=>{var s=o,{amount:a,isRaw:e,name:t}=s,n=De(s,["amount","isRaw","name"]);return new he(new Se({mint:bt(n.address).toBase58(),decimals:n.decimals,symbol:n.symbol,name:t}),a,e,t)};function DI(a){return a.address===ln.address?ut:a}function WI(a){return a.address===ut.address?ln:a}var Pt=o=>{var s=o,{address:a,programId:e,decimals:t}=s,n=De(s,["address","programId","decimals"]);return v({chainId:101,address:bt(a).toBase58(),programId:e,logoURI:"",symbol:"",name:"",decimals:t,tags:[],extensions:n.extensions||{}},n)},Wn=a=>a?q(v({},a),{transferFeeConfigAuthority:a.transferFeeConfigAuthority.toBase58(),withdrawWithheldAuthority:a.withdrawWithheldAuthority.toBase58(),withheldAmount:a.withheldAmount.toString(),olderTransferFee:q(v({},a.olderTransferFee),{epoch:a.olderTransferFee.epoch.toString(),maximumFee:a.olderTransferFee.maximumFee.toString()}),newerTransferFee:q(v({},a.newerTransferFee),{epoch:a.newerTransferFee.epoch.toString(),maximumFee:a.newerTransferFee.maximumFee.toString()})}):void 0;import gl from"bn.js";var Da=new gl(25),qr=new gl(1e4),df={4:3,5:3};import{PublicKey as Le,SystemProgram as kl,SYSVAR_RENT_PUBKEY as ff,TransactionInstruction as Cn}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as yf,TOKEN_PROGRAM_ID as Vo}from"@solana/spl-token";var Wa=F([W("instruction"),k("amountIn"),k("minAmountOut")]),qa=F([W("instruction"),k("maxAmountIn"),k("amountOut")]),$I=F([W("instruction"),W("nonce")]),Ua=F([W("instruction"),W("nonce"),k("startTime")]),uo=F([k("status"),k("nonce"),k("maxOrder"),k("depth"),k("baseDecimal"),k("quoteDecimal"),k("state"),k("resetFlag"),k("minSize"),k("volMaxCutRatio"),k("amountWaveRatio"),k("baseLotSize"),k("quoteLotSize"),k("minPriceMultiplier"),k("maxPriceMultiplier"),k("systemDecimalValue"),k("minSeparateNumerator"),k("minSeparateDenominator"),k("tradeFeeNumerator"),k("tradeFeeDenominator"),k("pnlNumerator"),k("pnlDenominator"),k("swapFeeNumerator"),k("swapFeeDenominator"),k("baseNeedTakePnl"),k("quoteNeedTakePnl"),k("quoteTotalPnl"),k("baseTotalPnl"),k("poolOpenTime"),k("punishPcAmount"),k("punishCoinAmount"),k("orderbookToInitTime"),ee("swapBaseInAmount"),ee("swapQuoteOutAmount"),k("swapBase2QuoteFee"),ee("swapQuoteInAmount"),ee("swapBaseOutAmount"),k("swapQuote2BaseFee"),N("baseVault"),N("quoteVault"),N("baseMint"),N("quoteMint"),N("lpMint"),N("openOrders"),N("marketId"),N("marketProgramId"),N("targetOrders"),N("withdrawQueue"),N("lpVault"),N("owner"),k("lpReserve"),Q(k(),3,"padding")]),pf=F([k("accountType"),k("status"),k("nonce"),k("maxOrder"),k("depth"),k("baseDecimal"),k("quoteDecimal"),k("state"),k("resetFlag"),k("minSize"),k("volMaxCutRatio"),k("amountWaveRatio"),k("baseLotSize"),k("quoteLotSize"),k("minPriceMultiplier"),k("maxPriceMultiplier"),k("systemDecimalsValue"),k("abortTradeFactor"),k("priceTickMultiplier"),k("priceTick"),k("minSeparateNumerator"),k("minSeparateDenominator"),k("tradeFeeNumerator"),k("tradeFeeDenominator"),k("pnlNumerator"),k("pnlDenominator"),k("swapFeeNumerator"),k("swapFeeDenominator"),k("baseNeedTakePnl"),k("quoteNeedTakePnl"),k("quoteTotalPnl"),k("baseTotalPnl"),k("poolOpenTime"),k("punishPcAmount"),k("punishCoinAmount"),k("orderbookToInitTime"),ee("swapBaseInAmount"),ee("swapQuoteOutAmount"),ee("swapQuoteInAmount"),ee("swapBaseOutAmount"),k("swapQuote2BaseFee"),k("swapBase2QuoteFee"),N("baseVault"),N("quoteVault"),N("baseMint"),N("quoteMint"),N("lpMint"),N("modelDataAccount"),N("openOrders"),N("marketId"),N("marketProgramId"),N("targetOrders"),N("owner"),Q(k(),64,"padding")]),Ga=F([W("instruction"),k("baseAmountIn"),k("quoteAmountIn"),k("fixedSide"),k("otherAmountMin")]),Xa=F([W("instruction"),k("lpAmount"),k("baseAmountMin"),k("quoteAmountMin")]),JI={4:uo,5:pf},Al=F([k("fee")]);var Pl=ye("Raydium_liquidity_instruction");function wl(a){let{poolInfo:e,poolKeys:t,userKeys:n,baseAmountIn:o,quoteAmountIn:s,fixedSide:i,otherAmountMin:r,modelDataPubKey:c=vn}=a,u=Buffer.alloc(Ga.span);Ga.encode({instruction:3,baseAmountIn:J(o),quoteAmountIn:J(s),otherAmountMin:J(r),fixedSide:i==="base"?et:Xu},u);let l=[P({pubkey:Vo,isWritable:!1}),P({pubkey:new Le(e.id)}),P({pubkey:new Le(t.authority),isWritable:!1}),P({pubkey:new Le(t.openOrders),isWritable:!1}),P({pubkey:new Le(t.targetOrders)}),P({pubkey:new Le(e.lpMint.address)}),P({pubkey:new Le(t.vault.A)}),P({pubkey:new Le(t.vault.B)})];return e.pooltype.includes("StablePool")&&l.push(P({pubkey:c})),l.push(P({pubkey:new Le(e.marketId),isWritable:!1}),P({pubkey:n.baseTokenAccount}),P({pubkey:n.quoteTokenAccount}),P({pubkey:n.lpTokenAccount}),P({pubkey:n.owner,isWritable:!1,isSigner:!0}),P({pubkey:new Le(t.marketEventQueue),isWritable:!1})),new Cn({programId:new Le(e.programId),keys:l,data:u})}function za(a){let{poolInfo:e,poolKeys:t,userKeys:n,lpAmount:o,baseAmountMin:s,quoteAmountMin:i,modelDataPubKey:r=vn}=a,c=Fe(t),u=4;if(e.pooltype.includes("StablePool")&&(u=5),u===4||u===5){let l=Buffer.alloc(Xa.span);Xa.encode({instruction:4,lpAmount:J(o),baseAmountMin:J(s),quoteAmountMin:J(i)},l);let m=[P({pubkey:Vo,isWritable:!1}),P({pubkey:c.id}),P({pubkey:c.authority,isWritable:!1}),P({pubkey:c.openOrders}),P({pubkey:c.targetOrders}),P({pubkey:c.mintLp.address}),P({pubkey:c.vault.A}),P({pubkey:c.vault.B})];return u===5?m.push(P({pubkey:r})):(m.push(P({pubkey:c.id})),m.push(P({pubkey:c.id}))),m.push(P({pubkey:c.marketProgramId,isWritable:!1}),P({pubkey:c.marketId}),P({pubkey:c.marketBaseVault}),P({pubkey:c.marketQuoteVault}),P({pubkey:c.marketAuthority,isWritable:!1}),P({pubkey:n.lpTokenAccount}),P({pubkey:n.baseTokenAccount}),P({pubkey:n.quoteTokenAccount}),P({pubkey:n.owner,isWritable:!1,isSigner:!0}),P({pubkey:c.marketEventQueue}),P({pubkey:c.marketBids}),P({pubkey:c.marketAsks})),new Cn({programId:c.programId,keys:m,data:l})}return new Cn({programId:c.programId,keys:[]})}function Qa({programId:a,ammId:e,ammAuthority:t,ammOpenOrders:n,lpMint:o,coinMint:s,pcMint:i,coinVault:r,pcVault:c,withdrawQueue:u,ammTargetOrders:l,poolTempLp:m,marketProgramId:p,marketId:d,userWallet:f,userCoinVault:y,userPcVault:b,userLpVault:g,nonce:A,openTime:h,coinAmount:I,pcAmount:T,ammConfigId:w,feeDestinationId:S}){let x=F([W("instruction"),W("nonce"),k("openTime"),k("pcAmount"),k("coinAmount")]),K=[{pubkey:Vo,isSigner:!1,isWritable:!1},{pubkey:yf,isSigner:!1,isWritable:!1},{pubkey:kl.programId,isSigner:!1,isWritable:!1},{pubkey:nt,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:w,isSigner:!1,isWritable:!1},{pubkey:S,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!0,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0}],B=Buffer.alloc(x.span);return x.encode({instruction:1,nonce:A,openTime:h,coinAmount:I,pcAmount:T},B),{instruction:new Cn({keys:K,programId:a,data:B}),instructionType:U.AmmV4CreatePool}}function lB(a){let e=F([W("instruction"),W("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[P({pubkey:new Le(a.id),isWritable:!1}),P({pubkey:new Le(a.authority),isWritable:!1}),P({pubkey:new Le(a.openOrders),isWritable:!1}),P({pubkey:new Le(a.vault.A),isWritable:!1}),P({pubkey:new Le(a.vault.B),isWritable:!1}),P({pubkey:new Le(a.mintLp.address),isWritable:!1}),P({pubkey:new Le(a.marketId),isWritable:!1}),P({pubkey:new Le(a.marketEventQueue),isWritable:!1})];return new Cn({programId:new Le(a.programId),keys:n,data:t})}function bf({poolKeys:a,userKeys:e,amountIn:t,minAmountOut:n,modelDataPubKey:o=vn},s){let i=Fe(a),r=Buffer.alloc(Wa.span);Wa.encode({instruction:9,amountIn:J(t),minAmountOut:J(n)},r);let c=[P({pubkey:Vo,isWritable:!1}),P({pubkey:i.id}),P({pubkey:i.authority,isWritable:!1}),P({pubkey:i.openOrders})];return s===4&&c.push(P({pubkey:i.targetOrders})),c.push(P({pubkey:i.vault.A}),P({pubkey:i.vault.B})),s===5&&c.push(P({pubkey:o})),c.push(P({pubkey:i.marketProgramId,isWritable:!1}),P({pubkey:i.marketId}),P({pubkey:i.marketBids}),P({pubkey:i.marketAsks}),P({pubkey:i.marketEventQueue}),P({pubkey:i.marketBaseVault}),P({pubkey:i.marketQuoteVault}),P({pubkey:i.marketAuthority,isWritable:!1}),P({pubkey:e.tokenAccountIn}),P({pubkey:e.tokenAccountOut}),P({pubkey:e.owner,isWritable:!1,isSigner:!0})),new Cn({programId:i.programId,keys:c,data:r})}function gf({poolKeys:a,userKeys:e,maxAmountIn:t,amountOut:n,modelDataPubKey:o=vn},s){let i=Fe(a),r=Buffer.alloc(qa.span);qa.encode({instruction:11,maxAmountIn:J(t),amountOut:J(n)},r);let c=[P({pubkey:Vo,isWritable:!1}),P({pubkey:i.id}),P({pubkey:i.authority,isWritable:!1}),P({pubkey:i.openOrders}),P({pubkey:i.targetOrders}),P({pubkey:i.vault.A}),P({pubkey:i.vault.B})];return s===5&&c.push(P({pubkey:o})),c.push(P({pubkey:i.marketProgramId,isWritable:!1}),P({pubkey:i.marketId}),P({pubkey:i.marketBids}),P({pubkey:i.marketAsks}),P({pubkey:i.marketEventQueue}),P({pubkey:i.marketBaseVault}),P({pubkey:i.marketQuoteVault}),P({pubkey:i.marketAuthority,isWritable:!1}),P({pubkey:e.tokenAccountIn}),P({pubkey:e.tokenAccountOut}),P({pubkey:e.owner,isWritable:!1,isSigner:!0})),new Cn({programId:i.programId,keys:c,data:r})}function Ur(a){let{poolKeys:e,version:t,userKeys:n,amountIn:o,amountOut:s,fixedSide:i}=a;if(t===4||t===5){let r={poolKeys:e,userKeys:n};if(i==="in")return bf(q(v({},r),{amountIn:o,minAmountOut:s}),t);if(i==="out")return gf(q(v({},r),{maxAmountIn:o,amountOut:s}),t);Pl.logWithError("invalid params","params",a)}throw Pl.logWithError("invalid version","poolKeys.version",t),new Error("invalid version")}function mB({poolKeys:a,userKeys:e,startTime:t}){let n=Buffer.alloc(Ua.span);Ua.encode({instruction:0,nonce:5,startTime:J(t)},n);let o=Fe(a),s=[P({pubkey:Vo,isWritable:!1}),P({pubkey:kl.programId,isWritable:!1}),P({pubkey:ff,isWritable:!1}),P({pubkey:o.id}),P({pubkey:o.authority,isWritable:!1}),P({pubkey:o.openOrders}),P({pubkey:o.mintLp.address}),P({pubkey:o.mintA.address,isWritable:!1}),P({pubkey:o.mintB.address,isWritable:!1}),P({pubkey:o.vault.A,isWritable:!1}),P({pubkey:o.vault.B,isWritable:!1}),P({pubkey:o.id}),P({pubkey:o.targetOrders}),P({pubkey:e.lpTokenAccount}),P({pubkey:o.id,isWritable:!1}),P({pubkey:o.marketProgramId,isWritable:!1}),P({pubkey:o.marketId,isWritable:!1}),P({pubkey:e.payer,isSigner:!0})];return new Cn({programId:o.programId,keys:s,data:n})}function Tl({poolKeys:a}){let e=F([W("instruction"),W("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[P({pubkey:new Le(a.id),isWritable:!1}),P({pubkey:new Le(a.authority),isWritable:!1}),P({pubkey:new Le(a.openOrders),isWritable:!1}),P({pubkey:new Le(a.vault.A),isWritable:!1}),P({pubkey:new Le(a.vault.B),isWritable:!1}),P({pubkey:new Le(a.mintLp.address),isWritable:!1}),P({pubkey:new Le(a.marketId),isWritable:!1}),P({pubkey:new Le(a.marketEventQueue),isWritable:!1})];return{instruction:new Cn({programId:new Le(a.programId),keys:n,data:t})}}var lo=5e4,Af=F([k("x"),k("y"),k("price")]),Pf=F([k("accountType"),k("status"),k("multiplier"),k("validDataCount"),Q(Af,lo,"DataElement")]);function kf(a,e){return[0,lo-2]}function wf(a){return[0,lo-2]}function Tf(a){return[0,lo-2]}function hf(a,e,t){let[n,o]=kf(e,t),s=n,i=o,r=0,c=e*a.multiplier/t;for(;s<=i;){if(r=Math.floor((i+s)/2),r===0||r>=lo-2)return[r,r,!1];let u=a.DataElement[r].x*a.multiplier/a.DataElement[r].y,l=a.DataElement[r-1].x*a.multiplier/a.DataElement[r-1].y,m=a.DataElement[r+1].x*a.multiplier/a.DataElement[r+1].y;if(c===u)return[r,r,!0];if(c===l)return[r-1,r-1,!0];if(c===m)return[r+1,r+1,!0];if(c<l)i=r-1;else{if(c>l&&c<u)return[r-1,r,!0];if(c>u&&c<m)return[r,r+1,!0];s=r+1}}return[r,r,!1]}function Ya(a,e,t){let[n,o,s]=hf(a,e,t);if(!s)return 0;if(n===o){let i=a.DataElement[n].x;return e*a.multiplier/i}else{let i=a.DataElement[n].x,r=a.DataElement[n].y,c=a.DataElement[o].x,u=a.DataElement[o].y,l=t*(c*r-i*u),m=i*l,p=(c-i)*(e*r-i*t)*u,d=m+p;return e*a.multiplier*l/d}}function co(a,e,t){return e*a.multiplier/t}function hl(a,e,t){return e*t/a.multiplier}function If(a,e){let[t,n]=wf(e),o=t,s=n,i=0,r=e;for(;o<s;){if(i=Math.floor((s+o)/2),i<=0||i>lo-2)return[i,i,!1];let c=a.DataElement[i].x,u=a.DataElement[i-1].x,l=a.DataElement[i+1].x;if(r===c)return[i,i,!0];if(r===u)return[i-1,i-1,!0];if(r===l)return[i+1,i+1,!0];if(r<u)s=i-1;else{if(r>u&&r<c)return[i-1,i,!0];if(r>c&&r<l)return[i,i+1,!0];o=i+1}}return[i,i,!1]}function Bf(a,e){let[t,n]=Tf(e),o=t,s=n,i=0,r=e;for(;o<=s;){if(i=Math.floor((s+o)/2),i<=0||i>=lo-2)return[i,i,!1];let c=a.DataElement[i].y,u=a.DataElement[i-1].y,l=a.DataElement[i+1].y;if(r===c)return[i,i,!0];if(r===u)return[i-1,i-1,!0];if(r===l)return[i+1,i+1,!0];if(r<l)o=i+1;else{if(r<u&&r>c)return[i-1,i,!0];if(r<c&&r>l)return[i,i+1,!0];s=i-1}}return[i,i,!1]}function Il(a,e,t,n){let o=n?e+t:e-t,[s,i,r]=If(a,o);if(!r)return[0,0,!1,r];if(s===i)return[a.DataElement[i].price,a.DataElement[i].y,!1,r];{let c=a.DataElement[s].x,u=a.DataElement[i].x,l=a.DataElement[s].price,m=a.DataElement[i].price,p=a.DataElement[s].y,d=a.DataElement[i].y;if(e>=c&&e<=u)return n?[m,d,!0,r]:[l,p,!0,r];{let f,y;return n?(f=l+(m-l)*(e-c)/(u-c),y=p-(o-c)*a.multiplier/m):(f=l+(m-l)*(e-c)/(u-c),y=d+(u-o)*a.multiplier/l),[f,y,!1,r]}}}function xf(a,e,t,n){let o=n?e-t:e+t,[s,i,r]=Bf(a,o);if(!r)return[0,0,!1,r];if(s===i)return[a.DataElement[i].price,a.DataElement[i].x,!1,r];{let c=a.DataElement[s].x,u=a.DataElement[i].x,l=a.DataElement[s].price,m=a.DataElement[i].price,p=a.DataElement[s].y,d=a.DataElement[i].y;if(e>=d&&e<=p)return n?[m,u,!0,r]:[l,c,!0,r];{let f,y;return n?(f=l+(m-l)*(p-e)/(p-d),y=c+m*(p-o)/a.multiplier):(f=l+(m-l)*(p-e)/(p-d),y=u-l*(o-d)/a.multiplier),[f,y,!1,r]}}}function Sf(a,e){let t=Il(a,e,0,!1);return t[3]?t[0]:0}function Bl(a,e,t,n){let o=Ya(a,e,t),s=co(a,e,o),i=co(a,t,o),r=co(a,n,o),c=!0,[u,l,m,p]=Il(a,s,r,c);if(!p)return 0;if(m)return n*a.multiplier/u;{let d=i-l;return hl(a,d,o)}}function xl(a,e,t,n){let o=Ya(a,e,t),s=co(a,e,o),i=co(a,t,o),r=co(a,n,o),c=!1,[u,l,m,p]=xf(a,i,r,c);if(!p)return 0;if(m)return n*u/a.multiplier;{let d=s-l;return hl(a,d,o)}}function Kf(a){let e=Pf.decode(a);return{accountType:e.accountType.toNumber(),status:e.status.toNumber(),multiplier:e.multiplier.toNumber(),validDataCount:e.validDataCount.toNumber(),DataElement:e.DataElement.map(t=>({x:t.x.toNumber(),y:t.y.toNumber(),price:t.price.toNumber()}))}}function Sl(a,e,t,n){let o=Sf(a,co(a,e,Ya(a,e,t)))/a.multiplier;return n?o:1/o}var _o=class{constructor({connection:e,modelDataPubKey:t=vn}){this._layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};this.connection=e,this.modelDataPubKey=t}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let e=await this.connection.getAccountInfo(this.modelDataPubKey);e&&(this._layoutData=Kf(e==null?void 0:e.data))}}};import{PublicKey as Fi}from"@solana/web3.js";import vi from"bn.js";import Gr from"decimal.js";import{TOKEN_PROGRAM_ID as Lf}from"@solana/spl-token";import{PublicKey as Cf}from"@solana/web3.js";var Rf=ye("Raydium_liquidity_serum");function Kl({programId:a,marketId:e}){let t=[e.toBuffer()],n=0,o;for(;n<100;){try{let s=t.concat(Buffer.from([n]),Buffer.alloc(7));o=Cf.createProgramAddressSync(s,a)}catch(s){if(s instanceof TypeError)throw s;n++;continue}return{publicKey:o,nonce:n}}throw Rf.logWithError("unable to find a viable program address nonce","params",{programId:a,marketId:e}),new Error("unable to find a viable program address nonce")}function Xr({programId:a}){let{publicKey:e}=ne([Buffer.from("amm_config_account_seed","utf-8")],a);return e}function mo({name:a,programId:e,marketId:t}){let{publicKey:n}=ne([e.toBuffer(),t.toBuffer(),Buffer.from(a,"utf-8")],e);return n}function Of({programId:a,marketId:e}){let{publicKey:t}=ne([a.toBuffer(),e.toBuffer(),Buffer.from("open_order_associated_seed","utf-8")],a);return t}function Za({programId:a}){return ne([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],a)}function $a({version:a,marketVersion:e,marketId:t,baseMint:n,quoteMint:o,baseDecimals:s,quoteDecimals:i,programId:r,marketProgramId:c}){let u=mo({name:"amm_associated_seed",programId:r,marketId:t}),l=mo({name:"lp_mint_associated_seed",programId:r,marketId:t}),{publicKey:m,nonce:p}=Za({programId:r}),d=mo({name:"coin_vault_associated_seed",programId:r,marketId:t}),f=mo({name:"pc_vault_associated_seed",programId:r,marketId:t}),y=mo({name:"temp_lp_token_associated_seed",programId:r,marketId:t}),b=Of({programId:r,marketId:t}),g=mo({name:"target_associated_seed",programId:r,marketId:t}),A=mo({name:"withdraw_associated_seed",programId:r,marketId:t}),{publicKey:h}=Kl({programId:c,marketId:t});return{id:u,baseMint:n,quoteMint:o,lpMint:l,baseDecimals:s,quoteDecimals:i,lpDecimals:s,version:a,programId:r,authority:m,nonce:p,baseVault:d,quoteVault:f,lpVault:y,openOrders:b,targetOrders:g,withdrawQueue:A,marketVersion:e,marketProgramId:c,marketId:t,marketAuthority:h,lookupTableAccount:Fi.default,configId:Xr({programId:r})}}var ja;async function _B({connection:a,poolKeysList:e,config:t,modelDataPubKey:n}){return e.find(s=>s.modelDataAccount)&&(ja||(ja=new _o({connection:a,modelDataPubKey:n}),await ja.initStableModelLayout())),await Promise.all(e.map(async s=>{if(s.modelDataAccount){let i=Tl({poolKeys:s});return(await tc(a,[i.instruction],"GetPoolData")).map(u=>{let l=nc(u,"GetPoolData"),m=new vi(An(l,"status")),p=Number(An(l,"coin_decimals")),d=Number(An(l,"pc_decimals")),f=Number(An(l,"lp_decimals")),y=new vi(An(l,"pool_coin_amount")),b=new vi(An(l,"pool_pc_amount")),g=new vi(An(l,"pool_lp_supply")),A="0";try{A=An(l,"pool_open_time")}catch{}return{status:m,baseDecimals:p,quoteDecimals:d,lpDecimals:f,baseReserve:y,quoteReserve:b,lpSupply:g,startTime:new vi(A)}})[0]}else{let[i,r,c,u]=await a.getMultipleAccountsInfo([new Fi(s.id),new Fi(s.vault.A),new Fi(s.vault.B),new Fi(s.mintLp.address)]);if(i===null)throw Error("fetch pool error");if(r===null)throw Error("fetch vaultAccA error");if(c===null)throw Error("fetch vaultAccB error");if(u===null)throw Error("fetch mintAccLp error");let l=uo.decode(i.data),m=rn.decode(r.data),p=rn.decode(c.data),d=yl.decode(u.data);return{status:l.status,baseDecimals:l.baseDecimal.toNumber(),quoteDecimals:l.quoteDecimal.toNumber(),lpDecimals:d.decimals,baseReserve:m.amount.sub(l.baseNeedTakePnl),quoteReserve:p.amount.sub(l.quoteNeedTakePnl),lpSupply:l.lpReserve,startTime:l.poolOpenTime}}}))}var Ha={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]},zr=a=>{let e={},t=Lf.toBase58();return Object.keys(a).map(n=>{let o=a[n],[s,i]=[o.baseMint.toBase58(),o.quoteMint.toBase58()];e[n]={id:n,version:4,status:o.status.toNumber(),programId:o.programId.toBase58(),mintA:Pt({address:s,programId:t,decimals:o.baseDecimal.toNumber()}),mintB:Pt({address:i,programId:t,decimals:o.quoteDecimal.toNumber()}),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:o.poolPrice.toNumber(),mintAmountA:new Gr(o.mintAAmount.toString()).div(10**o.baseDecimal.toNumber()).toNumber(),mintAmountB:new Gr(o.mintBAmount.toString()).div(10**o.quoteDecimal.toNumber()).toNumber(),baseReserve:o.baseReserve,quoteReserve:o.quoteReserve,feeRate:new Gr(o.tradeFeeNumerator.toString()).div(o.tradeFeeDenominator.toString()).toNumber(),openTime:o.poolOpenTime.toString(),tvl:0,day:Ha,week:Ha,month:Ha,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,type:"Standard",marketId:o.marketId.toBase58(),configId:Xr({programId:o.programId}).toBase58(),lpPrice:0,lpAmount:new Gr(o.lpReserve.toString()).div(10**Math.min(o.baseDecimal.toNumber(),o.quoteDecimal.toNumber())).toNumber(),lpMint:Pt({address:o.lpMint.toBase58(),programId:t,decimals:Math.min(o.baseDecimal.toNumber(),o.quoteDecimal.toNumber())}),burnPercent:0}}),e};import Ge from"bn.js";import Oe from"decimal.js";import{PublicKey as Vi}from"@solana/web3.js";import _i from"bn.js";import{TOKEN_PROGRAM_ID as Ol}from"@solana/spl-token";import{SystemProgram as po,SYSVAR_RENT_PUBKEY as Mf,Transaction as Cl,TransactionInstruction as vf}from"@solana/web3.js";import{createInitializeAccountInstruction as Rl,TOKEN_PROGRAM_ID as Ll}from"@solana/spl-token";function Nf(a="accountFlags"){let e=new Lr(a);return e.addBoolean("initialized"),e.addBoolean("market"),e.addBoolean("openOrders"),e.addBoolean("requestQueue"),e.addBoolean("eventQueue"),e.addBoolean("bids"),e.addBoolean("asks"),e}var Ja=F([Be(5),Nf("accountFlags"),N("ownAddress"),k("vaultSignerNonce"),N("baseMint"),N("quoteMint"),N("baseVault"),k("baseDepositsTotal"),k("baseFeesAccrued"),N("quoteVault"),k("quoteDepositsTotal"),k("quoteFeesAccrued"),k("quoteDustThreshold"),N("requestQueue"),N("eventQueue"),N("bids"),N("asks"),k("baseLotSize"),k("quoteLotSize"),k("feeRateBps"),k("referrerRebatesAccrued"),Be(7)]);function Ff({programId:a,marketInfo:e}){let t=F([W("version"),ft("instruction"),k("baseLotSize"),k("quoteLotSize"),Mt("feeRateBps"),k("vaultSignerNonce"),k("quoteDustThreshold")]),n=[{pubkey:e.id,isSigner:!1,isWritable:!0},{pubkey:e.requestQueue,isSigner:!1,isWritable:!0},{pubkey:e.eventQueue,isSigner:!1,isWritable:!0},{pubkey:e.bids,isSigner:!1,isWritable:!0},{pubkey:e.asks,isSigner:!1,isWritable:!0},{pubkey:e.baseVault,isSigner:!1,isWritable:!0},{pubkey:e.quoteVault,isSigner:!1,isWritable:!0},{pubkey:e.baseMint,isSigner:!1,isWritable:!1},{pubkey:e.quoteMint,isSigner:!1,isWritable:!1},{pubkey:e.authority?e.quoteMint:Mf,isSigner:!1,isWritable:!1}].concat(e.authority?{pubkey:e.authority,isSigner:!1,isWritable:!1}:[]).concat(e.authority&&e.pruneAuthority?{pubkey:e.pruneAuthority,isSigner:!1,isWritable:!1}:[]),o=Buffer.alloc(t.span);return t.encode({version:0,instruction:0,baseLotSize:e.baseLotSize,quoteLotSize:e.quoteLotSize,feeRateBps:e.feeRateBps,vaultSignerNonce:e.vaultSignerNonce,quoteDustThreshold:e.quoteDustThreshold},o),new vf({keys:n,programId:a,data:o})}async function Qr({connection:a,wallet:e,marketInfo:t}){var i,r,c,u,l,m,p,d;let n=new Cl,o=await a.getMinimumBalanceForRentExemption(165);n.add(po.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.baseVault.seed,newAccountPubkey:t.baseVault.publicKey,lamports:o,space:165,programId:Ll}),po.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.quoteVault.seed,newAccountPubkey:t.quoteVault.publicKey,lamports:o,space:165,programId:Ll}),Rl(t.baseVault.publicKey,t.baseMint,t.vaultOwner),Rl(t.quoteVault.publicKey,t.quoteMint,t.vaultOwner),po.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.id.seed,newAccountPubkey:t.id.publicKey,lamports:await a.getMinimumBalanceForRentExemption(Ja.span),space:Ja.span,programId:t.programId}));let s=new Cl;return s.add(po.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.requestQueue.seed,newAccountPubkey:t.requestQueue.publicKey,lamports:t.lowestFeeMarket?6208320:await a.getMinimumBalanceForRentExemption((i=t.requestQueueSpace)!=null?i:5120+12),space:t.lowestFeeMarket?764:(r=t.requestQueueSpace)!=null?r:5120+12,programId:t.programId}),po.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.eventQueue.seed,newAccountPubkey:t.eventQueue.publicKey,lamports:t.lowestFeeMarket?79594560:await a.getMinimumBalanceForRentExemption((c=t.eventQueueSpace)!=null?c:262144+12),space:t.lowestFeeMarket?11308:(u=t.eventQueueSpace)!=null?u:262144+12,programId:t.programId}),po.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.bids.seed,newAccountPubkey:t.bids.publicKey,lamports:t.lowestFeeMarket?101977920:await a.getMinimumBalanceForRentExemption((l=t.orderbookQueueSpace)!=null?l:65536+12),space:t.lowestFeeMarket?14524:(m=t.orderbookQueueSpace)!=null?m:65536+12,programId:t.programId}),po.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.asks.seed,newAccountPubkey:t.asks.publicKey,lamports:t.lowestFeeMarket?101977920:await a.getMinimumBalanceForRentExemption((p=t.orderbookQueueSpace)!=null?p:65536+12),space:t.lowestFeeMarket?14524:(d=t.orderbookQueueSpace)!=null?d:65536+12,programId:t.programId}),Ff({programId:t.programId,marketInfo:{id:t.id.publicKey,requestQueue:t.requestQueue.publicKey,eventQueue:t.eventQueue.publicKey,bids:t.bids.publicKey,asks:t.asks.publicKey,baseVault:t.baseVault.publicKey,quoteVault:t.quoteVault.publicKey,baseMint:t.baseMint,quoteMint:t.quoteMint,baseLotSize:t.baseLotSize,quoteLotSize:t.quoteLotSize,feeRateBps:t.feeRateBps,vaultSignerNonce:t.vaultSignerNonce,quoteDustThreshold:t.quoteDustThreshold}})),[{transaction:n,signer:[],instructionTypes:[U.CreateAccount,U.CreateAccount,U.InitAccount,U.InitAccount]},{transaction:s,signer:[],instructionTypes:[U.CreateAccount,U.CreateAccount,U.CreateAccount,U.CreateAccount,U.CreateAccount,U.InitMarket]}]}var Eo=class extends Ve{async create({baseInfo:e,quoteInfo:t,lotSize:n,tickSize:o,dexProgramId:s,requestQueueSpace:i,eventQueueSpace:r,orderbookQueueSpace:c,lowestFeeMarket:u,assignSeed:l,txVersion:m,computeBudgetConfig:p,txTipConfig:d,feePayer:f}){let y=this.scope.ownerPubKey,b=l?`${e.mint.toBase58().slice(0,10)}-${t.mint.toBase58().slice(0,10)}-${l}`:void 0,g=Ye({fromPublicKey:y,programId:s,assignSeed:b&&`${b}-market`}),A=Ye({fromPublicKey:y,programId:s,assignSeed:b&&`${b}-request`}),h=Ye({fromPublicKey:y,programId:s,assignSeed:b&&`${b}-event`}),I=Ye({fromPublicKey:y,programId:s,assignSeed:b&&`${b}-bids`}),T=Ye({fromPublicKey:y,programId:s,assignSeed:b&&`${b}-asks`}),w=Ye({fromPublicKey:y,programId:Ol,assignSeed:b&&`${b}-baseVault`}),S=Ye({fromPublicKey:y,programId:Ol,assignSeed:b&&`${b}-quoteVault`}),x=0,K=new _i(100);function B(){let X=new _i(0);for(;;)try{return{vaultOwner:Vi.createProgramAddressSync([g.publicKey.toBuffer(),X.toArrayLike(Buffer,"le",8)],s),vaultSignerNonce:X}}catch{if(X.iaddn(1),X.gt(new _i(25555)))throw Error("find vault owner error")}}let{vaultOwner:C,vaultSignerNonce:L}=B(),M=new _i(Math.round(10**e.decimals*n)),R=new _i(Math.round(n*10**t.decimals*o));if(M.eq(et))throw Error("lot size is too small");if(R.eq(et))throw Error("tick size or lot size is too small");let O=await Qr({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:s,id:g,baseMint:e.mint,quoteMint:t.mint,baseVault:w,quoteVault:S,vaultOwner:C,requestQueue:A,eventQueue:h,bids:I,asks:T,feeRateBps:x,quoteDustThreshold:K,vaultSignerNonce:L,baseLotSize:M,quoteLotSize:R,requestQueueSpace:i,eventQueueSpace:r,orderbookQueueSpace:c,lowestFeeMarket:u}}),_=this.createTxBuilder(f);_.addInstruction({instructions:O[0].transaction.instructions,signers:O[0].signer});for await(let X of O.slice(1,O.length))_.addInstruction({instructions:X.transaction.instructions,signers:X.signer,instructionTypes:X.instructionTypes});return m===0?_.sizeCheckBuildV0({computeBudgetConfig:p,address:{marketId:g.publicKey,requestQueue:A.publicKey,eventQueue:h.publicKey,bids:I.publicKey,asks:T.publicKey,baseVault:w.publicKey,quoteVault:S.publicKey,baseMint:new Vi(e.mint),quoteMint:new Vi(t.mint)}}):_.sizeCheckBuild({computeBudgetConfig:p,address:{marketId:g.publicKey,requestQueue:A.publicKey,eventQueue:h.publicKey,bids:I.publicKey,asks:T.publicKey,baseVault:w.publicKey,quoteVault:S.publicKey,baseMint:new Vi(e.mint),quoteMint:new Vi(t.mint)}})}};var Ei=class extends Ve{constructor(t){super(t);this.stableLayout=new _o({connection:this.scope.connection,modelDataPubKey:this.scope.cluster==="mainnet"?void 0:kn.MODEL_DATA_PUBKEY})}async initLayout(){await this.stableLayout.initStableModelLayout()}async load(){this.checkDisabled()}computePairAmount({poolInfo:t,amount:n,slippage:o,baseIn:s}){let i=new Ge(new Oe(n).mul(10**t[s?"mintA":"mintB"].decimals).toFixed(0)),r=Wr(t[s?"mintB":"mintA"]),[c,u]=[new Ge(new Oe(t.mintAmountA).mul(10**t.mintA.decimals).toString()),new Ge(new Oe(t.mintAmountB).mul(10**t.mintB.decimals).toString())],l=new Ge(new Oe(t.lpAmount).mul(10**t.lpMint.decimals).toFixed(0,Oe.ROUND_DOWN));this.logDebug("baseReserve:",c.toString(),"quoteReserve:",u.toString()),this.logDebug("tokenIn:",s?t.mintA.symbol:t.mintB.symbol,"amountIn:",i.toString(),"anotherToken:",s?t.mintB.symbol:t.mintA.symbol,"slippage:",`${o.toSignificant()}%`,"baseReserve",c.toString(),"quoteReserve",u.toString());let m=s?"base":"quote";this.logDebug("input side:",m);let p=et;i.isZero()||(p=m==="base"?yr(i.mul(u),c):yr(i.mul(c),u)),this.logDebug("amountRaw:",p.toString(),"lpAmount:",l.toString());let d=yr(i.mul(l),m==="base"?c:u);this.logDebug("liquidity:",d.toString());let f=new ze(new Ge(1)).add(o),y=new ze(new Ge(1)).sub(o),b=f.mul(p).quotient,g=y.mul(p).quotient,A=new he(r,p),h=new he(r,b),I=new he(r,g);return this.logDebug("anotherAmount:",A.toFixed(),"maxAnotherAmount:",h.toFixed()),{anotherAmount:A,maxAnotherAmount:h,minAnotherAmount:I,liquidity:d}}async getAmmPoolKeys(t){return(await this.scope.api.fetchPoolKeysById({idList:[t]}))[0]}async addLiquidity(t){let{poolInfo:n,poolKeys:o,amountInA:s,amountInB:i,otherAmountMin:r,fixedSide:c,config:u,txVersion:l,computeBudgetConfig:m,txTipConfig:p,feePayer:d}=t;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),this.logDebug("amountInA:",s,"amountInB:",i),(s.isZero()||i.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:s.toFixed(),amountInB:i.toFixed()});let{account:f}=this.scope,{bypassAssociatedCheck:y,checkCreateATAOwner:b}=v({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},u),[g,A]=[s.token,i.token],h=await f.getCreatedTokenAccount({mint:g.mint,associatedOnly:!1}),I=await f.getCreatedTokenAccount({mint:A.mint,associatedOnly:!1});!h&&!I&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",f.tokenAccounts);let T=await f.getCreatedTokenAccount({mint:new tt(n.lpMint.address)}),w=[g,A],S=[h,I],x=[s.raw,i.raw],K=s.token.mint.toBase58()===n.mintA.address?"base":"quote",B="base";["quote","base"].includes(K)||this.logAndCreateError("invalid fixedSide","fixedSide",c),K==="quote"?(w.reverse(),S.reverse(),x.reverse(),B=c==="a"?"quote":"base"):K==="base"&&(B=c==="a"?"base":"quote");let[C,L]=w,[M,R]=S,[O,_]=x,X=o!=null?o:await this.getAmmPoolKeys(n.id),j=this.createTxBuilder(d),te=await f.handleTokenAccount({side:"in",amount:O,mint:C.mint,tokenAccount:M,bypassAssociatedCheck:y,checkCreateATAOwner:b}),{tokenAccount:ae}=te,le=De(te,["tokenAccount"]);j.addInstruction(le);let xe=await f.handleTokenAccount({side:"in",amount:_,mint:L.mint,tokenAccount:R,bypassAssociatedCheck:y,checkCreateATAOwner:b}),{tokenAccount:ie}=xe,de=De(xe,["tokenAccount"]);j.addInstruction(de);let Xe=await f.handleTokenAccount({side:"out",amount:0,mint:new tt(n.lpMint.address),tokenAccount:T,bypassAssociatedCheck:y,checkCreateATAOwner:b}),{tokenAccount:be}=Xe,fe=De(Xe,["tokenAccount"]);return j.addInstruction(fe),j.addInstruction({instructions:[wl({poolInfo:n,poolKeys:X,userKeys:{baseTokenAccount:ae,quoteTokenAccount:ie,lpTokenAccount:be,owner:this.scope.ownerPubKey},baseAmountIn:O,quoteAmountIn:_,otherAmountMin:r.raw,fixedSide:B})],instructionTypes:[n.pooltype.includes("StablePool")?U.AmmV5AddLiquidity:U.AmmV4AddLiquidity],lookupTableAddress:X.lookupTableAccount?[X.lookupTableAccount]:[]}),j.addCustomComputeBudget(m),j.addTipInstruction(p),l===0?await j.buildV0():j.build()}async removeLiquidity(t){this.scope.availability.removeStandardPosition===!1&&this.logAndCreateError("remove liquidity feature disabled in your region");let{poolInfo:n,poolKeys:o,lpAmount:s,baseAmountMin:i,quoteAmountMin:r,config:c,txVersion:u,computeBudgetConfig:l,txTipConfig:m,feePayer:p}=t,d=o!=null?o:await this.getAmmPoolKeys(n.id),[f,y,b]=[new tt(n.mintA.address),new tt(n.mintB.address),new tt(n.lpMint.address)];this.logDebug("lpAmount:",s),this.logDebug("baseAmountMin:",i),this.logDebug("quoteAmountMin:",r),s.isZero()&&this.logAndCreateError("amount must greater than zero","lpAmount",s.toString());let{account:g}=this.scope,A=await g.getCreatedTokenAccount({mint:b,associatedOnly:!1});A||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",g.tokenAccounts);let h=await g.getCreatedTokenAccount({mint:f}),I=await g.getCreatedTokenAccount({mint:y}),T=this.createTxBuilder(p),{bypassAssociatedCheck:w,checkCreateATAOwner:S}=v({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},c),L=await g.handleTokenAccount({side:"out",amount:0,mint:f,tokenAccount:h,bypassAssociatedCheck:w,checkCreateATAOwner:S}),{tokenAccount:x}=L,K=De(L,["tokenAccount"]);T.addInstruction(K);let M=await g.handleTokenAccount({side:"out",amount:0,mint:y,tokenAccount:I,bypassAssociatedCheck:w,checkCreateATAOwner:S}),{tokenAccount:B}=M,C=De(M,["tokenAccount"]);return T.addInstruction(C),T.addInstruction({instructions:[za({poolInfo:n,poolKeys:d,userKeys:{lpTokenAccount:A,baseTokenAccount:x,quoteTokenAccount:B,owner:this.scope.ownerPubKey},lpAmount:s,baseAmountMin:i,quoteAmountMin:r})],lookupTableAddress:d.lookupTableAccount?[d.lookupTableAccount]:[],instructionTypes:[n.pooltype.includes("StablePool")?U.AmmV5RemoveLiquidity:U.AmmV4RemoveLiquidity]}),T.addCustomComputeBudget(l),T.addTipInstruction(m),u===0?await T.buildV0():T.build()}async removeAllLpAndCreateClmmPosition({poolInfo:t,clmmPoolInfo:n,removeLpAmount:o,createPositionInfo:s,farmInfo:i,userFarmLpAmount:r,base:c,computeBudgetConfig:u,payer:l,userAuxiliaryLedgers:m,tokenProgram:p=qn,checkCreateATAOwner:d=!0,getEphemeralSigners:f,txVersion:y,feePayer:b}){if((this.scope.availability.removeStandardPosition===!1||this.scope.availability.createConcentratedPosition===!1)&&this.logAndCreateError("remove liquidity or create position feature disabled in your region"),!(t.mintA.address===n.mintA.address||t.mintA.address===n.mintB.address)||!(t.mintB.address===n.mintA.address||t.mintB.address===n.mintB.address))throw Error("mint check error");let g=this.createTxBuilder(b),A={};for(let X of this.scope.account.tokenAccountRawInfos)(A[X.accountInfo.mint.toString()]===void 0||H(this.scope.ownerPubKey,X.accountInfo.mint,qn).publicKey.equals(X.pubkey))&&(A[X.accountInfo.mint.toString()]=X.pubkey);let h=A[t.lpMint.address];if(h===void 0)throw Error("find lp account error in trade accounts");let I=o.add(r!=null?r:new Ge(0)),T=t.mintA.address===Se.WSOL.mint.toString(),w=t.mintB.address===Se.WSOL.mint.toString(),{account:S,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:qn,mint:new tt(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:T?{payer:this.scope.ownerPubKey}:void 0,skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:!0,checkCreateATAOwner:d});if(g.addInstruction(x||{}),S===void 0)throw new Error("base token account not found");let{account:K,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:qn,mint:new tt(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:w?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!w,notUseTokenAccount:w,associatedOnly:!0,checkCreateATAOwner:d});if(g.addInstruction(B||{}),K===void 0)throw new Error("quote token account not found");if(A[t.mintA.address]=S,A[t.mintB.address]=K,i!==void 0&&!(r!=null&&r.isZero())){let X=Ut[i.programId],j=gt({programId:new tt(i.programId),poolId:new tt(i.id),owner:this.scope.ownerPubKey,version:X}),ae,le=await this.scope.connection.getAccountInfo(j);if(le&&(ae=Oo(X).decode(le.data)),X!==6&&!ae){let{instruction:Xe,instructionType:ve}=wi({id:new tt(i.id),programId:new tt(i.programId),version:X,ledger:j,owner:this.scope.ownerPubKey});g.addInstruction({instructions:[Xe],instructionTypes:[ve]})}let ie=[];for(let Xe of i.rewardInfos){let ve=Xe.mint.address===Se.WSOL.mint.toString();if(A[Xe.mint.address])ie.push(A[Xe.mint.address]);else{let{account:qt,instructionParams:st}=await this.scope.account.getOrCreateTokenAccount({mint:new tt(Xe.mint.address),tokenProgram:p,owner:this.scope.ownerPubKey,skipCloseAccount:!ve,createInfo:{payer:l||this.scope.ownerPubKey},associatedOnly:!0,checkCreateATAOwner:d});qt||this.logAndCreateError("farm reward account not found:",Xe.mint.address),st&&g.addInstruction(st),ie.push(qt)}}let de=(await this.scope.api.fetchFarmKeysById({ids:i.id}))[0],be={userAuxiliaryLedgers:m,amount:r,owner:this.scope.ownerPubKey,farmInfo:i,farmKeys:de,lpAccount:h,rewardAccounts:ie},fe=Ut[i.programId],te=fe===6?Ti(be):fe===5?hi(be):Ii(be),xe={3:U.FarmV3Withdraw,5:U.FarmV5Withdraw,6:U.FarmV6Withdraw};g.addInstruction({instructions:[te],instructionTypes:[xe[fe]]})}let C=await this.getAmmPoolKeys(t.id),L=za({poolInfo:t,poolKeys:C,userKeys:{lpTokenAccount:h,baseTokenAccount:S,quoteTokenAccount:K,owner:this.scope.ownerPubKey},lpAmount:I,baseAmountMin:0,quoteAmountMin:0});g.addInstruction({instructions:[L],instructionTypes:[t.pooltype.includes("StablePool")?U.AmmV5RemoveLiquidity:U.AmmV4RemoveLiquidity],lookupTableAddress:C.lookupTableAccount?[C.lookupTableAccount]:[]});let[M,R]=t.mintA.address===n.mintA.address?[S,K]:[K,S],O=await this.scope.clmm.getClmmPoolKeys(n.id),_=await Re.openPositionFromBaseInstructions(q(v({poolInfo:n,poolKeys:O,ownerInfo:{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:M,tokenAccountB:R},withMetadata:"create"},s),{base:c,getEphemeralSigners:f}));return g.addInstruction({instructions:[..._.instructions],signers:_.signers,instructionTypes:[..._.instructionTypes],lookupTableAddress:O.lookupTableAccount?[O.lookupTableAccount]:[]}),y===0?g.sizeCheckBuildV0({computeBudgetConfig:u}):g.sizeCheckBuild({computeBudgetConfig:u})}async createPoolV4({programId:t,marketInfo:n,baseMintInfo:o,quoteMintInfo:s,baseAmount:i,quoteAmount:r,startTime:c,ownerInfo:u,associatedOnly:l=!1,checkCreateATAOwner:m=!1,tokenProgram:p,txVersion:d,feeDestinationId:f,computeBudgetConfig:y,txTipConfig:b,feePayer:g}){var R;let A=u.feePayer||((R=this.scope.owner)==null?void 0:R.publicKey),h=u.useSOLBalance&&o.mint.equals(Yr),I=u.useSOLBalance&&s.mint.equals(Yr),T=this.createTxBuilder(g),{account:w,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:o.mint,owner:this.scope.ownerPubKey,createInfo:h?{payer:A,amount:i}:void 0,notUseTokenAccount:h,skipCloseAccount:!h,associatedOnly:h?!1:l,checkCreateATAOwner:m});T.addInstruction(S||{});let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:s.mint,owner:this.scope.ownerPubKey,createInfo:I?{payer:A,amount:r}:void 0,notUseTokenAccount:I,skipCloseAccount:!I,associatedOnly:I?!1:l,checkCreateATAOwner:m});if(T.addInstruction(K||{}),w===void 0||x===void 0)throw Error("you don't has some token account");let B=$a({version:4,marketVersion:3,marketId:n.marketId,baseMint:o.mint,quoteMint:s.mint,baseDecimals:o.decimals,quoteDecimals:s.decimals,programId:t,marketProgramId:n.programId}),C={programId:t,ammId:B.id,ammAuthority:B.authority,ammOpenOrders:B.openOrders,lpMint:B.lpMint,coinMint:B.baseMint,pcMint:B.quoteMint,coinVault:B.baseVault,pcVault:B.quoteVault,withdrawQueue:B.withdrawQueue,ammTargetOrders:B.targetOrders,poolTempLp:B.lpVault,marketProgramId:B.marketProgramId,marketId:B.marketId,ammConfigId:B.configId,feeDestinationId:f},{instruction:L,instructionType:M}=Qa(q(v({},C),{userWallet:this.scope.ownerPubKey,userCoinVault:w,userPcVault:x,userLpVault:H(this.scope.ownerPubKey,B.lpMint,p).publicKey,nonce:B.nonce,openTime:c,coinAmount:i,pcAmount:r}));return T.addInstruction({instructions:[L],instructionTypes:[M]}),T.addCustomComputeBudget(y),T.addTipInstruction(b),T.versionBuild({txVersion:d,extInfo:{address:C}})}async createMarketAndPoolV4({programId:t=oi,marketProgram:n=Ws,feeDestinationId:o=qs,tokenProgram:s,baseMintInfo:i,quoteMintInfo:r,baseAmount:c,quoteAmount:u,startTime:l,ownerInfo:m,lowestFeeMarket:p,assignSeed:d,associatedOnly:f=!1,checkCreateATAOwner:y=!1,lotSize:b=1,tickSize:g=.01,txVersion:A,computeBudgetConfig:h,txTipConfig:I,feePayer:T}){var To,As,jo;let w=this.scope.ownerPubKey,S=m.feePayer||((To=this.scope.owner)==null?void 0:To.publicKey),x=m.useSOLBalance&&i.mint.equals(Yr),K=m.useSOLBalance&&r.mint.equals(Yr),B=d?`${i.mint.toBase58().slice(0,7)}-${r.mint.toBase58().slice(0,7)}-${d}`:void 0,C=Ye({fromPublicKey:w,programId:n,assignSeed:B&&`${B}-market`}),L=Ye({fromPublicKey:w,programId:n,assignSeed:B&&`${B}-request`}),M=Ye({fromPublicKey:w,programId:n,assignSeed:B&&`${B}-event`}),R=Ye({fromPublicKey:w,programId:n,assignSeed:B&&`${B}-bids`}),O=Ye({fromPublicKey:w,programId:n,assignSeed:B&&`${B}-asks`}),_=Ye({fromPublicKey:w,programId:qn,assignSeed:B&&`${B}-baseVault`}),X=Ye({fromPublicKey:w,programId:qn,assignSeed:B&&`${B}-quoteVault`}),j=0,ae=new Ge(100);function le(){let Ot=new Ge(0);for(;;)try{return{vaultOwner:tt.createProgramAddressSync([C.publicKey.toBuffer(),Ot.toArrayLike(Buffer,"le",8)],n),vaultSignerNonce:Ot}}catch{if(Ot.iaddn(1),Ot.gt(new Ge(25555)))throw Error("find vault owner error")}}let{vaultOwner:ie,vaultSignerNonce:de}=le(),be=new Ge(Math.round(10**i.decimals*b)),fe=new Ge(Math.round(b*10**r.decimals*g));if(be.eq(et))throw Error("lot size is too small");if(fe.eq(et))throw Error("tick size or lot size is too small");let te=await Qr({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:n,vaultOwner:ie,baseMint:i.mint,quoteMint:r.mint,id:C,baseVault:_,quoteVault:X,requestQueue:L,eventQueue:M,bids:R,asks:O,feeRateBps:j,quoteDustThreshold:ae,vaultSignerNonce:de,baseLotSize:be,quoteLotSize:fe,lowestFeeMarket:p}}),xe=this.createTxBuilder(T);xe.addInstruction({instructions:te[0].transaction.instructions,signers:te[0].signer});for await(let Ot of te.slice(1,te.length))xe.addInstruction({instructions:Ot.transaction.instructions,signers:Ot.signer,instructionTypes:Ot.instructionTypes});let{account:Xe,instructionParams:ve}=await this.scope.account.getOrCreateTokenAccount({mint:i.mint,owner:this.scope.ownerPubKey,createInfo:x?{payer:S,amount:c}:void 0,notUseTokenAccount:x,skipCloseAccount:!x,associatedOnly:x?!1:f,checkCreateATAOwner:y,assignSeed:x&&B?`${B}-wsol`:void 0});xe.addInstruction(ve||{});let{account:qt,instructionParams:st}=await this.scope.account.getOrCreateTokenAccount({mint:r.mint,owner:this.scope.ownerPubKey,createInfo:K?{payer:S,amount:u}:void 0,notUseTokenAccount:K,skipCloseAccount:!K,associatedOnly:K?!1:f,checkCreateATAOwner:y,assignSeed:K&&B?`${B}-wsol`:void 0});if(xe.addInstruction(st||{}),Xe===void 0)throw Error("you don't has base token account");if(qt===void 0)throw Error("you don't has quote token account");let at=$a({version:4,marketVersion:3,marketId:C.publicKey,baseMint:i.mint,quoteMint:r.mint,baseDecimals:i.decimals,quoteDecimals:r.decimals,programId:t,marketProgramId:n}),Qo={programId:t,ammId:at.id,ammAuthority:at.authority,ammOpenOrders:at.openOrders,lpMint:at.lpMint,coinMint:at.baseMint,pcMint:at.quoteMint,coinVault:at.baseVault,pcVault:at.quoteVault,withdrawQueue:at.withdrawQueue,ammTargetOrders:at.targetOrders,poolTempLp:at.lpVault,marketProgramId:at.marketProgramId,marketId:at.marketId,ammConfigId:at.configId,feeDestinationId:o},{instruction:Yo,instructionType:cn}=Qa(q(v({},Qo),{userWallet:this.scope.ownerPubKey,userCoinVault:Xe,userPcVault:qt,userLpVault:H(this.scope.ownerPubKey,at.lpMint,s).publicKey,nonce:at.nonce,openTime:l,coinAmount:c,pcAmount:u}));xe.addInstruction({instructions:[Yo],instructionTypes:[cn]});let wo=x||K?[((As=ve==null?void 0:ve.instructions)==null?void 0:As[0])||((jo=st==null?void 0:st.instructions)==null?void 0:jo[0])].filter(Ot=>!!Ot):void 0;return A===0?xe.sizeCheckBuildV0({computeBudgetConfig:h,splitIns:wo,address:v({requestQueue:L.publicKey,eventQueue:M.publicKey,bids:R.publicKey,asks:O.publicKey,baseVault:_.publicKey,quoteVault:X.publicKey,baseMint:new tt(i.mint),quoteMint:new tt(r.mint)},Qo)}):xe.sizeCheckBuild({computeBudgetConfig:h,splitIns:wo,address:v({requestQueue:L.publicKey,eventQueue:M.publicKey,bids:R.publicKey,asks:O.publicKey,baseVault:_.publicKey,quoteVault:X.publicKey,baseMint:new tt(i.mint),quoteMint:new tt(r.mint)},Qo)})}async getCreatePoolFee({programId:t}){let n=Xr({programId:t}),o=await this.scope.connection.getAccountInfo(n,{dataSlice:{offset:536,length:8}});if(o===null)throw Error("get config account error");return Al.decode(o.data).fee}computeAmountOut({poolInfo:t,amountIn:n,mintIn:o,mintOut:s,slippage:i}){let[r,c]=[o.toString(),s.toString()];if(r!==t.mintA.address&&r!==t.mintB.address)throw new Error("toke not match");if(c!==t.mintA.address&&c!==t.mintB.address)throw new Error("toke not match");let{baseReserve:u,quoteReserve:l}=t,m=[u,l],p=[t.mintA.decimals,t.mintB.decimals],d=r==t.mintA.address?"base":"quote";d==="quote"&&(m.reverse(),p.reverse());let[f,y]=m,[b,g]=p,A=t.version===4,h;if(A)h=new Oe(y.toString()).div(10**g).div(new Oe(f.toString()).div(10**b));else{let M=Sl(this.stableLayout.stableModelData,u.toNumber(),l.toNumber(),!1);d==="quote"?h=new Oe(1e6).div(M*1e6):h=new Oe(M*1e6).div(1e6)}let I=n,T=new Ge(0),w=new Ge(0);if(!I.isZero())if(A){w=St(I.mul(Da),qr);let M=I.sub(w),R=f.add(M);T=y.mul(M).div(R)}else{w=I.mul(new Ge(2)).div(new Ge(1e4));let M=I.sub(w);d==="quote"?T=new Ge(Bl(this.stableLayout.stableModelData,l.toNumber(),u.toNumber(),M.toNumber())):T=new Ge(xl(this.stableLayout.stableModelData,l.toNumber(),u.toNumber(),M.toNumber()))}let S=new Ge(new Oe(T.toString()).mul(1-i).toFixed(0)),x=T,K=S,B=new Oe(T.toString()).div(new Oe(I.sub(w).toString()).toFixed(0));!I.isZero()&&!T.isZero()&&(B=new Oe(T.toString()).div(10**g).div(new Oe(I.sub(w).toString()).div(10**b)));let C=h.sub(B).div(h).mul(100);return{amountOut:x,minAmountOut:K,currentPrice:h,executionPrice:B,priceImpact:C,fee:w}}computeAmountIn({poolInfo:t,amountOut:n,mintIn:o,mintOut:s,slippage:i}){let{baseReserve:r,quoteReserve:c}=t;o.toString()!==t.mintA.address&&o.toString()!==t.mintB.address&&this.logAndCreateError("mintIn does not match pool"),s.toString()!==t.mintA.address&&s.toString()!==t.mintB.address&&this.logAndCreateError("mintOut does not match pool"),this.logDebug("baseReserve:",r.toString()),this.logDebug("quoteReserve:",c.toString());let u=o.toString()===t.mintA.address,[l,m]=u?[t.mintA,t.mintB]:[t.mintB,t.mintA];this.logDebug("currencyOut:",m.symbol||m.address),this.logDebug("amountOut:",new Oe(n.toString()).div(10**m.decimals).toDecimalPlaces(m.decimals).toString(),l.symbol||l.address),this.logDebug("slippage:",`${i*100}%`);let p=[r,c],d=u?"quote":"base";d==="base"&&p.reverse(),this.logDebug("output side:",d);let[f,y]=p,b=new Oe(y.toString()).div(10**t[u?"mintB":"mintA"].decimals).div(new Oe(f.toString()).div(10**t[u?"mintA":"mintB"].decimals));this.logDebug("currentPrice:",`1 ${l.symbol||l.address} \u2248 ${b.toString()} ${m.symbol||m.address}`),this.logDebug("currentPrice invert:",`1 ${m.symbol||m.address} \u2248 ${new Oe(1).div(b).toString()} ${l.symbol||l.address}`);let g=new Ge(0),A=n;if(!A.isZero()){A.gt(y)&&(A=y.sub(new Ge(1)));let K=y.sub(A);g=f.mul(A).div(K).mul(qr).div(qr.sub(Da))}let h=new Ge(new Oe(g.toString()).mul(1+i).toFixed(0)),I=g,T=h;this.logDebug("amountIn:",new Oe(I.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString()),this.logDebug("maxAmountIn:",new Oe(T.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString());let w=null;!g.isZero()&&!A.isZero()&&(w=new Oe(A.toString()).div(10**m.decimals).div(new Oe(g.toString()).div(10**l.decimals)),this.logDebug("executionPrice:",`1 ${m.symbol||m.address} \u2248 ${w.toDecimalPlaces(Math.max(t.mintA.decimals,t.mintB.decimals)).toString()} ${l.symbol||l.address}`),this.logDebug("executionPrice invert:",`1 ${m.symbol||m.address} \u2248 ${new Oe(1).div(w).toDecimalPlaces(Math.max(t.mintA.decimals,t.mintB.decimals)).toString()} ${l.symbol||l.address}`));let S=b.mul(I.toString()),x=S.sub(n.toString()).abs().div(S);return this.logDebug("priceImpact:",`${x.toString()}%`),{amountIn:I,maxAmountIn:T,currentPrice:b,executionPrice:w,priceImpact:x}}async swap({poolInfo:t,poolKeys:n,amountIn:o,amountOut:s,inputMint:i,fixedSide:r,txVersion:c,config:u,computeBudgetConfig:l,txTipConfig:m,feePayer:p}){let d=this.createTxBuilder(p),{associatedOnly:f=!0,inputUseSolBalance:y=!0,outputUseSolBalance:b=!0}=u||{},[g,A]=i===t.mintA.address?[t.mintA,t.mintB]:[t.mintB,t.mintA],h=y&&g.address===Z.toBase58(),I=b&&A.address===Z.toBase58(),{account:T,instructionParams:w}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:qn,mint:new tt(g.address),owner:this.scope.ownerPubKey,createInfo:h?{payer:this.scope.ownerPubKey,amount:o}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:f});d.addInstruction(w||{}),T||this.logAndCreateError("input token account not found",{token:g.symbol||g.address,tokenAccountIn:T,inputTokenUseSolBalance:h,associatedOnly:f});let{account:S,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:qn,mint:new tt(A.address),owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:I?!1:f});d.addInstruction(x||{}),S===void 0&&this.logAndCreateError("output token account not found",{token:A.symbol||A.address,tokenAccountOut:S,outputTokenUseSolBalance:I,associatedOnly:f});let K=n||await this.getAmmPoolKeys(t.id),B=4;return t.pooltype.includes("StablePool")&&(B=5),d.addInstruction({instructions:[Ur({version:B,poolKeys:K,userKeys:{tokenAccountIn:T,tokenAccountOut:S,owner:this.scope.ownerPubKey},amountIn:o,amountOut:s,fixedSide:r})],instructionTypes:[B===4?U.AmmV4SwapBaseIn:U.AmmV5SwapBaseIn]}),d.addCustomComputeBudget(l),d.addTipInstruction(m),d.versionBuild({txVersion:c})}async getRpcPoolInfo(t){return(await this.getRpcPoolInfos([t]))[t]}async getRpcPoolInfos(t,n){let o=await Ne(this.scope.connection,t.map(l=>({pubkey:new tt(l)})),n),s={},i=[];for(let l=0;l<t.length;l++){let m=o[l];if(m===null||!m.accountInfo)throw Error("fetch pool info error: "+String(t[l]));let p=uo.decode(m.accountInfo.data);s[String(t[l])]=q(v({},p),{programId:m.accountInfo.owner}),i.push(p.baseVault,p.quoteVault)}let r={},c=await Ne(this.scope.connection,i.map(l=>({pubkey:new tt(l)})),n);for(let l=0;l<i.length;l++){let m=c[l].accountInfo;if(m===null)throw Error("fetch vault info error: "+i[l]);r[String(i[l])]=new Ge(Vf.decode(m.data).amount.toString())}let u={};for(let[l,m]of Object.entries(s)){let p=r[m.baseVault.toString()].sub(m.baseNeedTakePnl),d=r[m.quoteVault.toString()].sub(m.quoteNeedTakePnl);u[l]=q(v({},m),{baseReserve:p,mintAAmount:r[m.baseVault.toString()],mintBAmount:r[m.quoteVault.toString()],quoteReserve:d,poolPrice:new Oe(d.toString()).div(new Oe(10).pow(m.quoteDecimal.toString())).div(new Oe(p.toString()).div(new Oe(10).pow(m.baseDecimal.toString())))})}return u}async getPoolInfoFromRpc({poolId:t}){let n=await this.getRpcPoolInfo(t),o=zr({[t]:n}),s=o[t],i=await this.scope.tradeV2.computePoolToPoolKeys({pools:[o[t]],ammRpcData:{[t]:n}});return{poolRpcData:n,poolInfo:s,poolKeys:i[0]}}};import{PublicKey as Y}from"@solana/web3.js";import xt from"bn.js";import fo from"decimal.js";import{AccountLayout as Nl,createAssociatedTokenAccountIdempotentInstruction as Ml,TOKEN_2022_PROGRAM_ID as Un,TOKEN_PROGRAM_ID as Di}from"@solana/spl-token";var Wi=class extends Ve{constructor(e){super(e)}async getClmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async createPool(e){var S;let{programId:t,owner:n=((S=this.scope.owner)==null?void 0:S.publicKey)||Y.default,mint1:o,mint2:s,ammConfig:i,initialPrice:r,computeBudgetConfig:c,forerunCreate:u,getObserveState:l,txVersion:m,txTipConfig:p,feePayer:d}=e,f=this.createTxBuilder(d),[y,b,g]=new xt(new Y(o.address).toBuffer()).gt(new xt(new Y(s.address).toBuffer()))?[s,o,new fo(1).div(r)]:[o,s,r],A=re.priceToSqrtPriceX64(g,y.decimals,b.decimals),h=[],I=[];y.programId===Un.toBase58()&&I.push(Ma(t,new Y(y.address)).publicKey),b.programId===Un.toBase58()&&I.push(Ma(t,new Y(b.address)).publicKey),(await this.scope.connection.getMultipleAccountsInfo(I)).forEach((x,K)=>{x&&h.push(I[K])});let w=await Re.createPoolInstructions({connection:this.scope.connection,programId:t,owner:n,mintA:y,mintB:b,ammConfigId:i.id,initialPriceX64:A,forerunCreate:!l&&u,extendMintAccount:h});return f.addInstruction(w),f.addCustomComputeBudget(c),f.addTipInstruction(p),f.versionBuild({txVersion:m,extInfo:{address:q(v({},w.address),{observationId:w.address.observationId.toBase58(),exBitmapAccount:w.address.exBitmapAccount.toBase58(),programId:t.toString(),id:w.address.poolId.toString(),mintA:y,mintB:b,openTime:"0",vault:{A:w.address.mintAVault.toString(),B:w.address.mintBVault.toString()},rewardInfos:[],config:{id:i.id.toString(),index:i.index,protocolFeeRate:i.protocolFeeRate,tradeFeeRate:i.tradeFeeRate,tickSpacing:i.tickSpacing,fundFeeRate:i.fundFeeRate,description:i.description,defaultRange:0,defaultRangePoint:[]}}),mockPoolInfo:v({type:"Concentrated",rewardDefaultPoolInfos:"Clmm",id:w.address.poolId.toString(),mintA:y,mintB:b,feeRate:i.tradeFeeRate,openTime:"0",programId:t.toString(),price:g.toNumber(),config:{id:i.id.toString(),index:i.index,protocolFeeRate:i.protocolFeeRate,tradeFeeRate:i.tradeFeeRate,tickSpacing:i.tickSpacing,fundFeeRate:i.fundFeeRate,description:i.description,defaultRange:0,defaultRangePoint:[]},burnPercent:0},Zc),forerunCreate:u}})}async openPositionFromBase({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:s,base:i,baseAmount:r,otherAmountMax:c,nft2022:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,withMetadata:p="create",getEphemeralSigners:d,computeBudgetConfig:f,txTipConfig:y,txVersion:b,feePayer:g}){this.scope.availability.addConcentratedPosition===!1&&this.logAndCreateError("add position feature disabled in your region"),this.scope.checkOwner();let A=this.createTxBuilder(g),h=null,I=null,T=n.useSOLBalance&&e.mintA.address===Z.toString(),w=n.useSOLBalance&&e.mintB.address===Z.toString(),[S,x]=i==="MintA"?[r,c]:[c,r],{account:K,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new Y(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:T||S.isZero()?{payer:this.scope.ownerPubKey,amount:S}:void 0,skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:T?!1:l,checkCreateATAOwner:m});K&&(h=K),A.addInstruction(B||{});let{account:C,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new Y(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:w||x.isZero()?{payer:this.scope.ownerPubKey,amount:x}:void 0,skipCloseAccount:!w,notUseTokenAccount:w,associatedOnly:w?!1:l,checkCreateATAOwner:m});C&&(I=C),A.addInstruction(L||{}),(!h||!I)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",{ownerTokenAccountA:h==null?void 0:h.toBase58(),ownerTokenAccountB:I==null?void 0:I.toBase58()});let M=t||await this.getClmmPoolKeys(e.id),R=await Re.openPositionFromBaseInstructions({poolInfo:e,poolKeys:M,ownerInfo:q(v({},n),{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:h,tokenAccountB:I}),tickLower:o,tickUpper:s,base:i,baseAmount:r,otherAmountMax:c,withMetadata:p,getEphemeralSigners:d,nft2022:u});return A.addInstruction(R),A.addCustomComputeBudget(f),A.addTipInstruction(y),A.versionBuild({txVersion:b,extInfo:v({},R.address)})}async openPositionFromLiquidity({poolInfo:e,poolKeys:t,ownerInfo:n,amountMaxA:o,amountMaxB:s,tickLower:i,tickUpper:r,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",txVersion:p,computeBudgetConfig:d,txTipConfig:f,getEphemeralSigners:y,nft2022:b,feePayer:g}){this.scope.availability.createConcentratedPosition===!1&&this.logAndCreateError("open position feature disabled in your region");let A=this.createTxBuilder(g),h=null,I=null,T=n.useSOLBalance&&e.mintA.address===Z.toBase58(),w=n.useSOLBalance&&e.mintB.address===Z.toBase58(),{account:S,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new Y(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:T||o.isZero()?{payer:this.scope.ownerPubKey,amount:o}:void 0,skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:T?!1:u,checkCreateATAOwner:l});S&&(h=S),A.addInstruction(x||{});let{account:K,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new Y(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:w||s.isZero()?{payer:this.scope.ownerPubKey,amount:s}:void 0,skipCloseAccount:!w,notUseTokenAccount:w,associatedOnly:w?!1:u,checkCreateATAOwner:l});K&&(I=K),A.addInstruction(B||{}),(h===void 0||I===void 0)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let C=t||await this.getClmmPoolKeys(e.id),L=await Re.openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:C,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:h,tokenAccountB:I},tickLower:i,tickUpper:r,liquidity:c,amountMaxA:o,amountMaxB:s,withMetadata:m,getEphemeralSigners:y,nft2022:b});return A.addInstruction(L),A.addCustomComputeBudget(d),A.addTipInstruction(f),A.versionBuild({txVersion:p,extInfo:{address:L.address}})}async increasePositionFromLiquidity(e){var B;let{poolInfo:t,poolKeys:n,ownerPosition:o,amountMaxA:s,amountMaxB:i,liquidity:r,ownerInfo:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txTipConfig:p,txVersion:d,feePayer:f}=e,y=this.createTxBuilder(f),b,g,A=c.useSOLBalance&&t.mintA.address===Z.toString(),h=c.useSOLBalance&&t.mintB.address===Z.toString(),{account:I,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Y(t.mintA.address),notUseTokenAccount:A,owner:this.scope.ownerPubKey,createInfo:A||s.isZero()?{payer:this.scope.ownerPubKey,amount:s}:void 0,skipCloseAccount:!A,associatedOnly:A?!1:u,checkCreateATAOwner:l});I&&(b=I),y.addInstruction(T||{});let{account:w,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Y(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:h||i.isZero()?{payer:this.scope.ownerPubKey,amount:i}:void 0,notUseTokenAccount:h,skipCloseAccount:!h,associatedOnly:h?!1:u,checkCreateATAOwner:l});w&&(g=w),y.addInstruction(S||{}),!b&&!g&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let x=n!=null?n:await this.getClmmPoolKeys(t.id),K=Re.increasePositionFromLiquidityInstructions({poolInfo:t,poolKeys:x,ownerPosition:o,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g},liquidity:r,amountMaxA:s,amountMaxB:i,nft2022:(B=await this.scope.connection.getAccountInfo(o.nftMint))==null?void 0:B.owner.equals(Un)});return y.addInstruction(K),y.addCustomComputeBudget(m),y.addTipInstruction(p),y.versionBuild({txVersion:d,extInfo:{address:K.address}})}async increasePositionFromBase(e){var K;let{poolInfo:t,ownerPosition:n,base:o,baseAmount:s,otherAmountMax:i,ownerInfo:r,associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:m,txVersion:p,feePayer:d}=e,f=this.createTxBuilder(d),y,b,g=r.useSOLBalance&&t.mintA.address===Z.toString(),A=r.useSOLBalance&&t.mintB.address===Z.toString(),{account:h,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Y(t.mintA.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:g||(o==="MintA"?s:i).isZero()?{payer:this.scope.ownerPubKey,amount:o==="MintA"?s:i}:void 0,skipCloseAccount:!g,associatedOnly:g?!1:c,checkCreateATAOwner:u});h&&(y=h),f.addInstruction(I||{});let{account:T,instructionParams:w}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Y(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:A||(o==="MintA"?i:s).isZero()?{payer:this.scope.ownerPubKey,amount:o==="MintA"?i:s}:void 0,notUseTokenAccount:A,skipCloseAccount:!A,associatedOnly:A?!1:c,checkCreateATAOwner:u});T&&(b=T),f.addInstruction(w||{}),!y&&!b&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let S=await this.getClmmPoolKeys(t.id),x=Re.increasePositionFromBaseInstructions({poolInfo:t,poolKeys:S,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:y,tokenAccountB:b},base:o,baseAmount:s,otherAmountMax:i,nft2022:(K=await this.scope.connection.getAccountInfo(n.nftMint))==null?void 0:K.owner.equals(Un)});return f.addInstruction(x),f.addCustomComputeBudget(l),f.addTipInstruction(m),f.versionBuild({txVersion:p,extInfo:{address:x.address}})}async decreaseLiquidity(e){var M;let{poolInfo:t,poolKeys:n,ownerPosition:o,ownerInfo:s,amountMinA:i,amountMinB:r,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txTipConfig:p,txVersion:d,feePayer:f}=e;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let y=this.createTxBuilder(f),b=s.useSOLBalance&&t.mintA.address===Z.toString(),g=s.useSOLBalance&&t.mintB.address===Z.toString(),A,h,{account:I,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Y(t.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!b,associatedOnly:b?!1:u,checkCreateATAOwner:l});A=I,T&&y.addInstruction(T);let{account:w,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Y(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!g,associatedOnly:g?!1:u,checkCreateATAOwner:l});h=w,S&&y.addInstruction(S);let x=[];for(let R of t.rewardDefaultInfos){let O=s.useSOLBalance&&R.mint.address===Z.toString(),_;if(R.mint.address===t.mintA.address)_=A;else if(R.mint.address===t.mintB.address)_=h;else{let{account:X,instructionParams:j}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Y(R.mint.programId),mint:new Y(R.mint.address),notUseTokenAccount:O,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!O,associatedOnly:O?!1:u,checkCreateATAOwner:l});_=X,j&&y.addInstruction(j)}x.push(_)}!A&&!h&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccountRawInfos);let K=n!=null?n:await this.getClmmPoolKeys(t.id),B=(M=await this.scope.connection.getAccountInfo(o.nftMint))==null?void 0:M.owner.equals(Un),C=await Re.decreaseLiquidityInstructions({poolInfo:t,poolKeys:K,ownerPosition:o,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:A,tokenAccountB:h,rewardAccounts:x},liquidity:c,amountMinA:i,amountMinB:r,nft2022:B});y.addInstruction({instructions:C.instructions,instructionTypes:[U.ClmmDecreasePosition]});let L=v({},C.address);if(s.closePosition){let R=await Re.closePositionInstructions({poolInfo:t,poolKeys:K,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:o,nft2022:B});y.addInstruction({endInstructions:R.instructions,endInstructionTypes:R.instructionTypes}),L=v(v({},L),R.address)}return y.addCustomComputeBudget(m),y.addTipInstruction(p),y.versionBuild({txVersion:d,extInfo:{address:L}})}async lockPosition(e){var f;let{programId:t=Bo,authProgramId:n=ii,poolProgramId:o=Mn,ownerPosition:s,payer:i,computeBudgetConfig:r,txTipConfig:c,txVersion:u,getEphemeralSigners:l,feePayer:m}=e,p=this.createTxBuilder(m),d=await Re.makeLockPositions({programId:t,authProgramId:n,poolProgramId:o,wallet:this.scope.ownerPubKey,payer:i!=null?i:this.scope.ownerPubKey,nftMint:s.nftMint,getEphemeralSigners:l,nft2022:(f=await this.scope.connection.getAccountInfo(s.nftMint))==null?void 0:f.owner.equals(Un)});return p.addInstruction(d),p.addCustomComputeBudget(r),p.addTipInstruction(c),p.versionBuild({txVersion:u,extInfo:d.address})}async harvestLockPosition(e){let{programId:t=Bo,authProgramId:n=ii,clmmProgram:o=Mn,poolKeys:s,lockData:i,ownerInfo:r={useSOLBalance:!0},associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:m,txVersion:p,feePayer:d}=e,f=s||await this.getClmmPoolKeys(i.poolId.toString()),y=this.createTxBuilder(d),b=await this.scope.connection.getAccountInfo(i.positionId);b||this.logger.logWithError("position not found",i.positionId);let g=vo.decode(b.data),A=r.useSOLBalance&&f.mintA.address===Z.toString(),h=r.useSOLBalance&&f.mintB.address===Z.toString(),I,T,{account:w,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:f.mintA.programId,mint:new Y(f.mintA.address),notUseTokenAccount:A,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!A,associatedOnly:A?!1:c,checkCreateATAOwner:u});I=w,S&&y.addInstruction(S);let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:f.mintB.programId,mint:new Y(f.mintB.address),notUseTokenAccount:h,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!h,associatedOnly:h?!1:c,checkCreateATAOwner:u});T=x,K&&y.addInstruction(K);let B={},C=[];for(let ie of f.rewardInfos){let de=r.useSOLBalance&&ie.mint.address===Z.toString(),be=B[ie.mint.address];if(!be){let{account:fe,instructionParams:te}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Y(ie.mint.programId),mint:new Y(ie.mint.address),notUseTokenAccount:de,owner:this.scope.ownerPubKey,skipCloseAccount:!de,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:de?!1:c});be=fe,te&&y.addInstruction(te)}B[ie.mint.address]=be,C.push(be)}let L=Mo(t,i.lockNftMint).publicKey,M=H(this.scope.ownerPubKey,i.lockNftMint,Di).publicKey,R=$.getTickArrayStartIndexByTick(g.tickLower,f.config.tickSpacing),O=$.getTickArrayStartIndexByTick(g.tickUpper,f.config.tickSpacing),{publicKey:_}=Ae(new Y(f.programId),i.poolId,R),{publicKey:X}=Ae(new Y(f.programId),i.poolId,O),{publicKey:j}=sn(new Y(f.programId),i.poolId,g.tickLower,g.tickUpper),ae=[];for(let ie=0;ie<f.rewardInfos.length;ie++)ae.push({poolRewardVault:new Y(f.rewardInfos[ie].vault),ownerRewardVault:C[ie],rewardMint:new Y(f.rewardInfos[ie].mint.address)});let le=await Re.harvestLockPositionInstructionV2({programId:t,auth:n,lockPositionId:L,clmmProgram:o,lockOwner:this.scope.ownerPubKey,lockNftMint:i.lockNftMint,lockNftAccount:M,positionNftAccount:i.nftAccount,positionId:i.positionId,poolId:i.poolId,protocolPosition:j,vaultA:new Y(f.vault.A),vaultB:new Y(f.vault.B),tickArrayLower:_,tickArrayUpper:X,userVaultA:I,userVaultB:T,mintA:new Y(f.mintA.address),mintB:new Y(f.mintB.address),rewardAccounts:ae,exTickArrayBitmap:je(o,i.poolId).publicKey});return y.addInstruction({instructions:[le],instructionTypes:[U.ClmmHarvestLockPosition]}),y.addCustomComputeBudget(l),y.addTipInstruction(m),y.versionBuild({txVersion:p})}async closePosition({poolInfo:e,poolKeys:t,ownerPosition:n,txVersion:o,computeBudgetConfig:s,txTipConfig:i,feePayer:r}){var m;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let c=this.createTxBuilder(r),u=t!=null?t:await this.getClmmPoolKeys(e.id),l=Re.closePositionInstructions({poolInfo:e,poolKeys:u,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:n,nft2022:(m=await this.scope.connection.getAccountInfo(n.nftMint))==null?void 0:m.owner.equals(Un)});return c.addCustomComputeBudget(s),c.addTipInstruction(i),c.addInstruction(l).versionBuild({txVersion:o,extInfo:{address:l.address}})}async initReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:o=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:i,txVersion:r,feePayer:c}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(c),l=t.useSOLBalance&&n.mint.address.toString()===Z.toString(),m=n.perSecond.mul(n.endTime-n.openTime),{account:p,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Y(n.mint.address),mint:new Y(n.mint.address),notUseTokenAccount:!!l,skipCloseAccount:!l,owner:this.scope.ownerPubKey,createInfo:l?{payer:t.feePayer||this.scope.ownerPubKey,amount:new xt(new fo(m.toFixed(0)).gte(m)?m.toFixed(0):m.add(1).toFixed(0))}:void 0,associatedOnly:l?!1:o,checkCreateATAOwner:s});d&&u.addInstruction(d),p||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=await this.getClmmPoolKeys(e.id),y=Re.initRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:p},rewardInfo:{programId:new Y(n.mint.programId),mint:new Y(n.mint.address),openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ce.decimalToX64(n.perSecond)}});return u.addInstruction(y),u.addCustomComputeBudget(i),u.versionBuild({txVersion:r,extInfo:{address:y.address}})}async initRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:o,associatedOnly:s=!0,checkCreateATAOwner:i=!1,computeBudgetConfig:r,txTipConfig:c,txVersion:u,feePayer:l}){for(let d of o)d.endTime<=d.openTime&&this.logAndCreateError("reward time error","rewardInfo",d);let m=this.createTxBuilder(l),p={};for(let d of o){let f=n.useSOLBalance&&d.mint.address===Z.toString(),y=d.perSecond.mul(d.endTime-d.openTime),{account:b,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Y(d.mint.programId),mint:new Y(d.mint.address),notUseTokenAccount:!!f,skipCloseAccount:!f,owner:this.scope.ownerPubKey,createInfo:f?{payer:n.feePayer||this.scope.ownerPubKey,amount:new xt(new fo(y.toFixed(0)).gte(y)?y.toFixed(0):y.add(1).toFixed(0))}:void 0,associatedOnly:f?!1:s,checkCreateATAOwner:i});g&&m.addInstruction(g),b||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let A=t!=null?t:await this.getClmmPoolKeys(e.id),h=Re.initRewardInstructions({poolInfo:e,poolKeys:A,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:b},rewardInfo:{programId:new Y(d.mint.programId),mint:new Y(d.mint.address),openTime:d.openTime,endTime:d.endTime,emissionsPerSecondX64:ce.decimalToX64(d.perSecond)}});p=v(v({},p),h.address),m.addInstruction(h)}return m.addCustomComputeBudget(r),m.addTipInstruction(c),m.versionBuild({txVersion:u,extInfo:{address:p}})}async setReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:o=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:i,txTipConfig:r,txVersion:c,feePayer:u}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let l=this.createTxBuilder(u),m=t.useSOLBalance&&n.mint.equals(Z),{account:p,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:n.programId,mint:n.mint,notUseTokenAccount:m,owner:this.scope.ownerPubKey,createInfo:m?{payer:t.feePayer||this.scope.ownerPubKey,amount:new xt(new fo(n.perSecond.mul(n.endTime-n.openTime).toFixed(0)).gte(n.perSecond.mul(n.endTime-n.openTime))?n.perSecond.mul(n.endTime-n.openTime).toFixed(0):n.perSecond.mul(n.endTime-n.openTime).add(1).toFixed(0))}:void 0,associatedOnly:m?!1:o,checkCreateATAOwner:s});d&&l.addInstruction(d),p||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=await this.getClmmPoolKeys(e.id),y=Re.setRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:p},rewardInfo:{mint:n.mint,openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ce.decimalToX64(n.perSecond)}});return l.addInstruction(y),l.addCustomComputeBudget(i),l.addTipInstruction(r),l.versionBuild({txVersion:c,extInfo:{address:y.address}})}async setRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:o,associatedOnly:s=!0,checkCreateATAOwner:i=!1,computeBudgetConfig:r,txTipConfig:c,txVersion:u,feePayer:l}){let m=this.createTxBuilder(l),p={};for(let d of o){d.endTime<=d.openTime&&this.logAndCreateError("reward time error","rewardInfo",d);let f=n.useSOLBalance&&d.mint.address===Z.toString(),{account:y,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Y(d.mint.programId),mint:new Y(d.mint.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,createInfo:f?{payer:n.feePayer||this.scope.ownerPubKey,amount:new xt(new fo(d.perSecond.mul(d.endTime-d.openTime).toFixed(0)).gte(d.perSecond.mul(d.endTime-d.openTime))?d.perSecond.mul(d.endTime-d.openTime).toFixed(0):d.perSecond.mul(d.endTime-d.openTime).add(1).toFixed(0))}:void 0,associatedOnly:f?!1:s,checkCreateATAOwner:i});b&&m.addInstruction(b),y||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let g=t!=null?t:await this.getClmmPoolKeys(e.id),A=Re.setRewardInstructions({poolInfo:e,poolKeys:g,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:y},rewardInfo:{mint:new Y(d.mint.address),openTime:d.openTime,endTime:d.endTime,emissionsPerSecondX64:ce.decimalToX64(d.perSecond)}});m.addInstruction(A),p=v(v({},p),A.address)}return m.addCustomComputeBudget(r),m.addTipInstruction(c),m.versionBuild({txVersion:u,extInfo:{address:p}})}async collectReward({poolInfo:e,ownerInfo:t,rewardMint:n,associatedOnly:o=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:i,txTipConfig:r,txVersion:c,feePayer:u}){let l=e.rewardDefaultInfos.find(g=>g.mint.address===n.toString());l||this.logAndCreateError("reward mint error","not found reward mint",n);let m=this.createTxBuilder(u),p=t.useSOLBalance&&n.equals(Z),{account:d,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Y(l.mint.programId),mint:n,notUseTokenAccount:p,owner:this.scope.ownerPubKey,skipCloseAccount:!p,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:p?!1:o,checkCreateATAOwner:s});f&&m.addInstruction(f),d||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let y=await this.getClmmPoolKeys(e.id),b=Re.collectRewardInstructions({poolInfo:e,poolKeys:y,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:d},rewardMint:n});return m.addInstruction(b),m.addCustomComputeBudget(i),m.addTipInstruction(r),m.versionBuild({txVersion:c,extInfo:{address:b.address}})}async collectRewards({poolInfo:e,ownerInfo:t,rewardMints:n,associatedOnly:o=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:i,txTipConfig:r,feePayer:c}){let u=this.createTxBuilder(c),l={};for(let m of n){let p=e.rewardDefaultInfos.find(A=>A.mint.address===m.toString());if(!p){this.logAndCreateError("reward mint error","not found reward mint",m);continue}let d=t.useSOLBalance&&m.equals(Z),{account:f,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Y(p.mint.programId),mint:m,notUseTokenAccount:d,owner:this.scope.ownerPubKey,skipCloseAccount:!d,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:d?!1:o,checkCreateATAOwner:s});f||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos),y&&u.addInstruction(y);let b=await this.getClmmPoolKeys(e.id),g=Re.collectRewardInstructions({poolInfo:e,poolKeys:b,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:f},rewardMint:m});u.addInstruction(g),l=v(v({},l),g.address)}return u.addCustomComputeBudget(i),u.addTipInstruction(r),u.build({address:l})}async swap({poolInfo:e,poolKeys:t,inputMint:n,amountIn:o,amountOutMin:s,priceLimit:i,observationId:r,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:p,computeBudgetConfig:d,txTipConfig:f,feePayer:y}){let b=this.createTxBuilder(y),g=n.toString()===e.mintA.address,A=c.useSOLBalance&&e.mintA.address===Z.toBase58(),h=c.useSOLBalance&&e.mintB.address===Z.toBase58(),I;!i||i.equals(new fo(0))?I=g?Xt.add(new xt(1)):zt.sub(new xt(1)):I=re.priceToSqrtPriceX64(i,e.mintA.decimals,e.mintB.decimals);let T;if(!T){let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new Y(e.mintA.address),notUseTokenAccount:A,owner:this.scope.ownerPubKey,skipCloseAccount:!A,createInfo:A||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?o:0}:void 0,associatedOnly:A?!1:l,checkCreateATAOwner:m});T=x,K&&b.addInstruction(K)}let w;if(!w){let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new Y(e.mintB.address),notUseTokenAccount:h,owner:this.scope.ownerPubKey,skipCloseAccount:!h,createInfo:h||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:o}:void 0,associatedOnly:h?!1:l,checkCreateATAOwner:m});w=x,K&&b.addInstruction(K)}(!T||!w)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:T,ownerTokenAccountB:w,mintAUseSOLBalance:A,mintBUseSOLBalance:h,associatedOnly:l});let S=t!=null?t:await this.getClmmPoolKeys(e.id);return b.addInstruction(Re.makeSwapBaseInInstructions({poolInfo:e,poolKeys:S,observationId:r,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:T,tokenAccountB:w},inputMint:new Y(n),amountIn:o,amountOutMin:s,sqrtPriceLimitX64:I,remainingAccounts:u})),b.addCustomComputeBudget(d),b.addTipInstruction(f),b.versionBuild({txVersion:p})}async swapBaseOut({poolInfo:e,poolKeys:t,outputMint:n,amountOut:o,amountInMax:s,priceLimit:i,observationId:r,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:p,computeBudgetConfig:d,txTipConfig:f,feePayer:y}){let b=this.createTxBuilder(y),g=n.toString()===e.mintB.address,A=c.useSOLBalance&&e.mintA.address===Z.toBase58(),h=c.useSOLBalance&&e.mintB.address===Z.toBase58(),I;!i||i.equals(new fo(0))?I=n.toString()===e.mintB.address?Xt.add(new xt(1)):zt.sub(new xt(1)):I=re.priceToSqrtPriceX64(i,e.mintA.decimals,e.mintB.decimals);let T;if(!T){let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new Y(e.mintA.address),notUseTokenAccount:A,owner:this.scope.ownerPubKey,skipCloseAccount:!A,createInfo:A||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?s:0}:void 0,associatedOnly:A?!1:l,checkCreateATAOwner:m});T=x,K&&b.addInstruction(K)}let w;if(!w){let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new Y(e.mintB.address),notUseTokenAccount:h,owner:this.scope.ownerPubKey,skipCloseAccount:!h,createInfo:h||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:s}:void 0,associatedOnly:h?!1:l,checkCreateATAOwner:m});w=x,K&&b.addInstruction(K)}(!T||!w)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:T,ownerTokenAccountB:w,mintAUseSOLBalance:A,mintBUseSOLBalance:h,associatedOnly:l});let S=t!=null?t:await this.getClmmPoolKeys(e.id);return b.addInstruction(Re.makeSwapBaseOutInstructions({poolInfo:e,poolKeys:S,observationId:r,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:T,tokenAccountB:w},outputMint:new Y(n),amountOut:o,amountInMax:s,sqrtPriceLimitX64:I,remainingAccounts:u})),b.addCustomComputeBudget(d),b.addTipInstruction(f),b.versionBuild({txVersion:p})}async harvestAllRewards({allPoolInfo:e,allPositions:t,lockInfo:n,ownerInfo:o,associatedOnly:s=!0,checkCreateATAOwner:i=!1,programId:r,txVersion:c,computeBudgetConfig:u,feePayer:l,lockProgram:m=Bo,lockAuth:p=ii,clmmProgram:d=Mn}){var h,I;let f={};for(let T of this.scope.account.tokenAccountRawInfos)s?H(this.scope.ownerPubKey,T.accountInfo.mint,r).publicKey.equals(T.pubkey)&&(f[T.accountInfo.mint.toString()]=T.pubkey):f[T.accountInfo.mint.toString()]=T.pubkey;let y=Object.values(t).flat().map(T=>T.nftMint),b=await Ne(this.scope.connection,y.map(T=>({pubkey:T}))),g={};b.forEach(T=>{var w,S;g[T.pubkey.toBase58()]=(S=(w=T==null?void 0:T.accountInfo)==null?void 0:w.owner)!=null?S:null});let A=this.createTxBuilder(l);for(let T of Object.values(e)){if(t[T.id]===void 0||!t[T.id].find(R=>!R.liquidity.isZero()||R.rewardInfos.find(O=>!O.rewardAmountOwed.isZero())))continue;let w=T,S=o.useSOLBalance&&w.mintA.address===Z.toString(),x=o.useSOLBalance&&w.mintB.address===Z.toString(),K=f[w.mintA.address];if(!K)if(S){let{account:R,instructionParams:O}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:w.mintA.programId,mint:new Y(w.mintA.address),notUseTokenAccount:S,owner:this.scope.ownerPubKey,skipCloseAccount:!S,createInfo:{payer:o.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:S?!1:s,checkCreateATAOwner:i});K=R,O&&A.addInstruction(O)}else{let R=new Y(w.mintA.address);K=this.scope.account.getAssociatedTokenAccount(R,new Y(w.mintA.programId)),A.addInstruction({instructions:[Ml(this.scope.ownerPubKey,K,this.scope.ownerPubKey,R,new Y(w.mintA.programId))]})}let B=f[w.mintB.address];if(!B)if(x){let{account:R,instructionParams:O}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:w.mintB.programId,mint:new Y(w.mintB.address),notUseTokenAccount:x,owner:this.scope.ownerPubKey,skipCloseAccount:!x,createInfo:{payer:o.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:x?!1:s,checkCreateATAOwner:i});B=R,O&&A.addInstruction(O)}else{let R=new Y(w.mintB.address);B=this.scope.account.getAssociatedTokenAccount(R,new Y(w.mintB.programId)),A.addInstruction({instructions:[Ml(this.scope.ownerPubKey,B,this.scope.ownerPubKey,R,new Y(w.mintB.programId))]})}f[w.mintA.address]=K,f[w.mintB.address]=B;let C=[];for(let R of w.rewardDefaultInfos){let O=o.useSOLBalance&&R.mint.address===Z.toString(),_=f[R.mint.address];if(!_){let{account:X,instructionParams:j}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Y(R.mint.programId),mint:new Y(R.mint.address),notUseTokenAccount:O,owner:this.scope.ownerPubKey,skipCloseAccount:!O,createInfo:{payer:o.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:O?!1:s});_=X,j&&A.addInstruction(j)}f[R.mint.address]=_,C.push(_)}let L=await this.getClmmPoolKeys(w.id),M=[];for(let R=0;R<L.rewardInfos.length;R++)M.push({poolRewardVault:new Y(L.rewardInfos[R].vault),ownerRewardVault:C[R],rewardMint:new Y(L.rewardInfos[R].mint.address)});for(let R of t[T.id]){let O=(h=n==null?void 0:n[T.id])==null?void 0:h[R.nftMint.toBase58()];if(O){let _=H(this.scope.ownerPubKey,O.lockNftMint,Di).publicKey,X=$.getTickArrayStartIndexByTick(R.tickLower,L.config.tickSpacing),j=$.getTickArrayStartIndexByTick(R.tickUpper,L.config.tickSpacing),{publicKey:ae}=Ae(new Y(L.programId),O.poolId,X),{publicKey:le}=Ae(new Y(L.programId),O.poolId,j),{publicKey:ie}=sn(new Y(L.programId),O.poolId,R.tickLower,R.tickUpper),de=Mo(m,O.lockNftMint).publicKey,be=Re.harvestLockPositionInstructionV2({programId:m,auth:p,lockPositionId:de,clmmProgram:d,lockOwner:this.scope.ownerPubKey,lockNftMint:O.lockNftMint,lockNftAccount:_,positionNftAccount:O.nftAccount,positionId:O.positionId,poolId:O.poolId,protocolPosition:ie,vaultA:new Y(L.vault.A),vaultB:new Y(L.vault.B),tickArrayLower:ae,tickArrayUpper:le,userVaultA:K,userVaultB:B,mintA:new Y(L.mintA.address),mintB:new Y(L.mintB.address),rewardAccounts:M,exTickArrayBitmap:je(d,O.poolId).publicKey});A.addInstruction({instructions:[be],instructionTypes:[U.ClmmHarvestLockPosition],lookupTableAddress:L.lookupTableAccount?[L.lookupTableAccount]:[]})}else{let _=Re.decreaseLiquidityInstructions({poolInfo:w,poolKeys:L,ownerPosition:R,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:K,tokenAccountB:B,rewardAccounts:C},liquidity:new xt(0),amountMinA:new xt(0),amountMinB:new xt(0),nft2022:(I=g[R.nftMint.toBase58()])==null?void 0:I.equals(Un)});A.addInstruction(_)}}}return c===0?A.sizeCheckBuildV0({computeBudgetConfig:u}):A.sizeCheckBuild({computeBudgetConfig:u})}async getWhiteListMint({programId:e}){let t=await this.scope.connection.getAccountInfo(Ci(e).publicKey);return t?ll.decode(t.data).whitelistMints.filter(o=>!o.equals(Y.default)):[]}async getOwnerPositionInfo({programId:e=Mn}){await this.scope.account.fetchWalletTokenAccounts();let n=this.scope.account.tokenAccountRawInfos.filter(i=>i.accountInfo.amount.eq(new xt(1))).map(i=>Bt(new Y(e),i.accountInfo.mint).publicKey),o=await this.scope.connection.getMultipleAccountsInfo(n),s=[];return o.forEach(i=>{if(!i)return;let r=vo.decode(i.data);s.push(r)}),s}async getOwnerLockedPositionInfo({programId:e=Bo}){await this.scope.account.fetchWalletTokenAccounts();let n=this.scope.account.tokenAccountRawInfos.filter(c=>c.accountInfo.amount.eq(new xt(1))).map(c=>Mo(new Y(e),c.accountInfo.mint).publicKey),o=await this.scope.connection.getMultipleAccountsInfo(n),s=[];o.forEach(c=>{if(!c)return;let u=ml.decode(c.data);s.push(u)});let i=await this.scope.connection.getMultipleAccountsInfo(s.map(c=>c.positionId)),r=[];return i.forEach(c=>{if(!c)return;let u=vo.decode(c.data);r.push(u)}),s.map((c,u)=>({position:r[u],lockInfo:c}))}async getRpcClmmPoolInfo({poolId:e}){return(await this.getRpcClmmPoolInfos({poolIds:[e]}))[String(e)]}async getRpcClmmPoolInfos({poolIds:e,config:t}){let n=await Ne(this.scope.connection,e.map(s=>({pubkey:new Y(s)})),t),o={};for(let s=0;s<e.length;s++){let i=n[s];if(i===null||!i.accountInfo)throw Error("fetch pool info error: "+String(e[s]));let r=so.decode(i.accountInfo.data),c=re.sqrtPriceX64ToPrice(r.sqrtPriceX64,r.mintDecimalsA,r.mintDecimalsB).toNumber();o[String(e[s])]=q(v({},r),{currentPrice:c,programId:i.accountInfo.owner})}return o}async getComputeClmmPoolInfos({clmmPoolsRpcInfo:e,mintInfos:t}){let n=new Set(Object.keys(e).map(c=>e[c].ammConfig.toBase58())),o=await Ne(this.scope.connection,Array.from(n).map(c=>({pubkey:new Y(c)}))),s={};o.forEach(c=>{!c.accountInfo||(s[c.pubkey.toBase58()]=ul.decode(c.accountInfo.data))});let i=await Me.fetchComputeMultipleClmmInfo({connection:this.scope.connection,rpcDataMap:e,poolList:Object.keys(e).map(c=>{var m,p,d,f;let[u,l]=[e[c].mintA.toBase58(),e[c].mintB.toBase58()];return{id:c,programId:e[c].programId.toBase58(),mintA:Pt({address:u,decimals:e[c].mintDecimalsA,programId:t[u].programId.toBase58()||Di.toBase58(),extensions:{feeConfig:(m=t[u])!=null&&m.feeConfig?Wn((p=t[u])==null?void 0:p.feeConfig):void 0}}),mintB:Pt({address:l,decimals:e[c].mintDecimalsB,programId:t[l].programId.toBase58()||Di.toBase58(),extensions:{feeConfig:(d=t[l])!=null&&d.feeConfig?Wn((f=t[l])==null?void 0:f.feeConfig):void 0}}),price:e[c].currentPrice,config:q(v({},s[e[c].ammConfig.toBase58()]),{id:e[c].ammConfig.toBase58(),fundFeeRate:0,description:"",defaultRange:0,defaultRangePoint:[]})}})}),r=await Me.fetchMultiplePoolTickArrays({connection:this.scope.connection,poolKeys:Object.values(i)});return{computeClmmPoolInfo:i,computePoolTickData:r}}async getPoolInfoFromRpc(e){var l;let t=await this.getRpcClmmPoolInfo({poolId:e}),n=new Set([t.mintA.toBase58(),t.mintB.toBase58()]),o=await ho({connection:this.scope.connection,mints:Array.from(n).map(m=>new Y(m))}),{computeClmmPoolInfo:s,computePoolTickData:i}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:{[e]:t},mintInfos:o}),r=await Ne(this.scope.connection,[{pubkey:t.vaultA},{pubkey:t.vaultB}]),c=sl(s[e]);if(!r[0].accountInfo||!r[1].accountInfo)throw new Error("pool vault data not found");c.mintAmountA=Number(Nl.decode(r[0].accountInfo.data).amount.toString()),c.mintAmountB=Number(Nl.decode((l=r[1].accountInfo)==null?void 0:l.data).amount.toString());let u=q(v({},s[e]),{exBitmapAccount:s[e].exBitmapAccount.toBase58(),observationId:s[e].observationId.toBase58(),id:e,programId:t.programId.toBase58(),openTime:t.startTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},config:c.config,rewardInfos:s[e].rewardInfos.filter(m=>!m.tokenVault.equals(Y.default)).map(m=>({mint:Pt({address:m.tokenMint.toBase58(),programId:Di.toBase58(),decimals:10}),vault:m.tokenVault.toBase58()}))});return{poolInfo:c,poolKeys:u,computePoolInfo:s[e],tickData:i}}};import{PublicKey as z}from"@solana/web3.js";import{AccountLayout as $f,NATIVE_MINT as ns,TOKEN_PROGRAM_ID as _t,createAssociatedTokenAccountIdempotentInstruction as Xl}from"@solana/spl-token";import eu from"bn.js";import $r from"decimal.js-light";import qi from"bn.js";function jr(a,e){if(e.isZero())throw Error("divisor is zero");return a.mod(e)}function _f(a,e){if(e.isZero())throw Error("rhs is zero");let t=a.div(e);if(t.isZero())throw Error("quotient is zero");let n=jr(a,e);return n.gt(Do)&&(t=t.add(new qi(1)),e=a.div(t),n=jr(a,t),n.gt(Do)&&(e=e.add(new qi(1)))),[t,e]}var Do=new qi(0),Hr=class{static swapWithoutFees(e,t,n){let o=t.mul(n),s=t.add(e),[i]=_f(o,s),r=n.sub(i);if(r.isZero())throw Error("destinationAmountSwapped is zero");return{destinationAmountSwapped:r}}static lpTokensToTradingTokens(e,t,n,o,s){let i=e.mul(n).div(t),r=e.mul(o).div(t);if(s===0)return{tokenAmount0:i,tokenAmount1:r};if(s===1)return jr(e.mul(n),t).gt(Do)&&i.gt(Do)&&(i=i.add(new qi(1))),jr(e.mul(o),t).gt(Do)&&r.gt(Do)&&(r=r.add(new qi(1))),{tokenAmount0:i,tokenAmount1:r};throw Error("roundDirection value error")}};var Zr=class{static tradingFee(e,t){return br(e,t,nn)}static protocolFee(e,t){return Fs(e,t,nn)}static fundFee(e,t){return Fs(e,t,nn)}};var vl=(t=>(t[t.Floor=0]="Floor",t[t.Ceiling=1]="Ceiling",t))(vl||{}),Jr=class{static validate_supply(e,t){if(e.isZero())throw Error("tokenAmount0 is zero");if(t.isZero())throw Error("tokenAmount1 is zero")}static swap(e,t,n,o){let s=Zr.tradingFee(e,o),i=e.sub(s),{destinationAmountSwapped:r}=Hr.swapWithoutFees(i,t,n);return{newSwapDestinationAmount:n.sub(r),sourceAmountSwapped:e,destinationAmountSwapped:r,tradeFee:s}}static swapBaseOut({poolMintA:e,poolMintB:t,tradeFeeRate:n,baseReserve:o,quoteReserve:s,outputMint:i,outputAmount:r}){let[c,u,l,m,p]=t.address===i.toString()?[o,s,e.decimals,t.decimals,e.address]:[s,o,t.decimals,e.decimals,t.address],d=new $r(u.toString()).div(10**m).div(new $r(c.toString()).div(10**l)),f=r.gte(u)?u.sub(new eu(1)):r,y=u.sub(f),b=St(c.mul(f),y),g=St(b.mul(new eu(1e6)),new eu(1e6).sub(n)),A=g.sub(b),h=new $r(f.toString()).div(10**m).div(new $r(g.toString()).div(10**l)),I=d.isZero()?0:h.sub(d).div(d).abs().toNumber();return{amountRealOut:f,amountIn:g,amountInWithoutFee:b,tradeFee:A,priceImpact:I}}};import He from"bn.js";import Qt from"decimal.js";import{PublicKey as Xi,TransactionInstruction as yo,Keypair as Yf,SystemProgram as jf}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as _l,TOKEN_2022_PROGRAM_ID as nu,TOKEN_PROGRAM_ID as Gn}from"@solana/spl-token";var Ef=Buffer.from("vault_and_lp_mint_auth_seed","utf8"),Df=Buffer.from("amm_config","utf8"),Wf=Buffer.from("pool","utf8"),qf=Buffer.from("pool_lp_mint","utf8"),Uf=Buffer.from("pool_vault","utf8"),Gf=Buffer.from("observation","utf8");function Wo(a){return ne([Ef],a)}function VS(a,e){return ne([Df,zf(e)],a)}function tu(a,e,t,n){return ne([Wf,e.toBuffer(),t.toBuffer(),n.toBuffer()],a)}function Xf(a,e){return ne([qf,e.toBuffer()],a)}function Fl(a,e,t){return ne([Uf,e.toBuffer(),t.toBuffer()],a)}function Ui(a,e){return ne([Gf,e.toBuffer()],a)}function zf(a){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,a,!1),new Uint8Array(e)}function Vl({poolId:a,programId:e,configId:t,mintA:n,mintB:o}){let s=Wo(e).publicKey,i=a||tu(e,t,n,o).publicKey,r=Xf(e,i).publicKey,c=Fl(e,i,n).publicKey,u=Fl(e,i,o).publicKey,l=Ui(e,i).publicKey;return{poolId:i,configId:t,authority:s,lpMint:r,vaultA:c,vaultB:u,observationId:l}}var Qf=Buffer.from("locked_liquidity","utf8");function Gi(a,e){return ne([Qf,e.toBuffer()],a)}var Hf=ye("Raydium_cpmm"),bo={initialize:[175,175,109,31,13,152,155,237],deposit:[242,35,198,137,82,225,242,182],withdraw:[183,18,70,156,148,109,161,34],swapBaseInput:[143,190,90,218,196,30,51,222],swapBaseOutput:[55,217,98,86,163,74,180,173],lockCpLiquidity:[216,157,29,78,38,51,31,26],collectCpFee:[8,30,51,199,209,184,247,133]};function El(a,e,t,n,o,s,i,r,c,u,l,m,p,d,f,y,b,g,A,h){let I=F([k("amountMaxA"),k("amountMaxB"),k("openTime")]),T=tu(a,t,s,i).publicKey,w=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!o.equals(T),isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:Gn,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:_l,isSigner:!1,isWritable:!1},{pubkey:fr,isSigner:!1,isWritable:!1},{pubkey:nt,isSigner:!1,isWritable:!1}],S=Buffer.alloc(I.span);return I.encode({amountMaxA:g,amountMaxB:A,openTime:h},S),new yo({keys:w,programId:a,data:Buffer.from([...bo.initialize,...S])})}function Dl(a,e,t,n,o,s,i,r,c,u,l,m,p,d,f){let y=F([k("lpAmount"),k("amountMaxA"),k("amountMaxB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Gn,isSigner:!1,isWritable:!1},{pubkey:nu,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0}],g=Buffer.alloc(y.span);return Hf.debug("cpmm deposit data",{lpAmount:p.toString(),amountMaxA:d.toString(),amountMaxB:f.toString()}),y.encode({lpAmount:p,amountMaxA:d,amountMaxB:f},g),new yo({keys:b,programId:a,data:Buffer.from([...bo.deposit,...g])})}function Wl(a,e,t,n,o,s,i,r,c,u,l,m,p,d,f){let y=F([k("lpAmount"),k("amountMinA"),k("amountMinB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Gn,isSigner:!1,isWritable:!1},{pubkey:nu,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:mn,isSigner:!1,isWritable:!1}],g=Buffer.alloc(y.span);return y.encode({lpAmount:p,amountMinA:d,amountMinB:f},g),new yo({keys:b,programId:a,data:Buffer.from([...bo.withdraw,...g])})}function es(a,e,t,n,o,s,i,r,c,u,l,m,p,d,f,y){let b=F([k("amountIn"),k("amounOutMin")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!0}],A=Buffer.alloc(b.span);return b.encode({amountIn:f,amounOutMin:y},A),new yo({keys:g,programId:a,data:Buffer.from([...bo.swapBaseInput,...A])})}function ql(a,e,t,n,o,s,i,r,c,u,l,m,p,d,f,y){let b=F([k("amountInMax"),k("amountOut")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!0}],A=Buffer.alloc(b.span);return b.encode({amountInMax:f,amountOut:y},A),new yo({keys:g,programId:a,data:Buffer.from([...bo.swapBaseOutput,...A])})}async function Ul(a){var b;let{ownerInfo:e,poolInfo:t,poolKeys:n,feeNftOwner:o,getEphemeralSigners:s}=a,i=[],[r,c]=[new Xi(t.id),new Xi(t.lpMint.address)],u;if(s)u=new Xi((await s(1))[0]);else{let g=Yf.generate();i.push(g),u=g.publicKey}let{publicKey:l}=H(o,u,Gn),{publicKey:m}=xn(u),{publicKey:p}=Gi(a.lockProgram,u),{publicKey:d}=H(e.wallet,c,Gn),{publicKey:f}=H(a.lockAuthProgram,c,Gn),y=Zf({programId:a.lockProgram,auth:a.lockAuthProgram,payer:e.feePayer,liquidityOwner:e.wallet,nftOwner:o,nftMint:u,nftAccount:l,poolId:r,lockPda:p,mintLp:c,userLpVault:d,lockLpVault:f,poolVaultA:new Xi(n.vault.A),poolVaultB:new Xi(n.vault.B),metadataAccount:m,lpAmount:a.lpAmount,withMetadata:(b=a.withMetadata)!=null?b:!0});return{address:{nftMint:u,nftAccount:l,metadataAccount:m,lockPda:p,userLpVault:d,lockLpVault:f},instructions:[y],signers:i,instructionTypes:[U.CpmmLockLp],lookupTableAddress:[]}}function Zf({programId:a,auth:e,payer:t,liquidityOwner:n,nftOwner:o,nftMint:s,nftAccount:i,poolId:r,lockPda:c,mintLp:u,userLpVault:l,lockLpVault:m,poolVaultA:p,poolVaultB:d,metadataAccount:f,lpAmount:y,withMetadata:b}){let g=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:nt,isSigner:!1,isWritable:!1},{pubkey:jf.programId,isSigner:!1,isWritable:!1},{pubkey:Gn,isSigner:!1,isWritable:!1},{pubkey:_l,isSigner:!1,isWritable:!1},{pubkey:en,isSigner:!1,isWritable:!1}],A=F([k("lpAmount"),qe("withMetadata")]),h=Buffer.alloc(A.span);A.encode({lpAmount:y,withMetadata:b},h);let I=Buffer.from([...bo.lockCpLiquidity,...h]);return new yo({keys:g,programId:a,data:I})}function ou({programId:a,nftOwner:e,auth:t,nftAccount:n,lockPda:o,poolId:s,mintLp:i,userVaultA:r,userVaultB:c,poolVaultA:u,poolVaultB:l,mintA:m,mintB:p,lockLpVault:d,lpFeeAmount:f,cpmmProgram:y,cpmmAuthProgram:b}){let g=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:y!=null?y:ri,isSigner:!1,isWritable:!1},{pubkey:b!=null?b:Us,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Gn,isSigner:!1,isWritable:!1},{pubkey:nu,isSigner:!1,isWritable:!1},{pubkey:mn,isSigner:!1,isWritable:!1}],A=F([k("lpFeeAmount")]),h=Buffer.alloc(A.span);A.encode({lpFeeAmount:f},h);let I=Buffer.from([...bo.collectCpFee,...h]);return new yo({keys:g,programId:a,data:I})}var Gl=F([Be(8),W("bump"),qe("disableCreatePool"),Mt("index"),k("tradeFeeRate"),k("protocolFeeRate"),k("fundFeeRate"),k("createPoolFee"),N("protocolOwner"),N("fundOwner"),Q(k(),16)]),ts=F([Be(8),N("configId"),N("poolCreator"),N("vaultA"),N("vaultB"),N("mintLp"),N("mintA"),N("mintB"),N("mintProgramA"),N("mintProgramB"),N("observationId"),W("bump"),W("status"),W("lpDecimals"),W("mintDecimalA"),W("mintDecimalB"),k("lpAmount"),k("protocolFeesMintA"),k("protocolFeesMintB"),k("fundFeesMintA"),k("fundFeesMintB"),k("openTime"),Q(k(),32)]);var zi=class extends Ve{constructor(e){super(e)}async load(){this.checkDisabled()}async getCpmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async getRpcPoolInfo(e,t){return(await this.getRpcPoolInfos([e],t))[e]}async getRpcPoolInfos(e,t){let n=await Ne(this.scope.connection,e.map(m=>({pubkey:new z(m)}))),o={},s=new Set,i=[];for(let m=0;m<e.length;m++){let p=n[m];if(p.accountInfo===null)throw Error("fetch pool info error: "+String(e[m]));let d=ts.decode(p.accountInfo.data);o[String(e[m])]=q(v({},d),{programId:p.accountInfo.owner}),s.add(String(d.configId)),i.push(d.vaultA,d.vaultB)}let r={};if(t){let m=[...s],p=await Ne(this.scope.connection,m.map(d=>({pubkey:new z(d)})));for(let d=0;d<m.length;d++){let f=p[d].accountInfo;if(f===null)throw Error("fetch pool config error: "+m[d]);r[m[d]]=Gl.decode(f.data)}}let c={},u=await Ne(this.scope.connection,i.map(m=>({pubkey:new z(m)})));for(let m=0;m<i.length;m++){let p=u[m].accountInfo;if(p===null)throw Error("fetch vault info error: "+i[m]);c[String(i[m])]=new He($f.decode(p.data).amount.toString())}let l={};for(let[m,p]of Object.entries(o)){let d=c[p.vaultA.toString()].sub(p.protocolFeesMintA).sub(p.fundFeesMintA),f=c[p.vaultB.toString()].sub(p.protocolFeesMintB).sub(p.fundFeesMintB);l[m]=q(v({},p),{baseReserve:d,quoteReserve:f,vaultAAmount:c[p.vaultA.toString()],vaultBAmount:c[p.vaultB.toString()],configInfo:r[p.configId.toString()],poolPrice:new Qt(f.toString()).div(new Qt(10).pow(p.mintDecimalB)).div(new Qt(d.toString()).div(new Qt(10).pow(p.mintDecimalA)))})}return l}toComputePoolInfos({pools:e,mintInfos:t}){return Object.keys(e).reduce((n,o)=>{var c,u,l,m;let s=e[o],[i,r]=[s.mintA.toBase58(),s.mintB.toBase58()];return q(v({},n),{[o]:q(v({},s),{id:new z(o),configInfo:s.configInfo,version:7,authority:Wo(s.programId).publicKey,mintA:Pt({address:i,decimals:s.mintDecimalA,programId:s.mintProgramA.toBase58(),extensions:{feeConfig:(c=t[i])!=null&&c.feeConfig?Wn((u=t[i])==null?void 0:u.feeConfig):void 0}}),mintB:Pt({address:r,decimals:s.mintDecimalB,programId:s.mintProgramB.toBase58(),extensions:{feeConfig:(l=t[r])!=null&&l.feeConfig?Wn((m=t[r])==null?void 0:m.feeConfig):void 0}})})})},{})}async getPoolInfoFromRpc(e){let t=await this.getRpcPoolInfo(e,!0),n=await ho({connection:this.scope.connection,mints:[t.mintA,t.mintB]}),o=Pt({address:t.mintA.toBase58(),decimals:t.mintDecimalA,programId:t.mintProgramA.toBase58(),extensions:{feeConfig:n[t.mintA.toBase58()].feeConfig?Wn(n[t.mintA.toBase58()].feeConfig):void 0}}),s=Pt({address:t.mintB.toBase58(),decimals:t.mintDecimalB,programId:t.mintProgramB.toBase58(),extensions:{feeConfig:n[t.mintB.toBase58()].feeConfig?Wn(n[t.mintB.toBase58()].feeConfig):void 0}}),i=Pt({address:t.mintLp.toBase58(),decimals:t.lpDecimals,programId:_t.toBase58()}),r={id:t.configId.toBase58(),index:t.configInfo.index,protocolFeeRate:t.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:t.configInfo.tradeFeeRate.toNumber(),fundFeeRate:t.configInfo.fundFeeRate.toNumber(),createPoolFee:t.configInfo.createPoolFee.toString()},c={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};return{poolInfo:{programId:t.programId.toBase58(),id:e,type:"Standard",lpMint:i,lpPrice:0,lpAmount:t.lpAmount.toNumber(),config:r,mintA:o,mintB:s,rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:t.poolPrice.toNumber(),mintAmountA:new Qt(t.vaultAAmount.toString()).div(10**o.decimals).toNumber(),mintAmountB:new Qt(t.vaultBAmount.toString()).div(10**s.decimals).toNumber(),feeRate:t.configInfo.tradeFeeRate.toNumber(),openTime:t.openTime.toString(),tvl:0,burnPercent:0,day:c,week:c,month:c,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0},poolKeys:{programId:t.programId.toBase58(),id:e,mintA:o,mintB:s,openTime:t.openTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},authority:Wo(t.programId).publicKey.toBase58(),mintLp:i,config:r,observationId:Ui(t.programId,new z(e)).publicKey.toBase58()},rpcData:t}}async createPool(f){var y=f,{poolId:e,programId:t,poolFeeAccount:n,startTime:o,ownerInfo:s,associatedOnly:i=!1,checkCreateATAOwner:r=!1,txVersion:c,feeConfig:u,computeBudgetConfig:l,txTipConfig:m,feePayer:p}=y,d=De(y,["poolId","programId","poolFeeAccount","startTime","ownerInfo","associatedOnly","checkCreateATAOwner","txVersion","feeConfig","computeBudgetConfig","txTipConfig","feePayer"]);var _,X,j;let b=s.feePayer||((_=this.scope.owner)==null?void 0:_.publicKey),g=new He(new z(d.mintA.address).toBuffer()).lte(new He(new z(d.mintB.address).toBuffer())),[A,h]=g?[d.mintA,d.mintB]:[d.mintB,d.mintA],[I,T]=g?[d.mintAAmount,d.mintBAmount]:[d.mintBAmount,d.mintAAmount],w=s.useSOLBalance&&A.address===ns.toBase58(),S=s.useSOLBalance&&h.address===ns.toBase58(),[x,K]=[new z(A.address),new z(h.address)],B=this.createTxBuilder(p),{account:C,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({mint:x,tokenProgram:A.programId,owner:this.scope.ownerPubKey,createInfo:w?{payer:b,amount:I}:void 0,notUseTokenAccount:w,skipCloseAccount:!w,associatedOnly:w?!1:i,checkCreateATAOwner:r});B.addInstruction(L||{});let{account:M,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({mint:new z(h.address),tokenProgram:h.programId,owner:this.scope.ownerPubKey,createInfo:S?{payer:b,amount:T}:void 0,notUseTokenAccount:S,skipCloseAccount:!S,associatedOnly:S?!1:i,checkCreateATAOwner:r});if(B.addInstruction(R||{}),C===void 0||M===void 0)throw Error("you don't has some token account");let O=Vl({poolId:e,programId:t,configId:new z(u.id),mintA:x,mintB:K});return B.addInstruction({instructions:[El(t,this.scope.ownerPubKey,new z(u.id),O.authority,O.poolId,x,K,O.lpMint,C,M,H(this.scope.ownerPubKey,O.lpMint).publicKey,O.vaultA,O.vaultB,n,new z((X=A.programId)!=null?X:_t),new z((j=h.programId)!=null?j:_t),O.observationId,I,T,o)],instructionTypes:[U.CpmmCreatePool]}),B.addCustomComputeBudget(l),B.addTipInstruction(m),B.versionBuild({txVersion:c,extInfo:{address:q(v({},O),{mintA:A,mintB:h,programId:t,poolFeeAccount:n,feeConfig:u})}})}async addLiquidity(e){let{poolInfo:t,poolKeys:n,inputAmount:o,baseIn:s,slippage:i,computeResult:r,computeBudgetConfig:c,txTipConfig:u,config:l,txVersion:m,feePayer:p}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),o.isZero()&&this.logAndCreateError("amounts must greater than zero","amountInA",{amountInA:o.toString()});let{account:d}=this.scope,{bypassAssociatedCheck:f,checkCreateATAOwner:y}=v({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},l),b=r?void 0:await this.getRpcPoolInfo(t.id),{liquidity:g,inputAmountFee:A,anotherAmount:h}=r||this.computePairAmount({poolInfo:q(v({},t),{lpAmount:new Qt(b.lpAmount.toString()).div(10**t.lpMint.decimals).toNumber()}),baseReserve:b.baseReserve,quoteReserve:b.quoteReserve,slippage:new ze(0),baseIn:s,epochInfo:await this.scope.fetchEpochInfo(),amount:new Qt(o.toString()).div(10**(s?t.mintA.decimals:t.mintB.decimals))}),I=h.amount,T=t.mintA.address===ns.toString(),w=t.mintB.address===ns.toString(),S=this.createTxBuilder(p),[x,K]=[new z(t.mintA.address),new z(t.mintB.address)],{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:T||(s?o:I).isZero()?{payer:this.scope.ownerPubKey,amount:s?o:I}:void 0,skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:!1,checkCreateATAOwner:y});S.addInstruction(C||{});let{account:L,instructionParams:M}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:w||(s?I:o).isZero()?{payer:this.scope.ownerPubKey,amount:s?I:o}:void 0,skipCloseAccount:!w,notUseTokenAccount:w,associatedOnly:!1,checkCreateATAOwner:y});S.addInstruction(M||{}),!B&&!L&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",d.tokenAccounts);let R=await d.getCreatedTokenAccount({mint:new z(t.lpMint.address)}),ae=await d.handleTokenAccount({side:"out",amount:0,mint:new z(t.lpMint.address),tokenAccount:R,bypassAssociatedCheck:f,checkCreateATAOwner:y}),{tokenAccount:O}=ae,_=De(ae,["tokenAccount"]);S.addInstruction(_);let X=n!=null?n:await this.getCpmmPoolKeys(t.id),j=new ze(new He(1)).sub(i);return S.addInstruction({instructions:[Dl(new z(t.programId),this.scope.ownerPubKey,new z(X.authority),new z(t.id),O,B,L,new z(X.vault.A),new z(X.vault.B),x,K,new z(t.lpMint.address),r?r==null?void 0:r.liquidity:j.mul(g).quotient,s?A.amount:I,s?I:A.amount)],instructionTypes:[U.CpmmAddLiquidity],lookupTableAddress:X.lookupTableAccount?[X.lookupTableAccount]:[]}),S.addCustomComputeBudget(c),S.addTipInstruction(u),S.versionBuild({txVersion:m})}async withdrawLiquidity(e){var _,X;let{poolInfo:t,poolKeys:n,lpAmount:o,slippage:s,computeBudgetConfig:i,txTipConfig:r,txVersion:c,feePayer:u,closeWsol:l=!0}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region");let m=new ze(new He(1)).sub(s),p=await this.getRpcPoolInfo(t.id),[d,f]=[m.mul(o.mul(p.baseReserve).div(p.lpAmount)).quotient,m.mul(o.mul(p.quoteReserve).div(p.lpAmount)).quotient],y=await this.scope.fetchEpochInfo(),[b,g]=[Ie(d,t.mintA.extensions.feeConfig,y,!1),Ie(f,t.mintB.extensions.feeConfig,y,!1)],{account:A}=this.scope,h=this.createTxBuilder(u),[I,T]=[new z(t.mintA.address),new z(t.mintB.address)],w=I.equals(Z),S=T.equals(Z),x,K,{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(w&&l),associatedOnly:!w,checkCreateATAOwner:!1});x=B,C&&h.addInstruction(C);let{account:L,instructionParams:M}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),notUseTokenAccount:S,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(S&&l),associatedOnly:!S,checkCreateATAOwner:!1});K=L,M&&h.addInstruction(M),(!x||!K)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",A.tokenAccounts);let R=await A.getCreatedTokenAccount({mint:new z(t.lpMint.address)});R||this.logAndCreateError("cannot found lp token account","tokenAccounts",A.tokenAccounts);let O=n!=null?n:await this.getCpmmPoolKeys(t.id);return h.addInstruction({instructions:[Wl(new z(t.programId),this.scope.ownerPubKey,new z(O.authority),new z(t.id),R,x,K,new z(O.vault.A),new z(O.vault.B),I,T,new z(t.lpMint.address),o,d.sub((_=b.fee)!=null?_:new He(0)),f.sub((X=g.fee)!=null?X:new He(0)))],instructionTypes:[U.CpmmWithdrawLiquidity],lookupTableAddress:O.lookupTableAccount?[O.lookupTableAccount]:[]}),h.addCustomComputeBudget(i),h.addTipInstruction(r),h.versionBuild({txVersion:c})}async swap(e){var C,L,M,R,O,_;let{poolInfo:t,poolKeys:n,baseIn:o,fixedOut:s,inputAmount:i,swapResult:r,slippage:c=0,config:u,computeBudgetConfig:l,txTipConfig:m,txVersion:p,feePayer:d}=e,{bypassAssociatedCheck:f,checkCreateATAOwner:y,associatedOnly:b}=v({bypassAssociatedCheck:!1,checkCreateATAOwner:!1,associatedOnly:!0},u),g=this.createTxBuilder(d),[A,h]=[new z(t.mintA.address),new z(t.mintB.address)];s?r.sourceAmountSwapped=r.sourceAmountSwapped.mul(new He((1+c)*1e4)).div(new He(1e4)):r.destinationAmountSwapped=r.destinationAmountSwapped.mul(new He((1-c)*1e4)).div(new He(1e4));let I=t.mintA.address===Z.toBase58(),T=t.mintB.address===Z.toBase58(),{account:w,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:A,tokenProgram:new z((C=t.mintA.programId)!=null?C:_t),owner:this.scope.ownerPubKey,createInfo:I||!o?{payer:this.scope.ownerPubKey,amount:o?r.sourceAmountSwapped:0}:void 0,notUseTokenAccount:I,skipCloseAccount:!I,associatedOnly:I?!1:b,checkCreateATAOwner:y});S&&g.addInstruction(S);let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:h,tokenProgram:new z((L=t.mintB.programId)!=null?L:_t),owner:this.scope.ownerPubKey,createInfo:T||o?{payer:this.scope.ownerPubKey,amount:o?0:r.sourceAmountSwapped}:void 0,notUseTokenAccount:T,skipCloseAccount:!T,associatedOnly:T?!1:b,checkCreateATAOwner:y});K&&g.addInstruction(K),(!w||!x)&&this.logAndCreateError("user do not have token account",{mintA:t.mintA.symbol||t.mintA.address,mintB:t.mintB.symbol||t.mintB.address,mintATokenAcc:w,mintBTokenAcc:x,mintAUseSOLBalance:I,mintBUseSOLBalance:T,associatedOnly:b});let B=n!=null?n:await this.getCpmmPoolKeys(t.id);return g.addInstruction({instructions:[s?ql(new z(t.programId),this.scope.ownerPubKey,new z(B.authority),new z(B.config.id),new z(t.id),o?w:x,o?x:w,new z(B.vault[o?"A":"B"]),new z(B.vault[o?"B":"A"]),new z((O=t[o?"mintA":"mintB"].programId)!=null?O:_t),new z((_=t[o?"mintB":"mintA"].programId)!=null?_:_t),o?A:h,o?h:A,Ui(new z(t.programId),new z(t.id)).publicKey,r.sourceAmountSwapped,r.destinationAmountSwapped):es(new z(t.programId),this.scope.ownerPubKey,new z(B.authority),new z(B.config.id),new z(t.id),o?w:x,o?x:w,new z(B.vault[o?"A":"B"]),new z(B.vault[o?"B":"A"]),new z((M=t[o?"mintA":"mintB"].programId)!=null?M:_t),new z((R=t[o?"mintB":"mintA"].programId)!=null?R:_t),o?A:h,o?h:A,Ui(new z(t.programId),new z(t.id)).publicKey,i,r.destinationAmountSwapped)],instructionTypes:[s?U.CpmmSwapBaseOut:U.ClmmSwapBaseIn]}),g.addCustomComputeBudget(l),g.addTipInstruction(m),g.versionBuild({txVersion:p})}async lockLp(e){var p,d,f,y,b;let{poolInfo:t,lpAmount:n,computeBudgetConfig:o,txTipConfig:s,txVersion:i,feePayer:r,feeNftOwner:c}=e;n.isZero()&&this.logAndCreateError("lpAmount must greater than zero",{lpAmount:n.toString()});let u=this.createTxBuilder(r),l=(p=e.poolKeys)!=null?p:await this.getCpmmPoolKeys(t.id),m=await Ul({poolInfo:t,poolKeys:l,ownerInfo:{wallet:this.scope.ownerPubKey,feePayer:(d=e.feePayer)!=null?d:this.scope.ownerPubKey},feeNftOwner:c!=null?c:this.scope.ownerPubKey,lockProgram:(f=e.programId)!=null?f:si,lockAuthProgram:(y=e.authProgram)!=null?y:ai,lpAmount:n,withMetadata:(b=e.withMetadata)!=null?b:!0,getEphemeralSigners:e.getEphemeralSigners});return u.addInstruction(m),u.addCustomComputeBudget(o),u.addTipInstruction(s),u.versionBuild({txVersion:i,extInfo:m.address})}async harvestLockLp(e){var L;let{poolInfo:t,lpFeeAmount:n,nftMint:o,programId:s=si,authProgram:i=ai,cpmmProgram:r,computeBudgetConfig:c,txTipConfig:u,txVersion:l,closeWsol:m=!0}=e;n.isZero()&&this.logAndCreateError("lpFeeAmount must greater than zero",{lpAmount:n.toString()});let p=e.feePayer||this.scope.ownerPubKey,d=this.createTxBuilder(p),[f,y]=[new z(t.mintA.address),new z(t.mintB.address)],b=f.equals(Z),g=y.equals(Z),A,h,{account:I,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(b&&m),associatedOnly:!b,checkCreateATAOwner:!1});A=I,T&&d.addInstruction(T);let{account:w,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(g&&m),associatedOnly:!g,checkCreateATAOwner:!1});h=w,S&&d.addInstruction(S),(!A||!h)&&this.logAndCreateError("cannot found target token accounts",{tokenAccountA:A,tokenAccountB:h});let x=(L=e.poolKeys)!=null?L:await this.getCpmmPoolKeys(t.id),{publicKey:K}=H(p,o,_t),{publicKey:B}=Gi(s,o),{publicKey:C}=H(i,new z(t.lpMint.address),_t);return d.addInstruction({instructions:[ou({programId:s,nftOwner:this.scope.ownerPubKey,auth:i,nftMint:o,nftAccount:K,lockPda:B,poolId:new z(t.id),mintLp:new z(x.mintLp.address),userVaultA:A,userVaultB:h,poolVaultA:new z(x.vault.A),poolVaultB:new z(x.vault.B),mintA:f,mintB:y,lockLpVault:C,lpFeeAmount:n,cpmmProgram:r==null?void 0:r.programId,cpmmAuthProgram:r==null?void 0:r.authProgram})],instructionTypes:[U.CpmmCollectLockFee]}),d.addCustomComputeBudget(c),d.addTipInstruction(u),d.versionBuild({txVersion:l})}async harvestMultiLockLp(e){let{lockInfo:t,programId:n=si,authProgram:o=ai,cpmmProgram:s,computeBudgetConfig:i,txVersion:r,closeWsol:c=!0}=e,u=e.feePayer||this.scope.ownerPubKey,l=this.createTxBuilder(u),m={};return t.forEach(async p=>{var B;let{poolInfo:d,lpFeeAmount:f,nftMint:y}=p;if(f.isZero())return;let[b,g]=[new z(d.mintA.address),new z(d.mintB.address)],A=b.equals(Z),h=g.equals(Z),I=m[d.mintA.address],T=m[d.mintB.address];if(!I)if(A){let{account:C,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:d.mintA.programId,mint:new z(d.mintA.address),notUseTokenAccount:!0,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!c,associatedOnly:!1,checkCreateATAOwner:!1});I=C,L&&l.addInstruction(L),m[d.mintA.address]=C}else{let C=new z(d.mintA.address);I=this.scope.account.getAssociatedTokenAccount(C,new z(d.mintA.programId)),l.addInstruction({instructions:[Xl(this.scope.ownerPubKey,I,this.scope.ownerPubKey,C)]}),m[d.mintA.address]=I}if(!T)if(h){let{account:C,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:d.mintB.programId,mint:new z(d.mintB.address),notUseTokenAccount:!0,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!c,associatedOnly:!1,checkCreateATAOwner:!1});T=C,L&&l.addInstruction(L),m[d.mintB.address]=C}else{let C=new z(d.mintB.address);T=this.scope.account.getAssociatedTokenAccount(C,new z(d.mintB.programId)),l.addInstruction({instructions:[Xl(this.scope.ownerPubKey,T,this.scope.ownerPubKey,C)]}),m[d.mintB.address]=T}(!I||!T)&&this.logAndCreateError("cannot found target token accounts",{tokenAccountA:I,tokenAccountB:T});let w=(B=p.poolKeys)!=null?B:await this.getCpmmPoolKeys(d.id),{publicKey:S}=H(u,y,_t),{publicKey:x}=Gi(n,y),{publicKey:K}=H(o,new z(d.lpMint.address),_t);l.addInstruction({instructions:[ou({programId:n,nftOwner:this.scope.ownerPubKey,auth:o,nftMint:y,nftAccount:S,lockPda:x,poolId:new z(d.id),mintLp:new z(w.mintLp.address),userVaultA:I,userVaultB:T,poolVaultA:new z(w.vault.A),poolVaultB:new z(w.vault.B),mintA:b,mintB:g,lockLpVault:K,lpFeeAmount:f,cpmmProgram:s==null?void 0:s.programId,cpmmAuthProgram:s==null?void 0:s.authProgram})],instructionTypes:[U.CpmmCollectLockFee]})}),r===0?l.sizeCheckBuildV0({computeBudgetConfig:i}):l.sizeCheckBuild({computeBudgetConfig:i})}computeSwapAmount({pool:e,amountIn:t,outputMint:n,slippage:o}){let s=n.toString()===e.mintB.address,i=Jr.swap(t,s?e.baseReserve:e.quoteReserve,s?e.quoteReserve:e.baseReserve,e.configInfo.tradeFeeRate),r=new Qt(i.destinationAmountSwapped.toString()).div(i.sourceAmountSwapped.toString()),c=i.destinationAmountSwapped.mul(new He((1-o)*1e4)).div(new He(1e4));return{allTrade:i.sourceAmountSwapped.eq(t),amountIn:t,amountOut:i.destinationAmountSwapped,minAmountOut:c,executionPrice:r,fee:i.tradeFee,priceImpact:e.poolPrice.sub(r).div(e.poolPrice)}}computePairAmount({poolInfo:e,baseReserve:t,quoteReserve:n,amount:o,slippage:s,epochInfo:i,baseIn:r}){var I,T,w,S,x,K,B,C,L;let c=1-Number(s.toSignificant())/100,u=new He(new Qt(o).mul(10**e[r?"mintA":"mintB"].decimals).mul(c).toFixed(0)),l=Ie(u,e[r?"mintA":"mintB"].extensions.feeConfig,i,!1),m=u.sub((I=l.fee)!=null?I:new He(0)),p=new He(new Qt(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,Qt.ROUND_DOWN));this.logDebug("baseReserve:",t.toString(),"quoteReserve:",n.toString()),this.logDebug("tokenIn:",r?e.mintA.symbol:e.mintB.symbol,"amountIn:",u.toString(),"amountInFee:",(w=(T=l.fee)==null?void 0:T.toString())!=null?w:0,"anotherToken:",r?e.mintB.symbol:e.mintA.symbol,"slippage:",`${s.toSignificant()}%`);let d=r?"base":"quote";this.logDebug("input side:",d);let f=m.mul(p).div(d==="base"?t:n),y={amount:et,fee:void 0,expirationTime:void 0};if(!m.isZero()){let M=Jf(f,t,n,p);this.logDebug("lpAmountData:",{amountA:M.amountA.toString(),amountB:M.amountB.toString()}),y=Ie(M[r?"amountB":"amountA"],e[r?"mintB":"mintA"].extensions.feeConfig,i,!0)}let b=new ze(new He(1)).add(s),g=new ze(new He(1)).sub(s),A=Ie(b.mul(y.amount.sub((S=y.fee)!=null?S:new He(0))).quotient,e[r?"mintB":"mintA"].extensions.feeConfig,i,!0),h=Ie(g.mul(y.amount.sub((x=y.fee)!=null?x:new He(0))).quotient,e[r?"mintB":"mintA"].extensions.feeConfig,i,!0);return this.logDebug("anotherAmount:",y.amount.toString(),"anotherAmountFee:",(B=(K=y.fee)==null?void 0:K.toString())!=null?B:0,"maxAnotherAmount:",A.amount.toString(),"maxAnotherAmountFee:",(L=(C=A.fee)==null?void 0:C.toString())!=null?L:0),{inputAmountFee:l,anotherAmount:y,maxAnotherAmount:A,minAnotherAmount:h,liquidity:f}}};function Jf(a,e,t,n){let o=a.mul(e).div(n);!o.isZero()&&!a.mul(e).mod(n).isZero()&&(o=o.add(new He(1)));let s=a.mul(t).div(n);return!s.isZero()&&!a.mul(t).mod(n).isZero()&&(s=s.add(new He(1))),{amountA:o,amountB:s}}import{PublicKey as go}from"@solana/web3.js";import{createTransferInstruction as Zl,TOKEN_PROGRAM_ID as Ze,TOKEN_2022_PROGRAM_ID as rs}from"@solana/spl-token";import ss from"bn.js";import ji from"decimal.js";var zl={[kr.toBase58()]:3},Ql={3:kr};var iu=F([Be(5),Be(8),N("ownAddress"),k("vaultSignerNonce"),N("baseMint"),N("quoteMint"),N("baseVault"),k("baseDepositsTotal"),k("baseFeesAccrued"),N("quoteVault"),k("quoteDepositsTotal"),k("quoteFeesAccrued"),k("quoteDustThreshold"),N("requestQueue"),N("eventQueue"),N("bids"),N("asks"),k("baseLotSize"),k("quoteLotSize"),k("feeRateBps"),k("referrerRebatesAccrued"),Be(7)]),Yl={3:iu};import{PublicKey as jl}from"@solana/web3.js";var os=ye("Serum"),is=class{static getProgramId(e){let t=Ql[e];return t||os.logWithError("invalid version","version",e),t}static getVersion(e){let t=e.toBase58(),n=zl[t];return n||os.logWithError("invalid program id","programId",t),n}static getStateLayout(e){let t=Yl[e];return t||os.logWithError(!!t,"invalid version","version",e),t}static getLayouts(e){return{state:this.getStateLayout(e)}}static getAssociatedAuthority({programId:e,marketId:t}){let n=[t.toBuffer()],o=0,s;for(;o<100;){try{let i=n.concat(Buffer.from([o]),Buffer.alloc(7));s=jl.createProgramAddressSync(i,e)}catch(i){if(i instanceof TypeError)throw i;o++;continue}return{publicKey:s,nonce:o}}return os.logWithError("unable to find a viable program address nonce","params",{programId:e,marketId:t}),{publicKey:jl.default,nonce:o}}};import{PublicKey as V,SystemProgram as Qi,TransactionInstruction as Yi}from"@solana/web3.js";import fn from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as ru,TOKEN_2022_PROGRAM_ID as su,TOKEN_PROGRAM_ID as Xn}from"@solana/spl-token";function oC(a,e,t,n,o,s,i,r,c,u,l,m){let p=F([W("instruction"),k("amountIn"),k("amountOut")]),d=[{pubkey:Qi.programId,isSigner:!1,isWritable:!1},{pubkey:Xn,isSigner:!1,isWritable:!1},{pubkey:new V(t.programId),isSigner:!1,isWritable:!1},{pubkey:new V(t.id),isSigner:!1,isWritable:!0},{pubkey:new V(n.id),isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let y=Fe(t);d.push({pubkey:y.config.id,isSigner:!1,isWritable:!1},{pubkey:y.id,isSigner:!1,isWritable:!0},{pubkey:y.mintA.address.equals(c)?y.vault.A:y.vault.B,isSigner:!1,isWritable:!0},{pubkey:y.mintA.address.equals(c)?y.vault.B:y.vault.A,isSigner:!1,isWritable:!0},{pubkey:y.id,isSigner:!1,isWritable:!0},...m.map(b=>({pubkey:b,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let y=Fe(t);d.push({pubkey:y.authority,isSigner:!1,isWritable:!1},{pubkey:y.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:y.id,isSigner:!1,isWritable:!0},{pubkey:new V("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:y.openOrders,isSigner:!1,isWritable:!0},{pubkey:y.vault.A,isSigner:!1,isWritable:!0},{pubkey:y.vault.B,isSigner:!1,isWritable:!0},{pubkey:y.marketId,isSigner:!1,isWritable:!0},{pubkey:y.marketBids,isSigner:!1,isWritable:!0},{pubkey:y.marketAsks,isSigner:!1,isWritable:!0},{pubkey:y.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:y.id,isSigner:!1,isWritable:!0},{pubkey:y.id,isSigner:!1,isWritable:!0})}else{let y=Fe(t);d.push({pubkey:y.authority,isSigner:!1,isWritable:!1},{pubkey:y.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:y.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:y.openOrders,isSigner:!1,isWritable:!0},{pubkey:y.vault.A,isSigner:!1,isWritable:!0},{pubkey:y.vault.B,isSigner:!1,isWritable:!0},{pubkey:y.marketId,isSigner:!1,isWritable:!0},{pubkey:y.marketBids,isSigner:!1,isWritable:!0},{pubkey:y.marketAsks,isSigner:!1,isWritable:!0},{pubkey:y.marketEventQueue,isSigner:!1,isWritable:!0},...y.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:y.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:y.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:y.id,isSigner:!1,isWritable:!0},{pubkey:y.id,isSigner:!1,isWritable:!0}])}let f=Buffer.alloc(p.span);return p.encode({instruction:4,amountIn:u,amountOut:l},f),new Yi({keys:d,programId:a,data:f})}function iC(a,e,t,n,o,s,i,r,c,u){let l=F([W("instruction")]),m=[{pubkey:Qi.programId,isSigner:!1,isWritable:!1},{pubkey:Xn,isSigner:!1,isWritable:!1},{pubkey:new V(String(n.programId)),isSigner:!1,isWritable:!1},{pubkey:new V(String(n.id)),isSigner:!1,isWritable:!0},{pubkey:new V(String(t.id)),isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let d=Fe(n);m.push({pubkey:d.config.id,isSigner:!1,isWritable:!1},{pubkey:d.id,isSigner:!1,isWritable:!0},{pubkey:d.mintA.address.equals(c)?d.vault.A:d.vault.B,isSigner:!1,isWritable:!0},{pubkey:d.mintA.address.equals(c)?d.vault.B:d.vault.A,isSigner:!1,isWritable:!0},{pubkey:d.id,isSigner:!1,isWritable:!0},...u.map(f=>({pubkey:f,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let d=Fe(n);m.push({pubkey:d.authority,isSigner:!1,isWritable:!1},{pubkey:d.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:d.id,isSigner:!1,isWritable:!0},{pubkey:new V("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:d.openOrders,isSigner:!1,isWritable:!0},{pubkey:d.vault.A,isSigner:!1,isWritable:!0},{pubkey:d.vault.B,isSigner:!1,isWritable:!0},{pubkey:d.marketId,isSigner:!1,isWritable:!0},{pubkey:d.marketBids,isSigner:!1,isWritable:!0},{pubkey:d.marketAsks,isSigner:!1,isWritable:!0},{pubkey:d.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:d.id,isSigner:!1,isWritable:!0},{pubkey:d.id,isSigner:!1,isWritable:!0})}else{let d=Fe(n);m.push({pubkey:d.authority,isSigner:!1,isWritable:!1},{pubkey:d.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:d.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:d.openOrders,isSigner:!1,isWritable:!0},{pubkey:d.vault.A,isSigner:!1,isWritable:!0},{pubkey:d.vault.B,isSigner:!1,isWritable:!0},{pubkey:d.marketId,isSigner:!1,isWritable:!0},{pubkey:d.marketBids,isSigner:!1,isWritable:!0},{pubkey:d.marketAsks,isSigner:!1,isWritable:!0},{pubkey:d.marketEventQueue,isSigner:!1,isWritable:!0},...d.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:d.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:d.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:d.id,isSigner:!1,isWritable:!0},{pubkey:d.id,isSigner:!1,isWritable:!0}])}let p=Buffer.alloc(l.span);return l.encode({instruction:5},p),new Yi({keys:m,programId:a,data:p})}function ey(a,e,t,n,o,s,i,r,c,u,l,m,p,d,f){var w;let y=[],b=[P({pubkey:Xn,isWritable:!1}),P({pubkey:su,isWritable:!1}),P({pubkey:ru,isWritable:!1}),P({pubkey:Qi.programId,isWritable:!1}),P({pubkey:e,isSigner:!0})];b.push(P({pubkey:t})),b.push(P({pubkey:o}));let g=[c,u],A=[l,m],h=[s,i,r];for(let S=0;S<g.length;S++){let x=g[S],K=h[S]===x.mintA.address;if(b.push(P({pubkey:new V(x.programId),isWritable:!1})),S===g.length-1?b.push(P({pubkey:o})):b.push(P({pubkey:n})),b.push(P({pubkey:new V(h[S])})),b.push(P({pubkey:new V(h[S+1])})),x.version===6){let B=A[S];b.push(P({pubkey:new V(B.config.id)})),b.push(P({pubkey:new V(B.id)})),b.push(P({pubkey:new V(K?B.vault.A:B.vault.B)})),b.push(P({pubkey:new V(K?B.vault.B:B.vault.A)})),b.push(P({pubkey:new V(x.observationId)})),b.push(P({pubkey:mn})),b.push(P({pubkey:je(new V(x.programId),new V(x.id)).publicKey})),y.push(au(x.sqrtPriceX64.toString(),K));for(let C of(w=f[S])!=null?w:[])b.push(P({pubkey:new V(C)}))}else if(x.version===5){let B=A[S];b.push(P({pubkey:new V(B.id)})),b.push(P({pubkey:new V(B.authority),isWritable:!1})),b.push(P({pubkey:new V(B.marketProgramId)})),b.push(P({pubkey:new V(B.marketAuthority)})),b.push(P({pubkey:wr,isWritable:!1})),b.push(P({pubkey:new V(B.openOrders)})),b.push(P({pubkey:new V(B.vault.A)})),b.push(P({pubkey:new V(B.vault.B)})),b.push(P({pubkey:new V(B.id)})),b.push(P({pubkey:new V(B.id)})),b.push(P({pubkey:new V(B.id)})),b.push(P({pubkey:new V(B.id)})),b.push(P({pubkey:new V(B.id)})),b.push(P({pubkey:new V(B.id)})),b.push(P({pubkey:new V(B.marketId)})),b.push(P({pubkey:new V(B.marketBids)})),b.push(P({pubkey:new V(B.marketAsks)})),b.push(P({pubkey:new V(B.marketEventQueue)})),b.push(P({pubkey:new V(B.marketBaseVault)})),b.push(P({pubkey:new V(B.marketQuoteVault)}))}else if(x.version===4){let B=A[S],C=x.status!==1;b.push(P({pubkey:new V(B.id)})),b.push(P({pubkey:new V(B.authority),isWritable:!1})),b.push(P({pubkey:new V(C?B.id:B.marketProgramId)})),b.push(P({pubkey:new V(C?B.id:B.marketAuthority)})),b.push(P({pubkey:new V(C?B.id:B.openOrders)})),b.push(P({pubkey:new V(B.vault.A)})),b.push(P({pubkey:new V(B.vault.B)})),b.push(P({pubkey:new V(C?B.id:B.marketId)})),b.push(P({pubkey:new V(C?B.id:B.marketBids)})),b.push(P({pubkey:new V(C?B.id:B.marketAsks)})),b.push(P({pubkey:new V(C?B.id:B.marketEventQueue)})),b.push(P({pubkey:new V(C?B.id:B.marketBaseVault)})),b.push(P({pubkey:new V(C?B.id:B.marketQuoteVault)}))}else if(x.version===7){let B=A[S];b.push(P({pubkey:new V(B.authority)})),b.push(P({pubkey:new V(B.config.id)})),b.push(P({pubkey:new V(B.id)})),b.push(P({pubkey:new V(K?B.vault.A:B.vault.B)})),b.push(P({pubkey:new V(K?B.vault.B:B.vault.A)})),b.push(P({pubkey:new V(x.observationId)}))}else throw Error("pool type error")}let I=F([W("insId"),k("amountIn"),k("amountOut"),Q(ee(),y.length,"clmmPriceLimit")]),T=Buffer.alloc(I.span);return I.encode({insId:0,amountIn:p,amountOut:d,clmmPriceLimit:y},T),new Yi({keys:b,programId:a,data:T})}function au(a,e){if(a)if(e){let t=new fn(a).div(new fn(25));return t.gt(vr)?t:vr}else{let t=new fn(a).mul(new fn(25));return t.lt(Fr)?t:Fr}else return e?vr:Fr}function Hl({routeProgram:a,ownerInfo:e,inputMint:t,swapInfo:n}){var o,s,i,r,c,u,l;if(n.routeType==="amm")if(n.poolInfo[0].version===6){let m=n.poolKey[0],p=Fe(m),d=t.equals(p.mintA.address)?Xt.add(vt):zt.sub(vt);return Re.makeSwapBaseInInstructions({poolInfo:m,poolKeys:m,observationId:n.poolInfo[0].observationId,ownerInfo:{wallet:e.wallet,tokenAccountA:p.mintA.address.equals(t)?e.sourceToken:e.destinationToken,tokenAccountB:p.mintA.address.equals(t)?e.destinationToken:e.sourceToken},inputMint:t,amountIn:n.amountIn.amount.raw,amountOutMin:n.minAmountOut.amount.raw.sub((s=(o=n.minAmountOut.fee)==null?void 0:o.raw)!=null?s:new fn(0)),sqrtPriceLimitX64:d,remainingAccounts:(i=n.remainingAccounts[0])!=null?i:[]})}else if(n.poolInfo[0].version===7){let m=n.poolInfo[0],p=t.toString()===n.poolInfo[0].mintA.address;return{signers:[],instructions:[es(m.programId,e.wallet,m.authority,m.configId,m.id,e.sourceToken,e.destinationToken,p?m.vaultA:m.vaultB,p?m.vaultB:m.vaultA,p?m.mintProgramA:m.mintProgramB,p?m.mintProgramB:m.mintProgramA,new V(m[p?"mintA":"mintB"].address),new V(m[p?"mintB":"mintA"].address),m.observationId,n.amountIn.amount.raw,n.minAmountOut.amount.raw)],lookupTableAddress:[],instructionTypes:[p?U.CpmmSwapBaseIn:U.CpmmSwapBaseOut],address:{}}}else{let m=n.poolKey[0];return{signers:[],instructions:[Ur({poolKeys:m,version:n.poolInfo[0].pooltype.includes("StablePool")?5:4,userKeys:{tokenAccountIn:e.sourceToken,tokenAccountOut:e.destinationToken,owner:e.wallet},amountIn:n.amountIn.amount.raw,amountOut:n.minAmountOut.amount.raw.sub((c=(r=n.minAmountOut.fee)==null?void 0:r.raw)!=null?c:new fn(0)),fixedSide:"in"})],lookupTableAddress:m.lookupTableAccount?[m.lookupTableAccount]:[],instructionTypes:[n.poolInfo[0].pooltype.includes("StablePool")?U.AmmV5SwapBaseIn:U.AmmV4SwapBaseIn],address:{}}}else if(n.routeType==="route"){let m=n.poolInfo[0],p=n.poolInfo[1],d=n.poolKey[0],f=n.poolKey[1];if(e.routeToken===void 0)throw Error("owner route token account check error");return{signers:[],instructions:[ey(a,e.wallet,e.sourceToken,e.routeToken,e.destinationToken,t.toString(),n.middleToken.mint.toString(),n.outputMint.toString(),m,p,d,f,n.amountIn.amount.raw,n.minAmountOut.amount.raw.sub((l=(u=n.minAmountOut.fee)==null?void 0:u.raw)!=null?l:new fn(0)),n.remainingAccounts)],instructionTypes:[U.RouteSwap],lookupTableAddress:[d.lookupTableAccount,f.lookupTableAccount].filter(y=>y!==void 0),address:{}}}else throw Error("route type error")}function rC({programId:a,wallet:e,amount:t,inputAccount:n,outputAccount:o,routeInfo:s,poolKeys:i}){var p;if(s.success===!1)throw Error("route info error");let r=[],c=[P({pubkey:Xn,isWritable:!1}),P({pubkey:su,isWritable:!1}),P({pubkey:ru,isWritable:!1}),P({pubkey:Qi.programId,isWritable:!1}),P({pubkey:e,isSigner:!0})],u={[s.data.inputMint]:n,[s.data.outputMint]:o};c.push(P({pubkey:u[s.data.inputMint]})),c.push(P({pubkey:u[s.data.outputMint]}));for(let d=0;d<i.length;d++){let f=s.data.routePlan[d],y=i[d],b=f.inputMint===y.mintA.address;if(c.push(P({pubkey:new V(y.programId),isWritable:!1})),d===i.length-1)c.push(P({pubkey:u[f.outputMint]}));else{let g=f.outputMint;if(u[g]===void 0){let A=H(e,new V(g),y.programId===wt.CLMM_PROGRAM_ID.toBase58()||y.programId===wt.CREATE_CPMM_POOL_PROGRAM.toBase58()?new V(b?y.mintB.programId:y.mintA.programId):Xn).publicKey;u[g]=A}c.push(P({pubkey:u[g]}))}if(c.push(P({pubkey:new V(f.inputMint)})),c.push(P({pubkey:new V(f.outputMint)})),y.programId===wt.CLMM_PROGRAM_ID.toBase58()){let g=y;c.push(P({pubkey:new V(g.config.id)})),c.push(P({pubkey:new V(g.id)})),c.push(P({pubkey:new V(b?g.vault.A:g.vault.B)})),c.push(P({pubkey:new V(b?g.vault.B:g.vault.A)})),c.push(P({pubkey:new V(g.observationId)})),c.push(P({pubkey:mn,isWritable:!1})),c.push(P({pubkey:new V(g.exBitmapAccount)})),r.push(au(f.lastPoolPriceX64,b));for(let A of(p=f.remainingAccounts)!=null?p:[])c.push(P({pubkey:new V(A)}))}else if(y.programId===wt.AMM_STABLE.toBase58()){let g=y;c.push(P({pubkey:new V(g.id)})),c.push(P({pubkey:new V(g.authority),isWritable:!1})),c.push(P({pubkey:new V(g.marketProgramId),isWritable:!1})),c.push(P({pubkey:new V(g.marketAuthority),isWritable:!1})),c.push(P({pubkey:wr,isWritable:!1})),c.push(P({pubkey:new V(g.openOrders)})),c.push(P({pubkey:new V(g.vault.A)})),c.push(P({pubkey:new V(g.vault.B)})),c.push(P({pubkey:new V(g.marketId)})),c.push(P({pubkey:new V(g.marketBids)})),c.push(P({pubkey:new V(g.marketAsks)})),c.push(P({pubkey:new V(g.marketEventQueue)})),c.push(P({pubkey:new V(g.marketBaseVault)})),c.push(P({pubkey:new V(g.marketQuoteVault)}))}else if(y.programId===wt.AMM_V4.toBase58()){let g=y;c.push(P({pubkey:new V(g.id)})),c.push(P({pubkey:new V(g.authority),isWritable:!1})),c.push(P({pubkey:new V(g.id)})),c.push(P({pubkey:new V(g.id)})),c.push(P({pubkey:new V(g.id)})),c.push(P({pubkey:new V(g.vault.A)})),c.push(P({pubkey:new V(g.vault.B)})),c.push(P({pubkey:new V(g.id)})),c.push(P({pubkey:new V(g.id)})),c.push(P({pubkey:new V(g.id)})),c.push(P({pubkey:new V(g.id)})),c.push(P({pubkey:new V(g.id)})),c.push(P({pubkey:new V(g.id)}))}else if(y.programId===wt.CREATE_CPMM_POOL_PROGRAM.toBase58()){let g=y;c.push(P({pubkey:new V(g.authority)})),c.push(P({pubkey:new V(g.config.id)})),c.push(P({pubkey:new V(g.id)})),c.push(P({pubkey:new V(b?g.vault.A:g.vault.B)})),c.push(P({pubkey:new V(b?g.vault.B:g.vault.A)})),c.push(P({pubkey:new V(g.observationId)}))}else throw Error("pool type error")}let l=F([W("insId"),k("amountIn"),k("amountOut"),Q(ee(),r.length,"clmmPriceLimit")]),m=Buffer.alloc(l.span);return l.encode({insId:0,amountIn:t,amountOut:new fn(s.data.otherAmountThreshold),clmmPriceLimit:r},m),new Yi({keys:c,programId:a,data:m})}function sC({programId:a,wallet:e,inputAccount:t,outputAccount:n,routeInfo:o,poolKeys:s}){var m;if(o.success===!1)throw Error("route info error");let i=[],r=[P({pubkey:Xn,isWritable:!1}),P({pubkey:su,isWritable:!1}),P({pubkey:ru,isWritable:!1}),P({pubkey:Qi.programId,isWritable:!1}),P({pubkey:e,isSigner:!0})],c={[o.data.inputMint]:t,[o.data.outputMint]:n};for(let p=s.length-1;p>=0;p--){let d=o.data.routePlan[p],f=s[p],y=d.inputMint===f.mintA.address;if(r.push(P({pubkey:new V(f.programId)})),p===0)r.push(P({pubkey:c[d.inputMint]}));else{let b=d.inputMint;if(c[b]===void 0){let g=H(e,new V(b),f.programId===wt.CLMM_PROGRAM_ID.toBase58()||f.programId===wt.CREATE_CPMM_POOL_PROGRAM.toBase58()?new V(y?f.mintA.programId:f.mintB.programId):Xn).publicKey;c[b]=g}r.push(P({pubkey:c[b]}))}if(p===s.length-1)r.push(P({pubkey:c[d.outputMint]}));else{let b=d.outputMint;if(c[b]===void 0){let g=H(e,new V(b),f.programId===wt.CLMM_PROGRAM_ID.toBase58()||f.programId===wt.CREATE_CPMM_POOL_PROGRAM.toBase58()?new V(y?f.mintB.programId:f.mintA.programId):Xn).publicKey;c[b]=g}r.push(P({pubkey:c[b]}))}if(r.push(P({pubkey:new V(d.inputMint)})),r.push(P({pubkey:new V(d.outputMint)})),f.programId===wt.CLMM_PROGRAM_ID.toBase58()){let b=f;r.push(P({pubkey:new V(b.config.id)})),r.push(P({pubkey:new V(b.id)})),r.push(P({pubkey:new V(y?b.vault.A:b.vault.B)})),r.push(P({pubkey:new V(y?b.vault.B:b.vault.A)})),r.push(P({pubkey:new V(b.observationId)})),r.push(P({pubkey:mn,isWritable:!1})),r.push(P({pubkey:new V(b.exBitmapAccount)})),i.push(au(d.lastPoolPriceX64,y));for(let g of(m=d.remainingAccounts)!=null?m:[])r.push(P({pubkey:new V(g)}))}else if(f.programId===wt.AMM_STABLE.toBase58()){let b=f;r.push(P({pubkey:new V(b.id)})),r.push(P({pubkey:new V(b.authority),isWritable:!1})),r.push(P({pubkey:new V(b.marketProgramId),isWritable:!1})),r.push(P({pubkey:new V(b.marketAuthority),isWritable:!1})),r.push(P({pubkey:wr,isWritable:!1})),r.push(P({pubkey:new V(b.openOrders)})),r.push(P({pubkey:new V(b.vault.A)})),r.push(P({pubkey:new V(b.vault.B)})),r.push(P({pubkey:new V(b.marketId)})),r.push(P({pubkey:new V(b.marketBids)})),r.push(P({pubkey:new V(b.marketAsks)})),r.push(P({pubkey:new V(b.marketEventQueue)})),r.push(P({pubkey:new V(b.marketBaseVault)})),r.push(P({pubkey:new V(b.marketQuoteVault)}))}else if(f.programId===wt.AMM_V4.toBase58()){let b=f;r.push(P({pubkey:new V(b.id)})),r.push(P({pubkey:new V(b.authority),isWritable:!1})),r.push(P({pubkey:new V(b.id)})),r.push(P({pubkey:new V(b.id)})),r.push(P({pubkey:new V(b.id)})),r.push(P({pubkey:new V(b.vault.A)})),r.push(P({pubkey:new V(b.vault.B)})),r.push(P({pubkey:new V(b.id)})),r.push(P({pubkey:new V(b.id)})),r.push(P({pubkey:new V(b.id)})),r.push(P({pubkey:new V(b.id)})),r.push(P({pubkey:new V(b.id)})),r.push(P({pubkey:new V(b.id)}))}else if(f.programId===wt.CREATE_CPMM_POOL_PROGRAM.toBase58()){let b=f;r.push(P({pubkey:new V(b.authority)})),r.push(P({pubkey:new V(b.config.id)})),r.push(P({pubkey:new V(b.id)})),r.push(P({pubkey:new V(y?b.vault.A:b.vault.B)})),r.push(P({pubkey:new V(y?b.vault.B:b.vault.A)})),r.push(P({pubkey:new V(b.observationId)}))}else throw Error("pool type error")}let u=F([W("insId"),k("amountIn"),k("amountOut"),Q(ee(),i.length,"clmmPriceLimit")]),l=Buffer.alloc(u.span);return u.encode({insId:1,amountIn:new fn(o.data.otherAmountThreshold),amountOut:new fn(o.data.outputAmount),clmmPriceLimit:i},l),new Yi({keys:r,programId:a,data:l})}var Rn=new ss(0),Hi=class extends Ve{constructor(e){super(e)}async getWSolAccounts(){this.scope.checkOwner(),await this.scope.account.fetchWalletTokenAccounts();let e=this.scope.account.tokenAccounts.filter(t=>t.mint.equals(Z));return e.sort((t,n)=>t.isAssociated?1:n.isAssociated||t.amount.lt(n.amount)?-1:1),e}async unWrapWSol(e){let{amount:t,tokenProgram:n,txVersion:o=1,feePayer:s}=e,i=await this.getWSolAccounts(),r=this.createTxBuilder(s);r.addCustomComputeBudget(e.computeBudgetConfig);let c=J(t);for(let u=0;u<i.length;u++)c.gte(i[u].amount)?(r.addInstruction({instructions:[In({tokenAccount:i[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),c.sub(i[u].amount)):r.addInstruction({instructions:[In({tokenAccount:i[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]});return r.versionBuild({txVersion:o})}async wrapWSol(e,t,n,o){let s=this.createTxBuilder(o),i=await _n({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:e,skipCloseAccount:!0});return s.addInstruction(i),s.versionBuild({txVersion:n!=null?n:1})}async swap({swapInfo:e,swapPoolKeys:t,ownerInfo:n,computeBudgetConfig:o,routeProgram:s,txVersion:i,feePayer:r}){let c=this.createTxBuilder(r),u=e.amountIn,l=e.amountOut,m=u.amount.token.mint.equals(Z),p=l.amount.token.mint.equals(Z),d=u.amount.token.mint,f=l.amount.token.mint,{account:y,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.amount.token.isToken2022?rs:Ze,mint:d,notUseTokenAccount:m,owner:this.scope.ownerPubKey,skipCloseAccount:!m,createInfo:m?{payer:this.scope.ownerPubKey,amount:u.amount.raw}:void 0,associatedOnly:m?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});if(b&&c.addInstruction(b),y===void 0)throw Error("input account check error");let g;if(e.routeType==="route"&&!p)g=this.scope.account.getAssociatedTokenAccount(f,l.amount.token.isToken2022?rs:Ze);else{let{account:T,instructionParams:w}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:l.amount.token.isToken2022?rs:Ze,mint:f,notUseTokenAccount:p,owner:this.scope.ownerPubKey,skipCloseAccount:!0,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:p?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});g=T,w&&c.addInstruction(w)}p&&c.addInstruction({endInstructions:[In({owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,tokenAccount:g,programId:Ze})],endInstructionTypes:[U.CloseAccount]});let A;if(e.routeType==="route"){let T=e.middleToken;A=this.scope.account.getAssociatedTokenAccount(T.mint,T.isToken2022?rs:Ze)}let h=t||await this.computePoolToPoolKeys({pools:e.poolInfoList}),I=Hl({routeProgram:s,inputMint:d,swapInfo:q(v({},e),{poolInfo:[...e.poolInfoList],poolKey:h,outputMint:f}),ownerInfo:{wallet:this.scope.ownerPubKey,sourceToken:y,routeToken:A,destinationToken:g}});if(e.feeConfig!==void 0){let T=this.createTxBuilder();T.addInstruction({instructions:[Zl(y,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[U.TransferAmount]}),T.addInstruction(I);let{transactions:w}=i===0?await T.sizeCheckBuildV0():await T.sizeCheckBuild();w.length<2&&c.addInstruction({instructions:[Zl(y,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[U.TransferAmount]})}return c.addInstruction(I),i===0?c.sizeCheckBuildV0({computeBudgetConfig:o,address:I.address}):c.sizeCheckBuild({computeBudgetConfig:o,address:I.address})}async fetchRoutePoolBasicInfo(e){let{amm:t=oi,clmm:n=Mn,cpmm:o=ri}=e||{},s=await this.scope.connection.getProgramAccounts(t,{dataSlice:{offset:uo.offsetOf("baseMint"),length:64}}),i=F([N("baseMint"),N("quoteMint")]),r=s.map(d=>({id:d.pubkey,version:4,mintA:i.decode(d.account.data).baseMint,mintB:i.decode(d.account.data).quoteMint})),c=F([N("mintA"),N("mintB")]),l=(await this.scope.connection.getProgramAccounts(n,{filters:[{dataSize:so.span}],dataSlice:{offset:so.offsetOf("mintA"),length:64}})).map(d=>{let f=c.decode(d.account.data);return{id:d.pubkey,version:6,mintA:f.mintA,mintB:f.mintB}}),p=(await this.scope.connection.getProgramAccounts(o,{dataSlice:{offset:ts.offsetOf("mintA"),length:64}})).map(d=>{let f=c.decode(d.account.data);return{id:d.pubkey,version:7,mintA:f.mintA,mintB:f.mintB}});return{clmmPools:l,ammPools:r,cpmmPools:p}}getAllRoute({inputMint:e,outputMint:t,clmmPools:n,ammPools:o,cpmmPools:s}){e=e.toString()===go.default.toString()?Z:e,t=t.toString()===go.default.toString()?Z:t;let i={},r={},c={},u=[],l={};for(let p of n!=null?n:[]){if((p.mintA.equals(e)&&p.mintB.equals(t)||p.mintA.equals(t)&&p.mintB.equals(e))&&(u.push(p),r[p.id.toString()]=p),p.mintA.equals(e)){let d=p.mintB.toString();l[d]===void 0&&(l[d]={mintProgram:Ze,in:[],out:[],mDecimals:0}),l[d].in.push(p)}if(p.mintB.equals(e)){let d=p.mintA.toString();l[d]===void 0&&(l[d]={mintProgram:Ze,in:[],out:[],mDecimals:0}),l[d].in.push(p)}if(p.mintA.equals(t)){let d=p.mintB.toString();l[d]===void 0&&(l[d]={mintProgram:Ze,in:[],out:[],mDecimals:0}),l[d].out.push(p)}if(p.mintB.equals(t)){let d=p.mintA.toString();l[d]===void 0&&(l[d]={mintProgram:Ze,in:[],out:[],mDecimals:0}),l[d].out.push(p)}}let m=[];for(let p of o)(p.mintA.equals(e)&&p.mintB.equals(t)||p.mintA.equals(t)&&p.mintB.equals(e))&&(u.push(p),i[p.id.toBase58()]=p,m.push(p)),p.mintA.equals(e)&&(l[p.mintB.toBase58()]===void 0&&(l[p.mintB.toBase58()]={mintProgram:Ze,in:[],out:[],mDecimals:0}),l[p.mintB.toBase58()].in.push(p)),p.mintB.equals(e)&&(l[p.mintA.toBase58()]===void 0&&(l[p.mintA.toBase58()]={mintProgram:Ze,in:[],out:[],mDecimals:0}),l[p.mintA.toBase58()].in.push(p)),p.mintA.equals(t)&&(l[p.mintB.toBase58()]===void 0&&(l[p.mintB.toBase58()]={mintProgram:Ze,in:[],out:[],mDecimals:0}),l[p.mintB.toBase58()].out.push(p)),p.mintB.equals(t)&&(l[p.mintA.toBase58()]===void 0&&(l[p.mintA.toBase58()]={mintProgram:Ze,in:[],out:[],mDecimals:0}),l[p.mintA.toBase58()].out.push(p));for(let p of s)(p.mintA.equals(e)&&p.mintB.equals(t)||p.mintA.equals(t)&&p.mintB.equals(e))&&(u.push(p),c[p.id.toBase58()]=p),p.mintA.equals(e)&&(l[p.mintB.toBase58()]===void 0&&(l[p.mintB.toBase58()]={mintProgram:Ze,in:[],out:[],mDecimals:0}),l[p.mintB.toBase58()].in.push(p)),p.mintB.equals(e)&&(l[p.mintA.toBase58()]===void 0&&(l[p.mintA.toBase58()]={mintProgram:Ze,in:[],out:[],mDecimals:0}),l[p.mintA.toBase58()].in.push(p)),p.mintA.equals(t)&&(l[p.mintB.toBase58()]===void 0&&(l[p.mintB.toBase58()]={mintProgram:Ze,in:[],out:[],mDecimals:0}),l[p.mintB.toBase58()].out.push(p)),p.mintB.equals(t)&&(l[p.mintA.toBase58()]===void 0&&(l[p.mintA.toBase58()]={mintProgram:Ze,in:[],out:[],mDecimals:0}),l[p.mintA.toBase58()].out.push(p));for(let p of Object.keys(l)){if(l[p].in.length===1&&l[p].out.length===1&&l[p].in[0].id.equals(l[p].out[0].id)){delete l[p];continue}if(l[p].in.length===0||l[p].out.length===0){delete l[p];continue}let d=l[p];for(let f of d.in)for(let y of d.out)f.version===6&&r[f.id.toString()]===void 0?r[f.id.toString()]=f:f.version===7&&c[f.id.toString()]===void 0?c[f.id.toString()]=f:(f.version===4||f.version===5)&&i[f.id.toString()]===void 0&&(i[f.id.toString()]=f),y.version===6&&r[y.id.toString()]===void 0?r[y.id.toString()]=y:y.version===7&&c[y.id.toString()]===void 0?c[y.id.toString()]=y:(y.version===4||y.version===5)&&i[y.id.toString()]===void 0&&(i[y.id.toString()]=y)}return{directPath:u,addLiquidityPools:m,routePathDict:l,needSimulate:Object.values(i),needTickArray:Object.values(r),cpmmPoolList:Object.values(c)}}async fetchSwapRoutesData({routes:e,inputMint:t,outputMint:n}){let o=new Set([...e.needTickArray.map(y=>[y.mintA.toBase58(),y.mintB.toBase58()]).flat(),t.toString(),n.toString()]);console.log("fetching amm pools info, total: ",e.needSimulate.length);let s=await this.scope.liquidity.getRpcPoolInfos(e.needSimulate.map(y=>y.id)),i=zr(s),r={};Object.values(i).forEach(y=>{o.delete(y.mintA.address),r[y.mintA.address]={address:new go(y.mintA.address),programId:Ze,mintAuthority:null,supply:BigInt(0),decimals:y.mintA.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0},o.delete(y.mintB.address),r[y.mintB.address]={address:new go(y.mintB.address),programId:Ze,mintAuthority:null,supply:BigInt(0),decimals:y.mintB.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}}),console.log("fetching cpmm pools info, total: ",e.cpmmPoolList.length);let c=await this.scope.cpmm.getRpcPoolInfos(e.cpmmPoolList.map(y=>y.id.toBase58()),!0);Object.values(c).forEach(y=>{let[b,g]=[y.mintA.toBase58(),y.mintB.toBase58()];y.mintProgramA.equals(Ze)?(o.delete(b),r[b]={address:y.mintA,programId:y.mintProgramA,mintAuthority:null,supply:BigInt(0),decimals:y.mintDecimalA,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):o.add(b),y.mintProgramB.equals(Ze)?(o.delete(g),r[g]={address:y.mintB,programId:y.mintProgramB,mintAuthority:null,supply:BigInt(0),decimals:y.mintDecimalB,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):o.add(g)}),console.log("fetching mints info, total: ",o.size);let u=await ho({connection:this.scope.connection,mints:Array.from(o).map(y=>new go(y))});r=v(v({},r),u);let l=this.scope.cpmm.toComputePoolInfos({pools:c,mintInfos:r});console.log("fetching clmm pools info, total:",e.needTickArray.length);let m=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:e.needTickArray.map(y=>y.id)}),{computeClmmPoolInfo:p,computePoolTickData:d}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:m,mintInfos:r}),f=Object.keys(e.routePathDict).reduce((y,b)=>q(v({},y),{[b]:q(v({},e.routePathDict[b]),{mintProgram:r[b].programId,mDecimals:r[b].decimals,in:e.routePathDict[b].in.map(g=>i[g.id.toBase58()]||p[g.id.toBase58()]||l[g.id.toBase58()]),out:e.routePathDict[b].out.map(g=>i[g.id.toBase58()]||p[g.id.toBase58()]||l[g.id.toBase58()])})}),{});return{mintInfos:r,ammPoolsRpcInfo:s,ammSimulateCache:i,clmmPoolsRpcInfo:m,computeClmmPoolInfo:p,computePoolTickData:d,computeCpmmData:l,routePathDict:f}}getAllRouteComputeAmountOut({inputTokenAmount:e,outputToken:t,directPath:n,routePathDict:o,simulateCache:s,tickCache:i,slippage:r,chainTime:c,epochInfo:u,feeConfig:l}){var g,A,h,I,T,w,S,x,K;let m=l===void 0?new ss(0):e.raw.mul(new ss(l.feeBps.toNumber())).div(new ss(1e4)),p=e.raw.sub(m),d=new he(e.token,p),f=l===void 0?void 0:{feeAmount:m,feeAccount:l.feeAccount},y=q(v({},t),{address:bt(t.address).toString()}),b=[];for(let B of n)try{b.push(q(v({},this.computeAmountOut({itemPool:B,tickCache:i,simulateCache:s,chainTime:c,epochInfo:u,slippage:r,outputToken:y,amountIn:d})),{feeConfig:f}))}catch(C){this.logDebug("direct error",B.version,B.id.toString(),C.message)}this.logDebug("direct done");for(let[B,C]of Object.entries(o)){let L={chainId:101,address:B,programId:C.mintProgram.toBase58(),logoURI:"",symbol:"",name:"",decimals:C.mDecimals,tags:[],extensions:{}},M=C.in.map(O=>{try{return{pool:O,data:this.computeAmountOut({itemPool:O,tickCache:i,simulateCache:s,chainTime:c,epochInfo:u,slippage:r,outputToken:L,amountIn:d})}}catch(_){this.logDebug("route in error",O.version,O.id.toString(),_.message);return}}).sort((O,_)=>{var ae,le,ie,de;let X=O===void 0?Rn:O.data.amountOut.amount.raw.sub((le=(ae=O.data.amountOut.fee)==null?void 0:ae.raw)!=null?le:Rn),j=_===void 0?Rn:_.data.amountOut.amount.raw.sub((de=(ie=_.data.amountOut.fee)==null?void 0:ie.raw)!=null?de:Rn);return X.lt(j)?1:-1})[0];if(M===void 0)continue;let R=new he(Wr(L),M.data.amountOut.amount.raw.sub((A=(g=M.data.amountOut.fee)==null?void 0:g.raw)!=null?A:Rn));for(let O of C.out)try{let _=this.computeAmountOut({itemPool:O,tickCache:i,simulateCache:s,chainTime:c,epochInfo:u,slippage:r,outputToken:y,amountIn:R});b.push(q(v({},_),{allTrade:!!(M.data.allTrade&&_.allTrade),amountIn:M.data.amountIn,amountOut:_.amountOut,minAmountOut:_.minAmountOut,currentPrice:void 0,executionPrice:new ji(new lt({baseToken:M.data.amountIn.amount.token,denominator:M.data.amountIn.amount.raw,quoteToken:_.amountOut.amount.token,numerator:_.amountOut.amount.raw.sub((I=(h=_.amountOut.fee)==null?void 0:h.raw)!=null?I:Rn)}).toFixed()),priceImpact:new ji(M.data.priceImpact.add(_.priceImpact).toFixed()),fee:[M.data.fee[0],_.fee[0]],routeType:"route",poolInfoList:[M.pool,O],remainingAccounts:[M.data.remainingAccounts[0],_.remainingAccounts[0]],minMiddleAmountFee:(T=_.amountOut.fee)!=null&&T.raw?new he(M.data.amountOut.amount.token,((S=(w=M.data.amountOut.fee)==null?void 0:w.raw)!=null?S:Rn).add((K=(x=_.amountOut.fee)==null?void 0:x.raw)!=null?K:Rn)):void 0,middleToken:M.data.amountOut.amount.token,poolReady:M.data.poolReady&&_.poolReady,poolType:[M.data.poolType,_.poolType],feeConfig:f,expirationTime:tn(M.data.expirationTime,_.expirationTime)}))}catch(_){this.logDebug("route out error",O.version,O.id.toString(),_.message)}}return b.filter(B=>(B.allTrade||this.logDebug(`pool ${B.poolInfoList.map(C=>C.id.toString()).join(",")} filter out since not all trade`),B.allTrade)).sort((B,C)=>B.amountOut.amount.raw.sub(C.amountOut.amount.raw).gt(Rn)?-1:1)}computeAmountOut({itemPool:e,tickCache:t,simulateCache:n,chainTime:o,epochInfo:s,slippage:i,outputToken:r,amountIn:c}){if(e.version===6){let{allTrade:u,realAmountIn:l,amountOut:m,minAmountOut:p,expirationTime:d,currentPrice:f,executionPrice:y,priceImpact:b,fee:g,remainingAccounts:A,executionPriceX64:h}=Me.computeAmountOutFormat({poolInfo:e,tickArrayCache:t[e.id.toString()],amountIn:c.raw,tokenOut:r,slippage:i,epochInfo:s,catchLiquidityInsufficient:!0});return{allTrade:u,amountIn:l,amountOut:m,minAmountOut:p,currentPrice:new ji(f.toFixed()),executionPrice:new ji(y.toFixed()),priceImpact:new ji(b.toFixed()),fee:[g],remainingAccounts:[A],routeType:"amm",poolInfoList:[e],poolReady:e.startTime<o,poolType:"CLMM",slippage:i,clmmExPriceX64:[h],expirationTime:tn(l.expirationTime,d)}}else if(e.version===7){let{allTrade:u,executionPrice:l,amountOut:m,minAmountOut:p,priceImpact:d,fee:f}=this.scope.cpmm.computeSwapAmount({pool:e,outputMint:r.address,amountIn:c.raw,slippage:i});return{allTrade:u,amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:Mi(q(v({},r),{amount:m})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:Mi(q(v({},r),{amount:p})),fee:void 0,expirationTime:void 0},currentPrice:e.poolPrice,executionPrice:l,priceImpact:d,fee:[new he(c.token,f)],remainingAccounts:[],routeType:"amm",poolInfoList:[e],poolReady:e.openTime.toNumber()<o,poolType:"CPMM",slippage:i,clmmExPriceX64:[void 0],expirationTime:void 0}}else{if(![1,6,7].includes(n[e.id.toString()].status))throw Error("swap error");let{amountOut:u,minAmountOut:l,currentPrice:m,executionPrice:p,priceImpact:d,fee:f}=this.scope.liquidity.computeAmountOut({poolInfo:n[e.id.toString()],amountIn:c.raw,mintIn:c.token.mint,mintOut:r.address,slippage:i});return{amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:Mi(q(v({},r),{amount:u})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:Mi(q(v({},r),{amount:l})),fee:void 0,expirationTime:void 0},currentPrice:m,executionPrice:p,priceImpact:d,fee:[new he(c.token,f)],routeType:"amm",poolInfoList:[e],remainingAccounts:[],poolReady:Number(n[e.id].openTime)<o,poolType:e.version===5?"STABLE":void 0,expirationTime:void 0,allTrade:!0,slippage:i,clmmExPriceX64:[void 0]}}}async computePoolToPoolKeys({pools:e,clmmRpcData:t={},ammRpcData:n={}}){let o=new Set(e.filter(u=>u.version===6&&!t[u.id.toString()]).map(u=>u.id.toString()));if(o.size>0){let u=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:Array.from(o)});Object.keys(u).forEach(l=>{t[l]=u[l]})}let s=new Set(e.filter(u=>u.version===4&&!n[u.id.toString()]).map(u=>u.id.toString()));if(s.size>0){let u=await this.scope.liquidity.getRpcPoolInfos(Array.from(s));Object.keys(u).forEach(l=>{n[l]=u[l]})}let i=new Set(e.filter(u=>u.version===4).map(u=>u.marketId)),r={};i.size>0&&(await Ne(this.scope.connection,Array.from(i).map(l=>({pubkey:new go(l)})))).forEach(l=>{if(!l.accountInfo)return;let m=iu.decode(l.accountInfo.data);r[l.pubkey.toBase58()]={marketId:l.pubkey.toString(),marketProgramId:l.accountInfo.owner.toString(),marketAuthority:is.getAssociatedAuthority({programId:l.accountInfo.owner,marketId:l.pubkey}).publicKey.toString(),marketBaseVault:m.baseVault.toString(),marketQuoteVault:m.quoteVault.toString(),marketBids:m.bids.toString(),marketAsks:m.asks.toString(),marketEventQueue:m.eventQueue.toString()}});let c=[];return e.forEach(u=>{if(u.version===6){let l=t[u.id.toString()],m={programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.startTime),vault:{A:l.vaultA.toBase58(),B:l.vaultB.toBase58()},config:q(v({},u.ammConfig),{id:u.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]}),rewardInfos:[],observationId:u.observationId.toBase58(),exBitmapAccount:u.exBitmapAccount.toBase58()};c.push(m)}else if(u.version===4){let l=n[u.id.toString()],m=v({programId:u.programId,id:u.id,mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),vault:{A:l.baseVault.toBase58(),B:l.quoteVault.toBase58()},authority:Za({programId:new go(u.programId)}).publicKey.toString(),openOrders:l.openOrders.toBase58(),targetOrders:l.targetOrders.toBase58(),mintLp:u.lpMint},r[u.marketId]);c.push(m)}else u.version===7&&c.push({observationId:u.observationId.toBase58(),programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),authority:Wo(u.programId).publicKey.toBase58(),vault:{A:u.vaultA.toBase58(),B:u.vaultB.toBase58()},mintLp:Pt({address:u.mintLp.toBase58(),programId:Ze.toBase58(),decimals:u.lpDecimals}),config:q(v({id:u.configId.toBase58()},u.configInfo),{protocolFeeRate:u.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:u.configInfo.tradeFeeRate.toNumber(),fundFeeRate:u.configInfo.fundFeeRate.toNumber(),createPoolFee:u.configInfo.createPoolFee.toString()})})}),c}};import{PublicKey as ty,Transaction as uu,TransactionInstruction as ny}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as oy}from"@solana/spl-token";import $l from"bn.js";var kt=class extends Ve{static getPdaPoolId(e,t){return ne([kt.SEED_CONFIG.pool.id,t.toBuffer()],e)}static getPdaOwnerId(e,t,n,o){return ne([kt.SEED_CONFIG.owner.id,t.toBuffer(),n.toBuffer(),Buffer.from(new $l(o).toArray())],e)}static async getAllInfo({connection:e,programId:t,poolIds:n,wallet:o,chainTime:s}){if(n.length===0)return[];let i=n.map(l=>kt.getPdaPoolId(t,l).publicKey),r=[];for(let l=0;l<kt.VERSION_PROJECT.length;l++)r.push(...i.map(m=>kt.getPdaOwnerId(t,m,o,l).publicKey));let c=await Jt(e,[...i,...r]),u=[];for(let l=0;l<c.length;l++){let m=Math.floor(l/n.length),p=l%n.length,d=i[p],f=r[l],y=c[p],b=c[n.length+l];if(!(y&&b)||y.data.length!==kt.POOL_LAYOUT.span||b.data.length!==kt.OWNER_LAYOUT.span)continue;let g=kt.POOL_LAYOUT.decode(y.data),A=kt.OWNER_LAYOUT.decode(b.data),h=g.openTime.toNumber(),I=g.endTime.toNumber(),T=A.tokenInfo.map(x=>x.debtAmount.gt(new $l(0))).filter(x=>!x).length!==3,w=s>h&&s<I&&g.status===1,S=T&&w;u.push({programId:t,poolId:d,ammId:g.ammId,ownerAccountId:f,snapshotLpAmount:A.lpAmount,project:kt.VERSION_PROJECT[m],openTime:h,endTime:I,canClaim:S,canClaimErrorType:T?w?void 0:"outOfOperationalTime":"alreadyClaimIt",tokenInfo:g.tokenInfo.map((x,K)=>({mintAddress:x.mintAddress,mintVault:x.mintVault,mintDecimals:x.mintDecimals,perLpLoss:x.perLpLoss,debtAmount:A.tokenInfo[K].debtAmount.add(A.tokenInfo[K].claimedAmount)}))})}return u}async makeClaimTransaction({poolInfo:e,ownerInfo:t,feePayer:n}){t.wallet||this.scope.checkOwner();let o=this.createTxBuilder(n),s=t.wallet||this.scope.ownerPubKey,i=[];for(let u of e.tokenInfo){let{account:l,instructionParams:m}=await this.scope.account.getOrCreateTokenAccount({mint:u.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:u.mintAddress.equals(Se.WSOL.mint),createInfo:{payer:s,amount:0},skipCloseAccount:!u.mintAddress.equals(Se.WSOL.mint),associatedOnly:u.mintAddress.equals(Se.WSOL.mint)?!1:t.associatedOnly});m&&o.addInstruction(m),i.push(l)}o.addInstruction({instructions:[kt.makeClaimInstruction({programId:e.programId,poolInfo:e,ownerInfo:{wallet:s,ownerPda:e.ownerAccountId,claimAddress:i}})]});let{transaction:r,signers:c}=o.build();return[{transaction:r,signer:c}]}async makeClaimAllTransaction({poolInfos:e,ownerInfo:t,feePayer:n}){let o=this.createTxBuilder(n),s=t.wallet||this.scope.ownerPubKey,i={};for(let l of e){let m=[];for(let p of l.tokenInfo){let{account:d,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({mint:p.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:p.mintAddress.equals(Se.WSOL.mint),createInfo:{payer:s,amount:0},skipCloseAccount:!p.mintAddress.equals(Se.WSOL.mint),associatedOnly:p.mintAddress.equals(Se.WSOL.mint)?!1:t.associatedOnly});f&&o.addInstruction(f),d&&(i[p.mintAddress.toString()]=d,m.push(d))}o.addInstruction({instructions:[kt.makeClaimInstruction({programId:l.programId,poolInfo:l,ownerInfo:{wallet:s,ownerPda:l.ownerAccountId,claimAddress:m}})]})}let{transaction:r,signers:c}=o.build(),u=o.allInstructions;return Pr(u,[s,...c.map(l=>l.publicKey)])?[{transaction:r,signer:c}]:[{transaction:new uu().add(...u.slice(0,o.AllTxData.instructions.length-1)),signer:c},{transaction:new uu().add(...u.slice(o.AllTxData.instructions.length-1)),signer:[]},{transaction:new uu().add(...o.AllTxData.endInstructions),signer:[]}]}static makeClaimInstruction({programId:e,poolInfo:t,ownerInfo:n}){let o=F([]),s=[{pubkey:n.wallet,isSigner:!0,isWritable:!0},{pubkey:t.poolId,isSigner:!1,isWritable:!0},{pubkey:n.ownerPda,isSigner:!1,isWritable:!0},...n.claimAddress.map(c=>({pubkey:c,isSigner:!1,isWritable:!0})),...t.tokenInfo.map(({mintVault:c})=>({pubkey:c,isSigner:!1,isWritable:!0})),{pubkey:oy,isSigner:!1,isWritable:!1}],i=Buffer.alloc(o.span);o.encode({},i);let r=Buffer.from([10,66,208,184,161,6,191,98,...i]);return new ny({keys:s,programId:e,data:r})}},Yt=kt;Yt.CLAIMED_NUM=3,Yt.POOL_LAYOUT=F([Be(8),W("bump"),W("status"),k("openTime"),k("endTime"),N("ammId"),Q(F([W("mintDecimals"),N("mintAddress"),N("mintVault"),k("perLpLoss"),k("totalClaimedAmount")]),kt.CLAIMED_NUM,"tokenInfo"),Q(k(),10,"padding")]),Yt.OWNER_LAYOUT=F([Be(8),W("bump"),W("version"),N("poolId"),N("owner"),k("lpAmount"),Q(F([N("mintAddress"),k("debtAmount"),k("claimedAmount")]),kt.CLAIMED_NUM,"tokenInfo"),Q(k(),4,"padding")]),Yt.DEFAULT_POOL_ID=["58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2","6UmmUiYoBjSrhakAobJw8BvkmJtDVxaeBtbt7rxWo1mg","AVs9TA4nWDzfPJE9gGVNJMVhcQy3V9PGazuz33BfG2RA","DVa7Qmb5ct9RCpaU7UTpSaf3GVMYz17vNVU67XpdCRut","7XawhbbxtsRcQA8KTkHT9f9nc6d69UwqCDh6U5EEbEmX","6a1CsrpeZubDjEJE9s1CMVheB6HWM5d7m1cj2jkhyXhj","EoNrn8iUhwgJySD1pHu8Qxm5gSQqLK3za4m8xzD2RuEb","AceAyRTWt4PyB2pHqf2qhDgNZDtKVNaxgL8Ru3V4aN1P","6tmFJbMk5yVHFcFy7X2K8RwHjKLr6KVFLYXpgpBNeAxB"].map(e=>new ty(e)),Yt.SEED_CONFIG={pool:{id:Buffer.from("pool_seed","utf8")},owner:{id:Buffer.from("user_claim_seed","utf8")}},Yt.VERSION_PROJECT=[void 0,"Francium","Tulip","Larix"];import{PublicKey as $i}from"@solana/web3.js";import Jl from"bn.js";import{SYSVAR_CLOCK_PUBKEY as iy,TransactionInstruction as lu}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as mu}from"@solana/spl-token";var cu=F([W("instruction"),gc("amount")]),Zi=F([W("instruction")]);function JC({programId:a,amount:e,instructionKeys:t}){let n=[{pubkey:fr,isSigner:!1,isWritable:!1},{pubkey:mu,isSigner:!1,isWritable:!1},{pubkey:nt,isSigner:!1,isWritable:!1},{pubkey:Cs,isSigner:!1,isWritable:!1},...Object.entries(t).map(([s,i])=>({pubkey:i,isSigner:s==="userOwner",isWritable:!["authority","userOwner","userIdoCheck","userStakeInfo"].includes(s)}))],o=Buffer.alloc(cu.span);return cu.encode({instruction:1,amount:Number(e)},o),new lu({keys:n,programId:a,data:o})}function as({programId:a},e){let t=[{pubkey:mu,isSigner:!1,isWritable:!1},{pubkey:Cs,isSigner:!1,isWritable:!1},...Object.entries(e).map(([o,s])=>({pubkey:s,isSigner:o==="userOwner",isWritable:!["authority","userOwner"].includes(o)}))],n=Buffer.alloc(Zi.span);return Zi.encode({instruction:2},n),new lu({keys:t,programId:a,data:n})}function du(a){let{poolConfig:e,userKeys:t,side:n}=a,o=n==="base"?t.baseTokenAccount:t.quoteTokenAccount,s=n==="base"?e.baseVault:e.quoteVault,i=Buffer.alloc(Zi.span);Zi.encode({instruction:2},i);let r=[{pubkey:mu,isWritable:!1,isSigner:!1},{pubkey:iy,isWritable:!1,isSigner:!1},{pubkey:e.id,isWritable:!0,isSigner:!1},{pubkey:e.authority,isWritable:!1,isSigner:!1},{pubkey:s,isWritable:!0,isSigner:!1},{pubkey:o,isWritable:!0,isSigner:!1},{pubkey:t.ledgerAccount,isWritable:!0,isSigner:!1},{pubkey:t.owner,isWritable:!1,isSigner:!0}];return new lu({programId:e.programId,keys:r,data:i})}var ry={[ui.IDO_PROGRAM_ID_V1.toString()]:1,[ui.IDO_PROGRAM_ID_V2.toString()]:2,[ui.IDO_PROGRAM_ID_V3.toString()]:3,[ui.IDO_PROGRAM_ID_V4.toString()]:4},qo=class extends Ve{async claim({ownerInfo:e,idoKeys:t,associatedOnly:n=!0,checkCreateATAOwner:o=!1,txVersion:s,feePayer:i}){let r=this.createTxBuilder(i),c=ry[t.programId];c||this.logAndCreateError("invalid version",c);let u=Fe(t),[l,m]=[!new Jl(e.coin).isZero(),!new Jl(e.pc).isZero()],p=u.projectInfo.mint.address.equals(Z),{account:d,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.projectInfo.mint.programId,mint:u.projectInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!p,notUseTokenAccount:p,associatedOnly:p?!1:n,checkCreateATAOwner:o});!d&&l&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),l&&f&&r.addInstruction(f);let y=u.buyInfo.mint.address.equals(Z),{account:b,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.buyInfo.mint.programId,mint:u.buyInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!y,notUseTokenAccount:y,associatedOnly:y?!1:n,checkCreateATAOwner:o});if(!d&&m&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),m&&g&&r.addInstruction(g),(!d||!b)&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address,t.buyInfo.mint.address),c===3)return r.addInstruction({instructions:[...l?[as({programId:u.programId},{idoId:u.id,authority:u.authority,poolTokenAccount:u.projectInfo.vault,userTokenAccount:d,userIdoInfo:new $i(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[],...m?[as({programId:new $i(t.programId)},{idoId:u.id,authority:u.authority,poolTokenAccount:u.buyInfo.vault,userTokenAccount:b,userIdoInfo:new $i(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[]]}).versionBuild({txVersion:s});if(c<3)return!l&&!m&&this.logAndCreateError("no claimable rewards"),r.addInstruction({instructions:[as({programId:u.programId},{idoId:u.id,authority:u.authority,poolQuoteTokenAccount:u.buyInfo.vault,poolBaseTokenAccount:u.projectInfo.vault,userQuoteTokenAccount:b,userBaseTokenAccount:d,userIdoInfo:new $i(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]}).versionBuild({txVersion:s});let A={poolConfig:{id:u.id,programId:u.programId,authority:u.authority,baseVault:u.projectInfo.vault,quoteVault:u.buyInfo.vault,baseToken:t.projectInfo.mint,quoteToken:t.buyInfo.mint},userKeys:{baseTokenAccount:d,quoteTokenAccount:b,ledgerAccount:new $i(e.userIdoInfo),owner:this.scope.ownerPubKey}};return r.addInstruction({instructions:[...l?[du(q(v({},A),{side:"base"}))]:[],...m?[du(q(v({},A),{side:"quote"}))]:[]]}).versionBuild({txVersion:s})}};var sy=Buffer.from("vault_auth_seed","utf8"),ay=Buffer.from("global_config","utf8"),uy=Buffer.from("pool_vesting","utf8"),cy=Buffer.from("platform_config","utf8"),ly=Buffer.from("platform_fee_vault_auth_seed","utf8"),my=Buffer.from("creator_fee_vault_auth_seed","utf8");function yn(a){return ne([sy],a)}function AR(a,e,t,n){return ne([ay,e.toBuffer(),dy(t),_r(n)],a)}function Uo(a,e,t){return ne([Ra,e.toBuffer(),t.toBuffer()],a)}function pu(a,e,t){return ne([La,e.toBuffer(),t.toBuffer()],a)}function Ao(a){return ne([Buffer.from("__event_authority","utf8")],a)}function dy(a){let e=new ArrayBuffer(1);return new DataView(e).setUint8(0,a),new Uint8Array(e)}function fu(a,e){return ne([cy,e.toBuffer()],a)}function Ji(a,e,t){return ne([uy,e.toBuffer(),t.toBuffer()],a)}function Go(a,e,t){return ne([e.toBuffer(),t.toBuffer()],a)}function yu(a){return ne([ly],a)}function er(a,e,t){return ne([e.toBuffer(),t.toBuffer()],a)}function em(a){return ne([my],a)}import{SystemProgram as jt,TransactionInstruction as Et}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as us,TOKEN_2022_PROGRAM_ID as py,TOKEN_PROGRAM_ID as bu}from"@solana/spl-token";import tr from"bn.js";var Dt={initialize:Buffer.from([175,175,109,31,13,152,155,237]),buyExactIn:Buffer.from([250,234,13,123,213,156,19,236]),buyExactOut:Buffer.from([24,211,116,40,105,3,153,56]),sellExactIn:Buffer.from([149,39,222,155,211,124,152,26]),sellExactOut:Buffer.from([95,200,71,34,8,9,11,166]),createVestingAccount:Buffer.from([129,178,2,13,217,172,230,218]),claimVestedToken:Buffer.from([49,33,104,30,189,157,79,35]),createPlatformConfig:Buffer.from([176,90,196,175,253,113,220,20]),claimPlatformFee:Buffer.from([156,39,208,135,76,237,61,72]),updatePlaformConfig:Buffer.from([195,60,76,129,146,45,67,143]),initializeWithToken2022:Buffer.from([37,190,126,222,44,154,171,17]),claimPlatformFeeFromVault:Buffer.from([117,241,198,168,248,218,80,29]),claimCreatorFee:Buffer.from([26,97,138,203,132,171,141,252])};function tm(a,e,t,n,o,s,i,r,c,u,l,m,p,d,f,y,b,g,A,h){let I=F([W("decimals"),Kt("name"),Kt("symbol"),Kt("uri")]),T=F([k("totalLockedAmount"),k("cliffPeriod"),k("unlockPeriod")]),w=F([W("index"),k("supply"),k("totalFundRaisingB"),W("migrateType")]),S=F([W("index"),k("supply"),k("totalSellA"),k("totalFundRaisingB"),W("migrateType")]),x=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:bu,isSigner:!1,isWritable:!1},{pubkey:bu,isSigner:!1,isWritable:!1},{pubkey:en,isSigner:!1,isWritable:!1},{pubkey:jt.programId,isSigner:!1,isWritable:!1},{pubkey:nt,isSigner:!1,isWritable:!1},{pubkey:Ao(a).publicKey,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!1}],K=Buffer.alloc(Buffer.from(d,"utf-8").length+Buffer.from(f,"utf-8").length+Buffer.from(y,"utf-8").length+4*3+1),B=Buffer.alloc(T.span),C=Buffer.alloc(b.type==="ConstantCurve"?S.span:w.span);return I.encode({decimals:p,name:d,symbol:f,uri:y},K),b.type==="ConstantCurve"?S.encode(q(v({index:0},b),{migrateType:b.migrateType==="amm"?0:1}),C):b.type==="FixedCurve"?w.encode(q(v({index:1},b),{migrateType:b.migrateType==="amm"?0:1}),C):b.type==="LinearCurve"&&w.encode(q(v({index:2},b),{migrateType:b.migrateType==="amm"?0:1}),C),T.encode({totalLockedAmount:g,cliffPeriod:A,unlockPeriod:h},B),new Et({keys:x,programId:a,data:Buffer.from([...Dt.initialize,...K,...C,...B])})}function nm(a,e,t,n,o,s,i,r,c,u,l,m,p,d,f,y,b,g,A,h){let I=F([W("decimals"),Kt("name"),Kt("symbol"),Kt("uri")]),T=F([k("totalLockedAmount"),k("cliffPeriod"),k("unlockPeriod"),W("transferFeeExtensionParamsOption"),F([Mt("transferFeeBasePoints"),k("maxinumFee")]).replicate("transferFeeExtensionParams")]),w=F([W("index"),k("supply"),k("totalFundRaisingB"),W("migrateType")]),S=F([W("index"),k("supply"),k("totalSellA"),k("totalFundRaisingB"),W("migrateType")]),x=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:py,isSigner:!1,isWritable:!1},{pubkey:bu,isSigner:!1,isWritable:!1},{pubkey:jt.programId,isSigner:!1,isWritable:!1},{pubkey:Ao(a).publicKey,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!1}],K=Buffer.alloc(Buffer.from(p,"utf-8").length+Buffer.from(d,"utf-8").length+Buffer.from(f,"utf-8").length+4*3+1),B=Buffer.alloc(T.span),C=Buffer.alloc(y.type==="ConstantCurve"?S.span:w.span);return I.encode({decimals:m,name:p,symbol:d,uri:f},K),y.type==="ConstantCurve"?S.encode(q(v({index:0},y),{migrateType:y.migrateType==="amm"?0:1}),C):y.type==="FixedCurve"?w.encode(q(v({index:1},y),{migrateType:y.migrateType==="amm"?0:1}),C):y.type==="LinearCurve"&&w.encode(q(v({index:2},y),{migrateType:y.migrateType==="amm"?0:1}),C),T.encode({totalLockedAmount:b,cliffPeriod:g,unlockPeriod:A,transferFeeExtensionParamsOption:h?1:0,transferFeeExtensionParams:h!=null?h:{transferFeeBasePoints:0,maxinumFee:new tr(0)}},B),new Et({keys:x,programId:a,data:Buffer.from([...Dt.initializeWithToken2022,...K,...C,...B])})}function KR(a,e,t,n,o,s,i,r,c,u,l,m,p,d,f,y,b,g,A,h){let I=F([k("amountB"),k("minAmountA"),k("shareFeeRate")]),T=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:Ao(a).publicKey,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!1}];h&&T.push({pubkey:h,isSigner:!1,isWritable:!0}),T.push({pubkey:jt.programId,isSigner:!1,isWritable:!1}),T.push({pubkey:f,isSigner:!1,isWritable:!0}),T.push({pubkey:y,isSigner:!1,isWritable:!0});let w=Buffer.alloc(I.span);return I.encode({amountB:b,minAmountA:g,shareFeeRate:A!=null?A:new tr(0)},w),new Et({keys:T,programId:a,data:Buffer.from([...Dt.buyExactIn,...w])})}function om(a,e,t,n,o,s,i,r,c,u,l,m,p,d,f,y,b,g,A,h){let I=F([k("amountA"),k("maxAmountB"),k("shareFeeRate")]),T=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:Ao(a).publicKey,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!1}];h&&T.push({pubkey:h,isSigner:!1,isWritable:!0}),T.push({pubkey:jt.programId,isSigner:!1,isWritable:!1}),T.push({pubkey:f,isSigner:!1,isWritable:!0}),T.push({pubkey:y,isSigner:!1,isWritable:!0});let w=Buffer.alloc(I.span);return I.encode({amountA:b,maxAmountB:g,shareFeeRate:A!=null?A:new tr(0)},w),new Et({keys:T,programId:a,data:Buffer.from([...Dt.buyExactOut,...w])})}function im(a,e,t,n,o,s,i,r,c,u,l,m,p,d,f,y,b,g,A,h){let I=F([k("amountA"),k("minAmountB"),k("shareFeeRate")]),T=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:Ao(a).publicKey,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!1}];h&&T.push({pubkey:h,isSigner:!1,isWritable:!0}),T.push({pubkey:jt.programId,isSigner:!1,isWritable:!1}),T.push({pubkey:f,isSigner:!1,isWritable:!0}),T.push({pubkey:y,isSigner:!1,isWritable:!0});let w=Buffer.alloc(I.span);return I.encode({amountA:b,minAmountB:g,shareFeeRate:A!=null?A:new tr(0)},w),new Et({keys:T,programId:a,data:Buffer.from([...Dt.sellExactIn,...w])})}function rm(a,e,t,n,o,s,i,r,c,u,l,m,p,d,f,y,b,g,A,h){let I=F([k("amountB"),k("maxAmountA"),k("shareFeeRate")]),T=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:Ao(a).publicKey,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!1}];h&&T.push({pubkey:h,isSigner:!1,isWritable:!0}),T.push({pubkey:jt.programId,isSigner:!1,isWritable:!1}),T.push({pubkey:f,isSigner:!1,isWritable:!0}),T.push({pubkey:y,isSigner:!1,isWritable:!0});let w=Buffer.alloc(I.span);return I.encode({amountB:b,maxAmountA:g,shareFeeRate:A!=null?A:new tr(0)},w),new Et({keys:T,programId:a,data:Buffer.from([...Dt.sellExactOut,...w])})}function gu(a,e,t,n,o,s,i,r,c){let u=F([]),l=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:jt.programId,isSigner:!1,isWritable:!1},{pubkey:us,isSigner:!1,isWritable:!1}],m=Buffer.alloc(u.span);return u.encode({},m),new Et({keys:l,programId:a,data:Buffer.from([...Dt.claimVestedToken,...m])})}function Au(a,e,t,n,o,s){let i=F([k("shareAmount")]),r=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:jt.programId,isSigner:!1,isWritable:!1}],c=Buffer.alloc(i.span);return i.encode({shareAmount:s},c),new Et({keys:r,programId:a,data:Buffer.from([...Dt.createVestingAccount,...c])})}function Pu(a,e,t,n,o,s,i,r,c){let u=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:jt.programId,isSigner:!1,isWritable:!0},{pubkey:us,isSigner:!1,isWritable:!0}];return new Et({keys:u,programId:a,data:Dt.claimPlatformFee})}function sm(a,e,t,n,o,s,i,r,c,u,l,m,p){let d=F([k("platformScale"),k("creatorScale"),k("burnScale"),k("feeRate"),Kt("name"),Kt("web"),Kt("img"),k("creatorFeeRate")]),f=[{pubkey:e,isSigner:!0,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:jt.programId,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1}],y=Buffer.alloc(8*5+Buffer.from(l,"utf-8").length+Buffer.from(m,"utf-8").length+Buffer.from(p,"utf-8").length+4*3);return d.encode({platformScale:r.platformScale,creatorScale:r.creatorScale,burnScale:r.burnScale,feeRate:c,name:l,web:m,img:p,creatorFeeRate:u},y),new Et({keys:f,programId:a,data:Buffer.from([...Dt.createPlatformConfig,...y])})}function am(a,e,t,n){let o=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0}],s;if(n.type==="updateClaimFeeWallet"){let i=F([W("index"),N("value")]);s=Buffer.alloc(i.span),i.encode({index:0,value:n.value},s)}else if(n.type==="updateLockNftWallet"){let i=F([W("index"),N("value")]);s=Buffer.alloc(i.span),i.encode({index:1,value:n.value},s)}else if(n.type==="migrateCpLockNftScale"){let i=F([W("index"),k("platformScale"),k("creatorScale"),k("burnScale")]);s=Buffer.alloc(i.span),i.encode(v({index:2},n.value),s)}else if(n.type==="updateFeeRate"){let i=F([W("index"),k("value")]);s=Buffer.alloc(i.span),i.encode({index:3,value:n.value},s)}else if(n.type==="updateImg"||n.type==="updateName"||n.type==="updateWeb"){let i=F([W("index"),Kt("value")]);s=Buffer.alloc(Buffer.from(n.value,"utf-8").length+4+1*1),n.type==="updateName"?i.encode({index:4,value:n.value},s):n.type==="updateWeb"?i.encode({index:5,value:n.value},s):n.type==="updateImg"&&i.encode({index:6,value:n.value},s)}else if(n.type==="updateCpConfigId"){o.push({pubkey:n.value,isSigner:!1,isWritable:!1});let i=F([W("index")]);s=Buffer.alloc(i.span),i.encode({index:7},s)}else if(n.type==="updateAll"){o.push({pubkey:n.value.cpConfigId,isSigner:!1,isWritable:!1});let i=F([W("index"),N("platformClaimFeeWallet"),N("platformLockNftWallet"),k("platformScale"),k("creatorScale"),k("burnScale"),k("feeRate"),Kt("name"),Kt("web"),Kt("img"),N("transferFeeExtensionAuth"),k("creatorFeeRate")]);s=Buffer.alloc(1+32+32+8*4+4*3+Buffer.from(n.value.name,"utf-8").length+Buffer.from(n.value.web,"utf-8").length+Buffer.from(n.value.img,"utf-8").length),i.encode({index:8,platformClaimFeeWallet:n.value.platformClaimFeeWallet,platformLockNftWallet:n.value.platformLockNftWallet,platformScale:n.value.migrateCpLockNftScale.platformScale,creatorScale:n.value.migrateCpLockNftScale.creatorScale,burnScale:n.value.migrateCpLockNftScale.burnScale,feeRate:n.value.feeRate,name:n.value.name,web:n.value.web,img:n.value.img,transferFeeExtensionAuth:n.value.transferFeeExtensionAuth,creatorFeeRate:n.value.creatorFeeRate},s)}else throw Error("updateInfo params type error");return new Et({keys:o,programId:a,data:Buffer.from([...Dt.updatePlaformConfig,...s])})}function ku(a,e,t,n,o,s,i,r){let c=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:jt.programId,isSigner:!1,isWritable:!1},{pubkey:us,isSigner:!1,isWritable:!1}];return new Et({keys:c,programId:a,data:Dt.claimPlatformFeeFromVault})}function um(a,e,t,n,o,s,i){let r=[{pubkey:e,isSigner:!0,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:jt.programId,isSigner:!1,isWritable:!1},{pubkey:us,isSigner:!1,isWritable:!1}];return new Et({keys:r,programId:a,data:Dt.claimCreatorFee})}import{NATIVE_MINT as Ln,TOKEN_2022_PROGRAM_ID as Yn,TOKEN_PROGRAM_ID as $e,createAssociatedTokenAccountIdempotentInstruction as un,getTransferFeeConfig as ys,unpackMint as bs}from"@solana/spl-token";import se from"bn.js";import{PublicKey as lm}from"@solana/web3.js";var zn=F([k(),k("epoch"),W("curveType"),Mt("index"),k("migrateFee"),k("tradeFeeRate"),k("maxShareFeeRate"),k("minSupplyA"),k("maxLockRate"),k("minSellRateA"),k("minMigrateRateA"),k("minFundRaisingB"),N("mintB"),N("protocolFeeOwner"),N("migrateFeeOwner"),N("migrateToAmmWallet"),N("migrateToCpmmWallet"),Q(k(),16)]),fy=F([k("totalLockedAmount"),k("cliffPeriod"),k("unlockPeriod"),k("startTime"),k("totalAllocatedShare")]),an=F([k(),k("epoch"),W("bump"),W("status"),W("mintDecimalsA"),W("mintDecimalsB"),W("migrateType"),k("supply"),k("totalSellA"),k("virtualA"),k("virtualB"),k("realA"),k("realB"),k("totalFundRaisingB"),k("protocolFee"),k("platformFee"),k("migrateFee"),fy.replicate("vestingSchedule"),N("configId"),N("platformId"),N("mintA"),N("mintB"),N("vaultA"),N("vaultB"),N("creator"),W("mintProgramFlag"),Q(W(),63)]),LR=F([k(),k("epoch"),N("poolId"),N("beneficiary"),k("claimedAmount"),k("tokenShareAmount"),Q(k(),8)]),Xo=F([k(),k("epoch"),N("platformClaimFeeWallet"),N("platformLockNftWallet"),k("platformScale"),k("creatorScale"),k("burnScale"),k("feeRate"),Q(W(),64,"name"),Q(W(),256,"web"),Q(W(),256,"img"),N("cpConfigId"),k("creatorFeeRate"),N("transferFeeExtensionAuth"),Q(W(),184)]);import Ht from"bn.js";import cm from"decimal.js";import cs from"bn.js";import nr from"decimal.js";var Qn=class{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){throw Error()}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:s,decimalA:i,decimalB:r}){throw Error()}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:s}){throw Error()}static buyExactIn({poolInfo:e,amount:t}){throw Error()}static buyExactOut({poolInfo:e,amount:t}){throw Error()}static sellExactIn({poolInfo:e,amount:t}){throw Error()}static sellExactOut({poolInfo:e,amount:t}){throw Error()}};var ls=class extends Qn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new nr(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){return new nr(t.toString()).div(e.toString()).mul(10**(n-o))}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new nr(e.virtualB.add(e.realB).toString()).div(e.virtualA.sub(e.realA).toString()).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:s,decimalA:i,decimalB:r}){return new nr(o.sub(s).toString()).div(e.sub(t).sub(n).toString()).mul(10**(i-r))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let o=e.totalSellA.sub(e.realA),s=e.totalFundRaisingB.sub(e.realB);return new nr(e.virtualB.add(e.realB.add(s)).toString()).div(e.virtualA.sub(e.realA.add(o)).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:s}){if(e.lte(n))throw Error("supply need gt total sell");let i=e.sub(n).sub(o);if(i.lte(new cs(0)))throw Error("supplyMinusSellLocked <= 0");let r=t.sub(s);if(r.lte(new cs(0)))throw Error("tfMinusMf <= 0");let c=r.mul(n).mul(n).div(i),u=r.mul(n).div(i).sub(t),l=c.div(u),m=t.mul(t).div(u);if(l.lt(new cs(0))||m.lt(new cs(0)))throw Error("invalid input 0");return{a:l,b:m,c:n}}static buyExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,inputReserve:e.virtualB.add(e.realB),outputReserve:e.virtualA.sub(e.realA)})}static buyExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,inputReserve:e.virtualB.add(e.realB),outputReserve:e.virtualA.sub(e.realA)})}static sellExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,inputReserve:e.virtualA.sub(e.realA),outputReserve:e.virtualB.add(e.realB)})}static sellExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,inputReserve:e.virtualA.sub(e.realA),outputReserve:e.virtualB.add(e.realB)})}static getAmountOut({amountIn:e,inputReserve:t,outputReserve:n}){let o=e.mul(n),s=t.add(e);return o.div(s)}static getAmountIn({amountOut:e,inputReserve:t,outputReserve:n}){let o=t.mul(e),s=n.sub(e);return eo(o,s)}};import ms from"bn.js";import or from"decimal.js";var ds=class extends Qn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new or(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){return new or(t.toString()).div(e.toString()).mul(10**(n-o))}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new or(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:s,decimalA:i,decimalB:r}){return new or(o.sub(s).toString()).div(e.sub(t).sub(n).toString()).mul(10**(i-r))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let o=e.totalSellA.sub(e.realA),s=e.totalFundRaisingB.sub(e.realB);return new or(e.virtualB.add(e.realB).add(s).toString()).div(e.virtualA.sub(e.realA).add(o).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:s}){let i=e.sub(o);if(i.lte(new ms(0)))throw Error("invalid input 1");let r=new ms(2).mul(t).sub(s),u=t.mul(i).div(r);if(u.lt(new ms(0))||t.lt(new ms(0)))throw Error("invalid input 0");return{a:u,b:t,c:u}}static buyExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,initInput:e.virtualB,initOutput:e.virtualA})}static buyExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,initInput:e.virtualB,initOutput:e.virtualA})}static sellExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,initInput:e.virtualA,initOutput:e.virtualB})}static sellExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,initInput:e.virtualA,initOutput:e.virtualB})}static getAmountOut({amountIn:e,initInput:t,initOutput:n}){return n.mul(e).div(t)}static getAmountIn({amountOut:e,initInput:t,initOutput:n}){let o=t.mul(e);return eo(o,n)}};import Lt from"bn.js";import Po from"decimal.js";import zo from"bn.js";import ps from"decimal.js";var ir=class{static _multipler(e){return new ps(10).pow(e)}static getPrice({priceX64:e,decimalA:t,decimalB:n}){return new ps(e.toString()).div(this._Q64).mul(this._multipler(t)).div(this._multipler(n))}static getPriceX64({price:e,decimalA:t,decimalB:n}){let o=e.mul(this._multipler(n)).div(this._multipler(t));return new zo(o.mul(this._Q64).toFixed(0))}};ir._Q64=new ps(new zo(1).shln(64).toString());function YR({supply:a,totalFundRaisingB:e,totalLockedAmount:t,totalSellA:n,migrateType:o,decimalsA:s}){let i=a.sub(n).sub(t),r=new zo(new ps(i.mul(e).toString()).sqrt().toFixed(0));if(o==="amm"){if(r.gt(new zo(10).pow(new zo(s))))return!0}else if(o==="cpmm"){if(r.gt(new zo(100)))return!0}else throw Error("migrate type error");return!1}var fs=class extends Qn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new Po(0)}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){return new Po(0)}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new Po(e.virtualA.mul(e.realA).toString()).div(ir._Q64).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:s,decimalA:i,decimalB:r}){return new Po(o.sub(s).toString()).div(e.sub(t).sub(n).toString()).mul(10**(i-r))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let o=e.totalSellA.sub(e.realA),s=e.totalFundRaisingB.sub(e.realB);return new Po(e.virtualB.add(e.realB).add(s).toString()).div(e.virtualA.sub(e.realA).add(o).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:s}){let i=e.sub(o);if(i.lte(new Lt(0)))throw Error("supplyMinusLocked need gt 0");let r=t.mul(new Lt(3)).sub(s),u=t.mul(new Lt(2)).mul(i).div(r),l=u.mul(u),m=t.mul(new Lt(2)).mul(it).div(l);if(!m.gt(new Lt(0)))throw Error("a need gt 0");if(!xi.gt(m))throw Error("a need lt u64 max");if(m.lt(new Lt(0))||u.lt(new Lt(0)))throw Error("invalid input 0");return{a:m,b:new Lt(0),c:u}}static buyExactIn({poolInfo:e,amount:t}){let n=e.realB.add(t),o=new Lt(2).mul(n).mul(it).div(e.virtualA);return new Lt(new Po(o.toString()).sqrt().toFixed(0)).sub(e.realA)}static buyExactOut({poolInfo:e,amount:t}){let n=e.realA.add(t),o=n.mul(n);return eo(e.virtualA.mul(o),new Lt(2).mul(it)).sub(e.realB)}static sellExactIn({poolInfo:e,amount:t}){let n=e.realA.sub(t),o=n.mul(n),s=eo(e.virtualA.mul(o),new Lt(2).mul(it));return e.realB.sub(s)}static sellExactOut({poolInfo:e,amount:t}){let n=e.realB.sub(t),o=new Lt(2).mul(n).mul(it).div(e.virtualA),s=new Lt(new Po(o.toString()).sqrt().toFixed(0));return e.realA.sub(s)}};var Zt=class{static getPoolCurvePointByPoolInfo({curveType:e,pointCount:t,poolInfo:n}){return this.getPoolCurvePointByInit({curveType:e,pointCount:t,supply:n.supply,totalFundRaising:n.totalFundRaisingB,totalSell:n.totalSellA,totalLockedAmount:n.vestingSchedule.totalLockedAmount,migrateFee:n.migrateFee,decimalA:n.mintDecimalsA,decimalB:n.mintDecimalsB})}static getPoolCurvePointByInit({curveType:e,pointCount:t,supply:n,totalFundRaising:o,totalSell:s,totalLockedAmount:i,migrateFee:r,decimalA:c,decimalB:u}){if(t<3)throw Error("point count < 3");let l=this.getCurve(e),m=l.getInitParam({supply:n,totalFundRaising:o,totalSell:s,totalLockedAmount:i,migrateFee:r}),p=l.getPoolInitPriceByInit(q(v({},m),{decimalA:c,decimalB:u})),d=o.div(new Ht(t-1)),f=new Ht(0),y=[{price:p,totalSellSupply:0}],{a:b,b:g}=m,A=f,h=f;for(let I=1;I<t;I++){let T=I!==t-1?d:o.sub(h),w=this.buyExactIn({poolInfo:{virtualA:b,virtualB:g,realA:A,realB:h,totalFundRaisingB:o,totalSellA:s},amountB:T,protocolFeeRate:f,platformFeeRate:f,curveType:e,shareFeeRate:f,creatorFeeRate:f,transferFeeConfigA:void 0,slot:0});A=A.add(w.amountA.amount),h=h.add(w.amountB);let S=this.getPrice({poolInfo:{virtualA:b,virtualB:g,realA:A,realB:h},decimalA:c,decimalB:u,curveType:e});y.push({price:S,totalSellSupply:new cm(A.toString()).div(10**c).toNumber()})}return y}static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n,curveType:o}){return this.getCurve(o).getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n})}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o,curveType:s}){return this.getCurve(s).getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o})}static getPrice({poolInfo:e,curveType:t,decimalA:n,decimalB:o}){return this.getCurve(t).getPoolPrice({poolInfo:e,decimalA:n,decimalB:o})}static getEndPrice({poolInfo:e,curveType:t,decimalA:n,decimalB:o}){return this.getCurve(t).getPoolPrice({poolInfo:e,decimalA:n,decimalB:o})}static getPoolEndPriceReal({poolInfo:e,curveType:t,decimalA:n,decimalB:o}){return this.getCurve(t).getPoolEndPriceReal({poolInfo:e,decimalA:n,decimalB:o})}static checkParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,decimals:s,config:i,migrateType:r}){if(Number(s)!==6)throw Error("decimals = 6");if(e.mul(i.maxLockRate).div(nn).lt(o))throw Error("total lock amount gte max lock amount");if(e.lt(i.minSupplyA.mul(new Ht(10**s))))throw Error("supply lt min supply");let u=e.mul(i.minSellRateA).div(nn);if(n.lt(u))throw Error("invalid input");if(t.lt(i.minFundRaisingB))throw Error("total fund raising lt min fund raising");let l=e.sub(n).sub(o),m=e.mul(i.minMigrateRateA).div(nn);if(l.lt(m))throw Error("migrate lt min migrate amoount");let p=e.sub(n).sub(o),d=new Ht(new cm(p.mul(t).toString()).sqrt().toFixed(0));if(r==="amm"){let f=new Ht(10).pow(new Ht(s));if(d.lte(f))throw Error("check migrate lp error")}else if(r==="cpmm"){let f=new Ht(100);if(d.lte(f))throw Error("check migrate lp error")}else throw Error("migrate type error")}static buyExactIn({poolInfo:e,amountB:t,protocolFeeRate:n,platformFeeRate:o,curveType:s,shareFeeRate:i,creatorFeeRate:r,transferFeeConfigA:c,slot:u}){let l=this.totalFeeRate({protocolFeeRate:n,platformFeeRate:o,shareFeeRate:i,creatorFeeRate:r}),m=this.calculateFee({amount:t,feeRate:l}),p=t.sub(m),d=this.getCurve(s),f=d.buyExactIn({poolInfo:e,amount:p}),y=e.totalSellA.sub(e.realA),b,g,A;if(f.gt(y)){b=y;let I=d.buyExactOut({poolInfo:e,amount:b});g=this.calculatePreFee({postFeeAmount:I,feeRate:l}),A=g.sub(I)}else b=f,g=t,A=m;let h=this.splitFee({totalFee:A,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:i,creatorFeeRate:r});return{amountA:Gs(b,c,u),amountB:g,splitFee:h}}static buyExactOut({poolInfo:e,amountA:t,protocolFeeRate:n,platformFeeRate:o,curveType:s,shareFeeRate:i,creatorFeeRate:r,transferFeeConfigA:c,slot:u}){let l=e.totalSellA.sub(e.realA),m=Xs(t,c,u),p=m.fee?m.amount.add(m.fee):m.amount;t.gt(l)&&(p=l);let f=this.getCurve(s).buyExactOut({poolInfo:e,amount:p}),y=this.totalFeeRate({protocolFeeRate:n,platformFeeRate:o,shareFeeRate:i,creatorFeeRate:r}),b=this.calculatePreFee({postFeeAmount:f,feeRate:y}),g=b.sub(f),A=this.splitFee({totalFee:g,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:i,creatorFeeRate:r});return{amountA:m,amountB:b,splitFee:A}}static sellExactIn({poolInfo:e,amountA:t,protocolFeeRate:n,platformFeeRate:o,curveType:s,shareFeeRate:i,creatorFeeRate:r,transferFeeConfigA:c,slot:u}){let l=this.getCurve(s),m=Gs(t,c,u),p=m.fee?m.amount.sub(m.fee):m.amount,d=l.sellExactIn({poolInfo:e,amount:p}),f=this.calculateFee({amount:d,feeRate:this.totalFeeRate({protocolFeeRate:n,platformFeeRate:o,shareFeeRate:i,creatorFeeRate:r})}),y=this.splitFee({totalFee:f,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:i,creatorFeeRate:r});return{amountA:m,amountB:d.sub(f),splitFee:y}}static sellExactOut({poolInfo:e,amountB:t,protocolFeeRate:n,platformFeeRate:o,curveType:s,shareFeeRate:i,creatorFeeRate:r,transferFeeConfigA:c,slot:u}){let l=this.totalFeeRate({protocolFeeRate:n,platformFeeRate:o,shareFeeRate:i,creatorFeeRate:r}),m=this.calculatePreFee({postFeeAmount:t,feeRate:l});if(e.realB.lt(m))throw Error("Insufficient liquidity");let p=m.sub(t),f=Zt.getCurve(s).sellExactOut({poolInfo:e,amount:m});if(f.gt(e.realA))throw Error();let y=this.splitFee({totalFee:p,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:i,creatorFeeRate:r});return{amountA:Xs(f,c,u),amountB:t,splitFee:y}}static splitFee({totalFee:e,protocolFeeRate:t,platformFeeRate:n,shareFeeRate:o,creatorFeeRate:s}){let i=this.totalFeeRate({protocolFeeRate:t,platformFeeRate:n,shareFeeRate:o,creatorFeeRate:s}),r=i.isZero()?new Ht(0):e.mul(n).div(i),c=i.isZero()?new Ht(0):e.mul(o).div(i),u=i.isZero()?new Ht(0):e.mul(s).div(i),l=e.sub(r).sub(c).sub(u);return{platformFee:r,shareFee:c,protocolFee:l,creatorFee:u}}static calculateFee({amount:e,feeRate:t}){return br(e,t,nn)}static calculatePreFee({postFeeAmount:e,feeRate:t}){if(t.isZero())return e;let n=e.mul(nn),o=nn.sub(t);return n.add(o).sub(new Ht(1)).div(o)}static totalFeeRate({protocolFeeRate:e,platformFeeRate:t,shareFeeRate:n,creatorFeeRate:o}){if(e.add(t).add(n).add(o).gt(new Ht(1e6)))throw Error("total fee rate gt 1_000_000");return e.add(t).add(n).add(o)}static getCurve(e){switch(e){case 0:return ls;case 1:return ds;case 2:return fs}throw Error("find curve error")}};import Wt from"decimal.js";var ko={initPriceX64:new se("515752397214619"),supply:new se(1e15),totalSellA:new se(7931e11),totalFundRaisingB:new se(85e9),totalLockedAmount:new se("0"),cliffPeriod:new se("0"),unlockPeriod:new se("0"),decimals:6,virtualA:new se("1073471847374405"),virtualB:new se("30050573465"),realA:new se(0),realB:new se(0),protocolFee:new se(0),platformId:new lm("4Bu96XjU84XjPDSpveTVf6LYGCkfW5FK7SNkREWcEfV4"),vestingSchedule:{totalLockedAmount:new se(0),cliffPeriod:new se(0),unlockPeriod:new se(0),startTime:new se(0),totalAllocatedShare:new se(0)}},jn=new se(1e4),rr=class extends Ve{constructor(e){super(e)}async sayHello(){console.log("hello")}async createLaunchpad(L){var M=L,{programId:e=mt,authProgramId:t,platformId:n=ko.platformId,mintA:o,decimals:s=6,mintBDecimals:i=9,name:r,symbol:c,uri:u,migrateType:l,configId:m,snipers:p,configInfo:d,platformFeeRate:f,txVersion:y,computeBudgetConfig:b,txTipConfig:g,feePayer:A,buyAmount:h,minMintAAmount:I,slippage:T,associatedOnly:w=!0,checkCreateATAOwner:S=!1,extraSigners:x,token2022:K,transferFeeExtensionParams:B}=M,C=De(M,["programId","authProgramId","platformId","mintA","decimals","mintBDecimals","name","symbol","uri","migrateType","configId","snipers","configInfo","platformFeeRate","txVersion","computeBudgetConfig","txTipConfig","feePayer","buyAmount","minMintAAmount","slippage","associatedOnly","checkCreateATAOwner","extraSigners","token2022","transferFeeExtensionParams"]);var jo,Ot,ar,hu,Iu,Bu,xu,Su,Ku,Cu;let R=[],O=this.createTxBuilder(A);t=t!=null?t:yn(e).publicKey,K=!!B,K&&(l="cpmm");let _=d;if(!_&&m){let $t=await this.scope.connection.getAccountInfo(m);$t&&(_=zn.decode($t.data))}_||this.logAndCreateError("config not found");let X=_.mintB,j=_.curveType,{publicKey:ae}=Uo(e,o,X),{publicKey:le}=pu(e,ae,o),{publicKey:ie}=pu(e,ae,X),{publicKey:de}=xn(o);this.logDebug(`create token: ${o.toBase58()}, mintB: ${X.toBase58()}, decimals A:${s}/B:${i}, config:${m.toBase58()}`),c.length>10&&this.logAndCreateError("Symbol length should shorter than 11"),u||this.logAndCreateError("uri should not empty");let be=(jo=C==null?void 0:C.supply)!=null?jo:ko.supply,fe=(Ot=C==null?void 0:C.totalSellA)!=null?Ot:ko.totalSellA,te=(ar=C==null?void 0:C.totalFundRaisingB)!=null?ar:ko.totalFundRaisingB,xe=(hu=C==null?void 0:C.totalLockedAmount)!=null?hu:new se(0),Xe=f;if(!f){let $t=await this.scope.connection.getAccountInfo(n);$t||this.logAndCreateError("platform id not found:",n.toString()),Xe=Xo.decode($t.data).feeRate}let qt=Zt.getCurve(_.curveType).getInitParam({supply:be,totalFundRaising:te,totalSell:fe,totalLockedAmount:xe,migrateFee:_.migrateFee}),st={epoch:new se(896),bump:254,status:0,mintDecimalsA:s,mintDecimalsB:i,supply:be,totalSellA:fe,mintA:new lm(o),mintB:X,virtualA:qt.a,virtualB:qt.b,realA:ko.realA,realB:ko.realB,migrateFee:_.migrateFee,migrateType:l==="amm"?0:1,protocolFee:ko.protocolFee,platformFee:Xe,platformId:n,configId:m,vaultA:le,vaultB:ie,creator:this.scope.ownerPubKey,totalFundRaisingB:te,vestingSchedule:{totalLockedAmount:xe,cliffPeriod:new se(0),unlockPeriod:new se(0),startTime:new se(0),totalAllocatedShare:new se(0)},mintProgramFlag:K?1:0},at=Zt.getCurve(_.curveType),{c:Qo}=at.getInitParam({supply:st.supply,totalFundRaising:st.totalFundRaisingB,totalLockedAmount:xe,totalSell:_.curveType===0?st.totalSellA:new se(0),migrateFee:_.migrateFee});try{Zt.checkParam({supply:st.supply,totalFundRaising:st.totalFundRaisingB,totalSell:Qo,totalLockedAmount:xe,decimals:st.mintDecimalsA,config:_,migrateType:l}),this.logDebug("check init params success")}catch($t){this.logAndCreateError(`check create mint params failed, ${$t.message}`)}O.addInstruction({instructions:[K?nm(e,A!=null?A:this.scope.ownerPubKey,this.scope.ownerPubKey,m,n,t,ae,o,X,le,ie,s,r,c,u||"https://",{type:j===0?"ConstantCurve":j===1?"FixedCurve":j===2?"LinearCurve":"ConstantCurve",totalSellA:fe,migrateType:l,supply:be,totalFundRaisingB:te},xe,(Iu=C==null?void 0:C.cliffPeriod)!=null?Iu:new se(0),(Bu=C==null?void 0:C.unlockPeriod)!=null?Bu:new se(0),B):tm(e,A!=null?A:this.scope.ownerPubKey,this.scope.ownerPubKey,m,n,t,ae,o,X,le,ie,de,s,r,c,u||"https://",{type:j===0?"ConstantCurve":j===1?"FixedCurve":j===2?"LinearCurve":"ConstantCurve",totalSellA:fe,migrateType:l,supply:be,totalFundRaisingB:te},xe,(xu=C==null?void 0:C.cliffPeriod)!=null?xu:new se(0),(Su=C==null?void 0:C.unlockPeriod)!=null?Su:new se(0))]});let Yo=K?await this.scope.connection.getEpochInfo():void 0,cn=B?{epoch:BigInt((Yo==null?void 0:Yo.epoch)||0),maximumFee:BigInt((Ku=B==null?void 0:B.maxinumFee.toString())!=null?Ku:0),transferFeeBasisPoints:(Cu=B==null?void 0:B.transferFeeBasePoints)!=null?Cu:0}:void 0,wo={amountA:{amount:new se(0),fee:void 0,expirationTime:void 0},amountB:new se(0),splitFee:{platformFee:new se(0),shareFee:new se(0),protocolFee:new se(0),creatorFee:new se(0)}},To;if(x!=null&&x.length&&O.addInstruction({signers:x}),!C.createOnly){let{builder:$t,extInfo:mm}=await this.buyToken({programId:e,authProgramId:t,mintAProgram:K?Yn:void 0,mintA:o,mintB:X,poolInfo:st,buyAmount:h,minMintAAmount:I,shareFeeRate:C.shareFeeRate,shareFeeReceiver:C.shareFeeReceiver,configInfo:_,platformFeeRate:Xe,slippage:T,associatedOnly:w,checkCreateATAOwner:S,skipCheckMintA:!cn,transferFeeConfigA:cn?{transferFeeConfigAuthority:t,withdrawWithheldAuthority:t,withheldAmount:BigInt(0),olderTransferFee:cn,newerTransferFee:cn}:void 0});for(let Ru of p){let{builder:Ay,extInfo:Py,transaction:dm}=await this.buyToken({programId:e,authProgramId:t,mintAProgram:K?Yn:void 0,mintA:o,mintB:X,poolInfo:st,buyAmount:Ru.amount,minMintAAmount:I,shareFeeRate:C.shareFeeRate,shareFeeReceiver:C.shareFeeReceiver,configInfo:_,platformFeeRate:Xe,slippage:T,sniper:Ru,associatedOnly:w,checkCreateATAOwner:S,skipCheckMintA:!cn,transferFeeConfigA:cn?{transferFeeConfigAuthority:t,withdrawWithheldAuthority:t,withheldAmount:BigInt(0),olderTransferFee:cn,newerTransferFee:cn}:void 0});R.push(dm)}O.addInstruction(v({},$t.AllTxData)),wo=v({},mm),To=(this.scope.cluster==="devnet"||y===1)&&C.shareFeeReceiver?[$t.allInstructions[0]]:void 0}return O.addTipInstruction(g),y===0?{tx:await O.sizeCheckBuildV0({computeBudgetConfig:b,swapInfo:wo,splitIns:To,address:q(v({},st),{poolId:ae})}),txs:R}:{tx:await O.sizeCheckBuild({computeBudgetConfig:b,swapInfo:wo,splitIns:To,address:q(v({},st),{poolId:ae})}),txs:R}}async buyToken({programId:e=mt,authProgramId:t,mintA:n,mintAProgram:o=$e,mintB:s=Ln,poolInfo:i,configInfo:r,platformFeeRate:c,txVersion:u,computeBudgetConfig:l,txTipConfig:m,feePayer:p,buyAmount:d,minMintAAmount:f,slippage:y,shareFeeRate:b=new se(0),shareFeeReceiver:g,sniper:A,associatedOnly:h=!0,checkCreateATAOwner:I=!1,transferFeeConfigA:T,skipCheckMintA:w=!1}){var te,xe,Xe;d.lte(new se(0))&&this.logAndCreateError("buy amount should gt 0:",d.toString());let S=A?this.createSniperTxBuilder(A.owner,A.owner.publicKey):this.createTxBuilder(p),{publicKey:x}=Uo(e,n,s);t=t!=null?t:yn(e).publicKey;let K=T;if(!w)if(K)o=Yn;else{let ve=await this.scope.connection.getAccountInfo(n);if(ve&&ve.owner.equals(Yn)){o=ve.owner;let qt=bs(n,ve,o);K=ys(qt)||void 0}}let B=A?this.scope.account.getAssociatedTokenAccountByOwner(A.owner.publicKey,n,o):this.scope.account.getAssociatedTokenAccount(n,o),C=null,L=s.equals(Ln);console.log("userTokenAccountA: ",B),S.addInstruction({instructions:[un((A==null?void 0:A.owner.publicKey)||this.scope.ownerPubKey,B,(A==null?void 0:A.owner.publicKey)||this.scope.ownerPubKey,n,o)]});let{account:M,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({mint:s,owner:(A==null?void 0:A.owner.publicKey)||this.scope.ownerPubKey,createInfo:L?{payer:(A==null?void 0:A.owner.publicKey)||this.scope.ownerPubKey,amount:d}:void 0,skipCloseAccount:!L,notUseTokenAccount:L,associatedOnly:L?!1:h,checkCreateATAOwner:I});M&&(C=M),C===void 0&&this.logAndCreateError(`cannot found mintB(${s.toBase58()}) token accounts`,"tokenAccounts",this.scope.account.tokenAccounts);let O=i;if(!O){let ve=await this.scope.connection.getAccountInfo(x,{commitment:"processed"});ve||this.logAndCreateError("cannot found pool:",x.toBase58()),O=an.decode(ve.data)}let _=r,X=await Ne(this.scope.connection,[_?void 0:O.configId,O.platformId].filter(Boolean).map(ve=>({pubkey:ve})));if(!_){let ve=X.find(qt=>qt.pubkey.equals(O.configId));(!ve||!ve.accountInfo)&&this.logAndCreateError("config not found: ",O.configId.toBase58()),_=zn.decode(ve.accountInfo.data)}let j=X.find(ve=>ve.pubkey.equals(O.platformId));(!j||!j.accountInfo)&&this.logAndCreateError("platform info not found: ",O.configId.toBase58());let ae=Xo.decode(j.accountInfo.data);c=c||ae.feeRate;let le=Zt.buyExactIn({poolInfo:O,amountB:d,protocolFeeRate:_.tradeFeeRate,platformFeeRate:c,curveType:_.curveType,shareFeeRate:b,creatorFeeRate:ae.creatorFeeRate,transferFeeConfigA:K,slot:await this.scope.connection.getSlot()}),ie=new Wt(le.amountA.amount.toString()).sub((xe=(te=le.amountA.fee)==null?void 0:te.toString())!=null?xe:0),de=y?new Wt(jn.sub(y).toNumber()/jn.toNumber()).clampedTo(0,1):new Wt(1),be=f!=null?f:y?new se(ie.mul(de).toFixed(0)):le.amountA.amount.sub((Xe=le.amountA.fee)!=null?Xe:new se(0));le.amountB.lt(d)&&console.log(`maximum ${n.toBase58()} amount can buy is ${le.amountA.toString()}, input ${s.toBase58()} amount: ${le.amountB.toString()}`);let fe=g?H(g,s,$e).publicKey:void 0;return S.versionBuild({txVersion:u,extInfo:q(v({},le),{decimalOutAmount:ie,minDecimalOutAmount:new Wt(be.toString())})})}async buyTokenExactOut({programId:e=mt,authProgramId:t,mintA:n,mintAProgram:o=$e,mintB:s=Ln,poolInfo:i,configInfo:r,transferFeeConfigA:c,platformFeeRate:u,txVersion:l,computeBudgetConfig:m,txTipConfig:p,feePayer:d,maxBuyAmount:f,outAmount:y,slippage:b,shareFeeRate:g=new se(0),shareFeeReceiver:A,associatedOnly:h=!0,checkCreateATAOwner:I=!1,skipCheckMintA:T=!1}){y.lte(new se(0))&&this.logAndCreateError("out amount should gt 0:",y.toString());let w=this.createTxBuilder(d),{publicKey:S}=Uo(e,n,s);t=t!=null?t:yn(e).publicKey;let x=i;if(!x){let fe=await this.scope.connection.getAccountInfo(S,{commitment:"processed"});fe||this.logAndCreateError("cannot found pool:",S.toBase58()),x=an.decode(fe.data)}let K=r,B=await Ne(this.scope.connection,[K?void 0:x.configId,x.platformId].filter(Boolean).map(fe=>({pubkey:fe})));if(!K){let fe=B.find(te=>te.pubkey.equals(x.configId));(!fe||!fe.accountInfo)&&this.logAndCreateError("config not found: ",x.configId.toBase58()),K=zn.decode(fe.accountInfo.data)}let C=B.find(fe=>fe.pubkey.equals(x.platformId));(!C||!C.accountInfo)&&this.logAndCreateError("platform info not found: ",x.configId.toBase58());let L=Xo.decode(C.accountInfo.data);u=u||L.feeRate;let M=c;if(!T)if(M)o=Yn;else{let fe=await this.scope.connection.getAccountInfo(n);if(fe&&fe.owner.equals(Yn)){o=fe.owner;let te=bs(n,fe,o);M=ys(te)||void 0}}let R=Zt.buyExactOut({poolInfo:x,amountA:y,protocolFeeRate:K.tradeFeeRate,platformFeeRate:u,curveType:K.curveType,shareFeeRate:g,creatorFeeRate:L.creatorFeeRate,transferFeeConfigA:M,slot:await this.scope.connection.getSlot()}),O=new Wt(R.amountB.toString()),_=b?new Wt(jn.add(b).toNumber()/jn.toNumber()).clampedTo(0,Number.MIN_SAFE_INTEGER):new Wt(1),X=(f!=null?f:b)?new se(O.mul(_).toFixed(0)):R.amountB,j=this.scope.account.getAssociatedTokenAccount(n,o),ae=null,le=s.equals(Ln);w.addInstruction({instructions:[un(this.scope.ownerPubKey,j,this.scope.ownerPubKey,n,o)]});let{account:ie,instructionParams:de}=await this.scope.account.getOrCreateTokenAccount({mint:s,owner:this.scope.ownerPubKey,createInfo:le?{payer:this.scope.ownerPubKey,amount:R.amountB}:void 0,skipCloseAccount:!le,notUseTokenAccount:le,associatedOnly:le?!1:h,checkCreateATAOwner:I});ie&&(ae=ie),w.addInstruction(de||{}),ae===void 0&&this.logAndCreateError(`cannot found mintB(${s.toBase58()}) token accounts`,"tokenAccounts",this.scope.account.tokenAccounts);let be=A?H(A,s,$e).publicKey:void 0;return be&&w.addInstruction({instructions:[un(this.scope.ownerPubKey,be,A,s)]}),w.addInstruction({instructions:[om(e,this.scope.ownerPubKey,t,x.configId,x.platformId,S,j,ae,x.vaultA,x.vaultB,n,s,o,$e,Go(e,x.platformId,s).publicKey,er(e,x.creator,s).publicKey,y,X,g,be)]}),w.addCustomComputeBudget(m),w.addTipInstruction(p),w.versionBuild({txVersion:l,extInfo:{maxSpentAmount:X,outAmount:y}})}async sellToken({programId:e=mt,authProgramId:t,mintAProgram:n=$e,mintA:o,mintB:s=Ln,poolInfo:i,configInfo:r,platformFeeRate:c,txVersion:u,computeBudgetConfig:l,txTipConfig:m,feePayer:p,sellAmount:d,minAmountB:f,slippage:y,shareFeeRate:b=new se(0),shareFeeReceiver:g,associatedOnly:A=!0,checkCreateATAOwner:h=!1,skipCheckMintA:I=!1}){t=t!=null?t:yn(e).publicKey;let T=this.createTxBuilder(p);d.lte(new se(0))&&this.logAndCreateError("sell amount should be gt 0");let{publicKey:w}=Uo(e,o,s),S;if(!I){let te=await this.scope.connection.getAccountInfo(o);if(te&&te.owner.equals(Yn)){n=te.owner;let xe=bs(o,te,n);S=ys(xe)||void 0}}let x=null,K=null,B=s.equals(Ln),{account:C,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:n,mint:o,owner:this.scope.ownerPubKey,createInfo:void 0,skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:A,checkCreateATAOwner:h});C&&(x=C),T.addInstruction(L||{}),x===void 0&&this.logAndCreateError("cannot found mintA token accounts","tokenAccounts",this.scope.account.tokenAccounts);let{account:M,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({mint:s,owner:this.scope.ownerPubKey,createInfo:B?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!B,notUseTokenAccount:B,associatedOnly:B?!1:A,checkCreateATAOwner:h});M&&(K=M),T.addInstruction(R||{}),K===void 0&&this.logAndCreateError("cannot found mintB token accounts","tokenAccounts",this.scope.account.tokenAccounts);let O=i;if(!O){let te=await this.scope.connection.getAccountInfo(w,{commitment:"processed"});te||this.logAndCreateError("cannot found pool",w.toBase58()),O=an.decode(te.data)}let _=r,X=await Ne(this.scope.connection,[_?void 0:O.configId,O.platformId].filter(Boolean).map(te=>({pubkey:te})));if(!_){let te=X.find(xe=>xe.pubkey.equals(O.configId));(!te||!te.accountInfo)&&this.logAndCreateError("config not found: ",O.configId.toBase58()),_=zn.decode(te.accountInfo.data)}let j=X.find(te=>te.pubkey.equals(O.platformId));(!j||!j.accountInfo)&&this.logAndCreateError("platform info not found: ",O.configId.toBase58());let ae=Xo.decode(j.accountInfo.data);c=c||ae.feeRate;let le=Zt.sellExactIn({poolInfo:O,amountA:d,protocolFeeRate:_.tradeFeeRate,platformFeeRate:c,curveType:_.curveType,shareFeeRate:b,creatorFeeRate:ae.creatorFeeRate,transferFeeConfigA:S,slot:await this.scope.connection.getSlot()}),ie=new Wt(le.amountB.toString()),de=y?new Wt(jn.sub(y).toNumber()/jn.toNumber()).clampedTo(0,1):new Wt(1),be=f!=null?f:y?new se(ie.mul(de).toFixed(0)):le.amountB;be.lte(new se(0))&&this.logAndCreateError(`out ${s.toBase58()} amount should be gt 0`);let fe=g?H(g,s,$e).publicKey:void 0;return fe&&T.addInstruction({instructions:[un(this.scope.ownerPubKey,fe,g,s)]}),T.addInstruction({instructions:[im(e,this.scope.ownerPubKey,t,O.configId,O.platformId,w,x,K,O.vaultA,O.vaultB,o,s,n,$e,Go(e,O.platformId,s).publicKey,er(e,O.creator,s).publicKey,le.amountA.amount.lt(d)?le.amountA.amount:d,be,b,fe)]}),T.addCustomComputeBudget(l),T.addTipInstruction(m),T.versionBuild({txVersion:u,extInfo:{outAmount:be}})}async sellTokenExactOut({programId:e=mt,authProgramId:t,mintAProgram:n=$e,mintA:o,mintB:s=Ln,poolInfo:i,configInfo:r,platformFeeRate:c,txVersion:u,computeBudgetConfig:l,txTipConfig:m,feePayer:p,inAmount:d,maxSellAmount:f,slippage:y,shareFeeRate:b=new se(0),shareFeeReceiver:g,associatedOnly:A=!0,checkCreateATAOwner:h=!1,skipCheckMintA:I=!1}){t=t!=null?t:yn(e).publicKey;let T=this.createTxBuilder(p);f!=null&&f.lte(new se(0))&&this.logAndCreateError("max sell amount should be gt 0");let{publicKey:w}=Uo(e,o,s),S;if(!I){let te=await this.scope.connection.getAccountInfo(o);if(te&&te.owner.equals(Yn)){n=te.owner;let xe=bs(o,te,n);S=ys(xe)||void 0}}let x=null,K=null,B=s.equals(Ln),{account:C,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:n,mint:o,owner:this.scope.ownerPubKey,createInfo:void 0,skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:A,checkCreateATAOwner:h});C&&(x=C),T.addInstruction(L||{}),x===void 0&&this.logAndCreateError("cannot found mintA token accounts","tokenAccounts",this.scope.account.tokenAccounts);let{account:M,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({mint:s,owner:this.scope.ownerPubKey,createInfo:B?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!B,notUseTokenAccount:B,associatedOnly:B?!1:A,checkCreateATAOwner:h});M&&(K=M),T.addInstruction(R||{}),K===void 0&&this.logAndCreateError("cannot found mintB token accounts","tokenAccounts",this.scope.account.tokenAccounts);let O=i;if(!O){let te=await this.scope.connection.getAccountInfo(w,{commitment:"processed"});te||this.logAndCreateError("cannot found pool",w.toBase58()),O=an.decode(te.data)}let _=r,X=await Ne(this.scope.connection,[_?void 0:O.configId,O.platformId].filter(Boolean).map(te=>({pubkey:te})));if(!_){let te=X.find(xe=>xe.pubkey.equals(O.configId));(!te||!te.accountInfo)&&this.logAndCreateError("config not found: ",O.configId.toBase58()),_=zn.decode(te.accountInfo.data)}let j=X.find(te=>te.pubkey.equals(O.platformId));(!j||!j.accountInfo)&&this.logAndCreateError("platform info not found: ",O.configId.toBase58());let ae=Xo.decode(j.accountInfo.data);c=c||ae.feeRate;let le=Zt.sellExactOut({poolInfo:O,amountB:d,protocolFeeRate:_.tradeFeeRate,platformFeeRate:c,curveType:_.curveType,shareFeeRate:b,creatorFeeRate:ae.creatorFeeRate,transferFeeConfigA:S,slot:await this.scope.connection.getSlot()}),ie=new Wt(le.amountA.amount.toString()),de=y?new Wt(jn.add(y).toNumber()/jn.toNumber()).clampedTo(0,Number.MAX_SAFE_INTEGER):new Wt(1),be=(f!=null?f:y)?new se(ie.mul(de).toFixed(0)):le.amountA.amount,fe=g?H(g,s,$e).publicKey:void 0;return fe&&T.addInstruction({instructions:[un(this.scope.ownerPubKey,fe,g,s)]}),T.addInstruction({instructions:[rm(e,this.scope.ownerPubKey,t,O.configId,O.platformId,w,x,K,O.vaultA,O.vaultB,o,s,n,$e,Go(e,O.platformId,s).publicKey,er(e,O.creator,s).publicKey,d,be,b,fe)]}),T.addCustomComputeBudget(l),T.addTipInstruction(m),T.versionBuild({txVersion:u,extInfo:{maxSellAmount:be}})}async createPlatformConfig({programId:e=mt,platformAdmin:t,platformClaimFeeWallet:n,platformLockNftWallet:o,cpConfigId:s,migrateCpLockNftScale:i,transferFeeExtensionAuth:r,creatorFeeRate:c,feeRate:u,name:l,web:m,img:p,txVersion:d,computeBudgetConfig:f,txTipConfig:y,feePayer:b}){let g=this.createTxBuilder(b),{publicKey:A}=fu(e,t);return g.addInstruction({instructions:[sm(e,t,n,o,A,s,r,i,u,c,l,m,p)]}),g.addCustomComputeBudget(f),g.addTipInstruction(y),g.versionBuild({txVersion:d,extInfo:{platformId:A}})}async updatePlatformConfig({programId:e=mt,platformAdmin:t,platformId:n,updateInfo:o,txVersion:s,computeBudgetConfig:i,txTipConfig:r,feePayer:c}){let u=this.createTxBuilder(c),l=n!=null?n:fu(e,t).publicKey;return u.addInstruction({instructions:[am(e,t,l,o)]}),u.addCustomComputeBudget(i),u.addTipInstruction(r),u.versionBuild({txVersion:s})}async claimPlatformFee({programId:e=mt,authProgramId:t,platformId:n,poolId:o,platformClaimFeeWallet:s,mintB:i,vaultB:r,mintBProgram:c=$e,txVersion:u,computeBudgetConfig:l,txTipConfig:m,feePayer:p}){var g;let d=this.createTxBuilder(p);t=t!=null?t:yn(e).publicKey;let f=i,y=r;if(!f){let A=await this.scope.connection.getAccountInfo(o,{commitment:"processed"});A||this.logAndCreateError("cannot found pool:",o.toBase58());let h=an.decode(A.data),I=await this.scope.connection.getAccountInfo(h.configId,{commitment:"processed"});I||this.logAndCreateError("cannot found config:",h.configId.toBase58()),f=zn.decode(I.data).mintB,y=y!=null?y:h.vaultB}(!f||!y)&&this.logAndCreateError("cannot found mint info, mintB: ",f.toBase58(),", vaultB: ",(g=y==null?void 0:y.toBase58())!=null?g:"");let b=H(this.scope.ownerPubKey,f,$e).publicKey;return d.addInstruction({instructions:[un(this.scope.ownerPubKey,b,this.scope.ownerPubKey,f)]}),d.addInstruction({instructions:[Pu(e,s,t,o,n,y,b,f,c)]}),d.addCustomComputeBudget(l),d.addTipInstruction(m),d.versionBuild({txVersion:u})}async claimAllPlatformFee({programId:e=mt,authProgramId:t,platformId:n,platformClaimFeeWallet:o,txVersion:s,computeBudgetConfig:i,txTipConfig:r,feePayer:c}){let u=this.createTxBuilder(c);return t=t!=null?t:yn(e).publicKey,(await this.scope.connection.getProgramAccounts(e,{filters:[{dataSize:an.span},{memcmp:{offset:an.offsetOf("platformId"),bytes:n.toString()}}]})).forEach(m=>{let p=an.decode(m.account.data);if(p.platformFee.lte(new se(0)))return;let d=H(this.scope.ownerPubKey,p.mintB,$e).publicKey;u.addInstruction({instructions:[un(this.scope.ownerPubKey,d,this.scope.ownerPubKey,p.mintB)]}),u.addInstruction({instructions:[Pu(e,o,t,m.pubkey,n,p.vaultB,d,p.mintB,$e)]})}),u.addTipInstruction(r),s===0?u.sizeCheckBuildV0({computeBudgetConfig:i}):u.sizeCheckBuild({computeBudgetConfig:i})}async createVesting({programId:e=mt,poolId:t,beneficiary:n,shareAmount:o,txVersion:s,computeBudgetConfig:i,txTipConfig:r,feePayer:c}){let u=this.createTxBuilder(c),l=await this.getRpcPoolInfo({poolId:t});o.add(l.vestingSchedule.totalAllocatedShare).gt(l.vestingSchedule.totalLockedAmount)&&this.logAndCreateError("share amount exceed total locked amount");let m=Ji(e,t,n).publicKey;return u.addInstruction({instructions:[Au(e,this.scope.ownerPubKey,n,t,m,o)]}),u.addCustomComputeBudget(i),u.addTipInstruction(r),u.versionBuild({txVersion:s})}async createMultipleVesting({programId:e=mt,poolId:t,beneficiaryList:n,txVersion:o,computeBudgetConfig:s,feePayer:i}){let r=this.createTxBuilder(i);n.length===0&&this.logAndCreateError("beneficiaryList is null");let c=await this.getRpcPoolInfo({poolId:t});return n.reduce((l,m)=>l.add(m.shareAmount),c.vestingSchedule.totalAllocatedShare).gt(c.vestingSchedule.totalLockedAmount)&&this.logAndCreateError("share amount exceed total locked amount"),n.forEach(l=>{let m=Ji(e,t,l.wallet).publicKey;r.addInstruction({instructions:[Au(e,this.scope.ownerPubKey,l.wallet,t,m,l.shareAmount)]})}),o===0?r.sizeCheckBuildV0({computeBudgetConfig:s}):r.sizeCheckBuild({computeBudgetConfig:s})}async claimVesting({programId:e=mt,poolId:t,poolInfo:n,vestingRecord:o,txVersion:s,computeBudgetConfig:i,txTipConfig:r,feePayer:c}){let u=this.createTxBuilder(c),l=yn(e).publicKey,m=o||Ji(e,t,this.scope.ownerPubKey).publicKey,p=n;if(!p){let f=await this.scope.connection.getAccountInfo(t);f||this.logAndCreateError("pool not found"),p=an.decode(f.data)}let d=H(this.scope.ownerPubKey,p.mintA,$e).publicKey;return u.addInstruction({instructions:[un(this.scope.ownerPubKey,d,this.scope.ownerPubKey,p.mintA)]}),u.addInstruction({instructions:[gu(e,this.scope.ownerPubKey,l,t,m,d,p.vaultA,p.mintA,$e)]}),u.addCustomComputeBudget(i),u.addTipInstruction(r),u.versionBuild({txVersion:s})}async claimMultiVesting({programId:e=mt,poolIdList:t,poolsInfo:n={},vestingRecords:o={},txVersion:s,computeBudgetConfig:i,feePayer:r}){let c=this.createTxBuilder(r),u=v({},n),l=yn(e).publicKey,m=t.filter(p=>!u[p.toBase58()]);if(m.length){let p=await this.getRpcPoolsInfo({poolIdList:m});u=v(v({},u),p.poolInfoMap)}return t.forEach(p=>{let d=p.toBase58(),f=u[d];f||this.logAndCreateError(`pool info not found: ${d}`);let y=o[d]||Ji(e,p,this.scope.ownerPubKey).publicKey,b=H(this.scope.ownerPubKey,f.mintA,$e).publicKey;c.addInstruction({instructions:[un(this.scope.ownerPubKey,b,this.scope.ownerPubKey,f.mintA)]}),c.addInstruction({instructions:[gu(e,this.scope.ownerPubKey,l,p,y,b,f.vaultA,f.mintA,$e)]})}),s===0?c.sizeCheckBuildV0({computeBudgetConfig:i}):c.sizeCheckBuild({computeBudgetConfig:i})}async claimVaultPlatformFee({programId:e=mt,platformId:t,mintB:n,mintBProgram:o=$e,claimFeeWallet:s,txVersion:i,computeBudgetConfig:r,txTipConfig:c,feePayer:u}){let l=this.createTxBuilder(u),m=Go(e,t,n).publicKey,p=yu(e).publicKey,d=this.scope.account.getAssociatedTokenAccount(n,o);return l.addInstruction({instructions:[un(this.scope.ownerPubKey,d,this.scope.ownerPubKey,n,o),ku(e,t,s!=null?s:this.scope.ownerPubKey,p,m,d,n,o)]}),l.addCustomComputeBudget(r),l.addTipInstruction(c),l.versionBuild({txVersion:i})}async claimMultipleVaultPlatformFee({programId:e=mt,platformList:t,unwrapSol:n=!0,txVersion:o,computeBudgetConfig:s,feePayer:i,associatedOnly:r=!0,checkCreateATAOwner:c=!1}){let u=this.createTxBuilder(i),l={};return t.forEach(async m=>{var b,g;let p=yu(e).publicKey,d=Go(e,m.id,m.mintB).publicKey,f=m.mintB.equals(Ln)&&n,y=l[m.mintB.toBase58()];if(!y){let{account:A,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({mint:m.mintB,owner:this.scope.ownerPubKey,createInfo:f?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!f,notUseTokenAccount:f,associatedOnly:f?!1:r,checkCreateATAOwner:c});A&&(y=A),u.addInstruction(h||{}),y===void 0&&this.logAndCreateError(`cannot found platform ${m.id.toBase58()} mintB(${m.mintB.toBase58()}) token accounts`,"tokenAccounts",this.scope.account.tokenAccounts)}u.addInstruction({instructions:[ku(e,m.id,(b=m.claimFeeWallet)!=null?b:this.scope.ownerPubKey,d,p,y,m.mintB,(g=m.mintBProgram)!=null?g:$e)]})}),o===0?u.sizeCheckBuildV0({computeBudgetConfig:s}):u.sizeCheckBuild({computeBudgetConfig:s})}async claimCreatorFee({programId:e=mt,mintB:t,mintBProgram:n=$e,txVersion:o,computeBudgetConfig:s,txTipConfig:i,feePayer:r}){let c=this.createTxBuilder(r),u=er(e,this.scope.ownerPubKey,t).publicKey,l=em(e).publicKey,m=this.scope.account.getAssociatedTokenAccount(t,n);return c.addInstruction({instructions:[un(this.scope.ownerPubKey,m,this.scope.ownerPubKey,t,n),um(e,this.scope.ownerPubKey,l,u,m,t,n)]}),c.addCustomComputeBudget(s),c.addTipInstruction(i),c.versionBuild({txVersion:o})}async getRpcPoolInfo({poolId:e}){return(await this.getRpcPoolsInfo({poolIdList:[e]})).poolInfoMap[e.toBase58()]}async getRpcPoolsInfo({poolIdList:e,config:t}){let n=await Ne(this.scope.connection,e.map(c=>({pubkey:c})),t),o={},s=[];for(let c=0;c<e.length;c++){let u=n[c];if(u===null||!u.accountInfo)throw Error("fetch pool info error: "+e[c].toBase58());let l=an.decode(u.accountInfo.data);o[e[c].toBase58()]=q(v({},l),{poolId:u.accountInfo.owner}),s.push(l.configId)}let i=await Ne(this.scope.connection,s.map(c=>({pubkey:c})),t),r={};for(let c=0;c<s.length;c++){let u=i[c];if(u===null||!u.accountInfo)throw Error("fetch config info error: "+s[c].toBase58());let l=zn.decode(u.accountInfo.data);r[s[c].toBase58()]=q(v({},l),{configId:u.accountInfo.owner})}return{poolInfoMap:Object.keys(o).reduce((c,u)=>q(v({},c),{[u]:q(v({},o[u]),{configInfo:r[o[u].configId.toBase58()]})}),{})}}};import{PublicKey as yy}from"@solana/web3.js";import{MintLayout as by,TOKEN_2022_PROGRAM_ID as wu,TOKEN_PROGRAM_ID as Tu}from"@solana/spl-token";var sr=class extends Ve{constructor(t){super(t);this._tokenList=[];this._tokenMap=new Map;this._blackTokenMap=new Set;this._mintGroup={official:new Set,jup:new Set,extra:new Set};this._whiteMap=new Set;this._extraTokenList=[]}async load(t){this.checkDisabled();let{forceUpdate:n=!1,type:o="strict"}=t||{},{mintList:s,blacklist:i,whiteList:r}=await this.scope.fetchV3TokenList(n),c=await this.scope.fetchJupTokenList(n);this._tokenList=[],this._tokenMap=new Map,this._blackTokenMap=new Set(i),this._mintGroup={official:new Set,jup:new Set,extra:new Set},this._whiteMap=new Set(r),this._tokenMap.set(ln.address,ln),this._mintGroup.official.add(ln.address),s.forEach(u=>{var l;this._blackTokenMap.has(u.address)||(this._tokenMap.set(u.address,q(v({},u),{type:"raydium",priority:2,programId:(l=u.programId)!=null?l:u.tags.includes("token-2022")?wu.toBase58():Tu.toBase58()})),this._mintGroup.official.add(u.address))}),c.forEach(u=>{var l;this._blackTokenMap.has(u.address)||this._tokenMap.has(u.address)||(this._tokenMap.set(u.address,q(v({},u),{type:"jupiter",priority:1,programId:(l=u.programId)!=null?l:u.tags.includes("token-2022")?wu.toBase58():Tu.toBase58(),tags:u.freezeAuthority?[...u.tags||[],"hasFreeze"]:u.tags})),this._mintGroup.jup.add(u.address))}),this._extraTokenList.forEach(u=>{this._blackTokenMap.has(u.address)||this._tokenMap.has(u.address)||(this._tokenMap.set(u.address,q(v({},u),{type:"extra",priority:1,programId:u.programId||u.tags.includes("token-2022")?wu.toBase58():Tu.toBase58()})),this._mintGroup.extra.add(u.address))}),this._tokenList=Array.from(this._tokenMap).map(u=>u[1])}get tokenList(){return this._tokenList}get tokenMap(){return this._tokenMap}get blackTokenMap(){return this._blackTokenMap}get mintGroup(){return this._mintGroup}get whiteListMap(){return this._whiteMap}async getTokenInfo(t){if(!t)throw new Error("please input mint");let n=t.toString(),o=this._tokenMap.get(n);if(o)return o;if(n.toLocaleUpperCase()==="SOL")return ln;let s=(await this.scope.api.getTokenInfo([n]))[0];if(s)return this._mintGroup.extra.add(n),this._tokenMap.set(n,q(v({},s),{priority:2})),s;let i=await this.scope.connection.getAccountInfo(new yy(n));if(!i)throw new Error(`mint address not found: ${n}`);let r=by.decode(i.data),c=n.toString().substring(0,6),u={chainId:101,address:n,programId:i.owner.toBase58(),logoURI:"",symbol:c,name:c,decimals:r.decimals,tags:[],extensions:{},priority:0,type:"unknown"};return this._mintGroup.extra.add(n),this._tokenMap.set(n,u),u}};var gs=class{constructor(e){this.rawBalances=new Map;let{connection:t,cluster:n,owner:o,api:s,defaultChainTime:i,defaultChainTimeOffset:r,apiCacheTime:c,blockhashCommitment:u="confirmed",loopMultiTxStatus:l}=e;this._connection=t,this.cluster=n||"mainnet",this._owner=o?new Nt(o):void 0,this._signAllTransactions=e.signAllTransactions,this.blockhashCommitment=u,this.loopMultiTxStatus=l,this.api=s,this._apiCacheTime=c||5*60*1e3,this.logger=ye("Raydium"),this.farm=new Bi({scope:this,moduleName:"Raydium_Farm"}),this.account=new yi({scope:this,moduleName:"Raydium_Account",tokenAccounts:e.tokenAccounts,tokenAccountRawInfos:e.tokenAccountRawInfos}),this.liquidity=new Ei({scope:this,moduleName:"Raydium_LiquidityV2"}),this.token=new sr({scope:this,moduleName:"Raydium_tokenV2"}),this.tradeV2=new Hi({scope:this,moduleName:"Raydium_tradeV2"}),this.clmm=new Wi({scope:this,moduleName:"Raydium_clmm"}),this.cpmm=new zi({scope:this,moduleName:"Raydium_cpmm"}),this.utils1216=new Yt({scope:this,moduleName:"Raydium_utils1216"}),this.marketV2=new Eo({scope:this,moduleName:"Raydium_marketV2"}),this.ido=new qo({scope:this,moduleName:"Raydium_ido"}),this.launchpad=new rr({scope:this,moduleName:"Raydium_lauchpad"}),this.availability={};let m=new Date().getTime();this.apiData={},r&&(this._chainTime={fetched:m,value:{chainTime:i||Date.now()-r,offset:r}})}static async load(e){var l;let t=gy({cluster:"mainnet",owner:null,apiRequestInterval:3e5,apiRequestTimeout:1e4},e),{cluster:n,apiRequestTimeout:o,logCount:s,logRequests:i,urlConfigs:r}=t,c=new Br({cluster:n,timeout:o,urlConfigs:r,logCount:s,logRequests:i}),u=new gs(q(v({},t),{api:c}));return await u.fetchAvailabilityStatus((l=e.disableFeatureCheck)!=null?l:!0),e.disableLoadToken||await u.token.load({type:e.jupTokenType}),u}get owner(){return this._owner}get ownerPubKey(){if(!this._owner)throw new Error(xr);return this._owner.publicKey}setOwner(e){return this._owner=e?new Nt(e):void 0,this.account.resetTokenAccounts(),this}get connection(){if(!this._connection)throw new Error(uc);return this._connection}setConnection(e){return this._connection=e,this}get signAllTransactions(){return this._signAllTransactions}setSignAllTransactions(e){return this._signAllTransactions=e,this}checkOwner(){if(!this.owner)throw console.error(xr),new Error(xr)}isCacheInvalidate(e){return new Date().getTime()-e>this._apiCacheTime}async fetchChainTime(){try{let e=await this.api.getChainTimeOffset();this._chainTime={fetched:Date.now(),value:{chainTime:Date.now()+e.offset*1e3,offset:e.offset*1e3}}}catch{this._chainTime=void 0}}async fetchV3TokenList(e){if(this.apiData.tokenList&&!this.isCacheInvalidate(this.apiData.tokenList.fetched)&&!e)return this.apiData.tokenList.data;try{let t=await this.api.getTokenList(),n={fetched:Date.now(),data:t};return this.apiData.tokenList=n,n.data}catch(t){return console.error(t),{mintList:[],blacklist:[],whiteList:[]}}}async fetchJupTokenList(e){if(this.cluster==="devnet")return[];let t=this.apiData.jupTokenList;if(t&&!this.isCacheInvalidate(t.fetched)&&!e)return t.data;try{let n=await this.api.getJupTokenList();return this.apiData.jupTokenList={fetched:Date.now(),data:n.map(o=>q(v({},o),{mintAuthority:o.mint_authority||void 0,freezeAuthority:o.freeze_authority||void 0}))},this.apiData.jupTokenList.data}catch(n){return console.error(n),[]}}get chainTimeData(){var e;return(e=this._chainTime)==null?void 0:e.value}async chainTimeOffset(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.offset:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.offset)||0)}async currentBlockChainTime(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.chainTime:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.chainTime)||Date.now())}async fetchEpochInfo(){return this._epochInfo&&Date.now()-this._epochInfo.fetched<=1e3*30?this._epochInfo.value:(this._epochInfo={fetched:Date.now(),value:await this.connection.getEpochInfo()},this._epochInfo.value)}async fetchAvailabilityStatus(e){if(e)return{};try{let t=await this.api.fetchAvailabilityStatus(),n=t.all===!1;return this.availability={all:t.all,swap:n?!1:t.swap,createConcentratedPosition:n?!1:t.createConcentratedPosition,addConcentratedPosition:n?!1:t.addConcentratedPosition,addStandardPosition:n?!1:t.addStandardPosition,removeConcentratedPosition:n?!1:t.removeConcentratedPosition,removeStandardPosition:n?!1:t.removeStandardPosition,addFarm:n?!1:t.addFarm,removeFarm:n?!1:t.removeFarm},t}catch{return{}}}};var y0=a=>a;export{Ly as ACCOUNT_TYPE_SIZE,wt as ALL_PROGRAM_ID,jp as AMM_CONFIG_SEED,$m as AMM_STABLE,oi as AMM_V4,Ab as ANAMint,dt as API_URLS,sy as AUTH_SEED,wm as AccountType,Br as Api,Qc as BIT_PRECISION,St as BNDivCeil,no as BNLayout,Bg as BN_100,xg as BN_1000,Sg as BN_10000,Ig as BN_FIVE,Xu as BN_ONE,Zn as BN_TEN,hg as BN_THREE,Tg as BN_TWO,et as BN_ZERO,UP as BitStructure,bc as Blob,ii as CLMM_LOCK_AUTH_ID,Bo as CLMM_LOCK_PROGRAM_ID,Mn as CLMM_PROGRAM_ID,Cs as CLOCK_PROGRAM_ID,ay as CONFIG_SEED,Us as CREATE_CPMM_POOL_AUTH,id as CREATE_CPMM_POOL_FEE_ACC,ri as CREATE_CPMM_POOL_PROGRAM,my as CREATOR_FEE_VAULT_AUTH_SEED,Wi as Clmm,ul as ClmmConfigLayout,Re as ClmmInstrument,Hr as ConstantProductCurve,Gl as CpmmConfigInfoLayout,Zr as CpmmFee,ts as CpmmPoolInfoLayout,Jo as Currency,Hn as CurrencyAmount,Zt as Curve,Qn as CurveBase,Jr as CurveCalculator,kn as DEVNET_PROGRAM_ID,QA as DEV_API_URLS,Ow as DEV_FARM_LOCK_MINT,Nw as DEV_FARM_LOCK_VAULT,iA as DEV_LAUNCHPAD_AUTH,oA as DEV_LAUNCHPAD_PROGRAM,xo as DEV_LOOKUP_TABLE_CACHE,Af as DataElement,Pb as ETHMint,Fa as EXTENSION_TICKARRAY_BITMAP_SIZE,Nc as FARM_LOCK_MINT,Mc as FARM_LOCK_VAULT,_s as FARM_PROGRAM_ID_V3,Es as FARM_PROGRAM_ID_V4,Ds as FARM_PROGRAM_ID_V5,Io as FARM_PROGRAM_ID_V6,Ut as FARM_PROGRAM_TO_VERSION,Fc as FARM_VERSION_TO_LEDGER_LAYOUT,vc as FARM_VERSION_TO_STATE_LAYOUT,qs as FEE_DESTINATION_ID,Vr as FEE_RATE_DENOMINATOR,nn as FEE_RATE_DENOMINATOR_VALUE,nf as FETCH_TICKARRAY_COUNT,Yp as Fee,ds as FixedPriceCurve,me as Fraction,ui as IDO_ALL_PROGRAM,ed as IDO_PROGRAM_ID_V1,td as IDO_PROGRAM_ID_V2,nd as IDO_PROGRAM_ID_V3,od as IDO_PROGRAM_ID_V4,pr as INSTRUCTION_PROGRAM_ID,U as InstructionType,ic as JupTokenType,rd as LAUNCHPAD_AUTH,ad as LAUNCHPAD_CONFIG,sd as LAUNCHPAD_PLATFORM,mt as LAUNCHPAD_PROGRAM,qr as LIQUIDITY_FEES_DENOMINATOR,Da as LIQUIDITY_FEES_NUMERATOR,wr as LIQUIDITY_POOL_PROGRAM_ID_V5_MODEL,df as LIQUIDITY_VERSION_TO_SERUM_VERSION,JI as LIQUIDITY_VERSION_TO_STATE_LAYOUT,ai as LOCK_CPMM_AUTH,si as LOCK_CPMM_PROGRAM,Qf as LOCK_LIQUIDITY_SEED,Yc as LOG_B_2_X32,jc as LOG_B_P_ERR_MARGIN_LOWER_X64,Hc as LOG_B_P_ERR_MARGIN_UPPER_X64,ci as LOOKUP_TABLE_CACHE,ls as LaunchConstantProductCurve,zn as LaunchpadConfig,an as LaunchpadPool,ko as LaunchpadPoolInitParam,LR as LaunchpadVesting,pi as Layout,fs as LinearPriceCurve,Pe as LiquidityMath,ml as LockClPositionLayoutV2,mI as LockPositionLayout,bm as LogLevel,ks as Logger,Ja as MARKET_STATE_LAYOUT_V2,iu as MARKET_STATE_LAYOUT_V3,Yl as MARKET_VERSION_TO_STATE_LAYOUT,ec as MAX_BASE64_SIZE,zt as MAX_SQRT_PRICE_X64,Fr as MAX_SQRT_PRICE_X64_SUB_ONE,It as MAX_TICK,dr as MEMO_PROGRAM_ID,mn as MEMO_PROGRAM_ID2,en as METADATA_PROGRAM_ID,Xt as MIN_SQRT_PRICE_X64,vr as MIN_SQRT_PRICE_X64_ADD_ONE,At as MIN_TICK,vn as MODEL_DATA_PUBKEY,is as Market,ir as MathLaunch,ce as MathUtil,xi as MaxU64,zc as MaxUint128,Bn as NEGATIVE_ONE,gb as NRVMint,ef as OBSERVATION_SEED,vt as ONE,Ws as OPEN_BOOK_PROGRAM,$p as OPERATION_SEED,cl as ObservationInfoLayout,sf as ObservationLayout,ll as OperationLayout,ia as OptionLayout,Nt as Owner,lb as PAIMint,ly as PLATFORM_FEE_VAULT_AUTH_SEED,cy as PLATFORM_SEED,il as POOL_LOCK_ID_SEED,Hp as POOL_REWARD_VAULT_SEED,Ra as POOL_SEED,Jp as POOL_TICK_ARRAY_BITMAP_SEED,La as POOL_VAULT_SEED,uy as POOL_VESTING_SEED,el as POSITION_SEED,ze as Percent,Xo as PlatformConfig,rc as PoolFetchType,so as PoolInfoLayout,Me as PoolUtils,vo as PositionInfoLayout,uf as PositionRewardInfoLayout,Ri as PositionUtils,lt as Price,lI as ProtocolPositionLayout,Mr as Q128,it as Q64,cb as RAYMint,nt as RENT_PROGRAM_ID,gs as Raydium,af as RewardInfo,vl as RoundDirection,Is as Rounding,Jm as Router,zl as SERUM_PROGRAMID_TO_VERSION,kr as SERUM_PROGRAM_ID_V3,Ql as SERUM_VERSION_TO_PROGRAMID,sc as SESSION_KEY,ct as SOLMint,ln as SOL_INFO,yl as SPL_MINT_LAYOUT,mb as SRMMint,Ys as STORAGE_KEY,tf as SUPPORT_MINT_SEED,fr as SYSTEM_PROGRAM_ID,re as SqrtPriceMath,_o as StableLayout,ra as Structure,ro as SwapMath,io as TICK_ARRAY_BITMAP_SIZE,Zp as TICK_ARRAY_SEED,rt as TICK_ARRAY_SIZE,zT as TICK_SPACINGS,ut as TOKEN_WSOL,Sn as TickArrayBitmap,al as TickArrayBitmapExtensionLayout,Oi as TickArrayBitmapExtensionUtils,Li as TickArrayLayout,cf as TickLayout,ao as TickMath,Te as TickQuery,$ as TickUtils,Se as Token,he as TokenAmount,di as TxBuilder,bn as TxVersion,Si as U64Resolution,YT as U64_IGNORE_RANGE,ta as UInt,db as USDCMint,bb as USDHMint,pb as USDTMint,Zm as UTIL1216,sa as Union,fy as VestingSchedule,Oc as Voter,Op as VoterDepositEntry,Lp as VoterLockup,Lc as VoterRegistrar,Rp as VoterVotingMintConfig,Z as WSOLMint,Lr as WideBits,hn as WrappedLayout,ge as ZERO,Wu as _100_PERCENT,P as accountMeta,og as add,ei as addComputeBudget,Ga as addLiquidityLayout,Dt as anchorDataBuf,Sk as array,la as associatedLedgerAccountLayout,na as bits,Be as blob,qe as bool,KR as buyExactInInstruction,om as buyExactOutInstruction,Ia as calFarmRewardAmount,br as ceilDiv,eo as ceilDivBN,ni as checkLegacyTxSize,YR as checkPoolToAmm,Pn as checkV0TxSize,hs as chunkArray,um as claimCreatorFee,Zi as claimLayout,Pu as claimPlatformFee,ku as claimPlatformFeeFromVault,gu as claimVestedToken,sl as clmmComputeInfoToApiInfo,In as closeAccountInstruction,ou as collectCpFeeInstruction,xs as commonSystemAccountMeta,ti as confirmTransaction,Zf as cpmmLockPositionInstruction,wi as createAssociatedLedgerAccountInstruction,ye as createLogger,sm as createPlatformConfig,Al as createPoolFeeLayout,Qa as createPoolV4InstructionV2,$I as createPoolV4Layout,Au as createVestingAccount,_n as createWSolAccountInstructions,gk as cstr,Kb as currencyEquals,qm as decimalToFraction,lp as decodeBool,Jb as div,yr as divCeil,ht as dwLayout,mp as encodeBool,gP as endlessRetry,Fm as eq,dk as f32,pk as f32be,fk as f64,yk as f64be,fa as farmAddRewardLayout,ww as farmLedgerLayoutV3_1,gi as farmLedgerLayoutV3_2,Tw as farmLedgerLayoutV5_1,Cc as farmLedgerLayoutV5_2,Rc as farmLedgerLayoutV6_1,_c as farmRewardInfoToConfig,da as farmRewardLayout,pa as farmRewardRestartLayout,Cp as farmRewardTimeInfoLayout,Sc as farmStateV3Layout,Kc as farmStateV5Layout,bi as farmStateV6Layout,Hw as fetchMultipleFarmInfoAndUpdate,_B as fetchMultipleInfo,ho as fetchMultipleMintInfos,ne as findProgramAddress,Wa as fixedSwapInLayout,qa as fixedSwapOutLayout,Fs as floorDiv,Pr as forecastTransactionSize,Kf as formatLayout,Ye as generatePubKey,H as getATAAddress,Vc as getAssociatedAuthority,Xr as getAssociatedConfigId,gt as getAssociatedLedgerAccount,Pi as getAssociatedLedgerPoolAccount,Of as getAssociatedOpenOrders,$a as getAssociatedPoolKeys,Gi as getCpLockPda,VS as getCpmmPdaAmmConfigId,tu as getCpmmPdaPoolId,Vl as getCreatePoolKeys,Yu as getDate,Ba as getDepositEntryIndex,hr as getDevLookupTableCache,xl as getDxByDyBaseIn,Bl as getDyByDxBaseIn,jg as getEpochInfo,Oo as getFarmLedgerLayout,Mp as getFarmStateLayout,Za as getLiquidityAssociatedAuthority,mo as getLiquidityAssociatedId,Dh as getLiquidityFromAmounts,ng as getMax,Jt as getMultipleAccountsInfo,Ne as getMultipleAccountsInfoWithCustomFlags,Tr as getMultipleLookupTableInfo,th as getPdaAmmConfigId,Ao as getPdaCpiEvent,em as getPdaCreatorFeeVaultAuth,er as getPdaCreatorVault,je as getPdaExBitmapAccount,yn as getPdaLaunchpadAuth,AR as getPdaLaunchpadConfigId,Uo as getPdaLaunchpadPoolId,pu as getPdaLaunchpadVaultId,Mo as getPdaLockClPositionIdV2,Na as getPdaLockPositionId,Xf as getPdaLpMint,xn as getPdaMetadataKey,Ma as getPdaMintExAccount,ol as getPdaObservationAccount,Ui as getPdaObservationId,Ci as getPdaOperationAccount,Bt as getPdaPersonalPositionAddress,yu as getPdaPlatformFeeVaultAuth,fu as getPdaPlatformId,Go as getPdaPlatformVault,Wo as getPdaPoolAuthority,tl as getPdaPoolId,nl as getPdaPoolRewardVaulId,Oa as getPdaPoolVaultId,sn as getPdaProtocolPositionAddress,Ae as getPdaTickArrayAddress,Fl as getPdaVault,Ji as getPdaVestId,Jn as getRecentBlockHash,Aa as getRegistrarAddress,md as getSessionKey,Sl as getStablePrice,Gm as getTime,cg as getTimestamp,ha as getTokenOwnerRecordAddress,aA as getTransferAmountFee,Xs as getTransferAmountFeeFromPost,Gs as getTransferAmountFeeFromPre,Ie as getTransferAmountFeeV2,wa as getVoterAddress,Ta as getVoterWeightRecordAddress,ka as getVotingMintAuthority,Pa as getVotingTokenMint,Up as governanceCreateTokenOwnerRecord,GP as greedy,vm as gt,$b as gte,hc as i128,HT as i16ToBytes,Er as i32ToBytes,Co as i64,Tc as i8,Ua as initPoolLayout,ua as initTokenAccountInstruction,tm as initialize,Ff as initializeMarket,nm as initializeWithToken2022,Mg as intersection,Hu as isDateAfter,ju as isDateBefore,Um as isDecimal,tg as isMeaningfulNumber,Qu as isNumber,ba as isValidFarmVersion,Ki as isZero,Fe as jsonInfo2PoolKeys,Zw as judgeFarmType,Ka as leadingZeros,Jc as leastSignificantBit,uo as liquidityStateV4Layout,pf as liquidityStateV5Layout,Hb as lt,Zb as lte,fb as mSOLMint,Ur as makeAMMSwapInstruction,wl as makeAddLiquidityInstruction,Sa as makeAddNewRewardInstruction,as as makeClaimInstruction,du as makeClaimInstructionV4,Ul as makeCpmmLockInstruction,El as makeCreateCpmmPoolInInstruction,Ec as makeCreateFarmInstruction,Qr as makeCreateMarketInstruction,Dc as makeCreatorWithdrawFarmRewardInstruction,Dl as makeDepositCpmmInInstruction,qc as makeDepositInstructionV3,Uc as makeDepositInstructionV5,Gc as makeDepositInstructionV6,pT as makeDepositTokenInstruction,yT as makeDepositWithdrawInstruction,mB as makeInitPoolInstructionV4,JC as makePurchaseInstruction,xa as makeRestartRewardInstruction,Tl as makeSimulatePoolInfoInstruction,es as makeSwapCpmmBaseInInstruction,ql as makeSwapCpmmBaseOutInstruction,bf as makeSwapFixedInInstruction,gf as makeSwapFixedOutInstruction,Hl as makeSwapInstruction,xc as makeTransferInstruction,Wl as makeWithdrawCpmmInInstruction,Ii as makeWithdrawInstructionV3,Wc as makeWithdrawInstructionV4,hi as makeWithdrawInstructionV5,Ti as makeWithdrawInstructionV6,fT as makeWithdrawTokenInstruction,tn as minExpirationTime,QT as mockCreatePoolInfo,Zc as mockV3CreatePoolInfo,Pf as modelDataInfoLayout,$c as mostSignificantBit,Ms as mul,vs as notInnerObject,rk as ns64,mk as ns64be,gc as nu64,JP as nu64be,oa as offset,Og as offsetDateTime,hk as option,J as parseBigNumberish,$n as parseNumberInfo,nc as parseSimulateLogToJson,An as parseSimulateValue,Bc as parseTokenAccountResp,_I as parseTokenInfo,Dn as poolTypeV6,Nn as printSimulate,N as publicKey,cu as purchaseLayout,xp as realFarmStateV3Layout,Sp as realFarmStateV5Layout,Kp as realFarmV6Layout,Gu as recursivelyDecimalToFraction,za as removeLiquidityInstruction,Xa as removeLiquidityLayout,oC as route1Instruction,iC as route2Instruction,ey as routeInstruction,xk as rustEnum,tk as s16,sk as s16be,nk as s24,ak as s24be,_e as s32,uk as s32be,ok as s40,ck as s40be,ik as s48,lk as s48be,ek as s8,im as sellExactInInstruction,rm as sellExactOut,Q as seq,Ty as setLoggerLevel,Dm as shakeFractionDecimal,tc as simulateMultipleInstruction,lB as simulatePoolInfoInstruction,Qm as simulateTransaction,qu as sleep,bt as solToWSol,DI as solToWSolToken,rn as splAccountLayout,_u as splitNumber,yb as stSOLMint,Kt as str,F as struct,eg as sub,rC as swapBaseInAutoAccount,sC as swapBaseOutAutoAccount,Bk as tagged,Ns as tenExponential,zr as toAmmComputePoolInfo,Pt as toApiV3Token,Wm as toBN,oc as toBuffer,Wn as toFeeConfig,zu as toFraction,jb as toFractionWithDecimals,Kg as toPercent,Wr as toToken,Mi as toTokenAmount,EI as toTokenInfo,Cg as toTokenPrice,Rg as toTotalPrice,Uu as toUsdCurrency,Ca as trailingZeros,Hg as transformTxToBase64,Ks as tryParsePublicKey,Ym as txToBase64,ee as u128,Mt as u16,_r as u16ToBytes,YP as u16be,XP as u24,jP as u24be,ft as u32,ZT as u32ToBytes,HP as u32be,zP as u40,ZP as u40be,QP as u48,$P as u48be,k as u64,W as u8,dy as u8ToBytes,Kk as union,y0 as unionArr,bk as unionLayoutDiscriminator,Fg as uniq,vp as updateFarmPoolInfo,am as updatePlatformConfig,Ir as updateReqHistory,Ak as utf8,Ss as validateAndParsePublicKey,ga as validateFarmRewards,Ik as vec,dp as vecU8,Xp as voterStakeRegistryCreateDepositEntry,Gp as voterStakeRegistryCreateVoter,Dp as voterStakeRegistryDeposit,Wp as voterStakeRegistryUpdateVoterWeightRecord,qp as voterStakeRegistryWithdraw,WI as wSolToSolToken,ma as withdrawRewardLayout,vg as xor,Ck as zeros};
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
//# sourceMappingURL=index.mjs.map